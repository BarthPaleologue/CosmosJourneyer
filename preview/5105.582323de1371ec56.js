/*
 *  This file is part of Cosmos Journeyer
 *
 *  Copyright (C) 2024 Barthélemy Paléologue <barth.paleologue@cosmosjourneyer.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";(globalThis.webpackChunk_cosmos_journeyer_game=globalThis.webpackChunk_cosmos_journeyer_game||[]).push([["5105"],{17093(e,t,i){i.d(t,{G:()=>r});class r{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(let e in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(let e in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,e)){let t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(let t in r.Triggers)if(Object.prototype.hasOwnProperty.call(r.Triggers,t)&&parseInt(t)===e)return!0;return!1}}r.Triggers={}},98304(e,t,i){i.d(t,{X:()=>r});class r{constructor(e,t,i,r,s,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=s,this.additionalData=n}static CreateNew(e,t,i){let s=e.getScene();return new r(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new r(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new r(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new r(e,t.x,t.y,null,i,s)}}},24265(e,t,i){i.d(t,{G:()=>n});var r=i(93965),s=i(50394);class n{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){let i;if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(s.R.NormalKind))return null;let n=this.pickedMesh.getIndices();n?.length===0&&(n=null);let a=r.AA.Vector3["0"],o=r.AA.Vector3["1"],h=r.AA.Vector3["2"];if(t){let e=this.pickedMesh.getVerticesData(s.R.NormalKind),t=n?r.Pq.FromArrayToRef(e,3*n[3*this.faceId],a):a.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),l=n?r.Pq.FromArrayToRef(e,3*n[3*this.faceId+1],o):o.copyFromFloats(e[(3*this.faceId+1)*3],e[(3*this.faceId+1)*3+1],e[(3*this.faceId+1)*3+2]),d=n?r.Pq.FromArrayToRef(e,3*n[3*this.faceId+2],h):h.copyFromFloats(e[(3*this.faceId+2)*3],e[(3*this.faceId+2)*3+1],e[(3*this.faceId+2)*3+2]);t=t.scale(this.bu),l=l.scale(this.bv),d=d.scale(1-this.bu-this.bv),i=new r.Pq(t.x+l.x+d.x,t.y+l.y+d.y,t.z+l.z+d.z)}else{let e=this.pickedMesh.getVerticesData(s.R.PositionKind),t=n?r.Pq.FromArrayToRef(e,3*n[3*this.faceId],a):a.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),l=n?r.Pq.FromArrayToRef(e,3*n[3*this.faceId+1],o):o.copyFromFloats(e[(3*this.faceId+1)*3],e[(3*this.faceId+1)*3+1],e[(3*this.faceId+1)*3+2]),d=n?r.Pq.FromArrayToRef(e,3*n[3*this.faceId+2],h):h.copyFromFloats(e[(3*this.faceId+2)*3],e[(3*this.faceId+2)*3+1],e[(3*this.faceId+2)*3+2]),u=t.subtract(l),c=d.subtract(l);i=r.Pq.Cross(u,c)}let l=(e,t)=>{if(-1!==this.thinInstanceIndex){let i=e.thinInstanceGetWorldMatrices()[this.thinInstanceIndex];i&&r.Pq.TransformNormalToRef(t,i,t)}let i=e.getWorldMatrix();e.nonUniformScaling&&(r.AA.Matrix["0"].copyFrom(i),(i=r.AA.Matrix["0"]).setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(r.AA.Matrix["1"]),i=r.AA.Matrix["1"]),r.Pq.TransformNormalToRef(t,i,t)};if(e&&l(this.pickedMesh,i),this.ray){let t=r.AA.Vector3["0"].copyFrom(i);e||l(this.pickedMesh,t),r.Pq.Dot(t,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}getTextureCoordinates(e=s.R.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;let t=this.pickedMesh.getIndices();if(!t)return null;let i=this.pickedMesh.getVerticesData(e);if(!i)return null;let n=r.I9.FromArray(i,2*t[3*this.faceId]),a=r.I9.FromArray(i,2*t[3*this.faceId+1]),o=r.I9.FromArray(i,2*t[3*this.faceId+2]);return n=n.scale(this.bu),a=a.scale(this.bv),o=o.scale(1-this.bu-this.bv),new r.I9(n.x+a.x+o.x,n.y+a.y+o.y)}}},69823(e,t,i){var r,s,n,a,o,h,l,d,u,c,_,f,g,p;i.d(t,{ST:()=>s,Ze:()=>n,bq:()=>r,dR:()=>l,h8:()=>a,pI:()=>o,sZ:()=>h}),(d=r||(r={}))[d.Generic=0]="Generic",d[d.Keyboard=1]="Keyboard",d[d.Mouse=2]="Mouse",d[d.Touch=3]="Touch",d[d.DualShock=4]="DualShock",d[d.Xbox=5]="Xbox",d[d.Switch=6]="Switch",d[d.DualSense=7]="DualSense",(u=s||(s={}))[u.Horizontal=0]="Horizontal",u[u.Vertical=1]="Vertical",u[u.LeftClick=2]="LeftClick",u[u.MiddleClick=3]="MiddleClick",u[u.RightClick=4]="RightClick",u[u.BrowserBack=5]="BrowserBack",u[u.BrowserForward=6]="BrowserForward",u[u.MouseWheelX=7]="MouseWheelX",u[u.MouseWheelY=8]="MouseWheelY",u[u.MouseWheelZ=9]="MouseWheelZ",u[u.Move=12]="Move",(c=n||(n={}))[c.Horizontal=0]="Horizontal",c[c.Vertical=1]="Vertical",c[c.LeftClick=2]="LeftClick",c[c.MiddleClick=3]="MiddleClick",c[c.RightClick=4]="RightClick",c[c.BrowserBack=5]="BrowserBack",c[c.BrowserForward=6]="BrowserForward",c[c.MouseWheelX=7]="MouseWheelX",c[c.MouseWheelY=8]="MouseWheelY",c[c.MouseWheelZ=9]="MouseWheelZ",c[c.DeltaHorizontal=10]="DeltaHorizontal",c[c.DeltaVertical=11]="DeltaVertical",(_=a||(a={}))[_.Cross=0]="Cross",_[_.Circle=1]="Circle",_[_.Square=2]="Square",_[_.Triangle=3]="Triangle",_[_.L1=4]="L1",_[_.R1=5]="R1",_[_.L2=6]="L2",_[_.R2=7]="R2",_[_.Share=8]="Share",_[_.Options=9]="Options",_[_.L3=10]="L3",_[_.R3=11]="R3",_[_.DPadUp=12]="DPadUp",_[_.DPadDown=13]="DPadDown",_[_.DPadLeft=14]="DPadLeft",_[_.DPadRight=15]="DPadRight",_[_.Home=16]="Home",_[_.TouchPad=17]="TouchPad",_[_.LStickXAxis=18]="LStickXAxis",_[_.LStickYAxis=19]="LStickYAxis",_[_.RStickXAxis=20]="RStickXAxis",_[_.RStickYAxis=21]="RStickYAxis",(f=o||(o={}))[f.Cross=0]="Cross",f[f.Circle=1]="Circle",f[f.Square=2]="Square",f[f.Triangle=3]="Triangle",f[f.L1=4]="L1",f[f.R1=5]="R1",f[f.L2=6]="L2",f[f.R2=7]="R2",f[f.Create=8]="Create",f[f.Options=9]="Options",f[f.L3=10]="L3",f[f.R3=11]="R3",f[f.DPadUp=12]="DPadUp",f[f.DPadDown=13]="DPadDown",f[f.DPadLeft=14]="DPadLeft",f[f.DPadRight=15]="DPadRight",f[f.Home=16]="Home",f[f.TouchPad=17]="TouchPad",f[f.LStickXAxis=18]="LStickXAxis",f[f.LStickYAxis=19]="LStickYAxis",f[f.RStickXAxis=20]="RStickXAxis",f[f.RStickYAxis=21]="RStickYAxis",(g=h||(h={}))[g.A=0]="A",g[g.B=1]="B",g[g.X=2]="X",g[g.Y=3]="Y",g[g.LB=4]="LB",g[g.RB=5]="RB",g[g.LT=6]="LT",g[g.RT=7]="RT",g[g.Back=8]="Back",g[g.Start=9]="Start",g[g.LS=10]="LS",g[g.RS=11]="RS",g[g.DPadUp=12]="DPadUp",g[g.DPadDown=13]="DPadDown",g[g.DPadLeft=14]="DPadLeft",g[g.DPadRight=15]="DPadRight",g[g.Home=16]="Home",g[g.LStickXAxis=17]="LStickXAxis",g[g.LStickYAxis=18]="LStickYAxis",g[g.RStickXAxis=19]="RStickXAxis",g[g.RStickYAxis=20]="RStickYAxis",(p=l||(l={}))[p.B=0]="B",p[p.A=1]="A",p[p.Y=2]="Y",p[p.X=3]="X",p[p.L=4]="L",p[p.R=5]="R",p[p.ZL=6]="ZL",p[p.ZR=7]="ZR",p[p.Minus=8]="Minus",p[p.Plus=9]="Plus",p[p.LS=10]="LS",p[p.RS=11]="RS",p[p.DPadUp=12]="DPadUp",p[p.DPadDown=13]="DPadDown",p[p.DPadLeft=14]="DPadLeft",p[p.DPadRight=15]="DPadRight",p[p.Home=16]="Home",p[p.Capture=17]="Capture",p[p.LStickXAxis=18]="LStickXAxis",p[p.LStickYAxis=19]="LStickYAxis",p[p.RStickXAxis=20]="RStickXAxis",p[p.RStickYAxis=21]="RStickYAxis"},33516(e,t,i){i.d(t,{c:()=>s});var r=i(72210);class s{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new r.cP,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}},98715(e,t,i){i.d(t,{Z:()=>f});var r=i(69823),s=i(72210),n=i(3429);class a{static CreateDeviceEvent(e,t,i,s,n,a,o){switch(e){case r.bq.Keyboard:return this._CreateKeyboardEvent(i,s,n,a);case r.bq.Mouse:if(i===r.ST.MouseWheelX||i===r.ST.MouseWheelY||i===r.ST.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,n,a);case r.bq.Touch:return this._CreatePointerEvent(e,t,i,s,n,a,o);default:throw`Unable to generate event for device ${r.bq[e]}`}}static _CreatePointerEvent(e,t,i,s,n,a,o){let h=this._CreateMouseEvent(e,t,i,s,n,a);return e===r.bq.Mouse?(h.deviceType=r.bq.Mouse,h.pointerId=1,h.pointerType="mouse"):(h.deviceType=r.bq.Touch,h.pointerId=o??t,h.pointerType="touch"),h.buttons=0+n.pollInput(e,t,r.ST.LeftClick)+2*n.pollInput(e,t,r.ST.RightClick)+4*n.pollInput(e,t,r.ST.MiddleClick),i===r.ST.Move?h.type="pointermove":i>=r.ST.LeftClick&&i<=r.ST.RightClick&&(h.type=1===s?"pointerdown":"pointerup",h.button=i-2),h}static _CreateWheelEvent(e,t,i,s,a,o){let h=this._CreateMouseEvent(e,t,i,s,a,o);switch(h.pointerId=1,h.type="wheel",h.deltaMode=n.s.DOM_DELTA_PIXEL,h.deltaX=0,h.deltaY=0,h.deltaZ=0,i){case r.ST.MouseWheelX:h.deltaX=s;break;case r.ST.MouseWheelY:h.deltaY=s;break;case r.ST.MouseWheelZ:h.deltaZ=s}return h}static _CreateMouseEvent(e,t,i,s,n,a){let o=this._CreateEvent(a),h=n.pollInput(e,t,r.ST.Horizontal),l=n.pollInput(e,t,r.ST.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=n.pollInput(e,t,10),o.movementY=n.pollInput(e,t,11),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,n),o.clientX=h,o.clientY=l,o.x=h,o.y=l,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,s){let n=this._CreateEvent(s);return this._CheckNonCharacterKeys(n,i),n.deviceType=r.bq.Keyboard,n.deviceSlot=0,n.inputIndex=e,n.type=1===t?"keydown":"keyup",n.key=String.fromCharCode(e),n.keyCode=e,n}static _CheckNonCharacterKeys(e,t){let i=t.isDeviceAvailable(r.bq.Keyboard),s=i&&1===t.pollInput(r.bq.Keyboard,0,18),n=i&&1===t.pollInput(r.bq.Keyboard,0,17),a=i&&(1===t.pollInput(r.bq.Keyboard,0,91)||1===t.pollInput(r.bq.Keyboard,0,92)||1===t.pollInput(r.bq.Keyboard,0,93)),o=i&&1===t.pollInput(r.bq.Keyboard,0,16);e.altKey=s,e.ctrlKey=n,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){let t={};return t.preventDefault=()=>{},t.target=e,t}}class o{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(e,t,r,s)=>{let n=a.CreateDeviceEvent(e,t,r,s,this);i(e,t,n)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===r.bq.Mouse||e===r.bq.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}var h=i(79556),l=i(85928);let d=Object.keys(r.ST).length/2;class u{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=l.S0.IsSafari(),this._usingMacOs=(0,h.XD)()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerCancelTouch=e=>{},this._pointerLeaveEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOsChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=(0,h.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=(0,h.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=l.S0.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=+!this._isUsingFirefox,this._enableEvents(),this._usingMacOs&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){let s=this._inputs[e][t];if(!s)throw`Unable to find device ${r.bq[e]}`;e>=r.bq.DualShock&&e<=r.bq.DualSense&&this._updateDevice(e,t,i);let n=s[i];if(void 0===n)throw`Unable to find input ${i} for device ${r.bq[e]} in slot ${t}`;return i===r.ST.Move&&l.S0.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){let e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(let e of this._inputs)if(e)for(let t in e){let i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOs&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads)for(let e of navigator.getGamepads())e&&this._addGamePad(e);"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(r.bq.Mouse,0,0,0)}_addGamePad(e){let t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,d);let s=this._inputs[e][t];s[0]=i,s[1]=r}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${r.bq[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){let r=Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(r.bq.Keyboard,0,255));let t=this._inputs[r.bq.Keyboard][0];t&&(t[e.keyCode]=1,e.inputIndex=e.keyCode,this._usingMacOs&&e.metaKey&&"Meta"!==e.key&&!this._metaKeys.includes(e.keyCode)&&this._metaKeys.push(e.keyCode),this._onInputChanged(r.bq.Keyboard,0,e))},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(r.bq.Keyboard,0,255));let t=this._inputs[r.bq.Keyboard][0];if(t){if(t[e.keyCode]=0,e.inputIndex=e.keyCode,this._usingMacOs&&"Meta"===e.key&&this._metaKeys.length>0){for(let e of this._metaKeys){let i=a.CreateDeviceEvent(r.bq.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(r.bq.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(r.bq.Keyboard,0,e)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){let e=this._inputs[r.bq.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;let i=a.CreateDeviceEvent(r.bq.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(r.bq.Keyboard,0,i)}this._usingMacOs&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=(0,h.XD)()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{let t=this._getPointerType(e),i=t===r.bq.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===r.bq.Touch&&-1===i){let r=this._activeTouchIds.indexOf(-1);if(!(r>=0))return void l.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=r,this._activeTouchIds[r]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);let s=this._inputs[t][i];s&&(e.inputIndex=r.ST.Move,s[r.ST.Horizontal]=e.clientX,s[r.ST.Vertical]=e.clientY,t===r.bq.Touch&&0===s[r.ST.LeftClick]&&(s[r.ST.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,e),this._usingSafari||-1===e.button||(e.inputIndex=e.button+2,s[e.button+2]=+!s[e.button+2],this._onInputChanged(t,i,e)))},this._pointerDownEvent=e=>{let t=this._getPointerType(e),i=t===r.bq.Mouse?0:e.pointerId;if(t===r.bq.Touch){let t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t&&(t=this._activeTouchIds.indexOf(-1)),!(t>=0))return void l.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===r.bq.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);let s=this._inputs[t][i];if(s){let n=s[r.ST.Horizontal],a=s[r.ST.Vertical];if(t===r.bq.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}s[r.ST.Horizontal]=e.clientX,s[r.ST.Vertical]=e.clientY,s[e.button+2]=1,e.inputIndex=e.button+2,this._onInputChanged(t,i,e),(n!==e.clientX||a!==e.clientY)&&(e.inputIndex=r.ST.Move,this._onInputChanged(t,i,e))}},this._pointerUpEvent=e=>{let t=this._getPointerType(e),i=t===r.bq.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===r.bq.Touch)if(-1===i)return;else this._activeTouchIds[i]=-1;let s=this._inputs[t]?.[i],n=e.button,a=s&&0!==s[n+2];if(!a&&this._isUsingFirefox&&this._usingMacOs&&s&&(a=0!==s[(n=2*(2!==n))+2]),a){let a=s[r.ST.Horizontal],o=s[r.ST.Vertical];s[r.ST.Horizontal]=e.clientX,s[r.ST.Vertical]=e.clientY,s[n+2]=0,void 0===e.pointerId&&(e.pointerId=this._mouseId),(a!==e.clientX||o!==e.clientY)&&(e.inputIndex=r.ST.Move,this._onInputChanged(t,i,e)),e.inputIndex=n+2,t===r.bq.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&this._elementToAttachTo.hasPointerCapture?.(e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(t,i,e),t===r.bq.Touch&&this._onDeviceDisconnected(t,i)}},this._pointerCancelTouch=e=>{let t=this._activeTouchIds.indexOf(e);if(-1===t)return;this._elementToAttachTo.hasPointerCapture?.(e)&&this._elementToAttachTo.releasePointerCapture(e),this._inputs[r.bq.Touch][t][r.ST.LeftClick]=0;let i=a.CreateDeviceEvent(r.bq.Touch,t,r.ST.LeftClick,0,this,this._elementToAttachTo,e);this._onInputChanged(r.bq.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(r.bq.Touch,t)},this._pointerCancelEvent=e=>{if("mouse"===e.pointerType){let e=this._inputs[r.bq.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=r.ST.LeftClick;t<=r.ST.BrowserForward;t++)if(1===e[t]){e[t]=0;let i=a.CreateDeviceEvent(r.bq.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(r.bq.Mouse,0,i)}}else this._pointerCancelTouch(e.pointerId)},this._pointerLeaveEvent=e=>{"pen"===e.pointerType&&this._pointerCancelTouch(e.pointerId)},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1,t=function(){};try{let i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(r.bq.Mouse)){let e=this._inputs[r.bq.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=r.ST.LeftClick;t<=r.ST.BrowserForward;t++)if(1===e[t]){e[t]=0;let i=a.CreateDeviceEvent(r.bq.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(r.bq.Mouse,0,i)}}if(this.isDeviceAvailable(r.bq.Touch)){let e=this._inputs[r.bq.Touch];for(let t=0;t<this._activeTouchIds.length;t++){let i=this._activeTouchIds[t];if(this._elementToAttachTo.hasPointerCapture?.(i)&&this._elementToAttachTo.releasePointerCapture(i),-1!==i&&e[t]?.[r.ST.LeftClick]===1){e[t][r.ST.LeftClick]=0;let s=a.CreateDeviceEvent(r.bq.Touch,t,r.ST.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(r.bq.Touch,t,s),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(r.bq.Touch,t)}}}},this._pointerWheelEvent=e=>{let t=r.bq.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,d));let i=this._inputs[t][0];i&&(i[r.ST.MouseWheelX]=e.deltaX||0,i[r.ST.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[r.ST.MouseWheelZ]=e.deltaZ||0,void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[r.ST.MouseWheelX]&&(e.inputIndex=r.ST.MouseWheelX,this._onInputChanged(t,0,e)),0!==i[r.ST.MouseWheelY]&&(e.inputIndex=r.ST.MouseWheelY,this._onInputChanged(t,0,e)),0!==i[r.ST.MouseWheelZ]&&(e.inputIndex=r.ST.MouseWheelZ,this._onInputChanged(t,0,e)))},this._usingMacOs&&this._isUsingChromium&&(this._pointerMacOsChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(r.bq.Mouse)){let e=this._inputs[r.bq.Mouse][0];e[r.ST.MouseWheelX]=0,e[r.ST.MouseWheelY]=0,e[r.ST.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){let t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){let r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){let s=this._inputs[e][t];i>=r.buttons.length?s[i]=r.axes[i-r.buttons.length].valueOf():s[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return -1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?r.bq.DualSense:r.bq.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?r.bq.Xbox:-1!==e.indexOf("057e")?r.bq.Switch:r.bq.Generic}_getPointerType(e){let t=r.bq.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=r.bq.Touch),t}}var c=i(33516);class _{constructor(e){this._registeredManagers=[],this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){let i=this._devices[t];for(let r in i){let i=+r;e._addDevice(new c.c(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{let t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(r.bq).length/2;this._devices=Array(t);const i=(e,t)=>{for(let i of(this._devices[e]||(this._devices[e]=[]),this._devices[e][t]||(this._devices[e][t]=t),this._registeredManagers)){let r=new c.c(this._deviceInputSystem,e,t);i._addDevice(r)}},s=(e,t)=>{for(let i of(this._devices[e]?.[t]&&delete this._devices[e][t],this._registeredManagers))i._removeDevice(e,t)},n=(e,t,i)=>{if(i)for(let r of this._registeredManagers)r._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new o(i,s,n):this._deviceInputSystem=new u(e,i,s,n)}dispose(){this._deviceInputSystem.dispose()}}class f{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(e=>!!e):[]}constructor(e){const t=Object.keys(r.bq).length/2;this._devices=Array(t),this._firstDevice=Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new _(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new s.cP(e=>{for(let t of this._devices)if(t)for(let i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)}),this.onDeviceDisconnectedObservable=new s.cP,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=[]),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){let i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case r.bq.Keyboard:case r.bq.Mouse:this._firstDevice[e]=0;break;case r.bq.Touch:case r.bq.DualSense:case r.bq.DualShock:case r.bq.Xbox:case r.bq.Switch:case r.bq.Generic:{delete this._firstDevice[e];let t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}}}}}},3429(e,t,i){var r,s;i.d(t,{b:()=>r,s:()=>n}),(s=r||(r={}))[s.PointerMove=0]="PointerMove",s[s.PointerDown=1]="PointerDown",s[s.PointerUp=2]="PointerUp";class n{}n.DOM_DELTA_PIXEL=0,n.DOM_DELTA_LINE=1,n.DOM_DELTA_PAGE=2},72524(e,t,i){i.d(t,{Bu:()=>n,TB:()=>r,W0:()=>s});class r{}r.KEYDOWN=1,r.KEYUP=2;class s{constructor(e,t){this.type=e,this.event=t}}class n extends s{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}},59346(e,t,i){i.d(t,{Vn:()=>n,Zp:()=>s,mx:()=>o,tT:()=>a});var r=i(93965);class s{}s.POINTERDOWN=1,s.POINTERUP=2,s.POINTERMOVE=4,s.POINTERWHEEL=8,s.POINTERPICK=16,s.POINTERTAP=32,s.POINTERDOUBLETAP=64;class n{constructor(e,t){this.type=e,this.event=t}}class a extends n{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new r.I9(i,s)}}class o extends n{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}},96408(e,t,i){i.d(t,{Q:()=>h});var r=i(45014),s=i(70813),n=i(29535),a=i(34007),o=i(27419);class h{constructor(){this._dirty=!0,this._tempColor=new n.ov(0,0,0,0),this._globalCurve=new n.ov(0,0,0,0),this._highlightsCurve=new n.ov(0,0,0,0),this._midtonesCurve=new n.ov(0,0,0,0),this._shadowsCurve=new n.ov(0,0,0,0),this._positiveCurve=new n.ov(0,0,0,0),this._negativeCurve=new n.ov(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",s="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(s,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,r,s){null!=e&&(e=h._Clamp(e,0,360),t=h._Clamp(t,-100,100),i=h._Clamp(i,-100,100),r=h._Clamp(r,-100,100),t=.5*h._ApplyColorGradingSliderNonlinear(t),r=h._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),h._FromHSBToRef(e,t,50+.25*r,s),s.scaleToRef(2,s),s.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){let t=Math.abs(e/=100);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100}static _FromHSBToRef(e,t,i,r){let s=h._Clamp(e,0,360),n=h._Clamp(t/100,0,1),a=h._Clamp(i/100,0,1);if(0===n)r.r=a,r.g=a,r.b=a;else{let e=Math.floor(s/=60),t=s-e,i=a*(1-n),o=a*(1-n*t),h=a*(1-n*(1-t));switch(e){case 0:r.r=a,r.g=h,r.b=i;break;case 1:r.r=o,r.g=a,r.b=i;break;case 2:r.r=i,r.g=a,r.b=h;break;case 3:r.r=i,r.g=o,r.b=a;break;case 4:r.r=h,r.g=i,r.b=a;break;default:r.r=a,r.g=i,r.b=o}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return a.p.Clone(()=>new h,this)}serialize(){return a.p.Serialize(this)}static Parse(e){return a.p.Parse(()=>new h,e,null,null)}}h.PrepareUniforms=o.B,(0,r.Cg)([(0,s.lK)()],h.prototype,"_globalHue",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_globalDensity",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_globalSaturation",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_globalExposure",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_highlightsHue",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_highlightsDensity",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_highlightsSaturation",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_highlightsExposure",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_midtonesHue",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_midtonesDensity",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_midtonesSaturation",void 0),(0,r.Cg)([(0,s.lK)()],h.prototype,"_midtonesExposure",void 0),a.p._ColorCurvesParser=h.Parse},94277(e,t,i){i.d(t,{Dh:()=>A,Lz:()=>v,Si:()=>p,k2:()=>d,oW:()=>R,oX:()=>g,rs:()=>_});var r=i(51462),s=i(93965),n=i(19340),a=i(37297);let o=new s.uq,h=new s.uq,l=new s.uq,d={getScene:()=>void 0,eyeAtCamera:!0};function u(e,t,i){let r=i.asArray(),s=t.asArray();for(let e=0;e<16;e++)r[e]=s[e];return r[12]-=e.x,r[13]-=e.y,r[14]-=e.z,i.markAsUpdated(),i}function c(e,t,i){return(0,n.EE)(t,h),u(e,h,l),(0,n.EE)(l,i),i}function _(e,t,i){if(!d.eyeAtCamera)return c(e,t,i);let r=i.asArray(),s=t.asArray();for(let e=0;e<16;e++)r[e]=s[e];return r[12]=0,r[13]=0,r[14]=0,i.markAsUpdated(),i}function f(e,t,i,r){return(0,n.fd)(_(e,t,r),i,r),r}function g(e,t,i){return i.normal.copyFrom(t.normal),i.d=t.d+s.Pq.Dot(t.normal,e),i}function p(e,t,i,r,s){for(let n=0;n<r;++n)v(e,t[n],i[n],h),h.copyToArray(s,16*n);return s}function m(e,t,i,r){return(0,n.EE)(i,h),(0,n.fd)(t,h,l),u(e,l,h),_(e,i,l),(0,n.fd)(h,l,r),r}function v(e,t,i,r){return c(e,t,l),(0,n.fd)(l,i,r),r}function b(e,t,i,r,s,a){return(0,n.EE)(i,h),(0,n.fd)(t,h,l),u(e,l,h),f(e,r,s,l),(0,n.fd)(h,l,a),a}function y(e,t){let i=d.getScene();if(!i||o===t)return t;o.updateFlag=t.updateFlag;let r=i.floatingOriginOffset;switch(e){case"world":return u(r,t,o);case"view":return _(r,t,o);case"worldView":return m(r,t,i.getViewMatrix(),o);case"viewProjection":return f(r,i.getViewMatrix(),i.getProjectionMatrix(),o);case"worldViewProjection":return b(r,t,i.getTransformMatrix(),i.getViewMatrix(),i.getProjectionMatrix(),o);default:if(e.startsWith("u_")){let s=e.toLowerCase();if(s.startsWith("u_worldviewprojection"))return b(r,t,i.getTransformMatrix(),i.getViewMatrix(),i.getProjectionMatrix(),o);if(s.startsWith("u_viewprojection"))return f(r,i.getViewMatrix(),i.getProjectionMatrix(),o);if(s.startsWith("u_worldview"))return m(r,t,i.getViewMatrix(),o);if(s.startsWith("u_world"))return u(r,t,o);if(s.startsWith("u_view"))return _(r,t,o)}return t}}let C=a.D,T=r.M,E=C.prototype._updateMatrixForUniform,M=r.M.prototype.setMatrix;function R(){r.M.prototype.setMatrix=M,T._setMatrixOverride=void 0,C.prototype._updateMatrixForUniform=E,C.prototype._updateMatrixForUniformOverride=void 0}function A(){T.prototype._setMatrixOverride=M,T.prototype.setMatrix=function(e,t){return this._setMatrixOverride(e,y(e,t)),this},C.prototype._updateMatrixForUniformOverride=E,C.prototype._updateMatrixForUniform=function(e,t){this._updateMatrixForUniformOverride(e,y(e,t))}}},47143(e,t,i){i.d(t,{p:()=>c});var r=i(45014),s=i(70813),n=i(72210),a=i(29535),o=i(96408),h=i(36331),l=i(34007),d=i(20068),u=i(98946);class c{constructor(){this.colorCurves=new o.Q,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=c.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new a.ov(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=c.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.outputTextureWidth=0,this.outputTextureHeight=0,this.onUpdateParameters=new n.cP}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===c._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,this._toneMappingEnabled)switch(this._toneMappingType){case c.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case c.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1}else e.TONEMAPPING=0;e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&o.Q.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){let i=1/(this.outputTextureWidth||e.getEngine().getRenderWidth()),r=1/(this.outputTextureHeight||e.getEngine().getRenderHeight());if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){let s=null!=t?t:r/i,n=Math.tan(.5*this.vignetteCameraFov),a=n*s,o=Math.sqrt(a*n);a=(0,h.zF)(a,o,this.vignetteStretch),n=(0,h.zF)(n,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,n,-a*this.vignetteCenterX,-n*this.vignetteCenterY);let l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);let t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return l.p.Clone(()=>new c,this)}serialize(){return l.p.Serialize(this)}static Parse(e){let t=l.p.Parse(()=>new c,e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}c.TONEMAPPING_STANDARD=0,c.TONEMAPPING_ACES=1,c.TONEMAPPING_KHR_PBR_NEUTRAL=2,c.PrepareUniforms=d._,c.PrepareSamplers=d.C,c._VIGNETTEMODE_MULTIPLY=0,c._VIGNETTEMODE_OPAQUE=1,(0,r.Cg)([(0,s.wL)()],c.prototype,"colorCurves",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_colorCurvesEnabled",void 0),(0,r.Cg)([(0,s.uM)("colorGradingTexture")],c.prototype,"_colorGradingTexture",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_colorGradingEnabled",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_colorGradingWithGreenDepth",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_colorGradingBGR",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_exposure",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_toneMappingEnabled",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_toneMappingType",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_contrast",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"vignetteStretch",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"vignetteCenterX",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"vignetteCenterY",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"vignetteWeight",void 0),(0,r.Cg)([(0,s.qK)()],c.prototype,"vignetteColor",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"vignetteCameraFov",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_vignetteBlendMode",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_vignetteEnabled",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_ditheringEnabled",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_ditheringIntensity",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_skipFinalColorClamp",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_applyByPostProcess",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"_isEnabled",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"outputTextureWidth",void 0),(0,r.Cg)([(0,s.lK)()],c.prototype,"outputTextureHeight",void 0),l.p._ImageProcessingConfigurationParser=c.Parse,(0,u.Y5)("BABYLON.ImageProcessingConfiguration",c)},37297(e,t,i){i.d(t,{D:()=>n});var r=i(77507),s=i(85928);class n{constructor(e,t,i=!1,r,s=!1,n){this._uniformNames=[],this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._trackUBOsInFrame=!1,(void 0===n&&this._engine._features.trackUbosInFrame||!0===n)&&(this._buffers=[],this._bufferIndex=-1,this._bufferUpdatedLastFrame=!1,this._createBufferOnWrite=!1,this._currentFrameId=0,this._trackUBOsInFrame=!0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}getUniformNames(){return this._uniformNames}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){let e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;let i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0)}}addUniform(e,t,i=0){let r;if((i>0&&"number"==typeof t&&(this._uniformArraySizes[e]={strideSize:t,arraySize:i}),void 0===this._uniformLocations[e])&&(this._uniformNames.push(e),!this._noUBO)){if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),16==t)t*=i;else{let e=4-t;t=t*i+e*i}r=[];for(let e=0;e<t;e++)r.push(0)}else{if(t instanceof Array)t=(r=t).length;else{r=[];for(let e=0;e<t;e++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(r[e]);this._needSync=!0}}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){this.addUniform(e,[t,i])}addFloat3(e,t,i,r){this.addUniform(e,[t,i,r])}addColor3(e,t){let i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){let r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){let i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNamesDebug(){let e=[],t=0;for(let i in this._uniformLocations)if(e.push(i),10==++t)break;return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()),this._trackUBOsInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._trackUBOsInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}set name(e){this._name=e}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer)return void this.create();if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._trackUBOsInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._bufferUpdatedLastFrame=!0,this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(n._UpdatedUbosInFrame[this._name]||(n._UpdatedUbosInFrame[this._name]=0),n._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._trackUBOsInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(1===this._buffers.length?this._needSync=!this._bufferUpdatedLastFrame:this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(void 0===s){if(this._buffer)return void r.V.Error("Cannot add an uniform after UBO has been created. uniformName="+e);this.addUniform(e,i),s=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[s+e]=t[e];else{let e=!1;for(let r=0;r<i;r++)(16!==i||this._engine._features.uniformBufferHardCheckMatrix)&&this._bufferData[s+r]===Math.fround(t[r])||(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+r]=t[r]);this._needSync=this._needSync||e}}updateUniformArray(e,t,i){this._checkNewFrame();let n=this._uniformLocations[e];if(void 0===n)return void r.V.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();let a=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[n+e]=t[e];else{let e=!1,r=0,o=0;for(let h=0;h<i;h++)if(this._bufferData[n+4*o+r]!==s.S0.FloatRound(t[h])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[n+4*o+r]=t[h]),++r===a.strideSize){for(;r<4;r++)this._bufferData[n+4*o+r]=0;r=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();let i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)n._TempBuffer[4*e]=t[3*e],n._TempBuffer[4*e+1]=t[3*e+1],n._TempBuffer[4*e+2]=t[3*e+2],n._TempBuffer[4*e+3]=0;this.updateUniform(e,n._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)n._TempBuffer[4*e]=t[2*e],n._TempBuffer[4*e+1]=t[2*e+1],n._TempBuffer[4*e+2]=0,n._TempBuffer[4*e+3]=0;this.updateUniform(e,n._TempBuffer,8)}_updateFloatForEffect(e,t,i=""){this._currentEffect.setFloat(e+i,t)}_updateFloatForUniform(e,t){n._TempBuffer[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){n._TempBuffer[0]=t,n._TempBuffer[1]=i,this.updateUniform(e,n._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,s=""){this._currentEffect.setFloat3(e+s,t,i,r)}_updateFloat3ForUniform(e,t,i,r){n._TempBuffer[0]=t,n._TempBuffer[1]=i,n._TempBuffer[2]=r,this.updateUniform(e,n._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setFloat4(e+n,t,i,r,s)}_updateFloat4ForUniform(e,t,i,r,s){n._TempBuffer[0]=t,n._TempBuffer[1]=i,n._TempBuffer[2]=r,n._TempBuffer[3]=s,this.updateUniform(e,n._TempBuffer,4)}_updateFloatArrayForEffect(e,t,i=""){switch(this._uniformArraySizes[e]?.strideSize){case 2:this._currentEffect.setFloatArray2(e+i,t);break;case 3:this._currentEffect.setFloatArray3(e+i,t);break;case 4:this._currentEffect.setFloatArray4(e+i,t);break;default:this._currentEffect.setFloatArray(e+i,t)}}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){n._TempBufferInt32View.set(t),this.updateUniformArray(e,n._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){n._TempBufferUInt32View.set(t),this.updateUniformArray(e,n._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){n._TempBuffer[0]=t.x,n._TempBuffer[1]=t.y,n._TempBuffer[2]=t.z,this.updateUniform(e,n._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){n._TempBuffer[0]=t.x,n._TempBuffer[1]=t.y,n._TempBuffer[2]=t.z,n._TempBuffer[3]=t.w,this.updateUniform(e,n._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,this.updateUniform(e,n._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,n._TempBuffer[3]=i,this.updateUniform(e,n._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,n._TempBuffer[3]=t.a,this.updateUniform(e,n._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){n._TempBufferInt32View[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=i,this.updateUniform(e,n._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setInt3(e+s,t,i,r)}_updateInt3ForUniform(e,t,i,r){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=i,n._TempBufferInt32View[2]=r,this.updateUniform(e,n._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setInt4(e+n,t,i,r,s)}_updateInt4ForUniform(e,t,i,r,s){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=i,n._TempBufferInt32View[2]=r,n._TempBufferInt32View[3]=s,this.updateUniform(e,n._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){n._TempBufferUInt32View[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=i,this.updateUniform(e,n._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,s=""){this._currentEffect.setUInt3(e+s,t,i,r)}_updateUInt3ForUniform(e,t,i,r){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=i,n._TempBufferUInt32View[2]=r,this.updateUniform(e,n._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,s,n=""){this._currentEffect.setUInt4(e+n,t,i,r,s)}_updateUInt4ForUniform(e,t,i,r,s){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=i,n._TempBufferUInt32View[2]=r,n._TempBufferUInt32View[3]=s,this.updateUniform(e,n._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,this._buffers.length>1&&this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,!0;return!1}has(e){return void 0!==this._uniformLocations[e]}dispose(){if(this._noUBO)return;let e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._trackUBOsInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){let t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}n._UpdatedUbosInFrame={},n._MAX_UNIFORM_SIZE=256,n._TempBuffer=new Float32Array(n._MAX_UNIFORM_SIZE),n._TempBufferInt32View=new Int32Array(n._TempBuffer.buffer),n._TempBufferUInt32View=new Uint32Array(n._TempBuffer.buffer)},63704(e,t,i){i.d(t,{Hx:()=>v,Pu:()=>C,RZ:()=>m,UA:()=>M,cU:()=>p,gW:()=>I,o5:()=>T,ow:()=>P,p$:()=>R,qY:()=>S,ux:()=>y});var r=i(85928),s=i(93965),n=i(61973),a=i(82507),o=i(81724),h=i(6932),l=i(5722),d=i(11169),u=i(77507),c=i(62908),_=i(43410);i(21366);let f="image/png",g=[134,22,135,150,246,214,150,54];function p(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=0;for(let e=0;e<g.length;e++)if(t.getUint8(i++)!==g[e])return u.V.Error("Not a babylon environment map"),null;let r="",s=0;for(;s=t.getUint8(i++);)r+=String.fromCharCode(s);let n=JSON.parse(r);return(n=m(n)).binaryDataPosition=i,n.specular&&(n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function m(e){if(e.version>2)throw Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:f}}async function v(e,t={}){let i,r=e.getInternalTexture();if(!r)return await Promise.reject("The cube texture is invalid.");let s=r.getEngine();if(2!==e.textureType&&1!==e.textureType&&0!==e.textureType&&0!==e.textureType&&7!==e.textureType&&-1!==e.textureType)return await Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let a=1;if(!s.getCaps().textureFloatRender&&(a=2,!s.getCaps().textureHalfFloatRender))return await Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");e.sphericalPolynomial;let o=e.getInternalTexture()?._sphericalPolynomialPromise,h=r.width,d=new l.Z(s),u={},c={};s.flushFramebuffer();let _=t.imageType??f,p=(0,n.ILog2)(r.width);for(let i=0;i<=p;i++){let r=Math.pow(2,p-i);for(let s=0;s<6;s++)u[6*i+s]=await b(d,e,a,s,i,r,_,t.imageQuality)}let m=t.disableIrradianceTexture?null:e.irradianceTexture;if(m){let e=m.getSize().width;for(let i=0;i<6;i++)c[i]=await b(d,m,a,i,0,e,_,t.imageQuality)}d.dispose(),o&&await o;let y={version:2,width:h,imageType:_,irradiance:null==(i=e.sphericalPolynomial)?null:{x:[i.x.x,i.x.y,i.x.z],y:[i.y.x,i.y.y,i.y.z],z:[i.z.x,i.z.y,i.z.z],xx:[i.xx.x,i.xx.y,i.xx.z],yy:[i.yy.x,i.yy.y,i.yy.z],zz:[i.zz.x,i.zz.y,i.zz.z],yz:[i.yz.x,i.yz.y,i.yz.z],zx:[i.zx.x,i.zx.y,i.zx.z],xy:[i.xy.x,i.xy.y,i.xy.z]},specular:{mipmaps:[],lodGenerationScale:e.lodGenerationScale}},C=0;for(let e=0;e<=p;e++)for(let t=0;t<6;t++){let i=u[6*e+t].byteLength;y.specular.mipmaps.push({length:i,position:C}),C+=i}if(m){y.irradiance=y.irradiance||{x:[0,0,0],xx:[0,0,0],y:[0,0,0],yy:[0,0,0],z:[0,0,0],zz:[0,0,0],yz:[0,0,0],zx:[0,0,0],xy:[0,0,0]},y.irradiance.irradianceTexture={size:m.getSize().width,faces:[],dominantDirection:m._dominantDirection?.asArray()};for(let e=0;e<6;e++){let t=c[e].byteLength;y.irradiance.irradianceTexture.faces.push({length:t,position:C}),C+=t}}let T=JSON.stringify(y),E=new ArrayBuffer(T.length+1),M=new Uint8Array(E);for(let e=0,t=T.length;e<t;e++)M[e]=T.charCodeAt(e);M[T.length]=0;let R=new ArrayBuffer(g.length+C+E.byteLength),A=new Uint8Array(R),P=new DataView(R),I=0;for(let e=0;e<g.length;e++)P.setUint8(I++,g[e]);A.set(new Uint8Array(E),I),I+=E.byteLength;for(let e=0;e<=p;e++)for(let t=0;t<6;t++){let i=u[6*e+t];A.set(new Uint8Array(i),I),I+=i.byteLength}if(m)for(let e=0;e<6;e++){let t=c[e];A.set(new Uint8Array(t),I),I+=t.byteLength}return R}async function b(e,t,i,r,s,n,a,o){let h=await t.readPixels(r,s,void 0,!1);if(h&&h.byteLength===h.length){let e=new Float32Array(4*h.byteLength);for(let t=0;t<h.byteLength;t++)e[t]=h[t]/255,e[t]=Math.pow(e[t],2.2);h=e}else if(h&&t.gammaSpace){let e=h;for(let t=0;t<e.length;t++)e[t]=Math.pow(e[t],2.2)}let l=e.getEngine(),d=l.createRawTexture(h,n,n,5,!1,!0,1,null,i);await c.G.EncodeTextureToRGBD(d,e,i);let u=await l._readTexturePixels(d,n,n),f=await (0,_.DumpDataAsync)(n,n,u,a,void 0,!1,!0,o);return d.dispose(),f}function y(e,t){let i=(t=m(t)).specular,r=Math.log2(t.width);if(r=Math.round(r)+1,i.mipmaps.length!==6*r)throw Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);let s=Array(r);for(let n=0;n<r;n++){s[n]=Array(6);for(let r=0;r<6;r++){let a=i.mipmaps[6*n+r];s[n][r]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+a.position,a.length)}}return s}function C(e,t){t=m(t);let i=Array(6),r=t.irradiance?.irradianceTexture;if(r){if(6!==r.faces.length)throw Error(`Incorrect irradiance texture faces number "${r.faces.length}"`);for(let s=0;s<6;s++){let n=r.faces[s];i[s]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+n.position,n.length)}}return i}function T(e,t,i){let r=(i=m(i)).specular;if(!r)return Promise.resolve([]);e._lodGenerationScale=r.lodGenerationScale;let n=[],a=y(t,i);n.push(M(e,a,i.imageType));let o=i.irradiance?.irradianceTexture;if(o){let r=C(t,i),a=null;i.irradiance?.irradianceTexture?.dominantDirection&&(a=s.Pq.FromArray(i.irradiance.irradianceTexture.dominantDirection)),n.push(R(e,r,o.size,i.imageType,a))}return Promise.all(n)}async function E(e,t,i,r,s,n,a,o,h,l,d){return await new Promise((u,c)=>{if(i){let i=t.createTexture(null,!0,!0,null,1,null,e=>{c(e)},e);r?.onEffectCreatedObservable.addOnce(o=>{o.executeWhenCompiled(()=>{r.externalTextureSamplerBinding=!0,r.onApply=r=>{r._bindTexture("textureSampler",i),r.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([r],l,!0,n,a),t.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(s),u())})})}else{if(t._uploadImageToTexture(d,e,n,a),o){let i=h[a];i&&t._uploadImageToTexture(i._texture,e,n,0)}u()}})}async function M(e,t,i=f){let r=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,r.updateTextureSamplingMode(3,e),await A(e,t,!0,i),e.isReady=!0}async function R(e,t,i,r=f,s=null){let n=e.getEngine(),a=new o.h(n,5),l=new h.t(n,a);e._irradianceTexture=l,l._dominantDirection=s,a.isCube=!0,a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,a.generateMipMaps=!0,a.width=i,a.height=i,n.updateTextureSamplingMode(3,a),await A(a,[t],!1,r),n.generateMipMapsForCubemap(a),a.isReady=!0}async function A(e,t,s,a=f){if(!r.S0.IsExponentOfTwo(e.width))throw Error("Texture size must be a power of two");let l=(0,n.ILog2)(e.width)+1,u=e.getEngine(),c=!1,_=!1,g=null,p=null,m=null,v=u.getCaps();v.textureLOD?u._features.supportRenderAndCopyToLodForFloatTextures?v.textureHalfFloatRender&&v.textureHalfFloatLinearFiltering?(c=!0,e.type=2):v.textureFloatRender&&v.textureFloatLinearFiltering&&(c=!0,e.type=1):c=!1:(c=!1,_=s);let b=0;if(c)u.isWebGPU?(b=1,await i.e("3862").then(i.bind(i,8037))):await i.e("7577").then(i.bind(i,39360)),g=new d.w("rgbdDecode","rgbdDecode",null,null,1,null,3,u,!1,void 0,e.type,void 0,null,!1,void 0,b),e._isRGBD=!1,e.invertY=!1,p=u.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,_){m={};let t=e._lodGenerationScale,i=e._lodGenerationOffset;for(let r=0;r<3;r++){let s=(l-1)*t+i,n=Math.round(Math.min(Math.max(i+(s-i)*(1-r/2),0),s)),a=new o.h(u,2);a.isCube=!0,a.invertY=!0,a.generateMipMaps=!1,u.updateTextureSamplingMode(2,a);let d=new h.t(null);switch(d._isCube=!0,d._texture=a,m[n]=d,r){case 0:e._lodTextureLow=d;break;case 1:e._lodTextureMid=d;break;case 2:e._lodTextureHigh=d}}}let y=[];for(let i=0;i<t.length;i++)for(let r=0;r<6;r++){let s,n=new Blob([t[i][r]],{type:a}),o=URL.createObjectURL(n);if(u._features.forceBitmapOverHTMLImageElement)s=u.createImageBitmap(n,{premultiplyAlpha:"none"}).then(async t=>await E(t,u,c,g,o,r,i,_,m,p,e));else{let t=new Image;t.src=o,s=new Promise((s,n)=>{t.onload=()=>{E(t,u,c,g,o,r,i,_,m,p,e).then(()=>s()).catch(e=>{n(e)})},t.onerror=e=>{n(e)}})}y.push(s)}if(await Promise.all(y),t.length<l){let i,r=Math.pow(2,l-1-t.length),s=r*r*4;switch(e.type){case 0:i=new Uint8Array(s);break;case 2:i=new Uint16Array(s);break;case 1:i=new Float32Array(s)}for(let r=t.length;r<l;r++)for(let t=0;t<6;t++)u._uploadArrayBufferViewToTexture(p?.texture||e,i,t,r)}if(p){let t=e._irradianceTexture;e._irradianceTexture=null,u._releaseTexture(e),p._swapAndDie(e),e._irradianceTexture=t}g&&g.dispose(),_&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function P(e,t){let i=(t=m(t)).irradiance;if(!i)return;let r=new a.Q;s.Pq.FromArrayToRef(i.x,0,r.x),s.Pq.FromArrayToRef(i.y,0,r.y),s.Pq.FromArrayToRef(i.z,0,r.z),s.Pq.FromArrayToRef(i.xx,0,r.xx),s.Pq.FromArrayToRef(i.yy,0,r.yy),s.Pq.FromArrayToRef(i.zz,0,r.zz),s.Pq.FromArrayToRef(i.yz,0,r.yz),s.Pq.FromArrayToRef(i.zx,0,r.zx),s.Pq.FromArrayToRef(i.xy,0,r.xy),e._sphericalPolynomial=r}function I(e,t,i,r,s){let n=M(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),t).then(()=>e);return e.onRebuildCallback=e=>({proxy:n,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=r,e._lodGenerationOffset=s,e._sphericalPolynomial=i,M(e,t).then(()=>(e.isReady=!0,e))}let S={GetEnvInfo:p,CreateEnvTextureAsync:v,CreateRadianceImageDataArrayBufferViews:y,CreateIrradianceImageDataArrayBufferViews:C,UploadEnvLevelsAsync:T,UploadRadianceLevelsAsync:M,UploadIrradianceLevelsAsync:R,UploadEnvSpherical:P}},62908(e,t,i){i.d(t,{G:()=>n});var r=i(11169),s=i(53949);class n{static ExpandRGBDTexture(e){let t=e._texture;if(!t||!e.isRGBD)return;let s=t.getEngine(),n=s.getCaps(),a=t.isReady,o=!1;n.textureHalfFloatRender&&n.textureHalfFloatLinearFiltering?(o=!0,t.type=2):n.textureFloatRender&&n.textureFloatLinearFiltering&&(o=!0,t.type=1),o&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);let h=async()=>{let n=s.isWebGPU;t.isReady=!1,n?await i.e("3862").then(i.bind(i,8037)):await i.e("7577").then(i.bind(i,39360));let a=new r.w("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,t.type,void 0,null,!1,void 0,+!!n);a.externalTextureSamplerBinding=!0;let o=s.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});a.onEffectCreatedObservable.addOnce(i=>{i.executeWhenCompiled(()=>{a.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([a],o,!0),s.restoreDefaultFramebuffer(),s._releaseTexture(t),a&&a.dispose(),o._swapAndDie(t),t.isReady=!0})})};o&&(a?h():e.onLoadObservable.addOnce(h))}static async EncodeTextureToRGBD(e,t,r=0){return t.getEngine().isWebGPU?await i.e("1002").then(i.bind(i,83761)):await i.e("2049").then(i.bind(i,31336)),await (0,s.Qs)("rgbdEncode",e,t,r,1,5)}}},3418(e,t,i){i.d(t,{w:()=>r});class r{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((e,t)=>this.add(e,t))}get(e){let t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e))&&this.add(e,i),i}getOrAdd(e,t){let i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){let t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(let t in this._data){let i=this._data[t];e(t,i)}}first(e){for(let t in this._data){let i=this._data[t],r=e(t,i);if(r)return r}return null}}},71044(e,t,i){i.d(t,{K:()=>r});class r{static get UniqueId(){let e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}r._UniqueIdCounter=1},5722(e,t,i){i.d(t,{F:()=>s,Z:()=>U});var r,s,n=i(85928),a=i(58927),o=i(72210),h=i(51165),l=i(3418),d=i(42882),u=i(93965),c=i(47143),_=i(37297),f=i(24265),g=i(98304),p=i(66702),m=i(94277),v=i(87514),b=i(63331),y=i(79556),C=i(23733),T=i(53289),E=i(61405),M=i(80278),R=i(29535),A=i(83598),P=i(71044),I=i(17586),S=i(68521),O=i(64875),D=i(6180),x=i(77507),w=i(98946),B=i(35550);let F=new u.IU,k=new u.IU;(r=s||(s={}))[r.BackwardCompatible=0]="BackwardCompatible",r[r.Intermediate=1]="Intermediate",r[r.Aggressive=2]="Aggressive";class U{static DefaultMaterialFactory(e){throw(0,T.n)("StandardMaterial")}static CollisionCoordinatorFactory(){throw(0,T.n)("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];for(let t of(e=(e=(e=(e=e.concat(this.meshes)).concat(this.lights)).concat(this.cameras)).concat(this.transformNodes),this.skeletons))e=e.concat(t.bones);return e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return E.e.DragMovementThreshold}static set DragMovementThreshold(e){E.e.DragMovementThreshold=e}static get LongPressDelay(){return E.e.LongPressDelay}static set LongPressDelay(e){E.e.LongPressDelay=e}static get DoubleClickDelay(){return E.e.DoubleClickDelay}static set DoubleClickDelay(e){E.e.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return E.e.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){E.e.ExclusiveDoubleClickMode=e}get _eyePosition(){return this._forcedViewPosition??this.activeCamera?.globalPosition??u.Pq.ZeroReadOnly}bindEyePosition(e,t="vEyePosition",i=!1){let r=this._eyePosition,s=this.useRightHandedSystem===(null!=this._mirroredCameraPosition),n=this.floatingOriginOffset,a=F.set(r.x,r.y,r.z,s?-1:1),o=a.subtractFromFloatsToRef(n.x,n.y,n.z,0,k);return e&&(i?e.setFloat3(t,o.x,o.y,o.z):e.setVector4(t,o)),a}finalizeSceneUbo(){let e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null),i=this.floatingOriginOffset;return e.updateFloat4("vEyePosition",t.x-i.x,t.y-i.y,t.z-i.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=(0,O.lL)(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get _hasDefaultMaterial(){return U.DefaultMaterialFactory!==U._OriginalDefaultMaterialFactory}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=U.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph){this._frameGraph=e,e||(this.customRenderFunction=this._currentCustomRenderFunction);return}this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph,this.activeCamera=null)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=U.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(let e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e),e.addFromContainer&&e.serialize&&this._serializableComponents.push(e)}_getComponent(e){for(let t of this._components)if(t.name===e)return t;return null}get uniqueId(){return this._uniqueId}constructor(e,t){this._inputManager=new E.e(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new R.ov(.2,.2,.3,1),this.onClearColorChangedObservable=new o.cP,this.ambientColor=new R.v9(0,0,0),this.environmentIntensity=1,this.iblIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new o.cP,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.objectRenderers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new o.cP,this._onDisposeObserver=null,this.onBeforeRenderObservable=new o.cP,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new o.cP,this.onAfterRenderCameraObservable=new o.cP,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new o.cP,this.onAfterAnimationsObservable=new o.cP,this.onBeforeDrawPhaseObservable=new o.cP,this.onAfterDrawPhaseObservable=new o.cP,this.onReadyObservable=new o.cP,this.onBeforeCameraRenderObservable=new o.cP,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new o.cP,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new o.cP,this.onAfterActiveMeshesEvaluationObservable=new o.cP,this.onBeforeParticlesRenderingObservable=new o.cP,this.onAfterParticlesRenderingObservable=new o.cP,this.onDataLoadedObservable=new o.cP,this.onNewCameraAddedObservable=new o.cP,this.onCameraRemovedObservable=new o.cP,this.onNewLightAddedObservable=new o.cP,this.onLightRemovedObservable=new o.cP,this.onNewGeometryAddedObservable=new o.cP,this.onGeometryRemovedObservable=new o.cP,this.onNewTransformNodeAddedObservable=new o.cP,this.onTransformNodeRemovedObservable=new o.cP,this.onNewMeshAddedObservable=new o.cP,this.onMeshRemovedObservable=new o.cP,this.onNewSkeletonAddedObservable=new o.cP,this.onSkeletonRemovedObservable=new o.cP,this.onNewParticleSystemAddedObservable=new o.cP,this.onParticleSystemRemovedObservable=new o.cP,this.onNewAnimationGroupAddedObservable=new o.cP,this.onAnimationGroupRemovedObservable=new o.cP,this.onNewMaterialAddedObservable=new o.cP,this.onNewMultiMaterialAddedObservable=new o.cP,this.onMaterialRemovedObservable=new o.cP,this.onMultiMaterialRemovedObservable=new o.cP,this.onNewTextureAddedObservable=new o.cP,this.onTextureRemovedObservable=new o.cP,this.onNewFrameGraphAddedObservable=new o.cP,this.onFrameGraphRemovedObservable=new o.cP,this.onNewObjectRendererAddedObservable=new o.cP,this.onObjectRendererRemovedObservable=new o.cP,this.onNewPostProcessAddedObservable=new o.cP,this.onPostProcessRemovedObservable=new o.cP,this.onNewEffectLayerAddedObservable=new o.cP,this.onEffectLayerRemovedObservable=new o.cP,this.onBeforeRenderTargetsRenderObservable=new o.cP,this.onAfterRenderTargetsRenderObservable=new o.cP,this.onBeforeStepObservable=new o.cP,this.onAfterStepObservable=new o.cP,this.onActiveCameraChanged=new o.cP,this.onActiveCamerasChanged=new o.cP,this.onBeforeRenderingGroupObservable=new o.cP,this.onAfterRenderingGroupObservable=new o.cP,this.onMeshImportedObservable=new o.cP,this.onAnimationFileImportedObservable=new o.cP,this.onEnvironmentTextureChangedObservable=new o.cP,this.onMeshUnderPointerUpdatedObservable=new o.cP,this._registeredForLateAnimationBindings=new h.b(256),this._pointerPickingConfiguration=new D.d,this.onPrePointerObservable=new o.cP,this.onPointerObservable=new o.cP,this.onPreKeyboardObservable=new o.cP,this.onKeyboardObservable=new o.cP,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=U.FOGMODE_NONE,this.fogColor=new R.v9(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.frameGraphs=[],this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new u.Pq(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new h.b(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new M.A,this._activeIndices=new M.A,this._activeParticles=new M.A,this._activeBones=new M.A,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=Array(256),this._activeRequests=[],this._pendingData=[],this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new h.L(256),this._processedMaterials=new h.L(256),this._renderTargets=new h.b(256),this._materialsRenderTargets=new h.b(256),this._activeParticleSystems=new h.L(256),this._activeSkeletons=new h.b(32),this._softwareSkinnedMeshes=new h.b(32),this._activeAnimatables=[],this._transformMatrix=u.uq.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=b.B.Create(),this._beforeClearStage=b.B.Create(),this._beforeRenderTargetClearStage=b.B.Create(),this._gatherRenderTargetsStage=b.B.Create(),this._gatherActiveCameraRenderTargetsStage=b.B.Create(),this._isReadyForMeshStage=b.B.Create(),this._beforeEvaluateActiveMeshStage=b.B.Create(),this._evaluateSubMeshStage=b.B.Create(),this._preActiveMeshStage=b.B.Create(),this._cameraDrawRenderTargetStage=b.B.Create(),this._beforeCameraDrawStage=b.B.Create(),this._beforeRenderTargetDrawStage=b.B.Create(),this._beforeRenderingGroupDrawStage=b.B.Create(),this._beforeRenderingMeshStage=b.B.Create(),this._afterRenderingMeshStage=b.B.Create(),this._afterRenderingGroupDrawStage=b.B.Create(),this._afterCameraDrawStage=b.B.Create(),this._afterCameraPostProcessStage=b.B.Create(),this._afterRenderTargetDrawStage=b.B.Create(),this._afterRenderTargetPostProcessStage=b.B.Create(),this._afterRenderStage=b.B.Create(),this._pointerMoveStage=b.B.Create(),this._pointerDownStage=b.B.Create(),this._pointerUpStage=b.B.Create(),this._geometriesByUniqueId=null,this._uniqueId=0,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._floatingOriginScene=void 0,this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._freezeActiveMeshesCancel=null,this._useCurrentFrameBuffer=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._getFloatingOriginScene=()=>this._floatingOriginScene,this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[],this._uniqueId=this.getUniqueId();const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||C.q.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(C.q._LastCreatedScene=this,e.scenes.push(this)),(e.getCreationOptions().useLargeWorldRendering||t?.useFloatingOrigin)&&((0,m.Dh)(),this._floatingOriginScene=this),this._uid=null,this._renderingManager=new v.m(this),p.X&&(this.postProcessManager=new p.X(this)),(0,y.BA)()&&this.attachControl(),this._createUbo(),c.p&&(this._imageProcessingConfiguration=new c.p),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){let t;if(this._isDisposed)return!1;let i=this.getEngine(),r=i.currentRenderPassId;i.currentRenderPassId=this.activeCamera?.renderPassId??r;let s=!0;for(this._pendingData.length>0&&(s=!1),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&s&&(s=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){let r=this.meshes[t];if(!r.subMeshes||0===r.subMeshes.length)continue;if(!r.isReady(!0)){s=!1;continue}let n=r.hasThinInstances||"InstancedMesh"===r.getClassName()||"InstancedLinesMesh"===r.getClassName()||i.getCaps().instancedArrays&&r.instances.length>0;for(let e of this._isReadyForMeshStage)e.action(r,n)||(s=!1);if(!e)continue;let a=r.material||this.defaultMaterial;if(a)if(a._storeEffectOnSubMeshes)for(let e of r.subMeshes){let t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else a.hasRenderTargetTextures&&null!=a.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(a)&&(this._processedMaterials.push(a),this._materialsRenderTargets.concatWithNoDuplicate(a.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(s=!1);for(t=0;t<this.geometries.length;t++)2===this.geometries[t].delayLoadState&&(s=!1);if(this.activeCameras&&this.activeCameras.length>0)for(let e of this.activeCameras)e.isReady(!0)||(s=!1);else this.activeCamera&&!this.activeCamera.isReady(!0)&&(s=!1);for(let e of this.particleSystems)e.isReady()||(s=!1);if(this.layers)for(let e of this.layers)e.isReady()||(s=!1);if(this.effectLayers)for(let e of this.effectLayers)e.isLayerReady()||(s=!1);return i.areAllEffectsReady()||(s=!1),i.currentRenderPassId=r,s}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){let t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){let t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}async whenReadyAsync(e=!1){return await new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=a.j.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){i||r||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),(this._viewUpdateFlag!==e.updateFlag||this._projectionUpdateFlag!==t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?A.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=A.P.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e,t){let i=new _.D(this._engine,void 0,!1,e??"scene",void 0,t);return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}get floatingOriginMode(){return void 0!==this._floatingOriginScene}get floatingOriginOffset(){return this.floatingOriginMode?this._eyePosition:u.Pq.ZeroReadOnly}getUniqueId(){return P.K.UniqueId}addMesh(e,t=!1){if(!this._blockEntityCollection&&(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),n.S0.SetImmediate(()=>{this.onNewMeshAddedObservable.notifyObservers(e)}),t))for(let t of e.getChildMeshes())this.addMesh(t)}removeMesh(e,t=!1){let i=this.meshes.indexOf(e);if(-1!==i&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t)for(let t of e.getChildMeshes())this.removeMesh(t);return i}addTransformNode(e){this._blockEntityCollection||(e.getScene()!==this||-1===e._indexInSceneTransformNodesArray)&&(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){let t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){let e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){let t=this.skeletons.indexOf(e);return -1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){let t=this.morphTargetManagers.indexOf(e);return -1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){let t=this.lights.indexOf(e);if(-1!==t){for(let t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){let t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){let t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){let t=this.particleSystems.indexOf(e);return -1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),this.onParticleSystemRemovedObservable.notifyObservers(e),t}removeAnimation(e){let t=this.animations.indexOf(e);return -1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){let t=this.animationGroups.indexOf(e);return -1!==t&&this.animationGroups.splice(t,1),this.onAnimationGroupRemovedObservable.notifyObservers(e),t}removeMultiMaterial(e){let t=this.multiMaterials.indexOf(e);return -1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){let t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){let e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){let t=this.actionManagers.indexOf(e);return -1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){let t=this.textures.indexOf(e);return -1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}removeFrameGraph(e){let t=this.frameGraphs.indexOf(e);return -1!==t&&this.frameGraphs.splice(t,1),this.onFrameGraphRemovedObservable.notifyObservers(e),t}removeObjectRenderer(e){let t=this.objectRenderers.indexOf(e);return -1!==t&&this.objectRenderers.splice(t,1),this.onObjectRendererRemovedObservable.notifyObservers(e),t}removePostProcess(e){let t=this.postProcesses.indexOf(e);return -1!==t&&this.postProcesses.splice(t,1),this.onPostProcessRemovedObservable.notifyObservers(e),t}removeEffectLayer(e){let t=this.effectLayers.indexOf(e);return -1!==t&&this.effectLayers.splice(t,1),this.onEffectLayerRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){for(let t of(this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes(),this.meshes))-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());n.S0.SetImmediate(()=>{this.onNewLightAddedObservable.notifyObservers(e)})}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(S.c.CompareLightsPriority)}addCamera(e){!this._blockEntityCollection&&(this.cameras.push(e),n.S0.SetImmediate(()=>{this.onNewCameraAddedObservable.notifyObservers(e)}),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),n.S0.SetImmediate(()=>{this.onNewSkeletonAddedObservable.notifyObservers(e)}))}addParticleSystem(e){this._blockEntityCollection||(this.particleSystems.push(e),n.S0.SetImmediate(()=>{this.onNewParticleSystemAddedObservable.notifyObservers(e)}))}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||(this.animationGroups.push(e),n.S0.SetImmediate(()=>{this.onNewAnimationGroupAddedObservable.notifyObservers(e)}))}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),n.S0.SetImmediate(()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e)}))}addMaterial(e){this._blockEntityCollection||(e.getScene()!==this||-1===e._indexInSceneMaterialArray)&&(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),n.S0.SetImmediate(()=>{this.onNewMaterialAddedObservable.notifyObservers(e)}))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}addFrameGraph(e){this.frameGraphs.push(e),n.S0.SetImmediate(()=>{this.onNewFrameGraphAddedObservable.notifyObservers(e)})}addObjectRenderer(e){this.objectRenderers.push(e),n.S0.SetImmediate(()=>{this.onNewObjectRendererAddedObservable.notifyObservers(e)})}addPostProcess(e){this._blockEntityCollection||(this.postProcesses.push(e),n.S0.SetImmediate(()=>{this.onNewPostProcessAddedObservable.notifyObservers(e)}))}addEffectLayer(e){this._blockEntityCollection||(this.effectLayers.push(e),n.S0.SetImmediate(()=>{this.onNewEffectLayerAddedObservable.notifyObservers(e)}))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){let t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){let t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){let i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){let i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=!1){return this.getMaterialByUniqueId(e,t)}getMaterialByUniqueId(e,t=!1){return this._getMaterial(t,t=>t.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,t=>t.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,t=>t.name===e)}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t){for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){let i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){let i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){let t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}getFrameGraphByName(e){for(let t=0;t<this.frameGraphs.length;t++)if(this.frameGraphs[t].name===e)return this.frameGraphs[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId))&&(this.addGeometry(e),n.S0.SetImmediate(()=>{this.onNewGeometryAddedObservable.notifyObservers(e)}),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(void 0===(t=this._geometriesByUniqueId[e.uniqueId]))return!1}else if((t=this.geometries.indexOf(e))<0)return!1;if(t!==this.geometries.length-1){let e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){let t=this.getMeshById(e);if(t)return t;let i=this.getTransformNodeById(e);if(i)return i;let r=this.getLightById(e);if(r)return r;let s=this.getCameraById(e);if(s)return s;let n=this.getBoneById(e);return n||null}getNodeByName(e){let t=this.getMeshByName(e);if(t)return t;let i=this.getTransformNodeByName(e);if(i)return i;let r=this.getLightByName(e);if(r)return r;let s=this.getCameraByName(e);if(s)return s;let n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){let i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){let r=i.getTarget(t);if(r.id===e)return r}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){let i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){let r=i.getTarget(t);if(r.name===e)return r}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){let i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return -1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=n.S0.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new l.w),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new l.w),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(let i of this._evaluateSubMeshStage)i.action(t,e);let i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){let t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,s=!1){if(this.frameGraph){this._renderWithFrameGraph(!0,!1,!0);let n=this.frameGraph.getTasksByClassName(["FrameGraphObjectRendererTask","FrameGraphGeometryRendererTask"]);for(let e of n)e.objectRenderer._freezeActiveMeshes(r);return this._freezeActiveMeshesCancel=(0,B.B)(()=>{let e=!0,t=!0;for(let i of n)e&&(e=i.objectRenderer._isFrozen),t&&(t=null!==i.objectRenderer._freezeActiveMeshesCancel);if(e)return!0;if(!t)throw Error("Freezing active meshes was cancelled");return!1},()=>{this._freezeActiveMeshesCancel=null,this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,t?.()},(e,t)=>{if(this._freezeActiveMeshesCancel=null,this.unfreezeActiveMeshes(),t){let t="Scene: Timeout while waiting for meshes to be frozen.";i?i(t):(x.V.Error(t),e&&x.V.Error(e))}else{let t="Scene: An unexpected error occurred while trying to freeze active meshes.";i?i(t):(x.V.Error(t),e&&(x.V.Error(e),e.stack&&x.V.Error(e.stack)))}}),this}return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=s,this._skipEvaluateActiveMeshesCompletely=e,r)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}if(this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null,this.frameGraph)for(let e of this.frameGraph.getTasksByClassName(["FrameGraphObjectRendererTask","FrameGraphGeometryRendererTask"]))e.objectRenderer._unfreezeActiveMeshes();else for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode){this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){let e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){let e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;for(let e of(this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset(),this._beforeEvaluateActiveMeshStage))e.action();let e=this.getActiveMeshCandidates(),t=e.length;for(let i=0;i<t;i++){let t=e.data[i],r=t._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(r?r[1]=-1:(r=[t,-1],t._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,r)),t.isBlocked||(this._totalVertices.addCount(t.getTotalVertices(),!1),!t.isReady()||!t.isEnabled()||t.scaling.hasAZeroComponent))continue;t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t);let s=this.customLODSelector?this.customLODSelector(t,this.activeCamera):t.getLOD(this.activeCamera);if(r[0]=s,r[1]=this._frameId,null!=s&&(s!==t&&0!==s.billboardMode&&s.computeWorldMatrix(),t._preActivate(),t.isVisible&&t.visibility>0&&(t.layerMask&this.activeCamera.layerMask)!=0&&(this._skipFrustumClipping||t.alwaysSelectAsActiveMesh||t.isInFrustum(this._frustumPlanes)))){for(let e of(this._activeMeshes.push(t),this.activeCamera._activeMeshes.push(t),s!==t&&s._activate(this._renderId,!1),this._preActiveMeshStage))e.action(t);t._activate(this._renderId,!1)&&(t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(s=t):s._internalAbstractMeshDataInfo._onlyForInstances=!1,s._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(t,s)),t._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){let t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;let i=t.emitter;(!i.position||i.isEnabled())&&(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){this._skeletonsEnabled&&e.skeleton&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),!e.computeBonesUsingShaders&&this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){let r=this.getActiveSubMeshCandidates(t),s=r.length;i=i||1===s;for(let n=0;n<s;n++){let s=r.data[n];this._evaluateSubMesh(s,t,e,i)}}}updateTransformMatrix(e){let t=this.activeCamera;if(t)if(t._renderingMultiview){let i=t._rigCameras[0],r=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),r.getViewMatrix(),r.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){!this._useCurrentFrameBuffer&&(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){let t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||e.isRightCamera||(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){if(e&&e._skipRendering)return;let r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw Error("Active camera not set");if(r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){let t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}for(let i of(this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture),this._gatherActiveCameraRenderTargetsStage))i.action(this._renderTargets);let s=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){let e;n.S0.StartPerformanceCounter("Render targets",this._renderTargets.length>0);let t=this.getBoundingBoxRenderer?.();for(let i=0;i<this._renderTargets.length;i++){let r=this._renderTargets.data[i];if(r._shouldRender()){this._renderId++;let i=r.activeCamera&&r.activeCamera!==this.activeCamera;t&&!e&&((e=t.renderList.length>0?t.renderList.data.slice():[]).length=t.renderList.length),r.render(i,this.dumpNextRenderTargets),s=!0}}t&&e&&(t.renderList.data=e,t.renderList.length=e.length),n.S0.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(let e of this._cameraDrawRenderTargetStage)s=e.action(this.activeCamera)||s;this._intermediateRendering=!1}for(let t of(this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??0,s&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame(),this._beforeCameraDrawStage))t.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this);let a=r.snapshotRendering&&1===r.snapshotRenderingMode;for(let e of(a&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!a),this.onAfterDrawPhaseObservable.notifyObservers(this),this._afterCameraDrawStage))e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){let t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(let e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){let t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){let i=t.actionManager.actions[e];if(12===i.trigger||13===i.trigger){let e=i.getTriggerParameter(),r=e.mesh?e.mesh:e,s=r.intersectsMesh(t,e.usePreciseIntersection),n=t._intersectionsInProgress.indexOf(r);s&&-1===n?12===i.trigger?(i._executeCurrent(g.X.CreateNew(t,void 0,r)),t._intersectionsInProgress.push(r)):13===i.trigger&&t._intersectionsInProgress.push(r):!s&&n>-1&&(13===i.trigger&&i._executeCurrent(g.X.CreateNew(t,void 0,r)),t.actionManager.hasSpecificTrigger(13,e=>r===(e.mesh?e.mesh:e))&&13!==i.trigger||t._intersectionsInProgress.splice(n,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(U.MinDeltaTime,Math.min(this._engine.getDeltaTime(),U.MaxDeltaTime))+this._timeAccumulator,t=this._engine.getTimeStep(),i=1e3/t/1e3,r=0,s=this._engine.getLockstepMaxSteps(),n=Math.floor(e/t);for(n=Math.min(n,s);e>0&&r<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{let e=this.useConstantAnimationDeltaTime?16:Math.max(U.MinDeltaTime,Math.min(this._engine.getDeltaTime(),U.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=!1),e?.rigCameras?.length)for(let t=0;t<e.rigCameras.length;++t){let i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(let t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1,i=!1){if(this.activeCamera=null,this.activeCameras=null,e){for(let e of this.cameras)if(e.update(),0!==e.cameraRigMode)for(let t=0;t<e._rigCameras.length;t++)e._rigCameras[t].update()}for(let e of(this.onBeforeRenderObservable.notifyObservers(this),this._beforeClearStage))e.action();if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();else{let e=this.getActiveMeshCandidates(),t=e.length;if(this._activeMeshesFrozen){if(!this._skipEvaluateActiveMeshesCompletely)for(let i=0;i<t;i++){let t=e.data[i];t._internalAbstractMeshDataInfo._wasActiveLastFrame&&t.computeWorldMatrix()}if(this.particlesEnabled){let e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}}else{this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();for(let r=0;r<t;r++){let t=e.data[r];t._internalAbstractMeshDataInfo._wasActiveLastFrame=!1,!t.isBlocked&&(this._totalVertices.addCount(t.getTotalVertices(),!1),t.isReady()&&t.isEnabled()&&!t.scaling.hasAZeroComponent&&(t.computeWorldMatrix(i),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t)))}if(this.particlesEnabled)for(let e=0;e<this.particleSystems.length;e++){let t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;let i=t.emitter;(!i.position||i.isEnabled())&&(this._activeParticleSystems.push(t),t.animate())}}}this.frameGraph?.execute()}_renderRenderTarget(e,t,i=!1,r=!1){if(this._intermediateRendering=!0,e._shouldRender()){if(this._renderId++,this.activeCamera=t,!this.activeCamera)throw Error("Active camera not set");this._engine.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),e.render(i,r)}this._intermediateRendering=!1}render(e=!0,t=!1){if(!this.isDisposed){if(this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),m.k2.getScene=this._getFloatingOriginScene,this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length)for(let e of this.activeCameras)this._checkCameraRenderTarget(e);for(let e of(this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate(),this._beforeCameraUpdateStage))e.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update()}if(this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{this.onBeforeRenderObservable.notifyObservers(this),this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);let e=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){n.S0.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);for(let t=0;t<this.customRenderTargets.length;t++){let i=this.customRenderTargets[t],r=i.activeCamera||this.activeCamera;this._renderRenderTarget(i,r,e!==r,this.dumpNextRenderTargets)}n.S0.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._renderId++}for(let t of(this._engine.currentRenderPassId=e?.renderPassId??0,this.activeCamera=e,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this._beforeClearStage))t.action();for(let e of(this._clearFrameBuffer(this.activeCamera),this._gatherRenderTargetsStage))e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}for(let e of(this._checkIntersections(),this._afterRenderStage))e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){let t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;if(this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations){for(let e of this._activeAnimatables)e.onAnimationEndObservable.clear(),e.onAnimationEnd=null;this.stopAllAnimations()}for(let e of(this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0,this._activeRequests.slice()))e.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){x.V.Error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,e=>e.dispose(!0)),this._disposeList(this.transformNodes,e=>e.dispose(!0));let e=this.cameras;this._disposeList(e),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._disposeList(this.frameGraphs),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let t=this._engine.scenes.indexOf(this);if(t>-1&&this._engine.scenes.splice(t,1),this._floatingOriginScene=void 0,0===this._engine.scenes.length&&(0,m.oW)(),C.q._LastCreatedScene===this){C.q._LastCreatedScene=null;let e=C.q.Instances.length-1;for(;e>=0;){let t=C.q.Instances[e];if(t.scenes.length>0){C.q._LastCreatedScene=t.scenes[this._engine.scenes.length-1];break}e--}}(t=this._engine._virtualScenes.indexOf(this))>-1&&this._engine._virtualScenes.splice(t,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onNewFrameGraphAddedObservable.clear(),this.onFrameGraphRemovedObservable.clear(),this.onNewObjectRendererAddedObservable.clear(),this.onObjectRendererRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){let i=e.slice(0);for(let e of(t=t??(e=>e.dispose()),i))t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(let e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){let t=new u.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new u.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let r of(e=e||(()=>!0),this.meshes.filter(e))){if(r.computeWorldMatrix(!0),!r.subMeshes||0===r.subMeshes.length||r.infiniteDistance)continue;let e=r.getBoundingInfo(),s=e.boundingBox.minimumWorld,n=e.boundingBox.maximumWorld;u.Pq.CheckExtends(s,t,i),u.Pq.CheckExtends(n,t,i)}return t.x===Number.MAX_VALUE?{min:u.Pq.Zero(),max:u.Pq.Zero()}:{min:t,max:i}}createPickingRay(e,t,i,r,s=!1){throw(0,T.n)("Ray")}createPickingRayToRef(e,t,i,r,s,n=!1,a=!1){throw(0,T.n)("Ray")}createPickingRayInCameraSpace(e,t,i){throw(0,T.n)("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw(0,T.n)("Ray")}pick(e,t,i,r,s,n){let a=(0,T.n)("Ray",!0);return a&&x.V.Warn(a),new f.G}pickWithBoundingInfo(e,t,i,r,s){let n=(0,T.n)("Ray",!0);return n&&x.V.Warn(n),new f.G}pickWithRay(e,t,i,r){throw(0,T.n)("Ray")}multiPick(e,t,i,r,s){throw(0,T.n)("Ray")}multiPickWithRay(e,t,i){throw(0,T.n)("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(let e of this.geometries)e._rebuild();for(let e of this.meshes)e._rebuild();for(let e of(this.postProcessManager&&this.postProcessManager._rebuild(),this._components))e.rebuild();for(let e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(let e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(let e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(void 0===t)return e;let r=[];for(let s in e){let n=e[s];d.Y&&d.Y.MatchesQuery(n,t)&&(!i||i(n))&&r.push(n)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(127))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(let i of this.materials)(!t||t(i))&&i.markAsDirty(e)}_loadFile(e,t,i,r,s,n,a){let o=(0,I.zU)(e,t,i,r?this.offlineProvider:void 0,s,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),o}async _loadFileAsync(e,t,i,r,s){return await new Promise((n,a)=>{this._loadFile(e,e=>{n(e)},t,i,r,(e,t)=>{a(t)},s)})}_requestFile(e,t,i,r,s,n,a){let o=(0,I.sh)(e,t,i,r?this.offlineProvider:void 0,s,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),o}async _requestFileAsync(e,t,i,r,s){return await new Promise((n,a)=>{this._requestFile(e,e=>{n(e)},t,i,r,e=>{a(e)},s)})}_readFile(e,t,i,r,s){let n=(0,I.NJ)(e,t,i,r,s);return this._activeRequests.push(n),n.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),n}async _readFileAsync(e,t,i){return await new Promise((r,s)=>{this._readFile(e,e=>{r(e)},t,i,e=>{s(e)})})}getPerfCollector(){throw(0,T.n)("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}U.FOGMODE_NONE=0,U.FOGMODE_EXP=1,U.FOGMODE_EXP2=2,U.FOGMODE_LINEAR=3,U.MinDeltaTime=1,U.MaxDeltaTime=1e3,U._OriginalDefaultMaterialFactory=U.DefaultMaterialFactory,(0,w.Y5)("BABYLON.Scene",U)},63331(e,t,i){i.d(t,{B:()=>s,v:()=>r});class r{}r.NAME_EFFECTLAYER="EffectLayer",r.NAME_LAYER="Layer",r.NAME_LENSFLARESYSTEM="LensFlareSystem",r.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",r.NAME_PARTICLESYSTEM="ParticleSystem",r.NAME_GAMEPAD="Gamepad",r.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",r.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",r.NAME_PREPASSRENDERER="PrePassRenderer",r.NAME_DEPTHRENDERER="DepthRenderer",r.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",r.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",r.NAME_SPRITE="Sprite",r.NAME_SUBSURFACE="SubSurface",r.NAME_OUTLINERENDERER="Outline",r.NAME_PROCEDURALTEXTURE="ProceduralTexture",r.NAME_SHADOWGENERATOR="ShadowGenerator",r.NAME_OCTREE="Octree",r.NAME_PHYSICSENGINE="PhysicsEngine",r.NAME_AUDIO="Audio",r.NAME_FLUIDRENDERER="FluidRenderer",r.NAME_IBLCDFGENERATOR="iblCDFGenerator",r.NAME_CLUSTEREDLIGHTING="ClusteredLighting",r.STEP_ISREADYFORMESH_EFFECTLAYER=0,r.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,r.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,r.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_PREPASS=0,r.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,r.STEP_BEFORECAMERADRAW_LAYER=2,r.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,r.STEP_BEFORERENDERTARGETDRAW_LAYER=1,r.STEP_BEFORERENDERINGMESH_PREPASS=0,r.STEP_BEFORERENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGMESH_PREPASS=0,r.STEP_AFTERRENDERINGMESH_OUTLINE=1,r.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,r.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,r.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,r.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,r.STEP_BEFORECLEAR_PREPASS=1,r.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,r.STEP_AFTERRENDERTARGETDRAW_LAYER=1,r.STEP_AFTERCAMERADRAW_PREPASS=0,r.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,r.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,r.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,r.STEP_AFTERCAMERADRAW_LAYER=4,r.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,r.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,r.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,r.STEP_AFTERRENDER_AUDIO=0,r.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,r.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,r.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,r.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,r.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,r.STEP_GATHERACTIVECAMERARENDERTARGETS_CLUSTEREDLIGHTING=2,r.STEP_POINTERMOVE_SPRITE=0,r.STEP_POINTERDOWN_SPRITE=0,r.STEP_POINTERUP_SPRITE=0;class s extends Array{constructor(e){super(...e)}static Create(){return Object.create(s.prototype)}registerStep(e,t,i){let r=0,s=Number.MAX_VALUE;for(;r<this.length&&!(e<this[r].index);r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}}}]);