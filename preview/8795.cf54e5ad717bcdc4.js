/*
 *  This file is part of Cosmos Journeyer
 *
 *  Copyright (C) 2024 Barthélemy Paléologue <barth.paleologue@cosmosjourneyer.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";(globalThis.webpackChunk_cosmos_journeyer_game=globalThis.webpackChunk_cosmos_journeyer_game||[]).push([["8795"],{93039:function(e,t,i){i.d(t,{A:()=>s});var r=i(59530),n=i(26934),a=i(16891);let o="undefined"==typeof performance?()=>performance.now():()=>Date.now();class s extends a.A{constructor(e={}){let t;super(),Array.isArray(e)&&(e={bindings:e}),this.name=e.name||"";const i=[],a=[];let s=!1,l=!0,c=null,f=0;this.bindings=i,this.processors=a,this.bind=(e,r)=>{if(r||e instanceof n.A||(r=e),r&&r.control&&(e=r.control),!(e instanceof n.A))throw Error("Binding requires an InputControl");let a={control:e,processors:r&&r.processors};return i.push(a),void 0===t&&(t=Object.getPrototypeOf(e).constructor.defaultValue),(null==r?void 0:r.autoUpdate)!==!1&&e.on("change",this.update),i.length-1},this.unbind=e=>{if(e<i.length&&e>=0){let t=i[e];i.splice(e,1),t.control.off("change",this.update)}},this.update=()=>{if(!l)return;let e=t;c=null;let n=-1/0;for(let e=0;e<i.length;e++){let a=i[e],{control:s}=a;if(s.enabled){let e=a.processors?(0,r.A)(a.processors,s.read()):s.read(),i=s.magnitude(e);i>n&&(t=e,n=i,i>0&&(c=a,f||(f=o())))}}c||(f=0),void 0!==t&&(t=(0,r.A)(a,t)),this.emit("update"),t!==e&&this.emit("change")};const u=this.destroy;this.destroy=()=>{s=!0,l=!1,u()},Object.defineProperties(this,{enabled:{set(e){(e=!!e)===l||s||((l=e)?this.emit("enable"):this.emit("disable"))},get:()=>l},activeControl:{get:()=>c?c.control:null},value:{get:()=>t}}),e.bindings&&e.bindings.forEach(e=>{this.bind(e)}),e.processors&&a.push(...e.processors),!1===e.enabled&&(this.enabled=!1)}}},9059:function(e,t,i){i.d(t,{$9:()=>a,Ct:()=>o,pF:()=>n});var r=i(16891);class n extends r.A{}class a extends n{}class o extends a{}},60688:function(e,t,i){i.d(t,{A:()=>a});var r=i(65959),n=i(82090);class a extends n.A{constructor(e){const{negative:t,positive:i}=e;super(()=>{let e=this.children.get("negative").read();return this.children.get("positive").read()-e},(0,r.Tt)(e,["negative","positive"])),this.children.set("negative",t),this.children.set("positive",i);const n=()=>this.emit("change");this.children.forEach(e=>{e.on("change",n)})}}},82090:function(e,t,i){i.d(t,{A:()=>n});var r=i(26934);class n extends r.A{constructor(e,t){e&&"function"!=typeof e&&!t&&(t=e,e=null),super(e,t),this.axis=this.read}}},54451:function(e,t,i){i.d(t,{A:()=>n});var r=i(82090);class n extends r.A{constructor(e,t){e&&"object"==typeof e&&!t&&(t=e,e=null),super(e,t),this.pressPoint=.5,(null==t?void 0:t.pressPoint)!==void 0&&(this.pressPoint=null==t?void 0:t.pressPoint)}pressed(e=this.magnitude()){return e>=this.pressPoint}}},36960:function(e,t,i){i.d(t,{A:()=>a});var r=i(65959),n=i(91806);class a extends n.A{constructor(e){var{left:t,right:i,up:n,down:a}=e;super(()=>[this.children.get("right").read()-this.children.get("left").read(),this.children.get("up").read()-this.children.get("down").read()],(0,r.Tt)(e,["left","right","up","down"])),this.children.set("left",t),this.children.set("right",i),this.children.set("up",n),this.children.set("down",a);const o=()=>this.emit("change");this.children.forEach(e=>{e.on("change",o)})}}},26934:function(e,t,i){i.d(t,{A:()=>o});var r=i(65959),n=i(59530),a=i(16891);class o extends a.A{constructor(e,t){super(),this.name="",this.parent=null,this.enabled=!0,this.children=new Map,this.device=null,this.processors=[],e&&"object"==typeof e&&!t&&(t=e,e=void 0);const i=t||{},{processors:a,children:o,active:s}=i;if(!function(e,t){t&&Object.keys(e).forEach(i=>{i in t&&"function"!=typeof e[i]&&(e[i]=t[i])})}(this,(0,r.Tt)(i,["processors","children","active"])),this.device&&this.device.on("change",()=>{this.enabled&&this.emit("change")}),a)for(const e of a)this.processors.push(e);if(o)for(const[e,t]of Array.isArray(o)||o instanceof Map?o:Object.entries(o))this.children.set(e,t);const l=e||this.read.bind(this),c=()=>(0,n.A)(this.processors,l());this.read=()=>this.enabled?c():Object.getPrototypeOf(this).constructor.defaultValue,"function"==typeof s&&(this.active=()=>s(this));const f=this.destroy;this.destroy=()=>{f(),this.children.forEach(e=>e.destroy())}}find(e){if(!e)return this;let t=e.indexOf("/");if(t>0){let i=e.substring(0,t),r=this.children.get(i);if(r)return r.find(e.substring(t+1))}return this.children.get(e)||null}read(){return Object.getPrototypeOf(this).constructor.defaultValue}magnitude(e=this.read()){return"number"==typeof e?Math.abs(e):0}active(){return this.magnitude()>0}}o.defaultValue=0},72450:function(e,t,i){i.d(t,{A:()=>s});var r=i(91806),n=i(54451);function a(e,t,i){let[r,n]=e,a=Math.hypot(r,n),o=function(e,t=.125,i=.925){let r=Math.abs(e);return r<t?0:r>i?Math.sign(e):Math.sign(e)*(r-t)/(i-t)}(a,t,i);if(0===o)return[0,0];let s=o/a;return[r*s,n*s]}let o=[["left",0,!0],["right",0,!1],["down",1,!0],["up",1,!1]];class s extends r.A{constructor(e,t){e&&"object"==typeof e&&!t&&(t=e,e=null),super(e,Object.assign({processors:[a]},t)),o.forEach(([e,i,r])=>{var a,o;let s;a=this,s=Object.assign({},(o=t)&&o[e],{parent:a,device:a.device}),a[e]=new n.A(()=>{var e;let t;return e=a.read,t=e()[i],Math.max(0,r?-t:t)},s),a.children.set(e,a[e])});const i=()=>this.emit("change");this.children.forEach(e=>{e.on("change",i)})}}},91806:function(e,t,i){i.d(t,{A:()=>o});var r=i(65959),n=i(26934),a=i(82090);class o extends n.A{constructor(e,t){e&&"object"==typeof e&&!t&&(t=e,e=null);const i=t||{},{x:n,y:o}=i;super(e,(0,r.Tt)(i,["x","y"])),this.vector2=this.read,this.x=new a.A(()=>this.read()[0],Object.assign({},n,{parent:this,device:null==t?void 0:t.device})),this.y=new a.A(()=>this.read()[1],Object.assign({},o,{parent:this,device:null==t?void 0:t.device})),this.children.set("x",this.x),this.children.set("y",this.x);const s=()=>this.emit("change");this.children.forEach(e=>{e.on("change",s)})}magnitude(e=this.read()){return Math.hypot(e[0],e[1])}active(){let e=this.read();return 0!==e[0]||0!==e[1]}}o.defaultValue=[0,0]},67924:function(e,t,i){let r={dpadUp:12,dpadDown:13,dpadLeft:14,dpadRight:15,L1:4,L2:6,L3:10,R1:5,R2:7,R3:11,A:0,B:1,X:2,Y:3,start:9,select:8,home:16},n=[];Object.keys(r).forEach(e=>{n[r[e]]=e});var a=i(54451),o=i(72450),s=i(82090),l=i(9059);let c=new Set(n);["leftStick","rightStick"].forEach(e=>c.add(e)),a.A,o.A,s.A,l.Ct},98648:function(e,t,i){i.d(t,{A:()=>s});var r=i(65959),n=i(54451),a=i(28346),o=i(9059);class s extends o.pF{constructor(e){super();let t=!1,i=!1;const o=(null==e?void 0:e.keyCode)!==!1,s=new Set,l=e=>{let t=o?e.code:e.key;s.add(t),s.add(t.toLowerCase()),this.emit("change")},c=e=>{let t=o?e.code:e.key;s.delete(t),s.delete(t.toLowerCase()),this.emit("change")};function f(){return s.size>0}function u(e){return s.has(e.toLowerCase())}const d=(e=!1)=>{!i&&(i=!0,window.addEventListener("keydown",l),window.addEventListener("keyup",c),e&&this.emit("enable"))},h=(e=!1)=>{i&&(i=!1,s.clear(),window.removeEventListener("keydown",l),window.removeEventListener("keyup",c),e&&this.emit("disable"))};this.getControl=(e,t={})=>{let{filter:i=e}=t,o=(0,r.Tt)(t,["filter"]),l=f;return i&&("string"==typeof i?l=()=>u(i):"function"==typeof i?l=()=>f()&&i(new Set(s)):Array.isArray(i)&&(l=()=>i.some(u))),new n.A((0,a.A)(l),Object.assign({name:t.filter?String(e||i):"string"==typeof i&&i?`key:${i}`:String(e||i||"any key")},o,{device:this,children:null}))};const p=this.destroy;this.destroy=()=>{t=!0,p(),h()},Object.defineProperties(this,{connected:{enumerable:!1,configurable:!1,writable:!1,value:!0},enabled:{get:()=>i,set(e){e&&!t?d(!0):h(!0)}}}),(null==e?void 0:e.enabled)!==!1&&d()}}},91020:function(e,t,i){i.d(t,{A:()=>h});var r=i(54451),n=i(82090),a=i(91806),o=i(28346),s=i(9059);let l={leftMouseButton:{device:"mouse",index:0},touch:{device:"touch",index:0},penTip:{device:"pen",index:0},middleMouseButton:{device:"mouse",index:1},rightMouseButton:{device:"mouse",index:2},penBarrelButton:{device:"pen",index:2},mouseBackButton:{device:"mouse",index:3},mouseForwardButton:{device:"mouse",index:4},penEraser:{device:"pen",index:5}},c=[],f=new Set(Object.keys(l));f.forEach(e=>{let{device:t,index:i}=l[e];c[i]||(c[i]={}),c[i][t]=e});let u={position:{constructor:a.A,reader:e=>[e.x,e.y]},pagePosition:{constructor:a.A,reader:e=>[e.pageX,e.pageY]},screenPosition:{constructor:a.A,reader:e=>[e.screenX,e.screenY]},tilt:{constructor:a.A,reader:e=>[e.screenX/90,e.screenY/90]},contact:{constructor:a.A,reader:e=>[e.width,e.height]},delta:{constructor:a.A,reader:(e,t,i)=>{if(!t)return i;let r=(e.timeStamp-t.timeStamp)*.1||1;return[(e.x-t.x)/r,(e.y-t.y)/r]}},pageDelta:{constructor:a.A,reader:(e,t,i)=>{if(!t)return i;let r=e.timeStamp-t.timeStamp||1;return[(e.pageX-t.pageX)/r,(e.pageY-t.pageY)/r]}},screenDelta:{constructor:a.A,reader:"movementX"in MouseEvent.prototype?(e,t,i)=>e?[e.movementX,e.movementY]:i:(e,t,i)=>{if(!t)return i;let r=e.timeStamp-t.timeStamp||1;return[(e.screenX-t.screenX)/r,(e.screenY-t.screenY)/r]}}},d={constructor:n.A,reader:e=>e.pressure||0};class h extends s.$9{constructor(e={}){super();const{updatePeriod:t=1e3/60,element:i=document.body,touch:n=!0,pen:s=!0,mouse:l=!0,touchActionStyle:h=!0}=e;let{enabled:p=!0}=e,m=null,_=null,g=null;const v={pen:s,mouse:l,touch:n},S=new Set,E=e=>{if(p&&e.isPrimary&&v[e.pointerType]){_&&(!m||_.timeStamp-m.timeStamp>=t)&&(m=_),_=e;for(let t=0;t<c.length;t++){let i=1<<t,r=e.buttons&i,n=function(e,t=e.button){return t>=0&&t<c.length&&e.isPrimary&&c[t][e.pointerType]||""}(e,t);r?S.add(n):S.delete(n)}this.emit("change")}},T=()=>{_=m=null},A=e=>{g=e},x=h&&i.style?i:document.body;function I(){p=!0,window.addEventListener("pointerdown",E),window.addEventListener("pointerup",E),window.addEventListener("pointermove",E),window.addEventListener("pointerout",T),window.addEventListener("wheel",A)}function R(){p=!1,m=null,_=null,g=null,h&&(x.style.touchAction=""),S.clear(),window.removeEventListener("pointerdown",E),window.removeEventListener("pointerup",E),window.removeEventListener("pointermove",E),window.removeEventListener("pointerout",T),window.removeEventListener("wheel",A)}h&&(x.style.touchAction="none"),this.getControl=(e,i={})=>{let n="pressure"===e?d:u[e];if(n){let{constructor:t,reader:r}=n;return new t(()=>_?r(_,m,t.defaultValue):t.defaultValue,Object.assign({name:e},i,{device:this}))}if(f.has(e))return new r.A((0,o.A)(()=>S.has(e.toLowerCase())),Object.assign({name:e},i,{device:this}));if("wheel"===e)return new a.A(()=>(g&&performance.now()-g.timeStamp>t&&(g=null),g?[g.deltaX,g.deltaY]:a.A.defaultValue),Object.assign({name:e},i,{device:this}));throw Error("Control not found")},this.destroy=()=>{R()},Object.defineProperties(this,{pointerType:{get:()=>_&&_.pointerType||""},connected:{enumerable:!1,configurable:!1,writable:!1,value:!0},timestamp:{get:()=>_&&_.timeStamp||0},enabled:{get:()=>p,set(e){!!e!=!!p&&(e?I():R())}}}),p&&I()}}},76692:function(e,t,i){var r=i(72450),n=i(9059);r.A,n.pF},60393:function(e,t,i){i(93039),i(26934),i(60688),i(82090),i(54451),i(36960),i(72450),i(91806)},11787:function(e,t,i){i.d(t,{A:()=>a});var r=i(16891);let n={disabled:{started:["cancel","disable"],"*":["disable"]},ready:{started:["cancel","ready"],"*":["ready"]},started:{disabled:["enable","start"],"*":["start"]},complete:{disabled:["enable","start","complete"],started:["complete"],"*":["start","complete"]}};class a extends r.A{constructor(e){if(!e)throw Error("Interaction requires an Action");super();let t=!1,i=!0,r="ready",a=0;const o=e=>{if(r===e)return;let t=n[e],i=t[r]||t["*"];r=e,i.forEach(e=>this.emit(e))},s=()=>{(a=i?this.evaluate():0)<=0?o("ready"):a>=1?o("complete"):o("started")};e.on("change",s),e.on("enable",s),e.on("disable",s),this.update=s;const l=this.destroy;this.destroy=()=>{t=!0,i=!1,l()},this.destroy=()=>{e.off("change",s),e.off("enable",s),e.off("disable",s),l()},Object.defineProperties(this,{enabled:{set(e){(e=!!e)===i||t||((i=e)?o("ready"):o("disabled"))},get:()=>i},action:{get:()=>e},state:{get:()=>r}})}evaluate(){var e;return+(((null==(e=this.action.activeControl)?void 0:e.magnitude())||0)>0)}}},4762:function(e,t,i){i.d(t,{A:()=>n});var r=i(11787);class n extends r.A{constructor(e,t){super(e),this.pressPoint=.5,t>=0&&(this.pressPoint=t)}evaluate(){var e;return+(((null==(e=this.action.activeControl)?void 0:e.magnitude())||0)>=this.pressPoint)}}},57324:function(e,t,i){i.d(t,{A:()=>n});var r=i(11787);class n extends r.A{constructor(e,t){super(e),this.pressPoint=.5,"number"==typeof t&&t>=0&&(this.pressPoint=t);let i=!1,r=0;this.evaluate=()=>{var e;clearTimeout(r);let t=i;return(i=((null==(e=this.action.activeControl)?void 0:e.magnitude())||0)>=this.pressPoint)?.5:t?(r=setTimeout(this.update,0),1):0}}}},16891:function(e,t,i){i.d(t,{A:()=>r});class r{constructor(){const{all:e,on:t,off:i,emit:r}=function(e){return{all:e=e||new Map,on:function(t,i){var r=e.get(t);r?r.push(i):e.set(t,[i])},off:function(t,i){var r=e.get(t);r&&(i?r.splice(r.indexOf(i)>>>0,1):e.set(t,[]))},emit:function(t,i){var r=e.get(t);r&&r.slice().map(function(e){e(i)}),(r=e.get("*"))&&r.slice().map(function(e){e(t,i)})}}}();this.on=t,this.off=i,this.emit=r,this.destroy=()=>e.clear()}}},28346:function(e,t,i){i.d(t,{A:()=>r});let r=e=>()=>+!!e()},59530:function(e,t,i){i.d(t,{A:()=>n});let r=(e,t)=>t(e);function n(e,t){return e.reduce(r,t)}},88314:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.makeNoise2D=void 0;var i=(3-Math.sqrt(3))/6,r=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[1,0],[-1,0],[0,1],[0,-1],[0,1],[0,-1]];t.makeNoise2D=function(e){void 0===e&&(e=Math.random);for(var t,n,a=new Uint8Array(256),o=0;o<256;o++)a[o]=o;for(var o=255;o>0;o--)t=Math.floor((o+1)*e()),n=a[o],a[o]=a[t],a[t]=n;for(var s=new Uint8Array(512),l=new Uint8Array(512),o=0;o<512;o++)s[o]=a[255&o],l[o]=s[o]%12;return function(e,t){var n=(e+t)*.5*(Math.sqrt(3)-1),a=Math.floor(e+n),o=Math.floor(t+n),c=(a+o)*i,f=e-(a-c),u=t-(o-c),d=+(f>u),h=f>u?0:1,p=f-d+i,m=u-h+i,_=f-1+2*i,g=u-1+2*i,v=255&a,S=255&o,E=r[l[v+s[S]]],T=r[l[v+d+s[S+h]]],A=r[l[v+1+s[S+1]]],x=.5-f*f-u*u,I=x<0?0:Math.pow(x,4)*(E[0]*f+E[1]*u),R=.5-p*p-m*m,C=R<0?0:Math.pow(R,4)*(T[0]*p+T[1]*m),b=.5-_*_-g*g;return 70.14805770653952*(I+C+(b<0?0:Math.pow(b,4)*(A[0]*_+A[1]*g)))}}},66039:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.makeNoise3D=void 0;var i=1/6,r=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,-1],[0,1,-1],[0,-1,-1]];t.makeNoise3D=function(e){void 0===e&&(e=Math.random);for(var t,n,a=new Uint8Array(256),o=0;o<256;o++)a[o]=o;for(var o=255;o>0;o--)t=Math.floor((o+1)*e()),n=a[o],a[o]=a[t],a[t]=n;for(var s=new Uint8Array(512),l=new Uint8Array(512),o=0;o<512;o++)s[o]=a[255&o],l[o]=s[o]%12;return function(e,t,n){var a,o,c,f,u,d,h=(e+t+n)/3,p=Math.floor(e+h),m=Math.floor(t+h),_=Math.floor(n+h),g=(p+m+_)*i,v=e-(p-g),S=t-(m-g),E=n-(_-g);v>=S?S>=E?(a=f=u=1,o=c=d=0):v>=E?(a=f=d=1,o=c=u=0):(c=f=d=1,a=o=u=0):S<E?(c=u=d=1,a=o=f=0):v<E?(o=u=d=1,a=c=f=0):(o=f=u=1,a=c=d=0);var T=v-a+i,A=S-o+i,x=E-c+i,I=v-f+2*i,R=S-u+2*i,C=E-d+2*i,b=v-1+3*i,y=S-1+3*i,L=E-1+3*i,M=255&p,P=255&m,N=255&_,D=r[l[M+s[P+s[N]]]],O=r[l[M+a+s[P+o+s[N+c]]]],F=r[l[M+f+s[P+u+s[N+d]]]],w=r[l[M+1+s[P+1+s[N+1]]]],B=.5-v*v-S*S-E*E,U=B<0?0:Math.pow(B,4)*(D[0]*v+D[1]*S+D[2]*E),G=.5-T*T-A*A-x*x,V=G<0?0:Math.pow(G,4)*(O[0]*T+O[1]*A+O[2]*x),k=.5-I*I-R*R-C*C,z=k<0?0:Math.pow(k,4)*(F[0]*I+F[1]*R+F[2]*C),H=.5-b*b-y*y-L*L;return 94.68493150681972*(U+V+z+(H<0?0:Math.pow(H,4)*(w[0]*b+w[1]*y+w[2]*L)))}}},48236:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.makeNoise4D=void 0;var i=(5-Math.sqrt(5))/20,r=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]];t.makeNoise4D=function(e){void 0===e&&(e=Math.random);for(var t,n,a=new Uint8Array(256),o=0;o<256;o++)a[o]=o;for(var o=255;o>0;o--)t=Math.floor((o+1)*e()),n=a[o],a[o]=a[t],a[t]=n;for(var s=new Uint8Array(512),l=new Uint8Array(512),o=0;o<512;o++)s[o]=a[255&o],l[o]=s[o]%12;return function(e,t,n,a){var o=(e+t+n+a)*(Math.sqrt(5)-1)/4,l=Math.floor(e+o),c=Math.floor(t+o),f=Math.floor(n+o),u=Math.floor(a+o),d=(l+c+f+u)*i,h=e-(l-d),p=t-(c-d),m=n-(f-d),_=a-(u-d),g=0,v=0,S=0,E=0;h>p?g++:v++,h>m?g++:S++,h>_?g++:E++,p>m?v++:S++,p>_?v++:E++,m>_?S++:E++;var T=+(g>=3),A=+(v>=3),x=+(S>=3),I=+(E>=3),R=+(g>=2),C=+(v>=2),b=+(S>=2),y=+(E>=2),L=+(g>=1),M=+(v>=1),P=+(S>=1),N=+(E>=1),D=h-T+i,O=p-A+i,F=m-x+i,w=_-I+i,B=h-R+2*i,U=p-C+2*i,G=m-b+2*i,V=_-y+2*i,k=h-L+3*i,z=p-M+3*i,H=m-P+3*i,W=_-N+3*i,X=h-1+4*i,Y=p-1+4*i,$=m-1+4*i,q=_-1+4*i,Z=255&l,j=255&c,K=255&f,Q=255&u,J=r[s[Z+s[j+s[K+s[Q]]]]%32],ee=r[s[Z+T+s[j+A+s[K+x+s[Q+I]]]]%32],et=r[s[Z+R+s[j+C+s[K+b+s[Q+y]]]]%32],ei=r[s[Z+L+s[j+M+s[K+P+s[Q+N]]]]%32],er=r[s[Z+1+s[j+1+s[K+1+s[Q+1]]]]%32],en=.5-h*h-p*p-m*m-_*_,ea=en<0?0:Math.pow(en,4)*(J[0]*h+J[1]*p+J[2]*m+J[3]*_),eo=.5-D*D-O*O-F*F-w*w,es=eo<0?0:Math.pow(eo,4)*(ee[0]*D+ee[1]*O+ee[2]*F+ee[3]*w),el=.5-B*B-U*U-G*G-V*V,ec=el<0?0:Math.pow(el,4)*(et[0]*B+et[1]*U+et[2]*G+et[3]*V),ef=.5-k*k-z*z-H*H-W*W,eu=ef<0?0:Math.pow(ef,4)*(ei[0]*k+ei[1]*z+ei[2]*H+ei[3]*W),ed=.5-X*X-Y*Y-$*$-q*q;return 72.37855765153665*(ea+es+ec+eu+(ed<0?0:Math.pow(ed,4)*(er[0]*X+er[1]*Y+er[2]*$+er[3]*q)))}}},67902:function(e,t,i){t.makeNoise3D=void 0,i(88314);var r=i(66039);Object.defineProperty(t,"makeNoise3D",{enumerable:!0,get:function(){return r.makeNoise3D}}),i(48236)},2733:function(e,t){t.seededSquirrelNoise=void 0,t.seededSquirrelNoise=function(e){return function(t){var i,r,n;return i=e,n=0x68e31da4*(r=t)+i,n^=n>>8,n+=0xb5297a4d,n^=n<<8,n*=0x1b56c4e9,(n^=n>>8)/0x7fffffff}}},95073:function(e,t,i){e.exports=i.p+"2f699b388ca13ffa.wasm"},13152:function(){},96909:function(e,t,i){i.d(t,{rT:()=>c,BT:()=>f,SM:()=>u});var r=i(36819),n=i(76937),a=i(19411),o=i(47627),s=i(42778),l=i(97782);class c{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(-1===e){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,a=!1,o=1,s,l,c,f=!1,u=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=a,this.onAnimationEnd=s,this.onAnimationLoop=c,this.isAdditive=f,this.playOrder=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=[],this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new n.cP,this.onAnimationLoopObservable=new n.cP,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=o,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){let e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){let r=t[i],n=new a.x(e,r,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){let i=this._runtimeAnimations;if(i[0]){let t=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;let r=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/t*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let r=0;r<i.length;r++)i[r].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){let n=this._scene._activeAnimatables.indexOf(this);if(n>-1){let a=this._runtimeAnimations;for(let i=a.length-1;i>=0;i--){let r=a[i];(!e||r.animation.name==e)&&(!t||t(r.target))&&(r.dispose(),a.splice(i,1))}0==a.length&&(i||this._scene._activeAnimatables.splice(n,1),r||this._raiseOnAnimationEnd())}}else{let e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);let t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}async waitAsync(){return await new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){let t;if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this.speedRatio<0?-this._manualJumpDelay:this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,!c.ProcessPausedAnimatables&&0===this._weight&&0===this._previousWeight)return!0;this._previousWeight=this._weight;let i=!1,r=this._runtimeAnimations;for(t=0;t<r.length;t++){let n=r[t].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);i=i||n}if(this.animationStarted=i,!i){if(this.disposeOnEnd)for(t=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(t,1),t=0;t<r.length;t++)r[t].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return i}}function f(e,t,i){let r=t.target;e._registeredForLateAnimationBindings.pushNoDuplicate(r),r._lateAnimationHolders||(r._lateAnimationHolders={}),r._lateAnimationHolders[t.targetPath]||(r._lateAnimationHolders[t.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:i}),t.isAdditive?(r._lateAnimationHolders[t.targetPath].additiveAnimations.push(t),r._lateAnimationHolders[t.targetPath].totalAdditiveWeight+=t.weight):(r._lateAnimationHolders[t.targetPath].animations.push(t),r._lateAnimationHolders[t.targetPath].totalWeight+=t.weight)}function u(e,t){t&&(t.prototype.copyAnimationRange=function(e,t,i,r=!1,n=null){let a,s,l;0===this.animations.length&&(this.animations.push(new o.X5(this.name,"_matrix",e.animations[0].framePerSecond,o.X5.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));let c=e.animations[0].getRange(t);if(!c)return!1;let f=c.from,u=c.to,d=e.animations[0].getKeys(),h=e.length,p=e.getParent(),m=this.getParent(),_=r&&p&&h&&this.length&&h!==this.length,g=_&&m&&p?m.length/p.length:1,v=r&&!m&&n&&(1!==n.x||1!==n.y||1!==n.z),S=this.animations[0].getKeys();for(let e=0,t=d.length;e<t;e++)(a=d[e]).frame>=f&&a.frame<=u&&(r?(l=a.value.clone(),_?(s=l.getTranslation(),l.setTranslation(s.scaleInPlace(g))):v&&n?(s=l.getTranslation(),l.setTranslation(s.multiplyInPlace(n))):l=a.value):l=a.value,S.push({frame:a.frame+i,value:l}));return this.animations[0].createRange(t,f+i,u+i),!0}),e&&(e.prototype._animate=function(e){if(!this.animationsEnabled)return;let t=s.j.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}this.deltaTime=void 0!==e?e:this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=t;let i=this._activeAnimatables;if(0===i.length)return;this._animationTime+=this.deltaTime;let r=this._animationTime;for(let e=0;e<i.length;e++){let t=i[e];!t._animate(r)&&t.disposeOnEnd&&e--}!function(e){if(e._registeredForLateAnimationBindings.length){for(let t=0;t<e._registeredForLateAnimationBindings.length;t++){let i=e._registeredForLateAnimationBindings.data[t];for(let e in i._lateAnimationHolders){let t=i._lateAnimationHolders[e],r=t.animations[0],n=t.originalValue;if(null==n)continue;let a=o.X5.AllowMatrixDecomposeForInterpolation&&n.m,s=i[e];if(a)s=function(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1,i=l.AA.Vector3["0"],r=l.AA.Vector3["1"],n=l.AA.Quaternion["0"],a=0,o=e.animations[0],s=e.originalValue,c=1,f=!1;if(e.totalWeight<1)c=1-e.totalWeight,s.decompose(r,n,i);else{if(a=1,t=e.totalWeight,1==(c=o.weight/t))if(!e.totalAdditiveWeight)return o.currentValue;else f=!0;o.currentValue.decompose(r,n,i)}if(!f){r.scaleInPlace(c),i.scaleInPlace(c),n.scaleInPlace(c);for(let o=a;o<e.animations.length;o++){let a=e.animations[o];if(0===a.weight)continue;c=a.weight/t;let s=l.AA.Vector3["2"],f=l.AA.Vector3["3"],u=l.AA.Quaternion["1"];a.currentValue.decompose(f,u,s),f.scaleAndAddToRef(c,r),u.scaleAndAddToRef(l.PT.Dot(n,u)>0?c:-c,n),s.scaleAndAddToRef(c,i)}n.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){let a=e.additiveAnimations[t];if(0===a.weight)continue;let o=l.AA.Vector3["2"],s=l.AA.Vector3["3"],c=l.AA.Quaternion["1"];a.currentValue.decompose(s,c,o),s.multiplyToRef(r,s),l.Pq.LerpToRef(r,s,a.weight,r),n.multiplyToRef(c,c),l.PT.SlerpToRef(n,c,a.weight,n),o.scaleAndAddToRef(a.weight,i)}let u=o?o._animationState.workValue:l.AA.Matrix["0"].clone();return l.uq.ComposeToRef(r,n,i,u),u}(t);else if(void 0!==n.w)s=function(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;let i=e.animations[0],r=e.originalValue,n=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)n.copyFrom(r);else if(1===e.animations.length){if(l.PT.SlerpToRef(r,i.currentValue,Math.min(1,e.totalWeight),n),0===e.totalAdditiveWeight)return n}else if(e.animations.length>1){let i,a,o=1;if(e.totalWeight<1){let t=1-e.totalWeight;a=[],(i=[]).push(r),a.push(t)}else{if(2===e.animations.length&&(l.PT.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],a=[],o=e.totalWeight}for(let t=0;t<e.animations.length;t++){let r=e.animations[t];i.push(r.currentValue),a.push(r.weight/o)}let s=0;for(let e=0;e<i.length;){if(!e){l.PT.SlerpToRef(i[e],i[e+1],a[e+1]/(a[e]+a[e+1]),t),n=t,s=a[e]+a[e+1],e+=2;continue}s+=a[e],l.PT.SlerpToRef(n,i[e],a[e]/s,n),e++}}for(let t=0;t<e.additiveAnimations.length;t++){let i=e.additiveAnimations[t];0!==i.weight&&(n.multiplyToRef(i.currentValue,l.AA.Quaternion["0"]),l.PT.SlerpToRef(n,l.AA.Quaternion["0"],i.weight,n))}return n}(t,s||l.PT.Identity());else{let e=0,i=1,a=r&&r._animationState.loopMode===o.X5.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(t.totalWeight<1)s=a?n.clone?n.clone():n:r&&n.scale?n.scale(1-t.totalWeight):r?n*(1-t.totalWeight):n.clone?n.clone():n;else if(r){i=t.totalWeight;let o=r.weight/i;s=1!==o?r.currentValue.scale?r.currentValue.scale(o):r.currentValue*o:r.currentValue,a&&(s.addToRef?s.addToRef(n,s):s+=n),e=1}for(let r=e;r<t.animations.length;r++){let e=t.animations[r],n=e.weight/i;n&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(n,s):s+=e.currentValue*n)}for(let e=0;e<t.additiveAnimations.length;e++){let i=t.additiveAnimations[e],r=i.weight;r&&(i.currentValue.scaleAndAddToRef?i.currentValue.scaleAndAddToRef(r,s):s+=i.currentValue*r)}}i[e]=s}i._lateAnimationHolders={}}e._registeredForLateAnimationBindings.reset()}}(this)},e.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((e,t)=>e.playOrder-t.playOrder)},e.prototype.beginWeightedAnimation=function(e,t,i,r=1,n,a=1,o,s,l,c,f=!1){let u=this.beginAnimation(e,t,i,n,a,o,s,!1,l,c,f);return u.weight=r,u},e.prototype.beginAnimation=function(e,t,i,r,n=1,a,o,s=!0,l,f,u=!1){if(n<0){let e=t;t=i,i=e,n=-n}t>i&&(n=-n),s&&this.stopAnimation(e,void 0,l),o||(o=new c(this,e,t,i,r,n,a,void 0,f,u));let d=!l||l(e);if(e.animations&&d&&o.appendAnimations(e,e.animations),e.getAnimatables){let c=e.getAnimatables();for(let e=0;e<c.length;e++)this.beginAnimation(c[e],t,i,r,n,a,o,s,l,f)}return o.reset(),o},e.prototype.beginHierarchyAnimation=function(e,t,i,r,n,a=1,o,s,l=!0,c,f,u=!1){let d=e.getDescendants(t),h=[];for(let t of(h.push(this.beginAnimation(e,i,r,n,a,o,s,l,c,void 0,u)),d))h.push(this.beginAnimation(t,i,r,n,a,o,s,l,c,void 0,u));return h},e.prototype.beginDirectAnimation=function(e,t,i,r,n,a=1,o,s,l=!1){if(a<0){let e=i;i=r,r=e,a=-a}return i>r&&(a=-a),new c(this,e,i,r,n,a,o,t,s,l)},e.prototype.beginDirectHierarchyAnimation=function(e,t,i,r,n,a,o,s,l,c=!1){let f=e.getDescendants(t),u=[];for(let t of(u.push(this.beginDirectAnimation(e,i,r,n,a,o,s,l,c)),f))u.push(this.beginDirectAnimation(t,i,r,n,a,o,s,l,c));return u},e.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},e.prototype.getAllAnimatablesByTarget=function(e){let t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},e.prototype.stopAnimation=function(e,t,i){for(let r of this.getAllAnimatablesByTarget(e))r.stop(t,i)},e.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(let e of this.animationGroups)e.stop()})}c.ProcessPausedAnimatables=!1,u(i(38241).Z,r.$)},41312:function(){},92489:function(){},26484:function(e,t,i){i.d(t,{L:()=>o});var r=i(76937),n=i(39393),a=i(79839);n.$.AudioEngineFactory=(e,t,i)=>new o(e,t,i);class o{get masterGain(){return this._masterGain}set masterGain(e){this._masterGain=this._v2.mainOut._inNode=e}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(e){this._useCustomUnlockedButton=e,this._v2._unmuteUIEnabled=!e}get audioContext(){return"running"===this._v2.state&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(e=null,t=null,i=null){this._audioContext=null,this._tryToRun=!1,this._useCustomUnlockedButton=!1,this.canUseWebAudio=!0,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.onAudioUnlockedObservable=new r.cP,this.onAudioLockedObservable=new r.cP;const n=new a.Q({audioContext:t||void 0,defaultUIParentElement:e?.parentElement?e.parentElement:void 0});n._unmuteUIEnabled=!1,this._masterGain=new GainNode(n._audioContext),n._audioDestination=i,n.stateChangedObservable.add(e=>{"running"===e?(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this))}),n._initAsync({resumeOnInteraction:!1}).then(()=>{let e=n.defaultMainBus._outNode;e&&(e.disconnect(n.mainOut._inNode),e.connect(this._masterGain)),n.mainOut._inNode=this._masterGain,n.stateChangedObservable.notifyObservers(n.state)}),this.isMP3supported=n.isFormatValid("mp3"),this.isOGGsupported=n.isFormatValid("ogg"),this._v2=n}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=!0)}unlock(){if(this._audioContext?.state==="running"){this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._triggerRunningStateAsync()}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",()=>{this.unlocked&&this._audioContext?.state!=="running"&&this._resumeAudioContextAsync()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():this._v2._audioContext.resume()}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(e){this.masterGain.gain.value=e}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination)}async _triggerRunningStateAsync(){this._tryToRun||(this._tryToRun=!0,await this._resumeAudioContextAsync(),this._tryToRun=!1,this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this))}}},99949:function(e,t,i){i.d(t,{Y:()=>u});var r=i(83771),n=i(24560),a=i(97782),o=i(89270),s=i(38241);i(26484);var l=i(42778),c=i(37702),f=i(39393);(0,i(6243).ji)(o.v.NAME_AUDIO,(e,t,i,n)=>{let a,o=[];if(i.sounds=i.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let s=0,l=e.sounds.length;s<l;s++){let l=e.sounds[s];f.$.audioEngine?.canUseWebAudio?(l.url||(l.url=l.name),o[l.url]?i.sounds.push(r.A.Parse(l,t,n,o[l.url])):(a=r.A.Parse(l,t,n),o[l.url]=a,i.sounds.push(a))):i.sounds.push(new r.A(l.name,null,t))}o=[]}),Object.defineProperty(s.Z.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(o.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new n.j(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),s.Z.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks){for(let i=0;i<this.soundTracks.length;i++)for(t=0;t<this.soundTracks[i].soundCollection.length;t++)if(this.soundTracks[i].soundCollection[t].name===e)return this.soundTracks[i].soundCollection[t]}return null},Object.defineProperty(s.Z.prototype,"audioEnabled",{get:function(){let e=this._getComponent(o.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(o.v.NAME_AUDIO);t||(t=new u(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(s.Z.prototype,"headphone",{get:function(){let e=this._getComponent(o.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(o.v.NAME_AUDIO);t||(t=new u(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(s.Z.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(o.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(o.v.NAME_AUDIO);if(t||(t=new u(this),this._addComponent(t)),e&&"function"!=typeof e)throw Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.Z.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(o.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(o.v.NAME_AUDIO);if(t||(t=new u(this),this._addComponent(t)),e&&"function"!=typeof e)throw Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(s.Z.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(o.v.NAME_AUDIO);return e||(e=new u(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(o.v.NAME_AUDIO);t||(t=new u(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class u{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){if(this.name=o.v.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new a.Pq,this._cachedCameraPosition=new a.Pq,this._lastCheck=0,this._invertMatrixTemp=new a.uq,this._cameraDirectionTemp=new a.Pq,!(e=e||c.q.LastCreatedScene))return;this.scene=e,e.soundTracks=[],e.sounds=[]}register(){this.scene._afterRenderStage.registerStep(o.v.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){let i=this.scene.soundTracks[t];for(let t=0;t<i.soundCollection.length;t++)e.sounds.push(i.soundCollection[t].serialize())}}addFromContainer(e){if(e.sounds)for(let t of e.sounds)t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}removeFromContainer(e,t=!1){if(e.sounds)for(let i of e.sounds)i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()}dispose(){let e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){let e,t=this.scene;for(this._audioEnabled=!1,f.$.audioEngine&&f.$.audioEngine.audioContext&&f.$.audioEngine.audioContext.suspend(),e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].pause()}enableAudio(){let e,t=this.scene;for(this._audioEnabled=!0,f.$.audioEngine&&f.$.audioEngine.audioContext&&f.$.audioEngine.audioContext.resume(),e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].isPaused&&t.soundTracks[e].soundCollection[i].play()}switchAudioModeForHeadphones(){let e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){let e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){let e=l.j.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;let t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;let i=f.$.audioEngine;if(i&&i.audioContext){let e,r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){let e=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){let e=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),a.Pq.TransformNormalToRef(u._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){let i=t.mainSoundTrack.soundCollection[e];i.useCustomAttenuation&&i.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++){let r=t.soundTracks[e].soundCollection[i];r.useCustomAttenuation&&r.updateDistanceFromListener()}}}}u._CameraDirection=new a.Pq(0,0,-1),r.A._SceneComponentInitialization=e=>{let t=e._getComponent(o.v.NAME_AUDIO);t||(t=new u(e),e._addComponent(t))}},89293:function(e,t,i){i.d(t,{g:()=>a});var r=i(76937),n=i(12963);class a extends n.f0{constructor(e){super(e.engine,2),this._state=1,this.onEndedObservable=new r.cP,this.onErrorObservable=new r.cP,this.onStateChangedObservable=new r.cP,this._sound=e}get state(){return this._state}dispose(){super.dispose(),this.stop(),this.onEndedObservable.clear(),this.onStateChangedObservable.clear()}_setState(e){this._state!==e&&(this._state=e,this.onStateChangedObservable.notifyObservers(this),1===this._state&&this.onEndedObservable.notifyObservers(this))}}},82631:function(e,t,i){i.d(t,{L:()=>n});var r=i(86319);class n extends r.t{constructor(e,t,i=2){super(e,t,i),this._outBus=null,this._onOutBusDisposed=()=>{this._outBus=null}}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null}}},57027:function(e,t,i){i.d(t,{l:()=>n});var r=i(97782);class n{constructor(e){this._attachmentType=3,this._position=new r.Pq,this._rotationQuaternion=new r.PT,this._sceneNode=null,this._useBoundingBox=!1,this.dispose=()=>{this.detach()},this._spatialAudioNode=e}get isAttached(){return null!==this._sceneNode}attach(e,t,i){this._sceneNode===e||(this.detach(),e&&(this._attachmentType=i,this._sceneNode=e,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=t))}detach(){this._sceneNode?.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null}update(){1&this._attachmentType&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):this._sceneNode?.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),2&this._attachmentType&&(this._sceneNode?.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation())}}},58493:function(e,t,i){i.d(t,{I:()=>n});var r=i(89293);class n extends r.g{}},36899:function(e,t,i){i.d(t,{K:()=>a});var r=i(76937),n=i(89293);class a extends n.g{constructor(e){super(e),this.onReadyObservable=new r.cP,this.preloadedPromise=new Promise((e,t)=>{this._rejectPreloadedProimse=t,this._resolvePreloadedPromise=e}),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise)}set startOffset(e){this._options.startOffset=e}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise()}}},85545:function(e,t,i){i.d(t,{e:()=>n});var r=i(12963);class n extends r.Ui{constructor(e,t){super(e,t,3)}connect(e){if(!this._connect(e))throw Error("Connect failed")}disconnect(e){if(!this._disconnect(e))throw Error("Disconnect failed")}disconnectAll(){if(!this._downstreamNodes)throw Error("Disconnect failed");let e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next())if(!this._disconnect(t.value))throw Error("Disconnect failed")}}},83225:function(e,t,i){i.d(t,{CA:()=>o,Z7:()=>s,i_:()=>a});var r=i(81725),n=i(85545);class a extends n.e{constructor(e){super("Analyzer",e)}setOptions(e){this.fftSize=e.analyzerFFTSize??r.IR.fftSize,this.minDecibels=e.analyzerMinDecibels??r.IR.minDecibels,this.maxDecibels=e.analyzerMaxDecibels??r.IR.maxDecibels,this.smoothing=e.analyzerSmoothing??r.IR.smoothing}}function o(e){return e.getSubNode("Analyzer")}function s(e,t,i){e.callOnSubNode("Analyzer",e=>{e[t]=i})}},5088:function(e,t,i){i.d(t,{Au:()=>o,Pt:()=>l,y5:()=>s});var r=i(57027),n=i(81719),a=i(85545);class o extends a.e{constructor(e){super("Spatial",e),this._attacherComponent=null}get isAttached(){return null!==this._attacherComponent&&this._attacherComponent.isAttached}attach(e,t,i){this.detach(),this._attacherComponent||(this._attacherComponent=new r.l(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){super.dispose(),this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){this.coneInnerAngle=e.spatialConeInnerAngle??n.Qc.coneInnerAngle,this.coneOuterAngle=e.spatialConeOuterAngle??n.Qc.coneOuterAngle,this.coneOuterVolume=e.spatialConeOuterVolume??n.Qc.coneOuterVolume,this.distanceModel=e.spatialDistanceModel??n.Qc.distanceModel,this.maxDistance=e.spatialMaxDistance??n.Qc.maxDistance,this.minDistance=e.spatialMinDistance??n.Qc.minDistance,this.panningModel=e.spatialPanningModel??n.Qc.panningModel,this.rolloffFactor=e.spatialRolloffFactor??n.Qc.rolloffFactor,e.spatialPosition&&(this.position=e.spatialPosition.clone()),e.spatialRotationQuaternion?this.rotationQuaternion=e.spatialRotationQuaternion.clone():e.spatialRotation?this.rotation=e.spatialRotation.clone():this.rotationQuaternion=n.Qc.rotationQuaternion.clone(),this.update()}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}}function s(e){return e.getSubNode("Spatial")}function l(e,t,i){e.callOnSubNode("Spatial",e=>{e[t]=i})}},71119:function(e,t,i){i.d(t,{KJ:()=>o,a7:()=>a,n9:()=>s});var r=i(85545),n=i(15839);class a extends r.e{constructor(e){super("Stereo",e)}setOptions(e){this.pan=e.stereoPan??n.uJ.pan}}function o(e){return e.getSubNode("Stereo")}function s(e,t,i){e.callOnSubNode("Stereo",e=>{e[t]=i})}},68621:function(e,t,i){i.d(t,{Sy:()=>a,pN:()=>s,sf:()=>o});var r=i(85545);let n={volume:1};class a extends r.e{constructor(e){super("Volume",e)}setOptions(e){this.setVolume(e.volume??n.volume,{shape:"none"})}}function o(e){return e.getSubNode("Volume")}function s(e,t){return o(e)?.[t]??n[t]}},54799:function(e,t,i){i.d(t,{Hi:()=>c,hU:()=>l,sQ:()=>f});var r=i(57480),n=i(81725),a=i(83225);let o=null,s=null;function l(){return o||(o=new Uint8Array),o}function c(){return s||(s=new Float32Array),s}class f extends n.zx{constructor(e){super(),this._fftSize=n.IR.fftSize,this._maxDecibels=n.IR.maxDecibels,this._minDecibels=n.IR.minDecibels,this._smoothing=n.IR.smoothing,this._subGraph=e}get fftSize(){return this._fftSize}set fftSize(e){this._fftSize=e,(0,a.Z7)(this._subGraph,"fftSize",e)}get isEnabled(){return null!==(0,a.CA)(this._subGraph)}get minDecibels(){return this._minDecibels}set minDecibels(e){this._minDecibels=e,(0,a.Z7)(this._subGraph,"minDecibels",e)}get maxDecibels(){return this._maxDecibels}set maxDecibels(e){this._maxDecibels=e,(0,a.Z7)(this._subGraph,"maxDecibels",e)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,(0,a.Z7)(this._subGraph,"smoothing",e)}dispose(){let e=(0,a.CA)(this._subGraph);e&&(this._subGraph.removeSubNodeAsync(e),e.dispose())}async enableAsync(){(0,a.CA)(this._subGraph)||await this._subGraph.createAndAddSubNodeAsync("Analyzer")}getByteFrequencyData(){let e=(0,a.CA)(this._subGraph);return e?e.getByteFrequencyData():(r.V.Warn("AudioAnalyzer not enabled"),this.enableAsync(),l())}getFloatFrequencyData(){let e=(0,a.CA)(this._subGraph);return e?e.getFloatFrequencyData():(r.V.Warn("AudioAnalyzer not enabled"),this.enableAsync(),c())}}},53489:function(e,t,i){i.d(t,{i:()=>a});var r=i(15839),n=i(71119);class a extends r.bO{constructor(e){super(),this._pan=r.uJ.pan,this._subGraph=e}get pan(){return this._pan}set pan(e){this._pan=e,(0,n.n9)(this._subGraph,"pan",e)}}},5925:function(e,t,i){i.d(t,{Ki:()=>c,mJ:()=>l,qK:()=>r});let r=RegExp("\\.(\\w{3,4})($|\\?)"),n=new Float32Array([0,0]),a=null,o=null,s=null;function l(e,t,i){let r;if(a||(a=new Float32Array(100)),"linear"===e)return n[0]=t,n[1]=i,n;if("exponential"===e)r=function(){if(!o){o=new Float32Array(100);let e=1/99,t=1/99;for(let i=1;i<100;i++)o[i]=Math.exp(-11.512925464970227*(1-t)),t+=e}return o}();else if("logarithmic"===e)r=function(){if(!s){s=new Float32Array(100);let e=.01;for(let t=0;t<100;t++)s[t]=1+Math.log10(e)/Math.log10(100),e+=.01}return s}();else throw Error(`Unknown ramp shape: ${e}`);let l=Math.sign(i-t),c=Math.abs(i-t);if(1===l)for(let e=0;e<r.length;e++)a[e]=t+c*r[e];else{let e=99;for(let i=0;i<r.length;i++,e--)a[i]=t-c*(1-r[e])}return a}function c(e){return e.replace(/#/gm,"%23")}},68490:function(e,t,i){i.d(t,{w:()=>n});var r=i(42778);class n{constructor(e,t,i){if(this._autoUpdate=!0,this._lastUpdateTime=0,this.minUpdateTime=0,!t)return;this.minUpdateTime=i;const n=()=>{if(!this._autoUpdate)return;let t=!1;if(0<this.minUpdateTime){let e=r.j.Now;this._lastUpdateTime&&e-this._lastUpdateTime<this.minUpdateTime&&(t=!0),this._lastUpdateTime=e}t||e.update(),requestAnimationFrame(n)};requestAnimationFrame(n)}dispose(){this._autoUpdate=!1}}},45130:function(e,t,i){i.d(t,{k:()=>n});var r=i(5925);class n{constructor(e,t){this._rampEndTime=0,this._engine=e,this._param=t,this._targetValue=t.value}get isRamping(){return this._engine.currentTime<this._rampEndTime}get targetValue(){return this._targetValue}set targetValue(e){this.setTargetValue(e)}get value(){return this._param.value}dispose(){this._param=null,this._engine=null}setTargetValue(e,t=null){let i="string"==typeof t?.shape?t.shape:"linear",n=this._engine.currentTime;if("none"===i){this._param.cancelScheduledValues(n),this._param.value=this._targetValue=e,this._rampEndTime=n;return}let a="number"==typeof t?.duration?Math.max(t.duration,this._engine.parameterRampDuration):this._engine.parameterRampDuration;(a=Math.max(this._engine.parameterRampDuration,a))<1e-6?this._param.setValueAtTime(this._targetValue=e,n):(this._param.cancelScheduledValues(n),this._param.setValueCurveAtTime((0,r.mJ)(i,this._param.value,this._targetValue=e),n,a),this._rampEndTime=n+a)}}},22036:function(e,t,i){i.d(t,{H:()=>h});class r{constructor(){this._createSubNodePromises={},this._isDisposed=!1,this._subNodes={},this._onSubNodeDisposed=e=>{delete this._subNodes[e.name],this._onSubNodesChanged()}}callOnSubNode(e,t){let i=this.getSubNode(e);i?t(i):this._createSubNodePromisesResolvedAsync().then(()=>{let i=this.getSubNode(e);i?t(i):this.createAndAddSubNodeAsync(e).then(e=>{t(e)})})}createAndAddSubNodeAsync(e){var t;return(t=this._createSubNodePromises)[e]||(t[e]=this._createSubNode(e).then(e=>(this._addSubNode(e),e))),this._createSubNodePromises[e]}dispose(){for(let e of(this._isDisposed=!0,Object.values(this._subNodes)))e.dispose();this._subNodes={},this._createSubNodePromises={}}getSubNode(e){return this._subNodes[e]??null}async removeSubNodeAsync(e){await this._createSubNodePromisesResolvedAsync();let t=e.name;this._subNodes[t]&&delete this._subNodes[t],delete this._createSubNodePromises[t],this._onSubNodesChanged()}async _createSubNodePromisesResolvedAsync(){return await Promise.all(Object.values(this._createSubNodePromises))}_addSubNode(e){this._isDisposed?e.dispose():(this._subNodes[e.name]=e,e.onDisposeObservable.addOnce(this._onSubNodeDisposed),this._onSubNodesChanged())}}var n=i(83225),a=i(68621),o=i(81725),s=i(45130);async function l(e){return new c(e)}class c extends a.Sy{constructor(e){super(e);const t=this.node=new GainNode(e._audioContext);this._volume=new s.k(e,t.gain)}dispose(){super.dispose(),this._volume.dispose()}get volume(){return this._volume.value}set volume(e){this.setVolume(e)}get _inNode(){return this.node}get _outNode(){return this.node}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_connect(e){return!!super._connect(e)&&(e._inNode&&this.node.connect(e._inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e._inNode&&this.node.disconnect(e._inNode),!0)}getClassName(){return"_VolumeWebAudioSubNode"}}var f=i(54799);async function u(e){return new d(e)}class d extends n.i_{constructor(e){super(e),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode=new AnalyserNode(e._audioContext)}get fftSize(){return this._analyzerNode.fftSize}set fftSize(e){e!==this._analyzerNode.fftSize&&(this._analyzerNode.fftSize=e,this._clearArrays())}get _inNode(){return this._analyzerNode}get minDecibels(){return this._analyzerNode.minDecibels}set minDecibels(e){this._analyzerNode.minDecibels=e}get maxDecibels(){return this._analyzerNode.maxDecibels}set maxDecibels(e){this._analyzerNode.maxDecibels=e}get smoothing(){return this._analyzerNode.smoothingTimeConstant}set smoothing(e){this._analyzerNode.smoothingTimeConstant=e}dispose(){super.dispose(),this._clearArrays(),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode.disconnect()}getClassName(){return"_WebAudioAnalyzerSubNode"}getByteFrequencyData(){return this._byteFrequencyData&&0!==this._byteFrequencyData.length||(this._byteFrequencyData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._byteFrequencyData),this._byteFrequencyData}getFloatFrequencyData(){return this._floatFrequencyData&&0!==this._floatFrequencyData.length||(this._floatFrequencyData=new Float32Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getFloatFrequencyData(this._floatFrequencyData),this._floatFrequencyData}_clearArrays(){this._byteFrequencyData?.set((0,f.hU)()),this._floatFrequencyData?.set((0,f.Hi)())}}class h extends r{constructor(e){super(),this._outputNode=null,this._owner=e}async initAsync(e){let t=(0,o.GA)(e);if(t&&await this.createAndAddSubNodeAsync("Analyzer"),await this.createAndAddSubNodeAsync("Volume"),await this._createSubNodePromisesResolvedAsync(),t){let t=(0,n.CA)(this);if(!t)throw Error("No analyzer subnode.");t.setOptions(e)}let i=(0,a.sf)(this);if(!i)throw Error("No volume subnode.");if(i.setOptions(e),"_VolumeWebAudioSubNode"!==i.getClassName())throw Error("Not a WebAudio subnode.");if(this._outputNode=i.node,this._outputNode&&this._downstreamNodes){let e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next()){let e=t.value._inNode;e&&this._outputNode.connect(e)}}}get _inNode(){return this._outputNode}get _outNode(){return this._outputNode}_createSubNode(e){switch(e){case"Analyzer":return u(this._owner.engine);case"Volume":return l(this._owner.engine);default:throw Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){let e=(0,n.CA)(this),t=(0,a.sf)(this);e&&t&&t.connect(e)}}},35521:function(e,t,i){i.d(t,{Q:()=>E});var r=i(5088),n=i(71119),a=i(68621),o=i(81719),s=i(15839),l=i(97782),c=i(45130);let f=l.uq.Zero(),u=new l.PT,d=l.Pq.Zero();function h(e){return e*Math.PI/180}function p(e){return 180*e/Math.PI}async function m(e){return new _(e)}class _ extends r.Au{constructor(e){super(e),this._lastPosition=l.Pq.Zero(),this._lastRotation=l.Pq.Zero(),this._lastRotationQuaternion=new l.PT,this.position=o.Qc.position.clone(),this.rotation=o.Qc.rotation.clone(),this.rotationQuaternion=o.Qc.rotationQuaternion.clone(),this.node=new PannerNode(e._audioContext),this._orientationX=new c.k(e,this.node.orientationX),this._orientationY=new c.k(e,this.node.orientationY),this._orientationZ=new c.k(e,this.node.orientationZ),this._positionX=new c.k(e,this.node.positionX),this._positionY=new c.k(e,this.node.positionY),this._positionZ=new c.k(e,this.node.positionZ)}dispose(){super.dispose(),this._orientationX.dispose(),this._orientationY.dispose(),this._orientationZ.dispose(),this._positionX.dispose(),this._positionY.dispose(),this._positionZ.dispose(),this.node.disconnect()}get coneInnerAngle(){return h(this.node.coneInnerAngle)}set coneInnerAngle(e){this.node.coneInnerAngle=p(e)}get coneOuterAngle(){return h(this.node.coneOuterAngle)}set coneOuterAngle(e){this.node.coneOuterAngle=p(e)}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(e){this.node.coneOuterGain=e}get distanceModel(){return this.node.distanceModel}set distanceModel(e){this.node.distanceModel=e;let t=this.node.maxDistance;this.node.maxDistance=t+.001,this.node.maxDistance=t}get minDistance(){return this.node.refDistance}set minDistance(e){this.node.refDistance=e}get maxDistance(){return this.node.maxDistance}set maxDistance(e){this.node.maxDistance=e}get panningModel(){return this.node.panningModel}set panningModel(e){this.node.panningModel=e}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(e){this.node.rolloffFactor=e}get _inNode(){return this.node}get _outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=this.position.x,this._positionY.targetValue=this.position.y,this._positionZ.targetValue=this.position.z,this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this.isAttached||!this._orientationX.isRamping&&!this._orientationY.isRamping&&!this._orientationZ.isRamping){if(this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))if(this._lastRotation.equalsWithEpsilon(this.rotation))return;else l.PT.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,u),this._lastRotation.copyFrom(this.rotation);else u.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);l.uq.FromQuaternionToRef(u,f),l.Pq.TransformNormalToRef(l.Pq.RightReadOnly,f,d),this._orientationX.targetValue=d.x,this._orientationY.targetValue=d.y,this._orientationZ.targetValue=d.z}}_connect(e){return!!super._connect(e)&&(e._inNode&&this.node.connect(e._inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e._inNode&&this.node.disconnect(e._inNode),!0)}getClassName(){return"_SpatialWebAudioSubNode"}}async function g(e){return new v(e)}class v extends n.a7{constructor(e){super(e),this.node=new StereoPannerNode(e._audioContext),this._pan=new c.k(e,this.node.pan)}dispose(){super.dispose(),this._pan.dispose()}get pan(){return this._pan.targetValue}set pan(e){this._pan.targetValue=e}get _inNode(){return this.node}get _outNode(){return this.node}getClassName(){return"_StereoWebAudioSubNode"}_connect(e){return!!super._connect(e)&&(e._inNode&&this.node.connect(e._inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e._inNode&&this.node.disconnect(e._inNode),!0)}}var S=i(22036);class E extends S.H{constructor(){super(...arguments),this._rootNode=null,this._inputNode=null}async initAsync(e){await super.initAsync(e);let t=!1,i=!1;(t=(0,o.GB)(e))&&await this.createAndAddSubNodeAsync("Spatial"),(i=(0,s.uD)(e))&&await this.createAndAddSubNodeAsync("Stereo"),await this._createSubNodePromisesResolvedAsync(),t&&(0,r.y5)(this)?.setOptions(e),i&&(0,n.KJ)(this)?.setOptions(e)}get _inNode(){return this._inputNode}_createSubNode(e){try{return super._createSubNode(e)}catch(e){}switch(e){case"Spatial":return m(this._owner.engine);case"Stereo":return g(this._owner.engine);default:throw Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){super._onSubNodesChanged();let e=(0,r.y5)(this),t=(0,n.KJ)(this),i=(0,a.sf)(this);if(e&&"_SpatialWebAudioSubNode"!==e.getClassName()||t&&"_StereoWebAudioSubNode"!==t.getClassName()||i&&"_VolumeWebAudioSubNode"!==i.getClassName())throw Error("Not a WebAudio subnode.");e&&(e.disconnectAll(),i&&e.connect(i)),t&&(t.disconnectAll(),i&&t.connect(i)),e&&t?(this._rootNode=new GainNode(this._owner.engine._audioContext),this._rootNode.connect(e._outNode),this._rootNode.connect(t._outNode)):(this._rootNode?.disconnect(),this._rootNode=null);let o=null,s=null;if(this._rootNode?s=this._rootNode:(e?o=e:t?o=t:i&&(o=i),s=o?.node??null),this._inputNode!==s){if(this._inputNode&&this._upstreamNodes){let e=this._upstreamNodes.values();for(let t=e.next();!t.done;t=e.next())t.value._outNode?.disconnect(this._inputNode)}if(this._inputNode=s,s&&this._upstreamNodes){let e=this._upstreamNodes.values();for(let t=e.next();!t.done;t=e.next())t.value._outNode?.connect(s)}}}}},75811:function(e,t,i){i.d(t,{i:()=>s});var r=i(5088),n=i(81719);class a extends n.lA{constructor(e){super(),this._coneInnerAngle=n.Qc.coneInnerAngle,this._coneOuterAngle=n.Qc.coneOuterAngle,this._coneOuterVolume=n.Qc.coneOuterVolume,this._distanceModel=n.Qc.distanceModel,this._maxDistance=n.Qc.maxDistance,this._minDistance=n.Qc.minDistance,this._panningModel=n.Qc.panningModel,this._rolloffFactor=n.Qc.rolloffFactor;const t=(0,r.y5)(e);t?(this._position=t.position.clone(),this._rotation=t.rotation.clone(),this._rotationQuaternion=t.rotationQuaternion.clone()):(this._position=n.Qc.position.clone(),this._rotation=n.Qc.rotation.clone(),this._rotationQuaternion=n.Qc.rotationQuaternion.clone(),e.createAndAddSubNodeAsync("Spatial")),this._subGraph=e}get coneInnerAngle(){return this._coneInnerAngle}set coneInnerAngle(e){this._coneInnerAngle=e,(0,r.Pt)(this._subGraph,"coneInnerAngle",e)}get coneOuterAngle(){return this._coneOuterAngle}set coneOuterAngle(e){this._coneOuterAngle=e,(0,r.Pt)(this._subGraph,"coneOuterAngle",e)}get coneOuterVolume(){return this._coneOuterVolume}set coneOuterVolume(e){this._coneOuterVolume=e,(0,r.Pt)(this._subGraph,"coneOuterVolume",e)}get distanceModel(){return this._distanceModel}set distanceModel(e){this._distanceModel=e,(0,r.Pt)(this._subGraph,"distanceModel",e)}get isAttached(){return this._subGraph.getSubNode("Spatial")?.isAttached??!1}get maxDistance(){return this._maxDistance}set maxDistance(e){e<=0&&(e=1e-6),this._maxDistance=e,(0,r.Pt)(this._subGraph,"maxDistance",e)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance=e,(0,r.Pt)(this._subGraph,"minDistance",e)}get panningModel(){return this._panningModel}set panningModel(e){this._panningModel=e,(0,r.Pt)(this._subGraph,"panningModel",e)}get position(){return this._position}set position(e){this._position=e,this._updatePosition()}get rolloffFactor(){return this._rolloffFactor}set rolloffFactor(e){this._rolloffFactor=e,(0,r.Pt)(this._subGraph,"rolloffFactor",e)}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._updateRotation()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,this._updateRotation()}attach(e,t=!1,i=3){(0,r.y5)(this._subGraph)?.attach(e,t,i)}detach(){(0,r.y5)(this._subGraph)?.detach()}update(){let e=(0,r.y5)(this._subGraph);e&&(e.isAttached?e.update():(this._updatePosition(e),this._updateRotation(e)))}_updatePosition(e=null){(e||(e=(0,r.y5)(this._subGraph)))&&(e.position.equalsWithEpsilon(this._position)||(e.position.copyFrom(this._position),e._updatePosition()))}_updateRotation(e=null){(e||(e=(0,r.y5)(this._subGraph)))&&(e.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?e.rotation.equalsWithEpsilon(this._rotation)||(e.rotation.copyFrom(this._rotation),e._updateRotation()):(e.rotationQuaternion.copyFrom(this._rotationQuaternion),e._updateRotation()))}}var o=i(68490);class s extends a{constructor(e,t,i){super(e),this._updaterComponent=new o.w(this,t,i)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null}}},21900:function(e,t,i){i.d(t,{o:()=>h});var r=i(97782),n=i(57027),a=i(74983);class o extends a.rF{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new n.l(this)}get isAttached(){return null!==this._attacherComponent&&this._attacherComponent.isAttached}attach(e,t=!1,i=3){this._attacherComponent||(this._attacherComponent=new n.l(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){void 0!==e.listenerMinUpdateTime&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=a.oO.rotationQuaternion.clone(),this.update()}}var s=i(68490),l=i(45130);let c=r.uq.Zero(),f=new r.PT,u=r.Pq.Zero(),d=r.Pq.Zero();function h(e,t,i){let r=e._audioContext.listener;return r.forwardX&&r.forwardY&&r.forwardZ&&r.positionX&&r.positionY&&r.positionZ&&r.upX&&r.upY&&r.upZ?new m(e,t,i):new _(e,t,i)}class p extends o{constructor(e,t,i){super(),this._lastPosition=r.Pq.Zero(),this._lastRotation=r.Pq.Zero(),this._lastRotationQuaternion=new r.PT,this.position=r.Pq.Zero(),this.rotation=r.Pq.Zero(),this.rotationQuaternion=new r.PT,this._listener=e._audioContext.listener,this.engine=e,this._updaterComponent=new s.w(this,t,i)}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))if(this._lastRotation.equalsWithEpsilon(this.rotation))return;else r.PT.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,f),this._lastRotation.copyFrom(this.rotation);else f.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);r.uq.FromQuaternionToRef(f,c),r.Pq.TransformNormalToRef(r.Pq.RightHandedForwardReadOnly,c,u),r.Pq.TransformNormalToRef(r.Pq.Up(),c,d),this._setWebAudioOrientation(u,d)}}class m extends p{constructor(e,t,i){super(e,t,i);const r=e._audioContext.listener;this._forwardX=new l.k(e,r.forwardX),this._forwardY=new l.k(e,r.forwardY),this._forwardZ=new l.k(e,r.forwardZ),this._positionX=new l.k(e,r.positionX),this._positionY=new l.k(e,r.positionY),this._positionZ=new l.k(e,r.positionZ),this._upX=new l.k(e,r.upX),this._upY=new l.k(e,r.upY),this._upZ=new l.k(e,r.upZ)}_setWebAudioPosition(e){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=e.x,this._positionY.targetValue=e.y,this._positionZ.targetValue=e.z)}_setWebAudioOrientation(e,t){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=e.x,this._forwardY.targetValue=e.y,this._forwardZ.targetValue=e.z,this._upX.targetValue=t.x,this._upY.targetValue=t.y,this._upZ.targetValue=t.z)}}class _ extends p{_setWebAudioPosition(e){this._listener.setPosition(e.x,e.y,e.z)}_setWebAudioOrientation(e,t){this._listener.setOrientation(e.x,e.y,e.z,t.x,t.y,t.z)}}},87475:function(e,t,i){i.d(t,{$:()=>o});var r=i(12963);class n extends r.f0{constructor(e){super(e,1)}}var a=i(45130);class o extends n{constructor(e){super(e),this._setGainNode(new GainNode(e._audioContext))}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}get _inNode(){return this._gainNode}set _inNode(e){this._gainNode!==e&&this._setGainNode(e)}get volume(){return this._volume.targetValue}set volume(e){this._volume.targetValue=e}get _destinationNode(){return this.engine._audioDestination}getClassName(){return"_WebAudioMainOut"}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_setGainNode(e){this._gainNode!==e&&(this._gainNode?.disconnect(),e.connect(this._destinationNode),this._volume=new a.k(this.engine,e.gain),this._gainNode=e)}}},19165:function(e,t,i){i.d(t,{U:()=>n});var r=i(37702);class n{constructor(e,t){this._button=null,this._enabled=!0,this._style=null,this._onStateChanged=()=>{this._button&&("running"===this._engine.state?this._hide():this._show())},this._engine=e;const i=t||r.q.LastCreatedEngine?.getInputElement()?.parentElement||document.body,n=(i?.offsetTop||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${n}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",()=>{this._engine.unlockAsync()}),i.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged)}dispose(){this._button?.remove(),this._button=null,this._style?.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?"running"!==this._engine.state&&this._show():this._hide()}_show(){this._button&&this._enabled&&(this._button.style.display="block")}_hide(){this._button&&(this._button.style.display="none")}}},89648:function(e,t,i){i.d(t,{$:()=>a});var r=i(70388),n=i(47627);class a{get name(){return"Interpolating"}get attachedNode(){return this._attachedCamera}constructor(){this.easingFunction=new r.vm,this.easingMode=r.KA.EASINGMODE_EASEINOUT,this.transitionDuration=450,this._attachedCamera=null,this._animatables=new Map,this.easingFunction.setEasingMode(this.easingMode)}init(){}attach(e){this._attachedCamera=e}detach(){this._attachedCamera&&(this.stopAllAnimations(),this._attachedCamera=null)}get isInterpolating(){return this._animatables.size>0}stopAllAnimations(){this._attachedCamera&&this._animatables.forEach(e=>e.stop()),this._animatables.clear(),this._promiseResolve?.(),this._promiseResolve=void 0}updateProperties(e){e.forEach((e,t)=>{if(void 0!==e){let i=this._animatables.get(String(t));i&&(i.target=e)}})}async animatePropertiesAsync(e,t=this.transitionDuration,i=this.easingFunction,r){let a=new Promise(a=>{if(this.stopAllAnimations(),this._promiseResolve=a,!this._attachedCamera)return this._promiseResolve=void 0,a();let s=this._attachedCamera,l=s.getScene(),c=e=>{for(let t=s.animations.length-1;t>=0;--t)s.animations[t].name===e+"Animation"&&s.animations.splice(t,1);this._animatables.delete(e),0===this._animatables.size&&(this._promiseResolve=void 0,a())};e.forEach((e,a)=>{if(void 0!==e&&s[a]!==e){let f=String(a),u=n.X5.CreateAnimation(f,o(e),60,i);r?.(f,u);let d=n.X5.TransitionTo(f,e,s,l,60,u,t,()=>c(f),!1);d&&this._animatables.set(f,d)}})});return await a}}let o=e=>null!=e&&"number"==typeof e.x&&"number"==typeof e.y&&"number"==typeof e.z&&"number"==typeof e.w?n.X5.ANIMATIONTYPE_QUATERNION:null!=e&&(Array.isArray(e.m)||"object"==typeof e.m)?n.X5.ANIMATIONTYPE_MATRIX:null!=e&&"number"==typeof e.x&&"number"==typeof e.y&&"number"==typeof e.z?n.X5.ANIMATIONTYPE_VECTOR3:null!=e&&"number"==typeof e.x&&"number"==typeof e.y?n.X5.ANIMATIONTYPE_VECTOR2:null!=e&&"number"==typeof e.r&&"number"==typeof e.g&&"number"==typeof e.b?n.X5.ANIMATIONTYPE_COLOR3:null!=e&&"number"==typeof e.r&&"number"==typeof e.g&&"number"==typeof e.b&&"number"==typeof e.a?n.X5.ANIMATIONTYPE_COLOR4:null!=e&&"number"==typeof e.width&&"number"==typeof e.height?n.X5.ANIMATIONTYPE_SIZE:n.X5.ANIMATIONTYPE_FLOAT},69657:function(){},59651:function(){},99180:function(e,t,i){let r;var n=i(44043),a=i(55514);let o=!!((new Uint32Array((r=new Uint8Array(4)).buffer)[0]=1)&r[0]);Object.defineProperty(n.R.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0}),Object.defineProperty(n.R.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(n.R.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0}),n.R.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild()},n.R.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0},n.R.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer},n.R.prototype._alignBuffer=function(){let e,t,i=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4==0&&this.byteOffset%4==0||!i)return;let r=(0,a.PD)(this.type),s=this.byteStride+3&-4,l=s/r,c=this._maxVerticesCount,f=c*s/r;if(Array.isArray(i)){let t=new Float32Array(i);e=new DataView(t.buffer,t.byteOffset,t.byteLength)}else e=i instanceof ArrayBuffer?new DataView(i,0,i.byteLength):new DataView(i.buffer,i.byteOffset,i.byteLength);t=this.type===n.R.BYTE?new Int8Array(f):this.type===n.R.UNSIGNED_BYTE?new Uint8Array(f):this.type===n.R.SHORT?new Int16Array(f):this.type===n.R.UNSIGNED_SHORT?new Uint16Array(f):this.type===n.R.INT?new Int32Array(f):this.type===n.R.UNSIGNED_INT?new Uint32Array(f):new Float32Array(f);let u=this.getSize(),d=this.byteOffset;for(let i=0;i<c;++i){for(let r=0;r<u;++r)switch(this.type){case n.R.BYTE:t[i*l+r]=e.getInt8(d+r);break;case n.R.UNSIGNED_BYTE:t[i*l+r]=e.getUint8(d+r);break;case n.R.SHORT:t[i*l+r]=e.getInt16(d+2*r,o);break;case n.R.UNSIGNED_SHORT:t[i*l+r]=e.getUint16(d+2*r,o);break;case n.R.INT:t[i*l+r]=e.getInt32(d+4*r,o);break;case n.R.UNSIGNED_INT:t[i*l+r]=e.getUint32(d+4*r,o);break;case n.R.FLOAT:t[i*l+r]=e.getFloat32(d+4*r,o)}d+=this.byteStride}this._alignedBuffer?.dispose(),this._alignedBuffer=new n.h(this.engine,t,!1,s,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")}},82169:function(e,t,i){i.d(t,{z:()=>a});var r=i(81741);let n={[r.R.PositionKind]:!0,[r.R.NormalKind]:!0,[r.R.TangentKind]:!0,[r.R.UVKind]:!0,[r.R.UV2Kind]:!0,[r.R.UV3Kind]:!0,[r.R.UV4Kind]:!0,[r.R.UV5Kind]:!0,[r.R.UV6Kind]:!0,[r.R.ColorKind]:!0,[r.R.ColorInstanceKind]:!0,[r.R.MatricesIndicesKind]:!0,[r.R.MatricesWeightsKind]:!0,[r.R.MatricesIndicesExtraKind]:!0,[r.R.MatricesWeightsExtraKind]:!0};function a(e,t){let i=t.getEngine(),a=t._pipelineContext;if(!a?.vertexBufferKindToType)return;let o=null;for(let s in e){let l=e[s];if(!l||!n[s])continue;let c=l.normalized?r.R.FLOAT:l.type,f=a.vertexBufferKindToType[s];(c!==r.R.FLOAT&&void 0===f||void 0!==f&&f!==c)&&(o||(o=i._getShaderProcessingContext(t.shaderLanguage,!1)),a.vertexBufferKindToType[s]=c,c!==r.R.FLOAT&&(o.vertexBufferKindToNumberOfComponents[s]=r.R.DeduceStride(s),function(e){switch(e){case r.R.BYTE:case r.R.SHORT:case r.R.INT:case r.R.FLOAT:return!0;case r.R.UNSIGNED_BYTE:case r.R.UNSIGNED_SHORT:case r.R.UNSIGNED_INT:return!1;default:throw Error(`Invalid type '${e}'`)}}(c)&&(o.vertexBufferKindToNumberOfComponents[s]*=-1)))}if(o){let e=i._caps.parallelShaderCompile;i._caps.parallelShaderCompile=void 0,t._processShaderCodeAsync(null,i._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,o),i._caps.parallelShaderCompile=e}}},97890:function(e,t,i){i.d(t,{n:()=>o});var r=i(25923),n=i(92460),a=i(49477);n.H.prototype.addVRDeviceOrientation=function(){return this.add(new o),this};class o{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=a.S0.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);let t=this.camera.getScene().getEngine().getHostWindow();t&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e?t.addEventListener("deviceorientation",this._deviceOrientationHandler):a.S0.Warn("Permission not granted.")}).catch(e=>{a.S0.Error(e)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}r.H.ArcRotateCameraVRDeviceOrientationInput=o},53265:function(e,t,i){i.d(t,{e:()=>l});var r=i(25923),n=i(97782),a=i(49477),o=i(7445),s=i(76937);o.s.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new l,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class l{static async WaitForOrientationChangeAsync(e){return await new Promise((t,i)=>{let r=!1,n=()=>{window.removeEventListener("deviceorientation",n),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",n),i("WaitForOrientationChangeAsync timed out"))},e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"==e?window.addEventListener("deviceorientation",n):a.S0.Warn("Permission not granted.")}).catch(e=>{a.S0.Error(e)}):window.addEventListener("deviceorientation",n)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new n.PT,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new s.cP,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-a.S0.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?a.S0.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?a.S0.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?a.S0.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new n.PT(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new n.PT),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){let e=this.camera.getScene().getEngine().getHostWindow();if(e){let t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e?t():a.S0.Warn("Permission not granted.")}).catch(e=>{a.S0.Error(e)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&this._camera.rotationQuaternion&&(n.PT.RotationYawPitchRollToRef(a.S0.ToRadians(this._alpha),a.S0.ToRadians(this._beta),-a.S0.ToRadians(this._gamma),this._camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}r.H.FreeCameraDeviceOrientationInput=l},62534:function(e,t,i){i.d(t,{d:()=>o});var r=i(111),n=i(25923),a=i(97782);i(7445).s.prototype.addVirtualJoystick=function(){return this.add(new o),this};class o{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){let e=this.camera,t=50*e._computeLocalCameraSpeed(),i=a.uq.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=a.Pq.TransformCoordinates(new a.Pq(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new r.Y(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new r.Y(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}n.H.FreeCameraVirtualJoystickInput=o},26120:function(e,t,i){i.d(t,{y:()=>n});var r=i(61020);class n{constructor(e){this._altitudeMin=r.bH,this._radiusMin=r.bH,this._radiusMax=1/0,this.pitchMin=r.bH,this.pitchMax=Math.PI/2,this.yawMin=-1/0,this.yawMax=1/0,this.pinchToPanMax=20,this._planetRadius=e}get altitudeMin(){return this._altitudeMin}set altitudeMin(e){this._altitudeMin=e,this._radiusMin=this._planetRadius+e}get altitudeMax(){return this._altitudeMax}set altitudeMax(e){this._altitudeMax=e,this._radiusMax=this._planetRadius+e}get radiusMin(){return this._radiusMin}set radiusMin(e){this._radiusMin=e,this._altitudeMin=e-this._planetRadius}get radiusMax(){return this._radiusMax}set radiusMax(e){this._radiusMax=e,this._altitudeMax=e-this._planetRadius}get planetRadius(){return this._planetRadius}set planetRadius(e){this._planetRadius=e,this._radiusMin=e+this._altitudeMin,this._radiusMax=e+this._altitudeMax}}},24029:function(e,t,i){i.d(t,{r:()=>u});var r=i(25923),n=i(19152),a=i(21388),o=i(69081),s=i(1742),l=i(49927),c=i(49477);class f{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysZoomIn=[187,107],this.keysZoomOut=[189,109],this.rotationSensitivity=1,this.panSensitivity=1,this.zoomSensitivity=1,this._keys=[]}attachControl(e){e=c.S0.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===l.TB.KEYDOWN)this._ctrlPressed=i.ctrlKey,(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysZoomIn.indexOf(i.keyCode)||-1!==this.keysZoomOut.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&!e&&i.preventDefault());else if(-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)||-1!==this.keysZoomIn.indexOf(i.keyCode)||-1!==this.keysZoomOut.indexOf(i.keyCode)){let t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&!e&&i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t];if(this._ctrlPressed)-1!==this.keysLeft.indexOf(i)?e.movement.rotationAccumulatedPixels.y-=this.rotationSensitivity:-1!==this.keysRight.indexOf(i)?e.movement.rotationAccumulatedPixels.y+=this.rotationSensitivity:-1!==this.keysUp.indexOf(i)?e.movement.rotationAccumulatedPixels.x-=this.rotationSensitivity:-1!==this.keysDown.indexOf(i)&&(e.movement.rotationAccumulatedPixels.x+=this.rotationSensitivity);else if(-1!==this.keysZoomIn.indexOf(i))e.movement.zoomAccumulatedPixels+=this.zoomSensitivity;else if(-1!==this.keysZoomOut.indexOf(i))e.movement.zoomAccumulatedPixels-=this.zoomSensitivity;else{let t=this._engine.getRenderWidth()/2,r=this._engine.getRenderHeight()/2;e.movement.startDrag(t,r),-1!==this.keysLeft.indexOf(i)?e.movement.handleDrag(t-this.panSensitivity,r):-1!==this.keysRight.indexOf(i)?e.movement.handleDrag(t+this.panSensitivity,r):-1!==this.keysUp.indexOf(i)?e.movement.handleDrag(t,r+this.panSensitivity):-1!==this.keysDown.indexOf(i)&&e.movement.handleDrag(t,r-this.panSensitivity),e.movement.stopDrag()}}}}getClassName(){return"GeospatialCameraKeyboardInput"}getSimpleName(){return"keyboard"}}(0,o.Cg)([(0,s.lK)()],f.prototype,"keysUp",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"keysDown",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"keysLeft",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"keysRight",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"keysZoomIn",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"keysZoomOut",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"rotationSensitivity",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"panSensitivity",void 0),(0,o.Cg)([(0,s.lK)()],f.prototype,"zoomSensitivity",void 0),r.H.GeospatialCameraKeyboardInput=f;class u extends r._{constructor(e){super(e)}addMouse(){return this.add(new n.r),this}addMouseWheel(){return this.add(new a.T),this}addKeyboard(){return this.add(new f),this}}},74695:function(e,t,i){i.d(t,{uj:()=>d,qn:()=>h,SS:()=>u});var r=i(97782),n=i(61020);let a=1e3/60;class o{constructor(e,t,i){this._cameraPosition=t,this._behavior=i,this.activeInput=!1,this.zoomSpeed=1,this.panSpeed=1,this.rotationXSpeed=1,this.rotationYSpeed=1,this._zoomSpeedMultiplier=1,this._panSpeedMultiplier=1,this.zoomInertia=.9,this.panInertia=.9,this.rotationInertia=.9,this.zoomAccumulatedPixels=0,this.panAccumulatedPixels=new r.Pq,this.rotationAccumulatedPixels=new r.Pq,this.zoomDeltaCurrentFrame=0,this.panDeltaCurrentFrame=r.Pq.Zero(),this.rotationDeltaCurrentFrame=r.Pq.Zero(),this._zoomVelocity=0,this._panVelocity=new r.Pq,this._rotationVelocity=new r.Pq,this._prevFrameTimeMs=a,this._scene=e}computeCurrentFrameDeltas(){let e=this._scene.getEngine().getDeltaTime();this.panDeltaCurrentFrame.setAll(0),this.rotationDeltaCurrentFrame.setAll(0),this.zoomDeltaCurrentFrame=0,(this.panAccumulatedPixels.lengthSquared()>0||this.rotationAccumulatedPixels.lengthSquared()>0||0!==this.zoomAccumulatedPixels)&&this._behavior?.isInterpolating&&this._behavior.stopAllAnimations(),this._panVelocity.copyFromFloats(this._calculateCurrentVelocity(this._panVelocity.x,this.panAccumulatedPixels.x,this.panSpeed*this._panSpeedMultiplier,this.panInertia),this._calculateCurrentVelocity(this._panVelocity.y,this.panAccumulatedPixels.y,this.panSpeed*this._panSpeedMultiplier,this.panInertia),this._calculateCurrentVelocity(this._panVelocity.z,this.panAccumulatedPixels.z,this.panSpeed*this._panSpeedMultiplier,this.panInertia)),this._panVelocity.scaleToRef(e,this.panDeltaCurrentFrame),this._rotationVelocity.copyFromFloats(this._calculateCurrentVelocity(this._rotationVelocity.x,this.rotationAccumulatedPixels.x,this.rotationXSpeed,this.rotationInertia),this._calculateCurrentVelocity(this._rotationVelocity.y,this.rotationAccumulatedPixels.y,this.rotationYSpeed,this.rotationInertia),this._calculateCurrentVelocity(this._rotationVelocity.z,this.rotationAccumulatedPixels.z,this.rotationYSpeed,this.rotationInertia)),this._rotationVelocity.scaleToRef(e,this.rotationDeltaCurrentFrame),this._zoomVelocity=this._calculateCurrentVelocity(this._zoomVelocity,this.zoomAccumulatedPixels,this.zoomSpeed*this._zoomSpeedMultiplier,this.zoomInertia),this.zoomDeltaCurrentFrame=this._zoomVelocity*e,this._prevFrameTimeMs=e,this.zoomAccumulatedPixels=0,this.panAccumulatedPixels.setAll(0),this.rotationAccumulatedPixels.setAll(0)}get isInterpolating(){return!!this._behavior?.isInterpolating}_calculateCurrentVelocity(e,t,i,r){let o=e,s=this._scene.getEngine().getDeltaTime();return 0!==t||this.activeInput?o=t/s*i:!this.activeInput&&0!==o&&Math.abs(o*=Math.pow(r,this._prevFrameTimeMs/a))<=n.bH&&(o=0),o}}var s=i(71519),l=i(79194),c=i(23933),f=i(52754);class u extends o{constructor(e,t,i,n,a,o,c){super(e,i,c),this.limits=t,this._cameraCenter=n,this._cameraLookAt=a,this.zoomToCursor=!0,this._hitPointRadius=void 0,this._dragPlane=new s.Z(0,0,0,0),this._dragPlaneNormal=r.Pq.Zero(),this._dragPlaneOriginPointEcef=r.Pq.Zero(),this._dragPlaneHitPointLocal=r.Pq.Zero(),this._previousDragPlaneHitPointLocal=r.Pq.Zero(),this.pickPredicate=o,this._tempPickingRay=new l.Rl(this._cameraPosition,this._cameraLookAt),this.panInertia=0,this.rotationInertia=0,this.rotationXSpeed=Math.PI/500,this.rotationYSpeed=Math.PI/500}startDrag(e,t){let i=this._scene.pick(e,t,this.pickPredicate);i.pickedPoint&&i.ray?(this._hitPointRadius=i.pickedPoint.length(),this._recalculateDragPlaneHitPoint(this._hitPointRadius,i.ray,r.AA.Matrix["0"]),this._previousDragPlaneHitPointLocal.copyFrom(this._dragPlaneHitPointLocal)):this._hitPointRadius=void 0}stopDrag(){this._hitPointRadius=void 0}_recalculateDragPlaneHitPoint(e,t,i){var n,a,o;let l;this._cameraPosition.normalizeToRef(this._dragPlaneNormal),this._dragPlaneNormal.scaleToRef(e,this._dragPlaneOriginPointEcef),h(this._dragPlaneOriginPointEcef,r.AA.Vector3["0"],r.AA.Vector3["1"],r.AA.Vector3["2"]);let c=r.uq.FromXYZAxesToRef(r.AA.Vector3["0"],r.AA.Vector3["1"],r.AA.Vector3["2"],i);c.setTranslationFromFloats(this._dragPlaneOriginPointEcef.x,this._dragPlaneOriginPointEcef.y,this._dragPlaneOriginPointEcef.z);let f=c.invertToRef(r.AA.Matrix["1"]);s.Z.FromPositionAndNormalToRef(this._dragPlaneOriginPointEcef,this._dragPlaneNormal,this._dragPlane),n=t,a=this._dragPlane,o=this._dragPlaneHitPointLocal,null!==(l=n.intersectsPlane(a))&&l>=0&&(n.origin.addToRef(n.direction.scaleToRef(l,r.AA.Vector3["0"]),o),1)&&r.Pq.TransformCoordinatesToRef(this._dragPlaneHitPointLocal,f,this._dragPlaneHitPointLocal)}handleDrag(e,t){if(this._hitPointRadius){let i=this._scene.pick(e,t);if(i.ray){let e=r.AA.Matrix["0"];this._recalculateDragPlaneHitPoint(this._hitPointRadius,i.ray,e);let t=this._dragPlaneHitPointLocal.subtractToRef(this._previousDragPlaneHitPointLocal,r.AA.Vector3["6"]);this._previousDragPlaneHitPointLocal.copyFrom(this._dragPlaneHitPointLocal),r.Pq.TransformNormalToRef(t,e,t),this._dragPlaneOriginPointEcef.addInPlace(t),this.panAccumulatedPixels.subtractInPlace(t)}}}computeCurrentFrameDeltas(){let e=this._cameraCenter;if(this.panAccumulatedPixels.lengthSquared()>n.bH){let t=e.length(),i=this._cameraPosition.length(),r=0===t?0:e.z/t,a=Math.sqrt(Math.abs(Math.sqrt(1-Math.min(1,r*r)))),o=Math.max(i-t,n.bH),s=Math.max(1,t/o);this._panSpeedMultiplier=(0,f.Clamp)(s*a,0,1)}else this._panSpeedMultiplier=1;this.isDragging?(this._zoomSpeedMultiplier=0,this._zoomVelocity=0):this._zoomSpeedMultiplier=.01*(0,c.cZ)(this._cameraPosition,e);let t=Math.abs(this.zoomAccumulatedPixels)>0;super.computeCurrentFrameDeltas(),this._handleZoom(t)}get isDragging(){return void 0!==this._hitPointRadius}_handleZoom(e){if(Math.abs(this.zoomDeltaCurrentFrame)>n.bH){let t;if(e){let e=this._scene.pick(this._scene.pointerX,this._scene.pointerY,this.pickPredicate);if(e.hit&&e.pickedPoint&&e.ray&&this.zoomToCursor)t=e.distance,this._storedZoomPickDistance=t,this.computedPerFrameZoomPickPoint=e.pickedPoint;else{let e=this.pickAlongVector(this._cameraLookAt);t=e?.distance,this._storedZoomPickDistance=t,this.computedPerFrameZoomPickPoint=void 0}}else t=this._storedZoomPickDistance;this._clampZoomDistance(this.zoomDeltaCurrentFrame,t)}}_clampZoomDistance(e,t){if(e>0&&(void 0!==t?(t-this.limits.altitudeMin<0&&(this.zoomDeltaCurrentFrame=0),this.zoomDeltaCurrentFrame=Math.min(e,t-this.limits.altitudeMin)):this.zoomDeltaCurrentFrame=e),e<0){let t=this.limits.radiusMax?this.limits.radiusMax-this._cameraPosition.length():1/0;this.zoomDeltaCurrentFrame=Math.max(e,-t)}return this.zoomDeltaCurrentFrame}pickAlongVector(e){return this._tempPickingRay.origin.copyFrom(this._cameraPosition),this._tempPickingRay.direction.copyFrom(e),this._scene.pickWithRay(this._tempPickingRay,this.pickPredicate)}}function d(e){let t=e.length();if(t>n.bH){let i=0===t?0:e.z/t;if(Math.abs(i)>.998749218){let r=(0,f.Clamp)(i,-.998749218,.998749218),n=Math.sqrt(1-r*r),a=Math.atan2(e.y,e.x),o=t*Math.cos(a)*n,s=t*Math.sin(a)*n;e.set(o,s,t*r)}}return e}function h(e,t,i,a){a.copyFrom(e).normalize();let o=r.Pq.LeftHandedForwardReadOnly;r.Pq.CrossToRef(o,a,t),t.lengthSquared()<n.bH&&r.Pq.CrossToRef(r.Pq.Right(),a,t),t.normalize(),r.Pq.CrossToRef(a,t,i),i.normalize()}},55937:function(e,t,i){i.d(t,{A:()=>s});var r=i(38241),n=i(97782),a=i(10651),o=i(39393);class s{constructor(){this._scaledPosition=n.Pq.Zero(),this._scaledVelocity=n.Pq.Zero(),this._finalPosition=n.Pq.Zero()}getNewPosition(e,t,i,r,n,a,o,s=!0){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,s,n),this._finalPosition.multiplyInPlace(i._radius),a(o,this._finalPosition,i.collidedMesh)}createCollider(){return new a.J}init(e){this._scene=e}_collideWithWorld(e,t,i,r,n,a,s=null){let l=10*o.$.CollisionsEpsilon;if(i._retry>=r)return void n.copyFrom(e);let c=s?s.collisionMask:i.collisionMask;i._initialize(e,t,l);let f=s&&s.surroundingMeshes||this._scene.meshes;for(let e=0;e<f.length;e++){let t=f[e];t.isEnabled()&&t.checkCollisions&&t.subMeshes&&t!==s&&(c&t.collisionGroup)!=0&&t._checkCollision(i)}i.collisionFound?((0!==t.x||0!==t.y||0!==t.z)&&(i._getResponse(e,t,a),a||t.setAll(0)),t.length()<=l)?n.copyFrom(e):(i._retry++,this._collideWithWorld(e,t,i,r,n,a,s)):e.addToRef(t,n)}}r.Z.CollisionCoordinatorFactory=()=>new s},50961:function(e,t,i){i.d(t,{AU:()=>p,DY:()=>A,Gz:()=>h,KI:()=>I,Oj:()=>C,R0:()=>f,Rl:()=>u,S:()=>T,TR:()=>x,m9:()=>R,mc:()=>E,oZ:()=>m,uW:()=>S,ui:()=>d});var r=i(61020),n=i(97782),a=i(73896),o=i(2590),s=i(35632),l=i(37702),c=i(35584);let f={internalPickerForMesh:void 0};class u{constructor(e,t,i=Number.MAX_VALUE,n=r.bH){this.origin=e,this.direction=t,this.length=i,this.epsilon=n}clone(){return new u(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){let r,n,a,o,s=u._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),l=u._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i),c=0,f=Number.MAX_VALUE;if(1e-7>Math.abs(this.direction.x)){if(this.origin.x<s.x||this.origin.x>l.x)return!1}else if(r=1/this.direction.x,n=(s.x-this.origin.x)*r,(a=(l.x-this.origin.x)*r)==-1/0&&(a=1/0),n>a&&(o=n,n=a,a=o),(c=Math.max(n,c))>(f=Math.min(a,f)))return!1;if(1e-7>Math.abs(this.direction.y)){if(this.origin.y<s.y||this.origin.y>l.y)return!1}else if(r=1/this.direction.y,n=(s.y-this.origin.y)*r,(a=(l.y-this.origin.y)*r)==-1/0&&(a=1/0),n>a&&(o=n,n=a,a=o),(c=Math.max(n,c))>(f=Math.min(a,f)))return!1;if(1e-7>Math.abs(this.direction.z)){if(this.origin.z<s.z||this.origin.z>l.z)return!1}else if(r=1/this.direction.z,n=(s.z-this.origin.z)*r,(a=(l.z-this.origin.z)*r)==-1/0&&(a=1/0),n>a&&(o=n,n=a,a=o),(c=Math.max(n,c))>(f=Math.min(a,f)))return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,n=e.center.z-this.origin.z,a=i*i+r*r+n*n,o=e.radius+t,s=o*o;if(a<=s)return!0;let l=i*this.direction.x+r*this.direction.y+n*this.direction.z;return!(l<0)&&a-l*l<=s}intersectsTriangle(e,t,i){let r=u._TmpVector3[0],a=u._TmpVector3[1],s=u._TmpVector3[2],l=u._TmpVector3[3],c=u._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,a),n.Pq.CrossToRef(this.direction,a,s);let f=n.Pq.Dot(r,s);if(0===f)return null;let d=1/f;this.origin.subtractToRef(e,l);let h=n.Pq.Dot(l,s)*d;if(h<-this.epsilon||h>1+this.epsilon)return null;n.Pq.CrossToRef(l,r,c);let p=n.Pq.Dot(this.direction,c)*d;if(p<-this.epsilon||h+p>1+this.epsilon)return null;let m=n.Pq.Dot(a,c)*d;return m>this.length||m<0?null:new o.w(1-h-p,h,m)}intersectsPlane(e){let t,i=n.Pq.Dot(e.normal,this.direction);if(999999997475243e-21>Math.abs(i))return null;{let r=n.Pq.Dot(e.normal,this.origin);if((t=(-e.d-r)/i)<0)if(t<-999999997475243e-21)return null;else return 0;return t}}intersectsAxis(e,t=0){switch(e){case"y":{let e=(this.origin.y-t)/this.direction.y;if(e>0)return null;return new n.Pq(this.origin.x+-(this.direction.x*e),t,this.origin.z+-(this.direction.z*e))}case"x":{let e=(this.origin.x-t)/this.direction.x;if(e>0)return null;return new n.Pq(t,this.origin.y+-(this.direction.y*e),this.origin.z+-(this.direction.z*e))}case"z":{let e=(this.origin.z-t)/this.direction.z;if(e>0)return null;return new n.Pq(this.origin.x+-(this.direction.x*e),this.origin.y+-(this.direction.y*e),t)}default:return null}}intersectsMesh(e,t,i,r=!1,a,o=!1){let s=n.AA.Matrix["0"];return e.getWorldMatrix().invertToRef(s),this._tmpRay?u.TransformToRef(this,s,this._tmpRay):this._tmpRay=u.Transform(this,s),e.intersects(this._tmpRay,t,i,r,a,o)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){let n=this.intersectsMesh(e[r],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:+(e.distance>t.distance)}intersectionSegment(e,t,i){let r=this.origin,a=n.AA.Vector3["0"],o=n.AA.Vector3["1"],s=n.AA.Vector3["2"],l=n.AA.Vector3["3"];t.subtractToRef(e,a),this.direction.scaleToRef(u._Rayl,s),r.addToRef(s,o),e.subtractToRef(r,l);let c=n.Pq.Dot(a,a),f=n.Pq.Dot(a,s),d=n.Pq.Dot(s,s),h=n.Pq.Dot(a,l),p=n.Pq.Dot(s,l),m=c*d-f*f,_,g=m,v,S=m;m<u._Smallnum?(_=0,g=1,v=p,S=d):(_=f*p-d*h,v=c*p-f*h,_<0?(_=0,v=p,S=d):_>g&&(_=g,v=p+f,S=d)),v<0?(v=0,0>-h?_=0:-h>c?_=g:(_=-h,g=c)):v>S&&(v=S,-h+f<0?_=0:-h+f>c?_=g:(_=-h+f,g=c));let E=Math.abs(_)<u._Smallnum?0:_/g,T=Math.abs(v)<u._Smallnum?0:v/S,A=n.AA.Vector3["4"];s.scaleToRef(T,A);let x=n.AA.Vector3["5"];a.scaleToRef(E,x),x.addInPlace(l);let I=n.AA.Vector3["6"];return(x.subtractToRef(A,I),T>0&&T<=this.length&&I.lengthSquared()<i*i)?x.length():-1}update(e,t,i,r,a,o,s,l=!1){if(l){u._RayDistant||(u._RayDistant=u.Zero()),u._RayDistant.unprojectRayToRef(e,t,i,r,n.uq.IdentityReadOnly,o,s);let l=n.AA.Matrix["0"];a.invertToRef(l),u.TransformToRef(u._RayDistant,l,this)}else this.unprojectRayToRef(e,t,i,r,a,o,s);return this}static Zero(){return new u(n.Pq.Zero(),n.Pq.Zero())}static CreateNew(e,t,i,r,n,a,o){return u.Zero().update(e,t,i,r,n,a,o)}static CreateNewFromTo(e,t,i=n.uq.IdentityReadOnly){let r=new u(new n.Pq(0,0,0),new n.Pq(0,0,0));return u.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=n.uq.IdentityReadOnly){i.origin.copyFrom(e);let a=t.subtractToRef(e,i.direction);return i.length=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),i.direction.normalize(),u.TransformToRef(i,r,i)}static Transform(e,t){let i=new u(new n.Pq(0,0,0),new n.Pq(0,0,0));return u.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){n.Pq.TransformCoordinatesToRef(e.origin,t,i.origin),n.Pq.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;let r=i.direction,a=r.length();if(0!==a&&1!==a){let e=1/a;r.x*=e,r.y*=e,r.z*=e,i.length*=a}return i}unprojectRayToRef(e,t,i,r,a,o,s){let c=n.AA.Matrix["0"];a.multiplyToRef(o,c),c.multiplyToRef(s,c),c.invert();let f=l.q.LastCreatedEngine,u=n.AA.Vector3["0"];u.x=e/i*2-1,u.y=-(t/r*2-1),u.z=f?.useReverseDepthBuffer?1:f?.isNDCHalfZRange?0:-1;let d=n.AA.Vector3["1"].copyFromFloats(u.x,u.y,1-1e-8),h=n.AA.Vector3["2"],p=n.AA.Vector3["3"];n.Pq.TransformCoordinatesToRef(u,c,h),n.Pq.TransformCoordinatesToRef(d,c,p),this.origin.copyFrom(h),p.subtractToRef(h,this.direction),this.direction.normalize()}}function d(e,t,i,r,n,a=!1){let o=u.Zero();return h(e,t,i,r,o,n,a),o}function h(e,t,i,r,a,o,s=!1,l=!1){let c=e.getEngine();if(!o&&!(o=e.activeCamera))return e;let f=o.viewport,u=c.getRenderHeight(),{x:d,y:p,width:m,height:_}=f.toGlobal(c.getRenderWidth(),u),g=1/c.getHardwareScalingLevel();return t=t*g-d,i=i*g-(u-p-_),a.update(t,i,m,_,r||n.uq.IdentityReadOnly,s?n.uq.IdentityReadOnly:o.getViewMatrix(),o.getProjectionMatrix(),l),e}function p(e,t,i,r){let n=u.Zero();return m(e,t,i,n,r),n}function m(e,t,i,r,a){if(!s.G)return e;let o=e.getEngine();if(!a&&!(a=e.activeCamera))throw Error("Active camera not set");let l=a.viewport,c=o.getRenderHeight(),{x:f,y:u,width:d,height:h}=l.toGlobal(o.getRenderWidth(),c),p=n.uq.Identity(),m=1/o.getHardwareScalingLevel();return t=t*m-f,i=i*m-(c-u-h),r.update(t,i,d,h,p,p,a.getProjectionMatrix()),e}function _(e,t,i,r,n,a,o,s){let l=t(r,i.enableDistantPicking),c=i.intersects(l,n,o,a,r,s);return c&&c.hit&&(n||null==e||!(c.distance>=e.distance))?c:null}function g(e,t,i,r,a,o){let l=null,c=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),u=e.cameraToUseForPointers||e.activeCamera,d=f.internalPickerForMesh||_;for(let s=0;s<e.meshes.length;s++){let f=e.meshes[s];if(i){if(!i(f,-1))continue}else if(!f.isEnabled()||!f.isVisible||!f.isPickable)continue;let h=c&&f.isWorldMatrixCameraDependent(),p=f.computeWorldMatrix(h,u);if(f.hasThinInstances&&f.thinInstanceEnablePicking){let e=d(l,t,f,p,!0,!0,o);if(e){if(a)return e;let s=n.AA.Matrix["1"],c=f.thinInstanceGetWorldMatrices();for(let e=0;e<c.length;e++){if(i&&!i(f,e))continue;c[e].multiplyToRef(p,s);let n=d(l,t,f,s,r,a,o,!0);if(n&&((l=n).thinInstanceIndex=e,r))return l}}}else{let e=d(l,t,f,p,r,a,o);if(e&&(l=e,r))return l}}return l||new s.G}function v(e,t,i,r){if(!s.G)return null;let a=[],o=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),l=e.cameraToUseForPointers||e.activeCamera,c=f.internalPickerForMesh||_;for(let s=0;s<e.meshes.length;s++){let f=e.meshes[s];if(i){if(!i(f,-1))continue}else if(!f.isEnabled()||!f.isVisible||!f.isPickable)continue;let u=o&&f.isWorldMatrixCameraDependent(),d=f.computeWorldMatrix(u,l);if(f.hasThinInstances&&f.thinInstanceEnablePicking){if(c(null,t,f,d,!0,!0,r)){let e=n.AA.Matrix["1"],o=f.thinInstanceGetWorldMatrices();for(let n=0;n<o.length;n++){if(i&&!i(f,n))continue;o[n].multiplyToRef(d,e);let s=c(null,t,f,e,!1,!1,r,!0);s&&(s.thinInstanceIndex=n,a.push(s))}}}else{let e=c(null,t,f,d,!1,!1,r);e&&a.push(e)}}return a}function S(e,t,i,r,a,o){if(!s.G)return null;let l=g(e,r=>(e._tempPickingRay||(e._tempPickingRay=u.Zero()),h(e,t,i,r,e._tempPickingRay,o||null),e._tempPickingRay),r,a,!0);return l&&(l.ray=d(e,t,i,n.uq.Identity(),o||null)),l}function E(e,t,i,r,a,o,s,l=!1){let c=g(e,(r,n)=>(e._tempPickingRay||(e._tempPickingRay=u.Zero()),h(e,t,i,r,e._tempPickingRay,o||null,!1,n),e._tempPickingRay),r,a,!1,s);return c&&(c.ray=d(e,t,i,n.uq.Identity(),o||null)),c}function T(e,t,i,r,a){let o=g(e,i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=n.uq.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=u.Zero()),u.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform),i,r,!1,a);return o&&(o.ray=t),o}function A(e,t,i,r,n,a){return v(e,r=>d(e,t,i,r,n||null),r,a)}function x(e,t,i,r){return v(e,i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=n.uq.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=u.Zero()),u.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform),i,r)}function I(e,t=100,i,r){return R(e,new u(n.Pq.Zero(),n.Pq.Zero(),t),t,i,r)}function R(e,t,i=100,r,a){r||(r=e.getWorldMatrix()),t.length=i,a?t.origin.copyFrom(a):t.origin.copyFrom(e.position);let o=n.AA.Vector3["2"];o.set(0,0,e._scene.useRightHandedSystem?-1:1);let s=n.AA.Vector3["3"];return n.Pq.TransformNormalToRef(o,r,s),n.Pq.NormalizeToRef(s,t.direction),t}function C(e,t){t&&(t.prototype.getForwardRay=function(e=100,t,i){return R(this,new u(n.Pq.Zero(),n.Pq.Zero(),e),e,t,i)},t.prototype.getForwardRayToRef=function(e,t=100,i,r){return R(this,e,t,i,r)}),e&&(c.h._IsPickingAvailable=!0,e.prototype.createPickingRay=function(e,t,i,r,n=!1){return d(this,e,t,i,r,n)})}u._TmpVector3=(0,a.mI)(6,n.Pq.Zero),u._RayDistant=u.Zero(),u._Smallnum=1e-8,u._Rayl=1e9},79194:function(e,t,i){i.d(t,{AU:()=>a.AU,DY:()=>a.DY,Gz:()=>a.Gz,KI:()=>a.KI,Oj:()=>a.Oj,R0:()=>a.R0,Rl:()=>a.Rl,S:()=>a.S,TR:()=>a.TR,m9:()=>a.m9,mc:()=>a.mc,oZ:()=>a.oZ,uW:()=>a.uW,ui:()=>a.ui});var r=i(38241),n=i(45119),a=i(50961);(0,a.Oj)(r.Z,n.i),r.Z.prototype.createPickingRayToRef=function(e,t,i,r,n,o=!1,s=!1){return(0,a.Gz)(this,e,t,i,r,n,o,s)},r.Z.prototype.createPickingRayInCameraSpace=function(e,t,i){return(0,a.AU)(this,e,t,i)},r.Z.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,r){return(0,a.oZ)(this,e,t,i,r)},r.Z.prototype.pickWithBoundingInfo=function(e,t,i,r,n){return(0,a.uW)(this,e,t,i,r,n)},r.Z.prototype.pick=function(e,t,i,r,n,o,s=!1){return(0,a.mc)(this,e,t,i,r,n,o,s)},r.Z.prototype.pickWithRay=function(e,t,i,r){return(0,a.S)(this,e,t,i,r)},r.Z.prototype.multiPick=function(e,t,i,r,n){return(0,a.DY)(this,e,t,i,r,n)},r.Z.prototype.multiPickWithRay=function(e,t,i){return(0,a.TR)(this,e,t,i)}},77186:function(e,t,i){i.d(t,{dg:()=>a.d,uB:()=>r.u,pJ:()=>x.p,K0:()=>a.K,$c:()=>R.$,Uv:()=>n.U,wR:()=>A,qY:()=>I.q});var r=i(74706),n=i(47112),a=i(91297),o=i(84774),s=i(19754),l=i(62888),c=i(97782),f=i(55322),u=i(37702),d=i(93874),h=i(40133),p=i(58274),m=i(99661),_=i(71740),g=i(57480),v=i(58720),S=i(99047),E=i(89671),T=i(61020);class A{constructor(e,t,i=p.j.DefaultUtilityLayer){if(this._impostors=[],this._meshes=[],this._bodies=[],this._inertiaBodies=[],this._constraints=[],this._bodyMeshes=[],this._inertiaMeshes=[],this._constraintMeshes=[],this._numMeshes=0,this._numBodies=0,this._numInertiaBodies=0,this._numConstraints=0,this._ownUtilityLayer=!1,this._debugMeshMeshes=[],this._constraintAxesSize=.4,this._constraintAngularSize=.4,this._scene=e||u.q.LastCreatedScene,!this._scene)return;const r=this._scene.getPhysicsEngine();r&&(this._physicsEnginePlugin=r.getPhysicsPlugin()),i?this._utilityLayer=i:(this._utilityLayer=new p.j(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0,this._ownUtilityLayer=!0),t&&(this._constraintAxesSize=.4*t,this._constraintAngularSize=.4*t)}_updateDebugMeshes(){let e=this._physicsEnginePlugin;e?.getPluginVersion()===1?this._updateDebugMeshesV1():this._updateDebugMeshesV2()}_updateDebugMeshesV1(){let e=this._physicsEnginePlugin;for(let t=0;t<this._numMeshes;t++){let i=this._impostors[t];if(i)if(i.isDisposed)this.hideImpostor(this._impostors[t--]);else{if(i.type===h.j.MeshImpostor)continue;let r=this._meshes[t];r&&e&&e.syncMeshWithImpostor(r,i)}}}_updateDebugMeshesV2(){let e=this._physicsEnginePlugin;for(let t=0;t<this._numBodies;){let i=this._bodies[t];if(i&&i.isDisposed&&this.hideBody(i))continue;let r=this._bodyMeshes[t];i&&r&&e.syncTransform(i,r),t++}}_updateInertiaMeshes(){for(let e=0;e<this._numInertiaBodies;){let t=this._inertiaBodies[e];if(t&&t.isDisposed&&this.hideInertia(t))continue;let i=this._inertiaMeshes[e];t&&i&&this._updateDebugInertia(t,i),e++}}_updateDebugInertia(e,t){let i=c.uq.Identity(),r=c.uq.Identity(),n=c.uq.Identity();if(e._pluginDataInstances.length){let a=t._thinInstanceDataStorage.matrixData,o=e.transformNode._thinInstanceDataStorage.matrixData;for(let t=0;t<e._pluginDataInstances.length;t++){let s=e.getMassProperties(t);this._getMeshDebugInertiaMatrixToRef(s,i),c.uq.FromArrayToRef(o,16*t,r),i.multiplyToRef(r,n),n.copyToArray(a,16*t)}t.thinInstanceBufferUpdated("matrix")}else{let n=e.getMassProperties();if(this._getMeshDebugInertiaMatrixToRef(n,i),e.transformNode.rotationQuaternion?.toRotationMatrix(r),r.setTranslation(e.transformNode.position),e.transformNode.parent){let t=e.transformNode.parent.computeWorldMatrix(!0);r.multiplyToRef(t,r)}i.multiplyToRef(r,i),i.decomposeToTransformNode(t)}}_updateDebugConstraints(){for(let e=0;e<this._numConstraints;e++){let t=this._constraints[e],i=this._constraintMeshes[e];t&&i&&this._updateDebugConstraint(t,i[0])}}_makeScalingUnitInPlace(e){Math.abs(e.x-1)>T.bH&&(e.x=+Math.sign(e.x)),Math.abs(e.y-1)>T.bH&&(e.y=+Math.sign(e.y)),Math.abs(e.z-1)>T.bH&&(e.z=+Math.sign(e.z))}_updateDebugConstraint(e,t){if(!e._initOptions)return;let{pivotA:i,pivotB:r,axisA:n,axisB:a,perpAxisA:o,perpAxisB:s}=e._initOptions;if(i&&r&&n&&a&&o&&s)for(let e of t.getDescendants(!0)){let t=e.getDescendants(!0)[0],l=e.getDescendants(!0)[1],{parentBody:f,parentBodyIndex:u}=t.metadata,{childBody:d,childBodyIndex:h}=l.metadata,p=this._getTransformFromBodyToRef(f,c.AA.Matrix["0"],u),m=this._getTransformFromBodyToRef(d,c.AA.Matrix["1"],h);p.decomposeToTransformNode(t),this._makeScalingUnitInPlace(t.scaling),m.decomposeToTransformNode(l),this._makeScalingUnitInPlace(l.scaling);let _=t.getDescendants(!0)[0];_.position.copyFrom(i);let g=l.getDescendants(!0)[0];g.position.copyFrom(r),c.PT.FromRotationMatrixToRef(c.uq.FromXYZAxesToRef(n,o,c.Pq.CrossToRef(n,o,c.AA.Vector3["0"]),c.AA.Matrix["0"]),_.rotationQuaternion),c.PT.FromRotationMatrixToRef(c.uq.FromXYZAxesToRef(a,s,c.Pq.CrossToRef(a,s,c.AA.Vector3["1"]),c.AA.Matrix["1"]),g.rotationQuaternion)}}showImpostor(e,t){if(!this._scene)return null;for(let t=0;t<this._numMeshes;t++)if(this._impostors[t]==e)return null;let i=this._getDebugMesh(e,t);return i&&(this._impostors[this._numMeshes]=e,this._meshes[this._numMeshes]=i,0===this._numMeshes&&(this._renderFunction=()=>this._updateDebugMeshes(),this._scene.registerBeforeRender(this._renderFunction)),this._numMeshes++),i}showBody(e){if(!this._scene)return null;for(let t=0;t<this._numBodies;t++)if(this._bodies[t]==e)return null;let t=this._getDebugBodyMesh(e);return t&&(this._bodies[this._numBodies]=e,this._bodyMeshes[this._numBodies]=t,0===this._numBodies&&(this._renderFunction=()=>this._updateDebugMeshes(),this._scene.registerBeforeRender(this._renderFunction)),this._numBodies++),t}showInertia(e){if(!this._scene)return null;for(let t=0;t<this._numInertiaBodies;t++)if(this._inertiaBodies[t]==e)return null;let t=this._getDebugInertiaMesh(e);return t&&(this._inertiaBodies[this._numInertiaBodies]=e,this._inertiaMeshes[this._numInertiaBodies]=t,0===this._numInertiaBodies&&(this._inertiaRenderFunction=()=>this._updateInertiaMeshes(),this._scene.registerBeforeRender(this._inertiaRenderFunction)),this._numInertiaBodies++),t}showConstraint(e){if(!this._scene)return null;for(let t=0;t<this._numConstraints;t++)if(this._constraints[t]==e)return null;let t=this._getDebugConstraintMesh(e);return t&&(this._constraints[this._numConstraints]=e,this._constraintMeshes[this._numConstraints]=t,0===this._numConstraints&&(this._constraintRenderFunction=()=>this._updateDebugConstraints(),this._scene.registerBeforeRender(this._constraintRenderFunction)),this._numConstraints++),t?t[0]:null}hideImpostor(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1,i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numMeshes;r++)if(this._impostors[r]==e){let e=this._meshes[r];if(!e)continue;i.removeMesh(e),e.dispose();let n=this._debugMeshMeshes.indexOf(e);n>-1&&this._debugMeshMeshes.splice(n,1),this._numMeshes--,this._numMeshes>0?(this._meshes[r]=this._meshes[this._numMeshes],this._impostors[r]=this._impostors[this._numMeshes],this._meshes[this._numMeshes]=null,this._impostors[this._numMeshes]=null):(this._meshes[0]=null,this._impostors[0]=null),t=!0;break}t&&0===this._numMeshes&&this._scene.unregisterBeforeRender(this._renderFunction)}hideBody(e){if(!e||!this._scene||!this._utilityLayer)return!1;let t=!1,i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numBodies;r++)if(this._bodies[r]===e){let e=this._bodyMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._numBodies--,this._numBodies>0?(this._bodyMeshes[r]=this._bodyMeshes[this._numBodies],this._bodies[r]=this._bodies[this._numBodies],this._bodyMeshes[this._numBodies]=null,this._bodies[this._numBodies]=null):(this._bodyMeshes[0]=null,this._bodies[0]=null),t=!0;break}return t&&0===this._numBodies&&this._scene.unregisterBeforeRender(this._renderFunction),t}hideInertia(e){if(!e||!this._scene||!this._utilityLayer)return!1;let t=!1,i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numInertiaBodies;r++)if(this._inertiaBodies[r]===e){let e=this._inertiaMeshes[r];if(!e)continue;i.removeMesh(e),e.dispose(),this._inertiaBodies.splice(r,1),this._inertiaMeshes.splice(r,1),this._numInertiaBodies--,t=!0;break}return t&&0===this._numInertiaBodies&&this._scene.unregisterBeforeRender(this._inertiaRenderFunction),t}hideConstraint(e){if(!e||!this._scene||!this._utilityLayer)return;let t=!1,i=this._utilityLayer.utilityLayerScene;for(let r=0;r<this._numConstraints;r++)if(this._constraints[r]===e){let e=this._constraintMeshes[r];if(!e)continue;for(let t of e)i.removeMesh(t),t.dispose();this._constraints.splice(r,1),this._constraintMeshes.splice(r,1),this._numConstraints--,this._numConstraints>0?(this._constraints[r]=this._constraints[this._numConstraints],this._constraintMeshes[r]=this._constraintMeshes[this._numConstraints],this._constraints[this._numConstraints]=null,this._constraintMeshes[this._numConstraints]=null):(this._constraints[0]=null,this._constraintMeshes[0]=null),t=!0;break}t&&0===this._numConstraints&&this._scene.unregisterBeforeRender(this._constraintRenderFunction)}_getDebugMaterial(e){return this._debugMaterial||(this._debugMaterial=new d.F("",e),this._debugMaterial.wireframe=!0,this._debugMaterial.emissiveColor=f.v9.White(),this._debugMaterial.disableLighting=!0),this._debugMaterial}_getDebugInertiaMaterial(e){return this._debugInertiaMaterial||(this._debugInertiaMaterial=new d.F("",e),this._debugInertiaMaterial.disableLighting=!0,this._debugInertiaMaterial.alpha=0),this._debugInertiaMaterial}_getDebugAxisColoredMaterial(e,t){let i=new d.F("",t);return i.emissiveColor=0==e?f.v9.Red():1==e?f.v9.Green():f.v9.Blue(),i.disableLighting=!0,i}_getDebugBoxMesh(e){return this._debugBoxMesh||(this._debugBoxMesh=(0,s.an)("physicsBodyBoxViewMesh",{size:1},e),this._debugBoxMesh.rotationQuaternion=c.PT.Identity(),this._debugBoxMesh.material=this._getDebugMaterial(e),this._debugBoxMesh.setEnabled(!1)),this._debugBoxMesh.createInstance("physicsBodyBoxViewInstance")}_getDebugSphereMesh(e){return this._debugSphereMesh||(this._debugSphereMesh=(0,l._6)("physicsBodySphereViewMesh",{diameter:1},e),this._debugSphereMesh.rotationQuaternion=c.PT.Identity(),this._debugSphereMesh.material=this._getDebugMaterial(e),this._debugSphereMesh.setEnabled(!1)),this._debugSphereMesh.createInstance("physicsBodySphereViewInstance")}_getDebugCapsuleMesh(e){return this._debugCapsuleMesh||(this._debugCapsuleMesh=(0,_._S)("physicsBodyCapsuleViewMesh",{height:1},e),this._debugCapsuleMesh.rotationQuaternion=c.PT.Identity(),this._debugCapsuleMesh.material=this._getDebugMaterial(e),this._debugCapsuleMesh.setEnabled(!1)),this._debugCapsuleMesh.createInstance("physicsBodyCapsuleViewInstance")}_getDebugCylinderMesh(e){return this._debugCylinderMesh||(this._debugCylinderMesh=(0,m.zk)("physicsBodyCylinderViewMesh",{diameterTop:1,diameterBottom:1,height:1},e),this._debugCylinderMesh.rotationQuaternion=c.PT.Identity(),this._debugCylinderMesh.material=this._getDebugMaterial(e),this._debugCylinderMesh.setEnabled(!1)),this._debugCylinderMesh.createInstance("physicsBodyCylinderViewInstance")}_getDebugMeshMesh(e,t){let i=new o.e(e.name,t,null,e);return i.setParent(e),i.position=c.Pq.Zero(),i.material=this._getDebugMaterial(t),this._debugMeshMeshes.push(i),i}_getDebugMesh(e,t){if(!this._utilityLayer||t&&t.parent&&t.parent.physicsImpostor)return null;let i=null,r=this._utilityLayer.utilityLayerScene;if(!e.physicsBody)return g.V.Warn("Unable to get physicsBody of impostor. It might be initialized later by its parent's impostor."),null;switch(e.type){case h.j.BoxImpostor:i=this._getDebugBoxMesh(r),e.getBoxSizeToRef(i.scaling);break;case h.j.SphereImpostor:{i=this._getDebugSphereMesh(r);let t=e.getRadius();i.scaling.x=2*t,i.scaling.y=2*t,i.scaling.z=2*t;break}case h.j.CapsuleImpostor:{i=this._getDebugCapsuleMesh(r);let t=e.object.getBoundingInfo();i.scaling.x=(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*2*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*2*e.object.scaling.z;break}case h.j.MeshImpostor:t&&(i=this._getDebugMeshMesh(t,r));break;case h.j.NoImpostor:if(t){for(let e of t.getChildMeshes().filter(e=>+!!e.physicsImpostor))if(e.physicsImpostor&&"Mesh"===e.getClassName()){let t=e.getBoundingInfo(),n=t.boundingBox.minimum,a=t.boundingBox.maximum;switch(e.physicsImpostor.type){case h.j.BoxImpostor:(i=this._getDebugBoxMesh(r)).position.copyFrom(n),i.position.addInPlace(a),i.position.scaleInPlace(.5);break;case h.j.SphereImpostor:i=this._getDebugSphereMesh(r);break;case h.j.CylinderImpostor:i=this._getDebugCylinderMesh(r);break;default:i=null}i&&(i.scaling.x=a.x-n.x,i.scaling.y=a.y-n.y,i.scaling.z=a.z-n.z,i.parent=e)}}else g.V.Warn("No target mesh parameter provided for NoImpostor. Skipping.");i=null;break;case h.j.CylinderImpostor:{i=this._getDebugCylinderMesh(r);let t=e.object.getBoundingInfo();i.scaling.x=(t.boundingBox.maximum.x-t.boundingBox.minimum.x)*e.object.scaling.x,i.scaling.y=(t.boundingBox.maximum.y-t.boundingBox.minimum.y)*e.object.scaling.y,i.scaling.z=(t.boundingBox.maximum.z-t.boundingBox.minimum.z)*e.object.scaling.z}}return i}_getDebugBodyMesh(e){if(!this._utilityLayer)return null;let t=this._utilityLayer.utilityLayerScene,i=new o.e("custom",t),r=new v.P,n=e.getGeometry();if(r.positions=n.positions,r.indices=n.indices,r.applyToMesh(i),e._pluginDataInstances){let t=new Float32Array(16*e._pluginDataInstances.length);i.thinInstanceSetBuffer("matrix",t,16,!1)}return i.material=this._getDebugMaterial(t),i}_getMeshDebugInertiaMatrixToRef(e,t){let i=e.inertiaOrientation??c.PT.Identity(),r=e.inertia??c.Pq.Zero(),n=e.centerOfMass??c.Pq.Zero(),a=(r.x-r.y+r.z)*6,o=Math.sqrt(Math.max(a,0)),s=Math.sqrt(Math.max(12*r.x-a,0)),l=Math.sqrt(Math.max(12*r.z-a,0)),f=c.AA.Vector3["0"];f.set(l,o,s);let u=c.uq.ScalingToRef(f.x,f.y,f.z,c.AA.Matrix["0"]),d=i.toRotationMatrix(c.AA.Matrix["1"]),h=c.uq.TranslationToRef(n.x,n.y,n.z,c.AA.Matrix["2"]);return u.multiplyToRef(d,t),t.multiplyToRef(h,t),t}_getDebugInertiaMesh(e){if(!this._utilityLayer)return null;let t=this._utilityLayer.utilityLayerScene,i=S.P.CreateBox("custom",{size:1},t),r=c.uq.Identity();if(e._pluginDataInstances.length){let t=new Float32Array(16*e._pluginDataInstances.length);for(let i=0;i<e._pluginDataInstances.length;++i){let n=e.getMassProperties(i);this._getMeshDebugInertiaMatrixToRef(n,r),r.copyToArray(t,16*i)}i.thinInstanceSetBuffer("matrix",t,16,!1)}else{let t=e.getMassProperties();this._getMeshDebugInertiaMatrixToRef(t,r),r.decomposeToTransformNode(i)}return i.enableEdgesRendering(),i.edgesWidth=2,i.edgesColor=new f.ov(1,0,1,1),i.material=this._getDebugInertiaMaterial(t),i}_getTransformFromBodyToRef(e,t,i){let r=e.transformNode;return i&&i>=0?c.uq.FromArrayToRef(r._thinInstanceDataStorage.matrixData,i,t):t.copyFrom(r.getWorldMatrix())}_createAngularConstraintMesh(e,t,i,r,n){let a=(t-e)/(2*Math.PI),o=S.P.CreateCylinder("ConstraintCylinder",{height:1e-4,diameter:3*this._constraintAngularSize,arc:a},n);o.material=this._getDebugAxisColoredMaterial(i,n),o.parent=r;let s=r.absoluteScaling;switch(i){case 0:o.rotation.z=.5*Math.PI,o.rotation.x=-e+.5*Math.PI,o.scaling.x=1/s.x,o.scaling.y=1/s.z,o.scaling.z=1/s.y;break;case 1:o.rotation.y=1.5*Math.PI+e,o.scaling.x=1/s.z,o.scaling.y=1/s.y,o.scaling.z=1/s.x;break;case 2:o.rotation.x=.5*Math.PI,o.scaling.x=1/s.x,o.scaling.y=1/s.z,o.scaling.z=1/s.y}return o}_createCage(e,t){let i=S.P.CreateBox("cage",{size:1},t);i.setPivotPoint(new c.Pq(-.5,-.5,-.5));let r=new d.F("cage_material",t);return r.alpha=0,i.material=r,i.enableEdgesRendering(),i.edgesWidth=4,i.edgesColor=new f.ov(1,1,1,1),i.parent=e,i}_getDebugConstraintMesh(e){if(!this._utilityLayer)return null;let t=this._utilityLayer.utilityLayerScene;if(!e._initOptions)return null;let{pivotA:i,pivotB:n,axisA:a,axisB:s,perpAxisA:l,perpAxisB:f}=e._initOptions;if(!i||!n||!a||!s||!l||!f)return null;let u=new o.e("parentingDebugConstraint",t),d=e.getBodiesUsingConstraint(),h=[];for(let o of(h.push(u),d)){let d=new E.V("parentOfPair",t);d.parent=u;let{parentBody:p,parentBodyIndex:m,childBody:_,childBodyIndex:g}=o,v=this._getTransformFromBodyToRef(p,c.AA.Matrix["0"],m),S=this._getTransformFromBodyToRef(_,c.AA.Matrix["1"],g),A=new E.V("parentCoordSystem",t);A.parent=d,A.metadata={parentBody:p,parentBodyIndex:m},v.decomposeToTransformNode(A);let x=new E.V("childCoordSystem",t);x.parent=d,x.metadata={childBody:_,childBodyIndex:g},S.decomposeToTransformNode(x);let I=c.PT.FromRotationMatrix(c.uq.FromXYZAxesToRef(a,l,a.cross(l),c.AA.Matrix["0"])),R=c.PT.FromRotationMatrix(c.uq.FromXYZAxesToRef(s,f,s.cross(f),c.AA.Matrix["0"])),C=new E.V("constraint_parent",t);C.position.copyFrom(i),C.rotationQuaternion=I,C.parent=A;let b=new E.V("constraint_child",t);b.parent=x,b.position.copyFrom(n),b.rotationQuaternion=R;let y=new r.u(t,this._constraintAxesSize);y.xAxis.parent=C,y.yAxis.parent=C,y.zAxis.parent=C;let L=new r.u(t,this._constraintAxesSize);L.xAxis.parent=b,L.yAxis.parent=b,L.zAxis.parent=b;let M=this._physicsEnginePlugin,P=[3,4,5],N=[P,[0,1,2]],D=[0,0];for(let t=0;t<2;t++)for(let i=0;i<3;i++){let r=N[t][i];2==M.getAxisMode(e,r)&&D[t]++}if(3!=D[1]){let i=this._createCage(C,t),r=c.AA.Vector3["0"],n=c.AA.Vector3["1"],a=[!1,!1,!1];a[0]=1==M.getAxisMode(e,0),a[1]=1==M.getAxisMode(e,1),a[2]=1==M.getAxisMode(e,2),r.x=a[0]?M.getAxisMinLimit(e,0):0,n.x=a[0]?M.getAxisMaxLimit(e,0):0,r.y=a[1]?M.getAxisMinLimit(e,1):0,n.y=a[1]?M.getAxisMaxLimit(e,1):0,r.z=a[2]?M.getAxisMinLimit(e,2):0,n.z=a[2]?M.getAxisMaxLimit(e,2):0,i.position.x=r.x+.5,i.position.y=r.y+.5,i.position.z=r.z+.5,i.scaling.x=n.x-r.x+T.bH,i.scaling.y=n.y-r.y+T.bH,i.scaling.z=n.z-r.z+T.bH,h.push(i)}if(3!=D[0])for(let i=0;i<3;i++){let r=P[i],n=M.getAxisMode(e,r),a=0,o=2*Math.PI;if(1==n&&(a=M.getAxisMinLimit(e,r),o=M.getAxisMaxLimit(e,r)),2!=n&&e.options.pivotB){let r=this._createAngularConstraintMesh(a,o,i,_.transformNode,t);r.position.copyFrom(e.options.pivotB),h.push(r)}}}return h}dispose(){for(let e=this._numMeshes-1;e>=0;e--)this.hideImpostor(this._impostors[0]);for(let e=this._numBodies-1;e>=0;e--)this.hideBody(this._bodies[0]);for(let e=this._numInertiaBodies-1;e>=0;e--)this.hideInertia(this._inertiaBodies[0]);this._debugBoxMesh&&this._debugBoxMesh.dispose(),this._debugSphereMesh&&this._debugSphereMesh.dispose(),this._debugCylinderMesh&&this._debugCylinderMesh.dispose(),this._debugMaterial&&this._debugMaterial.dispose(),this._impostors.length=0,this._scene=null,this._physicsEnginePlugin=null,this._ownUtilityLayer&&this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null)}}var x=i(77501),I=i(37600),R=i(16329)},2213:function(){},19050:function(e,t,i){var r=i(54925),n=i(57480),a=i(91083),o=i(10793),s=i(39393),l=i(42779),c=i(67207);s.$.prototype._partialLoadFile=function(e,t,i,r,n=null){this._loadFile(e,e=>{i[t]=e,i._internalCount++,6===i._internalCount&&r(i)},void 0,void 0,!0,(e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)})},s.$.prototype._cascadeLoadFiles=function(e,t,i,r=null){let n=[];n._internalCount=0;for(let e=0;e<6;e++)this._partialLoadFile(i[e],e,n,t,r)},s.$.prototype._cascadeLoadImgs=function(e,t,i,r,n=null,a){let o=[];o._internalCount=0;for(let s=0;s<6;s++)this._partialLoadImg(r[s],s,o,e,t,i,n,a)},s.$.prototype._partialLoadImg=function(e,t,i,r,n,s,l=null,c){let f=(0,o.z)();(0,a.W$)(e,e=>{i[t]=e,i._internalCount++,r&&r.removePendingData(f),6===i._internalCount&&s&&s(n,i)},(e,t)=>{r&&r.removePendingData(f),l&&l(e,t)},r?r.offlineProvider:null,c),r&&r.addPendingData(f)},s.$.prototype.createCubeTextureBase=function(e,t,i,a,o=null,s=null,f,u=null,d=!1,h=0,p=0,m=null,_=null,g=null,v=!1,S=null){let E=m||new r.h(this,7);E.isCube=!0,E.url=e,E.generateMipMaps=!a,E._lodGenerationScale=h,E._lodGenerationOffset=p,E._useSRGBBuffer=!!v&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!a),E!==m&&(E.label=e.substring(0,60)),this._doNotHandleContextLost||(E._extension=u,E._files=i,E._buffer=S);let T=e;this._transformTextureUrl&&!m&&(e=this._transformTextureUrl(e));let A=u??(0,c.r)(e),x=(0,l.gT)(A),I=(e,t)=>{E.dispose(),s?s(e,t):e&&n.V.Warn(e)},R=(r,s)=>{e===T?r&&I(r.status+" "+r.statusText,s):(n.V.Warn(`Failed to load ${e}, falling back to the ${T}`),this.createCubeTextureBase(T,t,i,!!a,o,I,f,u,d,h,p,E,_,g,v,S))};if(x)x.then(r=>{let n=e=>{_&&_(E,e),r.loadCubeData(e,E,d,o,(e,t)=>{I(e,t)})};S?n(S):i&&6===i.length?r.supportCascades?this._cascadeLoadFiles(t,e=>n(e.map(e=>new Uint8Array(e))),i,I):I("Textures type does not support cascades."):this._loadFile(e,e=>n(new Uint8Array(e)),void 0,t?t.offlineProvider||null:void 0,!0,R)});else{if(!i||0===i.length)throw Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(t,E,(e,t)=>{g&&g(e,t)},i,I)}return this._internalTexturesCache.push(E),E}},31722:function(e,t,i){i.d(t,{W:()=>a});var r=i(96700),n=i(39393);class a{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=r.u.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=r.u.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}n.$.prototype.createQuery=function(){return null},n.$.prototype.deleteQuery=function(e){return this},n.$.prototype.isQueryResultAvailable=function(e){return!1},n.$.prototype.getQueryResult=function(e){return 0},n.$.prototype.beginOcclusionQuery=function(e,t){return!1},n.$.prototype.endOcclusionQuery=function(e){return this},Object.defineProperty(r.u.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e},enumerable:!1,configurable:!0}),Object.defineProperty(r.u.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new a),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(r.u.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.u.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.u.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.u.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.u.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e},enumerable:!0,configurable:!0}),r.u.prototype._checkOcclusionQuery=function(){let e=this._occlusionDataStorage;if(e.occlusionType===r.u.OCCLUSION_TYPE_NONE)return e.isOccluded=!1,!1;let t=this.getEngine();if(!t.getCaps().supportOcclusionQuery||!t.isQueryResultAvailable)return e.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&null!==this._occlusionQuery&&void 0!==this._occlusionQuery)if(t.isQueryResultAvailable(this._occlusionQuery)){let i=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=!(i>0)}else{if(e.occlusionInternalRetryCounter++,-1===e.occlusionRetryCount||!(e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==r.u.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==r.u.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded}let i=this.getScene();if(i.getBoundingBoxRenderer){let r=i.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),this._occlusionQuery&&t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(r.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return e.isOccluded}},5497:function(e,t,i){var r=i(39393),n=i(81231);r.$.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime||(this._gpuFrameTime=new n.A),this._gpuFrameTime},r.$.prototype.captureGPUFrameTime=function(e){}},73914:function(e,t,i){var r=i(39393);r.$.prototype._debugPushGroup=function(e,t){},r.$.prototype._debugPopGroup=function(e){},r.$.prototype._debugInsertMarker=function(e,t){},r.$.prototype._debugFlushPendingCommands=function(){}},55976:function(e,t,i){var r=i(95686),n=i(32768),a=i(54925);n.ThinEngine.prototype.createDynamicTexture=function(e,t,i,n){let o=new a.h(this,4);return o.baseWidth=e,o.baseHeight=t,i&&(e=this.needPOTTextures?(0,r.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,r.R)(t,this._caps.maxTextureSize):t),o.width=e,o.height=t,o.isReady=!1,o.generateMipMaps=i,o.samplingMode=n,this.updateTextureSamplingMode(n,o),this._internalTexturesCache.push(o),o},n.ThinEngine.prototype.updateDynamicTexture=function(e,t,i,r=!1,n,a=!1,o=!1){if(!e)return;let s=this._gl,l=s.TEXTURE_2D,c=this._bindTextureDirectly(l,e,!0,a);this._unpackFlipY(void 0===i?e.invertY:i),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);let f=this._getWebGLTextureType(e.type),u=this._getInternalFormat(n||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,u);s.texImage2D(l,0,d,u,f,t),e.generateMipMaps&&s.generateMipmap(l),c||this._bindTextureDirectly(l,null),r&&s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),n&&(e.format=n),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0}},52771:function(e,t,i){var r=i(54925),n=i(57480),a=i(32768);a.ThinEngine.prototype.restoreSingleAttachment=function(){let e=this._gl;this.bindAttachments([e.BACK])},a.ThinEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){let e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},a.ThinEngine.prototype.buildTextureLayout=function(e,t=!1){let i=this._gl,r=[];if(t)r.push(i.BACK);else for(let t=0;t<e.length;t++)e[t]?r.push(i["COLOR_ATTACHMENT"+t]):r.push(i.NONE);return r},a.ThinEngine.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},a.ThinEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null,e.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(e),t||this.generateMipMapsMultiFramebuffer(e),i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},a.ThinEngine.prototype.createMultipleRenderTarget=function(e,t,i=!0){let a,o=!1,s=!0,l=!1,c=!1,f=1,u=1,d=[],h=[],p=[],m=[],_=[],g=[],v=[],S=[],E=[],T=!1,A=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(o=void 0!==t.generateMipMaps&&t.generateMipMaps,s=void 0===t.generateDepthBuffer||t.generateDepthBuffer,l=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,c=void 0!==t.generateDepthTexture&&t.generateDepthTexture,f=t.textureCount??1,u=t.samples??u,d=t.types||d,h=t.samplingModes||h,p=t.useSRGBBuffers||p,m=t.formats||m,_=t.targetTypes||_,g=t.faceIndex||g,v=t.layerIndex||v,S=t.layerCounts||S,E=t.labels||E,T=t.dontCreateTextures??!1,this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(a=t.depthTextureFormat)),void 0===a&&(a=l?13:14);let x=this._gl,I=this._currentFramebuffer,R=x.createFramebuffer();this._bindUnboundFramebuffer(R);let C=e.width??e,b=e.height??e,y=[],L=[],M=this.webGLVersion>1&&(13===a||17===a||18===a);A.label=t?.label??"MultiRenderTargetWrapper",A._framebuffer=R,A._generateDepthBuffer=c||s,A._generateStencilBuffer=c?M:l,A._depthStencilBuffer=this._setupFramebufferDepthAttachments(A._generateStencilBuffer,A._generateDepthBuffer,C,b,1,a),A._attachments=L;for(let e=0;e<f;e++){let t=h[e]||3,i=d[e]||0,a=p[e]||!1,s=m[e]||5,l=_[e]||3553,c=S[e]??1;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);let f=this._getSamplingParameters(t,o);1!==i||this._caps.textureFloat||(i=0,n.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),a=a&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);let u=this.webGLVersion>1,g=x[u?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(L.push(g),-1===l||T)continue;let v=new r.h(this,6);y[e]=v,x.activeTexture(x["TEXTURE"+e]),x.bindTexture(l,v._hardwareTexture.underlyingResource),x.texParameteri(l,x.TEXTURE_MAG_FILTER,f.mag),x.texParameteri(l,x.TEXTURE_MIN_FILTER,f.min),x.texParameteri(l,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(l,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE);let I=this._getRGBABufferInternalSizedFormat(i,s,a),R=this._getInternalFormat(s),M=this._getWebGLTextureType(i);if(u&&(35866===l||32879===l))35866===l?v.is2DArray=!0:v.is3D=!0,v.baseDepth=v.depth=c,x.texImage3D(l,0,I,C,b,c,0,R,M,null);else if(34067===l){for(let e=0;e<6;e++)x.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,I,C,b,0,R,M,null);v.isCube=!0}else x.texImage2D(x.TEXTURE_2D,0,I,C,b,0,R,M,null);o&&x.generateMipmap(l),this._bindTextureDirectly(l,null),v.baseWidth=C,v.baseHeight=b,v.width=C,v.height=b,v.isReady=!0,v.samples=1,v.generateMipMaps=o,v.samplingMode=t,v.type=i,v._useSRGBBuffer=a,v.format=s,v.label=E[e]??A.label+"-Texture"+e,this._internalTexturesCache.push(v)}if(c&&this._caps.depthTextureExtension&&!T){let e=new r.h(this,14),t=5,i=x.DEPTH_COMPONENT16,n=x.DEPTH_COMPONENT,s=x.UNSIGNED_SHORT,l=x.DEPTH_ATTACHMENT;this.webGLVersion<2?i=x.DEPTH_COMPONENT:14===a?(t=1,s=x.FLOAT,i=x.DEPTH_COMPONENT32F):18===a?(t=0,s=x.FLOAT_32_UNSIGNED_INT_24_8_REV,i=x.DEPTH32F_STENCIL8,n=x.DEPTH_STENCIL,l=x.DEPTH_STENCIL_ATTACHMENT):16===a?(t=0,s=x.UNSIGNED_INT,i=x.DEPTH_COMPONENT24,l=x.DEPTH_ATTACHMENT):(13===a||17===a)&&(t=12,s=x.UNSIGNED_INT_24_8,i=x.DEPTH24_STENCIL8,n=x.DEPTH_STENCIL,l=x.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(x.TEXTURE_2D,e,!0),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,i,C,b,0,n,s,null),x.framebufferTexture2D(x.FRAMEBUFFER,l,x.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(x.TEXTURE_2D,null),A._depthStencilTexture=e,A._depthStencilTextureWithStencil=M,e.baseWidth=C,e.baseHeight=b,e.width=C,e.height=b,e.isReady=!0,e.samples=1,e.generateMipMaps=o,e.samplingMode=1,e.format=a,e.type=t,e.label=A.label+"-DepthStencil",y[f]=e,this._internalTexturesCache.push(e)}if(A.setTextures(y),i&&x.drawBuffers(L),this._bindUnboundFramebuffer(I),A.setLayerAndFaceIndices(v,g),this.resetTextureCache(),T){if(u>1){let e=x.createFramebuffer();if(!e)throw Error("Unable to create multi sampled framebuffer");A._samples=u,A._MSAAFramebuffer=e,f>0&&i&&(this._bindUnboundFramebuffer(e),x.drawBuffers(L),this._bindUnboundFramebuffer(I))}}else this.updateMultipleRenderTargetTextureSampleCount(A,u,i);return A},a.ThinEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;let r=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);let n=e._attachments.length;for(let t=0;t<n;t++){let i=e.textures[t]._hardwareTexture;i?.releaseMSAARenderBuffers()}if(t>1&&"function"==typeof r.renderbufferStorageMultisample){let a=r.createFramebuffer();if(!a)throw Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);let o=[];for(let i=0;i<n;i++){let n=e.textures[i],a=n._hardwareTexture,s=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(n.width,n.height,t,-1,this._getRGBABufferInternalSizedFormat(n.type,n.format,n._useSRGBBuffer),s);if(!l)throw Error("Unable to create multi sampled framebuffer");a.addMSAARenderBuffer(l),n.samples=t,o.push(s)}i&&r.drawBuffers(o)}else this._bindUnboundFramebuffer(e._framebuffer);let a=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,a),this._bindUnboundFramebuffer(null),e._samples=t,t},a.ThinEngine.prototype.generateMipMapsMultiFramebuffer=function(e){let t=this._gl;if(e.isMulti)for(let i=0;i<e._attachments.length;i++){let r=e.textures[i];!r?.generateMipMaps||r?.isCube||r?.is3D||(this._bindTextureDirectly(t.TEXTURE_2D,r,!0),t.generateMipmap(t.TEXTURE_2D),this._bindTextureDirectly(t.TEXTURE_2D,null))}},a.ThinEngine.prototype.resolveMultiFramebuffer=function(e){let t=this._gl;if(!e._MSAAFramebuffer||!e.isMulti)return;let i=e.resolveMSAAColors?t.COLOR_BUFFER_BIT:0;i|=e._generateDepthBuffer&&e.resolveMSAADepth?t.DEPTH_BUFFER_BIT:0,i|=e._generateStencilBuffer&&e.resolveMSAAStencil?t.STENCIL_BUFFER_BIT:0;let r=e._attachments,n=r.length;t.bindFramebuffer(t.READ_FRAMEBUFFER,e._MSAAFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);for(let a=0;a<n;a++){let o=e.textures[a];for(let e=0;e<n;e++)r[e]=t.NONE;r[a]=t[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],t.readBuffer(r[a]),t.drawBuffers(r),t.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i,t.NEAREST)}for(let e=0;e<n;e++)r[e]=t[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];t.drawBuffers(r),t.bindFramebuffer(this._gl.FRAMEBUFFER,e._MSAAFramebuffer)}},72590:function(e,t,i){var r=i(45119),n=i(10363),a=i(38241),o=i(54925),s=i(97782),l=i(98714),c=i(63604),f=i(47747);function u(e,t,i){let r=new l.D(e,void 0,!0,t,void 0,i);return r.addUniform("viewProjection",16),r.addUniform("viewProjectionR",16),r.addUniform("view",16),r.addUniform("projection",16),r.addUniform("vEyePosition",4),r}n.N.prototype.createMultiviewRenderTargetTexture=function(e,t,i,r){let n=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";let a=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});a._framebuffer=n.createFramebuffer();let s=new o.h(this,0,!0);return s.width=e,s.height=t,s.isMultiview=!0,i||(i=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,i),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.RGBA8,e,t,2)),a._colorTextureArray=i,r||(r=n.createTexture(),n.bindTexture(n.TEXTURE_2D_ARRAY,r),n.texStorage3D(n.TEXTURE_2D_ARRAY,1,n.DEPTH24_STENCIL8,e,t,2)),a._depthStencilTextureArray=r,s.isReady=!0,a.setTextures(s),a._depthStencilTexture=s,a},n.N.prototype.bindMultiviewFramebuffer=function(e){let t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"},n.N.prototype.bindSpaceWarpFramebuffer=function(e){let t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw Error("Invalid Space Warp framebuffer")},r.i.prototype._useMultiviewToSingleView=!1,r.i.prototype._multiviewTexture=null,r.i.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=e||this._multiviewTexture.getRenderHeight()!=t)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new c.c(this.getScene(),{width:e,height:t})):this._multiviewTexture=new c.c(this.getScene(),{width:e,height:t})};let d=a.Z.prototype.createSceneUniformBuffer;a.Z.prototype._transformMatrixR=s.uq.Zero(),a.Z.prototype._multiviewSceneUbo=null,a.Z.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=u(this.getEngine(),"scene_multiview")},a.Z.prototype.createSceneUniformBuffer=function(e,t){return this._multiviewSceneUbo?u(this.getEngine(),e,t):d.bind(this)(e,t)},a.Z.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,s.AA.Matrix["0"]),f.P.GetRightPlaneToRef(s.AA.Matrix["0"],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},a.Z.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){let i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}}},65250:function(e,t,i){var r=i(32768),n=i(96700),a=i(79742);i(5497),i(31722),r.ThinEngine.prototype.createQuery=function(){let e=this._gl.createQuery();if(!e)throw Error("Unable to create Occlusion Query");return e},r.ThinEngine.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},r.ThinEngine.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},r.ThinEngine.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},r.ThinEngine.prototype.beginOcclusionQuery=function(e,t){let i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},r.ThinEngine.prototype.endOcclusionQuery=function(e){let t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},r.ThinEngine.prototype._createTimeQuery=function(){let e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},r.ThinEngine.prototype._deleteTimeQuery=function(e){let t=this.getCaps().timerQuery;t.deleteQueryEXT?t.deleteQueryEXT(e):this.deleteQuery(e)},r.ThinEngine.prototype._getTimeQueryResult=function(e){let t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},r.ThinEngine.prototype._getTimeQueryAvailability=function(e){let t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},r.ThinEngine.prototype.startTimeQuery=function(){let e=this.getCaps(),t=e.timerQuery;if(!t)return null;let i=new a.e;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),i._startTimeQuery&&t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),i._timeElapsedQuery&&(t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery)),this._currentNonTimestampToken=i}return i},r.ThinEngine.prototype.endTimeQuery=function(e){let t=this.getCaps(),i=t.timerQuery;if(!i||!e)return -1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return -1;!e._endTimeQuery&&(e._endTimeQuery=this._createTimeQuery(),e._endTimeQuery&&i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return -1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}let r=this._gl.getParameter(i.GPU_DISJOINT_EXT),n=!1;if(e._endTimeQuery?n=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(n=this._getTimeQueryAvailability(e._timeElapsedQuery)),n&&!r){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return -1;let t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return -1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return -1},r.ThinEngine.prototype.captureGPUFrameTime=function(e){if(e!==this._captureGPUFrameTime)if(this._captureGPUFrameTime=e,e){let e=this.getGPUFrameTimeCounter();this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;let t=this.endTimeQuery(this._gpuFrameTimeToken);t>-1&&(this._gpuFrameTimeToken=null,e.fetchNewFrame(),e.addCount(t,!0))})}else this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null},r.ThinEngine.prototype._getGlAlgorithmType=function(e){return e===n.u.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED}},80140:function(e,t,i){var r=i(10363);function n(e){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(t=>e&&(e===t||e.match(RegExp("\\b"+t+"\\b","g")))))return e;let t=e.lastIndexOf("."),i=e.lastIndexOf("?"),r=i>-1?e.substring(i,e.length):"";return(t>-1?e.substring(0,t):e)+this._textureFormatInUse+r}Object.defineProperty(r.N.prototype,"texturesSupported",{get:function(){let e=[];return this._caps.astc&&e.push("-astc.ktx"),this._caps.s3tc&&e.push("-dxt.ktx"),this._caps.pvrtc&&e.push("-pvrtc.ktx"),this._caps.etc2&&e.push("-etc2.ktx"),this._caps.etc1&&e.push("-etc1.ktx"),e},enumerable:!0,configurable:!0}),Object.defineProperty(r.N.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),r.N.prototype.setCompressedTextureExclusions=function(e){this._excludedCompressedTextures=e},r.N.prototype.setTextureFormatToUse=function(e){let t=this.texturesSupported;for(let i=0,r=t.length;i<r;i++)for(let r=0,a=e.length;r<a;r++)if(t[i]===e[r].toLowerCase())return this._transformTextureUrl=n.bind(this),this._textureFormatInUse=t[i];return this._textureFormatInUse="",this._transformTextureUrl=null,null}},40917:function(e,t,i){i.d(t,{P:()=>n});var r=i(10363),n=!0;r.N.prototype.createTransformFeedback=function(){let e=this._gl.createTransformFeedback();if(!e)throw Error("Unable to create Transform Feedback");return e},r.N.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},r.N.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},r.N.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},r.N.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},r.N.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},r.N.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)},r.N.prototype.readTransformFeedbackBuffer=function(e){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e)}},81842:function(e,t,i){i(32768).ThinEngine.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;let r=this._getInternalFormat(e.format),n=this._getRGBABufferInternalSizedFormat(0,e.format),a=this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0);this._unpackFlipY(!i);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=this.createCanvas(e.width,e.height);let t=e._workingCanvas.getContext("2d");if(!t)throw Error("Unable to get 2d context");e._workingContext=t,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.clearRect(0,0,e.width,e.height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,n,r,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),a||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}}},72007:function(e,t,i){i.d(t,{N:()=>r});class r{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}},43973:function(e,t,i){i.d(t,{Fd:()=>d,IC:()=>l,U2:()=>o,UJ:()=>h,Xw:()=>s,bW:()=>c,mk:()=>a,t6:()=>f,uc:()=>u});var r=i(2824),n=i(44043);function a(e,t){switch(e){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break;case 5:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break;case 6:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break;case 7:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break;case 12:if(0===t)return _native.Engine.TEXTURE_FORMAT_BGRA8}throw new r.bu(`Unsupported texture format or type: format ${e}, type ${t}.`,r.tG.UnsupportedTextureError)}function o(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw Error(`Unsupported sampling mode: ${e}.`)}}function s(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw Error("Unexpected wrap mode: "+e+".")}}function l(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw Error(`Unsupported stencil func mode: ${e}.`)}}function c(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw Error(`Unsupported stencil OpFail mode: ${e}.`)}}function f(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw Error(`Unsupported stencil depthFail mode: ${e}.`)}}function u(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw Error(`Unsupported stencil opPass mode: ${e}.`)}}function d(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw Error(`Unsupported alpha mode: ${e}.`)}}function h(e){switch(e){case n.R.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case n.R.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case n.R.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case n.R.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case n.R.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw Error(`Unsupported attribute type: ${e}.`)}}},42789:function(e,t,i){i.d(t,{f:()=>r});class r{get isReady(){if(this.compilationError){let e=this.compilationError.message;throw Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,n,a,o,s){let l,c=this._engine;if(c.supportsUniformBuffers)for(let i in t)e.bindUniformBlock(i,t[i]);for(this._engine.getUniforms(this,i).forEach((e,t)=>{r[i[t]]=e}),this._uniforms=r,l=0;l<n.length;l++)null==e.getUniform(n[l])&&(n.splice(l,1),l--);n.forEach((e,t)=>{a[e]=t}),s.push(...c.getAttributes(this,o))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){let i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(e,t,i,r){let n=this._valueCache[e];if(!n)return n=[t,i,r],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),a}_cacheFloat4(e,t,i,r,n){let a=this._valueCache[e];if(!a)return a=[t,i,r,n],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==r&&(a[2]=r,o=!0),a[3]!==n&&(a[3]=n,o=!0),o}setInt(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&!this._engine.setInt2(this._uniforms[e],t,i)&&(this._valueCache[e]=null)}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&!this._engine.setInt3(this._uniforms[e],t,i,r)&&(this._valueCache[e]=null)}setInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&!this._engine.setInt4(this._uniforms[e],t,i,r,n)&&(this._valueCache[e]=null)}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&!this._engine.setUInt2(this._uniforms[e],t,i)&&(this._valueCache[e]=null)}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&!this._engine.setUInt3(this._uniforms[e],t,i,r)&&(this._valueCache[e]=null)}setUInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&!this._engine.setUInt4(this._uniforms[e],t,i,r,n)&&(this._valueCache[e]=null)}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&!this._engine.setMatrices(this._uniforms[e],t.asArray())&&(this._valueCache[e]=null)}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setInt(this._uniforms[e],+!!t)&&(this._valueCache[e]=+!!t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&!this._engine.setFloat2(this._uniforms[e],t.x,t.y)&&(this._valueCache[e]=null)}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&!this._engine.setFloat2(this._uniforms[e],t,i)&&(this._valueCache[e]=null)}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&!this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)&&(this._valueCache[e]=null)}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&!this._engine.setFloat3(this._uniforms[e],t,i,r)&&(this._valueCache[e]=null)}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&!this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)&&(this._valueCache[e]=null)}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&!this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)&&(this._valueCache[e]=null)}setFloat4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&!this._engine.setFloat4(this._uniforms[e],t,i,r,n)&&(this._valueCache[e]=null)}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&!this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)&&(this._valueCache[e]=null)}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&!this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)&&(this._valueCache[e]=null)}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&!this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)&&(this._valueCache[e]=null)}}},10064:function(e,t,i){i.d(t,{C:()=>n});var r=i(31581);class n extends r.v{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}},46893:function(e,t,i){i.d(t,{l:()=>r});class r{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}}},48278:function(e,t,i){i.d(t,{N:()=>a});var r=i(29919);let n=/(flat\s)?\s*varying\s*.*/;class a{constructor(){this.shaderLanguage=0}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");let t=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==t){let i=t[1],r=t[2],n=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[r];if(void 0!==n){let a=`_int_${r}_`;e=e.replace(t[0],`in ${n<0?-1===n?"int":"ivec"+-n:1===n?"uint":"uvec"+n} ${a}; ${i} ${r};`),this._nativeProcessingContext.injectInVertexMain+=`${r} = ${i}(${a});
`,this._nativeProcessingContext.remappedAttributeNames[r]=a}else e=e.replace(t[0],`in ${i} ${r};`)}return e}varyingCheck(e,t){return n.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){let n=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){let t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(n||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(t.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0&&(e="invariant gl_Position;\n"+e),this._nativeProcessingContext?.injectInVertexMain&&(e=(0,r.bI)(e,"void main",this._nativeProcessingContext.injectInVertexMain)),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}},32761:function(e,t,i){var r=i(39393);i(55790);var n=i(38212);n.M.prototype.setAlphaMode=function(e,t=!1,i=0){let r=this._alphaState._alphaBlend[i];if(this._alphaMode[i]===e&&(0===e&&!r||0!==e&&r)){if(!t){let t=0===e;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}return}let n=0===e;this._alphaState.setAlphaBlend(!n,i),this._alphaState.setAlphaMode(e,i),t||(this.setDepthWrite(n),this._cacheRenderPipeline.setDepthWriteEnabled(n)),this._alphaMode[i]=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)},n.M.prototype.setAlphaEquation=function(e,t=0){r.$.prototype.setAlphaEquation.call(this,e,t),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}},67029:function(e,t,i){var r=i(54925),n=i(35689),a=i(38212);a.M.prototype._createDepthStencilCubeTexture=function(e,t){let i=new r.h(this,t.generateStencil?12:14);i.isCube=!0,i.label=t.label;let a={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t};i.format=a.depthTextureFormat,this._setupDepthStencilTexture(i,e,a.bilinearFiltering,a.comparisonFunction,a.samples),this._textureHelper.createGPUTextureForInternalTexture(i);let o=i._hardwareTexture;return i.type=n.m.GetTextureTypeFromFormat(o.format),this._internalTexturesCache.push(i),i},a.M.prototype.createCubeTexture=function(e,t,i,r,n=null,a=null,o,s=null,l=!1,c=0,f=0,u=null,d,h=!1,p=null){return this.createCubeTextureBase(e,t,i,!!r,n,a,o,s,l,c,f,u,null,(e,t)=>{let i=t[0].width;this._setCubeMapTextureParams(e,!r),e.format=o??-1;let a=this._textureHelper.createGPUTextureForInternalTexture(e,i,i);this._textureHelper.updateCubeTextures(t,a.underlyingResource,i,i,a.format,!1,!1,0,0),r||this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),n&&n()},!!h,p)},a.M.prototype._setCubeMapTextureParams=function(e,t,i){e.samplingMode=t?3:2,e._cachedWrapU=0,e._cachedWrapV=0,i&&(e._maxLodLevel=i)},a.M.prototype.generateMipMapsForCubemap=function(e){e.generateMipMaps&&(e._hardwareTexture?.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e))}},4224:function(e,t,i){var r=i(54925),n=i(57480),a=i(77459);a.$.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){i&&i(),this._endCurrentRenderPass(),e.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(e,!1),t||this.generateMipMapsMultiFramebuffer(e),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},a.$.prototype.createMultipleRenderTarget=function(e,t,i){let a=!1,o=!0,s=!1,l=!1,c=15,f=1,u=1,d=[],h=[],p=[],m=[],_=[],g=[],v=[],S=[],E=[],T=[],A=!1,x=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(a=t.generateMipMaps??!1,o=t.generateDepthBuffer??!0,s=t.generateStencilBuffer??!1,l=t.generateDepthTexture??!1,f=t.textureCount??1,c=t.depthTextureFormat??15,d=t.types||d,h=t.samplingModes||h,p=t.useSRGBBuffers||p,m=t.formats||m,_=t.targetTypes||_,g=t.faceIndex||g,v=t.layerIndex||v,S=t.layerCounts||S,E=t.labels||E,T=t.creationFlags||T,u=t.samples??u,A=t.dontCreateTextures??!1);let I=e.width??e,R=e.height??e,C=[],b=[],y=[];x.label=t?.label??"MultiRenderTargetWrapper",x._generateDepthBuffer=o,x._generateStencilBuffer=s,x._attachments=b,x._defaultAttachments=y;let L=null;(o||s||l)&&!A&&(l||(c=o&&s?13:o?14:19),L=x.createDepthStencilTexture(0,!1,s,1,c,x.label+"-DepthStencil"));let M=void 0!==t&&"object"==typeof t&&t.createMipMaps&&!a;for(let e=0;e<f;e++){let t=h[e]||3,o=d[e]||0,s=m[e]||5,l=(p[e]||!1)&&this._caps.supportSRGBBuffers,c=_[e]||3553,f=S[e]??1,u=T[e];if((1!==o||this._caps.textureFloatLinearFiltering)&&(2!==o||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==o||this._caps.textureFloat||(o=0,n.V.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),b.push(e+1),y.push(i?e+1:+(0===e)),-1===c||A)continue;let g=new r.h(this,6);switch(C[e]=g,c){case 34067:g.isCube=!0;break;case 32879:g.is3D=!0,g.baseDepth=g.depth=f;break;case 35866:g.is2DArray=!0,g.baseDepth=g.depth=f}g.baseWidth=I,g.baseHeight=R,g.width=I,g.height=R,g.isReady=!0,g.samples=1,g.generateMipMaps=a,g.samplingMode=t,g.type=o,g._cachedWrapU=0,g._cachedWrapV=0,g._useSRGBBuffer=l,g.format=s,g.label=E[e]??x.label+"-Texture"+e,this._internalTexturesCache.push(g),M&&(g.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(g,void 0,void 0,void 0,u,!0),M&&(g.generateMipMaps=!1)}return L&&(L.incrementReferences(),C[f]=L,this._internalTexturesCache.push(L)),x.setTextures(C),x.setLayerAndFaceIndices(v,g),A?x._samples=u:this.updateMultipleRenderTargetTextureSampleCount(x,u),x},a.$.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||0===e.textures.length||e.textures[0].samples===t)return t;let i=e.textures.length;if(0===i)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<i;++t){let i=e.textures[t]._hardwareTexture;i?.releaseMSAATexture(e.getBaseArrayLayer(t))}let r=e._depthStencilTexture===e.textures[i-1];for(let r=0;r<i;++r){let i=e.textures[r];this._textureHelper.createMSAATexture(i,t,!1,e.getBaseArrayLayer(r)),i.samples=t}return e._depthStencilTexture&&!r&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,t},a.$.prototype.generateMipMapsMultiFramebuffer=function(e){if(!e.isMulti)return;let t=e._attachments.length;for(let i=0;i<t;i++){let t=e.textures[i];!t.generateMipMaps||t.isCube||t.is3D||this._generateMipmaps(t)}},a.$.prototype.resolveMultiFramebuffer=function(e,t=!0){this.resolveFramebuffer(e,t)},a.$.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},a.$.prototype.buildTextureLayout=function(e,t=!1){let i=[];if(t)i.push(1);else for(let t=0;t<e.length;t++)e[t]?i.push(t+1):i.push(0);return i},a.$.prototype.restoreSingleAttachment=function(){},a.$.prototype.restoreSingleAttachmentForRenderTarget=function(){}},48149:function(e,t,i){var r=i(38212),n=i(74168);i(31722),r.M.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},r.M.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery},r.M.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},r.M.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},r.M.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},r.M.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},r.M.prototype.beginOcclusionQuery=function(e,t){return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery(t)&&(this._currentRenderPass?.beginOcclusionQuery(t),!0):(this._bundleList.addItem(new n.KS(t)),!0)},r.M.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new n.c7),this}},42672:function(e,t,i){var r=i(54925),n=i(57480),a=i(38212);function o(e,t,i,r){let n,a=1;1===r?n=new Float32Array(t*i*4):2===r?(n=new Uint16Array(t*i*4),a=15360):n=7===r?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let r=0;r<t;r++)for(let o=0;o<i;o++){let i=(o*t+r)*3,s=(o*t+r)*4;n[s+0]=e[i+0],n[s+1]=e[i+1],n[s+2]=e[i+2],n[s+3]=a}return n}a.M.prototype.createRawTexture=function(e,t,i,n,a,o,s,l=null,c=0,f=0,u=!1){let d=new r.h(this,3);return d.baseWidth=t,d.baseHeight=i,d.width=t,d.height=i,d.format=n,d.generateMipMaps=a,d.samplingMode=s,d.invertY=o,d._compression=l,d.type=c,d._creationFlags=f,d._useSRGBBuffer=u,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,void 0,f),this.updateRawTexture(d,e,n,o,l,c,u),this._internalTexturesCache.push(d),d},a.M.prototype.updateRawTexture=function(e,t,i,r,n=null,a=0,s=!1){if(e){if(this._doNotHandleContextLost||(e._bufferView=t,e.invertY=r,e._compression=n,e._useSRGBBuffer=s),t){let n=e._hardwareTexture;4===i&&(t=o(t,e.width,e.height,a));let s=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(s,e,e.width,e.height,e.depth,n.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},a.M.prototype.createRawCubeTexture=function(e,t,i,a,o,s,l,c=null){let f=new r.h(this,8);return 1!==a||this._caps.textureFloatLinearFiltering?2!==a||this._caps.textureHalfFloatLinearFiltering?1!==a||this._caps.textureFloatRender?2!==a||this._caps.colorBufferFloat||(o=!1,n.V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(o=!1,n.V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(o=!1,l=1,n.V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(o=!1,l=1,n.V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),f.isCube=!0,f._originalFormat=i,f.format=4===i?5:i,f.type=a,f.generateMipMaps=o,f.width=t,f.height=t,f.samplingMode=l,this._doNotHandleContextLost||(f._bufferViewArray=e),f.invertY=s,f._compression=c,f._cachedWrapU=0,f._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(f),4===i&&(f._hardwareTexture._originalFormatIsRGB=!0),e&&this.updateRawCubeTexture(f,e,i,a,s,c),f.isReady=!0,f},a.M.prototype.updateRawCubeTexture=function(e,t,i,r,n,a=null){e._bufferViewArray=t,e.invertY=n,e._compression=a;let s=e._hardwareTexture,l=s._originalFormatIsRGB,c=[0,2,4,1,3,5],f=[];for(let i=0;i<t.length;++i){let n=t[c[i]];l&&(n=o(n,e.width,e.height,r)),f.push(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}this._textureHelper.updateCubeTextures(f,s.underlyingResource,e.width,e.height,s.format,n,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},a.M.prototype.createRawCubeTextureFromUrl=function(e,t,i,r,n,a,s,l,c=null,f=null,u=3,d=!1){let h=this.createRawCubeTexture(null,i,r,n,!a,d,u,null);t?.addPendingData(h),h.url=e,h.isReady=!1,this._internalTexturesCache.push(h);let p=(e,i)=>{t?.removePendingData(h),f&&e&&f(e.status+" "+e.statusText,i)},m=async e=>{let i=s(e);if(!i)return;let a=i instanceof Promise?await i:i,f=h.width;if(l){let e=4===r,t=l(a),i=h._hardwareTexture,s=[0,1,2,3,4,5];for(let r=0;r<t.length;r++){let a=f>>r,l=[];for(let i=0;i<6;i++){let c=t[r][s[i]];e&&(c=o(c,a,a,n)),l.push(new Uint8Array(c.buffer,c.byteOffset,c.byteLength))}this._textureHelper.updateCubeTextures(l,i.underlyingResource,a,a,i.format,d,!1,0,0)}}else this.updateRawCubeTexture(h,a,r,n,d);h.isReady=!0,t?.removePendingData(h),c&&c()};return this._loadFile(e,e=>{m(e).catch(e=>{p(void 0,e)})},void 0,t?.offlineProvider,!0,p),h},a.M.prototype.createRawTexture3D=function(e,t,i,n,a,o,s,l,c=null,f=0,u=0){let d=new r.h(this,10);return d.baseWidth=t,d.baseHeight=i,d.baseDepth=n,d.width=t,d.height=i,d.depth=n,d.format=a,d.type=f,d.generateMipMaps=o,d.samplingMode=l,d.is3D=!0,d._creationFlags=u,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,void 0,u),this.updateRawTexture3D(d,e,a,s,c,f),this._internalTexturesCache.push(d),d},a.M.prototype.updateRawTexture3D=function(e,t,i,r,n=null,a=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n),t){let n=e._hardwareTexture;4===i&&(t=o(t,e.width,e.height,a));let s=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(s,e,e.width,e.height,e.depth,n.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},a.M.prototype.createRawTexture2DArray=function(e,t,i,n,a,o,s,l,c=null,f=0,u=0){let d=new r.h(this,11);return d.baseWidth=t,d.baseHeight=i,d.baseDepth=n,d.width=t,d.height=i,d.depth=n,d.format=a,d.type=f,d.generateMipMaps=o,d.samplingMode=l,d.is2DArray=!0,d._creationFlags=u,this._doNotHandleContextLost||(d._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(d,t,i,n,u),this.updateRawTexture2DArray(d,e,a,s,c,f),this._internalTexturesCache.push(d),d},a.M.prototype.updateRawTexture2DArray=function(e,t,i,r,n=null,a=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n),t){let n=e._hardwareTexture;4===i&&(t=o(t,e.width,e.height,a));let s=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(s,e,e.width,e.height,e.depth,n.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},37434:function(e,t,i){var r=i(38212);r.M.prototype._readTexturePixels=function(e,t,i,r=-1,n=0,a=null,o=!0,s=!1,l=0,c=0){let f=e._hardwareTexture;return o&&this.flushFramebuffer(),this._textureHelper.readPixels(f.underlyingResource,l,c,t,i,f.format,r,n,a,s)},r.M.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"}},91696:function(e,t,i){var r=i(54925),n=i(77462),a=i(69729);i(4781);var o=i(38212);o.M.prototype._createHardwareRenderTargetWrapper=function(e,t,i){let r=new n.H(e,t,i,this);return this._renderTargetWrapperCache.push(r),r},o.M.prototype.createRenderTargetTexture=function(e,t){let i=this._createHardwareRenderTargetWrapper(!1,!1,e),r={};void 0!==t&&"object"==typeof t?(r.generateMipMaps=t.generateMipMaps,r.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&t.generateStencilBuffer,r.samplingMode=void 0===t.samplingMode?3:t.samplingMode,r.creationFlags=t.creationFlags??0,r.noColorAttachment=!!t.noColorAttachment,r.colorAttachment=t.colorAttachment,r.samples=t.samples,r.label=t.label,r.format=t.format,r.type=t.type):(r.generateMipMaps=t,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.samplingMode=3,r.creationFlags=0,r.noColorAttachment=!1);let n=r.colorAttachment||(r.noColorAttachment?null:this._createInternalTexture(e,r,!0,5));return i.label=r.label??"RenderTargetWrapper",i._samples=r.colorAttachment?.samples??r.samples??1,i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=!!r.generateStencilBuffer,i.setTextures(n),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,!1,i._generateStencilBuffer,i.samples,r.generateStencilBuffer?13:14,r.label?r.label+"-DepthStencil":void 0),n&&!r.colorAttachment&&(void 0!==t&&"object"==typeof t&&t.createMipMaps&&!r.generateMipMaps&&(n.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(n,void 0,void 0,void 0,r.creationFlags),void 0!==t&&"object"==typeof t&&t.createMipMaps&&!r.generateMipMaps&&(n.generateMipMaps=!1)),i},o.M.prototype._createDepthStencilTexture=function(e,t,i){let n={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t},o=(0,a.$l)(n.depthTextureFormat);i._depthStencilTextureWithStencil=o;let s=new r.h(this,o?12:14);return s.label=t.label,s.format=n.depthTextureFormat,s.type=(0,a.GX)(s.format),this._setupDepthStencilTexture(s,e,n.bilinearFiltering,n.comparisonFunction,n.samples),this._textureHelper.createGPUTextureForInternalTexture(s),this._internalTexturesCache.push(s),s},o.M.prototype._setupDepthStencilTexture=function(e,t,i,r,n=1){let a=t.width??t,o=t.height??t,s=t.layers||0,l=t.depth||0;e.baseWidth=a,e.baseHeight=o,e.width=a,e.height=o,e.is2DArray=s>0,e.is3D=l>0,e.depth=s||l,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=i?2:1,e.type=1,e._comparisonFunction=r,e._cachedWrapU=0,e._cachedWrapV=0},o.M.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t&&(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t),t}},64329:function(e,t,i){var r=i(38212),n=i(54925);r.M.prototype.createRenderTargetCubeTexture=function(e,t){let i=this._createHardwareRenderTargetWrapper(!1,!0,e),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...t};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,i.label=r.label??"RenderTargetWrapper",i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=r.generateStencilBuffer;let a=new n.h(this,5);return a.width=e,a.height=e,a.depth=0,a.isReady=!0,a.isCube=!0,a.samples=r.samples,a.generateMipMaps=r.generateMipMaps,a.samplingMode=r.samplingMode,a.type=r.type,a.format=r.format,this._internalTexturesCache.push(a),i.setTextures(a),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,void 0===r.samplingMode||2===r.samplingMode||2===r.samplingMode||3===r.samplingMode||3===r.samplingMode||5===r.samplingMode||6===r.samplingMode||7===r.samplingMode||11===r.samplingMode,i._generateStencilBuffer,i.samples),t&&t.createMipMaps&&!r.generateMipMaps&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a),t&&t.createMipMaps&&!r.generateMipMaps&&(a.generateMipMaps=!1),i}},19741:function(e,t,i){i(38212).M.prototype.setDepthStencilTexture=function(e,t,i,r){i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,r):this._setTexture(e,null,void 0,void 0,r)}},58953:function(e,t,i){i(32761);var r=i(57480),n=i(82707),a=i(77459);class o{getBindGroups(e,t,i){if(!i)throw Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){let n=this._bindGroupEntries.length>0;for(let t in e){let a=e[t],o=i[t],s=o.group,l=o.binding,c=a.type,f=a.object,u=a.indexInGroupEntries,d=this._bindGroupEntries[s];switch(!d&&(d=this._bindGroupEntries[s]=[]),c){case 5:void 0!==u&&n?d[u].resource=this._cacheSampler.getSampler(f):(a.indexInGroupEntries=d.length,d.push({binding:l,resource:this._cacheSampler.getSampler(f)}));break;case 0:case 4:{let e=f._texture._hardwareTexture;void 0!==u&&n?(0===c&&(d[u++].resource=this._cacheSampler.getSampler(f._texture)),d[u].resource=e.view):(a.indexInGroupEntries=d.length,0===c&&d.push({binding:l-1,resource:this._cacheSampler.getSampler(f._texture)}),d.push({binding:l,resource:e.view}));break}case 8:{let e=f._hardwareTexture;void 0!==u&&n?d[u].resource=e.view:(a.indexInGroupEntries=d.length,d.push({binding:l,resource:e.view}));break}case 1:{let e=f._texture._hardwareTexture;(8&e.textureAdditionalUsages)==0&&r.V.Error(`computeDispatch: The texture (name=${f.name}, uniqueId=${f.uniqueId}) is not a storage texture!`,50),void 0!==u&&n?d[u].resource=e.viewForWriting:(a.indexInGroupEntries=d.length,d.push({binding:l,resource:e.viewForWriting}));break}case 6:{let e=f.underlyingResource;void 0!==u&&n?d[u].resource=this._device.importExternalTexture({source:e}):(a.indexInGroupEntries=d.length,d.push({binding:l,resource:this._device.importExternalTexture({source:e})}));break}case 2:case 3:case 7:{let e=7===c?f:f.getBuffer(),t=e.underlyingResource;void 0!==u&&n?(d[u].resource.buffer=t,d[u].resource.size=e.capacity):(a.indexInGroupEntries=d.length,d.push({binding:l,resource:{buffer:t,offset:0,size:e.capacity}}))}}}for(let e=0;e<this._bindGroupEntries.length;++e){let i=this._bindGroupEntries[e];if(!i){this._bindGroups[e]=void 0;continue}this._bindGroups[e]=this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:i})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=o._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}o._Counter=0;class s{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}}let l={};a.$.prototype.createComputeContext=function(){return new o(this._device,this._cacheSampler)},a.$.prototype.createComputeEffect=function(e,t){let i=("string"==typeof e?e:e.computeToken||e.computeSource||e.computeElement||e.compute)+"@"+t.defines;if(this._compiledComputeEffects[i]){let e=this._compiledComputeEffects[i];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}let r=new n.B(e,t,this,i);return this._compiledComputeEffects[i]=r,r},a.$.prototype.createComputePipelineContext=function(){return new s(this)},a.$.prototype.areAllComputeEffectsReady=function(){for(let e in this._compiledComputeEffects)if(!this._compiledComputeEffects[e].isReady())return!1;return!0},a.$.prototype.computeDispatch=function(e,t,i,r,n=1,a=1,o,s){this._computeDispatch(e,t,i,r,n,a,void 0,void 0,o,s)},a.$.prototype.computeDispatchIndirect=function(e,t,i,r,n=0,a,o){this._computeDispatch(e,t,i,void 0,void 0,void 0,r,n,a,o)},a.$.prototype._computeDispatch=function(e,t,i,r,n,a,o,s,c,f){this._endCurrentRenderPass();let u=e._pipelineContext;u.computePipeline||(u.computePipeline=this._device.createComputePipeline({layout:"auto",compute:u.stage})),f&&this._timestampQuery.startPass(l,this._timestampIndex);let d=this._renderEncoder.beginComputePass(l);d.setPipeline(u.computePipeline);let h=t.getBindGroups(i,u.computePipeline,c);for(let e=0;e<h.length;++e){let t=h[e];t&&d.setBindGroup(e,t)}void 0!==o?d.dispatchWorkgroupsIndirect(o.underlyingResource,s):r+n+a>0&&d.dispatchWorkgroups(r,n,a),d.end(),f&&(this._timestampQuery.endPass(this._timestampIndex,f),this._timestampIndex+=2)},a.$.prototype.releaseComputeEffects=function(){for(let e in this._compiledComputeEffects){let t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},a.$.prototype._prepareComputePipelineContext=function(e,t,i,n,a){this.dbgShowShaderCode&&(r.V.Log(n),r.V.Log(t)),e.sources={compute:t,rawCompute:i},e.stage=this._createComputePipelineStageDescriptor(t,n,a)},a.$.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},a.$.prototype._rebuildComputeEffects=function(){for(let e in this._compiledComputeEffects){let t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},a.$.prototype._executeWhenComputeStateIsCompiled=function(e,t){e.stage.module.getCompilationInfo().then(e=>{let i={numErrors:0,messages:[]};for(let t of e.messages)"error"===t.type&&i.numErrors++,i.messages.push({type:t.type,text:t.message,line:t.lineNum,column:t.linePos,length:t.length,offset:t.offset});t(i)})},a.$.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},a.$.prototype._createComputePipelineStageDescriptor=function(e,t,i){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:i}},i(67029),a.$.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.pushDebugGroup(e)):this._currentRenderPass?(this._currentRenderPass.pushDebugGroup(e),this._debugStackRenderPass.push(e)):this._pendingDebugCommands.push(["push",e,t]))},a.$.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?(1===e&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.popDebugGroup()):this._currentRenderPass?(this._currentRenderPass.popDebugGroup(),this._debugStackRenderPass.pop()):this._pendingDebugCommands.push(["pop",null,e]))},a.$.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?(1===t&&(this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass()),this._renderEncoder.insertDebugMarker(e)):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e,t]))},a.$.prototype._debugFlushPendingCommands=function(){if(0!==this._debugStackRenderPass.length){let e=this._debugStackRenderPass.slice();this._debugStackRenderPass.length=0;for(let t=0;t<e.length;++t)this._debugPushGroup(e[t],2)}for(let e=0;e<this._pendingDebugCommands.length;++e){let[t,i,r]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(i,r);break;case"pop":this._debugPopGroup(r);break;case"insert":this._debugInsertMarker(i,r)}}this._pendingDebugCommands.length=0};var c=i(54925),f=i(95686);a.$.prototype.createDynamicTexture=function(e,t,i,r){let n=new c.h(this,4);return n.baseWidth=e,n.baseHeight=t,i&&(e=this.needPOTTextures?(0,f.R)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,f.R)(t,this._caps.maxTextureSize):t),n.width=e,n.height=t,n.isReady=!1,n.generateMipMaps=i,n.samplingMode=r,this.updateTextureSamplingMode(r,n),this._internalTexturesCache.push(n),e&&t&&this._textureHelper.createGPUTextureForInternalTexture(n,e,t),n},a.$.prototype.updateDynamicTexture=function(e,t,i,r=!1,n,a,o){if(!e)return;let s=t.width,l=t.height,c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e,s,l)),this._textureHelper.updateTexture(t,e,s,l,e.depth,c.format,0,0,i,r,0,0,o),e.generateMipMaps&&this._generateMipmaps(e),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0},i(4224),i(48149),i(42672),i(37434),i(91696),i(64329),i(19741),a.$.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let r=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(r=this._textureHelper.createGPUTextureForInternalTexture(e)),t&&void 0!==t.underlyingResource){if(t.isReady()){try{this._textureHelper.copyVideoToTexture(t,e,r.format,!i),e.generateMipMaps&&this._generateMipmaps(e)}catch(e){}e.isReady=!0}}else t&&this.createImageBitmap(t).then(t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,r.format,0,0,!i,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0}).catch(()=>{e.isReady=!0})}},40975:function(e,t,i){i.d(t,{u:()=>s});var r=i(40832),n=i(20486),a=i(31818),o=i(11971);class s{static _IsGPUBuffer(e){return void 0===e.underlyingResource}static _FlagsToString(e,t=""){let i=t;for(let t=0;t<=9;++t)e&1<<t&&(i&&(i+="_"),i+=o.Sd[1<<t]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){let n=void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,a={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+s._FlagsToString(t,r??"Buffer")+"_size"+n,mappedAtCreation:i,size:n,usage:t};return this._device.createBuffer(a)}createBuffer(e,t,i){let n=void 0!==e.byteLength,a=new r.p,o="DataBufferUniqueId="+a.uniqueId;return a.buffer=this.createRawBuffer(e,t,void 0,i?o+"-"+i:o),a.references=1,a.capacity=n?e.byteLength:e,a.engineId=this._engine.uniqueId,n&&this.setSubData(a,0,e),a}setRawData(e,t,i,r,n){r+=i.byteOffset,this._device.queue.writeBuffer(e,t,i.buffer,r,n)}setSubData(e,t,i,r=0,n=0){let a=e.underlyingResource;n=n||i.byteLength-r;let o=3&t;r-=o,t-=o;let s=n;if(n=n+o+3&-4,i.buffer.byteLength-i.byteOffset<n){let e=new Uint8Array(n);e.set(new Uint8Array(i.buffer,i.byteOffset+r,s)),i=e,r=0}this.setRawData(a,t,i,r,n)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i?e=Math.min(e,i.length):i=new Float32Array(e);let r=new Uint16Array(t);for(;e--;)i[e]=(0,n.SX)(r[e]);return i}readDataFromBuffer(e,t,i,r,n,o,s=0,l=0,c=null,f=!0,u=!1){let d=1===s?2:+(2===s),h=this._engine.uniqueId;return new Promise((i,p)=>{e.mapAsync(1,l,t).then(()=>{let h=e.getMappedRange(l,t),p=c;if(u)p=null===p?(0,a.kZ)(s,t,!0,h):(0,a.kZ)(s,p.buffer,void 0,h);else if(null===p)switch(d){case 0:(p=new Uint8Array(t)).set(new Uint8Array(h));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,h);break;case 2:(p=new Float32Array(t/4)).set(new Float32Array(h))}else switch(d){case 0:(p=new Uint8Array(p.buffer)).set(new Uint8Array(h,0,Math.min(p.byteLength,t)));break;case 1:p=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,h,c);break;case 2:(p=new Float32Array(p.buffer)).set(new Float32Array(h,0,p.byteLength/4))}if(n!==o){1!==d||u||(n*=2,o*=2);let e=new Uint8Array(p.buffer),t=n,i=0;for(let a=1;a<r;++a){i=a*o;for(let r=0;r<n;++r)e[t++]=e[i++]}p=0===d||u?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4)}e.unmap(),f&&this.releaseBuffer(e),i(p)},e=>{this._engine.isDisposed||this._engine.uniqueId!==h?i(new Uint8Array):p(e)})})}releaseBuffer(e){return s._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}},74168:function(e,t,i){i.d(t,{Eb:()=>n,KS:()=>l,c7:()=>c,d_:()=>u,h1:()=>o,qY:()=>s,w$:()=>a});var r=i(35689);class n{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new n(this.x,this.y,this.w,this.h)}}class a{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new a(this.x,this.y,this.w,this.h)}}class o{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new o(this.ref)}}class s{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new s(this.color)}}class l{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new l(this.query)}}class c{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new c}}class f{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){let e=new f;return e.bundles=this.bundles,e}}class u{constructor(e){this.numDrawCalls=0,this._device=e,this._list=Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){let e=new f;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:r.m.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();let e=new u(this._device);e._list=Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}},60636:function(e,t,i){i.d(t,{N:()=>d});var r=i(90478),n=i(89491),a=i(35689),o=i(29338),s=i(68415);let l="clearQuadVertexShader",c=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;s.l.ShadersStoreWGSL[l]||(s.l.ShadersStoreWGSL[l]=c);let f="clearQuadPixelShader",u=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;s.l.ShadersStoreWGSL[f]||(s.l.ShadersStoreWGSL[f]=u);class d{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new r.V(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,i,r,s=1){let l,c,f=null,u=!!this._engine._currentRenderTarget;if(e)l=e;else{let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=o.g[this._cacheRenderPipeline.colorFormats[t]??""];let n=o.g[this._depthTextureFormat??0];if(this._keyTemp[e]=(t?t.r+256*t.g+256*t.b*256+256*t.a*65536:0)+0x100000000*!!i+0x200000000*!!r+0x400000000*!!this._engine.useReverseDepthBuffer+0x800000000*!!u+0x1000000000*(s>1)+0x2000000000*n,c=this._keyTemp.join("_"),f=this._bundleCache[c])return f;l=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:a.m.GetSample(s)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&a.m.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(255*!!r),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(15*!!t);let d=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,s),h=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),h.uniformBuffer.update();let p=u?this._engine._ubInvertY:this._engine._ubDontInvertY,m=h.uniformBuffer.getBuffer(),_=m.uniqueId+"-"+p.uniqueId,g=this._bindGroups[_];if(!g){let e=h.bindGroupLayouts[0];(g=this._bindGroups[_]=[]).push(this._device.createBindGroup({label:`clearQuadBindGroup0-${_}`,layout:e[0],entries:[]})),n.E._SimplifiedKnownBindings||g.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${_}`,layout:e[1],entries:[]})),g.push(this._device.createBindGroup({label:`clearQuadBindGroup${n.E._SimplifiedKnownBindings?1:2}-${_}`,layout:e[n.E._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:p.underlyingResource,size:p.capacity}},{binding:1,resource:{buffer:m.underlyingResource,size:m.capacity}}]}))}l.setPipeline(d);for(let e=0;e<g.length;++e)l.setBindGroup(e,g[e]);return l.draw(4,1,0,0),e||(f=l.finish(),this._bundleCache[c]=f),f}}},24926:function(e,t,i){i.d(t,{H:()=>n});var r=i(2296);class n extends r.N{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}},23528:function(e,t,i){i.d(t,{J:()=>n});var r=i(45195);class n extends r.r{constructor(e){super(e)}}},44757:function(e,t,i){i.d(t,{Q:()=>a});var r=i(52754),n=i(35689);class a{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=e}releaseMSAATexture(e){if(this._webgpuMSAATexture)if(void 0!==e)this._engine._textureHelper.releaseTexture(this._webgpuMSAATexture[e]),delete this._webgpuMSAATexture[e];else{for(let e of this._webgpuMSAATexture)this._engine._textureHelper.releaseTexture(e);this._webgpuMSAATexture=null}}constructor(e,t=null){this._engine=e,this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,a,o,s,l,c){let f="2d",u=1;a?(f=i?"cube-array":"cube",u=6*(c||1)):o?(f="3d",u=1):i&&(f="2d-array",u=c);let d=n.m.GetDepthFormatOnly(this.format),h=n.m.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${o?"3D":a?"Cube":"2D"}${i?"_Array"+u:""}_${s}x${l}_${t?"wmips":"womips"}_${this.format}_${f}`,format:d,dimension:f,mipLevelCount:t?(0,r.ILog2)(Math.max(s,l))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:u,aspect:h})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){let t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset()}}},31254:function(e,t,i){i.d(t,{r:()=>a});var r=i(45195),n=i(20230);class a{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.useVertexPulling=!1,this.uniqueId=a._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?n.R.GetSamplerHashCode(t):0;let a=r!==i.hashCode;a&&this.updateId++,this.isDirty||(this.isDirty=a)}setTexture(e,t){let i=this.textures[e],n=-1;i?n=i.texture?.uniqueId??-1:this.textures[e]=i={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},i.isExternalTexture&&this._numExternalTextures--,i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(i.isFloatOrDepthTexture=1===t.type||t.format>=13&&t.format<=18,i.isExternalTexture=r.r.IsExternalTexture(t),i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,i.isExternalTexture&&this._numExternalTextures++):(i.isFloatOrDepthTexture=!1,i.isExternalTexture=!1),i.texture=t;let a=n!==(t?.uniqueId??-1);a&&this.updateId++,this.isDirty||(this.isDirty=a)}}a._Counter=0},10743:function(e,t,i){i.d(t,{e:()=>n});var r=i(46052);class n{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;let t=void 0!==this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,n=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(r)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();let e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new r.L(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){let e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}}},85279:function(e,t,i){i.d(t,{e:()=>n});var r=i(81231);class n{constructor(){this._gpuTimeInFrameId=-1,this.counter=new r.A}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}},46052:function(e,t,i){i.d(t,{L:()=>n});var r=i(11971);class n{get querySet(){return this._querySet}constructor(e,t,i,n,a,o=!0,s){this._dstBuffers=[],this._engine=e,this._device=n,this._bufferManager=a,this._count=t,this._canUseMultipleBuffers=o,this._querySet=n.createQuerySet({label:s??"QuerySet",type:i,count:t}),this._queryBuffer=a.createRawBuffer(8*t,r.Sd.QueryResolve|r.Sd.CopySrc,void 0,"QueryBuffer"),o||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,r.Sd.MapRead|r.Sd.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){let i;if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;let n=this._device.createCommandEncoder();return 0===this._dstBuffers.length?i=this._bufferManager.createRawBuffer(8*this._count,r.Sd.MapRead|r.Sd.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(i=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),n.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),n.copyBufferToBuffer(this._queryBuffer,0,i,0,8*t),this._device.queue.submit([n.finish()]),i}async readValues(e=0,t=1){let i=this._getBuffer(e,t);if(null===i)return null;let r=this._engine.uniqueId;try{await i.mapAsync(1);let e=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,e}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw e}}async readValue(e=0){let t=this._getBuffer(e,1);if(null===t)return null;let i=this._engine.uniqueId;try{await t.mapAsync(1);let e=new BigUint64Array(t.getMappedRange()),i=Number(e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,i}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw e}}async readTwoValuesAndSubtract(e=0){let t=this._getBuffer(e,2);if(null===t)return null;let i=this._engine.uniqueId;try{await t.mapAsync(1);let e=new BigUint64Array(t.getMappedRange()),i=Number(e[1]-e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,i}catch(e){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw e}}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}},89491:function(e,t,i){i.d(t,{E:()=>n});let r={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class n{static get KnownUBOs(){return n._SimplifiedKnownBindings?n._SimplifiedKnownUBOs:n._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){let e=n.KnownUBOs,t=[];for(let i in e){let r=e[i].binding;-1!==r.groupIndex&&(void 0===t[r.groupIndex]?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){let i=this._attributeNextLocation;return this._attributeNextLocation+=(r[e]??1)*(t||1),i}getVaryingNextLocation(e,t=0){let i=this._varyingNextLocation;return this._varyingNextLocation+=(r[e]??1)*(t||1),i}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";let t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}n._SimplifiedKnownBindings=!0,n._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},n._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}}},52684:function(e,t,i){i.d(t,{I:()=>s});var r=i(89491),n=i(57480),a=i(93685),o=i(29919);class s extends a.q{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0,n=e.indexOf("["),a=e.indexOf("]");if(n>0&&a>0){let t=e.substring(n+1,a);isNaN(r=+t)&&(r=+i[t.trim()]),e=e.substring(0,n)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){let i=`// Internals UBO
uniform ${a.q.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){return(t&&this._fragmentIsGLES3?/(flat\s)?\s*\bin\b/:!t&&this._vertexIsGLES3?/(flat\s)?\s*\bout\b/:/(flat\s)?\s*\bvarying\b/).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;let r=(t&&this._fragmentIsGLES3?/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){let a,o=r[1]??"",s=r[2],l=r[3];t?(a=this._webgpuProcessingContext.availableVaryings[l],this._missingVaryings[a]="",void 0===a&&n.V.Warn(`Invalid fragment shader: The varying named "${l}" is not declared in the vertex shader! This declaration will be ignored.`)):(a=this._webgpuProcessingContext.getVaryingNextLocation(s,this._getArraySize(l,s,i)[2]),this._webgpuProcessingContext.availableVaryings[l]=a,this._missingVaryings[a]=`layout(location = ${a}) ${o} in ${s} ${l};`),e=e.replace(r[0],void 0===a?"":`layout(location = ${a}) ${o} ${t?"in":"out"} ${s} ${l};`)}return e}attributeProcessor(e,t){this._preProcessors=t;let i=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==i){let r=i[1],n=i[2],a=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(n,r,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=a,this._webgpuProcessingContext.orderedAttributes[a]=n;let o=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[n];if(void 0!==o){let t=`_int_${n}_`;e=e.replace(i[0],`layout(location = ${a}) in ${o<0?-1===o?"int":"ivec"+-o:1===o?"uint":"uvec"+o} ${t}; ${r} ${n} = ${r}(${t});`)}else e=e.replace(i[0],`layout(location = ${a}) in ${r} ${n};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;let r=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==r){let n=r[1],o=r[2];if(0===n.indexOf("sampler")||1===n.indexOf("sampler")){let r=0;[o,n,r]=this._getArraySize(o,n,i);let s=this._webgpuProcessingContext.availableTextures[o];if(!s){s={autoBindSampler:!0,isTextureArray:r>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let e=0;e<(r||1);++e)s.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}let l=a.q._SamplerTypeByWebGLSamplerType[n]??"sampler",c=!!a.q._IsComparisonSamplerByWebGPUSamplerType[l],f=o+"Sampler",u=this._webgpuProcessingContext.availableSamplers[f];u||(u={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c?"comparison":"filtering"});let d="u"===n.charAt(0)?"u":"i"===n.charAt(0)?"i":"";d&&(n=n.substring(1)),s.sampleType=c?"depth":"u"===d?"uint":"i"===d?"sint":"float";let h=r>0,p=u.binding.groupIndex,m=u.binding.bindingIndex,_=a.q._SamplerFunctionByWebGLSamplerType[n],g=a.q._TextureTypeByWebGLSamplerType[n],v=a.q._GpuTextureViewDimensionByWebGPUTextureType[g];if(h){let t=[];t.push(`layout(set = ${p}, binding = ${m}) uniform ${d}${l} ${f};`),e=`
`;for(let i=0;i<r;++i){let r=s.textures[i].groupIndex,n=s.textures[i].bindingIndex;t.push(`layout(set = ${r}, binding = ${n}) uniform ${g} ${o}Texture${i};`),e+=`${i>0?"\n":""}#define ${o}${i} ${d}${_}(${o}Texture${i}, ${f})`}e=t.join("\n")+e,this._textureArrayProcessing.push(o)}else r=1,e=`layout(set = ${p}, binding = ${m}) uniform ${l} ${f};
                        layout(set = ${s.textures[0].groupIndex}, binding = ${s.textures[0].bindingIndex}) uniform ${d}${g} ${o}Texture;
                        #define ${o} ${d}${_}(${o}Texture, ${f})`;this._webgpuProcessingContext.availableTextures[o]=s,this._webgpuProcessingContext.availableSamplers[f]=u,this._addSamplerBindingDescription(f,u,!t);for(let e=0;e<r;++e)this._addTextureBindingDescription(o,s,e,v,null,!t)}else this._addUniformToLeftOverUBO(o,n,i),e=""}return e}uniformBufferProcessor(e,t){let i=/uniform\s+(\w+)/gm.exec(e);if(null!==i){let n=i[1],a=this._webgpuProcessingContext.availableBuffers[n];if(!a){let e=r.E.KnownUBOs[n];a={binding:e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[n]=a}this._addBufferBindingDescription(n,a,"uniform",!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,n,a){let s=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){let t=e.indexOf("gl_FragCoord")>=0,i=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,r=-1!==e.search(/layout *\(location *= *0\) *out/g);if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){let t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index))}else e=e.replace(/void\s+?main\s*\(/g,(s||r?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",t?"vec4 glFragCoord_;\n":""),t&&(e=(0,o.bI)(e,"void main",i))}else if("VERTEXOUTPUT_INVARIANT"in a&&(e="invariant gl_Position;\n"+e),e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex"),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;if(!i){let t=e.lastIndexOf("}");e=e.substring(0,t)+"gl_Position.y *= yFactor_;\n}"}return e}_applyTextureArrayProcessing(e,t){let i=RegExp(t+"\\s*\\[(.+)?\\]","gm"),r=i.exec(e);for(;null!==r;){let n=r[1],a=+n;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[n.trim()]),e=e.replace(r[0],t+a),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(let e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?i+=`    ${e.type} ${e.name}[${e.length}];
`:i+=`    ${e.type} ${e.name};
`;return i+"};\n\n"}finalizeShaders(e,t){for(let i=0;i<this._textureArrayProcessing.length;++i){let r=this._textureArrayProcessing[i];e=this._applyTextureArrayProcessing(e,r),t=this._applyTextureArrayProcessing(t,r)}for(let e=0;e<this._missingVaryings.length;++e){let i=this._missingVaryings[e];i&&i.length>0&&(t=i+"\n"+t)}let i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}},72025:function(e,t,i){i.d(t,{z:()=>c});var r=i(89491),n=i(57480),a=i(93685),o=i(29919);i(60979),i(45103),i(38726),i(70654),i(29969),i(85439),i(88279),i(21968),i(82473);let s="fragmentOutputs.fragDepth",l={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class c extends a.q{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}_getArraySize(e,t,i){let r=0,n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let e=n;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;let a=t.substring(e+1,n);for(isNaN(r=+a)&&(r=+i[a.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){let t=this.pureMode?"":`struct ${a.q.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> internals : ${a.q.InternalsUBOName};
`;return -1!==e.indexOf(t)?e:t+(0,o.RJ)(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){let r=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==r){let a,o=r[1]??"perspective",s=r[2]??"center",l=r[4],c=r[3],f="flat"===o?`@interpolate(${o})`:`@interpolate(${o}, ${s})`;t?void 0===(a=this._webgpuProcessingContext.availableVaryings[c])&&n.V.Warn(`Invalid fragment shader: The varying named "${c}" is not declared in the vertex shader! This declaration will be ignored.`):(a=this._webgpuProcessingContext.getVaryingNextLocation(l,this._getArraySize(c,l,i)[2]),this._webgpuProcessingContext.availableVaryings[c]=a,this._varyingsWGSL.push(`  @location(${a}) ${f} ${c} : ${l},`),this._varyingNamesWGSL.push(c)),e=""}return e}attributeProcessor(e,t){let i=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==i){let r=i[2],n=i[1],a=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(n,r,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=a,this._webgpuProcessingContext.orderedAttributes[a]=n;let o=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[n];if(void 0!==o){let e=`_int_${n}_`;this._attributesInputWGSL.push(`@location(${a}) ${e} : ${o<0?-1===o?"i32":"vec"+-o+"<i32>":1===o?"u32":"vec"+o+"<u32>"},`),this._attributesWGSL.push(`${n} : ${r},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${n} = ${r}(vertexInputs_.${e});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${a}) ${n} : ${r},`),this._attributesWGSL.push(`${n} : ${r},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${n} = vertexInputs_.${n};`);e=""}return e}uniformProcessor(e,t,i){let r=this.uniformRegexp.exec(e);if(null!==r){let t=r[2],n=r[1];this._addUniformToLeftOverUBO(n,t,i),e=""}return e}textureProcessor(e,t,i){let r=this.textureRegexp.exec(e);if(null!==r){let n=r[1],a=r[2],o=!!r[3],s=r[4],c=s.indexOf("storage")>0,f=r[6],u=c?f.substring(0,f.indexOf(",")).trim():null,d=o?this._getArraySize(n,a,i)[2]:0,h=this._webgpuProcessingContext.availableTextures[n];if(h)d=h.textures.length;else{h={isTextureArray:d>0,isStorageTexture:c,textures:[],sampleType:"float"},d=d||1;for(let e=0;e<d;++e)h.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[n]=h;let p=s.indexOf("depth")>0,m=l[s],_=p?"depth":"u32"===f?"uint":"i32"===f?"sint":"float";if(h.sampleType=_,void 0===m)throw`Can't get the texture dimension corresponding to the texture function "${s}"!`;for(let i=0;i<d;++i){let{groupIndex:r,bindingIndex:a}=h.textures[i];0===i&&(e=`@group(${r}) @binding(${a}) ${e}`),this._addTextureBindingDescription(n,h,i,m,u,!t)}}return e}_convertDefinesToConst(e){let t="";for(let i in e){let r=e[i];!i.startsWith("__")&&(isNaN(parseInt(r))&&isNaN(parseFloat(r))?i&&""===r&&(t+=`const ${i} = true;
`):t+=`const ${i} = ${r};
`)}return t}postProcessor(e,t,i,r,n,a,o){let s=[];for(let e in o)"true"!==o[e]&&s.push(e);for(let t of(s.sort((e,t)=>e.length-t.length>0?-1:+(e.length!==t.length)),s)){let i=e.indexOf("#define "+t),r=e.indexOf("\n",i);-1===r&&(r=e.length);let n=e.substring(i+8+t.length+1,r);e=e.replace(RegExp(t,"g"),n)}return e=this._convertDefinesToConst(a)+e,"VERTEXOUTPUT_INVARIANT"in a&&(e="#define VERTEXOUTPUT_INVARIANT\n"+e),e}finalizeShaders(e,t){let i=[],r=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);let n=this._buildLeftOverUBO();e=n+e,t=n+t,e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let a="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesInputWGSL.length>0&&(a+=this._attributesInputWGSL.join("\n")),a+="\n};\nvar<private> vertexInputs"+(this._hasNonFloatAttribute?"_":"")+" : VertexInputs;\n",this._hasNonFloatAttribute&&(a+="struct VertexInputs_ {\n  vertexIndex : u32, instanceIndex : u32,\n",a+=this._attributesWGSL.join("\n"),a+="\n};\nvar<private> vertexInputs : VertexInputs_;\n");let l="struct FragmentInputs {\n  @builtin(position)"+(e.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0?" @invariant":"")+" position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(l+=this._varyingsWGSL.join("\n")),l+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=a+l+e;let c=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(c+="vertexInputs.vertexIndex = vertexInputs_.vertexIndex;\nvertexInputs.instanceIndex = vertexInputs_.instanceIndex;\n",c+=this._attributesConversionCodeWGSL.join("\n"),c+="\n");let f=this.pureMode?"  return vertexOutputs;":`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`,u=-1!==e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS");e=(u?"diagnostic(off, derivative_uniformity);\n":"")+"diagnostic(off, chromium.unreachable_code);\n"+(0,o.bI)(e,"fn main",c,f),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let d="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(d+=this._varyingsWGSL.join("\n")),d+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let h="struct FragmentOutputs {\n",p="fragmentOutputs\\.fragData",m=t.match(RegExp(p+"0","g")),_=0;if(m){h+=` @location(${_}) fragData0 : vec4<f32>,
`,_++;for(let e=1;e<8;e++)(m=t.match(RegExp(p+e,"g")))&&(h+=` @location(${_}) fragData${_} : vec4<f32>,
`,_++);-1!==t.indexOf("MRT_AND_COLOR")&&(h+=`  @location(${_}) color : vec4<f32>,
`,_++)}(m=t.match(/oitDepthSampler/))&&(h+=` @location(${_++}) depth : vec2<f32>,
 @location(${_++}) frontColor : vec4<f32>,
 @location(${_++}) backColor : vec4<f32>,
`),0===_&&(-1!==t.indexOf("DUAL_SOURCE_BLENDING")?(i.push("dual_source_blending"),h+="  @location(0) @blend_src(0) color : vec4<f32>,\n  @location(0) @blend_src(1) color2 : vec4<f32>,\n"):h+="  @location(0) color : vec4<f32>,\n",_++);let g=!1,v=0;for(;!g&&!((v=t.indexOf(s,v))<0);){let e=v;for(g=!0;v>1&&"\n"!==t.charAt(v);){if("/"===t.charAt(v)&&"/"===t.charAt(v-1)){g=!1;break}v--}v=e+s.length}return g&&(h+="  @builtin(frag_depth) fragDepth: f32,\n"),h+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n",u=-1!==(t=d+h+t).indexOf("#define DISABLE_UNIFORMITY_ANALYSIS"),i.length>0&&(t="enable "+i.join(";\nenable ")+";\n"+t),t=(u?"diagnostic(off, derivative_uniformity);\n":"")+"diagnostic(off, chromium.unreachable_code);\n"+(0,o.bI)(t,"fn main","  fragmentInputs = input;\n  "+r,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(let t of this._webgpuProcessingContext.leftOverUniforms){let n=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=a.q.UniformSizes[n];if(t.length>0)if(o<=2){let a=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${a} {
                        @size(16)
                        el: ${n},
                    }`,this._stridedUniformArrays.push(t.name),r+=` @align(16) ${t.name} : array<${a}, ${t.length}>,
`}else r+=` ${t.name} : array<${t.type}, ${t.length}>,
`;else r+=`  ${t.name} : ${t.type},
`}return r+="};\n",r=`${i}
${r}@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};
`}_processSamplers(e,t){let i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){let r=i.exec(e);if(null===r)break;let n=r[1],a=r[2],o=n.length-7,s=n.lastIndexOf("Sampler")===o?n.substring(0,o):null,l="sampler_comparison"===a?"comparison":"filtering";if(s){let e=this._webgpuProcessingContext.availableTextures[s];e&&(e.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[n];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[n]=c),this._addSamplerBindingDescription(n,c,t);let f=e.substring(0,r.index),u=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `;e=f+u+e.substring(r.index),i.lastIndex+=u.length}return e}_processCustomBuffers(e,t){let i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){let n=i.exec(e);if(null===n)break;let a=n[1],o=n[3],s=n[4],l=n[5],c=this._webgpuProcessingContext.availableBuffers[s];if(!c){let e,t="uniform"===a?r.E.KnownUBOs[l]:null;t?(s=l,-1===(e=t.binding).groupIndex&&((e=this._webgpuProcessingContext.availableBuffers[s]?.binding)||(e=this._webgpuProcessingContext.getNextFreeUBOBinding()))):e=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:e},this._webgpuProcessingContext.availableBuffers[s]=c}this._addBufferBindingDescription(s,this._webgpuProcessingContext.availableBuffers[s],"read_write"===o?"storage":"storage"===a?"read-only-storage":"uniform",t);let f=c.binding.groupIndex,u=c.binding.bindingIndex,d=e.substring(0,n.index),h=`@group(${f}) @binding(${u}) `;e=d+h+e.substring(n.index),i.lastIndex+=h.length}return e}_processStridedUniformArrays(e){for(let t of this._stridedUniformArrays)e=e.replace(RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}},5082:function(e,t,i){i.d(t,{V:()=>n});var r=i(57480);class n{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this.showDebugLogs=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._log("enabled",`activate=${e}, mode=${this._mode}`),this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t=null;return this._record?(t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset(),this._log("endRenderPass",`bundleList recorded at position #${this._allBundleLists.length-1}`)):this._playBundleListIndex>=this._allBundleLists.length?this._log("endRenderPass",`empty or out-of-sync bundleList (_allBundleLists.length=${this._allBundleLists.length}, playBundleListIndex=${this._playBundleListIndex})`):(this._log("endRenderPass",`run bundleList #${this._playBundleListIndex}`),t=this._allBundleLists[this._playBundleListIndex++]),t&&(t.run(e),1===this._mode&&this._engine._reportDrawCall(t.numDrawCalls)),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved,this._log("endFrame","bundles recorded, switching to play mode")),this._playBundleListIndex=0}reset(){this._log("reset","called"),this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}_log(e,t){this.showDebugLogs&&r.V.Log(`[Frame: ${this._engine.frameId}] WebGPUSnapshotRendering:${e} - ${t}`)}}},87663:function(e,t,i){i.d(t,{K:()=>n});var r=i(18793);class n extends r.u{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._cache.setStencilBackCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._cache.setStencilBackFailOp(e))}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._cache.setStencilBackDepthFailOp(e))}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._cache.setStencilBackPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){let e=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backFunc=e?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.backOpStencilFail=e?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=e?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=e?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass)}}},35689:function(e,t,i){i.d(t,{m:()=>n});var r=i(52754);class n{static ComputeNumMipmapLevels(e,t){return(0,r.ILog2)(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8uint":case"rg8unorm":case"rg8uint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8uint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc5-rg-unorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-rg11unorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":break;case"r8snorm":case"r8sint":case"rg8snorm":case"rg8sint":case"rgba8snorm":case"rgba8sint":case"bc6h-rgb-float":case"bc5-rg-snorm":case"bc4-r-snorm":case"eac-r11snorm":case"eac-rg11snorm":return 3;case"r16uint":case"r16unorm":case"rg16unorm":case"rgba16unorm":case"rg16uint":case"rgba16uint":case"depth16unorm":return 5;case"r16sint":case"r16snorm":case"rg16snorm":case"rgba16snorm":case"rg16sint":case"rgba16sint":return 4;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"rg32uint":case"rgba32uint":case"r32sint":case"rg32sint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16unorm":case"r16snorm":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth16unorm":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":case"depth32float":break;case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba16unorm":case"rgba16snorm":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return i?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return i?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return i?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return i?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return i?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return i?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return i?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?"rgba8unorm-srgb":"rgba8unorm";case 12:return i?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:default:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV"}case 14:switch(t){case 5:default:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return"rgb10a2unorm";case 11:return"rgb10a2uint"}}return i?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r16unorm":case"r16snorm":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgba16unorm":case"rgba16snorm":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAspect(e){switch(e){case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":case"depth24plus-stencil8":return"depth24plus";case"depth32float":case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}},29338:function(e,t,i){i.d(t,{g:()=>I,n:()=>R});var r,n,a,o,s=i(11971),l=i(44757),c=i(35689),f=i(12252);let u=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    varying vTex: vec2f;

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.vTex = tex[input.vertexIndex];
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,d=`
    var imgSampler: sampler;
    var img: texture_2d<f32>;

    varying vTex: vec2f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);
    }
    `,h=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        #ifdef INVERTY
            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));
        #endif
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,p=`
    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,m=`
    var img: texture_2d<f32>;
    uniform ofstX: f32;
    uniform ofstY: f32;
    uniform width: f32;
    uniform height: f32;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {
            discard;
        }
        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {
            discard;
        }
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,_=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,g=`
    uniform color: vec4f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = uniforms.color;
    }
    `,v=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,S=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,E=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `,T=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,A=`
    var msaaDepthTexture: texture_depth_multisampled_2d;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef USE_MIN
        let numSamples = textureNumSamples(msaaDepthTexture);
        var depth = 1.0;

        for (var i = 0u; i < numSamples; i = i + 1u) {
            depth = min(depth, textureLoad(msaaDepthTexture, vec2u(input.position.xy), i));
        }
        
        fragmentOutputs.color = vec4f(depth);
    #else
        fragmentOutputs.color = vec4f(textureLoad(msaaDepthTexture, vec2u(input.position.xy), 0)); // do like WebGL, take the first sample
    #endif
    }
    `;(r=a||(a={}))[r.MipMap=0]="MipMap",r[r.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",r[r.Clear=2]="Clear",r[r.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst",r[r.ResolveDepth=4]="ResolveDepth",(n=o||(o={}))[n.DontInvertY=0]="DontInvertY",n[n.InvertY=1]="InvertY";let x=[{vertex:u,fragment:d},{vertex:h,fragment:p},{vertex:_,fragment:g},{vertex:h,fragment:m},{vertex:T,fragment:A}],I={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38,r16unorm:39,rg16unorm:40,rgba16unorm:41,r16snorm:42,rg16snorm:43,rgba16snorm:44};class R{constructor(e,t,i,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=i,-1!==r.indexOf("rg11b10ufloat-renderable")){const e=Object.keys(I);I.rg11b10ufloat=I[e[e.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,s.Sd.Uniform|s.Sd.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=a.MipMap,i){let r=t===a.MipMap?1:t===a.InvertYPremultiplyAlpha?(!!i.invertY<<1)+(!!i.premultiplyAlpha<<2):t===a.Clear?8:t===a.InvertYPremultiplyAlphaWithOfst?(!!i.invertY<<4)+(!!i.premultiplyAlpha<<5):64*(t===a.ResolveDepth);this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][r];if(!n){let o="";(t===a.InvertYPremultiplyAlpha||t===a.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(o+="#define INVERTY\n"),i.premultiplyAlpha&&(o+="#define PREMULTIPLYALPHA\n"));let s=this._compiledShaders[r];if(!s){let e=x[t].vertex,i=x[t].fragment,n={defines:o.split("\n"),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};(0,f.pB)(n),n.processor.pureMode=!0,(0,f.M0)(e,n,t=>{e=t},this._engine),n.isFragment=!0,(0,f.M0)(i,n,e=>{i=e},this._engine);let a=(0,f.nO)(e,i,n);n.processor.pureMode=!1;let l=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVertexShader_${r}`,code:a.vertexCode}),c=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalFragmentShader_${r}`,code:a.fragmentCode});s=this._compiledShaders[r]=[l,c]}let l=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalPipeline_${e}_${r}`,layout:"auto",vertex:{module:s[0],entryPoint:"main"},fragment:{module:s[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._pipelines[e][r]=[l,l.getBindGroupLayout(0)]}return n}_getVideoPipeline(e,t=o.DontInvertY){let i=+(t===o.InvertY);this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let t=this._videoCompiledShaders[i];if(!t){let e=this._device.createShaderModule({code:v,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_VertexShader`}),r=this._device.createShaderModule({code:0===i?S:E,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_FragmentShader_${0===i?"DontInvertY":"InvertY"}`});t=this._videoCompiledShaders[i]=[e,r]}let n=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVideoPipeline_${e}_${0===i?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});r=this._videoPipelines[e][i]=[n,n.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,n){let a=void 0===n,[s,l]=this._getVideoPipeline(i,r?o.InvertY:o.DontInvertY);a&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`copy video to texture - invertY=${r}`);let c=t._hardwareTexture,f={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:c.underlyingResource.createView({format:i,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},u=n.beginRenderPass(f),d={layout:l,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},h=this._device.createBindGroup(d);u.setPipeline(s),u.setBindGroup(0,h),u.draw(4,1,0,0),u.end(),n.popDebugGroup?.(),a&&(this._device.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(e,t,i,r,n=!1,o=!1,s=0,l=0,f=1,u=0,d=0,h=0,p=0,m,_){let g,v=0!==h,S=void 0===m,[E,T]=this._getPipeline(r,v?a.InvertYPremultiplyAlphaWithOfst:a.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:o});if(s=Math.max(s,0),S&&(m=this._device.createCommandEncoder({})),m.pushDebugGroup?.(`internal process texture - invertY=${n} premultiplyAlpha=${o}`),c.m.IsHardwareTexture(e)?(g=e.underlyingResource,n&&!o&&1===f&&0===s||(e=void 0)):(g=e,e=void 0),!g)return;v&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([u,d,h,p]),0,16);let A=e,x=A?._copyInvertYTempTexture??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,m,21,void 0,"TempTextureForCopyWithInvertY"),I=A?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${n?"InvertY":"DontInvertY"}_${o?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:x.createView({format:r,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},R=m.beginRenderPass(I),C=v?A?._copyInvertYBindGroupWithOfst:A?._copyInvertYBindGroup;if(!C){let e={layout:T,entries:[{binding:0,resource:g.createView({format:r,dimension:"2d",baseMipLevel:l,mipLevelCount:1,arrayLayerCount:f,baseArrayLayer:s})}]};v&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),C=this._device.createBindGroup(e)}R.setPipeline(E),R.setBindGroup(0,C),R.draw(4,1,0,0),R.end(),m.copyTextureToTexture({texture:x},{texture:g,mipLevel:l,origin:{x:0,y:0,z:s}},{width:h||t,height:p||i,depthOrArrayLayers:1}),A?(A._copyInvertYTempTexture=x,A._copyInvertYRenderPassDescr=I,v?A._copyInvertYBindGroupWithOfst=C:A._copyInvertYBindGroup=C):this._deferredReleaseTextures.push([x,null]),m.popDebugGroup?.(),S&&(this._device.queue.submit([m.finish()]),m=null)}createTexture(e,t=!1,i=!1,r=!1,n=!1,a=!1,o="rgba8unorm",s=1,l,f=-1,u=0,d){s=c.m.GetSample(s);let h=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:h},m=16*!!I[o],_=c.m.IsCompressedFormat(o),g=t?c.m.ComputeNumMipmapLevels(e.width,e.height):1;u|=t&&!_?1|m:0,_||a||(u|=2|m);let v=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${a?"3D":"2D"}_${d?d+"_":""}${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${s}`,size:p,dimension:a?"3d":"2d",format:o,usage:(f>=0?f:7)|u,sampleCount:s,mipLevelCount:g});return c.m.IsImageBitmap(e)&&(this.updateTexture(e,v,e.width,e.height,h,o,0,0,r,n,0,0),t&&i&&this.generateMipmaps(v,o,g,0,a,l)),v}createCubeTexture(e,t=!1,i=!1,r=!1,n=!1,a="rgba8unorm",o=1,s,l=-1,f=0,u){o=c.m.GetSample(o);let d=c.m.IsImageBitmapArray(e)?e[0].width:e.width,h=c.m.IsImageBitmapArray(e)?e[0].height:e.height,p=16*!!I[a],m=c.m.IsCompressedFormat(a),_=t?c.m.ComputeNumMipmapLevels(d,h):1;f|=t&&!m?1|p:0,m||(f|=2|p);let g=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${u?u+"_":""}${d}x${h}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:d,height:h,depthOrArrayLayers:6},dimension:"2d",format:a,usage:(l>=0?l:7)|f,sampleCount:o,mipLevelCount:_});return c.m.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,g,d,h,a,r,n,0,0),t&&i&&this.generateCubeMipmaps(g,a,_,s)),g}generateCubeMipmaps(e,t,i,r){let n=void 0===r;n&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup?.(`create cube mipmaps - ${i} levels`);for(let n=0;n<6;++n)this.generateMipmaps(e,t,i,n,!1,r);r.popDebugGroup?.(),n&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,n=!1,a){let o,s=void 0===a,[l,f]=this._getPipeline(t);if(r=Math.max(r,0),s&&(a=this._device.createCommandEncoder({})),a.pushDebugGroup?.(`create mipmaps for face #${r} - ${i} levels`),c.m.IsHardwareTexture(e)?(o=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(o=e,e=void 0),!o)return;let u=e;for(let e=1;e<i;++e){let i=u?._mipmapGenRenderPassDescr[r]?.[e-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${r}_level${e}`,colorAttachments:[{view:o.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:"load",storeOp:"store"}]};u&&(u._mipmapGenRenderPassDescr[r]=u._mipmapGenRenderPassDescr[r]||[],u._mipmapGenRenderPassDescr[r][e-1]=i);let s=a.beginRenderPass(i),c=u?._mipmapGenBindGroup[r]?.[e-1]??this._device.createBindGroup({layout:f,entries:[{binding:0,resource:o.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})},{binding:1,resource:this._mipmapSampler}]});u&&(u._mipmapGenBindGroup[r]=u._mipmapGenBindGroup[r]||[],u._mipmapGenBindGroup[r][e-1]=c),s.setPipeline(l),s.setBindGroup(0,c),s.draw(4,1,0,0),s.end()}a.popDebugGroup?.(),s&&(this._device.queue.submit([a.finish()]),a=null)}createGPUTextureForInternalTexture(e,t,i,r,n,a){let o;e._hardwareTexture||(e._hardwareTexture=new l.Q(this._engine)),void 0===t&&(t=e.width),void 0===i&&(i=e.height),void 0===r&&(r=e.depth),e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r;let s=e._hardwareTexture,f=((n??0)&1)!=0;if(s.format=c.m.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),a||this.createMSAATexture(e,e.samples),e.samples>1)switch(s.format){case"depth16unorm":s.format="r16unorm";break;case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":s.format="r32float"}s.textureUsages=5===e._source||6===e.source?21:12===e._source?20:-1,s.textureAdditionalUsages=8*!!f;let u=e.generateMipMaps,d=r||1;if(o=null!==e._maxLodLevel?e._maxLodLevel:u?c.m.ComputeNumMipmapLevels(t,i):1,e.isCube){let r=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,s.format,1,this._commandEncoderForCreation,s.textureUsages,s.textureAdditionalUsages,e.label);s.set(r);let n=e.is3D?1:d,a=c.m.GetDepthFormatOnly(s.format),l=c.m.HasDepthAndStencilAspects(s.format)?"depth-only":"all",h=e.is2DArray?"cube-array":"cube";s.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+n:""}_${t}x${i}_${u?"wmips":"womips"}_${a}_${h}_${l}_${e.label??"noname"}`,format:a,dimension:h,mipLevelCount:o,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:l},f)}else{let r=this.createTexture({width:t,height:i,layers:d},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,s.format,1,this._commandEncoderForCreation,s.textureUsages,s.textureAdditionalUsages,e.label);s.set(r);let n=e.is3D?1:d,a=c.m.GetDepthFormatOnly(s.format),l=c.m.HasDepthAndStencilAspects(s.format)?"depth-only":"all",h=e.is2DArray?"2d-array":e.is3D?"3d":"2d";s.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+n:""}_${t}x${i}${e.is3D?"x"+d:""}_${u?"wmips":"womips"}_${a}_${h}_${l}_${e.label??"noname"}`,format:a,dimension:h,mipLevelCount:o,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:n,aspect:l},f)}return s}createMSAATexture(e,t,i=!0,r=0){let n=e._hardwareTexture;if(i&&n?.releaseMSAATexture(),!n||(t??1)<=1)return;let a=e.width,o=e.height,s=this.createTexture({width:a,height:o,layers:1},!1,!1,!1,!1,!1,n.format,t,this._commandEncoderForCreation,20,0,e.label?"MSAA_"+e.label:"MSAA");n.setMSAATexture(s,r)}resolveMSAADepthTexture(e,t,i){let r=t.format,n=void 0===i,[o,s]=this._getPipeline(r,a.ResolveDepth);n&&(i=this._device.createCommandEncoder({})),i.pushDebugGroup(`resolve MSAA Depth texture${e.label?" - "+e.label:""}`);let l={label:`BabylonWebGPUDevice${this._engine.uniqueId}_resolveMSAADepthTexture${e.label?"_"+e.label:""}`,colorAttachments:[{view:t,loadOp:"load",storeOp:"store"}]},f=i.beginRenderPass(l),u={layout:s,entries:[{binding:0,resource:e.createView({format:c.m.GetDepthFormatOnly(e.format),dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"depth-only"})}]},d=this._device.createBindGroup(u);f.setPipeline(o),f.setBindGroup(0,d),f.draw(4,1,0,0),f.end(),i.popDebugGroup(),n&&(this._device.queue.submit([i.finish()]),i=null)}updateCubeTextures(e,t,i,r,n,a=!1,o=!1,s=0,l=0){let c=[0,3,1,4,2,5];for(let f=0;f<c.length;++f){let u=e[c[f]];this.updateTexture(u,t,i,r,1,n,f,0,a,o,s,l)}}updateTexture(e,t,i,r,n,a,o=0,l=0,f=!1,u=!1,d=0,h=0,p){let m=c.m.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,_=c.m.GetBlockInformationFromFormat(a),g=c.m.IsInternalTexture(t)?t._hardwareTexture:t,v={texture:m,origin:{x:d,y:h,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:u},S={width:Math.ceil(i/_.width)*_.width,height:Math.ceil(r/_.height)*_.height,depthOrArrayLayers:n||1};if(void 0!==e.byteLength){let E=Math.ceil(i/_.width)*_.length;if(256*Math.ceil(E/256)===E){let t=this._device.createCommandEncoder({}),i=this._bufferManager.createRawBuffer(e.byteLength,s.Sd.MapWrite|s.Sd.CopySrc,!0,"TempBufferForUpdateTexture"+(m?"_"+m.label:""));new Uint8Array(i.getMappedRange()).set(e),i.unmap(),t.copyBufferToTexture({buffer:i,offset:0,bytesPerRow:E,rowsPerImage:S.height/_.height},v,S),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(i)}else this._device.queue.writeTexture(v,e,{offset:0,bytesPerRow:E,rowsPerImage:S.height/_.height},S);if(f||u)if(c.m.IsInternalTexture(t)){let e=0===d&&0===h&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(g,t.width,t.height,a,f,u,o,l,n||1,d,h,e?0:i,e?0:r,void 0,p)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else this._device.queue.copyExternalImageToTexture({source:e,flipY:f},v,S)}readPixels(e,t,i,r,n,a,o=0,l=0,f=null,u=!1){let d=c.m.GetBlockInformationFromFormat(a),h=Math.ceil(r/d.width)*d.length,p=256*Math.ceil(h/256),m=p*n,_=this._bufferManager.createRawBuffer(m,s.Sd.MapRead|s.Sd.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),g=this._device.createCommandEncoder({});return g.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:_,offset:0,bytesPerRow:p},{width:r,height:n,depthOrArrayLayers:1}),this._device.queue.submit([g.finish()]),this._bufferManager.readDataFromBuffer(_,m,r,n,h,p,c.m.GetTextureTypeFromFormat(a),0,f,!0,u)}releaseTexture(e){if(c.m.IsInternalTexture(e)){let t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){let[t,i]=this._deferredReleaseTextures[e];t&&(c.m.IsHardwareTexture(t)?t.release():t.destroy()),i?.dispose()}this._deferredReleaseTextures.length=0}}},46700:function(e,t,i){i.d(t,{e:()=>o});var r=i(81231),n=i(46052),a=i(57480);class o{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new r.A,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new s(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(e){this._enabled=!1,a.V.Error("Could not create a WebGPUDurationMeasure!\nError: "+e.message+"\nMake sure timestamp query is supported and enabled in your browser.");return}else this._measureDuration.dispose()}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then(e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;let i=this._engine.frameId;this._measureDuration.stopPass(e).then(e=>{t._addDuration(i,null!==e&&e>0?e:0)})}dispose(){this._measureDuration?.dispose()}}class s{constructor(e,t,i,r=2,a){this._count=r,this._querySet=new n.L(e,r,"timestamp",t,i,!0,a)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?await this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return await this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}},96892:function(e,t,i){i.d(t,{Y:()=>r});class r{}r.AUTOSAMPLERSUFFIX="Sampler",r.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_MIN=18,r.ALPHA_MAX=19,r.ALPHA_DUAL_SRC0_ADD_SRC1xDST=20,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_R16_UNORM=33322,r.TEXTUREFORMAT_RG16_UNORM=33324,r.TEXTUREFORMAT_RGB16_UNORM=32852,r.TEXTUREFORMAT_RGBA16_UNORM=32859,r.TEXTUREFORMAT_R16_SNORM=36760,r.TEXTUREFORMAT_RG16_SNORM=36761,r.TEXTUREFORMAT_RGB16_SNORM=36762,r.TEXTUREFORMAT_RGBA16_SNORM=36763,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,r.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,r.TEXTUREFORMAT_STENCIL8=19,r.TEXTUREFORMAT_UNDEFINED=0xffffffff,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,r.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,r.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,r.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,r.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_2D=3553,r.TEXTURE_2D_ARRAY=35866,r.TEXTURE_CUBE_MAP=34067,r.TEXTURE_CUBE_MAP_ARRAY=0xdeadbeef,r.TEXTURE_3D=32879,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_ImageProcessingDirtyFlag=64,r.MATERIAL_AllDirtyFlag=127,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR=0,r.MATERIAL_DIFFUSE_MODEL_BURLEY=1,r.MATERIAL_DIFFUSE_MODEL_LAMBERT=2,r.MATERIAL_DIFFUSE_MODEL_LEGACY=3,r.MATERIAL_DIELECTRIC_SPECULAR_MODEL_GLTF=0,r.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR=1,r.MATERIAL_CONDUCTOR_SPECULAR_MODEL_GLTF=0,r.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8,r.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9,r.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10,r.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11,r.PREPASS_ALBEDO_TEXTURE_TYPE=12,r.PREPASS_NORMALIZED_VIEW_DEPTH_TEXTURE_TYPE=13,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.BUFFER_CREATIONFLAG_INDIRECT=64,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r.GL_ALPHA_FUNCTION_SRC1_COLOR=35065,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066,r.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067,r.SnippetUrl="https://snippet.babylonjs.com",r.FOGMODE_NONE=0,r.FOGMODE_EXP=1,r.FOGMODE_EXP2=2,r.FOGMODE_LINEAR=3,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.PositionKind="position",r.NormalKind="normal",r.TangentKind="tangent",r.UVKind="uv",r.UV2Kind="uv2",r.UV3Kind="uv3",r.UV4Kind="uv4",r.UV5Kind="uv5",r.UV6Kind="uv6",r.ColorKind="color",r.ColorInstanceKind="instanceColor",r.MatricesIndicesKind="matricesIndices",r.MatricesWeightsKind="matricesWeights",r.MatricesIndicesExtraKind="matricesIndicesExtra",r.MatricesWeightsExtraKind="matricesWeightsExtra",r.ANIMATIONTYPE_FLOAT=0,r.ANIMATIONTYPE_VECTOR3=1,r.ANIMATIONTYPE_QUATERNION=2,r.ANIMATIONTYPE_MATRIX=3,r.ANIMATIONTYPE_COLOR3=4,r.ANIMATIONTYPE_COLOR4=7,r.ANIMATIONTYPE_VECTOR2=5,r.ANIMATIONTYPE_SIZE=6,r.ShadowMinZ=0,r.ShadowMaxZ=1e4},37702:function(e,t,i){i.d(t,{q:()=>n});var r=i(76937);class n{static get LastCreatedEngine(){return 0===this.Instances.length?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}n.Instances=[],n.OnEnginesDisposedObservable=new r.cP,n._LastCreatedScene=null,n.UseFallbackTexture=!0,n.FallbackTexture=""},25898:function(e,t,i){i.d(t,{IE:()=>u.I,UU:()=>p.UU,dn:()=>p.dn,MT:()=>p.MT,BJ:()=>f.BJ,iR:()=>p.iR,nJ:()=>C.nJ,kA:()=>v.k,Vx:()=>g.V,PR:()=>N.PR,YY:()=>b.Y,$q:()=>m.$,qS:()=>x.q,gl:()=>I.g,vI:()=>P.v,Sd:()=>p.Sd,qQ:()=>s.q,eA:()=>p.eA,WK:()=>c.W,ne:()=>p.ne,Dq:()=>_.D,TK:()=>p.TK,tl:()=>N.tl,Jd:()=>L.J,g7:()=>N.g7,kF:()=>N.kF,ym:()=>p.ym,wB:()=>a.ThinEngine,kZ:()=>f.kZ,Uc:()=>c.U,BX:()=>R.B,jf:()=>N.jf,kX:()=>N.kX,MW:()=>p.MW,dq:()=>h.d,H_:()=>A.H,P8:()=>p.P8,tT:()=>p.tT,bO:()=>p.bO,mE:()=>C.mE,$r:()=>p.$r,Kz:()=>p.Kz,ly:()=>M.l,G8:()=>p.G8,U7:()=>p.U7,Tb:()=>p.Tb,s8:()=>T.s,ID:()=>y.I,GU:()=>p.GU,I0:()=>l.I,Qb:()=>p.Qb,Yl:()=>p.Yl,x_:()=>p.x_,rM:()=>n.r,qd:()=>p.qd,ab:()=>p.ab,YM:()=>r.Y,BG:()=>N.BG,uK:()=>p.uK,fw:()=>p.fw,Rf:()=>S.R,MF:()=>l.M,SD:()=>p.SD,Ag:()=>p.Ag,y2:()=>p.y2,N$:()=>o.N,$l:()=>n.$,dL:()=>p.dL,cc:()=>u.c,Ap:()=>p.Ap,rT:()=>N.rT,xf:()=>p.xf,eG:()=>N.eG,Vs:()=>C.Vs,OR:()=>E.O,Wy:()=>p.Wy,Xk:()=>p.Xk,nC:()=>p.nC,Ld:()=>p.Ld,$s:()=>p.$s,$_:()=>p.$_,Ac:()=>p.Ac,Vz:()=>p.Vz,x1:()=>d.x,Ph:()=>f.Ph,gZ:()=>p.gZ});var r=i(96892),n=i(39393),a=i(32768),o=i(10363),s=i(37702),l=i(24706),c=i(19573),f=i(96288),u=i(81464);i(58953);var d=i(27737),h=i(88003),p=i(11971),m=i(77459),_=i(58358),g=i(90478),v=i(14919),S=i(20230),E=i(65863),T=i(58875),A=i(77462),x=i(93685),I=i(45953),R=i(16370),C=i(66076),b=i(2874),y=i(87962),L=i(31845),M=i(68415),P=i(31581),N=i(5492)},68415:function(e,t,i){i.d(t,{l:()=>r});class r{static GetShadersRepository(e=0){return 0===e?r.ShadersRepository:r.ShadersRepositoryWGSL}static GetShadersStore(e=0){return 0===e?r.ShadersStore:r.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return 0===e?r.IncludesShadersStore:r.IncludesShadersStoreWGSL}}r.ShadersRepository="src/Shaders/",r.ShadersStore={},r.IncludesShadersStore={},r.ShadersRepositoryWGSL="src/ShadersWGSL/",r.ShadersStoreWGSL={},r.IncludesShadersStoreWGSL={}},38212:function(e,t,i){i.d(t,{M:()=>s});var r=i(39393),n=i(57480),a=i(35689),o=i(85279);class s extends r.${constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0,this._debugStackRenderPass=[]}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new o.e:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return null===this._currentRenderTarget}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;if(0!==this._debugStackRenderPass.length)for(let e=0;e<this._debugStackRenderPass.length;++e)this._currentRenderPass.popDebugGroup();let e=this._currentPassIsMainPass()?2:1;return this._snapshotRendering.endRenderPass(this._currentRenderPass)||this.compatibilityMode||(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log("frame #"+this._count+" - "+(2===e?"main":"render target")+" end pass"+(1===e?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._debugPopGroup?.(0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;let i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();let r=e._hardwareTexture.format,o=a.m.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&n.V.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,o,t):this._textureHelper.generateMipmaps(i,r,o,0,e.is3D,t)}}},55049:function(e,t,i){i.d(t,{W:()=>n});var r=i(79806);class n extends r.r{constructor(e,t,i,r,n,a){super(i,a),this._operation=r,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){let t=this.a.getValue(e),i=this.b.getValue(e);return this._operation(t,i)}getClassName(){return this._className}}},79806:function(e,t,i){i.d(t,{r:()=>s});var r=i(16065),n=i(23911);let a="cachedOperationValue",o="cachedExecutionId";class s extends r.e{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e),this.isValid=this.registerDataOutput("isValid",n.RI)}_updateOutputs(e){let t=e._getExecutionVariable(this,o,-1),i=e._getExecutionVariable(this,a,null);if(null!=i&&t===e.executionId)this.isValid.setValue(!0,e),this.value.setValue(i,e);else try{let t=this._doOperation(e);if(null==t)return void this.isValid.setValue(!1,e);e._setExecutionVariable(this,a,t),e._setExecutionVariable(this,o,e.executionId),this.value.setValue(t,e),this.isValid.setValue(!0,e)}catch(t){this.isValid.setValue(!1,e)}}}},83676:function(e,t,i){i.d(t,{H:()=>n});var r=i(79806);class n extends r.r{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation(e)}getClassName(){return this._className}}},64349:function(e,t,i){i.d(t,{q:()=>n});var r=i(79806);class n extends r.r{constructor(e,t,i,r,n,a,o){super(r,o),this._operation=n,this._className=a,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}},87213:function(e,t,i){i.d(t,{a:()=>n});var r=i(79806);class n extends r.r{constructor(e,t,i,r,n){super(t,n),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}}},93219:function(e,t,i){i.d(t,{M:()=>n});var r=i(19601);class n extends r.w{constructor(e,t){if(super(e),this._eventsSignalOutputs={},this.done=this._registerSignalOutput("done"),t)for(const e of t)this._eventsSignalOutputs[e]=this._registerSignalOutput(e+"Event")}_executeOnTick(e){}_startPendingTasks(e){e._getExecutionVariable(this,"_initialized",!1)&&(this._cancelPendingTasks(e),this._resetAfterCanceled(e)),this._preparePendingTasks(e),e._addPendingBlock(this),this.out._activateSignal(e),e._setExecutionVariable(this,"_initialized",!0)}_resetAfterCanceled(e){e._deleteExecutionVariable(this,"_initialized"),e._removePendingBlock(this)}}},19601:function(e,t,i){i.d(t,{w:()=>n});var r=i(53169);class n extends r.u{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}},85768:function(e,t,i){i.d(t,{bQ:()=>o,pi:()=>s});var r=i(52754),n=i(97782),a=i(23933);function o(e,t){return 2*Math.acos((0,r.Clamp)((0,a.FQ)(e,t),-1,1))}function s(e,t){var i,o,s;let l,c,f=new n.PT;return i=e,o=t,s=f,l=n.Pq.Cross(i,o),c=Math.acos((0,r.Clamp)((0,a.G$)(i,o),-1,1)),n.PT.RotationAxisToRef(l,c,s),f}},16336:function(){},75668:function(e,t,i){i.d(t,{r:()=>f});var r=i(69081),n=i(61833),a=i(17023),o=i(585),s=i(94859),l=i(45314),c=i(48330);class f extends n.E{get task(){return this._frameGraphTask}constructor(e,t,i,r=!0,n=!0){super(e,t,i),this._additionalConstructionParameters=[r,n],this.registerInput("target",a.tp.AutoDetect),this.registerInput("depth",a.tp.AutoDetect,!0),this.registerInput("camera",a.tp.Camera),this.registerInput("objects",a.tp.ObjectList),this._addDependenciesInput(),this.registerInput("shadowGenerators",a.tp.AutoDetect,!0),this.registerOutput("output",a.tp.BasedOnInput),this.registerOutput("outputDepth",a.tp.BasedOnInput),this.registerOutput("objectRenderer",a.tp.Object,new l.$("objectRenderer",this,1,f,"NodeRenderGraphBaseObjectRendererBlock")),this.target.addExcludedConnectionPointFromAllowedTypes(a.tp.TextureAllButBackBufferDepthStencil),this.depth.addExcludedConnectionPointFromAllowedTypes(a.tp.TextureDepthStencilAttachment|a.tp.TextureBackBufferDepthStencilAttachment),this.shadowGenerators.addExcludedConnectionPointFromAllowedTypes(a.tp.ShadowGenerator|a.tp.ResourceContainer),this.output._typeConnectionSource=this.target,this.outputDepth._typeConnectionSource=this.depth,this._createFrameGraphObject()}_createFrameGraphObject(){this._frameGraphTask?.dispose(),this._frameGraphTask=new c.H(this.name,this._frameGraph,this._scene,{doNotChangeAspectRatio:this._additionalConstructionParameters[0],enableClusteredLights:this._additionalConstructionParameters[1]})}_saveState(e){e.disabled=this._frameGraphTask.disabled,e.isMainObjectRenderer=this.isMainObjectRenderer,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.disableShadows=this.disableShadows,e.renderInLinearSpace=this.renderInLinearSpace,e.renderParticles=this.renderParticles,e.renderSprites=this.renderSprites,e.forceLayerMaskCheck=this.forceLayerMaskCheck,e.enableBoundingBoxRendering=this.enableBoundingBoxRendering,e.enableOutlineRendering=this.enableOutlineRendering}_restoreState(e){this._frameGraphTask.disabled=e.disabled,this.isMainObjectRenderer=e.isMainObjectRenderer,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.disableShadows=e.disableShadows,this.renderInLinearSpace=e.renderInLinearSpace,this.renderParticles=e.renderParticles,this.renderSprites=e.renderSprites,this.forceLayerMaskCheck=e.forceLayerMaskCheck,this.enableBoundingBoxRendering=e.enableBoundingBoxRendering,this.enableOutlineRendering=e.enableOutlineRendering}_createFrameGraphObjectWithState(e,t){let i={};this._saveState(i),this._additionalConstructionParameters=[e,t],this._createFrameGraphObject(),this._restoreState(i)}get isMainObjectRenderer(){return this._frameGraphTask.isMainObjectRenderer}set isMainObjectRenderer(e){this._frameGraphTask.isMainObjectRenderer=e}get depthTest(){return this._frameGraphTask.depthTest}set depthTest(e){this._frameGraphTask.depthTest=e}get depthWrite(){return this._frameGraphTask.depthWrite}set depthWrite(e){this._frameGraphTask.depthWrite=e}get renderParticles(){return this._frameGraphTask.renderParticles}set renderParticles(e){this._frameGraphTask.renderParticles=e}get renderSprites(){return this._frameGraphTask.renderSprites}set renderSprites(e){this._frameGraphTask.renderSprites=e}get forceLayerMaskCheck(){return this._frameGraphTask.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._frameGraphTask.forceLayerMaskCheck=e}get enableBoundingBoxRendering(){return this._frameGraphTask.enableBoundingBoxRendering}set enableBoundingBoxRendering(e){this._frameGraphTask.enableBoundingBoxRendering=e}get enableOutlineRendering(){return this._frameGraphTask.enableOutlineRendering}set enableOutlineRendering(e){this._frameGraphTask.enableOutlineRendering=e}get disableShadows(){return this._frameGraphTask.disableShadows}set disableShadows(e){this._frameGraphTask.disableShadows=e}get renderInLinearSpace(){return this._frameGraphTask.disableImageProcessing}set renderInLinearSpace(e){this._frameGraphTask.disableImageProcessing=e}get doNotChangeAspectRatio(){return this._frameGraphTask.objectRenderer.options.doNotChangeAspectRatio}set doNotChangeAspectRatio(e){this._createFrameGraphObjectWithState(e,this.enableClusteredLights)}get enableClusteredLights(){return this._frameGraphTask.objectRenderer.options.enableClusteredLights}set enableClusteredLights(e){this._createFrameGraphObjectWithState(this.doNotChangeAspectRatio,e)}get resolveMSAAColors(){return this._frameGraphTask.resolveMSAAColors}set resolveMSAAColors(e){this._frameGraphTask.resolveMSAAColors=e}get resolveMSAADepth(){return this._frameGraphTask.resolveMSAADepth}set resolveMSAADepth(e){this._frameGraphTask.resolveMSAADepth=e}getClassName(){return"NodeRenderGraphBaseObjectRendererBlock"}get target(){return this._inputs[0]}get depth(){return this._inputs[1]}get camera(){return this._inputs[2]}get objects(){return this._inputs[3]}get dependencies(){return this._inputs[4]}get shadowGenerators(){return this._inputs[5]}get output(){return this._outputs[0]}get outputDepth(){return this._outputs[1]}get objectRenderer(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e),this.output.value=this._frameGraphTask.outputTexture,this.outputDepth.value=this._frameGraphTask.outputDepthTexture,this.objectRenderer.value=this._frameGraphTask,this._frameGraphTask.targetTexture=this.target.connectedPoint?.value,this._frameGraphTask.depthTexture=this.depth.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this._frameGraphTask.objectList=this.objects.connectedPoint?.value,this._frameGraphTask.shadowGenerators=[];let t=this.shadowGenerators.connectedPoint;if(t)if(t.type===a.tp.ResourceContainer)for(let e of t.ownerBlock.inputs)e.connectedPoint&&void 0!==e.connectedPoint.value&&s.t.IsShadowGenerator(e.connectedPoint.value)&&this._frameGraphTask.shadowGenerators.push(e.connectedPoint.value);else s.t.IsShadowGenerator(t.value)&&(this._frameGraphTask.shadowGenerators[0]=t.value)}_dumpPropertiesCode(){let e=[];return e.push(`${this._codeVariableName}.isMainObjectRenderer = ${this.isMainObjectRenderer};`),e.push(`${this._codeVariableName}.depthTest = ${this.depthTest};`),e.push(`${this._codeVariableName}.depthWrite = ${this.depthWrite};`),e.push(`${this._codeVariableName}.renderParticles = ${this.renderParticles};`),e.push(`${this._codeVariableName}.renderSprites = ${this.renderSprites};`),e.push(`${this._codeVariableName}.forceLayerMaskCheck = ${this.forceLayerMaskCheck};`),e.push(`${this._codeVariableName}.enableBoundingBoxRendering = ${this.enableBoundingBoxRendering};`),e.push(`${this._codeVariableName}.enableOutlineRendering = ${this.enableOutlineRendering};`),e.push(`${this._codeVariableName}.disableShadows = ${this.disableShadows};`),e.push(`${this._codeVariableName}.renderInLinearSpace = ${this.renderInLinearSpace};`),e.push(`${this._codeVariableName}.resolveMSAAColors = ${this.resolveMSAAColors};`),e.push(`${this._codeVariableName}.resolveMSAADepth = ${this.resolveMSAADepth};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){let e=super.serialize();return e.isMainObjectRenderer=this.isMainObjectRenderer,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.renderParticles=this.renderParticles,e.renderSprites=this.renderSprites,e.forceLayerMaskCheck=this.forceLayerMaskCheck,e.enableBoundingBoxRendering=this.enableBoundingBoxRendering,e.enableOutlineRendering=this.enableOutlineRendering,e.disableShadows=this.disableShadows,e.renderInLinearSpace=this.renderInLinearSpace,e.resolveMSAAColors=this.resolveMSAAColors,e.resolveMSAADepth=this.resolveMSAADepth,e}_deserialize(e){super._deserialize(e),this.isMainObjectRenderer=!!e.isMainObjectRenderer,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.renderParticles=e.renderParticles??!0,this.renderSprites=e.renderSprites??!0,this.forceLayerMaskCheck=e.forceLayerMaskCheck??!0,this.enableBoundingBoxRendering=e.enableBoundingBoxRendering??!0,this.enableOutlineRendering=e.enableOutlineRendering??!0,this.disableShadows=e.disableShadows,this.renderInLinearSpace=!!e.renderInLinearSpace,this.resolveMSAAColors=e.resolveMSAAColors??!0,this.resolveMSAADepth=e.resolveMSAADepth??!1}}(0,r.Cg)([(0,o.u)("Is main object renderer",0,"PROPERTIES")],f.prototype,"isMainObjectRenderer",null),(0,r.Cg)([(0,o.u)("Depth test",0,"PROPERTIES")],f.prototype,"depthTest",null),(0,r.Cg)([(0,o.u)("Depth write",0,"PROPERTIES")],f.prototype,"depthWrite",null),(0,r.Cg)([(0,o.u)("Render particles",0,"PROPERTIES")],f.prototype,"renderParticles",null),(0,r.Cg)([(0,o.u)("Render sprites",0,"PROPERTIES")],f.prototype,"renderSprites",null),(0,r.Cg)([(0,o.u)("Force layer mask check",0,"PROPERTIES")],f.prototype,"forceLayerMaskCheck",null),(0,r.Cg)([(0,o.u)("Enable bounding box rendering",0,"PROPERTIES")],f.prototype,"enableBoundingBoxRendering",null),(0,r.Cg)([(0,o.u)("Enable outline/overlay rendering",0,"PROPERTIES")],f.prototype,"enableOutlineRendering",null),(0,r.Cg)([(0,o.u)("Disable shadows",0,"PROPERTIES")],f.prototype,"disableShadows",null),(0,r.Cg)([(0,o.u)("Disable image processing",0,"PROPERTIES")],f.prototype,"renderInLinearSpace",null),(0,r.Cg)([(0,o.u)("Do not change aspect ratio",0,"PROPERTIES")],f.prototype,"doNotChangeAspectRatio",null),(0,r.Cg)([(0,o.u)("Enable clustered lights",0,"PROPERTIES")],f.prototype,"enableClusteredLights",null),(0,r.Cg)([(0,o.u)("Resolve MSAA colors",0,"PROPERTIES")],f.prototype,"resolveMSAAColors",null),(0,r.Cg)([(0,o.u)("Resolve MSAA depth",0,"PROPERTIES")],f.prototype,"resolveMSAADepth",null)},8703:function(e,t,i){i.d(t,{y:()=>l});var r=i(69081),n=i(61833),a=i(17023),o=i(585),s=i(33012);class l extends n.E{get task(){return this._frameGraphTask}constructor(e,t,i){super(e,t,i),this.registerInput("light",a.tp.ShadowLight),this.registerInput("objects",a.tp.ObjectList),this.registerInput("camera",a.tp.Camera)}_finalizeInputOutputRegistering(){this._addDependenciesInput(),this.registerOutput("generator",a.tp.ShadowGenerator),this.registerOutput("output",a.tp.Texture)}get mapSize(){return this._frameGraphTask.mapSize}set mapSize(e){this._frameGraphTask.mapSize=e}get useFloat32TextureType(){return this._frameGraphTask.useFloat32TextureType}set useFloat32TextureType(e){this._frameGraphTask.useFloat32TextureType=e}get useRedTextureFormat(){return this._frameGraphTask.useRedTextureFormat}set useRedTextureFormat(e){this._frameGraphTask.useRedTextureFormat=e}get bias(){return this._frameGraphTask.bias}set bias(e){this._frameGraphTask.bias=e}get normalBias(){return this._frameGraphTask.normalBias}set normalBias(e){this._frameGraphTask.normalBias=e}get darkness(){return this._frameGraphTask.darkness}set darkness(e){this._frameGraphTask.darkness=e}get filter(){return this._frameGraphTask.filter}set filter(e){this._frameGraphTask.filter=e}get filteringQuality(){return this._frameGraphTask.filteringQuality}set filteringQuality(e){this._frameGraphTask.filteringQuality=e}get transparencyShadow(){return this._frameGraphTask.transparencyShadow}set transparencyShadow(e){this._frameGraphTask.transparencyShadow=e}get enableSoftTransparentShadow(){return this._frameGraphTask.enableSoftTransparentShadow}set enableSoftTransparentShadow(e){this._frameGraphTask.enableSoftTransparentShadow=e}get useOpacityTextureForTransparentShadow(){return this._frameGraphTask.useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){this._frameGraphTask.useOpacityTextureForTransparentShadow=e}getClassName(){return"NodeRenderGraphBaseShadowGeneratorBlock"}get light(){return this._inputs[0]}get objects(){return this._inputs[1]}get camera(){return this._inputs[2]}get generator(){return this._outputs[0]}get output(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e),this._frameGraphTask.light=this.light.connectedPoint?.value,this._frameGraphTask.objectList=this.objects.connectedPoint?.value,this._frameGraphTask.camera=this.camera.connectedPoint?.value,this.generator.value=this._frameGraphTask,this.output.value=this._frameGraphTask.outputTexture}_dumpPropertiesCode(){let e=[];return e.push(`${this._codeVariableName}.mapSize = ${this.mapSize};`),e.push(`${this._codeVariableName}.useFloat32TextureType = ${this.useFloat32TextureType};`),e.push(`${this._codeVariableName}.useRedTextureFormat = ${this.useRedTextureFormat};`),e.push(`${this._codeVariableName}.bias = ${this.bias};`),e.push(`${this._codeVariableName}.normalBias = ${this.normalBias};`),e.push(`${this._codeVariableName}.darkness = ${this.darkness};`),e.push(`${this._codeVariableName}.filter = ${this.filter};`),e.push(`${this._codeVariableName}.filteringQuality = ${this.filteringQuality};`),e.push(`${this._codeVariableName}.transparencyShadow = ${this.transparencyShadow};`),e.push(`${this._codeVariableName}.enableSoftTransparentShadow = ${this.enableSoftTransparentShadow};`),e.push(`${this._codeVariableName}.useOpacityTextureForTransparentShadow = ${this.useOpacityTextureForTransparentShadow};`),super._dumpPropertiesCode()+e.join("\n")}serialize(){let e=super.serialize();return e.mapSize=this.mapSize,e.useFloat32TextureType=this.useFloat32TextureType,e.useRedTextureFormat=this.useRedTextureFormat,e.bias=this.bias,e.normalBias=this.normalBias,e.darkness=this.darkness,e.filter=this.filter,e.filteringQuality=this.filteringQuality,e.transparencyShadow=this.transparencyShadow,e.enableSoftTransparentShadow=this.enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this.useOpacityTextureForTransparentShadow,e}_deserialize(e){super._deserialize(e),this.mapSize=e.mapSize,this.useFloat32TextureType=e.useFloat32TextureType,this.useRedTextureFormat=e.useRedTextureFormat,this.bias=e.bias,this.normalBias=e.normalBias,this.darkness=e.darkness,this.filter=e.filter,this.filteringQuality=e.filteringQuality,this.transparencyShadow=e.transparencyShadow,this.enableSoftTransparentShadow=e.enableSoftTransparentShadow,this.useOpacityTextureForTransparentShadow=e.useOpacityTextureForTransparentShadow}}(0,r.Cg)([(0,o.u)("Map size",5,"PROPERTIES",{options:[{label:"128",value:128},{label:"256",value:256},{label:"512",value:512},{label:"1024",value:1024},{label:"2048",value:2048},{label:"4096",value:4096},{label:"8192",value:8192}]})],l.prototype,"mapSize",null),(0,r.Cg)([(0,o.u)("Use 32 bits float texture type",0,"PROPERTIES")],l.prototype,"useFloat32TextureType",null),(0,r.Cg)([(0,o.u)("Use red texture format",0,"PROPERTIES")],l.prototype,"useRedTextureFormat",null),(0,r.Cg)([(0,o.u)("Bias",1,"PROPERTIES",{min:0,max:1})],l.prototype,"bias",null),(0,r.Cg)([(0,o.u)("Normal bias",1,"PROPERTIES",{min:0,max:1})],l.prototype,"normalBias",null),(0,r.Cg)([(0,o.u)("Darkness",1,"PROPERTIES",{min:0,max:1})],l.prototype,"darkness",null),(0,r.Cg)([(0,o.u)("Filter",5,"PROPERTIES",{options:[{label:"None",value:s.o.FILTER_NONE},{label:"Exponential",value:s.o.FILTER_EXPONENTIALSHADOWMAP},{label:"Poisson Sampling",value:s.o.FILTER_POISSONSAMPLING},{label:"Blur exponential",value:s.o.FILTER_BLUREXPONENTIALSHADOWMAP},{label:"Close exponential",value:s.o.FILTER_CLOSEEXPONENTIALSHADOWMAP},{label:"Blur close exponential",value:s.o.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP},{label:"PCF",value:s.o.FILTER_PCF},{label:"PCSS",value:s.o.FILTER_PCSS}]})],l.prototype,"filter",null),(0,r.Cg)([(0,o.u)("Filter quality",5,"PROPERTIES",{options:[{label:"Low",value:s.o.QUALITY_LOW},{label:"Medium",value:s.o.QUALITY_MEDIUM},{label:"High",value:s.o.QUALITY_HIGH}]})],l.prototype,"filteringQuality",null),(0,r.Cg)([(0,o.u)("Transparency shadow",0,"PROPERTIES")],l.prototype,"transparencyShadow",null),(0,r.Cg)([(0,o.u)("Enable soft transparent shadows",0,"PROPERTIES")],l.prototype,"enableSoftTransparentShadow",null),(0,r.Cg)([(0,o.u)("Use opacity texture for transparent shadows",0,"PROPERTIES")],l.prototype,"useOpacityTextureForTransparentShadow",null)},45314:function(e,t,i){i.d(t,{$:()=>n});var r=i(94859);class n extends r.t{constructor(e,t,i,r,n){super(e,t,i),this._blockType=r,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof n&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}},47342:function(e,t,i){i.d(t,{a:()=>a});var r=i(26536),n=i(80298);class a extends n.C{constructor(e,t,i){super(e,t,i||new r.c(e,t.engine))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.blurTexture)throw Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture and blurTexture are required`);let t=super.record(e,void 0,e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"bloomBlur",this.blurTexture)});return t.addDependencies(this.blurTexture),t}}},30926:function(e,t,i){i.d(t,{Y:()=>o});var r=i(32326),n=i(36624),a=i(97782);class o extends r.g{constructor(e,t,i){super(e,t,i||new n.w(e,t.engine,new a.I9(1,0),10)),this.circleOfConfusionSamplingMode=2}record(e=!1){if(void 0===this.sourceTexture||void 0===this.circleOfConfusionTexture)throw Error(`FrameGraphDepthOfFieldBlurTask "${this.name}": sourceTexture and circleOfConfusionTexture are required`);let t=super.record(e,e=>{e.setTextureSamplingMode(this.circleOfConfusionTexture,this.circleOfConfusionSamplingMode)},e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture)});return t.addDependencies(this.circleOfConfusionTexture),t}}},65377:function(e,t,i){i.d(t,{l:()=>a});var r=i(64165),n=i(80298);class a extends n.C{constructor(e,t,i){super(e,t,i||new r.Z(e,t.engine)),this.blurSteps=[]}record(e=!1){if(void 0===this.sourceTexture||void 0===this.circleOfConfusionTexture||0===this.blurSteps.length)throw Error(`FrameGraphBloomMergeTask "${this.name}": sourceTexture, circleOfConfusionTexture and blurSteps are required`);this.postProcess.updateEffect("#define BLUR_LEVEL "+(this.blurSteps.length-1)+"\n");let t=super.record(e,e=>{e.setTextureSamplingMode(this.blurSteps[this.blurSteps.length-1],2)},e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"circleOfConfusionSampler",this.circleOfConfusionTexture);for(let t=0;t<this.blurSteps.length;t++){let i=this.blurSteps[t];e.bindTextureHandle(this._postProcessDrawWrapper.effect,"blurStep"+(this.blurSteps.length-t-1),i)}});return t.addDependencies(this.circleOfConfusionTexture),t.addDependencies(this.blurSteps),t}}},95576:function(e,t,i){i.d(t,{C:()=>a});var r=i(80298),n=i(93610);class a extends r.C{constructor(e,t,i,r){super(e,t,r||new n.s(e,t.engine,i)),this._isHorizontal=i}record(e=!1){if(void 0===this.sourceTexture||void 0===this.depthTexture)throw Error(`FrameGraphSSAO2BlurTask "${this.name}": sourceTexture and depthTexture are required`);let t=super.record(e,e=>{e.setTextureSamplingMode(this.depthTexture,2)},e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture)});return this.postProcess.textureSize=this._isHorizontal?this._outputWidth:this._outputHeight,t}}},22357:function(e,t,i){i.d(t,{j:()=>a});var r=i(80298),n=i(65129);class a extends r.C{constructor(e,t,i){super(e,t,i||new n.V(e,t.scene)),this._currentCameraMode=-1}record(e=!1){if(void 0===this.sourceTexture||void 0===this.depthTexture||void 0===this.normalTexture||void 0===this.camera)throw Error(`FrameGraphSSAO2Task "${this.name}": sourceTexture, depthTexture, normalTexture and camera are required`);this._currentCameraMode=this.camera.mode,this.postProcess.updateEffect();let t=super.record(e,e=>{this.postProcess.camera=this.camera,this._currentCameraMode!==this.camera.mode&&(this._currentCameraMode=this.camera.mode,this.postProcess.updateEffect()),e.setTextureSamplingMode(this.depthTexture,2),e.setTextureSamplingMode(this.normalTexture,2)},e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"normalSampler",this.normalTexture)});return t.addDependencies([this.depthTexture]),this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,t}}},78504:function(e,t,i){i.d(t,{i:()=>o});var r=i(80298),n=i(21973),a=i(97782);class o extends r.C{constructor(e,t,i){super(e,t,i||new n.k(e,t.engine,new a.I9(1,0),.03))}record(e=!1,t,i){let r=super.record(e,t,i);return this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,r}}},1093:function(e,t,i){i.d(t,{j:()=>a});var r=i(80298),n=i(91793);class a extends r.C{constructor(e,t,i){super(e,t,i||new n.N(e,t.scene))}record(e=!1){if(void 0===this.sourceTexture||void 0===this.normalTexture||void 0===this.depthTexture||void 0===this.reflectivityTexture||void 0===this.camera)throw Error(`FrameGraphSSRTask "${this.name}": sourceTexture, normalTexture, depthTexture, reflectivityTexture and camera are required`);let t=super.record(e,e=>{this.postProcess.camera=this.camera,e.setTextureSamplingMode(this.normalTexture,2),e.setTextureSamplingMode(this.depthTexture,2),e.setTextureSamplingMode(this.reflectivityTexture,2),this.backDepthTexture&&e.setTextureSamplingMode(this.backDepthTexture,1)},e=>{e.bindTextureHandle(this._postProcessDrawWrapper.effect,"normalSampler",this.normalTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"depthSampler",this.depthTexture),e.bindTextureHandle(this._postProcessDrawWrapper.effect,"reflectivitySampler",this.reflectivityTexture),this.backDepthTexture&&e.bindTextureHandle(this._postProcessDrawWrapper.effect,"backDepthSampler",this.backDepthTexture),this.postProcess.enableAutomaticThicknessComputation&&this._postProcessDrawWrapper.effect.setFloat("backSizeFactor",1)});return t.addDependencies([this.normalTexture,this.depthTexture,this.reflectivityTexture]),this.postProcess.textureWidth=this._sourceWidth,this.postProcess.textureHeight=this._sourceHeight,t}}},71862:function(e,t,i){i.d(t,{K:()=>f});var r=i(38241),n=i(89270),a=i(38974),o=i(7445),s=i(43740),l=i(92460),c=i(86859);Object.defineProperty(r.Z.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new a.b(this);let e=this._getComponent(n.v.NAME_GAMEPAD);e||(e=new f(this),this._addComponent(e))}return this._gamepadManager},enumerable:!0,configurable:!0}),o.s.prototype.addGamepad=function(){return this.add(new s.t),this},l.H.prototype.addGamepad=function(){return this.add(new c.Y),this};class f{constructor(e){this.name=n.v.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){let e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}}},1990:function(e,t,i){i.d(t,{z:()=>_});var r=i(57480),n=i(38241),a=i(97782),o=i(46538),s=i(93874),l=i(27550),c=i(14464),f=i(9494),u=i(65113),d=i(95022),h=i(1735);i(46871),i(94473),i(13867);var p=i(19754),m=i(695),_=!0;n.Z.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new c.g("default light",a.Pq.Up(),this)},n.Z.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){let t,r=this.getWorldExtends(e=>e.isVisible&&e.isEnabled()),n=r.max.subtract(r.min),o=r.min.add(n.scale(.5)),s=1.5*n.length();if(isFinite(s)&&0!==s||(s=1,o.copyFromFloats(0,0,0)),e){let e=new d.Lq("default camera",-(Math.PI/2),Math.PI/2,s,o,this);e.lowerRadiusLimit=.01*s,e.wheelPrecision=100/s,t=e}else{let e=new u.S("default camera",new a.Pq(o.x,o.y,-s),this);e.setTarget(o),t=e}t.minZ=.01*s,t.maxZ=1e3*s,t.speed=.2*s,this.activeCamera=t,i&&t.attachControl()}},n.Z.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},n.Z.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,n=0,a=!0){if(!e)return r.V.Warn("Can not create default skybox without environment texture."),null;a&&e&&(this.environmentTexture=e);let c=(0,p.an)("hdrSkyBox",{size:i},this);if(t){let t=new l.PBRMaterial("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=o.g.SKYBOX_MODE),t.microSurface=1-n,t.disableLighting=!0,t.twoSidedLighting=!0,c.material=t}else{let t=new s.F("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=o.g.SKYBOX_MODE),t.disableLighting=!0,c.material=t}return c.isPickable=!1,c.infiniteDistance=!0,c.ignoreCameraMaxZ=!0,c},n.Z.prototype.createDefaultEnvironment=function(e){return f.y?new f.y(e,this):null},n.Z.prototype.createDefaultVRExperience=function(e={}){return new h.L(this,e)},n.Z.prototype.createDefaultXRExperienceAsync=async function(e={}){return await m.u.CreateAsync(this,e)}},72511:function(e,t,i){i.d(t,{N:()=>u});var r=i(89671),n=i(84774),a=i(46538),o=i(26912),s=i(62888),l=i(76937),c=i(97782),f=i(97835);class u extends r.V{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=a.g.CLAMP_ADDRESSMODE,this._texture.wrapV=a.g.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=a.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=a.g.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,r,a=null){super(e,r),this.onError=a,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=u.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new l.cP,this.onLoadObservable=new l.cP,r=this.getScene(),e=e||"textureDome",i.resolution=0|Math.abs(i.resolution)||32,i.clickToPlay=!!i.clickToPlay,i.autoPlay=void 0===i.autoPlay||!!i.autoPlay,i.loop=void 0===i.loop||!!i.loop,i.size=Math.abs(i.size)||(r.activeCamera?.48*r.activeCamera.maxZ:1e3),void 0===i.useDirectMapping?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,void 0===i.faceForward&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=(0,s._6)(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:n.e.BACKSIDE},r);const d=this._material=new o.s(e+"_material",r);d.useEquirectangularFOV=!0,d.fovMultiplier=1,d.opacityFresnel=!1;const h=this._initTexture(t,r,i);if(this.texture=h,this._mesh.material=d,this._mesh.parent=this,this._halfDomeMask=(0,s._6)("",{slice:.5,diameter:.98*i.size,segments:2*i.resolution,sideOrientation:n.e.BACKSIDE},r),this._halfDomeMask.rotate(f._0.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),i.faceForward&&r.activeCamera){const e=r.activeCamera,t=c.Pq.Forward(),i=c.Pq.TransformNormal(t,e.getViewMatrix());i.normalize(),this.rotation.y=Math.acos(c.Pq.Dot(t,i))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case u.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case u.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;let e=.5*!this._halfDome,t=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(i=>{let r=i.isRightCamera;this._crossEye&&(r=!r),r?this._texture.uOffset=e:this._texture.uOffset=t});break}case u.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(e=>{let t=e.isRightCamera;this._crossEye&&(t=!t),this._texture.vOffset=.5*!!t})}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}u.MODE_MONOSCOPIC=0,u.MODE_TOPBOTTOM=1,u.MODE_SIDEBYSIDE=2},41485:function(e,t,i){i.d(t,{U:()=>s});var r=i(45119),n=i(89270),a=i(58490),o=i(37702);(0,i(6243).ji)(n.v.NAME_EFFECTLAYER,(e,t,i,r)=>{if(e.effectLayers){i.effectLayers||(i.effectLayers=[]);for(let n=0;n<e.effectLayers.length;n++){let o=a.p.Parse(e.effectLayers[n],t,r);i.effectLayers.push(o)}}});class s{constructor(e){if(this.name=n.v.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||o.q.LastCreatedScene,!this.scene)return;this._engine=this.scene.getEngine()}register(){this.scene._isReadyForMeshStage.registerStep(n.v.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(n.v.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(n.v.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(n.v.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(n.v.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(n.v.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){for(let e of this.scene.effectLayers)e._rebuild()}serialize(e){for(let t of(e.effectLayers=[],this.scene.effectLayers))t.serialize&&e.effectLayers.push(t.serialize())}addFromContainer(e){if(e.effectLayers)for(let t of e.effectLayers)this.scene.addEffectLayer(t)}removeFromContainer(e,t){if(e.effectLayers)for(let i of e.effectLayers)this.scene.removeEffectLayer(i),t&&i.dispose()}dispose(){let e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){let i=this._engine.currentRenderPassId;for(let r of this.scene.effectLayers){if(!r.hasMesh(e))continue;let n=r._mainTexture;for(let a of(this._engine.currentRenderPassId=n.renderPassId,e.subMeshes))if(!r.isReady(a,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1,i=this.scene.effectLayers;if(i&&i.length>0){for(let n of(this._previousStencilState=this._engine.getStencilBuffer(),i))if(n.shouldRender()&&(!n.camera||n.camera.cameraRigMode===r.i.RIG_MODE_NONE&&e===n.camera||n.camera.cameraRigMode!==r.i.RIG_MODE_NONE&&n.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||n.needStencil();let e=n._mainTexture;e._shouldRender()&&(this.scene.incrementRenderId(),e.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);let t=this.scene.effectLayers;for(let i=0;i<t.length;i++){let r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}a.p._SceneComponentInitialization=e=>{let t=e._getComponent(n.v.NAME_EFFECTLAYER);t||(t=new s(e),e._addComponent(t))}},91335:function(e,t,i){i.d(t,{D:()=>n});var r=i(49477);async function n(){let e=new Uint16Array(16384),t=new Uint16Array(16384),i=new Uint16Array(await r.S0.LoadFileAsync(r.S0.GetAssetUrl("https://assets.babylonjs.com/core/areaLights/areaLightsLTC.bin"))),n=i.length/8;for(let r=0;r<n;r++)e[4*r]=i[8*r],e[4*r+1]=i[8*r+1],e[4*r+2]=i[8*r+2],e[4*r+3]=i[8*r+3],t[4*r]=i[8*r+4],t[4*r+1]=i[8*r+5],t[4*r+2]=i[8*r+6],t[4*r+3]=i[8*r+7];return[e,t]}},65253:function(e,t,i){i.d(t,{Qn:()=>N,Ss:()=>H,lF:()=>D});var r=i(57480),n=i(45119),a=i(97782),o=i(55322),s=i(84774),l=i(59903),c=i(89671),f=i(15335),u=i(91716),d=i(2925),h=i(42955),p=i(49556),m=i(86983),_=i(89270),g=i(48621),v=i(54774),S=i(90802),E=i(75864),T=i(51610),A=i(17428),x=i(87913),I=i(20524),R=i(22518),C=i(92044),b=i(7979),y=i(49477),L=i(88250),M=i(84028),P=i(6243),N=!0;class D{}D.LoaderInjectedPhysicsEngine=void 0;let O={},F={},w={},B=(e,t,i,r)=>{if(!t.materials)return null;for(let n=0,a=t.materials.length;n<a;n++){let a=t.materials[n];if(e(a))return{parsedMaterial:a,material:f.i.Parse(a,i,r)}}return null},U=(e,t,i)=>{for(let r in t)if(e.name===t[r])return i.push(e.id),!0;return void 0!==e.parentId&&-1!==i.indexOf(e.parentId)&&(i.push(e.id),!0)},G=(e,t)=>e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown"),V=(e,t)=>{if(t._waitingData.lods){if(t._waitingData.lods.ids&&t._waitingData.lods.ids.length>0){let i=t._waitingData.lods.ids,r=t.isEnabled(!1);if(t._waitingData.lods.distances){let n=t._waitingData.lods.distances;if(n.length>=i.length){let a=n.length>i.length?n[n.length-1]:0;t.setEnabled(!1);for(let r=0;r<i.length;r++){let a=i[r],o=e.getMeshById(a);null!=o&&t.addLODLevel(n[r],o)}a>0&&t.addLODLevel(a,null),!0===r&&t.setEnabled(!0)}else y.S0.Warn("Invalid level of detail distances for "+t.name)}}t._waitingData.lods=null}},k=(e,t,i)=>{if("number"!=typeof e){let r=i.getLastEntryById(e);return r&&null!=t?r.instances[parseInt(t)]:r}let r=O[e];return r&&null!=t?r.instances[parseInt(t)]:r},z=(e,t)=>"number"!=typeof e?t.getLastMaterialById(e,!0):F[e];function H(e,t,i){return W(e,t,i)}let W=(e,t,i,a,o=!1)=>{let _=new S.WZ(e),g="importScene has failed JSON parse";try{let r,a;var x="object"==typeof t?t:JSON.parse(t);g="";let o=3===v.B.loggingLevel;if(void 0!==x.environmentTexture&&null!==x.environmentTexture){let t=void 0===x.isPBR||x.isPBR;if(x.environmentTextureType&&"BABYLON.HDRCubeTexture"===x.environmentTextureType){let r=x.environmentTextureSize?x.environmentTextureSize:128,n=new h.H((x.environmentTexture.match(/https?:\/\//g)?"":i)+x.environmentTexture,e,r,!0,!t,void 0,x.environmentTexturePrefilterOnLoad);x.environmentTextureRotationY&&(n.rotationY=x.environmentTextureRotationY),e.environmentTexture=n}else if("object"==typeof x.environmentTexture){let t=d.b.Parse(x.environmentTexture,e,i);e.environmentTexture=t}else if(x.environmentTexture.endsWith(".env")){let t=new d.b((x.environmentTexture.match(/https?:\/\//g)?"":i)+x.environmentTexture,e,x.environmentTextureForcedExtension);x.environmentTextureRotationY&&(t.rotationY=x.environmentTextureRotationY),e.environmentTexture=t}else{let t=d.b.CreateFromPrefilteredData((x.environmentTexture.match(/https?:\/\//g)?"":i)+x.environmentTexture,e,x.environmentTextureForcedExtension);x.environmentTextureRotationY&&(t.rotationY=x.environmentTextureRotationY),e.environmentTexture=t}if(!0===x.createDefaultSkybox){let i=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,r=x.skyboxBlurLevel||0;e.createDefaultSkybox(e.environmentTexture,t,i,r)}_.environmentTexture=e.environmentTexture}if(void 0!==x.environmentIntensity&&null!==x.environmentIntensity&&(e.environmentIntensity=x.environmentIntensity),void 0!==x.iblIntensity&&null!==x.iblIntensity&&(e.iblIntensity=x.iblIntensity),void 0!==x.lights&&null!==x.lights)for(r=0,a=x.lights.length;r<a;r++){let t=x.lights[r],i=m.v.Parse(t,e);i&&(O[t.uniqueId]=i,_.lights.push(i),i._parentContainer=_,g+=(0===r?"\n	Lights:":"")+"\n		"+i.toString(o))}if(void 0!==x.reflectionProbes&&null!==x.reflectionProbes)for(r=0,a=x.reflectionProbes.length;r<a;r++){let t=x.reflectionProbes[r],n=C.a.Parse(t,e,i);n&&(_.reflectionProbes.push(n),n._parentContainer=_,g+=(0===r?"\n	Reflection Probes:":"")+"\n		"+n.toString(o))}if(void 0!==x.animations&&null!==x.animations)for(r=0,a=x.animations.length;r<a;r++){let t=x.animations[r],i=(0,b.n9)("BABYLON.Animation");if(i){let n=i.Parse(t);e.animations.push(n),_.animations.push(n),g+=(0===r?"\n	Animations:":"")+"\n		"+n.toString(o)}}if(void 0!==x.materials&&null!==x.materials)for(r=0,a=x.materials.length;r<a;r++){let t=x.materials[r],n=f.i.Parse(t,e,i);if(n)for(let e of(F[t.uniqueId||t.id]=n,_.materials.push(n),n._parentContainer=_,g+=(0===r?"\n	Materials:":"")+"\n		"+n.toString(o),n.getActiveTextures()))-1==_.textures.indexOf(e)&&(_.textures.push(e),e._parentContainer=_)}if(void 0!==x.multiMaterials&&null!==x.multiMaterials)for(r=0,a=x.multiMaterials.length;r<a;r++){let t=x.multiMaterials[r],i=u.F.ParseMultiMaterial(t,e);for(let e of(F[t.uniqueId||t.id]=i,_.multiMaterials.push(i),i._parentContainer=_,g+=(0===r?"\n	MultiMaterials:":"")+"\n		"+i.toString(o),i.getActiveTextures()))-1==_.textures.indexOf(e)&&(_.textures.push(e),e._parentContainer=_)}if(void 0!==x.morphTargetManagers&&null!==x.morphTargetManagers)for(let t of x.morphTargetManagers){let i=A.j.Parse(t,e);w[t.id]=i,_.morphTargetManagers.push(i),i._parentContainer=_}if(void 0!==x.skeletons&&null!==x.skeletons)for(r=0,a=x.skeletons.length;r<a;r++){let t=x.skeletons[r],i=T.E.Parse(t,e);_.skeletons.push(i),i._parentContainer=_,g+=(0===r?"\n	Skeletons:":"")+"\n		"+i.toString(o)}let S=x.geometries;if(null!=S){let t=[],n=S.vertexData;if(null!=n)for(r=0,a=n.length;r<a;r++){let a=n[r];t.push(l.V.Parse(a,e,i))}for(let e of t)e&&(_.geometries.push(e),e._parentContainer=_)}if(void 0!==x.transformNodes&&null!==x.transformNodes)for(r=0,a=x.transformNodes.length;r<a;r++){let t=x.transformNodes[r],n=c.V.Parse(t,e,i);O[t.uniqueId]=n,_.transformNodes.push(n),n._parentContainer=_}if(void 0!==x.meshes&&null!==x.meshes)for(r=0,a=x.meshes.length;r<a;r++){let t=x.meshes[r],n=s.e.Parse(t,e,i);if(O[t.uniqueId]=n,_.meshes.push(n),n._parentContainer=_,n.hasInstances)for(let e of n.instances)_.meshes.push(e),e._parentContainer=_;g+=(0===r?"\n	Meshes:":"")+"\n		"+n.toString(o)}if(void 0!==x.cameras&&null!==x.cameras)for(r=0,a=x.cameras.length;r<a;r++){let t=x.cameras[r],i=n.i.Parse(t,e);O[t.uniqueId]=i,_.cameras.push(i),i._parentContainer=_,g+=(0===r?"\n	Cameras:":"")+"\n		"+i.toString(o)}if(void 0!==x.postProcesses&&null!==x.postProcesses)for(r=0,a=x.postProcesses.length;r<a;r++){let t=x.postProcesses[r],n=L.w.Parse(t,e,i);n&&(_.postProcesses.push(n),n._parentContainer=_,g+=(0===r?"\nPostprocesses:":"")+"\n		"+n.toString())}if(void 0!==x.animationGroups&&null!==x.animationGroups&&x.animationGroups.length){let t=new Map;for(let i=0;i<e.meshes.length;i++)t.has(e.meshes[i].id)||t.set(e.meshes[i].id,e.meshes[i]);for(let i=0;i<e.transformNodes.length;i++)t.has(e.transformNodes[i].id)||t.set(e.transformNodes[i].id,e.transformNodes[i]);for(let i=0;i<e.lights.length;i++)t.has(e.lights[i].id)||t.set(e.lights[i].id,e.lights[i]);for(let i=0;i<e.cameras.length;i++)t.has(e.cameras[i].id)||t.set(e.cameras[i].id,e.cameras[i]);for(let i=0;i<e.skeletons.length;i++){let r=e.skeletons[i];for(let e=0;e<r.bones.length;e++)t.has(r.bones[e].id)||t.set(r.bones[e].id,r.bones[e])}for(r=0,a=x.animationGroups.length;r<a;r++){let i=x.animationGroups[r],n=p.AnimationGroup.Parse(i,e,t);_.animationGroups.push(n),n._parentContainer=_,g+=(0===r?"\n	AnimationGroups:":"")+"\n		"+n.toString(o)}}if(x.spriteManagers)for(let t=0,r=x.spriteManagers.length;t<r;t++){let r=x.spriteManagers[t],n=M.x.Parse(r,e,i);g+="\n		SpriteManager "+n.name}for(r=0,a=e.cameras.length;r<a;r++){let t=e.cameras[r];null!==t._waitingParentId&&(t.parent=k(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(r=0,a=e.lights.length;r<a;r++){let t=e.lights[r];t&&null!==t._waitingParentId&&(t.parent=k(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(r=0,a=e.transformNodes.length;r<a;r++){let t=e.transformNodes[r];null!==t._waitingParentId&&(t.parent=k(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(r=0,a=e.meshes.length;r<a;r++){let t=e.meshes[r];null!==t._waitingParentId&&(t.parent=k(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null),t._waitingData.lods&&V(e,t)}for(let t of e.multiMaterials){for(let i of t._waitingSubMaterialsUniqueIds)t.subMaterials.push(z(i,e));t._waitingSubMaterialsUniqueIds=[]}for(let t of e.meshes)null!==t._waitingMaterialId&&(t.material=z(t._waitingMaterialId,e),t._waitingMaterialId=null);for(let t of e.meshes)null!==t._waitingMorphTargetManagerId&&(t.morphTargetManager=w[t._waitingMorphTargetManagerId],t._waitingMorphTargetManagerId=null);for(r=0,a=e.skeletons.length;r<a;r++){let t=e.skeletons[r];if(t._hasWaitingData){if(null!=t.bones){for(let i of t.bones)if(i._waitingTransformNodeId){let t=e.getLastEntryById(i._waitingTransformNodeId);t&&i.linkTransformNode(t),i._waitingTransformNodeId=null}}t._hasWaitingData=null}}for(r=0,a=e.meshes.length;r<a;r++){let t=e.meshes[r];t._waitingData.freezeWorldMatrix?(t.freezeWorldMatrix(),t._waitingData.freezeWorldMatrix=null):t.computeWorldMatrix(!0)}for(r=0,a=e.lights.length;r<a;r++){let t=e.lights[r];if(t._excludedMeshesIds.length>0){for(let i=0;i<t._excludedMeshesIds.length;i++){let r=e.getMeshById(t._excludedMeshesIds[i]);r&&t.excludedMeshes.push(r)}t._excludedMeshesIds=[]}if(t._includedOnlyMeshesIds.length>0){for(let i=0;i<t._includedOnlyMeshesIds.length;i++){let r=e.getMeshById(t._includedOnlyMeshesIds[i]);r&&t.includedOnlyMeshes.push(r)}t._includedOnlyMeshesIds=[]}}for(let t of e.geometries)t._loadedUniqueId="";for((0,P.oj)(x,e,_,i),r=0,a=e.meshes.length;r<a;r++){let t=e.meshes[r];t._waitingData.actions&&(E.m.Parse(t._waitingData.actions,t,e),t._waitingData.actions=null)}void 0!==x.actions&&null!==x.actions&&E.m.Parse(x.actions,null,e)}catch(t){let e=G("loadAssets",x?x.producer:"Unknown")+g;if(a)a(e,t);else throw r.V.Log(e),t}finally{O={},F={},w={},o||_.removeAllFromScene(),null!==g&&0!==v.B.loggingLevel&&r.V.Log(G("loadAssets",x?x.producer:"Unknown")+(1!==v.B.loggingLevel?g:""))}return _};(0,g.qS)({name:"babylon.js",extensions:".babylon",canDirectLoad:e=>-1!==e.indexOf("babylon"),importMesh:(e,t,i,n,a,o,f,d)=>{let h="importMesh has failed JSON parse";try{var p=JSON.parse(i);h="";let d=3===v.B.loggingLevel;e?Array.isArray(e)||(e=[e]):e=null;let m=[],g=new Map,S=[];if(void 0!==p.transformNodes&&null!==p.transformNodes)for(let e=0,i=p.transformNodes.length;e<i;e++){let i=p.transformNodes[e],r=c.V.Parse(i,t,n);S.push(r),g.set(r._waitingParsedUniqueId,r),r._waitingParsedUniqueId=null}if(void 0!==p.meshes&&null!==p.meshes){let i,o=[],c=[],_=[],v=[];for(let i=0,S=p.meshes.length;i<S;i++){let S=p.meshes[i];if(null===e||U(S,e,m)){if(null!==e&&delete e[e.indexOf(S.name)],void 0!==S.geometryId&&null!==S.geometryId&&void 0!==p.geometries&&null!==p.geometries){let e=!1;for(let i of["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"])if(p.geometries[i]&&Array.isArray(p.geometries[i])){for(let r of p.geometries[i])if(r.id===S.geometryId){"vertexData"===i&&l.V.Parse(r,t,n),e=!0;break}if(e)break}!1===e&&r.V.Warn("Geometry not found for mesh "+S.id)}if(S.materialUniqueId||S.materialId){let e=S.materialUniqueId?_:c,i=-1!==e.indexOf(S.materialUniqueId||S.materialId);if(!1===i&&void 0!==p.multiMaterials&&null!==p.multiMaterials){let r=(i,r)=>{e.push(i);let a=B(r,p,t,n);a&&a.material&&(F[a.parsedMaterial.uniqueId||a.parsedMaterial.id]=a.material,h+="\n	Material "+a.material.toString(d))};for(let n=0,a=p.multiMaterials.length;n<a;n++){let a=p.multiMaterials[n];if(S.materialUniqueId&&a.uniqueId===S.materialUniqueId||a.id===S.materialId){if(a.materialsUniqueIds)for(let e of a.materialsUniqueIds)r(e,t=>t.uniqueId===e);else for(let e of a.materials)r(e,t=>t.id===e);e.push(a.uniqueId||a.id);let n=u.F.ParseMultiMaterial(a,t);F[a.uniqueId||a.id]=n,n&&(i=!0,h+="\n	Multi-Material "+n.toString(d));break}}}if(!1===i){e.push(S.materialUniqueId||S.materialId);let i=B(e=>S.materialUniqueId&&e.uniqueId===S.materialUniqueId||e.id===S.materialId,p,t,n);i&&i.material?(F[i.parsedMaterial.uniqueId||i.parsedMaterial.id]=i.material,h+="\n	Material "+i.material.toString(d)):r.V.Warn("Material not found for mesh "+S.id)}}if(null!==S.skeletonId&&void 0!==S.skeletonId&&-1!==p.skeletonId&&void 0!==p.skeletons&&null!==p.skeletons&&!(o.indexOf(S.skeletonId)>-1))for(let e=0,i=p.skeletons.length;e<i;e++){let i=p.skeletons[e];if(i.id===S.skeletonId){let e=T.E.Parse(i,t);f.push(e),o.push(i.id),h+="\n	Skeleton "+e.toString(d)}}if(S.morphTargetManagerId>-1&&void 0!==p.morphTargetManagers&&null!==p.morphTargetManagers&&!(v.indexOf(S.morphTargetManagerId)>-1))for(let e=0;e<p.morphTargetManagers.length;e++){let i=p.morphTargetManagers[e];if(i.id===S.morphTargetManagerId){let e=A.j.Parse(i,t);w[i.id]=e,v.push(i.id),h+="\nMorph target manager"+e.toString()}}let i=s.e.Parse(S,t,n);a.push(i),g.set(i._waitingParsedUniqueId,i),i._waitingParsedUniqueId=null,h+="\n	Mesh "+i.toString(d)}}for(let e of t.multiMaterials){for(let i of e._waitingSubMaterialsUniqueIds)e.subMaterials.push(z(i,t));e._waitingSubMaterialsUniqueIds=[]}for(let e of t.meshes)null!==e._waitingMaterialId&&(e.material=z(e._waitingMaterialId,t),e._waitingMaterialId=null);for(let e of t.meshes)null!==e._waitingMorphTargetManagerId&&(e.morphTargetManager=w[e._waitingMorphTargetManagerId],e._waitingMorphTargetManagerId=null);for(let e=0,i=t.transformNodes.length;e<i;e++){let i=t.transformNodes[e];if(null!==i._waitingParentId){let e=g.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let r=e;i._waitingParentInstanceIndex&&(r=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=r,i._waitingParentId=null}}for(let e=0,r=t.meshes.length;e<r;e++){if((i=t.meshes[e])._waitingParentId){let e=g.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let r=e;i._waitingParentInstanceIndex&&(r=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=r,i._waitingParentId=null}i._waitingData.lods&&V(t,i)}for(let e of S)e.getChildMeshes(!1).length||e.dispose();for(let e=0,i=t.skeletons.length;e<i;e++){let i=t.skeletons[e];if(i._hasWaitingData){if(null!=i.bones){for(let e of i.bones)if(e._waitingTransformNodeId){let i=t.getLastEntryById(e._waitingTransformNodeId);i&&e.linkTransformNode(i),e._waitingTransformNodeId=null}}i._hasWaitingData=null}}for(let e=0,r=t.meshes.length;e<r;e++)(i=t.meshes[e])._waitingData.freezeWorldMatrix?(i.freezeWorldMatrix(),i._waitingData.freezeWorldMatrix=null):i.computeWorldMatrix(!0)}if(void 0!==p.particleSystems&&null!==p.particleSystems){let e=(0,P.LO)(_.v.NAME_PARTICLESYSTEM);if(e)for(let i=0,r=p.particleSystems.length;i<r;i++){let r=p.particleSystems[i];-1!==m.indexOf(r.emitterId)&&o.push(e(r,t,n))}}for(let e of t.geometries)e._loadedUniqueId="";return!0}catch(t){let e=G("importMesh",p?p.producer:"Unknown")+h;if(d)d(e,t);else throw r.V.Log(e),t}finally{null!==h&&0!==v.B.loggingLevel&&r.V.Log(G("importMesh",p?p.producer:"Unknown")+(1!==v.B.loggingLevel?h:"")),F={},w={}}return!1},load:(e,t,i,n)=>{let s="importScene has failed JSON parse";try{var l=JSON.parse(t);switch(s="",void 0!==l.useDelayedTextureLoading&&null!==l.useDelayedTextureLoading&&(e.useDelayedTextureLoading=l.useDelayedTextureLoading&&!v.B.ForceFullSceneLoadingForIncremental),void 0!==l.autoClear&&null!==l.autoClear&&(e.autoClear=l.autoClear),void 0!==l.clearColor&&null!==l.clearColor&&(e.clearColor=o.ov.FromArray(l.clearColor)),void 0!==l.ambientColor&&null!==l.ambientColor&&(e.ambientColor=o.v9.FromArray(l.ambientColor)),void 0!==l.gravity&&null!==l.gravity&&(e.gravity=a.Pq.FromArray(l.gravity)),void 0!==l.useRightHandedSystem&&(e.useRightHandedSystem=!!l.useRightHandedSystem),void 0!==l.fogMode&&null!==l.fogMode&&(e.fogMode=l.fogMode),void 0!==l.fogColor&&null!==l.fogColor&&(e.fogColor=o.v9.FromArray(l.fogColor)),void 0!==l.fogStart&&null!==l.fogStart&&(e.fogStart=l.fogStart),void 0!==l.fogEnd&&null!==l.fogEnd&&(e.fogEnd=l.fogEnd),void 0!==l.fogDensity&&null!==l.fogDensity&&(e.fogDensity=l.fogDensity),s+="	Fog mode for scene:  ",e.fogMode){case 0:s+="none\n";break;case 1:s+="exp\n";break;case 2:s+="exp2\n";break;case 3:s+="linear\n"}if(l.physicsEnabled){let t;"cannon"===l.physicsEngine||l.physicsEngine===x.O.name?t=new x.O(void 0,void 0,D.LoaderInjectedPhysicsEngine):"oimo"===l.physicsEngine||l.physicsEngine===I.z.name?t=new I.z(void 0,D.LoaderInjectedPhysicsEngine):("ammo"===l.physicsEngine||l.physicsEngine===R.v.name)&&(t=new R.v(void 0,D.LoaderInjectedPhysicsEngine,void 0)),s="	Physics engine "+(l.physicsEngine?l.physicsEngine:"oimo")+" enabled\n";let i=l.gravity?a.Pq.FromArray(l.gravity):l.physicsGravity?a.Pq.FromArray(l.physicsGravity):null;e.enablePhysics(i,t)}if(void 0!==l.metadata&&null!==l.metadata&&(e.metadata=l.metadata),void 0!==l.collisionsEnabled&&null!==l.collisionsEnabled&&(e.collisionsEnabled=l.collisionsEnabled),!W(e,t,i,n,!0))return!1;return l.autoAnimate&&e.beginAnimation(e,l.autoAnimateFrom,l.autoAnimateTo,l.autoAnimateLoop,l.autoAnimateSpeed||1),void 0!==l.activeCameraID&&null!==l.activeCameraID&&e.setActiveCameraById(l.activeCameraID),!0}catch(t){let e=G("importScene",l?l.producer:"Unknown")+s;if(n)n(e,t);else throw r.V.Log(e),t}finally{null!==s&&0!==v.B.loggingLevel&&r.V.Log(G("importScene",l?l.producer:"Unknown")+(1!==v.B.loggingLevel?s:""))}return!1},loadAssetContainer:(e,t,i,r)=>W(e,t,i,r)})},89294:function(e,t,i){i.d(t,{q:()=>a});var r=i(39393),n=i(37702);class a{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._loadingDivToRenderingCanvasMap=new Map,this._resizeLoadingUI=()=>{this._isLoading&&this._loadingDivToRenderingCanvasMap.forEach(([e,t],i)=>{let r=e.getBoundingClientRect();if(this._isCanvasLayoutChanged(t,r)){let t=window.getComputedStyle(e).position;i.style.position="fixed"===t?"fixed":"absolute",i.style.left=r.left+window.scrollX+"px",i.style.top=r.top+window.scrollY+"px",i.style.width=r.width+"px",i.style.height=r.height+"px",this._loadingDivToRenderingCanvasMap.set(i,[e,r])}})}}displayLoadingUI(){if(this._isLoading)return;this._isLoading=!0,this._engine=n.q.Instances.find(e=>e.getRenderingCanvas()===this._renderingCanvas);let e=document.createElement("div");e.id="babylonjsLoadingDiv",e.style.opacity="0",e.style.transition="opacity 1.5s ease",e.style.pointerEvents="none",e.style.display="grid",e.style.gridTemplateRows="100%",e.style.gridTemplateColumns="100%",e.style.justifyItems="center",e.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",e.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style");let t=`@-webkit-keyframes spin1 {\
                            0% { -webkit-transform: rotate(0deg);}
                            100% { -webkit-transform: rotate(360deg);}
                        }\
                        @keyframes spin1 {\
                            0% { transform: rotate(0deg);}
                            100% { transform: rotate(360deg);}
                        }`;this._style.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(this._style);let i=!!window.SVGSVGElement,r=new Image;a.DefaultLogoUrl?r.src=a.DefaultLogoUrl:r.src=i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",r.style.width="150px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";let o=document.createElement("div");o.style.width="300px",o.style.gridColumn="1",o.style.gridRow="1",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.position="absolute";let s=new Image;a.DefaultSpinnerUrl?s.src=a.DefaultSpinnerUrl:s.src=i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",i||(r.style.width="16vh",r.style.height="18.5vh",r.style.left=`calc(50% - ${8}vh)`,r.style.top=`calc(50% - ${9.25}vh)`,s.style.width="30vh",s.style.height="30vh",s.style.left=`calc(50% - ${15}vh)`,s.style.top=`calc(50% - ${15}vh)`),o.appendChild(s),e.appendChild(r),e.appendChild(o),e.style.backgroundColor=this._loadingDivBackgroundColor,e.style.opacity="1";let l=[],c=this._engine.views;if(c?.length)for(let e of c)e.enabled&&l.push(e.target);else l.push(this._renderingCanvas);for(let t=0;t<l.length;t++){let i=l[t],r=e.cloneNode(!0);r.id+=`-${t}`,this._loadingDivToRenderingCanvasMap.set(r,[i,null])}this._resizeLoadingUI(),this._resizeObserver=this._engine.onResizeObservable.add(()=>{this._resizeLoadingUI()}),this._loadingDivToRenderingCanvasMap.forEach((e,t)=>{document.body.appendChild(t)})}hideLoadingUI(){if(!this._isLoading)return;let e=0,t=i=>{let r=i.target;this._loadingDivToRenderingCanvasMap.has(r)&&(e++,r.remove(),e===this._loadingDivToRenderingCanvasMap.size&&(this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("transitionend",t),this._engine.onResizeObservable.remove(this._resizeObserver),this._loadingDivToRenderingCanvasMap.clear(),this._engine=null,this._isLoading=!1))};this._loadingDivToRenderingCanvasMap.forEach((e,t)=>{t.style.opacity="0"}),window.addEventListener("transitionend",t)}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&this._loadingDivToRenderingCanvasMap.forEach((e,t)=>{t.children[0].innerHTML=this._loadingText})}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._isLoading&&this._loadingDivToRenderingCanvasMap.forEach((e,t)=>{t.style.backgroundColor=this._loadingDivBackgroundColor})}_isCanvasLayoutChanged(e,t){return!e||e.left!==t.left||e.top!==t.top||e.right!==t.right||e.bottom!==t.bottom||e.width!==t.width||e.height!==t.height||e.x!==t.x||e.y!==t.y}}a.DefaultLogoUrl="",a.DefaultSpinnerUrl="",r.$.DefaultLoadingScreenFactory=e=>new a(e)},14936:function(e,t,i){i.d(t,{T:()=>n});var r=i(55322);class n{}n.DEFAULT_COLOR=r.v9.White(),n.DEFAULT_WIDTH_ATTENUATED=1,n.DEFAULT_WIDTH=.1},30630:function(e,t,i){var r,n,a,o,s,l;i.d(t,{Yq:()=>a,ZB:()=>n,yo:()=>r}),(o=r||(r={}))[o.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",o[o.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",o[o.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE",(s=n||(n={}))[s.COLOR_MODE_SET=0]="COLOR_MODE_SET",s[s.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",s[s.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY",(l=a||(a={}))[l.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",l[l.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE"},15210:function(e,t,i){i.d(t,{o:()=>u,v:()=>f});var r=i(76312),n=i(92233),a=i(97782),o=i(46319),s=i(7979),l=i(14936),c=i(16178);class f extends o.M{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0,this.GREASED_LINE_USE_OFFSETS=!1}}class u extends n.y{isCompatible(e){return!0}constructor(e,t,i){i=i||{color:l.T.DEFAULT_COLOR};const n=new f;n.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,n.GREASED_LINE_SIZE_ATTENUATION=i.sizeAttenuation??!1,n.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===i.colorDistributionType,n.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(t??e.getScene()).useRightHandedSystem,n.GREASED_LINE_CAMERA_FACING=i.cameraFacing??!0,super(e,u.GREASED_LINE_MATERIAL_NAME,200,n,!0,!0),this.colorsTexture=null,this._forceGLSL=!1,this._forceGLSL=i?.forceGLSL||u.ForceGLSL,this._scene=t??e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=i.cameraFacing??!0,this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.width=i.width?i.width:i.sizeAttenuation?l.T.DEFAULT_WIDTH_ATTENUATED:l.T.DEFAULT_WIDTH,this._sizeAttenuation=i.sizeAttenuation??!1,this.colorMode=i.colorMode??0,this._color=i.color??null,this.useColors=i.useColors??!1,this._colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??r.I.NEAREST_NEAREST,this._colors=i.colors??null,this.dashCount=i.dashCount??1,this.resolution=i.resolution??new a.I9(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=c.F.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??l.T.DEFAULT_COLOR,c.F.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add(()=>{c.F.DisposeEmptyColorsTexture()})}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(e=0){let t=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&t.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),1===e&&t.push({name:"viewProjection",size:16,type:"mat4"}),{ubo:t,vertex:this._cameraFacing&&this._isGLSL(e)?`
                    uniform vec4 grl_aspect_resolution_lineWidth;
                    uniform mat4 grl_projection;
    `:"",fragment:this._isGLSL(e)?`
                    uniform vec4 grl_dashOptions;
                    uniform vec2 grl_textureSize;
                    uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;
                    uniform vec3 grl_singleColor;
    `:""}}get isEnabled(){return!0}bindForSubMesh(e){if(this._cameraFacing){e.updateMatrix("grl_projection",this._scene.getProjectionMatrix()),this._isGLSL(this._material.shaderLanguage)||e.updateMatrix("viewProjection",this._scene.getTransformMatrix());let t=a.AA.Vector4["0"];t.x=this._aspect,t.y=this._resolution.x,t.z=this._resolution.y,t.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",t)}let t=a.AA.Vector4["0"];t.x=c.F.BooleanToNumber(this.useDash),t.y=this._dashArray,t.z=this.dashOffset,t.w=this.dashRatio,e.updateVector4("grl_dashOptions",t);let i=a.AA.Vector4["1"];i.x=this.colorMode,i.y=this.visibility,i.z=this.colorsTexture?this.colorsTexture.getSize().width:0,i.w=c.F.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",i),this._color&&e.updateColor3("grl_singleColor",this._color);let r=this.colorsTexture??l.T.EmptyColorsTexture;e.setTexture("grl_colors",r),e.updateFloat2("grl_textureSize",r?.getSize().width??1,r?.getSize().height??1)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===this._colorsDistributionType,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing,e.GREASED_LINE_USE_OFFSETS=!!i.offsets}getClassName(){return u.GREASED_LINE_MATERIAL_NAME}getCustomCode(e,t=0){if(this._isGLSL(t)){var i=this._cameraFacing;if("vertex"===e){let e={CUSTOM_VERTEX_DEFINITIONS:`
                attribute float grl_widths;
                attribute vec3 grl_offsets;
                attribute float grl_colorPointers;
                varying float grlCounters;
                varying float grlColorPointer;

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute vec4 grl_previousAndSide;
                    attribute vec4 grl_nextAndCounters;

                    vec2 grlFix( vec4 i, float aspect ) {
                        vec2 res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute vec3 grl_slopes;
                    attribute float grl_counters;
                #endif
                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_CAMERA_FACING
                    vec3 grlPositionOffset = grl_offsets;
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                grlColorPointer = grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    float grlAspect = grl_aspect_resolution_lineWidth.x;
                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;

                    vec3 grlPrevious = grl_previousAndSide.xyz;
                    float grlSide = grl_previousAndSide.w;

                    vec3 grlNext = grl_nextAndCounters.xyz;
                    grlCounters = grl_nextAndCounters.w;
                    float grlWidth = grlBaseWidth * grl_widths;
                    
                    vec3 worldDir = normalize(grlNext - grlPrevious);
                    vec3 nearPosition = positionUpdated + (worldDir * 0.01);
                    mat4 grlMatrix = viewProjection * finalWorld;
                    vec4 grlFinalPosition = grlMatrix * vec4(positionUpdated , 1.0);
                    vec4 screenNearPos = grlMatrix * vec4(nearPosition, 1.0);
                    vec2 grlLinePosition = grlFix(grlFinalPosition, grlAspect);
                    vec2 grlLineNearPosition = grlFix(screenNearPos, grlAspect);
                    vec2 grlDir = normalize(grlLineNearPosition - grlLinePosition);

                    vec4 grlNormal = vec4(-grlDir.y, grlDir.x, 0., 1.);

                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
                        grlNormal.xy *= -.5 * grlWidth;
                    #else
                        grlNormal.xy *= .5 * grlWidth;
                    #endif

                    grlNormal *= grl_projection;

                    #ifdef GREASED_LINE_SIZE_ATTENUATION
                        grlNormal.xy *= grlFinalPosition.w;
                        grlNormal.xy /= (vec4(grl_aspect_resolution_lineWidth.yz, 0., 1.) * grl_projection).xy;
                    #endif

                    grlFinalPosition.xy += grlNormal.xy * grlSide;
                    gl_Position = grlFinalPosition;

                    vPositionW = vec3(grlFinalPosition);
                #else
                    grlCounters = grl_counters;
                #endif
                `};return i&&(e["!gl_Position\\=viewProjection\\*worldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    #ifdef PBR
                         #define grlFinalColor finalColor
                    #else
                         #define grlFinalColor color
                    #endif

                    varying float grlCounters;
                    varying float grlColorPointer;
                    uniform sampler2D grl_colors;
                `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;
                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;
                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;
                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;

                    float grlUseDash = grl_dashOptions.x;
                    float grlDashArray = grl_dashOptions.y;
                    float grlDashOffset = grl_dashOptions.z;
                    float grlDashRatio = grl_dashOptions.w;

                    grlFinalColor.a *= step(grlCounters, grlVisibility);
                    if(grlFinalColor.a == 0.) discard;

                    if(grlUseDash == 1.){
                        grlFinalColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));
                        if (grlFinalColor.a == 0.) discard;
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == 0.) {
                            grlFinalColor.rgb = grl_singleColor;
                        } else if (grlColorMode == 1.) {
                            grlFinalColor.rgb += grl_singleColor;
                        } else if (grlColorMode == 2.) {
                            grlFinalColor.rgb *= grl_singleColor;
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);
                            #else
                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));
                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);
                            #endif
                            if (grlColorMode == 0.) {
                                grlFinalColor = grlColor;
                            } else if (grlColorMode == 1.) {
                                grlFinalColor += grlColor;
                            } else if (grlColorMode == 2.) {
                                grlFinalColor *= grlColor;
                            }
                        }
                    #endif
                `}:null}var r=this._cameraFacing;if("vertex"===e){let e={CUSTOM_VERTEX_DEFINITIONS:`
                attribute grl_widths: f32;
                attribute grl_colorPointers: f32;
                varying grlCounters: f32;
                varying grlColorPointer: f32;

                #ifdef GREASED_LINE_USE_OFFSETS
                    attribute grl_offsets: vec3f;   
                #endif

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute grl_previousAndSide : vec4f;
                    attribute grl_nextAndCounters : vec4f;

                    fn grlFix(i: vec4f, aspect: f32) -> vec2f {
                        var res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute grl_slopes: f32;
                    attribute grl_counters: f32;
                #endif


                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_USE_OFFSETS
                    var grlPositionOffset: vec3f = input.grl_offsets;
                #else
                    var grlPositionOffset = vec3f(0.);
                #endif

                #ifdef GREASED_LINE_CAMERA_FACING
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grlPositionOffset) + (input.grl_slopes * input.grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                vertexOutputs.grlColorPointer = input.grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    let grlAspect: f32 = uniforms.grl_aspect_resolution_lineWidth.x;
                    let grlBaseWidth: f32 = uniforms.grl_aspect_resolution_lineWidth.w;

                    let grlPrevious: vec3f = input.grl_previousAndSide.xyz;
                    let grlSide: f32 = input.grl_previousAndSide.w;

                    let grlNext: vec3f = input.grl_nextAndCounters.xyz;
                    vertexOutputs.grlCounters = input.grl_nextAndCounters.w;

                    let grlWidth: f32 = grlBaseWidth * input.grl_widths;

                    let worldDir: vec3f = normalize(grlNext - grlPrevious);
                    let nearPosition: vec3f = positionUpdated + (worldDir * 0.01);
                    let grlMatrix: mat4x4f = uniforms.viewProjection * finalWorld;
                    let grlFinalPosition: vec4f = grlMatrix * vec4f(positionUpdated, 1.0); 
                    let screenNearPos: vec4f = grlMatrix * vec4(nearPosition, 1.0);
                    let grlLinePosition: vec2f = grlFix(grlFinalPosition, grlAspect);
                    let grlLineNearPosition: vec2f = grlFix(screenNearPos, grlAspect);
                    let grlDir: vec2f = normalize(grlLineNearPosition - grlLinePosition);

                    var grlNormal: vec4f = vec4f(-grlDir.y, grlDir.x, 0.0, 1.0);

                    let grlHalfWidth: f32 = 0.5 * grlWidth;
                    #if defined(GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM)
                        grlNormal.x *= -grlHalfWidth;
                        grlNormal.y *= -grlHalfWidth;
                    #else
                        grlNormal.x *= grlHalfWidth;
                        grlNormal.y *= grlHalfWidth;
                    #endif

                    grlNormal *= uniforms.grl_projection;

                    #if defined(GREASED_LINE_SIZE_ATTENUATION)
                        grlNormal.x *= grlFinalPosition.w;
                        grlNormal.y *= grlFinalPosition.w;

                        let pr = vec4f(uniforms.grl_aspect_resolution_lineWidth.yz, 0.0, 1.0) * uniforms.grl_projection;
                        grlNormal.x /= pr.x;
                        grlNormal.y /= pr.y;
                    #endif

                    vertexOutputs.position = vec4f(grlFinalPosition.xy + grlNormal.xy * grlSide, grlFinalPosition.z, grlFinalPosition.w);
                    vertexOutputs.vPositionW = vertexOutputs.position.xyz;
                
                #else
                    vertexOutputs.grlCounters = input.grl_counters;
                #endif
                `};return r&&(e["!vertexOutputs\\.position\\s=\\sscene\\.viewProjection\\s\\*\\sworldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    #ifdef PBR
                         #define grlFinalColor finalColor
                    #else
                         #define grlFinalColor color
                    #endif

                    varying grlCounters: f32;
                    varying grlColorPointer: 32;

                    var grl_colors: texture_2d<f32>;
                    var grl_colorsSampler: sampler;
                `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                    let grlColorMode: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.x;
                    let grlVisibility: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.y;
                    let grlColorsWidth: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.z;
                    let grlUseColors: f32 = uniforms.grl_colorMode_visibility_colorsWidth_useColors.w;

                    let grlUseDash: f32 = uniforms.grl_dashOptions.x;
                    let grlDashArray: f32 = uniforms.grl_dashOptions.y;
                    let grlDashOffset: f32 = uniforms.grl_dashOptions.z;
                    let grlDashRatio: f32 = uniforms.grl_dashOptions.w;

                    grlFinalColor.a *= step(fragmentInputs.grlCounters, grlVisibility);
                    if (grlFinalColor.a == 0.0) {
                        discard;
                    }

                    if (grlUseDash == 1.0) {
                        let dashPosition = (fragmentInputs.grlCounters + grlDashOffset) % grlDashArray;
                        grlFinalColor.a *= ceil(dashPosition - (grlDashArray * grlDashRatio));

                        if (grlFinalColor.a == 0.0) {
                            discard;
                        }
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == 0.) {
                            grlFinalColor = vec4f(uniforms.grl_singleColor, grlFinalColor.a);
                        } else if (grlColorMode == 1.) {
                            grlFinalColor += vec4f(uniforms.grl_singleColor, grlFinalColor.a);
                        } else if (grlColorMode == 2.) {
                            grlFinalColor *= vec4f(uniforms.grl_singleColor, grlFinalColor.a);
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, vec2f(fragmentInputs.grlCounters, 0.));
                            #else
                                let lookup: vec2f = vec2(fract(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x), 1.0 - floor(fragmentInputs.grlColorPointer / uniforms.grl_textureSize.x) / max(uniforms.grl_textureSize.y - 1.0, 1.0));
                                let grlColor: vec4f = textureSample(grl_colors, grl_colorsSampler, lookup);
                            #endif
                            if (grlColorMode == 0.) {
                                grlFinalColor = grlColor;
                            } else if (grlColorMode == 1.) {
                                grlFinalColor += grlColor;
                            } else if (grlColorMode == 2.) {
                                grlFinalColor *= grlColor;
                            }
                        }
                    #endif


                `}:null}dispose(){this.colorsTexture?.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){let r=this._colors?.length??0;if(this._colors=e,null===e||0===e.length)return void this.colorsTexture?.dispose();if(!t||i)if(this.colorsTexture&&r===e.length&&!i){let t=c.F.Color3toRGBAUint8(e);this.colorsTexture.update(t)}else this.colorsTexture?.dispose(),this.colorsTexture=c.F.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){null===this._color&&null!==e||null!==this._color&&null===e?(this._color=e,t||this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){let e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){super.parse(e,t,i);let r=e.greasedLineMaterialOptions;this.colorsTexture?.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=c.F.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):c.F.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){e.colorsTexture?.dispose(),this._colors&&(e.colorsTexture=c.F.CreateColorsTexture(`${e._material.name}-colors-texture`,this._colors,e.colorsSampling,this._scene)),e.setColor(this.color,!0),e.colorsDistributionType=this.colorsDistributionType,e.colorsSampling=this.colorsSampling,e.colorMode=this.colorMode,e.useColors=this.useColors,e.visibility=this.visibility,e.useDash=this.useDash,e.dashCount=this.dashCount,e.dashRatio=this.dashRatio,e.dashOffset=this.dashOffset,e.width=this.width,e.sizeAttenuation=this.sizeAttenuation,e.resolution=this.resolution,e.markAllDefinesAsDirty()}_isGLSL(e){return 0===e||this._forceGLSL}}u.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",u.ForceGLSL=!1,(0,s.Y5)(`BABYLON.${u.GREASED_LINE_MATERIAL_NAME}`,u)},33500:function(e,t,i){i.d(t,{B:()=>f,h:()=>u});var r=i(76312),n=i(95298),a=i(55322),o=i(97782),s=i(82688),l=i(16178),c=i(14936);let f="GREASED_LINE_USE_OFFSETS";class u extends n.B{constructor(e,t,n){const f=t.getEngine(),d=f.isWebGPU&&!(n.forceGLSL||u.ForceGLSL),h=["COLOR_DISTRIBUTION_TYPE_LINE 1.","COLOR_DISTRIBUTION_TYPE_SEGMENT 0.","COLOR_MODE_SET 0.","COLOR_MODE_ADD 1.","COLOR_MODE_MULTIPLY 2."];t.useRightHandedSystem&&h.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM");const p=["position","grl_widths","grl_offsets","grl_colorPointers"];n.cameraFacing?(h.push("GREASED_LINE_CAMERA_FACING"),p.push("grl_previousAndSide","grl_nextAndCounters")):(p.push("grl_slopes"),p.push("grl_counters"));const m=["grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility","grlColors"];if(d||m.push("world","viewProjection","view","projection"),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{uniformBuffers:d?["Scene","Mesh"]:void 0,attributes:p,uniforms:m,samplers:d?[]:["grlColors"],defines:h,extraInitializationsAsync:async()=>{d?await Promise.all([Promise.resolve().then(i.bind(i,96904)),Promise.resolve().then(i.bind(i,8658))]):await Promise.all([Promise.resolve().then(i.bind(i,3911)),Promise.resolve().then(i.bind(i,15117))])},shaderLanguage:+!!d}),this._color=a.v9.White(),this._colorsDistributionType=0,this._colorsTexture=null,n=n||{color:c.T.DEFAULT_COLOR},this.visibility=n.visibility??1,this.useDash=n.useDash??!1,this.dashRatio=n.dashRatio??.5,this.dashOffset=n.dashOffset??0,this.dashCount=n.dashCount??1,this.width=n.width?n.width:n.sizeAttenuation&&n.cameraFacing?c.T.DEFAULT_WIDTH_ATTENUATED:c.T.DEFAULT_WIDTH,this.sizeAttenuation=n.sizeAttenuation??!1,this.color=n.color??a.v9.White(),this.useColors=n.useColors??!1,this.colorsDistributionType=n.colorDistributionType??0,this.colorsSampling=n.colorsSampling??r.I.NEAREST_NEAREST,this.colorMode=n.colorMode??0,this._colors=n.colors??null,this._cameraFacing=n.cameraFacing??!0,this.resolution=n.resolution??new o.I9(f.getRenderWidth(),f.getRenderHeight()),n.colorsTexture?this.colorsTexture=n.colorsTexture:this._colors?this.colorsTexture=l.F.CreateColorsTexture(`${this.name}-colors-texture`,this._colors,this.colorsSampling,t):(this._color=this._color??c.T.DEFAULT_COLOR,this.colorsTexture=l.F.PrepareEmptyColorsTexture(t)),d){const e=new s.u;e.setParameters(),e.samplingMode=this.colorsSampling,this.setTextureSampler("grlColorsSampler",e)}f.onDisposeObservable.add(()=>{l.F.DisposeEmptyColorsTexture()})}dispose(){this._colorsTexture?.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new o.I9(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){let r=this._colors?.length??0;if(this._colors=e,null===e||0===e.length)return void this._colorsTexture?.dispose();if(!t||i)if(this._colorsTexture&&r===e.length&&!i){let t=l.F.Color3toRGBAUint8(e);this._colorsTexture.update(t)}else this._colorsTexture?.dispose(),this.colorsTexture=l.F.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",l.F.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",l.F.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",l.F.BooleanToNumber(e))}get color(){return this._color}set color(e){this.setColor(e)}setColor(e){e=e??c.T.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){let e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){let r=e.greasedLineMaterialOptions;this._colorsTexture?.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=l.F.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=l.F.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}u.ForceGLSL=!1},29858:function(e,t,i){i.d(t,{k:()=>u});var r=i(38215),n=i(55301),a=i(37722),o=i(7979),s=i(46538),l=i(20540),c=i(88224),f=i(37702);class u extends r.N{get texture(){return this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??f.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,t=>t.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,a.n.VertexAndFragment),this.registerOutput("source",n.y.Object,a.n.VertexAndFragment,new c.s("source",this,1,u,"ImageSourceBlock")),this.registerOutput("dimensions",n.y.Vector2)}bind(e,t){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!this.texture||!!this.texture.isReadyOrNotBlocking()}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),e.target===a.n.Vertex&&(this._samplerName=e._getFreeVariableName(this.name),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let t="";t=1===e.shaderLanguage?`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${t};
`}return this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(e=!1){let t=super._dumpPropertiesCode();return!this.texture||e?t:(t+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,t+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,t+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,t+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,t+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,t+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,t+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,t+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,t+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,t+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,t+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`)}serialize(e=!1){let t=super.serialize();return!e&&this.texture&&(l.M.AllowSerializationOfRenderTargetTextures||!this.texture.isRenderTarget)&&"VideoTexture"!==this.texture.getClassName()&&(t.texture=this.texture.serialize()),t}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!l.M.IgnoreTexturesAtLoadTime&&(void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url)),(e.texture.base64String||void 0!==e.texture.url)&&(this.texture=s.g.Parse(e.texture,t,i)))}}(0,o.Y5)("BABYLON.ImageSourceBlock",u)},1326:function(e,t,i){i.d(t,{B:()=>a});var r=i(7979),n=i(40088);class a extends n.l{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};
`,this}}(0,r.Y5)("BABYLON.AddBlock",a)},70174:function(e,t,i){i.d(t,{z:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("x",n.y.Float),this.registerInput("y",n.y.Float),this.registerOutput("output",n.y.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=1===e.shaderLanguage?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.ArcTan2Block",s)},40088:function(e,t,i){i.d(t,{l:()=>o});var r=i(37722),n=i(38215),a=i(55301);class o extends n.N{constructor(e){super(e,r.n.Neutral),this.registerInput("left",a.y.AutoDetect),this.registerInput("right",a.y.AutoDetect),this.registerOutput("output",a.y.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(a.y.Float),this.right.acceptedConnectionPointTypes.push(a.y.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===a.y.Int||this.left.type===a.y.Float&&this.right.type!==a.y.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[a.y.Int,a.y.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===a.y.Int||t.type===a.y.Float)&&e.acceptedConnectionPointTypes.push(a.y.Vector2,a.y.Vector3,a.y.Vector4,a.y.Color3,a.y.Color4,a.y.Matrix))}dispose(){for(let e of(super.dispose(),this._connectionObservers))e.remove();this._connectionObservers.length=0}}},93986:function(e,t,i){i.d(t,{Z:()=>a});var r=i(7979),n=i(40088);class a extends n.l{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};
`,this}}(0,r.Y5)("BABYLON.DivideBlock",a)},8453:function(e,t,i){i.d(t,{A:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("value",n.y.AutoDetect),this.registerOutput("output",n.y.Float),this._inputs[0].excludedConnectionPointTypes.push(n.y.Float),this._inputs[0].excludedConnectionPointTypes.push(n.y.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.LengthBlock",s)},35930:function(e,t,i){i.d(t,{f:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("left",n.y.AutoDetect),this.registerInput("right",n.y.AutoDetect),this.registerInput("gradient",n.y.AutoDetect),this.registerOutput("output",n.y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(n.y.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.LerpBlock",s)},19697:function(e,t,i){i.d(t,{g:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("left",n.y.AutoDetect),this.registerInput("right",n.y.AutoDetect),this.registerOutput("output",n.y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.MaxBlock",s)},423:function(e,t,i){i.d(t,{e:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("left",n.y.AutoDetect),this.registerInput("right",n.y.AutoDetect),this.registerOutput("output",n.y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.MinBlock",s)},52312:function(e,t,i){i.d(t,{r:()=>f});var r=i(69081),n=i(38215),a=i(55301),o=i(37722),s=i(7979),l=i(97782),c=i(585);class f extends n.N{constructor(e){super(e,o.n.Neutral),this.sourceRange=new l.I9(-1,1),this.targetRange=new l.I9(0,1),this.registerInput("input",a.y.AutoDetect),this.registerInput("sourceMin",a.y.Float,!0),this.registerInput("sourceMax",a.y.Float,!0),this.registerInput("targetMin",a.y.Float,!0),this.registerInput("targetMax",a.y.Float,!0),this.registerOutput("output",a.y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),a=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${n} + (${this._inputs[0].associatedVariableName} - ${i}) * (${a} - ${n}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`}serialize(){let e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=l.I9.FromArray(e.sourceRange),this.targetRange=l.I9.FromArray(e.targetRange)}}(0,r.Cg)([(0,c.u)("From",3)],f.prototype,"sourceRange",void 0),(0,r.Cg)([(0,c.u)("To",3)],f.prototype,"targetRange",void 0),(0,s.Y5)("BABYLON.RemapBlock",f)},38597:function(e,t,i){i.d(t,{a:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("value",n.y.AutoDetect),this.registerInput("edge0",n.y.Float),this.registerInput("edge1",n.y.Float),this.registerOutput("output",n.y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.SmoothStepBlock",s)},77879:function(e,t,i){i.d(t,{e:()=>s});var r=i(38215),n=i(55301),a=i(37722),o=i(7979);class s extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("value",n.y.Float),this.registerInput("edge",n.y.Float),this.registerOutput("output",n.y.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});
`,this}}(0,o.Y5)("BABYLON.StepBlock",s)},85825:function(e,t,i){i.d(t,{_:()=>a});var r=i(7979),n=i(40088);class a extends n.l{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};
`,this}}(0,r.Y5)("BABYLON.SubtractBlock",a)},62852:function(e,t,i){i.d(t,{P:()=>p});var r=i(69081),n=i(38215),a=i(55301),o=i(37722),s=i(20540),l=i(7979),c=i(46538);i(34450);var f=i(29858),u=i(88224),d=i(37702),h=i(585);class p extends n.N{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??d.q.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,t=>t.hasTexture(e))}get textureY(){return this.sourceY.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}get textureZ(){return this.sourceZ?.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){let e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){return this._getImageSourceBlock(this.sourceY)?.samplerName??null}get samplerZName(){return this._getImageSourceBlock(this.sourceZ)?.samplerName??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){let e=this.texture.getScene()??d.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,e=>e.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){let e=this.texture.getScene()??d.q.LastCreatedScene;e?.markAllMaterialsAsDirty(1,e=>e.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,o.n.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",a.y.AutoDetect,!1),this.registerInput("normal",a.y.AutoDetect,!1),this.registerInput("sharpness",a.y.Float,!0),this.registerInput("source",a.y.Object,!0,o.n.VertexAndFragment,new u.s("source",this,0,f.k,"ImageSourceBlock")),this.registerInput("sourceY",a.y.Object,!0,o.n.VertexAndFragment,new u.s("sourceY",this,0,f.k,"ImageSourceBlock")),t||this.registerInput("sourceZ",a.y.Object,!0,o.n.VertexAndFragment,new u.s("sourceZ",this,0,f.k,"ImageSourceBlock")),this.registerOutput("rgba",a.y.Color4,o.n.Neutral),this.registerOutput("rgb",a.y.Color3,o.n.Neutral),this.registerOutput("r",a.y.Float,o.n.Neutral),this.registerOutput("g",a.y.Float,o.n.Neutral),this.registerOutput("b",a.y.Float,o.n.Neutral),this.registerOutput("a",a.y.Float,o.n.Neutral),this.registerOutput("level",a.y.Float,o.n.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(a.y.Color3|a.y.Vector3|a.y.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(a.y.Color3|a.y.Vector3|a.y.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e){if(!e._areTexturesDirty)return;let t=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,i=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;e.setValue(this._linearDefineName,t,!0),e.setValue(this._gammaDefineName,i,!0)}isReady(){return!this.texture||!!this.texture.isReadyOrNotBlocking()}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return 1===e.shaderLanguage?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return 1===i.shaderLanguage?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){let t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",o=e._getFreeVariableName("x"),s=e._getFreeVariableName("y"),l=e._getFreeVariableName("z"),c=e._getFreeVariableName("w"),f=e._getFreeVariableName("n"),u=e._getFreeVariableName("uvx"),d=e._getFreeVariableName("uvy"),h=e._getFreeVariableName("uvz");e.compilationString+=`
            ${e._declareLocalVar(f,a.y.Vector3)} = ${this.normal.associatedVariableName}.xyz;

            ${e._declareLocalVar(u,a.y.Vector2)} = ${this.position.associatedVariableName}.yz;
            ${e._declareLocalVar(d,a.y.Vector2)} = ${this.position.associatedVariableName}.zx;
            ${e._declareLocalVar(h,a.y.Vector2)} = ${this.position.associatedVariableName}.xy;
        `,this.projectAsCube&&(e.compilationString+=`
                ${u}.xy = ${u}.yx;

                if (${f}.x >= 0.0) {
                    ${u}.x = -${u}.x;
                }
                if (${f}.y < 0.0) {
                    ${d}.y = -${d}.y;
                }
                if (${f}.z < 0.0) {
                    ${h}.x = -${h}.x;
                }
            `);let p=e.fSuffix;e.compilationString+=`
            ${e._declareLocalVar(o,a.y.Vector4)} = ${this._generateTextureSample(t,u,e)};
            ${e._declareLocalVar(s,a.y.Vector4)} = ${this._generateTextureSample(i,d,e)};
            ${e._declareLocalVar(l,a.y.Vector4)} = ${this._generateTextureSample(r,h,e)};
           
            // blend weights
            ${e._declareLocalVar(c,a.y.Vector3)} = pow(abs(${f}), vec3${p}(${n}));

            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,a.y.Vector4)} = (${o}*${c}.x + ${s}*${c}.y + ${l}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        
        `}_generateConversionCode(e,t,i){let r="";1===e.shaderLanguage&&(t.type===a.y.Vector3||t.type===a.y.Color3)&&(r="Vec3"),"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${1===e.shaderLanguage?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=`//${this.name}`;for(let i of(e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,a.y.Float),this._generateTextureLookup(e),this._outputs))i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return(e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};
`,this.texture)?(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`):e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!s.M.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=c.g.Parse(e.texture,t,i))}}(0,r.Cg)([(0,h.u)("Project as cube",0,"ADVANCED",{embedded:!0,notifiers:{update:!0}})],p.prototype,"projectAsCube",void 0),(0,l.Y5)("BABYLON.TriPlanarBlock",p)},20552:function(e,t,i){i.d(t,{$:()=>n,D:()=>u});var r,n,a=i(69081),o=i(38215),s=i(55301),l=i(37722),c=i(7979),f=i(585);(r=n||(n={}))[r.Cos=0]="Cos",r[r.Sin=1]="Sin",r[r.Abs=2]="Abs",r[r.Exp=3]="Exp",r[r.Exp2=4]="Exp2",r[r.Round=5]="Round",r[r.Floor=6]="Floor",r[r.Ceiling=7]="Ceiling",r[r.Sqrt=8]="Sqrt",r[r.Log=9]="Log",r[r.Tan=10]="Tan",r[r.ArcTan=11]="ArcTan",r[r.ArcCos=12]="ArcCos",r[r.ArcSin=13]="ArcSin",r[r.Fract=14]="Fract",r[r.Sign=15]="Sign",r[r.Radians=16]="Radians",r[r.Degrees=17]="Degrees",r[r.Set=18]="Set";class u extends o.N{constructor(e){super(e,l.n.Neutral),this.operation=n.Cos,this.registerInput("input",s.y.AutoDetect),this.registerOutput("output",s.y.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i="";switch(this.operation){case n.Cos:i="cos";break;case n.Sin:i="sin";break;case n.Abs:i="abs";break;case n.Exp:i="exp";break;case n.Exp2:i="exp2";break;case n.Round:i="round";break;case n.Floor:i="floor";break;case n.Ceiling:i="ceil";break;case n.Sqrt:i="sqrt";break;case n.Log:i="log";break;case n.Tan:i="tan";break;case n.ArcTan:i="atan";break;case n.ArcCos:i="acos";break;case n.ArcSin:i="asin";break;case n.Fract:i="fract";break;case n.Sign:i="sign";break;case n.Radians:i="radians";break;case n.Degrees:i="degrees";break;case n.Set:i=""}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${n[this.operation]};
`}}(0,a.Cg)([(0,f.u)("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:n.Cos},{label:"Sin",value:n.Sin},{label:"Abs",value:n.Abs},{label:"Exp",value:n.Exp},{label:"Exp2",value:n.Exp2},{label:"Round",value:n.Round},{label:"Floor",value:n.Floor},{label:"Ceiling",value:n.Ceiling},{label:"Sqrt",value:n.Sqrt},{label:"Log",value:n.Log},{label:"Tan",value:n.Tan},{label:"ArcTan",value:n.ArcTan},{label:"ArcCos",value:n.ArcCos},{label:"ArcSin",value:n.ArcSin},{label:"Fract",value:n.Fract},{label:"Sign",value:n.Sign},{label:"Radians",value:n.Radians},{label:"Degrees",value:n.Degrees},{label:"Set",value:n.Set}]})],u.prototype,"operation",void 0),(0,c.Y5)("BABYLON.TrigonometryBlock",u)},42489:function(e,t,i){i.d(t,{W:()=>c});var r=i(38215),n=i(55301),a=i(37722),o=i(7979),s=i(86728),l=i(42882);class c extends r.N{constructor(e){super(e,a.n.Neutral),this.registerInput("worldPosition",n.y.Vector4),this.registerInput("cameraPosition",n.y.Vector3),this.registerOutput("output",n.y.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===s.Z.CameraPosition&&t(e));i||(i=new l.O("cameraPosition")).setAsSystemValue(s.Z.CameraPosition),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);
`,this}}(0,o.Y5)("BABYLON.ViewDirectionBlock",c)},77073:function(e,t,i){i.d(t,{f:()=>c});var r=i(55301),n=i(37722),a=i(68415),o=i(12252),s=i(2818),l=i(57480);class c{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._injectAtTop="",this._customEntryHeader="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return 1===this.shaderLanguage?"f":""}async getProcessedShaderAsync(e){if(!this._builtCompilationString)return l.V.Error("getProcessedShaderAsync: Shader not built yet."),"";let t=this.sharedData.nodeMaterial.getScene().getEngine(),i={defines:e.split("\n"),indexParameters:void 0,isFragment:this.target===n.n.Fragment,shouldUseHighPrecisionShader:t._shouldUseHighPrecisionShader,processor:t._getShaderProcessor(this.shaderLanguage),supportsUniformBuffers:t.supportsUniformBuffers,shadersRepository:a.l.GetShadersRepository(this.shaderLanguage),includesShadersStore:a.l.GetIncludesShadersStore(this.shaderLanguage),version:(100*t.version).toString(),platformName:t.shaderPlatformName,processingContext:null,isNDCHalfZRange:t.isNDCHalfZRange,useReverseDepthBuffer:t.useReverseDepthBuffer};return!t.isWebGPU&&t.version>1&&(i.processor=new s.n),await new Promise(e=>{(0,o.M0)(this._builtCompilationString,i,(t,i)=>{e(t)},t)})}finalize(e){let t=e.sharedData.emitComments,i=this.target===n.n.Fragment,r=`
${t?"//Entry point\n":""}`;this._customEntryHeader?r+=this._customEntryHeader:1===this.shaderLanguage?i?r+=`@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.sharedData.varyingInitializationsFragment}`:r+=`@vertex
fn main(input: VertexInputs) -> FragmentInputs{
`:r+=`void main(void) {
`,this.compilationString=r+this.compilationString,this._constantDeclaration&&(this.compilationString=`
${t?"//Constants\n":""}${this._constantDeclaration}
${this.compilationString}`);let a="";for(let e in this.functions)a+=this.functions[e]+`
`;if(this.compilationString=`
${a}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?"//Varyings\n":""}${i?this.sharedData.varyingDeclarationFragment:this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?"//Samplers\n":""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?"//Uniforms\n":""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?"//Attributes\n":""}${this._attributeDeclaration}
${this.compilationString}`),1!==this.shaderLanguage)for(let e in this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defined(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString),this.extensions){let t=this.extensions[e];this.compilationString=`
${t}
${this.compilationString}`}this._injectAtTop&&(this.compilationString=`${this._injectAtTop}
${this.compilationString}`),this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return(e=this.sharedData.formatConfig.formatVariablename(e),void 0===this.sharedData.variableNames[e])?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e)?e+this.sharedData.variableNames[e]:e:(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1,r,n,a){(0>this.samplers.indexOf(e)||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<${n?"u":"f"}32>;
`):this._samplerDeclaration+=`uniform ${a??""} ${n?"u":""}sampler2D ${e}; ${r||""}
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(0>this.samplers.indexOf(e)||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){0>this.samplers.indexOf(e)&&(1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d_array<f32>;
`):this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case r.y.Float:return"float";case r.y.Int:return"int";case r.y.Vector2:return"vec2";case r.y.Color3:case r.y.Vector3:return"vec3";case r.y.Color4:case r.y.Vector4:return"vec4";case r.y.Matrix:return"mat4"}return""}_getShaderType(e){let t=1===this.shaderLanguage;switch(e){case r.y.Float:return t?"f32":"float";case r.y.Int:return t?"i32":"int";case r.y.Vector2:return t?"vec2f":"vec2";case r.y.Color3:case r.y.Vector3:return t?"vec3f":"vec3";case r.y.Color4:case r.y.Vector4:return t?"vec4f":"vec4";case r.y.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){let r=a.l.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let n=r[e]+"\n";if(this.sharedData.emitComments&&(n=t+`
`+n),!i)return n;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){let t=i.replaceStrings[e];n=n.replace(t.search,t.replace)}return n}_emitFunctionFromInclude(e,t,i,r=""){let n=e+r;if(this.functions[n])return;let o=a.l.GetIncludesShadersStore(this.shaderLanguage);if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[n]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[n]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}
`,this.sharedData.emitComments&&(this.functions[n]=t+`
`+this.functions[n]);return}if(this.functions[n]=o[e],this.sharedData.emitComments&&(this.functions[n]=t+`
`+this.functions[n]),i.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[n]=this.functions[n].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[n]=this.functions[n].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[n]=this.functions[n].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){let t=i.replaceStrings[e];this.functions[n]=this.functions[n].replace(t.search,t.replace)}}_registerTempVariable(e){return -1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitDefineStart(e,t=!1){let i="";return e&&(i=e.startsWith("defined(")?`#if ${e}
`:`${t?"#ifndef":"#ifdef"} ${e}
`),i}_emitDefineEnd(e){return e?`#endif
`:""}_emitVaryingFromString(e,t,i="",r=!1){if(-1!==this.sharedData.varyings.indexOf(e))return!1;this.sharedData.varyings.push(e);let n=this._getShaderType(t),a=(t=!1)=>{let a=this._emitDefineStart(i,r);if(1===this.shaderLanguage)switch(n){case"i32":case"f32":case"vec2f":case"vec3f":case"vec4f":a+=`varying ${e}: ${n};
`,t&&(a+=`var<private> ${e}: ${n};
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(i,r)+`${e} = fragmentInputs.${e};
`+this._emitDefineEnd(i));break;case"mat4x4f":a+=`varying ${e}_r0: vec4f;
`,a+=`varying ${e}_r1: vec4f;
`,a+=`varying ${e}_r2: vec4f;
`,a+=`varying ${e}_r3: vec4f;
`,t&&(a+=`var<private> ${e}: mat4x4f;
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(i,r)+`${e} = mat4x4f(fragmentInputs.${e}_r0, fragmentInputs.${e}_r1, fragmentInputs.${e}_r2, fragmentInputs.${e}_r3);
`+this._emitDefineEnd(i));break;default:a+=`varying ${e}: ${n};
`}else a+=`varying ${n} ${e};
`;return a+this._emitDefineEnd(i)};if(1===this.shaderLanguage)this.sharedData.varyingDeclaration+=a(!1),this.sharedData.varyingDeclarationFragment+=a(!0);else{let e=a();this.sharedData.varyingDeclaration+=e,this.sharedData.varyingDeclarationFragment+=e}return!0}_getVaryingName(e){return 1===this.shaderLanguage?(this.target!==n.n.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(-1!==this.uniforms.indexOf(e))return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`),this.sharedData.formatConfig.getUniformAnnotation&&(this._uniformDeclaration+=this.sharedData.formatConfig.getUniformAnnotation(e));let n=this._getShaderType(t);1===this.shaderLanguage?this._uniformDeclaration+=`uniform ${e}: ${n};
`:this._uniformDeclaration+=`uniform ${n} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return 1===this.shaderLanguage?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i,r){return 1===this.shaderLanguage?`${i?"const":"var"+(r?"<private>":"")} ${e}: ${this._getShaderType(t)}`:`${i?"const ":""}${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return 1===this.shaderLanguage?"textureSample":"textureCube"}_samplerFunc(){return 1===this.shaderLanguage?"textureSample":"texture2D"}_samplerLODFunc(){return 1===this.shaderLanguage?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return 1===this.shaderLanguage&&(e.type===r.y.Color3||e.type===r.y.Vector3)?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return 1===this.shaderLanguage?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(e,t,i,r)=>`select(${r}, ${i}, ${t})`)}_convertModOperatorsToWGSL(e){return e.replace(RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(e,t,i)=>`((${t})%(${i}))`)}_convertConstToWGSL(e){return e.replace(RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(/inversesqrt/g,"inverseSqrt")}_convertFunctionsToWGSL(e){let t,i=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;for(;null!==(t=i.exec(e));){let i=t[1],r=t[2],n=t[3].replace(/var\s/g,"");e=e.replace(t[0],`fn ${i}(${n}) -> ${r}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=(e=this._convertOutParametersToWGSL(e)).replace(/\[\*\]/g,"*"),e=(e=(e=(e=this._convertFunctionsToWGSL(e)).replace(/\s->\svoidnull/g,"")).replace(/dFdx/g,"dpdx")).replace(/dFdy/g,"dpdy")}_convertTernaryOperandsToGLSL(e){return e.replace(RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(e,t,i,r)=>`${t} ? ${i} : ${r}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e)}}},91544:function(e,t,i){i.d(t,{Y:()=>n});var r=i(57480);class n{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.varyingDeclarationFragment="",this.varyingInitializationsFragment="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.formatConfig={getUniformAnnotation:null,formatVariablename:e=>e.replace(/[^a-zA-Z_]+/g,"")},this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:[],customErrors:[]},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}raiseBuildError(e){-1!==this.checks.customErrors.indexOf(e)&&this.checks.customErrors.push(e)}emitErrors(){let e="";for(let t of(this.checks.emitVertex||this.allowEmptyVertexProgram||(e+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.\n"),this.checks.emitFragment||(e+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.\n"),this.checks.notConnectedNonOptionalInputs))e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(let t of this.checks.customErrors)e+=t+"\n";return!e||(e="Node material build failed: \n"+e,r.V.Error(e),this.nodeMaterial.onBuildErrorObservable.notifyObservers(e),!1)}}},27550:function(e,t,i){i.r(t),i.d(t,{PBRMaterial:()=>u});var r=i(69081),n=i(1742),a=i(96336),o=i(55322),s=i(90875),l=i(7979),c=i(15335),f=i(78200);class u extends s.d{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===s.d.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=s.d.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=s.d.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===s.d.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=s.d.LIGHTFALLOFF_GLTF:this._lightFalloff=s.d.LIGHTFALLOFF_STANDARD)}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=u.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=o.v9.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new o.v9(0,0,0),this.albedoColor=new o.v9(1,1,1),this.baseWeight=1,this.reflectivityColor=new o.v9(1,1,1),this.reflectionColor=new o.v9(1,1,1),this.emissiveColor=new o.v9(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=(0,a.XX)(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){let r=f.p.Clone(()=>new u(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){let e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){let r=f.p.Parse(()=>new u(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),c.i._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}u.PBRMATERIAL_OPAQUE=s.d.PBRMATERIAL_OPAQUE,u.PBRMATERIAL_ALPHATEST=s.d.PBRMATERIAL_ALPHATEST,u.PBRMATERIAL_ALPHABLEND=s.d.PBRMATERIAL_ALPHABLEND,u.PBRMATERIAL_ALPHATESTANDBLEND=s.d.PBRMATERIAL_ALPHATESTANDBLEND,u.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=s.d.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"directIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"emissiveIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"environmentIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"specularIntensity",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"disableBumpMap",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"albedoTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"baseWeightTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"baseDiffuseRoughnessTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientTextureStrength",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"opacityTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectionTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"emissiveTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectivityTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallic",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"roughness",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicF0Factor",void 0),(0,r.Cg)([(0,n.jT)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicReflectanceColor",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"metallicReflectanceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectanceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"microSurfaceTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"bumpTexture",void 0),(0,r.Cg)([(0,n.uM)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty",null)],u.prototype,"lightmapTexture",void 0),(0,r.Cg)([(0,n.jT)("ambient"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"ambientColor",void 0),(0,r.Cg)([(0,n.jT)("albedo"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"albedoColor",void 0),(0,r.Cg)([(0,n.lK)("baseWeight"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"baseWeight",void 0),(0,r.Cg)([(0,n.lK)("baseDiffuseRoughness"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"baseDiffuseRoughness",void 0),(0,r.Cg)([(0,n.jT)("reflectivity"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectivityColor",void 0),(0,r.Cg)([(0,n.jT)("reflection"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"reflectionColor",void 0),(0,r.Cg)([(0,n.jT)("emissive"),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"emissiveColor",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"microSurface",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useLightmapAsShadowmap",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"useAlphaFromAlbedoTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"forceAlphaTest",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],u.prototype,"alphaCutOff",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useSpecularOverAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRoughnessFromMetallicTextureGreen",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useMetallnessFromMetallicTextureBlue",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAmbientInGrayScale",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),(0,r.Cg)([(0,n.lK)()],u.prototype,"usePhysicalLightFalloff",null),(0,r.Cg)([(0,n.lK)()],u.prototype,"useGLTFLightFalloff",null),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRadianceOverAlpha",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useObjectSpaceNormalMap",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useParallax",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useParallaxOcclusion",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"parallaxScaleBias",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsLightsDirty")],u.prototype,"disableLighting",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"forceIrradianceInFragment",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsLightsDirty")],u.prototype,"maxSimultaneousLights",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"invertNormalMapX",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"invertNormalMapY",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"twoSidedLighting",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useAlphaFresnel",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useLinearAlphaFresnel",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"environmentBRDFTexture",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"forceNormalForward",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"enableSpecularAntiAliasing",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useHorizonOcclusion",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"useRadianceOcclusion",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],u.prototype,"unlit",void 0),(0,r.Cg)([(0,n.lK)(),(0,n.$z)("_markAllSubMeshesAsMiscDirty")],u.prototype,"applyDecalMapAfterDetailMap",void 0),(0,l.Y5)("BABYLON.PBRMaterial",u)},81128:function(e,t,i){i.d(t,{X:()=>l});var r=i(97835),n=i(52754),a=i(35901),o=i(3008),s=i(1679);class l{constructor(e,t={}){this.quality=4096,this.hdrScale=1,this.useCdf=!1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality,this.useCdf=t.useCdf||this.useCdf}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!1,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:2,label:"HDR_Irradiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),i}_prefilterInternal(e){let t=e.getSize().width,i=(0,n.ILog2)(t),o=this._effectWrapper.effect,s=Math.max(32,1<<(0,n.ILog2)(t>>3)),l=this._createRenderTarget(s);this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let c=[[new r.Pq(0,0,-1),new r.Pq(0,-1,0),new r.Pq(1,0,0)],[new r.Pq(0,0,1),new r.Pq(0,-1,0),new r.Pq(-1,0,0)],[new r.Pq(1,0,0),new r.Pq(0,0,1),new r.Pq(0,1,0)],[new r.Pq(1,0,0),new r.Pq(0,0,-1),new r.Pq(0,-1,0)],[new r.Pq(1,0,0),new r.Pq(0,-1,0),new r.Pq(0,0,1)],[new r.Pq(-1,0,0),new r.Pq(0,-1,0),new r.Pq(0,0,-1)]];o.setFloat("hdrScale",this.hdrScale),o.setFloat2("vFilteringInfo",e.getSize().width,i),o.setTexture("inputTexture",e),this._cdfGenerator&&o.setTexture("icdfTexture",this._cdfGenerator.getIcdfTexture());for(let e=0;e<6;e++)o.setVector3("up",c[e][0]),o.setVector3("right",c[e][1]),o.setVector3("front",c[e][2]),this._engine.bindFramebuffer(l,e,void 0,void 0,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper),this._effectRenderer.draw();this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),o.setTexture("inputTexture",null),o.setTexture("icdfTexture",null);let f=new a.t(e.getScene(),l.texture);return f.name=e.name+"_irradiance",f.displayName=e.name+"_irradiance",f.gammaSpace=!1,f}_createEffect(e,t){let r=[];e.gammaSpace&&r.push("#define GAMMA_INPUT"),r.push("#define NUM_SAMPLES "+this.quality+"u");let n=this._engine.isWebGPU,a=["inputTexture"];return this._cdfGenerator&&(a.push("icdfTexture"),r.push("#define IBL_CDF_FILTERING")),new o.$({engine:this._engine,name:"HDRIrradianceFiltering",vertexShader:"hdrIrradianceFiltering",fragmentShader:"hdrIrradianceFiltering",samplerNames:a,uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale"],useShaderStore:!0,defines:r,onCompiled:t,shaderLanguage:+!!n,extraInitializationsAsync:async()=>{n?await Promise.all([Promise.resolve().then(i.bind(i,23047)),Promise.resolve().then(i.bind(i,52973))]):await Promise.all([Promise.resolve().then(i.bind(i,17774)),Promise.resolve().then(i.bind(i,55136))])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){if(!this._engine._features.allowTexturePrefiltering)throw Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this.useCdf&&(this._cdfGenerator=new s.O(this._engine),this._cdfGenerator.iblSource=e,await this._cdfGenerator.renderWhenReady()),this._effectRenderer=new o.J(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync();let t=this._prefilterInternal(e);return this.useCdf&&await this._cdfGenerator.findDominantDirection().then(e=>{t._dominantDirection=e}),this._effectRenderer.dispose(),this._effectWrapper.dispose(),this._cdfGenerator?.dispose(),t}}},46871:function(e,t,i){i.d(t,{_DDSTextureLoader:()=>a});var r=i(60316),n=i(53063);class a{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,a){let o,s=t.getEngine(),l=!1,c=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){let r=e[i];t.width=(o=n.DDSTools.GetDDSInfo(r)).width,t.height=o.height,l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(o.isCompressed),n.DDSTools.UploadDDSLevels(s,t,r,o,l,6,-1,i),o.isFourCC||1!==o.mipmapCount?c=o.mipmapCount-1:s.generateMipMapsForCubemap(t)}else t.width=(o=n.DDSTools.GetDDSInfo(e)).width,t.height=o.height,i&&(o.sphericalPolynomial=new r.Q),l=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,s._unpackFlipY(o.isCompressed),n.DDSTools.UploadDDSLevels(s,t,e,o,l,6),o.isFourCC||1!==o.mipmapCount?c=o.mipmapCount-1:s.generateMipMapsForCubemap(t,!1);s._setCubeMapTextureParams(t,l,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),a&&a({isDDS:!0,width:t.width,info:o,data:e,texture:t})}loadData(e,t,i){let r=n.DDSTools.GetDDSInfo(e),a=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&Math.max(r.width,r.height)>>r.mipmapCount-1==1;i(r.width,r.height,a,r.isFourCC,()=>{n.DDSTools.UploadDDSLevels(t.getEngine(),t,e,r,a,1)})}}},64485:function(){},13867:function(e,t,i){i.d(t,{_KTXTextureLoader:()=>o});var r=i(4348),n=i(8204),a=i(57480);class o{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,n){if(Array.isArray(e))return;t._invertVScale=!t.invertY;let a=t.getEngine(),o=new r.H(e,6),s=o.numberOfMipmapLevels>1&&t.generateMipMaps;a._unpackFlipY(!0),o.uploadLevels(t,t.generateMipMaps),t.width=o.pixelWidth,t.height=o.pixelHeight,a._setCubeMapTextureParams(t,s,o.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n()}loadData(e,t,i,o){if(r.H.IsValid(e)){t._invertVScale=!t.invertY;let n=new r.H(e,1),a=function(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(n.glInternalFormat);a?(t.format=a,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=n.glInternalFormat,i(n.pixelWidth,n.pixelHeight,t.generateMipMaps,!0,()=>{n.uploadLevels(t,t.generateMipMaps)},n.isInvalid)}else n.Z.IsValid(e)?new n.Z(t.getEngine())._uploadAsync(e,t,o).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},e=>{a.V.Warn(`Failed to load KTX2 texture data: ${e.message}`),i(0,0,!1,!1,()=>{},!0)}):(a.V.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}}},2925:function(e,t,i){i.d(t,{b:()=>d});var r=i(69081),n=i(1742),a=i(49477),o=i(97782),s=i(35901),l=i(46538),c=i(7979),f=i(76937),u=i(78200);i(19050);class d extends s.t{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(o.uq.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";for(let t of e)r+=t;return new d(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){let n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;let a=new d(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=n,a}constructor(e,t,i=null,r=!1,n=null,a=null,s=null,c=5,u=!1,d=null,h=!1,p=.8,m=0,_,g){super(t),this.onLoadObservable=new f.cP,this.boundingBoxPosition=o.Pq.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new o.uq,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=o.uq.Identity(),this.coordinatesMode=l.g.CUBIC_MODE;let v=null,S=null;if(null===i||Array.isArray(i)?(this._noMipmap=r,this._format=c,this._createPolynomials=h,v=i,this._loaderOptions=_,this._useSRGBBuffer=g,this._lodScale=p,this._lodOffset=m):(v=i.extensions??null,this._noMipmap=i.noMipmap??!1,n=i.files??null,S=i.buffer??null,this._format=i.format??5,u=i.prefiltered??!1,d=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??.8,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,a=i.onLoad??null,s=i.onError??null),!e&&!n)return;this.updateURL(e,d,a,u,s,v,this.getScene()?.useDelayedTextureLoading,n,S)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,n=null,a=null,o=!1,s=null,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);let c=e.lastIndexOf("."),f=t||(c>-1?e.substring(c).toLowerCase():""),u=0===f.indexOf(".dds"),d=0===f.indexOf(".env"),h=0===f.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),s)this._files=s;else if(h||d||u||a||(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let t=0;t<a.length;t++)this._files.push(e+a[t]);this._extensions=a}this._buffer=l,o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,e=>-1!==e.getActiveTextures().indexOf(this)),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem))return;let t=o.AA.Vector3["0"],i=o.AA.Quaternion["0"],r=o.AA.Vector3["1"];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,o.uq.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){let i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);let n=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},o=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),l.g.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?a.S0.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){let r=u.p.Parse(()=>{let r=!1;return e.prefiltered&&(r=e.prefiltered),new d(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=o.Pq.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=o.Pq.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){let i=e.animations[t],n=(0,c.n9)("BABYLON.Animation");n&&r.animations.push(n.Parse(i))}return r}clone(){let e=0,t=u.p.Clone(()=>{let t=new d(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t},this);return t.uniqueId=e,t}}(0,r.Cg)([(0,n.lK)()],d.prototype,"url",void 0),(0,r.Cg)([(0,n.P_)()],d.prototype,"boundingBoxPosition",void 0),(0,r.Cg)([(0,n.P_)()],d.prototype,"boundingBoxSize",null),(0,r.Cg)([(0,n.lK)("rotationY")],d.prototype,"rotationY",null),(0,r.Cg)([(0,n.lK)("files")],d.prototype,"_files",void 0),(0,r.Cg)([(0,n.lK)("forcedExtension")],d.prototype,"_forcedExtension",void 0),(0,r.Cg)([(0,n.lK)("extensions")],d.prototype,"_extensions",void 0),(0,r.Cg)([(0,n.GG)("textureMatrix")],d.prototype,"_textureMatrix",void 0),(0,r.Cg)([(0,n.GG)("textureMatrixRefraction")],d.prototype,"_textureMatrixRefraction",void 0),l.g._CubeTextureParser=d.Parse,(0,c.Y5)("BABYLON.CubeTexture",d)},80780:function(e,t,i){i.d(t,{a:()=>a});var r=i(98193),n=i(39616);class a extends r.H{constructor(e,t,i,r,n,a){super(e,i,r,n,a),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new n.g("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){let e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();(i!==e||r!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){let e=this._scene;if(super.dispose(),e&&e.prePassRenderer){let t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}},76312:function(e,t,i){i.d(t,{I:()=>n});var r=i(46538);class n extends r.g{constructor(e,t,i,n,a,o=!0,s=!1,l=3,c=0,f,u,d){if(super(null,a,!o,s,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,f),this.format=n,!this._engine)return;this._engine._caps.textureFloatLinearFiltering||1!==c||(l=1),this._engine._caps.textureHalfFloatLinearFiltering||2!==c||(l=1),this._texture=this._engine.createRawTexture(e,t,i,n,o,s,l,null,c,f??0,u??!1),this.wrapU=r.g.CLAMP_ADDRESSMODE,this.wrapV=r.g.CLAMP_ADDRESSMODE,this._waitingForData=!!d&&!e}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();let e=new n(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,t,i,r,a=!0,o=!1,s=3){return new n(e,t,i,1,r,a,o,s)}static CreateLuminanceAlphaTexture(e,t,i,r,a=!0,o=!1,s=3){return new n(e,t,i,2,r,a,o,s)}static CreateAlphaTexture(e,t,i,r,a=!0,o=!1,s=3){return new n(e,t,i,0,r,a,o,s)}static CreateRGBTexture(e,t,i,r,a=!0,o=!1,s=3,l=0,c=0,f=!1){return new n(e,t,i,4,r,a,o,s,l,c,f)}static CreateRGBATexture(e,t,i,r,a=!0,o=!1,s=3,l=0,c=0,f=!1,u=!1){return new n(e,t,i,5,r,a,o,s,l,c,f,u)}static CreateRGBAStorageTexture(e,t,i,r,a=!0,o=!1,s=3,l=0,c=!1){return new n(e,t,i,5,r,a,o,s,l,1,c)}static CreateRTexture(e,t,i,a,o=!0,s=!1,l=r.g.TRILINEAR_SAMPLINGMODE,c=1){return new n(e,t,i,6,a,o,s,l,c)}static CreateRStorageTexture(e,t,i,a,o=!0,s=!1,l=r.g.TRILINEAR_SAMPLINGMODE,c=1){return new n(e,t,i,6,a,o,s,l,c,1)}}},24839:function(){},13060:function(e,t,i){i.d(t,{W:()=>n,l:()=>a});var r=i(46319);function n(e){return class extends e{constructor(){super(...arguments),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1}}}class a extends r.M{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}},32201:function(e,t,i){var r=i(7460);Object.defineProperty(i(93874).F.prototype,"decalMap",{get:function(){return this._decalMap||(this._decalMap=new r.k(this)),this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(i(90875).d.prototype,"decalMap",{get:function(){return this._decalMap||(this._decalMap=new r.k(this)),this._decalMap},enumerable:!0,configurable:!0}),i(43109)},36180:function(e,t,i){i.d(t,{J:()=>r});class r{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,n){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(-1!==t.prePassRenderer.getIndex(2)||-1!==t.prePassRenderer.getIndex(11))){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());let n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}}},93874:function(e,t,i){i.d(t,{F:()=>L,f:()=>b});var r=i(69081),n=i(1742),a=i(80042),o=i(38241),s=i(55322),l=i(44043),c=i(36180),f=i(13060),u=i(23646),d=i(15335),h=i(46319),p=i(32647),m=i(7979),_=i(73488),g=i(46440),v=i(80472),S=i(32481),E=i(86732),T=i(78200),A=i(7521),x=i(64971),I=i(26194);let R={effect:null,subMesh:null};class C extends(0,x.F)(h.M){}class b extends(0,f.W)(C){constructor(e){super(e),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.USE_VERTEX_PULLING=!1,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}}class y extends(0,I.O)(p.E){}class L extends y{get isPrePassCapable(){return!this.disableDepthWrite}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t,void 0,i||L.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new s.v9(0,0,0),this.diffuseColor=new s.v9(1,1,1),this.specularColor=new s.v9(1,1,1),this.emissiveColor=new s.v9(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new a.L(16),this._globalAmbientColor=new s.v9(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new v.c(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new c.J,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),L.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),L.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return!!L.ReflectionTextureEnabled&&!!this._reflectionTexture&&!!this._reflectionTexture.isRenderTarget||!!L.RefractionTextureEnabled&&!!this._refractionTexture&&!!this._refractionTexture.isRenderTarget||this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled)}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===d.i.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==d.i.MATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,r=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let n=t._drawWrapper;if(n.effect&&this.isFrozen&&n._wasPreviouslyReady&&n._wasPreviouslyUsingInstances===r)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new b(this._eventInfo.defineNames));let a=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let s=a.getEngine();o._needNormals=(0,E.az)(a,e,o,!0,this._maxSimultaneousLights,this._disableLighting),(0,E.VO)(a,o);let f=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if((0,E.N4)(a,o,this.canRenderToMRT&&!f),(0,E.Nc)(a,o,f),A.m.PrepareDefines(s.currentRenderPassId,e,o),o._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o._needUVs=!1;for(let e=1;e<=6;++e)o["MAINUV"+e]=!1;if(a.texturesEnabled){if(o.DIFFUSEDIRECTUV=0,o.BUMPDIRECTUV=0,o.AMBIENTDIRECTUV=0,o.OPACITYDIRECTUV=0,o.EMISSIVEDIRECTUV=0,o.SPECULARDIRECTUV=0,o.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&L.DiffuseTextureEnabled)if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;else(0,E.YT)(this._diffuseTexture,o,"DIFFUSE");else o.DIFFUSE=!1;if(this._ambientTexture&&L.AmbientTextureEnabled)if(!this._ambientTexture.isReadyOrNotBlocking())return!1;else(0,E.YT)(this._ambientTexture,o,"AMBIENT");else o.AMBIENT=!1;if(this._opacityTexture&&L.OpacityTextureEnabled)if(!this._opacityTexture.isReadyOrNotBlocking())return!1;else(0,E.YT)(this._opacityTexture,o,"OPACITY"),o.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else o.OPACITY=!1;if(this._reflectionTexture&&L.ReflectionTextureEnabled?(o.ROUGHNESS=this._roughness>0,o.REFLECTIONOVERALPHA=this._useReflectionOverAlpha):(o.ROUGHNESS=!1,o.REFLECTIONOVERALPHA=!1),!(0,E.kz)(a,this._reflectionTexture,o))return!1;if(this._emissiveTexture&&L.EmissiveTextureEnabled)if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;else(0,E.YT)(this._emissiveTexture,o,"EMISSIVE");else o.EMISSIVE=!1;if(this._lightmapTexture&&L.LightmapTextureEnabled)if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;else(0,E.YT)(this._lightmapTexture,o,"LIGHTMAP"),o.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,o.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else o.LIGHTMAP=!1;if(this._specularTexture&&L.SpecularTextureEnabled)if(!this._specularTexture.isReadyOrNotBlocking())return!1;else(0,E.YT)(this._specularTexture,o,"SPECULAR"),o.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else o.SPECULAR=!1;if(a.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&L.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;(0,E.YT)(this._bumpTexture,o,"BUMP"),o.PARALLAX=this._useParallax,o.PARALLAX_RHS=a.useRightHandedSystem,o.PARALLAXOCCLUSION=this._useParallaxOcclusion,o.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else o.BUMP=!1,o.PARALLAX=!1,o.PARALLAX_RHS=!1,o.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&L.RefractionTextureEnabled)if(!this._refractionTexture.isReadyOrNotBlocking())return!1;else o._needUVs=!0,o.REFRACTION=!0,o.REFRACTIONMAP_3D=this._refractionTexture.isCube,o.RGBDREFRACTION=this._refractionTexture.isRGBD,o.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else o.REFRACTION=!1;o.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else o.DIFFUSE=!1,o.AMBIENT=!1,o.OPACITY=!1,o.REFLECTION=!1,o.EMISSIVE=!1,o.LIGHTMAP=!1,o.BUMP=!1,o.REFRACTION=!1;o.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),o.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,o.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,o.SPECULAROVERALPHA=this._useSpecularOverAlpha,o.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,o.ALPHATEST_AFTERALLALPHACOMPUTATIONS=null!==this.transparencyMode,o.ALPHABLEND=null===this.transparencyMode||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=o,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o),o.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,o.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}if(o._areFresnelDirty&&(L.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(o.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,o.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,o.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,o.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,o.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,o.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,o._needNormals=!0,o.FRESNEL=!0):o.FRESNEL=!1),o.AREALIGHTUSED||o.CLUSTLIGHT_BATCH){for(let t=0;t<e.lightSources.length;t++)if(!e.lightSources[t]._isReady())return!1}(0,E.fm)(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),o,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t.getRenderingMesh(),this._isVertexOutputInvariant),(0,E.OR)(a,s,this,o,r,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=o,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),(0,E.qB)(e,o,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let d=!1;if(o.isDirty){let r=o._areLightsDisposed;o.markAsProcessed();let n=new g.J;o.REFLECTION&&n.addFallback(0,"REFLECTION"),o.SPECULAR&&n.addFallback(0,"SPECULAR"),o.BUMP&&n.addFallback(0,"BUMP"),o.PARALLAX&&n.addFallback(1,"PARALLAX"),o.PARALLAX_RHS&&n.addFallback(1,"PARALLAX_RHS"),o.PARALLAXOCCLUSION&&n.addFallback(0,"PARALLAXOCCLUSION"),o.SPECULAROVERALPHA&&n.addFallback(0,"SPECULAROVERALPHA"),o.FOG&&n.addFallback(1,"FOG"),o.POINTSIZE&&n.addFallback(0,"POINTSIZE"),o.LOGARITHMICDEPTH&&n.addFallback(0,"LOGARITHMICDEPTH"),(0,E.c4)(o,n,this._maxSimultaneousLights),o.SPECULARTERM&&n.addFallback(0,"SPECULARTERM"),o.DIFFUSEFRESNEL&&n.addFallback(1,"DIFFUSEFRESNEL"),o.OPACITYFRESNEL&&n.addFallback(2,"OPACITYFRESNEL"),o.REFLECTIONFRESNEL&&n.addFallback(3,"REFLECTIONFRESNEL"),o.EMISSIVEFRESNEL&&n.addFallback(4,"EMISSIVEFRESNEL"),o.FRESNEL&&n.addFallback(4,"FRESNEL"),o.MULTIVIEW&&n.addFallback(0,"MULTIVIEW");let f=[l.R.PositionKind];o.NORMAL&&f.push(l.R.NormalKind),o.TANGENT&&f.push(l.R.TangentKind);for(let e=1;e<=6;++e)o["UV"+e]&&f.push(`uv${1===e?"":e}`);o.VERTEXCOLOR&&f.push(l.R.ColorKind),(0,E.ni)(f,e,o,n),(0,E.ER)(f,o),(0,E.IF)(f,e,o),(0,E.J2)(f,e,o);let h="default",p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],m=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];(0,E.B1)(p,m,!1);let _=["Material","Scene","Mesh"],v={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=n,this._eventInfo.fallbackRank=0,this._eventInfo.defines=o,this._eventInfo.uniforms=p,this._eventInfo.attributes=f,this._eventInfo.samplers=m,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=v,this._callbackPluginEventGeneric(128,this._eventInfo),A.m.AddUniformsAndSamplers(p,m),c.J.AddUniforms(p),c.J.AddSamplers(m),u.p&&(u.p.PrepareUniforms(p,o),u.p.PrepareSamplers(m,o)),(0,E.Bb)({uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:o,maxSimultaneousLights:this._maxSimultaneousLights}),(0,S.Ll)(p);let T={};this.customShaderNameResolve&&(h=this.customShaderNameResolve(h,p,_,m,o,f,T));let x=o.toString(),I=t.effect,C=a.getEngine().createEffect(h,{attributes:f,uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:x,fallbacks:n,onCompiled:this.onCompiled,onError:this.onError,indexParameters:v,processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:o.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,54922)),Promise.resolve().then(i.bind(i,65916))]):await Promise.all([Promise.resolve().then(i.bind(i,21173)),Promise.resolve().then(i.bind(i,48458))]),this._shadersLoaded=!0}},s);if(this._eventInfo.customCode=void 0,C)if(this._onEffectCreatedObservable&&(R.effect=C,R.subMesh=t,this._onEffectCreatedObservable.notifyObservers(R)),this.allowShaderHotSwapping&&I&&!C.isReady()){if(C=I,o.markAsUnprocessed(),d=this.isFrozen,r)return o._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(C,o,this._materialContext)}return!!t.effect&&!!t.effect.isReady()&&(o._renderId=a.getRenderId(),n._wasPreviouslyReady=!d,n._wasPreviouslyUsingInstances=r,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),e.addUniform("cameraInfo",4),(0,E.G$)(e,!1,!0),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),A.m.Bind(r.getEngine().currentRenderPassId,this._activeEffect,t,e,this);let l=r.activeCamera;l?this._uniformBuffer.updateFloat4("cameraInfo",l.minZ,l.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let c=this._mustRebind(r,a,i,t.visibility);(0,E.f$)(t,a);let f=this._uniformBuffer;if(c){if(this.bindViewProjection(a),!f.useUbo||!this.isFrozen||!f.isSync||i._drawWrapper._forceRebindOnNextCall){if(L.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(f.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),f.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&f.updateColor4("opacityParts",new s.v9(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(f.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),f.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(f.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),f.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(f.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),f.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled&&(this._diffuseTexture&&L.DiffuseTextureEnabled&&(f.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),(0,E.mA)(this._diffuseTexture,f,"diffuse")),this._ambientTexture&&L.AmbientTextureEnabled&&(f.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),(0,E.mA)(this._ambientTexture,f,"ambient")),this._opacityTexture&&L.OpacityTextureEnabled&&(f.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),(0,E.mA)(this._opacityTexture,f,"opacity")),this._hasAlphaChannel()&&f.updateFloat("alphaCutOff",this.alphaCutOff),(0,E.X8)(r,n,f,s.v9.White(),this._reflectionTexture,!1,!1,!0,!1,!1,!1,this.roughness),this._reflectionTexture&&L.ReflectionTextureEnabled||f.updateFloat2("vReflectionInfos",0,this.roughness),this._emissiveTexture&&L.EmissiveTextureEnabled&&(f.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),(0,E.mA)(this._emissiveTexture,f,"emissive")),this._lightmapTexture&&L.LightmapTextureEnabled&&(f.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),(0,E.mA)(this._lightmapTexture,f,"lightmap")),this._specularTexture&&L.SpecularTextureEnabled&&(f.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),(0,E.mA)(this._specularTexture,f,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&L.BumpTextureEnabled&&(f.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),(0,E.mA)(this._bumpTexture,f,"bump"),r._mirroredCameraPosition?f.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):f.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&L.RefractionTextureEnabled)){let e=1;if(!this._refractionTexture.isCube&&(f.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(e=this._refractionTexture.depth)),f.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){let e=this._refractionTexture;f.updateVector3("vRefractionPosition",e.boundingBoxPosition),f.updateVector3("vRefractionSize",e.boundingBoxSize)}}this.pointsCloud&&f.updateFloat("pointSize",this.pointSize),f.updateColor4("vSpecularColor",this.specularColor,this.specularPower),f.updateColor3("vEmissiveColor",L.EmissiveTextureEnabled?this.emissiveColor:s.v9.BlackReadOnly),f.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),f.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&L.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&L.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&L.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&L.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?a.setTexture("reflectionCubeSampler",this._reflectionTexture):a.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&L.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&L.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&L.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&L.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&L.RefractionTextureEnabled&&(this._refractionTexture.isCube?a.setTexture("refractionCubeSampler",this._refractionTexture):a.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),(0,S.ij)(a,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(c||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&(0,E.RL)(r,t,a,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==o.Z.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS||n.CLUSTLIGHT_BATCH)&&this.bindView(a),(0,E.Yy)(r,t,a),n.NUM_MORPH_INFLUENCERS&&(0,E.nR)(t,a),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(a,n.INSTANCES),this.useLogarithmicDepth&&(0,E.DL)(n,a,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),f.update()}getAnimatables(){let e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){let e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e||!1}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){let r=T.p.Clone(()=>new L(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){let r=T.p.Parse(()=>new L(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),d.i._ParsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return _.h.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){_.h.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return _.h.DetailTextureEnabled}static set DetailTextureEnabled(e){_.h.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return _.h.AmbientTextureEnabled}static set AmbientTextureEnabled(e){_.h.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return _.h.OpacityTextureEnabled}static set OpacityTextureEnabled(e){_.h.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return _.h.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){_.h.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return _.h.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){_.h.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return _.h.SpecularTextureEnabled}static set SpecularTextureEnabled(e){_.h.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return _.h.BumpTextureEnabled}static set BumpTextureEnabled(e){_.h.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return _.h.LightmapTextureEnabled}static set LightmapTextureEnabled(e){_.h.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return _.h.RefractionTextureEnabled}static set RefractionTextureEnabled(e){_.h.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return _.h.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){_.h.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return _.h.FresnelEnabled}static set FresnelEnabled(e){_.h.FresnelEnabled=e}}L.ForceGLSL=!1,(0,r.Cg)([(0,n.uM)("diffuseTexture")],L.prototype,"_diffuseTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],L.prototype,"diffuseTexture",void 0),(0,r.Cg)([(0,n.uM)("ambientTexture")],L.prototype,"_ambientTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"ambientTexture",void 0),(0,r.Cg)([(0,n.uM)("opacityTexture")],L.prototype,"_opacityTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],L.prototype,"opacityTexture",void 0),(0,r.Cg)([(0,n.uM)("reflectionTexture")],L.prototype,"_reflectionTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"reflectionTexture",void 0),(0,r.Cg)([(0,n.uM)("emissiveTexture")],L.prototype,"_emissiveTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"emissiveTexture",void 0),(0,r.Cg)([(0,n.uM)("specularTexture")],L.prototype,"_specularTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"specularTexture",void 0),(0,r.Cg)([(0,n.uM)("bumpTexture")],L.prototype,"_bumpTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"bumpTexture",void 0),(0,r.Cg)([(0,n.uM)("lightmapTexture")],L.prototype,"_lightmapTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"lightmapTexture",void 0),(0,r.Cg)([(0,n.uM)("refractionTexture")],L.prototype,"_refractionTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"refractionTexture",void 0),(0,r.Cg)([(0,n.jT)("ambient")],L.prototype,"ambientColor",void 0),(0,r.Cg)([(0,n.jT)("diffuse")],L.prototype,"diffuseColor",void 0),(0,r.Cg)([(0,n.jT)("specular")],L.prototype,"specularColor",void 0),(0,r.Cg)([(0,n.jT)("emissive")],L.prototype,"emissiveColor",void 0),(0,r.Cg)([(0,n.lK)()],L.prototype,"specularPower",void 0),(0,r.Cg)([(0,n.lK)("useAlphaFromDiffuseTexture")],L.prototype,"_useAlphaFromDiffuseTexture",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesAndMiscDirty")],L.prototype,"useAlphaFromDiffuseTexture",void 0),(0,r.Cg)([(0,n.lK)("useEmissiveAsIllumination")],L.prototype,"_useEmissiveAsIllumination",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useEmissiveAsIllumination",void 0),(0,r.Cg)([(0,n.lK)("linkEmissiveWithDiffuse")],L.prototype,"_linkEmissiveWithDiffuse",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"linkEmissiveWithDiffuse",void 0),(0,r.Cg)([(0,n.lK)("useSpecularOverAlpha")],L.prototype,"_useSpecularOverAlpha",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useSpecularOverAlpha",void 0),(0,r.Cg)([(0,n.lK)("useReflectionOverAlpha")],L.prototype,"_useReflectionOverAlpha",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useReflectionOverAlpha",void 0),(0,r.Cg)([(0,n.lK)("disableLighting")],L.prototype,"_disableLighting",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsLightsDirty")],L.prototype,"disableLighting",void 0),(0,r.Cg)([(0,n.lK)("useObjectSpaceNormalMap")],L.prototype,"_useObjectSpaceNormalMap",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useObjectSpaceNormalMap",void 0),(0,r.Cg)([(0,n.lK)("useParallax")],L.prototype,"_useParallax",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useParallax",void 0),(0,r.Cg)([(0,n.lK)("useParallaxOcclusion")],L.prototype,"_useParallaxOcclusion",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useParallaxOcclusion",void 0),(0,r.Cg)([(0,n.lK)()],L.prototype,"parallaxScaleBias",void 0),(0,r.Cg)([(0,n.lK)("roughness")],L.prototype,"_roughness",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"roughness",void 0),(0,r.Cg)([(0,n.lK)()],L.prototype,"indexOfRefraction",void 0),(0,r.Cg)([(0,n.lK)()],L.prototype,"invertRefractionY",void 0),(0,r.Cg)([(0,n.lK)()],L.prototype,"alphaCutOff",void 0),(0,r.Cg)([(0,n.lK)("useLightmapAsShadowmap")],L.prototype,"_useLightmapAsShadowmap",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useLightmapAsShadowmap",void 0),(0,r.Cg)([(0,n.Y9)("diffuseFresnelParameters")],L.prototype,"_diffuseFresnelParameters",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsFresnelDirty")],L.prototype,"diffuseFresnelParameters",void 0),(0,r.Cg)([(0,n.Y9)("opacityFresnelParameters")],L.prototype,"_opacityFresnelParameters",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsFresnelAndMiscDirty")],L.prototype,"opacityFresnelParameters",void 0),(0,r.Cg)([(0,n.Y9)("reflectionFresnelParameters")],L.prototype,"_reflectionFresnelParameters",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsFresnelDirty")],L.prototype,"reflectionFresnelParameters",void 0),(0,r.Cg)([(0,n.Y9)("refractionFresnelParameters")],L.prototype,"_refractionFresnelParameters",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsFresnelDirty")],L.prototype,"refractionFresnelParameters",void 0),(0,r.Cg)([(0,n.Y9)("emissiveFresnelParameters")],L.prototype,"_emissiveFresnelParameters",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsFresnelDirty")],L.prototype,"emissiveFresnelParameters",void 0),(0,r.Cg)([(0,n.lK)("useReflectionFresnelFromSpecular")],L.prototype,"_useReflectionFresnelFromSpecular",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsFresnelDirty")],L.prototype,"useReflectionFresnelFromSpecular",void 0),(0,r.Cg)([(0,n.lK)("useGlossinessFromSpecularMapAlpha")],L.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"useGlossinessFromSpecularMapAlpha",void 0),(0,r.Cg)([(0,n.lK)("maxSimultaneousLights")],L.prototype,"_maxSimultaneousLights",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsLightsDirty")],L.prototype,"maxSimultaneousLights",void 0),(0,r.Cg)([(0,n.lK)("invertNormalMapX")],L.prototype,"_invertNormalMapX",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"invertNormalMapX",void 0),(0,r.Cg)([(0,n.lK)("invertNormalMapY")],L.prototype,"_invertNormalMapY",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"invertNormalMapY",void 0),(0,r.Cg)([(0,n.lK)("twoSidedLighting")],L.prototype,"_twoSidedLighting",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsTexturesDirty")],L.prototype,"twoSidedLighting",void 0),(0,r.Cg)([(0,n.lK)("applyDecalMapAfterDetailMap")],L.prototype,"_applyDecalMapAfterDetailMap",void 0),(0,r.Cg)([(0,n.$z)("_markAllSubMeshesAsMiscDirty")],L.prototype,"applyDecalMapAfterDetailMap",void 0),(0,m.Y5)("BABYLON.StandardMaterial",L),o.Z.DefaultMaterialFactory=e=>new L("default material",e)},33297:function(e,t,i){i.d(t,{s:()=>r});class r{_isUbo(e){return void 0!==e.addUniform}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}},30742:function(){},94524:function(e,t,i){i.d(t,{SM:()=>E,_f:()=>a,hh:()=>v,lA:()=>_,qc:()=>g,rT:()=>o,vx:()=>S});var r,n,a,o,s=i(93874),l=i(27550),c=i(89901),f=i(37702),u=i(33500),d=i(16178),h=i(6533),p=i(15210),m=i(14936);function _(e,t,i){let r;switch(i=i??f.q.LastCreatedScene,t.materialType){case 1:r=new l.PBRMaterial(e,i,t.forceGLSL),new p.o(r,i,t);break;case 2:r=new u.h(e,i,t);break;default:r=new s.F(e,i,t.forceGLSL),new p.o(r,i,t)}return r}function g(e,t,i,r){let n;r=r??f.q.LastCreatedScene;let a=d.F.ConvertPoints(t.points,t.pointsOptions);t.widthDistribution=t.widthDistribution??3,t.ribbonOptions&&(t.ribbonOptions.facesMode=t.ribbonOptions.facesMode??1,t.ribbonOptions.pointsMode=t.ribbonOptions.pointsMode??0,t.ribbonOptions.directionsAutoMode=t.ribbonOptions.directionsAutoMode??99*!!t.ribbonOptions.directions),(i=i??{color:m.T.DEFAULT_COLOR}).createAndAssignMaterial=i.createAndAssignMaterial??!0,i.colorDistribution=i?.colorDistribution??3,i.materialType=i.materialType??0;let o=v(a),s=S(o,t.widths??[],t.widthDistribution),l=i?.colors?E(o,i.colors,i.colorDistribution,i.color??m.T.DEFAULT_COLOR):void 0,u={points:a,updatable:t.updatable,widths:s,lazy:t.lazy,ribbonOptions:t.ribbonOptions,uvs:t.uvs,colorPointers:t.colorPointers};if(u.ribbonOptions&&0===u.ribbonOptions.pointsMode&&(u.ribbonOptions.width=i.width??u.ribbonOptions.width??m.T.DEFAULT_WIDTH),t.instance)if((n=t.instance)instanceof h.z)n.addPoints(a,u);else{let e=n.widths;if(e){let t=e.slice();for(let e of s)t.push(e);n.widths=t}else n.widths=s;if(n.addPoints(a),t.uvs){let e=n.uvs;if(e){let i=new Float32Array(e.length+t.uvs.length);i.set(e,0),i.set(t.uvs,e.length),n.uvs=i}else n.uvs=t.uvs}}else if(n=u.ribbonOptions?new h.z(e,r,u):new c.X(e,r,u),i){let a={materialType:i.materialType,dashCount:i.dashCount,dashOffset:i.dashOffset,dashRatio:i.dashRatio,resolution:i.resolution,sizeAttenuation:i.sizeAttenuation,useColors:i.useColors,useDash:i.useDash,visibility:i.visibility,width:i.width,color:i.color,colorMode:i.colorMode,colorsSampling:i.colorsSampling,colorDistributionType:i.colorDistributionType,colors:l,cameraFacing:!t.ribbonOptions,colorsTexture:i.colorsTexture};if(i.createAndAssignMaterial){let i=_(e,a,r);n.material=i,t.ribbonOptions?.facesMode===1&&(i.backFaceCulling=!1)}}if(l&&t.instance&&t.instance.greasedLineMaterial){let e=t.instance.greasedLineMaterial.colors;if(e){let i=e.concat(l);t.instance.greasedLineMaterial.setColors(i,n.isLazy())}}return n}function v(e){let t=0;for(let i of e)t+=i.length/3;return t}function S(e,t,i,r=1,n=1){let a=e-t.length/2,o=[];if(a<0)return t.slice(0,2*e);if(a>0){if(t.length%2!=0&&t.push(r),5===i){let e=Math.floor(t.length/2);for(let i=0,r=0;i<e-1;i++)o.push(t[r++]),o.push(t[r++]);let i=t[e/2],r=t[e/2+1];for(let e=0;e<a;e++)o.push(r),o.push(i);for(let i=e;i<t.length;i+=2)o.push(t[i]),o.push(t[i+1])}else if(3===i){for(let e=0;e<t.length;e+=2)o.push(t[e]),o.push(t[e+1]);for(let e=0;e<a;e++)o.push(r),o.push(n)}else if(4===i){for(let e=0;e<a;e++)o.push(r),o.push(n);for(let e=0;e<t.length;e+=2)o.push(t[e]),o.push(t[e+1])}else if(1===i){let i=0;for(let r=0;r<e;r++)o.push(t[i++]),o.push(t[i++]),i===t.length&&(i=0)}else if(2===i){let i=0,r=t.length/((e-1)*2);for(let n=0;n<e;n++){let e=Math.floor(i);o.push(t[e]),o.push(t[e+1]),i+=r}}}else for(let e=0;e<t.length;e++)o.push(t[e]);return o}function E(e,t,i,r){let n=(e=Math.max(t.length,e))-t.length;if(n<0)return t.slice(0,e);let a=[];if(n>0){if(5===i){let e=Math.floor(t.length/2);for(let i=0;i<e;i++)a.push(t[i]);for(let e=0;e<n-1;e++)a.push(r);for(let i=e;i<t.length;i++)a.push(t[i])}else if(3===i){for(let e=0;e<t.length;e++)a.push(t[e]);for(let e=0;e<n;e++)a.push(r)}else if(4===i){for(let e=0;e<n-1;e++)a.push(r);for(let e=0;e<t.length;e++)a.push(t[e])}else if(1===i){let i=0;for(let r=0;r<e;r++)a.push(t[i]),++i===t.length&&(i=0)}else if(2===i){let i=0,r=t.length/(e-1);for(let n=0;n<e-1;n++){let e=Math.floor(i);a.push(t[e]),i+=r}}else if(0===i)for(let e=0;e<t.length;e++)a.push(t[e])}else for(let i=0;i<e;i++)a.push(t[i]);return a}(r=a||(a={}))[r.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",r[r.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",r[r.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",r[r.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",r[r.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",r[r.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END",(n=o||(o={}))[n.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",n[n.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",n[n.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",n[n.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",n[n.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",n[n.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END"},95305:function(e,t,i){i.d(t,{EH:()=>d,LL:()=>v,RI:()=>g,k:()=>h,km:()=>m,ol:()=>_,r_:()=>p});var r=i(97782),n=i(55322),a=i(84774),o=i(58720),s=i(62929),l=i(49477),c=i(37702),f=i(61020),u=i(68748);function d(e){let t,i,n=[],a=[],s=[],l=[],c=e.width||e.size||1,f=e.height||e.size||1,d=0|(e.subdivisionsX||e.subdivisions||1),h=0|(e.subdivisionsY||e.subdivisions||1);for(t=0;t<=h;t++)for(i=0;i<=d;i++){let e=new r.Pq(i*c/d-c/2,0,(h-t)*f/h-f/2),n=new r.Pq(0,1,0);a.push(e.x,e.y,e.z),s.push(n.x,n.y,n.z),l.push(i/d,u.rX?t/h:1-t/h)}for(t=0;t<h;t++)for(i=0;i<d;i++)n.push(i+1+(t+1)*(d+1)),n.push(i+1+t*(d+1)),n.push(i+t*(d+1)),n.push(i+(t+1)*(d+1)),n.push(i+1+(t+1)*(d+1)),n.push(i+t*(d+1));let p=new o.P;return p.indices=n,p.positions=a,p.normals=s,p.uvs=l,p}function h(e){let t,i,n,a,s=void 0!==e.xmin&&null!==e.xmin?e.xmin:-1,l=void 0!==e.zmin&&null!==e.zmin?e.zmin:-1,c=void 0!==e.xmax&&null!==e.xmax?e.xmax:1,f=void 0!==e.zmax&&null!==e.zmax?e.zmax:1,u=e.subdivisions||{w:1,h:1},d=e.precision||{w:1,h:1},h=[],p=[],m=[],_=[];u.h=u.h<1?1:u.h,u.w=u.w<1?1:u.w,d.w=d.w<1?1:d.w,d.h=d.h<1?1:d.h;let g={w:(c-s)/u.w,h:(f-l)/u.h};for(n=0;n<u.h;n++)for(a=0;a<u.w;a++)!function(e,n,a,o){let s=p.length/3,l=d.w+1;for(t=0;t<d.h;t++)for(i=0;i<d.w;i++){let e=[s+i+t*l,s+(i+1)+t*l,s+(i+1)+(t+1)*l,s+i+(t+1)*l];h.push(e[1]),h.push(e[2]),h.push(e[3]),h.push(e[0]),h.push(e[1]),h.push(e[3])}let c=r.Pq.Zero(),f=new r.Pq(0,1,0);for(t=0;t<=d.h;t++)for(i=0,c.z=t*(o-n)/d.h+n;i<=d.w;i++)c.x=i*(a-e)/d.w+e,c.y=0,p.push(c.x,c.y,c.z),m.push(f.x,f.y,f.z),_.push(i/d.w,t/d.h)}(s+a*g.w,l+n*g.h,s+(a+1)*g.w,l+(n+1)*g.h);let v=new o.P;return v.indices=h,v.positions=p,v.normals=m,v.uvs=_,v}function p(e){let t,i,a=[],s=[],l=[],c=[],u=e.colorFilter||new n.v9(.3,.59,.11),d=e.alphaFilter||0,h=!1;if(e.minHeight>e.maxHeight){h=!0;let t=e.maxHeight;e.maxHeight=e.minHeight,e.minHeight=t}for(t=0;t<=e.subdivisions;t++)for(i=0;i<=e.subdivisions;i++){let n=new r.Pq(i*e.width/e.subdivisions-e.width/2,0,(e.subdivisions-t)*e.height/e.subdivisions-e.height/2),a=(((n.x+e.width/2)/e.width*(e.bufferWidth-1)|0)+((1-(n.z+e.height/2)/e.height)*(e.bufferHeight-1)|0)*e.bufferWidth)*4,o=e.buffer[a]/255,p=e.buffer[a+1]/255,m=e.buffer[a+2]/255,_=e.buffer[a+3]/255;h&&(o=1-o,p=1-p,m=1-m);let g=o*u.r+p*u.g+m*u.b;_>=d?n.y=e.minHeight+(e.maxHeight-e.minHeight)*g:n.y=e.minHeight-f.bH,e.heightBuffer&&(e.heightBuffer[t*(e.subdivisions+1)+i]=n.y),s.push(n.x,n.y,n.z),l.push(0,0,0),c.push(i/e.subdivisions,1-t/e.subdivisions)}for(t=0;t<e.subdivisions;t++)for(i=0;i<e.subdivisions;i++){let r=i+1+(t+1)*(e.subdivisions+1),n=i+1+t*(e.subdivisions+1),o=i+t*(e.subdivisions+1),l=i+(t+1)*(e.subdivisions+1),c=s[3*r+1]>=e.minHeight,f=s[3*n+1]>=e.minHeight,u=s[3*o+1]>=e.minHeight;c&&f&&u&&(a.push(r),a.push(n),a.push(o)),s[3*l+1]>=e.minHeight&&c&&u&&(a.push(l),a.push(r),a.push(o))}o.P.ComputeNormals(s,a,l);let p=new o.P;return p.indices=a,p.positions=s,p.normals=l,p.uvs=c,p}function m(e,t={},i){let r=new s.f(e,i);return r._setReady(!1),r._subdivisionsX=t.subdivisionsX||t.subdivisions||1,r._subdivisionsY=t.subdivisionsY||t.subdivisions||1,r._width=t.width||1,r._height=t.height||1,r._maxX=r._width/2,r._maxZ=r._height/2,r._minX=-r._maxX,r._minZ=-r._maxZ,d(t).applyToMesh(r,t.updatable),r._setReady(!0),r}function _(e,t,i=null){let r=new a.e(e,i);return h(t).applyToMesh(r,t.updatable),r}function g(e,t,i={},r=null){let a,o=i.width||10,f=i.height||10,u=i.subdivisions||1,d=i.minHeight||0,h=i.maxHeight||1,m=i.colorFilter||new n.v9(.3,.59,.11),_=i.alphaFilter||0,v=i.updatable,S=i.onReady;r=r||c.q.LastCreatedScene;let E=new s.f(e,r);E._subdivisionsX=u,E._subdivisionsY=u,E._width=o,E._height=f,E._maxX=E._width/2,E._maxZ=E._height/2,E._minX=-E._maxX,E._minZ=-E._maxZ,E._setReady(!1),i.passHeightBufferInCallback&&(a=new Float32Array((u+1)*(u+1)));let T=(e,t,i)=>{p({width:o,height:f,subdivisions:u,minHeight:d,maxHeight:h,colorFilter:m,buffer:e,bufferWidth:t,bufferHeight:i,alphaFilter:_,heightBuffer:a}).applyToMesh(E,v),S&&S(E,a),E._setReady(!0)};return"string"==typeof t?l.S0.LoadImage(t,e=>{let t=e.width,i=e.height;r.isDisposed||T(r?.getEngine().resizeImageBitmap(e,t,i),t,i)},i.onError?i.onError:()=>{},r.offlineProvider):T(t.data,t.width,t.height),E}let v={CreateGround:m,CreateGroundFromHeightMap:g,CreateTiledGround:_};o.P.CreateGround=d,o.P.CreateTiledGround=h,o.P.CreateGroundFromHeightMap=p,a.e.CreateGround=(e,t,i,r,n,a)=>m(e,{width:t,height:i,subdivisions:r,updatable:a},n),a.e.CreateTiledGround=(e,t,i,r,n,a,o,s,l)=>_(e,{xmin:t,zmin:i,xmax:r,zmax:n,subdivisions:a,precision:o,updatable:l},s),a.e.CreateGroundFromHeightMap=(e,t,i,r,n,a,o,s,l,c,f)=>g(e,t,{width:i,height:r,subdivisions:n,minHeight:a,maxHeight:o,updatable:l,onReady:c,alphaFilter:f},s)},55308:function(e,t,i){i.d(t,{NX:()=>h,dT:()=>p,e8:()=>c,nP:()=>f,sh:()=>d,uz:()=>u});var r=i(97782),n=i(84774),a=i(58720),o=i(64793),s=i(44043),l=i(57480);function c(e){let t=[],i=[],r=e.lines,n=e.colors,o=[],s=0;for(let e=0;e<r.length;e++){let a=r[e];for(let r=0;r<a.length;r++){let{x:l,y:c,z:f}=a[r];if(i.push(l,c,f),n){let{r:t,g:i,b:a,a:s}=n[e][r];o.push(t,i,a,s)}r>0&&(t.push(s-1),t.push(s)),s++}}let l=new a.P;return l.indices=t,l.positions=i,n&&(l.colors=o),l}function f(e){let t=e.dashSize||3,i=e.gapSize||1,n=e.dashNb||200,o=e.points,s=[],l=[],c=r.Pq.Zero(),f=0,u=0,d=0,h=0,p=0,m=0,_=0;for(_=0;_<o.length-1;_++)o[_+1].subtractToRef(o[_],c),f+=c.length();for(_=0,h=t*(d=f/n)/(t+i);_<o.length-1;_++){o[_+1].subtractToRef(o[_],c),u=Math.floor(c.length()/d),c.normalize();for(let e=0;e<u;e++)p=d*e,s.push(o[_].x+p*c.x,o[_].y+p*c.y,o[_].z+p*c.z),s.push(o[_].x+(p+h)*c.x,o[_].y+(p+h)*c.y,o[_].z+(p+h)*c.z),l.push(m,m+1),m+=2}let g=new a.P;return g.positions=s,g.indices=l,g}function u(e,t,i=null){let r=t.instance,n=t.lines,a=t.colors;if(r){let e,t,i=r.getVerticesData(s.R.PositionKind);a&&(e=r.getVerticesData(s.R.ColorKind));let o=0,l=0;for(let r=0;r<n.length;r++){let s=n[r];for(let n=0;n<s.length;n++)i[o]=s[n].x,i[o+1]=s[n].y,i[o+2]=s[n].z,a&&e&&(t=a[r],e[l]=t[n].r,e[l+1]=t[n].g,e[l+2]=t[n].b,e[l+3]=t[n].a,l+=4),o+=3}return r.updateVerticesData(s.R.PositionKind,i,!1,!1),a&&e&&r.updateVerticesData(s.R.ColorKind,e,!1,!1),r.refreshBoundingInfo(),r}let l=!!a,f=new o.l(e,i,null,void 0,void 0,l,t.useVertexAlpha,t.material);return c(t).applyToMesh(f,t.updatable),f}function d(e,t,i=null){let r=t.colors?[t.colors]:null;return u(e,{lines:[t.points],updatable:t.updatable,instance:t.instance,colors:r,useVertexAlpha:t.useVertexAlpha,material:t.material},i)}function h(e,t,i=null){let a=t.points,s=t.instance,c=t.gapSize||1,u=t.dashSize||3;if(s)return(t.dashNb||t.dashSize||t.gapSize||t.useVertexAlpha||t.material)&&l.V.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),s.updateMeshPositions(e=>{let t=r.Pq.Zero(),i=e.length/6,n=0,o=0,l=0,c=0,f=0,u=0,d=0,h=0;for(d=0;d<a.length-1;d++)a[d+1].subtractToRef(a[d],t),n+=t.length();l=n/i;let p=s._creationDataStorage.dashSize;for(d=0,c=p*l/(p+s._creationDataStorage.gapSize);d<a.length-1;d++)for(a[d+1].subtractToRef(a[d],t),o=Math.floor(t.length()/l),t.normalize(),h=0;h<o&&u<e.length;)f=l*h,e[u]=a[d].x+f*t.x,e[u+1]=a[d].y+f*t.y,e[u+2]=a[d].z+f*t.z,e[u+3]=a[d].x+(f+c)*t.x,e[u+4]=a[d].y+(f+c)*t.y,e[u+5]=a[d].z+(f+c)*t.z,u+=6,h++;for(;u<e.length;)e[u]=a[d].x,e[u+1]=a[d].y,e[u+2]=a[d].z,u+=3},!1),s;let d=new o.l(e,i,null,void 0,void 0,void 0,t.useVertexAlpha,t.material);return f(t).applyToMesh(d,t.updatable),d._creationDataStorage=new n.Ez,d._creationDataStorage.dashSize=u,d._creationDataStorage.gapSize=c,d}let p={CreateDashedLines:h,CreateLineSystem:u,CreateLines:d};a.P.CreateLineSystem=c,a.P.CreateDashedLines=f,n.e.CreateLines=(e,t,i=null,r=!1,n=null)=>d(e,{points:t,updatable:r,instance:n},i),n.e.CreateDashedLines=(e,t,i,r,n,a=null,o,s)=>h(e,{points:t,dashSize:i,gapSize:r,dashNb:n,updatable:o,instance:s},a)},81019:function(e,t,i){i.d(t,{$Y:()=>s,AA:()=>l,E5:()=>o});var r=i(49477),n=i(47932),a=i(445);function o(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}function s(e){return!!(e.wasmUrl&&(e.wasmBinary||e.wasmBinaryUrl)&&"object"==typeof WebAssembly||e.fallbackUrl)}class l{constructor(e){if(e.workerPool){this._workerPoolPromise=Promise.resolve(e.workerPool);return}const t=e.wasmBinary,i=e.numWorkers??o(),s=i&&"function"==typeof Worker&&"function"==typeof URL,l=s||!e.jsModule,c=e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:l?r.S0.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:t?Promise.resolve(t):r.S0.LoadFileAsync(r.S0.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:l?r.S0.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};s?this._workerPoolPromise=c.wasmBinaryPromise.then(e=>{let t=this._getWorkerContent(),r=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));return new n.h(i,()=>{let t=new Worker(r);return(0,a.TD)(t,e,c.url)})}):this._modulePromise=c.wasmBinaryPromise.then(async t=>{if(!this._isModuleAvailable()&&!e.jsModule){if(!c.url)throw Error("Draco codec module is not available");await r.S0.LoadBabylonScriptAsync(c.url)}return await this._createModuleAsync(t,e.jsModule)})}async whenReadyAsync(){this._workerPoolPromise?await this._workerPoolPromise:this._modulePromise&&await this._modulePromise}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}}},445:function(e,t,i){function r(e,t,i,r){let n=null,a=null,o=null,s=null,l={},c=t.find(e=>"POSITION"===e.dracoName);if(!c)throw Error("Position attribute is required for Draco encoding");if(!i){let e=c.data.length/c.size;i=new(e>65535?Uint32Array:Uint16Array)(e);for(let t=0;t<e;t++)i[t]=t}try{n=new e.Encoder,a=new e.MeshBuilder,o=new e.Mesh,a.AddFacesToMesh(o,i.length/3,i);let c=new Map([[Float32Array,(e,t,i,r,n,a)=>e.AddFloatAttribute(t,i,r,n,a)],[Uint32Array,(e,t,i,r,n,a)=>e.AddUInt32Attribute(t,i,r,n,a)],[Uint16Array,(e,t,i,r,n,a)=>e.AddUInt16Attribute(t,i,r,n,a)],[Uint8Array,(e,t,i,r,n,a)=>e.AddUInt8Attribute(t,i,r,n,a)],[Int32Array,(e,t,i,r,n,a)=>e.AddInt32Attribute(t,i,r,n,a)],[Int16Array,(e,t,i,r,n,a)=>e.AddInt16Attribute(t,i,r,n,a)],[Int8Array,(e,t,i,r,n,a)=>e.AddInt8Attribute(t,i,r,n,a)]]);for(let i of t){i.data instanceof Uint8ClampedArray&&(i.data=new Uint8Array(i.data));let t=c.get(i.data.constructor),s=i.data.length/i.size;l[i.kind]=t(a,o,e[i.dracoName],s,i.size,i.data),r.quantizationBits&&r.quantizationBits[i.dracoName]&&n.SetAttributeQuantization(e[i.dracoName],r.quantizationBits[i.dracoName])}r.method&&n.SetEncodingMethod(e[r.method]),void 0!==r.encodeSpeed&&void 0!==r.decodeSpeed&&n.SetSpeedOptions(r.encodeSpeed,r.decodeSpeed),s=new e.DracoInt8Array;let f=n.EncodeMeshToDracoBuffer(o,s);if(f<=0)throw Error("Draco encoding failed.");let u=new Int8Array(f);for(let e=0;e<f;e++)u[e]=s.GetValue(e);return{data:u,attributeIds:l}}finally{o&&e.destroy(o),a&&e.destroy(a),n&&e.destroy(n),s&&e.destroy(s)}}function n(){let e;onmessage=t=>{let i=t.data;switch(i.id){case"init":i.url&&importScripts(i.url),e=DracoEncoderModule(i.wasmBinary?{wasmBinary:i.wasmBinary}:{}),postMessage({id:"initDone"});break;case"encodeMesh":if(!e)throw Error("Draco encoder module is not available");e.then(e=>{let t=r(e,i.attributes,i.indices,i.options);postMessage({id:"encodeMeshDone",encodedMeshData:t},t?[t.data.buffer]:void 0)})}}}function a(e,t,i,r,n){let a=null,o=null,s=null;try{let l;a=new e.Decoder,(o=new e.DecoderBuffer).Init(t,t.byteLength);let c=a.GetEncodedGeometryType(o);switch(c){case e.TRIANGULAR_MESH:{let t=new e.Mesh;if(!(l=a.DecodeBufferToMesh(o,t)).ok()||0===t.ptr)throw Error(l.error_msg());let i=t.num_faces(),n=3*i,c=4*n,f=e._malloc(c);try{a.GetTrianglesUInt32Array(t,c,f);let i=new Uint32Array(n);i.set(new Uint32Array(e.HEAPF32.buffer,f,n)),r(i)}finally{e._free(f)}s=t;break}case e.POINT_CLOUD:{let t=new e.PointCloud;if(!(l=a.DecodeBufferToPointCloud(o,t)).ok()||!t.ptr)throw Error(l.error_msg());s=t;break}default:throw Error(`Invalid geometry type ${c}`)}let f=s.num_points(),u=(t,i,r,a)=>{let o=a.data_type(),s=a.num_components(),l=a.normalized(),c=a.byte_stride(),u=a.byte_offset(),d={[e.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:e.HEAPF32},[e.DT_INT8]:{typedArrayConstructor:Int8Array,heap:e.HEAP8},[e.DT_INT16]:{typedArrayConstructor:Int16Array,heap:e.HEAP16},[e.DT_INT32]:{typedArrayConstructor:Int32Array,heap:e.HEAP32},[e.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:e.HEAPU8},[e.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:e.HEAPU16},[e.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:e.HEAPU32}}[o];if(!d)throw Error(`Invalid data type ${o}`);let h=f*s,p=h*d.typedArrayConstructor.BYTES_PER_ELEMENT,m=e._malloc(p);try{t.GetAttributeDataArrayForAllPoints(i,a,o,p,m);let e=new d.typedArrayConstructor(d.heap.buffer,m,h);n(r,e.slice(),s,u,c,l)}finally{e._free(m)}};if(i)for(let e in i){let t=i[e],r=a.GetAttributeByUniqueId(s,t);u(a,s,e,r)}else{let t={position:e.POSITION,normal:e.NORMAL,color:e.COLOR,uv:e.TEX_COORD};for(let e in t){let i=a.GetAttributeId(s,t[e]);if(-1!==i){let t=a.GetAttribute(s,i);u(a,s,e,t)}}}return f}finally{s&&e.destroy(s),o&&e.destroy(o),a&&e.destroy(a)}}function o(){let e;onmessage=t=>{let i=t.data;switch(i.id){case"init":i.url&&importScripts(i.url),e=DracoDecoderModule(i.wasmBinary?{wasmBinary:i.wasmBinary}:{}),postMessage({id:"initDone"});break;case"decodeMesh":if(!e)throw Error("Draco decoder module is not available");e.then(e=>{let t=a(e,i.dataView,i.attributes,e=>{postMessage({id:"indices",data:e},[e.buffer])},(e,t,i,r,n,a)=>{postMessage({id:"attribute",kind:e,data:t,size:i,byteOffset:r,byteStride:n,normalized:a},[t.buffer])});postMessage({id:"decodeMeshDone",totalVertices:t})})}}}async function s(e,t,i){return await new Promise((r,n)=>{let a=t=>{e.removeEventListener("error",a),e.removeEventListener("message",o),n(t)},o=t=>{"initDone"===t.data.id&&(e.removeEventListener("error",a),e.removeEventListener("message",o),r(e))};if(e.addEventListener("error",a),e.addEventListener("message",o),t){let r=t.slice(0);e.postMessage({id:"init",url:i,wasmBinary:r},[r])}else e.postMessage({id:"init",url:i})})}i.d(t,{Ct:()=>r,GX:()=>a,TD:()=>s,ho:()=>o,t:()=>n})},89901:function(e,t,i){i.d(t,{X:()=>f});var r=i(97782),n=i(84774),a=i(44043),o=i(35632),s=i(34600),l=i(16178),c=i(32400);n.e._GreasedLineMeshParser=(e,t)=>f.Parse(e,t);class f extends c.kH{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(l.F.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;for(let t of(this._colorPointers=[],this._points))for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,n=0,a=0,o=0;for(let t of e)o=Math.max(t.length,o),i+=2*t.length,r+=(t.length-3)*2,n+=4*t.length/3,a+=8*t.length/3;let s=new ArrayBuffer(4*i+r*(i>65535?4:2)+4*n+4*a*2),c=new ArrayBuffer((o/3+4*o)*4),u=0,d=new Float32Array(s,0,i);u+=d.byteLength;let h=i>65535?new Uint32Array(s,u,r):new Uint16Array(s,u,r),p=new Float32Array(s,u+=h.byteLength,n),m=new Float32Array(s,u+=p.byteLength,a),_=new Float32Array(s,u+=m.byteLength,a),g=0,v=0,S=0,E=0,T=0;for(let i of e){let e,r=l.F.GetLineLengthArray(i,c),n=r[r.length-1];for(let e=0,r=0;r<i.length;e++,r+=3){let n=g+2*r;if(d[n+0]=i[r+0],d[n+1]=i[r+1],d[n+2]=i[r+2],d[n+3]=i[r+0],d[n+4]=i[r+1],d[n+5]=i[r+2],r<i.length-3){let i=2*e+t,n=v+2*r;h[n+0]=i,h[n+1]=i+1,h[n+2]=i+2,h[n+3]=i+2,h[n+4]=i+1,h[n+5]=i+3}}t+=i.length/3*2;let a=2*i.length,o=d.subarray(g,g+a);g+=a,v+=(i.length-3)*2;let s=r.byteLength,u=new Float32Array(c,s,o.length),A=new Float32Array(c,s+=u.byteLength,o.length),x=o.length/6;e=f._CompareV3(0,x-1,o)?o.subarray((x-2)*6,(x-1)*6):o.subarray(0,6),u.set(e),u.set(o.subarray(0,o.length-6),6),A.set(o.subarray(6)),e=f._CompareV3(x-1,0,o)?o.subarray(6,12):o.subarray((x-1)*6,6*x),A.set(e,A.length-6);for(let e=0,t=o.length/3;e<t;e++)m[E++]=u[3*e],m[E++]=u[3*e+1],m[E++]=u[3*e+2],m[E++]=1-((1&e)<<1),_[T++]=A[3*e],_[T++]=A[3*e+1],_[T++]=A[3*e+2],_[T++]=r[e>>1]/n;if(this._options.uvs)for(let e=0;e<this._options.uvs.length;e++)p[S++]=this._options.uvs[e];else for(let e=0;e<x;e++){let t=r[e]/n,i=S+4*e;p[i+0]=t,p[i+1]=0,p[i+2]=t,p[i+3]=1}}this._vertexPositions=d,this._indices=h,this._uvs=p,this._previousAndSide=m,this._nextAndCounters=_,!this._lazy&&(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),this.doNotSyncBoundingInfo||this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){let i=this._createLineOptions(),r={};s.r.DeepCopy(i,r,["instance"],void 0,!0);let n=new f(e,this._scene,r);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){let i=e.lineOptions;return new f(e.name,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,n,a=!1){let s=new o.G,l=this.findAllIntersections(e,t,i,r,n,a,!0);if(l?.length===1){let t=l[0];s.hit=!0,s.distance=t.distance,s.ray=e,s.pickedMesh=this,s.pickedPoint=t.point}return s}findAllIntersections(e,t,i,r=!1,n,o=!1,s=!1){if(r&&!o&&!1===e.intersectsSphere(this._boundingSphere,this.intersectionThreshold))return;let l=this.getIndices(),c=this.getVerticesData(a.R.PositionKind),u=this._widths,d=this.greasedLineMaterial?.width??1,h=[];if(l&&c&&u){let t=0,i=0;for(t=0,i=l.length-1;t<i;t+=3){let i=l[t],r=l[t+1];f._V_START.fromArray(c,3*i),f._V_END.fromArray(c,3*r),this._offsets&&(f._V_OFFSET_START.fromArray(this._offsets,3*i),f._V_OFFSET_END.fromArray(this._offsets,3*r),f._V_START.addInPlace(f._V_OFFSET_START),f._V_END.addInPlace(f._V_OFFSET_END));let n=Math.floor(t/3),a=void 0!==u[n]?u[n]:1,o=this.intersectionThreshold*(d*a)/2,p=e.intersectionSegment(f._V_START,f._V_END,o);if(-1!==p&&(h.push({distance:p,point:e.direction.normalize().multiplyByFloats(p,p,p).add(e.origin)}),s))return h}t=i}return h}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){let r=6*e,n=6*t;return i[r]===i[n]&&i[r+1]===i[n+1]&&i[r+2]===i[n+2]}_createVertexBuffers(){let e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new a.h(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));let r=new a.h(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));let n=new a.h(t,this._widths,this._updatable,1);this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n;let o=new a.h(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(o.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=o,e}}f._V_START=new r.Pq,f._V_END=new r.Pq,f._V_OFFSET_START=new r.Pq,f._V_OFFSET_END=new r.Pq},6533:function(e,t,i){i.d(t,{z:()=>c});var r=i(97782),n=i(84774),a=i(44043),o=i(34600),s=i(16178),l=i(32400);n.e._GreasedLineRibbonMeshParser=(e,t)=>c.Parse(e,t);class c extends l.kH{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(s.F.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){let{options:i,pathCount:r}=this._pathsOptions[t],n=this._points[t];if(0===i.ribbonOptions.pointsMode)for(let t=0;t<r;t++)for(let t=0;t<n.length;t+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let t=0;t<n.length;t+=3){for(let t=0;t<r;t++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){let i;if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let r=0;for(let t=0,n=0;t<this._pathsOptions.length;t++){let{options:a,pathCount:o}=this._pathsOptions[t],l=e.slice(n,n+o);if(n+=o,a.ribbonOptions?.pointsMode===1)r=this._preprocess(s.F.ToVector3Array(l),r,a);else{if(a.ribbonOptions?.directionsAutoMode===99){if(!a.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";i=c._GetDirectionPlanesFromDirectionsOption(l.length,a.ribbonOptions.directions)}for(let e=0;e<l.length;e++){let t=l[e],n=c._ConvertToRibbonPath(t,a.ribbonOptions,this._scene.useRightHandedSystem,i?i[e]:i);r=this._preprocess(n,r,a)}}}!this._lazy&&(this._createVertexBuffers(),this.doNotSyncBoundingInfo||this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:Array(e).fill(t)}static _CreateRibbonVertexData(e,t){let i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";let r=[],n=[],a=e[0];for(let t=0;t<a.length;t++)for(let i=0;i<e.length;i++){let n=e[i][t];r.push(n.x,n.y,n.z)}let o=[1,0,i],s=t.ribbonOptions?.facesMode===2,l=t.ribbonOptions?.pointsMode===1&&t.ribbonOptions.closePath;if(i>2)for(let e=0;e<a.length-1;e++){o[0]=1+i*e,o[1]=i*e,o[2]=(e+1)*i;for(let e=0;e<(i-1)*2;e++)e%2!=0&&(o[2]+=1),e%2==0&&e>0&&(o[0]+=1,o[1]+=1),n.push(o[1]+(e%2!=0?i:0),o[0],o[2]),s&&n.push(o[0],o[1]+(e%2!=0?i:0),o[2])}else for(let e=0;e<r.length/3-3;e+=2)n.push(e,e+1,e+2),n.push(e+2,e+1,e+3),s&&(n.push(e+1,e,e+2),n.push(e+1,e+2,e+3));if(l){let e=i*(a.length-1);for(let t=0;t<i-1;t++)n.push(e,t+1,t),n.push(e+1,t+1,e),s&&(n.push(t,t+1,e),n.push(e,t+1,e+1)),e++}return{positions:r,indices:n}}_preprocess(e,t,i){this._paths=e;let r=c._CreateRibbonVertexData(e,i),n=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";let a=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=a;let o=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=o;let s=Array.isArray(this._indices)?this._indices:Array.from(this._indices);for(let e of(this._indices=s,n))a.push(e);let l=e;if(i.ribbonOptions?.pointsMode===1&&i.ribbonOptions.closePath){l=[];for(let t=0;t<e.length;t++){let i=e[t].slice();i.push(e[t][0].clone()),l.push(i)}}this._calculateSegmentLengths(l);let f=l.length,u=Array(f).fill(0);for(let e=0;e<l[0].length;e++){let t=0;for(let i=0;i<f;i++){let r=u[i]+this._vSegmentLengths[i][e]/this._vTotalLengths[i];this._counters.push(r),o.push(r,t),u[i]=r,t+=this._uSegmentLengths[e][i]/this._uTotalLengths[e]}}for(let e=0,t=0;e<l[0].length;e++){let i=this._uSegmentLengths[e][0]/2,r=this._uSegmentLengths[e][f-1]/2;this._ribbonWidths.push(((this._widths[t++]??1)-1)*i);for(let e=0;e<f-2;e++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[t++]??1)-1)*r)}for(let e of i.ribbonOptions?.pointsMode===1?Array(l[0].length*l.length*6).fill(0):c._CalculateSlopes(l))this._slopes.push(e);if(r.indices)for(let e=0;e<r.indices.length;e++)s.push(r.indices[e]+t);return t+=n.length/3}static _ConvertToRibbonPath(e,t,i,n){if(0===t.pointsMode&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";let a=[],o=[];if(0===t.pointsMode){let l=t.width/2,f=s.F.ToVector3Array(e),u=null,d=null;if(0===t.directionsAutoMode&&(n=c._GetDirectionFromPoints(f[0],f[1],null)),3===t.directionsAutoMode&&!(t.directions instanceof r.Pq))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";r.AA.Vector3["1"]=t.directions instanceof r.Pq?t.directions:c.DIRECTION_XZ;for(let e=0;e<f.length-!n;e++){let s=f[e],h=f[e+1];if(n)u=n;else if(3===t.directionsAutoMode)h.subtractToRef(s,r.AA.Vector3["0"]),u=r.Pq.CrossToRef(r.AA.Vector3["0"],r.AA.Vector3["1"],r.AA.Vector3["2"]).normalize();else if(1===t.directionsAutoMode)u=c._GetDirectionFromPoints(s,h,u);else{let e=h.subtract(s);e.applyRotationQuaternionInPlace(e.x>e.y&&e.x>e.z?i?c._RightHandedForwardReadOnlyQuaternion:c._LeftHandedForwardReadOnlyQuaternion:c._LeftReadOnlyQuaternion),u=e.normalize()}d=u.multiplyByFloats(l,l,l),a.push(s.add(d)),o.push(s.subtract(d))}n||(a.push(f[f.length-1].add(d)),o.push(f[f.length-1].subtract(d)))}return[a,o]}static _GetDirectionFromPoints(e,t,i){return e.x!==t.x||i&&i?.x!==1?e.y===t.y?c.DIRECTION_XZ:e.z===t.z?c.DIRECTION_XY:c.DIRECTION_XZ:c.DIRECTION_YZ}clone(e=`${this.name}-cloned`,t){let i=this._createLineOptions(),r={},n=[];o.r.DeepCopy(this._pathsOptions,n,void 0,void 0,!0),o.r.DeepCopy(i,r,["instance"],void 0,!0);let a=new c(e,this._scene,r,n);return t&&(a.parent=t),a.material=this.material,a}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){let i=e.lineOptions;return new c(e.name,t,i,e.pathOptions)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){let t=e.length;this._vSegmentLengths=Array(t),this._vTotalLengths=Array(t);let i=0;for(let r=0;r<t;r++){let t=e[r];this._vSegmentLengths[r]=[0],i=0;for(let e=0;e<t.length-1;e++){let n=Math.abs(t[e].subtract(t[e+1]).lengthSquared());i+=n,this._vSegmentLengths[r].push(n)}this._vTotalLengths[r]=i}let n=e[0].length;this._uSegmentLengths=Array(n).fill([]),this._uTotalLengths=Array(n).fill([]);let a=new r.Pq;for(let r=0;r<n;r++){i=0;for(let n=1;n<t;n++){e[n][r].subtractToRef(e[n-1][r],a);let t=a.length();i+=t,this._uSegmentLengths[r].push(t)}this._uTotalLengths[r]=i}}static _CalculateSlopes(e){let t=e[0],i=2===e.length?e[1]:e[e.length-1],n=[],a=new r.Pq;for(let r=0;r<t.length;r++)for(let o=0;o<e.length;o++)0===o||o===e.length-1?(t[r].subtract(i[r]).normalizeToRef(a),n.push(a.x,a.y,a.z),n.push(-a.x,-a.y,-a.z)):n.push(0,0,0,0,0,0);return n}_createVertexBuffers(){this._uvs=this._options.uvs??this._uvs;let e=super._createVertexBuffers(this._options.ribbonOptions?.smoothShading),t=new a.h(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));let i=new a.h(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));let r=new a.h(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));let n=new a.h(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n,e}}c.DEFAULT_WIDTH=.1,c._RightHandedForwardReadOnlyQuaternion=r.PT.RotationAxis(r.Pq.RightHandedForwardReadOnly,Math.PI/2),c._LeftHandedForwardReadOnlyQuaternion=r.PT.RotationAxis(r.Pq.LeftHandedForwardReadOnly,Math.PI/2),c._LeftReadOnlyQuaternion=r.PT.RotationAxis(r.Pq.LeftReadOnly,Math.PI/2),c.DIRECTION_XY=r.Pq.LeftHandedForwardReadOnly,c.DIRECTION_XZ=r.Pq.UpReadOnly,c.DIRECTION_YZ=r.Pq.LeftReadOnly},80400:function(e,t,i){i.d(t,{X:()=>s});var r=i(69081),n=i(65925),a=i(21678),o=i(585);class s extends n.A{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",a.J.Geometry,!0),this.registerInput("count",a.J.Int,!0,1),this.registerOutput("output",a.J.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r.Cg)([(0,o.u)("Evaluate context",0,"ADVANCED",{embedded:!0,notifiers:{rebuild:!0}})],s.prototype,"evaluateContext",void 0)},37511:function(){},43109:function(e,t,i){Object.defineProperty(i(96700).u.prototype,"decalMap",{get:function(){return this._decalMap},set:function(e){this._decalMap=e},enumerable:!0,configurable:!0})},54467:function(e,t,i){var r=i(97782),n=i(57536);n.K.prototype._projectOnTrianglesToRef=function(e,t,i,n,a,o){let s=r.AA.Vector3["0"],l=r.AA.Vector3["1"],c=Infinity;for(let o=this.indexStart;o<this.indexStart+this.indexCount-(3-n);o+=n){let n=i[o],f=i[o+1],u=i[o+2];if(a&&0xffffffff===u){o+=2;continue}let d=t[n],h=t[f],p=t[u];if(!d||!h||!p)continue;let m=r.Pq.ProjectOnTriangleToRef(e,d,h,p,l);m<c&&(s.copyFrom(l),c=m)}return o.copyFrom(s),c},n.K.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,n){let a=r.AA.Vector3["0"],o=r.AA.Vector3["1"],s=Infinity;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){let n=t[i],l=t[i+1],c=t[i+2],f=r.Pq.ProjectOnTriangleToRef(e,n,l,c,o);f<s&&(a.copyFrom(o),s=f)}return n.copyFrom(a),s},n.K.prototype.projectToRef=function(e,t,i,r){let n=this.getMaterial();if(!n)return -1;let a=3,o=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return -1;case 7:a=1,o=!0}return 4===n.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,r):this._projectOnTrianglesToRef(e,t,i,a,o,r)}},82646:function(e,t,i){var r=i(84774),n=i(44043),a=i(97782),o=i(57480),s=i(28836);r.e.prototype.thinInstanceAdd=function(e,t=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return o.V.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(e)?e.length:1);let i=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(e))for(let i=0;i<e.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e[i],i===e.length-1&&t);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e,t);return i},r.e.prototype.thinInstanceAddSelf=function(e=!0){return this.thinInstanceAdd(a.uq.IdentityReadOnly,e)},r.e.prototype.thinInstanceRegisterAttribute=function(e,t){e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this.removeVerticesData(e),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[e]=t,this._userThinInstanceBuffersStorage.sizes[e]=t*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[e]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[e]),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!0,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])},r.e.prototype.thinInstanceSetMatrixAt=function(e,t,i=!0){if(!this._thinInstanceDataStorage.matrixData||e>=this._thinInstanceDataStorage.instancesCount)return!1;let r=this._thinInstanceDataStorage.matrixData;return t.copyToArray(r,16*e),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[e]=t),i&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},r.e.prototype.thinInstanceSetAttributeAt=function(e,t,i,r=!0){return e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),!!this._userThinInstanceBuffersStorage&&!!this._userThinInstanceBuffersStorage.data[e]&&!(t>=this._thinInstanceDataStorage.instancesCount)&&(this._thinInstanceUpdateBufferSize(e,0),this._userThinInstanceBuffersStorage.data[e].set(i,t*this._userThinInstanceBuffersStorage.strides[e]),r&&this.thinInstanceBufferUpdated(e),!0)},Object.defineProperty(r.e.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(e){let t=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData;e<=(t?t.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=e)},enumerable:!0,configurable:!0}),r.e.prototype._thinInstanceCreateMatrixBuffer=function(e,t,i=!0){let r=new n.h(this.getEngine(),t,!i,16,!1,!0);for(let t=0;t<4;t++)this.setVerticesBuffer(r.createVertexBuffer(e+t,4*t,4));return r},r.e.prototype.thinInstanceSetBuffer=function(e,t,i=0,r=!0){if(i=i||16,"matrix"===e)this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=t?t.length:32*i,this._thinInstanceDataStorage.matrixData=t,this._thinInstanceDataStorage.worldMatrices=null,null!==t?(this._thinInstanceDataStorage.instancesCount=t.length/i,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",t,r),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo());else if("previousMatrix"===e)this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=t,null!==t&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",t,r));else if("splatIndex"===e&&t){this._thinInstanceInitializeUserStorage(),this._thinInstanceDataStorage.instancesCount=t.length/i,this._userThinInstanceBuffersStorage.data[e]=t,this._userThinInstanceBuffersStorage.strides[e]=i,this._userThinInstanceBuffersStorage.sizes[e]=t.length;let r=new n.h(this.getEngine(),t,!0,16,!1,!0);this._thinInstanceDataStorage.matrixBuffer=r;for(let t=0;t<4;t++)this.setVerticesBuffer(r.createVertexBuffer(e+t,4*t,4))}else e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),null===t?this._userThinInstanceBuffersStorage?.data[e]&&(this.removeVerticesData(e),delete this._userThinInstanceBuffersStorage.data[e],delete this._userThinInstanceBuffersStorage.strides[e],delete this._userThinInstanceBuffersStorage.sizes[e],delete this._userThinInstanceBuffersStorage.vertexBuffers[e]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[e]=t,this._userThinInstanceBuffersStorage.strides[e]=i,this._userThinInstanceBuffersStorage.sizes[e]=t.length,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),t,e,!r,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))},r.e.prototype.thinInstanceBufferUpdated=function(e){"matrix"===e?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):"previousMatrix"===e?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):"splatIndex"===e?this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._userThinInstanceBuffersStorage.data[e],0,this._thinInstanceDataStorage.instancesCount):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[e]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[e].isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(this._userThinInstanceBuffersStorage.data[e],0)))},r.e.prototype.thinInstancePartialBufferUpdate=function(e,t,i){"matrix"===e?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(t,i):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[e]&&this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(t,i))},r.e.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];let e=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t)this._thinInstanceDataStorage.worldMatrices[t]=a.uq.FromArray(e,16*t)}return this._thinInstanceDataStorage.worldMatrices},r.e.prototype.thinInstanceRefreshBoundingInfo=function(e=!1,t=!1,i=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;let r=this._thinInstanceDataStorage.boundingVectors;if(e||!this.rawBoundingInfo){r.length=0,this.refreshBoundingInfo(t,i);let e=this.getBoundingInfo();this.rawBoundingInfo=new s.j(e.minimum,e.maximum)}let n=this.getBoundingInfo(),o=this._thinInstanceDataStorage.matrixData;if(0===r.length)for(let e=0;e<n.boundingBox.vectors.length;++e)r.push(n.boundingBox.vectors[e].clone());a.AA.Vector3["0"].setAll(1/0),a.AA.Vector3["1"].setAll(-1/0);for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e){a.uq.FromArrayToRef(o,16*e,a.AA.Matrix["0"]);for(let e=0;e<r.length;++e)a.Pq.TransformCoordinatesToRef(r[e],a.AA.Matrix["0"],a.AA.Vector3["2"]),a.AA.Vector3["0"].minimizeInPlace(a.AA.Vector3["2"]),a.AA.Vector3["1"].maximizeInPlace(a.AA.Vector3["2"])}n.reConstruct(a.AA.Vector3["0"],a.AA.Vector3["1"]),this._updateBoundingInfo()},r.e.prototype._thinInstanceRecreateBuffer=function(e,t=!0){"matrix"===e?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,t)):"previousMatrix"===e?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,t)):(e===n.R.ColorKind&&(e=n.R.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[e]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!t,!1,this._userThinInstanceBuffersStorage.strides[e],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))},r.e.prototype._thinInstanceUpdateBufferSize=function(e,t=1){e===n.R.ColorKind&&(e=n.R.ColorInstanceKind);let i="matrix"===e;if(!i&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[e]))return;let r=i?16:this._userThinInstanceBuffersStorage.strides[e],a=i?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[e],o=i?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[e],s=(this._thinInstanceDataStorage.instancesCount+t)*r,l=a;for(;l<s;)l*=2;if(!o||a!=l){if(o){let e=new Float32Array(l);e.set(o,0),o=e}else o=new Float32Array(l);i?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",o,!1),this._thinInstanceDataStorage.matrixData=o,this._thinInstanceDataStorage.matrixBufferSize=l,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",o,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[e]?.dispose(),this._userThinInstanceBuffersStorage.data[e]=o,this._userThinInstanceBuffersStorage.sizes[e]=l,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new n.R(this.getEngine(),o,e,!0,!1,r,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))}},r.e.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},r.e.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null),this._thinInstanceDataStorage?.previousMatrixBuffer&&(this._thinInstanceDataStorage.previousMatrixBuffer.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null)}},89671:function(e,t,i){i.d(t,{V:()=>f});var r=i(69081),n=i(1742),a=i(78200),o=i(76937),s=i(97782),l=i(85269),c=i(7979);class f extends l.b{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&f.BILLBOARDMODE_USE_POSITION)!=0)}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new s.Pq(0,0,1),this._up=new s.Pq(0,1,0),this._right=new s.Pq(1,0,0),this._position=s.Pq.Zero(),this._rotation=s.Pq.Zero(),this._rotationQuaternion=null,this._scaling=s.Pq.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=f.BILLBOARDMODE_NONE,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=s.uq.Zero(),this._usePivotMatrix=!1,this._absolutePosition=s.Pq.Zero(),this._absoluteScaling=s.Pq.Zero(),this._absoluteRotationQuaternion=s.PT.Identity(),this._pivotMatrix=s.uq.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new o.cP,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){!this._isDirty&&(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return s.Pq.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return s.Pq.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return s.Pq.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?this._poseMatrix.copyFrom(e):this._poseMatrix=e.clone(),this}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=s.uq.Identity()),this._poseMatrix}_isSynchronized(){let e=this._cache;return this._billboardMode===e.billboardMode&&this._billboardMode===f.BILLBOARDMODE_NONE&&!e.pivotMatrixUpdated&&!this._infiniteDistance&&!this._position._isDirty&&!this._scaling._isDirty&&(!this._rotationQuaternion||!this._rotationQuaternion._isDirty)&&!this._rotation._isDirty&&!0}_initCache(){super._initCache();let e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=s.uq.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);for(let e of(r&&i&&i(this,r),this.getChildTransformNodes(!0)))e.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||s.PT.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){let t,i,r;if(!e)return this;if(void 0===e.x){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){let e=s.AA.Matrix["0"];this.parent.getWorldMatrix().invertToRef(e),s.Pq.TransformCoordinatesFromFloatsToRef(t,i,r,e,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=s.Pq.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let e=s.AA.Matrix["0"];return this._localMatrix.invertToRef(e),s.Pq.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=s.Pq.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,n=0){let a=f._LookAtVectorCache,o=0===n?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,i,r),1===n&&this.parent)if(this.rotationQuaternion){let e=s.AA.Matrix["0"];this.rotationQuaternion.toRotationMatrix(e);let t=s.AA.Matrix["1"];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e)}else{let e=s.AA.Quaternion["0"];s.PT.FromEulerVectorToRef(this.rotation,e);let t=s.AA.Matrix["0"];e.toRotationMatrix(t);let i=s.AA.Matrix["1"];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.invert(),t.multiplyToRef(i,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){let t=s.Pq.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return s.Pq.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){let n=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?s.PT.RotationYawPitchRollToRef(n+t,o+i,r,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=n+t,this.rotation.z=r),this}setPivotPoint(e,t=0){0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);let i=this.getWorldMatrix();if(1==t){let t=s.AA.Matrix["0"];i.invertToRef(t),e=s.Pq.TransformCoordinates(e,t)}return this.setPivotMatrix(s.uq.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){let e=s.Pq.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let e=s.Pq.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),s.Pq.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(let t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;let r=s.AA.Quaternion["0"],n=s.AA.Vector3["0"],a=s.AA.Vector3["1"],o=s.AA.Matrix["1"];s.uq.IdentityToRef(o);let l=s.AA.Matrix["0"];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=f._TmpRotation,s.PT.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),s.uq.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,r,n,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(n),this.parent=e,i&&this.setPivotMatrix(s.uq.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.parent!==this||e.setParent(null,t),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),0>e.getFinalMatrix().determinant()&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(0>this.parent.getWorldMatrix().determinant()&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null):e&&(this.parent=this._currentParentWhenAttachingToBone),this}rotate(e,t,i){let r;if(e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0)),i&&0!==i){if(this.parent){let i=this.parent.getWorldMatrix(),r=s.AA.Matrix["0"];i.invertToRef(r),e=s.Pq.TransformNormal(e,r),0>i.determinant()&&(t*=-1)}(r=s.PT.RotationAxisToRef(e,t,f._RotationAxisCache)).multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else r=s.PT.RotationAxisToRef(e,t,f._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=s.PT.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let r=s.AA.Vector3["0"],n=s.AA.Vector3["1"],a=s.AA.Vector3["2"],o=s.AA.Quaternion["0"],l=s.AA.Matrix["0"],c=s.AA.Matrix["1"],f=s.AA.Matrix["2"],u=s.AA.Matrix["3"];return e.subtractToRef(this.position,r),s.uq.TranslationToRef(r.x,r.y,r.z,l),s.uq.TranslationToRef(-r.x,-r.y,-r.z,c),s.uq.RotationAxisToRef(t,i,f),c.multiplyToRef(f,u),u.multiplyToRef(l,u),u.decompose(n,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){let r=e.scale(t);if(i&&0!==i)this.setAbsolutePosition(this.getAbsolutePosition().add(r));else{let e=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(e)}return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=s.AA.Quaternion["1"],s.PT.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));let n=s.AA.Quaternion["0"];return s.PT.RotationYawPitchRollToRef(t,e,i,n),r.multiplyInPlace(n),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==f.BILLBOARDMODE_NONE}computeWorldMatrix(e=!1,t=null){let i;if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let r=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===r||this.isSynchronized()))return this._currentRenderId=r,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();let n=this._cache;n.pivotMatrixUpdated=!1,n.billboardMode=this.billboardMode,n.infiniteDistance=this.infiniteDistance,n.parent=this._parentNode,this._currentRenderId=r,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let a=this._getEffectiveParent(),o=f._TmpScaling,l=this._position;if(this._infiniteDistance&&!this.parent&&t){let e=t.getWorldMatrix(),i=new s.Pq(e.m[12],e.m[13],e.m[14]);(l=f._TmpTranslation).copyFromFloats(this._position.x+i.x,this._position.y+i.y,this._position.z+i.z)}if(o.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant),this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,i=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(s.PT.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(i=f._TmpRotation,s.PT.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,i)),this._usePivotMatrix){let e=s.AA.Matrix["1"];s.uq.ScalingToRef(o.x,o.y,o.z,e);let t=s.AA.Matrix["0"];i.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,s.AA.Matrix["4"]),s.AA.Matrix["4"].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(l.x,l.y,l.z)}else s.uq.ComposeToRef(o,i,l,this._localMatrix);if(a&&a.getWorldMatrix){if(e&&a.computeWorldMatrix(e),this.billboardMode){if(this._transformToBoneReferal){let e=this.parent;e.getSkeleton().prepare(),e.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),s.AA.Matrix["7"])}else s.AA.Matrix["7"].copyFrom(a.getWorldMatrix());let e=s.AA.Vector3["5"],t=s.AA.Vector3["6"],i=s.AA.Quaternion["0"];s.AA.Matrix["7"].decompose(t,i,e),s.uq.ScalingToRef(t.x,t.y,t.z,s.AA.Matrix["7"]),s.AA.Matrix["7"].setTranslation(e),f.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(i,e),this._localMatrix.setTranslation(e)),this._localMatrix.multiplyToRef(s.AA.Matrix["7"],this._worldMatrix)}else if(this._transformToBoneReferal){let e=this.parent;e.getSkeleton().prepare(),this._localMatrix.multiplyToRef(e.getFinalMatrix(),s.AA.Matrix["6"]),s.AA.Matrix["6"].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(a.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(t&&this.billboardMode)if(n.useBillboardPosition){let e=s.AA.Vector3["0"];this._worldMatrix.getTranslationToRef(e);let i=t.globalPosition;this._worldMatrix.invertToRef(s.AA.Matrix["1"]);let r=s.AA.Vector3["1"];s.Pq.TransformCoordinatesToRef(i,s.AA.Matrix["1"],r),r.normalize();let n=-Math.atan2(r.z,r.x)+Math.PI/2,a=Math.sqrt(r.x*r.x+r.z*r.z),o=-Math.atan2(r.y,a);if(s.PT.RotationYawPitchRollToRef(n,o,0,s.AA.Quaternion["0"]),(this.billboardMode&f.BILLBOARDMODE_ALL)!==f.BILLBOARDMODE_ALL){let e=s.AA.Vector3["1"];s.AA.Quaternion["0"].toEulerAnglesToRef(e),(this.billboardMode&f.BILLBOARDMODE_X)!==f.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&f.BILLBOARDMODE_Y)!==f.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&f.BILLBOARDMODE_Z)!==f.BILLBOARDMODE_Z&&(e.z=0),s.uq.RotationYawPitchRollToRef(e.y,e.x,e.z,s.AA.Matrix["0"])}else s.uq.FromQuaternionToRef(s.AA.Quaternion["0"],s.AA.Matrix["0"]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(s.AA.Matrix["0"],this._worldMatrix),this._worldMatrix.setTranslation(s.AA.Vector3["0"])}else{let e=s.AA.Vector3["0"];this._worldMatrix.getTranslationToRef(e),s.AA.Matrix["1"].copyFrom(t.getViewMatrix());let i=this.getScene().useRightHandedSystem;if(i&&s.AA.Matrix["1"].multiplyToRef(f._TmpRHRestore,s.AA.Matrix["1"]),s.AA.Matrix["1"].setTranslationFromFloats(0,0,0),s.AA.Matrix["1"].invertToRef(s.AA.Matrix["0"]),(this.billboardMode&f.BILLBOARDMODE_ALL)!==f.BILLBOARDMODE_ALL){s.AA.Matrix["0"].decompose(void 0,s.AA.Quaternion["0"],void 0);let e=s.AA.Vector3["1"];s.AA.Quaternion["0"].toEulerAnglesToRef(e),(this.billboardMode&f.BILLBOARDMODE_X)!==f.BILLBOARDMODE_X&&(e.x=0),(this.billboardMode&f.BILLBOARDMODE_Y)!==f.BILLBOARDMODE_Y&&(e.y=0),(this.billboardMode&f.BILLBOARDMODE_Z)!==f.BILLBOARDMODE_Z&&(e.z=0),i&&(e.y+=Math.PI),s.uq.RotationYawPitchRollToRef(e.y,e.x,e.z,s.AA.Matrix["0"])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(s.AA.Matrix["0"],this._worldMatrix),this._worldMatrix.setTranslation(s.AA.Vector3["0"])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):a&&a._nonUniformScaling?this._updateNonUniformScalingState(a._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=s.uq.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){let e=this.getChildren();for(let t=0;t<e.length;++t){let i=e[t];if(i){i.computeWorldMatrix();let e=s.AA.Matrix["0"];i._localMatrix.multiplyToRef(this._localMatrix,e);let t=s.AA.Quaternion["0"];e.decompose(i.scaling,t,i.position),i.rotationQuaternion?i.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(i.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=s.PT.Identity()),this._worldMatrix=s.uq.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),s.Pq.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){let r=a.p.Clone(()=>new f(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){let t=this.getDescendants(!0);for(let i=0;i<t.length;i++){let n=t[i];n.clone&&n.clone(e+"."+n.name,r)}}return r}serialize(e){let t=a.p.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),a.p.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){let r=a.p.Parse(()=>new f(e.name,t),e,t,i);if(e.localMatrix?r.setPreTransformMatrix(s.uq.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(s.uq.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let t=0;t<e.animations.length;t++){let i=e.animations[t],n=(0,c.n9)("BABYLON.Animation");n&&r.animations.push(n.Parse(i))}l.b.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),r}getChildTransformNodes(e,t){let i=[];return this._getDescendants(i,e,e=>(!t||t(e))&&e instanceof f),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e)for(let e of this.getChildTransformNodes(!0))e.parent=null,e.computeWorldMatrix(!0);super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,n=null;t&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let a=this.getHierarchyBoundingVectors(e,i),o=a.max.subtract(a.min),s=Math.max(o.x,o.y,o.z);return 0===s||(this.scaling.scaleInPlace(1/s),t&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&r&&this.rotation.copyFrom(r))),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}f.BILLBOARDMODE_NONE=0,f.BILLBOARDMODE_X=1,f.BILLBOARDMODE_Y=2,f.BILLBOARDMODE_Z=4,f.BILLBOARDMODE_ALL=7,f.BILLBOARDMODE_USE_POSITION=128,f.BillboardUseParentOrientation=!1,f._TmpRotation=s.PT.Zero(),f._TmpScaling=s.Pq.Zero(),f._TmpTranslation=s.Pq.Zero(),f._TmpRHRestore=s.uq.Scaling(1,1,-1),f._LookAtVectorCache=new s.Pq(0,0,0),f._RotationAxisCache=new s.PT,(0,r.Cg)([(0,n.P_)("position")],f.prototype,"_position",void 0),(0,r.Cg)([(0,n.P_)("rotation")],f.prototype,"_rotation",void 0),(0,r.Cg)([(0,n.bR)("rotationQuaternion")],f.prototype,"_rotationQuaternion",void 0),(0,r.Cg)([(0,n.P_)("scaling")],f.prototype,"_scaling",void 0),(0,r.Cg)([(0,n.lK)("billboardMode")],f.prototype,"_billboardMode",void 0),(0,r.Cg)([(0,n.lK)()],f.prototype,"scalingDeterminant",void 0),(0,r.Cg)([(0,n.lK)("infiniteDistance")],f.prototype,"_infiniteDistance",void 0),(0,r.Cg)([(0,n.lK)()],f.prototype,"ignoreNonUniformScaling",void 0),(0,r.Cg)([(0,n.lK)()],f.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0)},95976:function(e,t,i){var r=i(38241),n=i(28802);r.Z.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new n.c(this)),this._perfCollector}},14818:function(e,t,i){i.d(t,{T:()=>a,X:()=>n});var r=i(49477);function n(){let e=null;onmessage=t=>{if("init"===t.data.action){if(t.data.url)try{importScripts(t.data.url)}catch(e){postMessage({action:"error",error:e})}e||(e=BASIS({wasmBinary:t.data.wasmBinary})),null!==e&&e.then(e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})})}else if("transcode"===t.data.action){var i,r;let e,n=t.data.config,a=t.data.imageData,o=new BASIS.BasisFile(a),s=function(e){let t=e.getHasAlpha(),i=e.getNumImages(),r=[];for(let t=0;t<i;t++){let i={levels:[]},n=e.getNumLevels(t);for(let r=0;r<n;r++){let n={width:e.getImageWidth(t,r),height:e.getImageHeight(t,r)};i.levels.push(n)}r.push(i)}return{hasAlpha:t,images:r}}(o),l=t.data.ignoreSupportedFormats?null:(i=t.data.config,r=s,e=null,i.supportedCompressionFormats&&(e=i.supportedCompressionFormats.astc?10:i.supportedCompressionFormats.bc7?6:i.supportedCompressionFormats.s3tc?r.hasAlpha?3:2:i.supportedCompressionFormats.pvrtc?r.hasAlpha?9:8:i.supportedCompressionFormats.etc2?1:14*!i.supportedCompressionFormats.etc1),e),c=!1;null===l&&(c=!0,l=s.hasAlpha?3:2);let f=!0;o.startTranscoding()||(f=!1);let u=[];for(let e=0;e<s.images.length&&f;e++){let t=s.images[e];if(void 0===n.loadSingleImage||n.loadSingleImage===e){let i=t.levels.length;!1===n.loadMipmapLevels&&(i=1);for(let r=0;r<i;r++){let i=t.levels[r],n=function(e,t,i,r,n){let a=new Uint8Array(e.getImageTranscodedSizeInBytes(t,i,r));return e.transcodeImage(a,t,i,r,1,0)?(n&&(a=function(e,t,i,r){let n=new Uint16Array(4),a=new Uint16Array(i*r),o=i/4,s=r/4;for(let t=0;t<s;t++)for(let r=0;r<o;r++){let s=0+8*(t*o+r);n[0]=e[s]|e[s+1]<<8,n[1]=e[s+2]|e[s+3]<<8,n[2]=(2*(31&n[0])+ +(31&n[1]))/3|(2*(2016&n[0])+ +(2016&n[1]))/3&2016|(2*(63488&n[0])+ +(63488&n[1]))/3&63488,n[3]=(2*(31&n[1])+ +(31&n[0]))/3|(2*(2016&n[1])+ +(2016&n[0]))/3&2016|(2*(63488&n[1])+ +(63488&n[0]))/3&63488;for(let o=0;o<4;o++){let l=e[s+4+o],c=(4*t+o)*i+4*r;a[c++]=n[3&l],a[c++]=n[l>>2&3],a[c++]=n[l>>4&3],a[c++]=n[l>>6&3]}}return a}(a,0,e.getImageWidth(t,i)+3&-4,e.getImageHeight(t,i)+3&-4)),a):null}(o,e,r,l,c);if(!n){f=!1;break}i.transcodedPixels=n,u.push(i.transcodedPixels.buffer)}}}o.close(),o.delete(),c&&(l=-1),f?postMessage({action:"transcode",success:f,id:t.data.id,fileInfo:s,format:l},u):postMessage({action:"transcode",success:f,id:t.data.id})}}}async function a(e,t,i){return await new Promise((n,a)=>{let o=t=>{"init"===t.data.action?(e.removeEventListener("message",o),n(e)):"error"===t.data.action&&a(t.data.error||"error initializing worker")};e.addEventListener("message",o),e.postMessage({action:"init",url:i?r.S0.GetBabylonScriptURL(i):void 0,wasmBinary:t},[t])})}},29919:function(e,t,i){function r(e,t,i,r){let n=r,a=0,o="";for(;n<i.length;){let r=i.charAt(n);if(o)r===o?'"'===o||"'"===o?"\\"!==i.charAt(n-1)&&(o=""):o="":"*/"===o&&"*"===r&&n+1<i.length&&("/"===i.charAt(n+1)&&(o=""),""===o&&n++);else switch(r){case e:a++;break;case t:a--;break;case'"':case"'":case"`":o=r;break;case"/":if(n+1<i.length){let e=i.charAt(n+1);"/"===e?o="\n":"*"===e&&(o="*/")}}if(n++,0===a)break}return 0===a?n-1:-1}function n(e,t){for(;t<e.length;){let i=e[t];if(" "!==i&&"\n"!==i&&"\r"!==i&&"	"!==i&&"\n"!==i&&"\xa0"!==i)break;t++}return t}function a(e){let t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122||95==t}function o(e){let t=0,i="",r=!1,n=[];for(;t<e.length;){let a=e.charAt(t);if(i)a===i?'"'===i||"'"===i?("\\"!==e.charAt(t-1)&&(i=""),n.push(a)):(i="",r=!1):"*/"===i&&"*"===a&&t+1<e.length?("/"===e.charAt(t+1)&&(i=""),""===i&&(r=!1,t++)):r||n.push(a);else{switch(a){case'"':case"'":case"`":i=a;break;case"/":if(t+1<e.length){let n=e.charAt(t+1);"/"===n?(i="\n",r=!0):"*"===n&&(i="*/",r=!0)}}r||n.push(a)}t++}return n.join("")}function s(e,t,i,r){for(;t>=0&&e.charAt(t)!==i&&(!r||e.charAt(t)!==r);)t--;return t}function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function c(e,t,i,r){let n=e.indexOf(t);if(n<0)return e;if(i){for(;n++<e.length&&"{"!=e.charAt(n););n<e.length&&(e=e.substring(0,n+1)+i+e.substring(n+1))}if(r){let t=e.lastIndexOf("}");e=e.substring(0,t)+(r+"\n}")}return e}i.d(t,{RJ:()=>o,V3:()=>l,VW:()=>r,_Z:()=>a,bI:()=>c,rU:()=>s,sz:()=>n})},16178:function(e,t,i){i.d(t,{F:()=>f});var r=i(54030),n=i(44043),a=i(97782),o=i(71350),s=i(76312),l=i(10363),c=i(14936);class f{static ConvertPoints(e,t){if(e.length&&Array.isArray(e)&&"number"==typeof e[0])return[e];if(e.length&&Array.isArray(e[0])&&"number"==typeof e[0][0])return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof a.Pq){let t=[];for(let i=0;i<e.length;i++){let r=e[i];t.push(r.x,r.y,r.z)}return[t]}if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof a.Pq){let t=[];for(let i of e)t.push(i.flatMap(e=>[e.x,e.y,e.z]));return t}if(e instanceof Float32Array)if(!t?.floatArrayStride)return[Array.from(e)];else{let i=[],r=3*t.floatArrayStride;for(let t=0;t<e.length;t+=r){let n=Array(r);for(let i=0;i<r;i++)n[i]=e[t+i];i.push(n)}return i}else if(e.length&&e[0]instanceof Float32Array){let t=[];for(let i of e)t.push(Array.from(i));return t}return[]}static OmitZeroLengthPredicate(e,t,i){let r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),0===r.length?null:r}static OmitDuplicatesPredicate(e,t,i,r){let n=[];return f._SearchInPoints(e,t,r)||n.push([e,t]),f._SearchInPoints(t,i,r)||n.push([t,i]),f._SearchInPoints(i,e,r)||n.push([i,e]),0===n.length?null:n}static _SearchInPoints(e,t,i){for(let r of i)for(let i=0;i<r.length;i++)if(r[i]?.equals(e)&&(r[i+1]?.equals(t)||r[i-1]?.equals(t)))return!0;return!1}static MeshesToLines(e,t){let i=[];for(let r=0;r<e.length;r++){let o=e[r],s=o.getVerticesData(n.R.PositionKind),l=o.getIndices();if(s&&l)for(let e=0,n=0;e<l.length;e++){let c=3*l[n++],f=3*l[n++],u=3*l[n++],d=new a.Pq(s[c],s[c+1],s[c+2]),h=new a.Pq(s[f],s[f+1],s[f+2]),p=new a.Pq(s[u],s[u+1],s[u+2]);if(t){let n=t(d,h,p,i,e,c,o,r,s,l);if(n)for(let e of n)i.push(e)}else i.push([d,h],[h,p],[p,d])}}return i}static ToVector3Array(e){if(Array.isArray(e[0])){let t=[];for(let i of e){let e=[];for(let t=0;t<i.length;t+=3)e.push(new a.Pq(i[t],i[t+1],i[t+2]));t.push(e)}return t}let t=[];for(let i=0;i<e.length;i+=3)t.push(new a.Pq(e[i],e[i+1],e[i+2]));return t}static ToNumberArray(e){return e.flatMap(e=>[e.x,e.y,e.z])}static GetPointsCountInfo(e){let t=Array(e.length),i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){let t;if(0===e.length)return 0;t="number"==typeof e[0]?f.ToVector3Array(e):e;let i=a.AA.Vector3["0"],r=0;for(let e=0;e<t.length-1;e++){let n=t[e];r+=t[e+1].subtractToRef(n,i).length()}return r}static GetLineLengthArray(e,t){let i=t?new Float32Array(t,0,e.length/3):new Float32Array(e.length/3),r=0;for(let t=0,n=e.length/3-1;t<n;t++){let n=e[3*t+0],a=e[3*t+1],o=e[3*t+2];n-=e[3*t+3],a-=e[3*t+4],r+=Math.sqrt(n*n+a*a+(o-=e[3*t+5])*o),i[t+1]=r}return i}static SegmentizeSegmentByCount(e,t,i){let r=[],n=t.subtract(e),o=a.AA.Vector3["0"];o.setAll(i);let s=a.AA.Vector3["1"];n.divideToRef(o,s);let l=e.clone();r.push(l);for(let e=0;e<i;e++)r.push((l=l.clone()).addInPlace(s));return r}static SegmentizeLineBySegmentLength(e,t){let i=e[0]instanceof a.Pq?f.GetLineSegments(e):"number"==typeof e[0]?f.GetLineSegments(f.ToVector3Array(e)):e,r=[];for(let e of i)if(e.length>t)for(let i of f.SegmentizeSegmentByCount(e.point1,e.point2,Math.ceil(e.length/t)))r.push(i);else r.push(e.point1),r.push(e.point2);return r}static SegmentizeLineBySegmentCount(e,t){let i="number"==typeof e[0]?f.ToVector3Array(e):e,r=f.GetLineLength(i)/t;return f.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){let t=[];for(let i=0;i<e.length-1;i++){let r=e[i],n=e[i+1],a=n.subtract(r).length();t.push({point1:r,point2:n,length:a})}return t}static GetMinMaxSegmentLength(e){let t=f.GetLineSegments(e).sort(e=>e.length);return{min:t[0].length,max:t[t.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){let n=t*i,o=0,s=0,l=e.length;for(let t=0;t<l;t++){if(n<=o+e[t].length){s=t;break}o+=e[t].length}let c=(n-o)/e[s].length;return e[s].point2.subtractToRef(e[s].point1,a.AA.Vector3["0"]),a.AA.Vector3["1"]=a.AA.Vector3["0"].multiplyByFloats(c,c,c),r||a.AA.Vector3["1"].addInPlace(e[s].point1),a.AA.Vector3["1"].clone()}static GetCircleLinePoints(e,t,i=0,r=e,n=2*Math.PI/t){let o=[];for(let s=0;s<=t;s++)o.push(new a.Pq(Math.cos(s*n)*e,Math.sin(s*n)*r,i));return o}static GetBezierLinePoints(e,t,i,n){return r.jj.CreateQuadraticBezier(e,t,i,n).getPoints().flatMap(e=>[e.x,e.y,e.z])}static GetArrowCap(e,t,i,r,n,a=0,o=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,n,a,o]}}static GetPointsFromText(e,t,i,r,n=0,a=!0){let s=[];for(let l of(0,o.r)(e,t,i,r)){for(let e of l.paths){let t=[];for(let i of e.getPoints())t.push(i.x,i.y,n);s.push(t)}if(a)for(let e of l.holes){let t=[];for(let i of e.getPoints())t.push(i.x,i.y,n);s.push(t)}}return s}static Color3toRGBAUint8(e){let t=new Uint8Array(4*e.length);for(let i=0,r=0;i<e.length;i++)t[r++]=255*e[i].r,t[r++]=255*e[i].g,t[r++]=255*e[i].b,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){let n=r.getEngine().getCaps().maxTextureSize??1,a=t.length>n?n:t.length,o=Math.ceil(t.length/n);o>1&&(t=[...t,...Array(a*o-t.length).fill(t[0])]);let c=f.Color3toRGBAUint8(t),u=new s.I(c,a,o,l.N.TEXTUREFORMAT_RGBA,r,!1,!0,i);return u.name=e,u}static PrepareEmptyColorsTexture(e){if(!c.T.EmptyColorsTexture){let t=new Uint8Array(4);c.T.EmptyColorsTexture=new s.I(t,1,1,l.N.TEXTUREFORMAT_RGBA,e,!1,!1,s.I.NEAREST_NEAREST),c.T.EmptyColorsTexture.name="grlEmptyColorsTexture"}return c.T.EmptyColorsTexture}static DisposeEmptyColorsTexture(){c.T.EmptyColorsTexture?.dispose(),c.T.EmptyColorsTexture=null}static BooleanToNumber(e){return+!!e}}},69418:function(e,t,i){i.d(t,{rvA:()=>J.r,LZI:()=>A.LZ,hb8:()=>n.hb,myE:()=>$.my,X5T:()=>n.X5,AVr:()=>q.AV,rNN:()=>F.r,VyI:()=>N.V,jq4:()=>q.jq,W$T:()=>$.W$,cUJ:()=>c.cU,EEw:()=>A.EE,fTt:()=>g.fT,ff7:()=>n.ff,ziR:()=>ec.z,aSt:()=>Y.a,Yog:()=>M.Y,ykX:()=>a.yk,$N5:()=>w.$,$zZ:()=>s.$z,vBu:()=>W.vB,NIX:()=>g.NI,lxt:()=>g.lx,fMk:()=>G.fM,SVS:()=>a.SV,p$b:()=>c.p$,T$1:()=>P.T,LVV:()=>y.LV,rw3:()=>n.rw,ZP5:()=>$.ZP,G9g:()=>x.lodCubePixelShader,IjJ:()=>g.Ij,afL:()=>a.af,F6r:()=>n.F6,Mj_:()=>u.M,o5w:()=>c.o5,s7E:()=>y.s7,Nf5:()=>ea.Nf,e94:()=>eh.DumpTools,j4T:()=>U.j,aBs:()=>a.aB,ruo:()=>s.ru,ZQm:()=>ee.Z,LWF:()=>q.LW,RZg:()=>c.RZ,XN1:()=>n.XN,rlp:()=>eS.r,juj:()=>k.j,ZUd:()=>r.Z,O_d:()=>b.O_,Zl$:()=>ea.Zl,Qzs:()=>ei.Qz,Lq2:()=>v.L,b3I:()=>S.b,L_L:()=>S.L,s2z:()=>G.s2,YDL:()=>T.Y,DiL:()=>eC.copyTextureToTexturePixelShaderWGSL,DCZ:()=>d.DC,NJJ:()=>$.NJ,QoC:()=>eR.copyTextureToTexturePixelShader,Rt7:()=>R.lodCubePixelShaderWGSL,qcv:()=>$.qc,qGA:()=>eh.EncodeImageAsync,Puc:()=>c.Pu,M7$:()=>C.lodPixelShaderWGSL,xLg:()=>eT.rgbdDecodePixelShader,VPl:()=>el.VP,T4F:()=>eA.rgbdEncodePixelShader,FDr:()=>ep.F,q7D:()=>es.q7,GBI:()=>B.G,bR2:()=>s.bR,lcN:()=>ef.lc,ELK:()=>q.EL,n9E:()=>D.n9,D8O:()=>er.D8,BAn:()=>ea.BA,D1Q:()=>f.D,MBK:()=>et.M,V10:()=>el.V1,WMt:()=>s.WM,r8T:()=>G.r8,w3D:()=>G.w3,lJR:()=>eb.l,KFQ:()=>ex.rgbdDecodePixelShaderWGSL,gi6:()=>L.g,hXF:()=>$.hX,wLI:()=>s.wL,rev:()=>n.re,HxD:()=>c.Hx,JyO:()=>z.Jy,VBB:()=>$.VB,M1H:()=>$.M1,kjy:()=>el.kj,shW:()=>$.sh,xGu:()=>s.xG,kmg:()=>G.km,jwY:()=>eu.j,gWE:()=>c.gW,FAz:()=>b.FA,lP4:()=>er.lP,Ajp:()=>el.Aj,daW:()=>g.d,I9v:()=>d.I9,GTp:()=>H.G,lKg:()=>s.lK,Qkj:()=>ed.Q,c9O:()=>er.c9,xiL:()=>em.x,XDJ:()=>ea.XD,$d4:()=>ee.$,UAN:()=>c.UA,dFZ:()=>eE.d,qYR:()=>c.qY,sW1:()=>Z.s,fGM:()=>eo.f,FEN:()=>el.FE,UHY:()=>q.UH,Cpb:()=>g.Cp,R$:()=>ei.R$,GJx:()=>Q.G,sss:()=>n.ss,LOb:()=>A.LO,xuI:()=>el.xu,Y5u:()=>D.Y5,hNE:()=>P.h,v9E:()=>A.v9,ccG:()=>es.cc,A8m:()=>X.A,AzY:()=>ea.Az,bub:()=>g.bu,dyi:()=>$.dy,PT9:()=>ev.P,SXx:()=>A.SX,zUw:()=>$.zU,tGV:()=>ef.tG,SVG:()=>W.SV,Mic:()=>$.Mi,f2U:()=>$.f2,dvJ:()=>d.dv,Y91:()=>s.Y9,liN:()=>W.li,fWN:()=>s.fW,nYI:()=>n.nY,aI5:()=>n.aI,fj$:()=>ei.fj,VEQ:()=>I.lodPixelShader,nyE:()=>$.ny,uTV:()=>b.uT,jTD:()=>s.jT,u1k:()=>V.u,yTS:()=>a.yT,qKZ:()=>s.qK,$eX:()=>a.$e,buA:()=>ef.bu,Vhy:()=>g.Vh,n1n:()=>s.n1,Uug:()=>D.Uu,nhr:()=>er.nh,o89:()=>g.o8,CxT:()=>s.Cx,DUA:()=>g.DU,ED9:()=>a.ED,ySZ:()=>q.yS,wqh:()=>eI.rgbdEncodePixelShaderWGSL,awT:()=>el.aw,keS:()=>K.k,pS5:()=>n.pS,qOk:()=>p.qO,Qsk:()=>A.Qs,XXF:()=>z.XX,pBU:()=>e_.p,TJM:()=>O.T,eCV:()=>$.eC,SmH:()=>ec.S,v7b:()=>g.v7,Tqw:()=>q.Tq,nQ$:()=>q.nQ,S0q:()=>y.S0,owC:()=>c.ow,wnn:()=>E.w,D3S:()=>o.DDSTools,rhY:()=>$.rh,YJ_:()=>n.YJ,CfX:()=>ef.Cf,cV4:()=>m.c,F0D:()=>et.F,GGG:()=>s.GG,H90:()=>h.H,Slg:()=>a.Sl,Rqt:()=>j.R,fOC:()=>es.fO,uMg:()=>s.uM,wSq:()=>$.wS,giD:()=>n.gi,OzP:()=>A.Oz,ir0:()=>M.i,uxr:()=>c.ux,JJR:()=>en.J,P_f:()=>s.P_,rBi:()=>_.K,mkG:()=>eg.m,r3B:()=>_.r,cPK:()=>p.cP,cRd:()=>g.cR,aCE:()=>W.aC,bPC:()=>G.bP,bj_:()=>ed.b,cYo:()=>l.c,nun:()=>p.nu,EtP:()=>n.Et,fPX:()=>G.fP,KP_:()=>z.KP,rzP:()=>$.rz});var r=i(65948),n=i(67594),a=i(93568),o=i(53063),s=i(1742),l=i(67939),c=i(62393),f=i(67496),u=i(87193),d=i(49257),h=i(4348),p=i(76937),m=i(92173),_=i(71780),g=i(22575),v=i(83638),S=i(80042),E=i(3733),T=i(40081),A=i(20486),x=i(36614),I=i(18865),R=i(70485),C=i(79354),b=i(94222),y=i(49477),L=i(91839),M=i(111),P=i(47932),N=i(57480),D=i(7979),O=i(40940),F=i(34600),w=i(19516),B=i(98671),U=i(42778),G=i(44777),V=i(28555),k=i(72665),z=i(96336),H=i(88947),W=i(77608),X=i(81231),Y=i(31073),$=i(91083),q=i(49234),Z=i(28915),j=i(50944),K=i(61503),Q=i(48511),J=i(74484),ee=i(8204),et=i(59536),ei=i(10391),er=i(6710),en=i(41910),ea=i(28573),eo=i(69990),es=i(11372),el=i(70216),ec=i(10793),ef=i(2824),eu=i(45650);p.cP.prototype.runCoroutineAsync=function(e){if(!this._coroutineScheduler){var t;let e,i,r,n,a=(t=this,e=[],i=[],r=[],n=t.add(()=>{let t=e.length;for(let n=0;n<t;n++)(0,el.FE)(e.shift(),i.shift(),r.shift())}),{scheduler:(t,n,a)=>{e.push(t),i.push(n),r.push(a)},dispose:()=>{t.remove(n)}});this._coroutineScheduler=a.scheduler,this._coroutineSchedulerDispose=a.dispose}return(0,el.kj)(e,this._coroutineScheduler)},p.cP.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};var ed=i(65148),eh=i(579),ep=i(16178),em=i(84114),e_=i(78200),eg=i(41477),ev=i(34060),eS=i(67207),eE=i(57610),eT=i(69327),eA=i(47367),ex=i(68678),eI=i(96138),eR=i(43782),eC=i(6271),eb=i(63501)},79158:function(e,t,i){function r(e,t){let i=t?.jsDecoderModule||KTX2DECODER;e&&(e.wasmBaseUrl&&(i.Transcoder.WasmBaseUrl=e.wasmBaseUrl),e.wasmUASTCToASTC&&(i.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(i.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(i.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(i.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(i.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(i.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(i.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(i.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(i.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)),t&&(t.wasmUASTCToASTC&&(i.LiteTranscoder_UASTC_ASTC.WasmBinary=t.wasmUASTCToASTC),t.wasmUASTCToBC7&&(i.LiteTranscoder_UASTC_BC7.WasmBinary=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM&&(i.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB&&(i.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=t.wasmUASTCToRGBA_SRGB),t.wasmUASTCToR8_UNORM&&(i.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=t.wasmUASTCToR8_UNORM),t.wasmUASTCToRG8_UNORM&&(i.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=t.wasmUASTCToRG8_UNORM),t.jsMSCTranscoder&&(i.MSCTranscoder.JSModule=t.jsMSCTranscoder),t.wasmMSCTranscoder&&(i.MSCTranscoder.WasmBinary=t.wasmMSCTranscoder),t.wasmZSTDDecoder&&(i.ZSTDDecoder.WasmBinary=t.wasmZSTDDecoder))}function n(e){let t;void 0===e&&"undefined"!=typeof KTX2DECODER&&(e=KTX2DECODER),onmessage=i=>{if(i.data)switch(i.data.action){case"init":{let n=i.data.urls;n&&(n.jsDecoderModule&&void 0===e&&(importScripts(n.jsDecoderModule),e=KTX2DECODER),r(n)),i.data.wasmBinaries&&r(void 0,{...i.data.wasmBinaries,jsDecoderModule:e}),t=new e.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":e.KTX2Decoder.DefaultDecoderOptions=i.data.options;break;case"decode":t.decode(i.data.data,i.data.caps,i.data.options).then(e=>{let t=[];for(let i=0;i<e.mipmaps.length;++i){let r=e.mipmaps[i];r&&r.data&&t.push(r.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:e},t)}).catch(e=>{postMessage({action:"decoded",success:!1,msg:e})})}}}async function a(e,t,i){return await new Promise((r,n)=>{let a=t=>{e.removeEventListener("error",a),e.removeEventListener("message",o),n(t)},o=t=>{"init"===t.data.action&&(e.removeEventListener("error",a),e.removeEventListener("message",o),r(e))};e.addEventListener("error",a),e.addEventListener("message",o),e.postMessage({action:"init",urls:i,wasmBinaries:t})})}i.d(t,{TD:()=>a,XE:()=>n,x2:()=>r})},57480:function(e,t,i){i.d(t,{V:()=>r});class r{static _CheckLimit(e,t){let i=r._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},r._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){let i=r._LogLimitOutputs[e];if(!i||!r.MessageLimitReached)return;let n=this._Levels[t];i.current===i.limit&&r[n.name](r.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,n.name??""))}static _AddLogEntry(e){r._LogCache=e+r._LogCache,r.OnNewCacheEntry&&r.OnNewCacheEntry(e)}static _FormatMessage(e){let t=e=>e<10?"0"+e:""+e,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){let n=Array.isArray(t)?t[0]:t;if(void 0!==i&&!r._CheckLimit(n,i))return;let a=r._FormatMessage(n),o=this._Levels[e],s=Array.isArray(t)?t.slice(1):[];o.logFunc&&o.logFunc("BJS - "+a,...s);let l=`<div style='color:${o.color}'>${a}</div><br>`;r._AddLogEntry(l),r._GenerateLimitMessage(n,e)}static get LogCache(){return r._LogCache}static ClearLogCache(){r._LogCache="",r._LogLimitOutputs={},r.errorsCount=0}static set LogLevels(e){for(let t of(r.Log=r._LogDisabled,r.Warn=r._LogDisabled,r.Error=r._LogDisabled,[r.MessageLogLevel,r.WarningLogLevel,r.ErrorLogLevel]))(e&t)===t&&(r[this._Levels[t].name]=r._LogEnabled.bind(r,t))}}r.NoneLogLevel=0,r.MessageLogLevel=1,r.WarningLogLevel=2,r.ErrorLogLevel=4,r.AllLogLevel=7,r.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.",r._LogCache="",r._LogLimitOutputs={},r._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}],r.errorsCount=0,r.Log=r._LogEnabled.bind(r,r.MessageLogLevel),r.Warn=r._LogEnabled.bind(r,r.WarningLogLevel),r.Error=r._LogEnabled.bind(r,r.ErrorLogLevel)},44777:function(e,t,i){i.d(t,{bP:()=>T,fM:()=>g,fP:()=>_,km:()=>E,r8:()=>v,s2:()=>S,w3:()=>x});var r=i(46538),n=i(40933),a=i(79954),o=i(57480),s=i(49477),l=i(579),c=i(20486),f=i(62355),u=i(49997),d=i(21811),h=i(94598),p=i(94609);let m=null;function _(e,t,i,r,n="image/png",a=!1,l,c=!1,f=!1){let{height:u,width:d}=A(e,t,i);if(!(u&&d))return void o.V.Error("Invalid 'size' parameter !");let h=t.getScene(),g=h.activeCamera!==t;if(h.frameGraph){let e=p.Fd.FindMainObjectRenderer(h.frameGraph);e&&(g=e.camera!==t)}g?S(e,t,i,e=>{if(a){let t=new Blob([e]);s.S0.DownloadBlob(t),r&&r("")}else r&&r(e)},n,1,e.getCreationOptions().antialias,void 0,void 0,void 0,void 0,l):e.onEndFrameObservable.addOnce(()=>{m||(m=document.createElement("canvas")),m.width=d,m.height=u;let t=m.getContext("2d"),i=e.getRenderingCanvas();if(!t||!i)return void o.V.Error("Failed to create screenshot. Rendering context or rendering canvas is not available.");let p=i.width,_=i.height,g=m.width,v=m.height,S=g/p,E=v/_,T=c?Math.max(S,E):Math.min(S,E),A=p*T,x=_*T;t.save(),t.fillStyle=f?h.clearColor.toHexString():"rgba(0, 0, 0, 0)",t.fillRect(0,0,d,u),t.restore(),t.drawImage(i,0,0,p,_,(g-A)/2,(v-x)/2,A,x),a?(s.S0.EncodeScreenshotCanvasData(m,void 0,n,void 0,l),r&&r("")):s.S0.EncodeScreenshotCanvasData(m,r,n,void 0,l)})}async function g(e,t,i,r="image/png",n,a=!1,o=!1,s=!1){return await new Promise((l,c)=>{_(e,t,i,e=>{void 0!==e?l(e):c(Error("Data is undefined"))},r,s,n,a,o)})}async function v(e,t,i,r,n="image/png",a,o=!1){return await new Promise(s=>{_(e,t,{width:i,height:r},()=>{s()},n,!0,a,o)})}function S(e,t,s,u,d="image/png",h=1,p=!1,m,_=!1,g=!1,v=!0,E,x,I){let R=t.getScene();if(R.frameGraph)return void T(R.frameGraph,t,s,d,h,p,m,E,I,!u).then(e=>{u&&u(e)});let{height:C,width:b,finalWidth:y,finalHeight:L}=A(e,t,s);if(!(C&&b))return void o.V.Error("Invalid 'size' parameter !");e.skipFrameRender=!0;let M=e.getRenderWidth,P=e.getRenderHeight;e.getRenderWidth=(t=!1)=>!t&&e._currentRenderTarget?e._currentRenderTarget.width:b,e.getRenderHeight=(t=!1)=>!t&&e._currentRenderTarget?e._currentRenderTarget.height:C,e.onResizeObservable.hasObservers()&&e.onResizeObservable.notifyObservers(e);let N=new n.$("screenShot",{width:b,height:C},R,!1,!1,0,!1,r.g.BILINEAR_SAMPLINGMODE,void 0,g,void 0,void 0,void 0,h);N.renderList=R.meshes.slice(),N.samples=h,N.renderSprites=_,N.activeCamera=t,N.forceLayerMaskCheck=v,x?.(N);let D=I||l.DumpData,O=()=>{R.incrementRenderId(),R.resetCachedMaterial(),(0,f.B)(()=>N.isReadyForRendering()&&t.isReady(!0),()=>{e.onEndFrameObservable.addOnce(()=>{y===b&&L===C?N.readPixels(void 0,void 0,void 0,!1).then(e=>{D(b,C,e,u,d,m,!0,void 0,E),N.dispose()}):(e.isWebGPU?Promise.resolve().then(i.bind(i,73368)):Promise.resolve().then(i.bind(i,99665))).then(async()=>await (0,c.Qs)("pass",N.getInternalTexture(),R,void 0,void 0,void 0,y,L).then(t=>{e._readTexturePixels(t,y,L,-1,0,null,!0,!1,0,0).then(e=>{D(y,L,e,u,d,m,!0,void 0,E),t.dispose()})}))}),R.incrementRenderId(),R.resetCachedMaterial();let r=R.activeCamera,n=R.activeCameras,a=t.outputRenderTarget,o=R.spritesEnabled;R.activeCamera=t,R.activeCameras=null,t.outputRenderTarget=N,R.spritesEnabled=_;let s=R.meshes;R.meshes=N.renderList||R.meshes;try{R.render()}finally{R.activeCamera=r,R.activeCameras=n,t.outputRenderTarget=a,R.spritesEnabled=o,R.meshes=s,e.getRenderWidth=M,e.getRenderHeight=P,e.onResizeObservable.hasObservers()&&e.onResizeObservable.notifyObservers(e),t.getProjectionMatrix(!0),e.skipFrameRender=!1}},()=>{e.skipFrameRender=!1,e.getRenderWidth=M,e.getRenderHeight=P})};if(p){let e=new a.a("antialiasing",1,R.activeCamera);N.addPostProcess(e),e.autoClear=!0,e.onEffectCreatedObservable.addOnce(e=>{e.isReady()?O():e.onCompiled=()=>{O()}})}else O()}async function E(e,t,i,r="image/png",n=1,a=!1,o,s=!1,l=!1,c=!0,f,u,d){return await new Promise((h,p)=>{S(e,t,i,e=>{void 0!==e?h(e):p(Error("Data is undefined"))},r,n,a,o,s,l,c,f,u,d)})}async function T(e,t,i,r="image/png",n=1,a=!1,o,s,c,f=!1,m){let _=e.engine,g=e.textureManager,{height:v,width:S,finalWidth:E,finalHeight:x}=A(_,t,i),I={width:S,height:v},R=c||l.DumpData,C=e.tasks,b=C.length,y=e.pausedExecution,L=_.getCaps().parallelShaderCompile;g.setBackBufferTextures(0,0,{size:I,options:{createMipMaps:!1,samples:n,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["screenshot color"]},sizeIsPercentage:!1},{size:I,options:{createMipMaps:!1,samples:n,types:[0],formats:[_.isStencilEnable?13:14],useSRGBBuffers:[!1],creationFlags:[0],labels:["screenshot depth"]},sizeIsPercentage:!1});let M=u.O;if(a){let t=new d.$("fxaa",e);t.sourceTexture=M,M=t.outputTexture,e.addTask(t)}if(E!==S||x!==v){let t=new h.m("pass",e);t.sourceTexture=M,t.targetTexture=e.textureManager.createRenderTargetTexture("pass_output",{size:{width:E,height:x},options:{createMipMaps:!1,types:[0],formats:[5],samples:1,labels:["screenshot_final_texture"],useSRGBBuffers:[!1]},sizeIsPercentage:!1}),M=t.outputTexture,e.addTask(t)}let P=p.Fd.FindMainObjectRenderer(e),N=null;P&&(N=P.camera,P.camera=t),_.getCaps().parallelShaderCompile=void 0,await e.buildAsync();let D=m??(g.hasHistoryTextures?32:1);for(let t=0;t<D;++t)e.execute();e.pausedExecution=!0,_.getCaps().parallelShaderCompile=L;for(let t=b;t<C.length;++t)e.tasks[t].dispose();e.tasks.length=b,P&&N&&(P.camera=N);let O=e.textureManager.getTextureFromHandle(M);return O.incrementReferences(),g.resetBackBufferTextures(),await e.buildAsync(),e.pausedExecution=y,new Promise(e=>{_._readTexturePixels(O,E,x,-1,0,null,!0,!1,0,0).then(async t=>{O.dispose(),R(E,x,t,f?void 0:t=>e(t),r,o,!0,void 0,s),f&&e(null)})})}function A(e,t,i){let r=0,n=0,a=0,o=0;if("object"==typeof i){let s=i.precision?Math.abs(i.precision):1;i.width&&i.height?(r=i.height*s,n=i.width*s):i.width&&!i.height?r=Math.round((n=i.width*s)/e.getAspectRatio(t)):i.height&&!i.width?n=Math.round((r=i.height*s)*e.getAspectRatio(t)):r=Math.round((n=Math.round(e.getRenderWidth()*s))/e.getAspectRatio(t)),i.finalWidth&&i.finalHeight?(o=i.finalHeight,a=i.finalWidth):i.finalWidth&&!i.finalHeight?o=Math.round((a=i.finalWidth)/e.getAspectRatio(t)):i.finalHeight&&!i.finalWidth?a=Math.round((o=i.finalHeight)*e.getAspectRatio(t)):(a=n,o=r)}else isNaN(i)||(r=i,n=i,a=i,o=i);return n&&(n=Math.floor(n)),r&&(r=Math.floor(r)),a&&(a=Math.floor(a)),o&&(o=Math.floor(o)),{height:0|r,width:0|n,finalWidth:0|a,finalHeight:0|o}}let x={CreateScreenshot:_,CreateScreenshotAsync:g,CreateScreenshotWithResizeAsync:v,CreateScreenshotUsingRenderTarget:S,CreateScreenshotUsingRenderTargetAsync:E,CreateScreenshotForFrameGraphAsync:T};s.S0.CreateScreenshot=_,s.S0.CreateScreenshotAsync=g,s.S0.CreateScreenshotUsingRenderTarget=S,s.S0.CreateScreenshotUsingRenderTargetAsync=E},3253:function(e,t,i){i.d(t,{W:()=>n});var r=i(28555);async function n(e,t){let i=t.method||"GET";return await new Promise((n,a)=>{let o=new r.u;o.addEventListener("readystatechange",()=>{if(4==o.readyState)if(200==o.status){let e={};if(t.responseHeaders)for(let i of t.responseHeaders)e[i]=o.getResponseHeader(i)||"";n({response:o.response,headerValues:e})}else a(`Unable to fetch data from ${e}. Error code: ${o.status}`)}),o.open(i,e),o.send()})}},31607:function(){},55879:function(){},47146:function(){},15224:function(){},40829:function(){},18637:function(e,t,i){i.d(t,{G:()=>r});function r(e){e._localPosition?e._localPosition.copyFrom(e.position):e._localPosition=e.position.clone()}},36812:function(e,t,i){i.d(t,{W:()=>n});var r=i(71459);function n(e,t,i){let n=new r.i;n.scene=t;let a=e.createSystem(n);return a.canStart=()=>!0,a.emitter=i.clone(),a.disposeOnStop=!0,a.start(),a}},30032:function(e,t,i){function r(e,t){e.previousItem=t.previousItem,e.nextItem=t,t.previousItem&&(t.previousItem.nextItem=e),t.previousItem=e}function n(e,t){e.previousItem=t,e.nextItem=t.nextItem,t.nextItem&&(t.nextItem.previousItem=e),t.nextItem=e}function a(e,t){let i=t;for(;i.nextItem;)i=i.nextItem;e.previousItem=i,e.nextItem=i.nextItem,i.nextItem=e}function o(e){e.previousItem&&(e.previousItem.nextItem=e.nextItem),e.nextItem&&(e.nextItem.previousItem=e.previousItem)}i.d(t,{E_:()=>n,lF:()=>r,nD:()=>o,zf:()=>a})},3333:function(e,t,i){i.d(t,{DG:()=>p,Iu:()=>u,PQ:()=>h,Pp:()=>c,gQ:()=>d,kH:()=>m,s5:()=>_,wb:()=>f});var r=i(97782),n=i(75563),a=i(34954),o=i(46994),s=i(43251),l=i(71728);function c(e,t){let i=new n.H;return i.direction1=e,i.direction2=t,i}function f(e=1,t=1){return new a.w(e,t)}function u(e=1,t=1){return new o.Q(e,t)}function d(e=1,t=new r.Pq(0,1,0),i=new r.Pq(0,1,0)){return new o.c(e,t,i)}function h(e=1,t=1,i=1,r=0){return new s.l(e,t,i,r)}function p(e=1,t=1,i=1,n=new r.Pq(0,1,0),a=new r.Pq(0,1,0)){return new s.J(e,t,i,n,a)}function m(e=1,t=Math.PI/4){return new l.A(e,t)}function _(e=1,t=Math.PI/4,i=new r.Pq(0,1,0),n=new r.Pq(0,1,0)){return new l.g(e,t,i,n)}},48759:function(e,t,i){var r=i(84774),n=i(44022),a=i(48014),o=i(89270),s=i(39393),l=i(6243);(0,l.ji)(o.v.NAME_PARTICLESYSTEM,(e,t,i,r)=>{let n=(0,l.LO)(o.v.NAME_PARTICLESYSTEM);if(n&&void 0!==e.particleSystems&&null!==e.particleSystems)for(let a=0,o=e.particleSystems.length;a<o;a++){let o=e.particleSystems[a];i.particleSystems.push(n(o,t,r))}}),(0,l.cf)(o.v.NAME_PARTICLESYSTEM,(e,t,i)=>e.activeParticleCount?n.A.Parse(e,t,i):a.o.Parse(e,t,i)),s.$.prototype.createEffectForParticles=function(e,t=[],r=[],n="",o,s,l,c,f=0,u){let d=[],h=[],p=[];return c?c.fillUniformsAttributesAndSamplerNames(h,d,p):(d=a.o._GetAttributeNamesOrOptions(),h=a.o._GetEffectCreationOptions()),-1===n.indexOf(" BILLBOARD")&&(n+="\n#define BILLBOARD\n"),c?.isAnimationSheetEnabled&&-1===n.indexOf(" ANIMATESHEET")&&(n+="\n#define ANIMATESHEET\n"),-1===r.indexOf("diffuseSampler")&&r.push("diffuseSampler"),this.createEffect({vertex:u??c?.vertexShaderName??"particles",fragmentElement:e},d,h.concat(t),p.concat(r),n,o,s,l,void 0,f,async()=>{0===f?await Promise.resolve().then(i.bind(i,55311)):await Promise.resolve().then(i.bind(i,62212))})},r.e.prototype.getEmittedParticleSystems=function(){let e=[];for(let t=0;t<this.getScene().particleSystems.length;t++){let i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},r.e.prototype.getHierarchyEmittedParticleSystems=function(){let e=[],t=this.getDescendants();t.push(this);for(let i=0;i<this.getScene().particleSystems.length;i++){let r=this.getScene().particleSystems[i],n=r.emitter;n.position&&-1!==t.indexOf(n)&&e.push(r)}return e}},91756:function(e,t,i){i.d(t,{T:()=>ee});var r=i(77608),n=i(76937),a=i(97782),o=i(44043),s=i(76312),l=i(37702),c=i(18527),f=i(40387),u=i(33909),d=i(55322);i(1526);var h=i(32481),p=i(86732),m=i(16578),_=i(52754),g=i(20565);function v(e,t){let i=(0,_.RandomRange)(0,1);d.ov.LerpToRef(t.color1,t.color2,i,e.color)}function S(e,t){t.colorDead.subtractToRef(e.color,t._colorDiff),t._colorDiff.scaleToRef(1/e.lifeTime,e.colorStep)}function E(e,t){e._currentColorGradient=t._colorGradients[0],e._currentColorGradient.getColorToRef(e.color),e._currentColor1.copyFrom(e.color),t._colorGradients.length>1?t._colorGradients[1].getColorToRef(e._currentColor2):e._currentColor2.copyFrom(e.color)}function T(e,t){let i=t._colorGradients;r.vB.GetCurrentGradient(t._ratio,i,(t,i,r)=>{t!==e._currentColorGradient&&(e._currentColor1.copyFrom(e._currentColor2),i.getColorToRef(e._currentColor2),e._currentColorGradient=t),d.ov.LerpToRef(e._currentColor1,e._currentColor2,r,e.color),e.color.a<0&&(e.color.a=0)})}function A(e,t){e.colorStep.scaleToRef(t._scaledUpdateSpeed,t._scaledColorStep),e.color.addInPlace(t._scaledColorStep),e.color.a<0&&(e.color.a=0)}function x(e,t){r.vB.GetCurrentGradient(t._ratio,t._angularSpeedGradients,(t,i,r)=>{t!==e._currentAngularSpeedGradient&&(e._currentAngularSpeed1=e._currentAngularSpeed2,e._currentAngularSpeed2=i.getFactor(),e._currentAngularSpeedGradient=t),e.angularSpeed=(0,_.Lerp)(e._currentAngularSpeed1,e._currentAngularSpeed2,r)})}function I(e,t){e.angle+=e.angularSpeed*t._scaledUpdateSpeed}function R(e,t){t.particleEmitterType.startDirectionFunction(t._emitterWorldMatrix,e.direction,e,t.isLocal,t._emitterInverseWorldMatrix)}function C(e,t){t.startDirectionFunction(t._emitterWorldMatrix,e.direction,e,t.isLocal)}function b(e,t){e._currentVelocityGradient=t._velocityGradients[0],e._currentVelocity1=e._currentVelocityGradient.getFactor(),t._velocityGradients.length>1?e._currentVelocity2=t._velocityGradients[1].getFactor():e._currentVelocity2=e._currentVelocity1}function y(e,t){e._currentLimitVelocityGradient=t._limitVelocityGradients[0],e._currentLimitVelocity1=e._currentLimitVelocityGradient.getFactor(),t._limitVelocityGradients.length>1?e._currentLimitVelocity2=t._limitVelocityGradients[1].getFactor():e._currentLimitVelocity2=e._currentLimitVelocity1}function L(e,t){r.vB.GetCurrentGradient(t._ratio,t._velocityGradients,(t,i,r)=>{t!==e._currentVelocityGradient&&(e._currentVelocity1=e._currentVelocity2,e._currentVelocity2=i.getFactor(),e._currentVelocityGradient=t),e._directionScale*=(0,_.Lerp)(e._currentVelocity1,e._currentVelocity2,r)})}function M(e,t){r.vB.GetCurrentGradient(t._ratio,t._limitVelocityGradients,(i,r,n)=>{i!==e._currentLimitVelocityGradient&&(e._currentLimitVelocity1=e._currentLimitVelocity2,e._currentLimitVelocity2=r.getFactor(),e._currentLimitVelocityGradient=i);let a=(0,_.Lerp)(e._currentLimitVelocity1,e._currentLimitVelocity2,n);e.direction.length()>a&&e.direction.scaleInPlace(t.limitVelocityDamping)})}function P(e){e.direction.scaleToRef(e._directionScale,e._scaledDirection)}function N(e,t){t.particleEmitterType.startPositionFunction(t._emitterWorldMatrix,e.position,e,t.isLocal)}function D(e,t){t.startPositionFunction(t._emitterWorldMatrix,e.position,e,t.isLocal)}function O(e,t){e._localPosition?e._localPosition.copyFrom(e.position):e._localPosition=e.position.clone(),a.Pq.TransformCoordinatesToRef(e._localPosition,t._emitterWorldMatrix,e.position)}function F(e,t){t.isLocal&&e._localPosition?(e._localPosition.addInPlace(e._scaledDirection),a.Pq.TransformCoordinatesToRef(e._localPosition,t._emitterWorldMatrix,e.position)):e.position.addInPlace(e._scaledDirection)}function w(e,t){e._currentDragGradient=t._dragGradients[0],e._currentDrag1=e._currentDragGradient.getFactor(),t._dragGradients.length>1?e._currentDrag2=t._dragGradients[1].getFactor():e._currentDrag2=e._currentDrag1}function B(e,t){r.vB.GetCurrentGradient(t._ratio,t._dragGradients,(t,i,r)=>{t!==e._currentDragGradient&&(e._currentDrag1=e._currentDrag2,e._currentDrag2=i.getFactor(),e._currentDragGradient=t);let n=(0,_.Lerp)(e._currentDrag1,e._currentDrag2,r);e._scaledDirection.scaleInPlace(1-n)})}function U(e,t){e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),e._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(e._randomNoiseCoordinates1=new a.Pq(Math.random(),Math.random(),Math.random()),e._randomNoiseCoordinates2=new a.Pq(Math.random(),Math.random(),Math.random()))}function G(e,t){let i=t._noiseTextureData,r=t._noiseTextureSize;if(i&&r&&e._randomNoiseCoordinates1){let n=t._fetchR(e._randomNoiseCoordinates1.x,e._randomNoiseCoordinates1.y,r.width,r.height,i),o=t._fetchR(e._randomNoiseCoordinates1.z,e._randomNoiseCoordinates2.x,r.width,r.height,i),s=t._fetchR(e._randomNoiseCoordinates2.y,e._randomNoiseCoordinates2.z,r.width,r.height,i),l=a.AA.Vector3["0"],c=a.AA.Vector3["1"];l.copyFromFloats((2*n-1)*t.noiseStrength.x,(2*o-1)*t.noiseStrength.y,(2*s-1)*t.noiseStrength.z),l.scaleToRef(t._tempScaledUpdateSpeed,c),e.direction.addInPlace(c)}}function V(e,t){t.gravity.scaleToRef(t._tempScaledUpdateSpeed,t._scaledGravity),e.direction.addInPlace(t._scaledGravity)}function k(e,t){e.size=(0,_.RandomRange)(t.minSize,t.maxSize),e.scale.copyFromFloats((0,_.RandomRange)(t.minScaleX,t.maxScaleX),(0,_.RandomRange)(t.minScaleY,t.maxScaleY))}function z(e,t){e._currentSizeGradient=t._sizeGradients[0],e._currentSize1=e._currentSizeGradient.getFactor(),e.size=e._currentSize1,t._sizeGradients.length>1?e._currentSize2=t._sizeGradients[1].getFactor():e._currentSize2=e._currentSize1,e.scale.copyFromFloats((0,_.RandomRange)(t.minScaleX,t.maxScaleX),(0,_.RandomRange)(t.minScaleY,t.maxScaleY))}function H(e,t){let i=t._actualFrame/t.targetStopDuration;r.vB.GetCurrentGradient(i,t._startSizeGradients,(i,r,n)=>{i!==t._currentStartSizeGradient&&(t._currentStartSize1=t._currentStartSize2,t._currentStartSize2=r.getFactor(),t._currentStartSizeGradient=i);let a=(0,_.Lerp)(t._currentStartSize1,t._currentStartSize2,n);e.scale.scaleInPlace(a)})}function W(e,t){r.vB.GetCurrentGradient(t._ratio,t._sizeGradients,(t,i,r)=>{t!==e._currentSizeGradient&&(e._currentSize1=e._currentSize2,e._currentSize2=i.getFactor(),e._currentSizeGradient=t),e.size=(0,_.Lerp)(e._currentSize1,e._currentSize2,r)})}function X(e,t){e.remapData=new a.IU(0,1,0,1)}function Y(e,t){t._colorRemapGradients&&t._colorRemapGradients.length>0&&r.vB.GetCurrentGradient(t._ratio,t._colorRemapGradients,(t,i,r)=>{let n=(0,_.Lerp)(t.factor1,i.factor1,r),a=(0,_.Lerp)(t.factor2,i.factor2,r);e.remapData.x=n,e.remapData.y=a-n}),t._alphaRemapGradients&&t._alphaRemapGradients.length>0&&r.vB.GetCurrentGradient(t._ratio,t._alphaRemapGradients,(t,i,r)=>{let n=(0,_.Lerp)(t.factor1,i.factor1,r),a=(0,_.Lerp)(t.factor2,i.factor2,r);e.remapData.z=n,e.remapData.w=a-n})}function $(e,t){let i=(0,_.Clamp)(t._actualFrame/t.targetStopDuration);r.vB.GetCurrentGradient(i,t._lifeTimeGradients,(t,r)=>{let n=t.getFactor(),a=r.getFactor(),o=(i-t.gradient)/(r.gradient-t.gradient);e.lifeTime=(0,_.Lerp)(n,a,o)}),t._emitPower=(0,_.RandomRange)(t.minEmitPower,t.maxEmitPower)}function q(e,t){e.lifeTime=(0,_.RandomRange)(t.minLifeTime,t.maxLifeTime),t._emitPower=(0,_.RandomRange)(t.minEmitPower,t.maxEmitPower)}function Z(e,t){0===t._emitPower?(e._initialDirection?e._initialDirection.copyFrom(e.direction):e._initialDirection=e.direction.clone(),e.direction.set(0,0,0)):(e._initialDirection=null,e.direction.scaleInPlace(t._emitPower)),e.direction.addInPlace(t._inheritedVelocityOffset)}function j(e,t){e.angularSpeed=(0,_.RandomRange)(t.minAngularSpeed,t.maxAngularSpeed),e.angle=(0,_.RandomRange)(t.minInitialRotation,t.maxInitialRotation)}function K(e,t){e._currentAngularSpeedGradient=t._angularSpeedGradients[0],e.angularSpeed=e._currentAngularSpeedGradient.getFactor(),e._currentAngularSpeed1=e.angularSpeed,t._angularSpeedGradients.length>1?e._currentAngularSpeed2=t._angularSpeedGradients[1].getFactor():e._currentAngularSpeed2=e._currentAngularSpeed1,e.angle=(0,_.RandomRange)(t.minInitialRotation,t.maxInitialRotation)}function Q(e,t){e._initialStartSpriteCellId=t.startSpriteCellID,e._initialEndSpriteCellId=t.endSpriteCellID,e._initialSpriteCellLoop=t.spriteCellLoop}var J=i(30032);class ee extends c.L{get startDirectionFunction(){return this._startDirectionFunction}set startDirectionFunction(e){this._startDirectionFunction!==e&&(this._startDirectionFunction=e,e?this._directionProcessing.process=C:this._directionProcessing.process=R)}get startPositionFunction(){return this._startPositionFunction}set startPositionFunction(e){this._startPositionFunction!==e&&(this._startPositionFunction=e,e?this._positionCreation.process=D:this._positionCreation.process=N)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isDisposed(){return this._isDisposed}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect(),e?(this._rampCreation={process:X,previousItem:null,nextItem:null},(0,J.E_)(this._rampCreation,this._colorDeadCreation),this._remapGradientProcessing={process:Y,previousItem:null,nextItem:null},(0,J.E_)(this._remapGradientProcessing,this._gravityProcessing)):((0,J.nD)(this._rampCreation),(0,J.nD)(this._remapGradientProcessing)))}get isLocal(){return this._isLocal}set isLocal(e){this._isLocal!==e&&(this._isLocal=e,e?(this._isLocalCreation={process:O,previousItem:null,nextItem:null},(0,J.E_)(this._isLocalCreation,this._positionCreation)):(0,J.nD)(this._isLocalCreation))}get particles(){return this._particles}get shaderLanguage(){return this._shaderLanguage}get _isAnimationSheetEnabled(){return this._animationSheetEnabled}set _isAnimationSheetEnabled(e){this._animationSheetEnabled!==e&&(this._animationSheetEnabled=e,e?(this._sheetCreation={process:Q,previousItem:null,nextItem:null},(0,J.E_)(this._sheetCreation,this._colorDeadCreation)):(0,J.nD)(this._sheetCreation),this._reset())}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new u.E(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new n.cP),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get noiseTexture(){return this._noiseTexture}set noiseTexture(e){if(this.noiseTexture!==e){if(this._noiseTexture=e,!e){(0,J.nD)(this._noiseCreation),(0,J.nD)(this._noiseProcessing);return}this._noiseCreation={process:U,previousItem:null,nextItem:null},(0,J.E_)(this._noiseCreation,this._colorDeadCreation),this._noiseProcessing={process:G,previousItem:null,nextItem:null},(0,J.E_)(this._noiseProcessing,this._positionProcessing)}}constructor(e,t,i,r=null,o=!1,s=.01,c=!1){super(e),this._emitterInverseWorldMatrix=a.uq.Identity(),this._startDirectionFunction=null,this._startPositionFunction=null,this._inheritedVelocityOffset=new a.Pq,this.onDisposeObservable=new n.cP,this.onStoppedObservable=new n.cP,this.onStartedObservable=new n.cP,this._noiseTextureSize=null,this._noiseTextureData=null,this._particles=[],this._stockParticles=[],this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new d.ov(0,0,0,0),this._colorDiff=new d.ov(0,0,0,0),this._scaledGravity=a.Pq.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._isDisposed=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._updateQueueStart=null,this._startSizeCreation=null,this._createQueueStart=null,this._isLocal=!1,this.isGPU=!1,this._shaderLanguage=0,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=e=>{},this.recycleParticle=e=>{let t=this._particles.pop();t!==e&&t.copyTo(e),this._stockParticles.push(t)},this._createParticle=()=>{let e;return 0!==this._stockParticles.length?(e=this._stockParticles.pop())._reset():e=new f.J(this),this._prepareParticle(e),e},this.paused=!1,this._shadersLoaded=!1,this._capacity=t,this._epsilon=s,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=a.uq.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||l.q.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._initShaderSourceAsync(),this._lifeTimeCreation={process:q,previousItem:null,nextItem:null},this._positionCreation={process:N,previousItem:null,nextItem:null},(0,J.E_)(this._positionCreation,this._lifeTimeCreation),this._directionCreation={process:R,previousItem:null,nextItem:null},(0,J.E_)(this._directionCreation,this._positionCreation),this._emitPowerCreation={process:Z,previousItem:null,nextItem:null},(0,J.E_)(this._emitPowerCreation,this._directionCreation),this._sizeCreation={process:k,previousItem:null,nextItem:null},(0,J.E_)(this._sizeCreation,this._emitPowerCreation),this._angleCreation={process:j,previousItem:null,nextItem:null},(0,J.E_)(this._angleCreation,this._sizeCreation),this._colorCreation={process:v,previousItem:null,nextItem:null},(0,J.E_)(this._colorCreation,this._angleCreation),this._colorDeadCreation={process:S,previousItem:null,nextItem:null},(0,J.E_)(this._colorDeadCreation,this._colorCreation),this._createQueueStart=this._lifeTimeCreation,c||(this._colorProcessing={process:A,previousItem:null,nextItem:null},this._angularSpeedProcessing={process:I,previousItem:null,nextItem:null},(0,J.E_)(this._angularSpeedProcessing,this._colorProcessing),this._directionProcessing={process:P,previousItem:null,nextItem:null},(0,J.E_)(this._directionProcessing,this._angularSpeedProcessing),this._positionProcessing={process:F,previousItem:null,nextItem:null},(0,J.E_)(this._positionProcessing,this._directionProcessing),this._gravityProcessing={process:V,previousItem:null,nextItem:null},(0,J.E_)(this._gravityProcessing,this._positionProcessing),this._updateQueueStart=this._colorProcessing),this._isAnimationSheetEnabled=o,this._attachImageProcessingConfiguration(null),this._customWrappers={0:new u.E(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new m.K,this.updateFunction=e=>{this.noiseTexture&&(this._noiseTextureSize=this.noiseTexture.getSize(),this.noiseTexture.getContent()?.then(e=>{this._noiseTextureData=e}));let t=e===this._particles;for(let i=0;i<e.length;i++){let r=e[i];this._tempScaledUpdateSpeed=this._scaledUpdateSpeed;let n=r.age;if(r.age+=this._tempScaledUpdateSpeed,r.age>r.lifeTime){let e=r.age-n,t=r.lifeTime-n;this._tempScaledUpdateSpeed=t*this._tempScaledUpdateSpeed/e,r.age=r.lifeTime}this._ratio=r.age/r.lifeTime,r._directionScale=this._tempScaledUpdateSpeed;let a=this._updateQueueStart;for(;a;)a.process(r,this),a=a.nextItem;if(this._isAnimationSheetEnabled&&!c&&r.updateCellIndex(),r._inheritParticleInfoToSubEmitters(),r.age>=r.lifeTime){if(this._emitFromParticle(r),r._attachedSubEmitters){for(let e of r._attachedSubEmitters)e.particleSystem.disposeOnStop=!0,e.particleSystem.stop();r._attachedSubEmitters=null}this.recycleParticle(r),t&&i--;continue}}}}serialize(e){throw Error("Method not implemented.")}clone(e,t,i=!1){throw Error("Method not implemented.")}_addFactorGradient(e,t,i,n){let a=new r.SV(t,i,n);e.push(a),e.sort((e,t)=>e.gradient<t.gradient?-1:+(e.gradient>t.gradient))}_removeFactorGradient(e,t){if(!e)return;let i=0;for(let r of e){if(r.gradient===t){e.splice(i,1);break}i++}}_syncLifeTimeCreation(){if(this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){this._lifeTimeCreation.process=$;return}this._lifeTimeCreation.process=q}_syncStartSizeCreation(){if(this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){this._startSizeCreation||(this._startSizeCreation={process:H,previousItem:null,nextItem:null},(0,J.E_)(this._startSizeCreation,this._sizeCreation));return}this._startSizeCreation&&((0,J.nD)(this._startSizeCreation),this._startSizeCreation=null)}get targetStopDuration(){return this._targetStopDuration}set targetStopDuration(e){this.targetStopDuration!==e&&(this._targetStopDuration=e,this._syncLifeTimeCreation(),this._syncStartSizeCreation())}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this._syncLifeTimeCreation(),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this._syncLifeTimeCreation(),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),0===this._sizeGradients.length&&(this._sizeCreation.process=z,this._sizeGradientProcessing={process:W,previousItem:null,nextItem:null},(0,J.lF)(this._sizeGradientProcessing,this._gravityProcessing)),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this._sizeGradients?.length===0&&((0,J.nD)(this._sizeGradientProcessing),this._sizeCreation.process=k),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),0===this._angularSpeedGradients.length&&(this._angleCreation.process=K,this._angularSpeedGradientProcessing={process:x,previousItem:null,nextItem:null},(0,J.lF)(this._angularSpeedGradientProcessing,this._angularSpeedProcessing)),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this._angularSpeedGradients?.length===0&&(this._angleCreation.process=j,(0,J.nD)(this._angularSpeedGradientProcessing)),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),0===this._velocityGradients.length&&(this._velocityCreation={process:b,previousItem:null,nextItem:null},(0,J.E_)(this._velocityCreation,this._angleCreation),this._velocityGradientProcessing={process:L,previousItem:null,nextItem:null},(0,J.lF)(this._velocityGradientProcessing,this._directionProcessing)),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this._velocityGradients?.length===0&&((0,J.nD)(this._velocityCreation),(0,J.nD)(this._velocityGradientProcessing)),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),0===this._limitVelocityGradients.length&&(this._limitVelocityCreation={process:y,previousItem:null,nextItem:null},(0,J.E_)(this._limitVelocityCreation,this._angleCreation),this._limitVelocityGradientProcessing={process:M,previousItem:null,nextItem:null},(0,J.E_)(this._limitVelocityGradientProcessing,this._directionProcessing)),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this._limitVelocityGradients?.length===0&&((0,J.nD)(this._limitVelocityCreation),(0,J.nD)(this._limitVelocityGradientProcessing)),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),0===this._dragGradients.length&&(this._dragCreation={process:w,previousItem:null,nextItem:null},(0,J.lF)(this._dragCreation,this._colorDeadCreation),this._dragGradientProcessing={process:B,previousItem:null,nextItem:null},(0,J.lF)(this._dragGradientProcessing,this._positionProcessing)),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this._dragGradients?.length===0&&((0,J.nD)(this._dragCreation),(0,J.nD)(this._dragGradientProcessing)),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this._syncStartSizeCreation(),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this._syncStartSizeCreation(),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;let e=new Uint8Array(4*this._rawTextureWidth),t=d.IG.Color3["0"];for(let i=0;i<this._rawTextureWidth;i++){let n=i/this._rawTextureWidth;r.vB.GetCurrentGradient(n,this._rampGradients,(r,n,a)=>{d.v9.LerpToRef(r.color,n.color,a,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255})}this._rampGradientsTexture=s.I.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((e,t)=>e.gradient<t.gradient?-1:+(e.gradient>t.gradient)),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);let i=new r.li(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]),0===this._colorGradients.length&&(this._colorCreation.process=E,this._colorProcessing.process=T);let n=new r.aC(e,t,i);return this._colorGradients.push(n),this._colorGradients.sort((e,t)=>e.gradient<t.gradient?-1:+(e.gradient>t.gradient)),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(let i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return 0===this._colorGradients.length&&(this._colorCreation.process=v,this._colorProcessing.process=A),this}resetDrawCache(){if(this._drawWrappers){for(let e of this._drawWrappers)if(e)for(let t of e)t?.dispose();this._drawWrappers=[]}}_fetchR(e,t,i,r,n){return n[(((e=.5*Math.abs(e)+.5)*i%i|0)+((t=.5*Math.abs(t)+.5)*r%r|0)*i)*4]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){let e;this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),this._isBillboardBased&&8!==this.billboardMode&&9!==this.billboardMode||(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);let t=this._engine,i=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*i),this._vertexBuffer=new o.h(t,this._vertexData,!0,i);let r=0,n=this._vertexBuffer.createVertexBuffer(o.R.PositionKind,r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[o.R.PositionKind]=n,r+=3;let a=this._vertexBuffer.createVertexBuffer(o.R.ColorKind,r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[o.R.ColorKind]=a,r+=4;let s=this._vertexBuffer.createVertexBuffer("angle",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=s,r+=1;let l=this._vertexBuffer.createVertexBuffer("size",r,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=l,r+=2,this._isAnimationSheetEnabled){let e=this._vertexBuffer.createVertexBuffer("cellIndex",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=e,r+=1}if(!this._isBillboardBased||8===this.billboardMode||9===this.billboardMode){let e=this._vertexBuffer.createVertexBuffer("direction",r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=e,r+=3}if(this._useRampGradients){let e=this._vertexBuffer.createVertexBuffer("remapData",r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=e,r+=4}if(this._useInstancing){let i=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new o.h(t,i,!1,2),e=this._spriteBuffer.createVertexBuffer("offset",0,2)}else e=this._vertexBuffer.createVertexBuffer("offset",r,2,this._vertexBufferSize,this._useInstancing),r+=2;this._vertexBuffers.offset=e,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]));return}let e=[],t=[],i=0;for(let r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){this.startDelay=e,setTimeout(()=>{this.start(0)},e);return}if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){this.emitter?.getClassName().indexOf("Mesh")!==-1&&this.emitter.computeWorldMatrix(!0);let e=this.noiseTexture;if(e&&e.onGeneratedObservable)e.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let t=0;t<this.preWarmCycles;t++)this.animate(!0),e.render()})});else for(let e=0;e<this.preWarmCycles;e++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop),this.onStartedObservable.notifyObservers(this)}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(e))}_postStop(e){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,r){let n=e*this._vertexBufferSize,o=a.AA.Vector3["0"].copyFrom(this._scene?.floatingOriginOffset||a.Pq.ZeroReadOnly);if(this._vertexData[n++]=t.position.x+this.worldOffset.x-o.x,this._vertexData[n++]=t.position.y+this.worldOffset.y-o.y,this._vertexData[n++]=t.position.z+this.worldOffset.z-o.z,this._vertexData[n++]=t.color.r,this._vertexData[n++]=t.color.g,this._vertexData[n++]=t.color.b,this._vertexData[n++]=t.color.a,this._vertexData[n++]=t.angle,this._vertexData[n++]=t.scale.x*t.size,this._vertexData[n++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[n++]=t.cellIndex),this._isBillboardBased)(8===this.billboardMode||9===this.billboardMode)&&(this._vertexData[n++]=t.direction.x,this._vertexData[n++]=t.direction.y,this._vertexData[n++]=t.direction.z);else if(t._initialDirection){let e=t._initialDirection;this.isLocal&&(a.Pq.TransformNormalToRef(e,this._emitterWorldMatrix,a.AA.Vector3["0"]),e=a.AA.Vector3["0"]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[n++]=e.x,this._vertexData[n++]=e.y,this._vertexData[n++]=e.z}else{let e=t.direction;this.isLocal&&(a.Pq.TransformNormalToRef(e,this._emitterWorldMatrix,a.AA.Vector3["0"]),e=a.AA.Vector3["0"]),0===e.x&&0===e.z&&(e.x=.001),this._vertexData[n++]=e.x,this._vertexData[n++]=e.y,this._vertexData[n++]=e.z}this._useRampGradients&&t.remapData&&(this._vertexData[n++]=t.remapData.x,this._vertexData[n++]=t.remapData.y,this._vertexData[n++]=t.remapData.z,this._vertexData[n++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon)),this._vertexData[n++]=i,this._vertexData[n++]=r)}_prepareParticle(e){}_createNewOnes(e){let t;for(let i=0;i<e&&this._particles.length!==this._capacity;i++){t=this._createParticle(),this._particles.push(t);let e=this._createQueueStart;for(;e;)e.process(t,this),e=e.nextItem;t._inheritParticleInfoToSubEmitters()}}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){let e=this.emitter;this._emitterWorldMatrix=e.getWorldMatrix()}else{let e=this.emitter;this._emitterWorldMatrix=a.uq.Translation(e.x,e.y,e.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles),this._createNewOnes(e)}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){let r=[o.R.PositionKind,o.R.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){let r=["invView","view","projection","textureMask","translationPivot","eyePosition"];return(0,h.Ll)(r),e&&r.push("particlesInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t,i=!0){if(this._scene&&((0,h.r4)(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&0!==this._scene.fogMode&&e.push("#define FOG")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===c.L.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case 2:e.push("#define BILLBOARDY");break;case 8:case 9:e.push("#define BILLBOARDSTRETCHED"),9===this.billboardMode&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:e.push("#define BILLBOARDMODE_ALL")}i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...ee._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&8!==this.billboardMode&&9!==this.billboardMode,this._useRampGradients)),e.push(...ee._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&((0,g._)(e,this._imageProcessingConfigurationDefines),(0,g.C)(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){let t=this._getCustomDrawWrapper(e);if(t?.effect)return t;let i=[];this.fillDefines(i,e);let r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,n=this._drawWrappers[r];n||(n=this._drawWrappers[r]=[]);let a=n[e];a||((a=new u.E(this._engine)).drawContext&&(a.drawContext.useInstancing=this._useInstancing),n[e]=a);let o=i.join("\n");if(a.defines!==o){let e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),a.setEffect(this._engine.createEffect("particles",e,t,i,o,void 0,void 0,void 0,void 0,this._shaderLanguage),o)}return a}animate(e=!1){let t;if(this._started&&!this.paused){if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}if(this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this.manualEmitCount>-1)t=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let e=this._calculateEmitRate();t=e*this._scaledUpdateSpeed|0,this._newPartsExcess+=e*this._scaledUpdateSpeed-t}if(this._newPartsExcess>1&&(t+=0|this._newPartsExcess,this._newPartsExcess-=0|this._newPartsExcess),this._alive=!1,this._stopped?t=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(t),this._stopped&&!this._alive&&(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this)),!e){let e=0;for(let t=0;t<this._particles.length;t++){let i=this._particles[t];this._appendParticleVertices(e,i),e+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}0===this.manualEmitCount&&this.disposeOnStop&&this.stop()}}_calculateEmitRate(){let e=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){let t=this._actualFrame/this.targetStopDuration;r.vB.GetCurrentGradient(t,this._emitRateGradients,(t,i,r)=>{t!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=i.getFactor(),this._currentEmitRateGradient=t),e=(0,_.Lerp)(this._currentEmitRate1,this._currentEmitRate2,r)})}return e}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),this._spriteBuffer?._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!ee.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,62212)),Promise.resolve().then(i.bind(i,46574))])):await Promise.all([Promise.resolve().then(i.bind(i,55311)),Promise.resolve().then(i.bind(i,64197))]),this._shadersLoaded=!0}isReady(){if(!this._shadersLoaded||!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==c.L.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(c.L.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(c.L.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(e){let t=this._getWrapper(e),i=t.effect,r=this._engine;r.enableEffect(t);let n=this.defaultViewMatrix??this._scene.getViewMatrix();if(i.setTexture("diffuseSampler",this.particleTexture),i.setMatrix("view",n),i.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){let e=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,this.spriteCellWidth/e.width)}if(i.setVector2("translationPivot",this.translationPivot),i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){let e=this._scene.activeCamera;i.setVector3("eyePosition",e.globalPosition)}this._rampGradientsTexture&&(this._rampGradients&&this._rampGradients.length||(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),i.setTexture("rampSampler",this._rampGradientsTexture));let o=i.defines;return this._scene&&((0,h.ij)(i,this,this._scene),this.applyFog&&(0,p.Yy)(this._scene,void 0,i)),o.indexOf("#define BILLBOARDMODE_ALL")>=0&&(n.invertToRef(a.AA.Matrix["0"]),i.setMatrix("invView",a.AA.Matrix["0"])),void 0!==this._vertexArrayObject?this._scene?.forceWireframe?r.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,i):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,i)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):this._indexBuffer?r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBuffer:this._indexBuffer,i):r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null,i),this.useLogarithmicDepth&&this._scene&&(0,p.DL)(o,i,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(i),this._setEngineBasedOnBlendMode(e),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(i),this._useInstancing?this._scene?.forceWireframe?r.drawElementsType(6,0,10,this._particles.length):r.drawArraysType(7,0,4,this._particles.length):this._scene?.forceWireframe?r.drawElementsType(1,0,10*this._particles.length):r.drawElementsType(0,0,6*this._particles.length),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;let e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return t=this.blendMode===c.L.BLENDMODE_MULTIPLYADD?this._render(c.L.BLENDMODE_MULTIPLY)+this._render(c.L.BLENDMODE_ADD):this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}_onDispose(e=!1,t=!1){}dispose(e=!0,t=!1,i=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(t,i),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){let e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.onStartedObservable.clear(),this.reset(),this._isDisposed=!0}}ee.ForceGLSL=!1},703:function(e,t,i){i.d(t,{d:()=>n});var r=i(97782);class n{constructor(){this._hasHit=!1,this._hitNormal=r.Pq.Zero(),this._hitPoint=r.Pq.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}},54785:function(e,t,i){var r=i(57480),n=i(76937),a=i(89270),o=i(38241),s=i(2062),l=i(81871);o.Z.prototype.getPhysicsEngine=function(){return this._physicsEngine??null},o.Z.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(a.v.NAME_PHYSICSENGINE);i||(i=new c(this),this._addComponent(i));try{if(t&&t?.getPluginVersion()!==1)if(t?.getPluginVersion()===2)this._physicsEngine=new l.A(e,t);else throw Error("Unsupported Physics plugin version.");else this._physicsEngine=new s.A(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return r.V.Error(e.message),!1}},o.Z.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},o.Z.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},o.Z.prototype.deleteCompoundImpostor=function(e){let t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},o.Z.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){let t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class c{constructor(e){this.name=a.v.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new n.cP,this.scene.onAfterPhysicsObservable=new n.cP,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}i(39607);var f=i(89671);Object.defineProperty(f.V.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)})))},enumerable:!0,configurable:!0}),f.V.prototype.getPhysicsBody=function(){return this.physicsBody},f.V.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this},f.V.prototype.applyAngularImpulse=function(e){if(!this.physicsBody)throw Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(e),this}},29065:function(){},50299:function(){},48972:function(){},39607:function(e,t,i){var r=i(96700),n=i(90878);Object.defineProperty(r.u.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0}),r.u.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},r.u.prototype.applyImpulse=function(e,t){return this.physicsImpostor&&this.physicsImpostor.applyImpulse(e,t),this},r.u.prototype.setPhysicsLinkWith=function(e,t,i,r){return this.physicsImpostor&&e.physicsImpostor&&this.physicsImpostor.createJoint(e.physicsImpostor,n.W$.HingeJoint,{mainPivot:t,connectedPivot:i,nativeParams:r}),this}},3143:function(e,t,i){var r,n,a,o,s,l,c,f,u,d,h,p,m,_,g,v,S,E;i.d(t,{AH:()=>c,DK:()=>o,Y1:()=>n,YK:()=>l,f9:()=>f,nC:()=>u,oE:()=>s,vX:()=>a,yc:()=>r}),(d=r||(r={}))[d.FREE=0]="FREE",d[d.LIMITED=1]="LIMITED",d[d.LOCKED=2]="LOCKED",(h=n||(n={}))[h.LINEAR_X=0]="LINEAR_X",h[h.LINEAR_Y=1]="LINEAR_Y",h[h.LINEAR_Z=2]="LINEAR_Z",h[h.ANGULAR_X=3]="ANGULAR_X",h[h.ANGULAR_Y=4]="ANGULAR_Y",h[h.ANGULAR_Z=5]="ANGULAR_Z",h[h.LINEAR_DISTANCE=6]="LINEAR_DISTANCE",(p=a||(a={}))[p.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",p[p.DISTANCE=2]="DISTANCE",p[p.HINGE=3]="HINGE",p[p.SLIDER=4]="SLIDER",p[p.LOCK=5]="LOCK",p[p.PRISMATIC=6]="PRISMATIC",p[p.SIX_DOF=7]="SIX_DOF",(m=o||(o={}))[m.SPHERE=0]="SPHERE",m[m.CAPSULE=1]="CAPSULE",m[m.CYLINDER=2]="CYLINDER",m[m.BOX=3]="BOX",m[m.CONVEX_HULL=4]="CONVEX_HULL",m[m.CONTAINER=5]="CONTAINER",m[m.MESH=6]="MESH",m[m.HEIGHTFIELD=7]="HEIGHTFIELD",(_=s||(s={}))[_.NONE=0]="NONE",_[_.VELOCITY=1]="VELOCITY",_[_.POSITION=2]="POSITION",(g=l||(l={})).COLLISION_STARTED="COLLISION_STARTED",g.COLLISION_CONTINUED="COLLISION_CONTINUED",g.COLLISION_FINISHED="COLLISION_FINISHED",g.TRIGGER_ENTERED="TRIGGER_ENTERED",g.TRIGGER_EXITED="TRIGGER_EXITED",(v=c||(c={}))[v.STATIC=0]="STATIC",v[v.ANIMATED=1]="ANIMATED",v[v.DYNAMIC=2]="DYNAMIC",(S=f||(f={}))[S.DISABLED=0]="DISABLED",S[S.TELEPORT=1]="TELEPORT",S[S.ACTION=2]="ACTION",(E=u||(u={}))[E.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",E[E.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",E[E.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE"},7469:function(e,t,i){i.d(t,{P:()=>S});var r=i(97782),n=i(3143),a=i(90310),o=i(57480),s=i(2044),l=i(37619),c=i(84774),f=i(69195),u=i(44043),d=i(73896),h=i(76937);class p{constructor(e,t,i){this._vertices=[],this._indices=[],this._isRightHanded=i.useRightHandedSystem,this._collectIndices=t}addNodeMeshes(e,t){e.computeWorldMatrix(!0);let i=r.AA.Matrix["0"];if(r.uq.ScalingToRef(e.absoluteScaling.x,e.absoluteScaling.y,e.absoluteScaling.z,i),e instanceof c.e?this._addMesh(e,i):e instanceof f.Z&&this._addMesh(e.sourceMesh,i),t){let t=r.AA.Matrix["1"];e.computeWorldMatrix().invertToRef(t);let n=r.AA.Matrix["2"];for(let a of(t.multiplyToRef(i,n),e.getChildMeshes(!1).filter(e=>!e.physicsBody))){let e=a.computeWorldMatrix(),t=r.AA.Matrix["3"];e.multiplyToRef(n,t),a instanceof c.e?this._addMesh(a,t):a instanceof f.Z&&this._addMesh(a.sourceMesh,t)}}}_addMesh(e,t){let i=e.getVerticesData(u.R.PositionKind)||[],n=i.length/3,a=this._vertices.length;for(let e=0;e<n;e++){let n=new r.Pq(i[3*e+0],i[3*e+1],i[3*e+2]);this._vertices.push(r.Pq.TransformCoordinates(n,t))}if(this._collectIndices){let t=e.getIndices();if(t)for(let e=0;e<t.length;e+=3)this._isRightHanded?(this._indices.push(t[e+0]+a),this._indices.push(t[e+1]+a),this._indices.push(t[e+2]+a)):(this._indices.push(t[e+2]+a),this._indices.push(t[e+1]+a),this._indices.push(t[e+0]+a))}}getVertices(e){let t=3*this._vertices.length,i=e._malloc(4*t),r=new Float32Array(e.HEAPU8.buffer,i,t);for(let e=0;e<this._vertices.length;e++)r[3*e+0]=this._vertices[e].x,r[3*e+1]=this._vertices[e].y,r[3*e+2]=this._vertices[e].z;return{offset:i,numObjects:t}}freeBuffer(e,t){e._free(t.offset)}getTriangles(e){let t=4*this._indices.length,i=e._malloc(t),r=new Int32Array(e.HEAPU8.buffer,i,this._indices.length);for(let e=0;e<this._indices.length;e++)r[e]=this._indices[e];return{offset:i,numObjects:this._indices.length}}}class m{constructor(e){this.hpBodyId=e,this.userMassProps={centerOfMass:void 0,mass:void 0,inertia:void 0,inertiaOrientation:void 0}}}class _{constructor(){this.bodyId=BigInt(0),this.position=new r.Pq,this.normal=new r.Pq}}class g{constructor(){this.contactOnA=new _,this.contactOnB=new _,this.impulseApplied=0,this.type=0}static readToRef(e,t,i){let r=new Int32Array(e,t),n=new Float32Array(e,t);i.contactOnA.bodyId=BigInt(r[2]),i.contactOnA.position.set(n[10],n[11],n[12]),i.contactOnA.normal.set(n[13],n[14],n[15]),i.contactOnB.bodyId=BigInt(r[18]),i.contactOnB.position.set(n[26],n[27],n[28]),i.contactOnB.normal.set(n[29],n[30],n[31]),i.impulseApplied=n[34],i.type=r[0]}}class v{constructor(){this.bodyIdA=BigInt(0),this.bodyIdB=BigInt(0),this.type=0}static readToRef(e,t,i){let r=new Int32Array(e,t);i.type=r[0],i.bodyIdA=BigInt(r[2]),i.bodyIdB=BigInt(r[6])}}class S{constructor(e=!0,t=HK,i={}){if(this._useDeltaForWorldStep=e,this._hknp={},this.name="HavokPlugin",this._multiQueryCollector=void 0,this._fixedTimeStep=1/60,this._maxQueryCollectorHits=1,this._tmpVec3=(0,d.mI)(3,r.Pq.Zero),this._bodies=new Map,this._shapes=new Map,this._bodyCollisionObservable=new Map,this._constraintToBodyIdPair=new Map,this._bodyCollisionEndedObservable=new Map,this.onCollisionObservable=new h.cP,this.onCollisionEndedObservable=new h.cP,this.onTriggerCollisionObservable=new h.cP,"function"==typeof t)return void o.V.Error("Havok is not ready. Please make sure you await HK() before using the plugin.");if(this._hknp=t,!this.isSupported())return void o.V.Error("Havok is not available. Please make sure you included the js file.");this.world=this._hknp.HP_World_Create()[1],this._queryCollector=this._hknp.HP_QueryCollector_Create(1)[1],this.setMaxQueryCollectorHits(i.maxQueryCollectorHits??1)}isSupported(){return void 0!==this._hknp}setGravity(e){this._hknp.HP_World_SetGravity(this.world,this._bVecToV3(e))}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}setMaxQueryCollectorHits(e){e!==this._maxQueryCollectorHits&&(this._multiQueryCollector&&(this._hknp.HP_QueryCollector_Release(this._multiQueryCollector),this._multiQueryCollector=void 0),e>1&&(this._multiQueryCollector=this._hknp.HP_QueryCollector_Create(e)[1]))}getMaxQueryCollectorHits(){return this._maxQueryCollectorHits}executeStep(e,t){for(let e of t)e.disablePreStep||this.setPhysicsBodyTransformation(e,e.transformNode);let i=this._useDeltaForWorldStep?e:this._fixedTimeStep;for(let e of(this._hknp.HP_World_SetIdealStepTime(this.world,i),this._hknp.HP_World_Step(this.world,i),this._bodyBuffer=this._hknp.HP_World_GetBodyBuffer(this.world)[1],t))e.disableSync||this.sync(e);this._notifyCollisions(),this._notifyTriggers()}getPluginVersion(){return 2}setVelocityLimits(e,t){this._hknp.HP_World_SetSpeedLimit(this.world,e,t)}getMaxLinearVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[1]}getMaxAngularVelocity(){return this._hknp.HP_World_GetSpeedLimit(this.world)[2]}initBody(e,t,i,r){e._pluginData=new m(this._hknp.HP_Body_Create()[1]),this._internalSetMotionType(e._pluginData,t);let n=[this._bVecToV3(i),this._bQuatToV4(r)];this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,n),this._hknp.HP_World_AddBody(this.world,e._pluginData.hpBodyId,e.startAsleep),this._bodies.set(e._pluginData.hpBodyId[0],{body:e,index:0})}removeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(let t of e._pluginDataInstances)this._bodyCollisionObservable.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._bodies.delete(t.hpBodyId[0]);e._pluginData&&(this._bodyCollisionObservable.delete(e._pluginData.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,e._pluginData.hpBodyId),this._bodies.delete(e._pluginData.hpBodyId[0]))}initBodyInstances(e,t,i){let r=i._thinInstanceDataStorage?.instancesCount??0,n=i._thinInstanceDataStorage.matrixData;if(n){this._createOrUpdateBodyInstances(e,t,n,0,r,!1);for(let t=0;t<e._pluginDataInstances.length;t++){let i=e._pluginDataInstances[t];this._bodies.set(i.hpBodyId[0],{body:e,index:t})}}}_createOrUpdateBodyInstances(e,t,i,n,a,o){let s=r.AA.Quaternion["0"],l=r.uq.Identity();for(let c=n;c<a;c++){let n,a=[i[16*c+12],i[16*c+13],i[16*c+14]];n=o?e._pluginDataInstances[c].hpBodyId:this._hknp.HP_Body_Create()[1],l.setRowFromFloats(0,i[16*c+0],i[16*c+1],i[16*c+2],0),l.setRowFromFloats(1,i[16*c+4],i[16*c+5],i[16*c+6],0),l.setRowFromFloats(2,i[16*c+8],i[16*c+9],i[16*c+10],0),r.PT.FromRotationMatrixToRef(l,s);let f=[a,[s.x,s.y,s.z,s.w]];if(this._hknp.HP_Body_SetQTransform(n,f),!o){let i=new m(n);e._pluginDataInstances.length&&(i.userMassProps=e._pluginDataInstances[0].userMassProps),this._internalSetMotionType(i,t),this._internalUpdateMassProperties(i),e._pluginDataInstances.push(i),this._hknp.HP_World_AddBody(this.world,n,e.startAsleep),i.worldTransformOffset=this._hknp.HP_Body_GetWorldTransformOffset(n)[1]}}}updateBodyInstances(e,t){let i=t._thinInstanceDataStorage?.instancesCount??0,r=t._thinInstanceDataStorage.matrixData;if(!r)return;let n=e._pluginDataInstances.length,a=this.getMotionType(e);if(i>n){this._createOrUpdateBodyInstances(e,a,r,n,i,!1);let t=this._hknp.HP_Body_GetShape(e._pluginDataInstances[0].hpBodyId)[1];t[0]||(t[0]=e.shape?._pluginData[0]);for(let r=n;r<i;r++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[r].hpBodyId,t),this._internalUpdateMassProperties(e._pluginDataInstances[r]),this._bodies.set(e._pluginDataInstances[r].hpBodyId[0],{body:e,index:r})}else if(i<n){let t=n-i;for(let i=0;i<t;i++){let t=e._pluginDataInstances.pop();this._bodies.delete(t.hpBodyId[0]),this._hknp.HP_World_RemoveBody(this.world,t.hpBodyId),this._hknp.HP_Body_Release(t.hpBodyId)}this._createOrUpdateBodyInstances(e,a,r,0,i,!0)}}sync(e){this.syncTransform(e,e.transformNode)}syncTransform(e,t){if(e._pluginDataInstances.length){let i=t._thinInstanceDataStorage.matrixData;if(!i)return;let r=e._pluginDataInstances.length;for(let t=0;t<r;t++){let r=e._pluginDataInstances[t].worldTransformOffset,n=new Float32Array(this._hknp.HEAPU8.buffer,this._bodyBuffer+r,16),a=16*t;for(let e=0;e<15;e++)(3&e)!=3&&(i[a+e]=n[e]);i[a+15]=1}t.thinInstanceBufferUpdated("matrix")}else try{let i=this._hknp.HP_Body_GetQTransform(e._pluginData.hpBodyId)[1],n=i[0],a=i[1],o=r.AA.Quaternion["0"];o.set(a[0],a[1],a[2],a[3]);let s=t.parent;if(s&&!s.getWorldMatrix().isIdentity()){s.computeWorldMatrix(!0),r.AA.Vector3["1"].copyFrom(t.scaling),o.normalize();let e=r.AA.Matrix["0"],i=r.AA.Vector3["0"];i.copyFromFloats(n[0],n[1],n[2]),r.uq.ComposeToRef(t.absoluteScaling,o,i,e);let a=r.AA.Matrix["1"];s.getWorldMatrix().invertToRef(a);let l=r.AA.Matrix["2"];e.multiplyToRef(a,l),l.decomposeToTransformNode(t),t.rotationQuaternion?.normalize(),t.scaling.copyFrom(r.AA.Vector3["1"])}else t.position.set(n[0],n[1],n[2]),t.rotationQuaternion?t.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(t.rotation)}catch(e){o.V.Error(`Syncing transform failed for node ${t.name}: ${e.message}...`)}}setShape(e,t){let i=t&&t._pluginData?t._pluginData:BigInt(0);if(!(e.transformNode instanceof c.e)||!e.transformNode._thinInstanceDataStorage?.matrixData){this._hknp.HP_Body_SetShape(e._pluginData.hpBodyId,i),this._internalUpdateMassProperties(e._pluginData);return}let r=e.transformNode,n=r._thinInstanceDataStorage?.instancesCount??0;for(let t=0;t<n;t++)this._hknp.HP_Body_SetShape(e._pluginDataInstances[t].hpBodyId,i),this._internalUpdateMassProperties(e._pluginDataInstances[t])}_getPluginReference(e,t){return e._pluginDataInstances?.length?e._pluginDataInstances[t??0]:e._pluginData}getShape(e){let t=this._getPluginReference(e),i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1];if(0!=i){let t=e.transformNode.getScene();return new s.JN({pluginData:i},t)}return null}getShapeType(e){return e.type?e.type:this._hknp.HP_Shape_GetType(e._pluginData)}setEventMask(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetEventMask(e.hpBodyId,t)},i)}getEventMask(e,t){let i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1]}_fromMassPropertiesTuple(e){return{centerOfMass:r.Pq.FromArray(e[0]),mass:e[1],inertia:r.Pq.FromArray(e[2]),inertiaOrientation:r.PT.FromArray(e[3])}}_internalUpdateMassProperties(e){let t=this._internalComputeMassProperties(e),i=e.userMassProps;i.centerOfMass&&(t[0]=i.centerOfMass.asArray()),void 0!=i.mass&&(t[1]=i.mass),i.inertia&&(t[2]=i.inertia.asArray()),i.inertiaOrientation&&(t[3]=i.inertiaOrientation.asArray()),this._hknp.HP_Body_SetMassProperties(e.hpBodyId,t)}_internalSetMotionType(e,t){switch(t){case 0:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.STATIC);break;case 1:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.KINEMATIC);break;case 2:this._hknp.HP_Body_SetMotionType(e.hpBodyId,this._hknp.MotionType.DYNAMIC)}}setMotionType(e,t,i){this._applyToBodyOrInstances(e,e=>{this._internalSetMotionType(e,t)},i)}getMotionType(e,t){let i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMotionType(i.hpBodyId)[1];switch(r){case this._hknp.MotionType.STATIC:return 0;case this._hknp.MotionType.KINEMATIC:return 1;case this._hknp.MotionType.DYNAMIC:return 2}throw Error("Unknown motion type: "+r)}setActivationControl(e,t){switch(t){case 1:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_ACTIVE);break;case 2:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.ALWAYS_INACTIVE);break;case 0:this._hknp.HP_Body_SetActivationControl(e._pluginData.hpBodyId,this._hknp.ActivationControl.SIMULATION_CONTROLLED)}}_internalComputeMassProperties(e){let t=this._hknp.HP_Body_GetShape(e.hpBodyId);if(t[0]==this._hknp.Result.RESULT_OK){let e=this._hknp.HP_Shape_BuildMassProperties(t[1]);if(e[0]==this._hknp.Result.RESULT_OK)return e[1]}return[[0,0,0],1,[1,1,1],[0,0,0,1]]}computeMassProperties(e,t){let i=this._getPluginReference(e,t),r=this._internalComputeMassProperties(i);return this._fromMassPropertiesTuple(r)}setMassProperties(e,t,i){this._applyToBodyOrInstances(e,e=>{e.userMassProps=t,this._internalUpdateMassProperties(e)},i)}getMassProperties(e,t){let i=this._getPluginReference(e,t),r=this._hknp.HP_Body_GetMassProperties(i.hpBodyId)[1];return this._fromMassPropertiesTuple(r)}setLinearDamping(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetLinearDamping(e.hpBodyId,t)},i)}getLinearDamping(e,t){let i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetLinearDamping(i.hpBodyId)[1]}setAngularDamping(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetAngularDamping(e.hpBodyId,t)},i)}getAngularDamping(e,t){let i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetAngularDamping(i.hpBodyId)[1]}setLinearVelocity(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetLinearVelocity(e.hpBodyId,this._bVecToV3(t))},i)}getLinearVelocityToRef(e,t,i){let r=this._getPluginReference(e,i),n=this._hknp.HP_Body_GetLinearVelocity(r.hpBodyId)[1];this._v3ToBvecRef(n,t)}_applyToBodyOrInstances(e,t,i){if(e._pluginDataInstances?.length>0&&void 0===i)for(let i=0;i<e._pluginDataInstances.length;i++)t(e._pluginDataInstances[i]);else t(this._getPluginReference(e,i))}applyImpulse(e,t,i,r){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_ApplyImpulse(e.hpBodyId,this._bVecToV3(i),this._bVecToV3(t))},r)}applyAngularImpulse(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_ApplyAngularImpulse(e.hpBodyId,this._bVecToV3(t))},i)}applyForce(e,t,i,r){t.scaleToRef(this.getTimeStep(),this._tmpVec3[0]),this.applyImpulse(e,this._tmpVec3[0],i,r)}setAngularVelocity(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetAngularVelocity(e.hpBodyId,this._bVecToV3(t))},i)}getAngularVelocityToRef(e,t,i){let r=this._getPluginReference(e,i),n=this._hknp.HP_Body_GetAngularVelocity(r.hpBodyId)[1];this._v3ToBvecRef(n,t)}setPhysicsBodyTransformation(e,t){if(e.getPrestepType()==n.f9.TELEPORT){let i=e.transformNode;if(e.numInstances>0){let t=i._thinInstanceDataStorage.matrixData;if(!t)return;let r=e.numInstances;this._createOrUpdateBodyInstances(e,e.getMotionType(),t,0,r,!0)}else this._hknp.HP_Body_SetQTransform(e._pluginData.hpBodyId,this._getTransformInfos(t))}else e.getPrestepType()==n.f9.ACTION?this.setTargetTransform(e,t.absolutePosition,t.absoluteRotationQuaternion):e.getPrestepType()==n.f9.DISABLED?o.V.Warn("Prestep type is set to DISABLED. Unable to set physics body transformation."):o.V.Warn("Invalid prestep type set to physics body.")}setTargetTransform(e,t,i,r){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetTargetQTransform(e.hpBodyId,[this._bVecToV3(t),this._bQuatToV4(i)])},r)}setGravityFactor(e,t,i){this._applyToBodyOrInstances(e,e=>{this._hknp.HP_Body_SetGravityFactor(e.hpBodyId,t)},i)}getGravityFactor(e,t){let i=this._getPluginReference(e,t);return this._hknp.HP_Body_GetGravityFactor(i.hpBodyId)[1]}disposeBody(e){if(e._pluginDataInstances&&e._pluginDataInstances.length>0)for(let t of e._pluginDataInstances)this._hknp.HP_Body_Release(t.hpBodyId),t.hpBodyId=void 0;e._pluginData&&(this._hknp.HP_Body_Release(e._pluginData.hpBodyId),e._pluginData.hpBodyId=void 0)}_createOptionsFromGroundMesh(e){let t,i=e.groundMesh;if(!i)return;let n=i.getVerticesData(u.R.PositionKind),a=i.computeWorldMatrix(!0),o=[];for(t=0;t<n.length;t+=3)r.Pq.FromArrayToRef(n,t,r.AA.Vector3["0"]),r.Pq.TransformCoordinatesToRef(r.AA.Vector3["0"],a,r.AA.Vector3["1"]),r.AA.Vector3["1"].toArray(o,t);let s=~~(Math.sqrt((n=o).length/3)-1),l=i.getBoundingInfo(),c=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.z),f=l.boundingBox.minimumWorld.x,d=l.boundingBox.minimumWorld.y,h=l.boundingBox.minimumWorld.z,p=new Float32Array((s+1)*(s+1)),m=2*c/s;for(let e=0;e<p.length;e++)p[e]=d;for(let e=0;e<n.length;e+=3){let t=Math.round((n[e+0]-f)/m),i=s-Math.round((n[e+2]-h)/m),r=n[e+1]-d;p[i*(s+1)+t]=r}e.numHeightFieldSamplesX=s+1,e.numHeightFieldSamplesZ=s+1,e.heightFieldSizeX=2*l.boundingBox.extendSizeWorld.x,e.heightFieldSizeZ=2*l.boundingBox.extendSizeWorld.z,e.heightFieldData=p}initShape(e,t,i){switch(t){case 0:{let t=i.radius||1,r=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateSphere(r,t)[1]}break;case 3:{let t=i.rotation?this._bQuatToV4(i.rotation):[0,0,0,1],r=i.extents?this._bVecToV3(i.extents):[1,1,1],n=i.center?this._bVecToV3(i.center):[0,0,0];e._pluginData=this._hknp.HP_Shape_CreateBox(n,t,r)[1]}break;case 1:{let t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],r=i.pointB?this._bVecToV3(i.pointB):[0,1,0],n=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCapsule(t,r,n)[1]}break;case 5:e._pluginData=this._hknp.HP_Shape_CreateContainer()[1];break;case 2:{let t=i.pointA?this._bVecToV3(i.pointA):[0,0,0],r=i.pointB?this._bVecToV3(i.pointB):[0,1,0],n=i.radius||0;e._pluginData=this._hknp.HP_Shape_CreateCylinder(t,r,n)[1]}break;case 4:case 6:{let r=i.mesh;if(r){let n=!!i.includeChildMeshes,a=new p(r,4!=t,r?.getScene());a.addNodeMeshes(r,n);let o=a.getVertices(this._hknp),s=o.numObjects/3;if(4==t)e._pluginData=this._hknp.HP_Shape_CreateConvexHull(o.offset,s)[1];else{let t=a.getTriangles(this._hknp),i=t.numObjects/3;e._pluginData=this._hknp.HP_Shape_CreateMesh(o.offset,s,t.offset,i)[1],a.freeBuffer(this._hknp,t)}a.freeBuffer(this._hknp,o)}else throw Error("No mesh provided to create physics shape.")}break;case 7:if(i.groundMesh&&this._createOptionsFromGroundMesh(i),i.numHeightFieldSamplesX&&i.numHeightFieldSamplesZ&&i.heightFieldSizeX&&i.heightFieldSizeZ&&i.heightFieldData){let t=i.numHeightFieldSamplesX*i.numHeightFieldSamplesZ,r=this._hknp._malloc(4*t),n=new Float32Array(this._hknp.HEAPU8.buffer,r,t);for(let e=0;e<i.numHeightFieldSamplesX;e++)for(let t=0;t<i.numHeightFieldSamplesZ;t++){let r=t*i.numHeightFieldSamplesX+e,a=(i.numHeightFieldSamplesX-1-e)*i.numHeightFieldSamplesZ+t;n[r]=i.heightFieldData[a]}let a=i.heightFieldSizeX/(i.numHeightFieldSamplesX-1),o=i.heightFieldSizeZ/(i.numHeightFieldSamplesZ-1);e._pluginData=this._hknp.HP_Shape_CreateHeightField(i.numHeightFieldSamplesX,i.numHeightFieldSamplesZ,[a,1,o],r)[1],this._hknp._free(r)}else throw Error("Missing required heightfield parameters");break;default:throw Error("Unsupported Shape Type.")}this._shapes.set(e._pluginData[0],e)}setShapeFilterMembershipMask(e,t){let i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[t,i])}getShapeFilterMembershipMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0]}setShapeFilterCollideMask(e,t){let i=this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][0];this._hknp.HP_Shape_SetFilterInfo(e._pluginData,[i,t])}getShapeFilterCollideMask(e){return this._hknp.HP_Shape_GetFilterInfo(e._pluginData)[1][1]}setMaterial(e,t){let i=t.friction??.5,r=t.staticFriction??i,n=t.restitution??0,a=t.frictionCombine??1,o=t.restitutionCombine??2,s=[r,i,n,this._materialCombineToNative(a),this._materialCombineToNative(o)];this._hknp.HP_Shape_SetMaterial(e._pluginData,s)}getMaterial(e){let t=this._hknp.HP_Shape_GetMaterial(e._pluginData)[1];return{staticFriction:t[0],friction:t[1],restitution:t[2],frictionCombine:this._nativeToMaterialCombine(t[3]),restitutionCombine:this._nativeToMaterialCombine(t[4])}}setDensity(e,t){this._hknp.HP_Shape_SetDensity(e._pluginData,t)}getDensity(e){return this._hknp.HP_Shape_GetDensity(e._pluginData)[1]}_getTransformInfos(e){if(e.parent)return e.computeWorldMatrix(!0),[this._bVecToV3(e.absolutePosition),this._bQuatToV4(e.absoluteRotationQuaternion)];let t=r.AA.Quaternion["0"];if(e.rotationQuaternion)t=e.rotationQuaternion;else{let i=e.rotation;r.PT.FromEulerAnglesToRef(i.x,i.y,i.z,t)}return[this._bVecToV3(e.position),this._bQuatToV4(t)]}addChild(e,t,i,r,n){let a=[i?this._bVecToV3(i):[0,0,0],r?this._bQuatToV4(r):[0,0,0,1],n?this._bVecToV3(n):[1,1,1]];this._hknp.HP_Shape_AddChild(e._pluginData,t._pluginData,a)}removeChild(e,t){this._hknp.HP_Shape_RemoveChild(e._pluginData,t)}getNumChildren(e){return this._hknp.HP_Shape_GetNumChildren(e._pluginData)[1]}setTrigger(e,t){this._hknp.HP_Shape_SetTrigger(e._pluginData,t)}getBoundingBox(e){let t=this._hknp.HP_Shape_GetBoundingBox(e._pluginData,[[0,0,0],[0,0,0,1]])[1];return r.AA.Vector3["0"].set(t[0][0],t[0][1],t[0][2]),r.AA.Vector3["1"].set(t[1][0],t[1][1],t[1][2]),new l.I(r.AA.Vector3["0"],r.AA.Vector3["1"],r.uq.IdentityReadOnly)}getBodyBoundingBox(e){let t=this.getBoundingBox(e.shape);return new l.I(t.minimum,t.maximum,e.transformNode.getWorldMatrix())}getBodyGeometry(e){let t=e._pluginDataInstances?.length>0?e._pluginDataInstances[0]:e._pluginData,i=this._hknp.HP_Body_GetShape(t.hpBodyId)[1],r=this._hknp.HP_Shape_CreateDebugDisplayGeometry(i);if(r[0]!=this._hknp.Result.RESULT_OK)return{positions:[],indices:[]};let n=this._hknp.HP_DebugGeometry_GetInfo(r[1])[1],a=new Float32Array(this._hknp.HEAPU8.buffer,n[0],3*n[1]),o=new Uint32Array(this._hknp.HEAPU8.buffer,n[2],3*n[3]),s=a.slice(0),l=o.slice(0);return this._hknp.HP_DebugGeometry_Release(r[1]),{positions:s,indices:l}}disposeShape(e){this._shapes.delete(e._pluginData[0]),this._hknp.HP_Shape_Release(e._pluginData),e._pluginData=void 0}initConstraint(e,t,i,n,a){let s=e.type,l=e.options;if(!s||!l)return void o.V.Warn("No constraint type or options. Constraint is invalid.");if(t._pluginDataInstances.length>0&&void 0===n||i._pluginDataInstances.length>0&&void 0===a)return void o.V.Warn("Body is instanced but no instance index was specified. Constraint will not be applied.");e._pluginData=e._pluginData??[];let c=this._hknp.HP_Constraint_Create()[1];e._pluginData.push(c);let f=this._getPluginReference(t,n).hpBodyId,u=this._getPluginReference(i,a).hpBodyId;this._hknp.HP_Constraint_SetParentBody(c,f),this._hknp.HP_Constraint_SetChildBody(c,u),this._constraintToBodyIdPair.set(c[0],[f[0],u[0]]);let d=l.pivotA?this._bVecToV3(l.pivotA):this._bVecToV3(r.Pq.Zero()),h=l.axisA??new r.Pq(1,0,0),p=this._tmpVec3[0];l.perpAxisA?p.copyFrom(l.perpAxisA):h.getNormalToRef(p),this._hknp.HP_Constraint_SetAnchorInParent(c,d,this._bVecToV3(h),this._bVecToV3(p));let m=l.pivotB?this._bVecToV3(l.pivotB):this._bVecToV3(r.Pq.Zero()),_=l.axisB??new r.Pq(1,0,0),g=this._tmpVec3[0];if(l.perpAxisB?g.copyFrom(l.perpAxisB):_.getNormalToRef(g),this._hknp.HP_Constraint_SetAnchorInChild(c,m,this._bVecToV3(_),this._bVecToV3(g)),e._initOptions||(e._initOptions={axisA:h.clone(),axisB:_.clone(),perpAxisA:p.clone(),perpAxisB:g.clone(),pivotA:new r.Pq(d[0],d[1],d[2]),pivotB:new r.Pq(m[0],m[1],m[2])}),5==s)this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(2==s){let e=l.maxDistance||0,t=this._hknp.ConstraintAxis.LINEAR_DISTANCE;this._hknp.HP_Constraint_SetAxisMode(c,t,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(c,t,e),this._hknp.HP_Constraint_SetAxisMaxLimit(c,t,e)}else if(3==s)this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(6==s)this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(4==s)this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.ANGULAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(1==s)this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_X,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Y,this._hknp.ConstraintAxisLimitMode.LOCKED),this._hknp.HP_Constraint_SetAxisMode(c,this._hknp.ConstraintAxis.LINEAR_Z,this._hknp.ConstraintAxisLimitMode.LOCKED);else if(7==s)for(let t of e.limits){let e=this._constraintAxisToNative(t.axis);(t.minLimit??-1)==0&&(t.maxLimit??-1)==0?this._hknp.HP_Constraint_SetAxisMode(c,e,this._hknp.ConstraintAxisLimitMode.LOCKED):(void 0!=t.minLimit&&(this._hknp.HP_Constraint_SetAxisMode(c,e,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMinLimit(c,e,t.minLimit)),void 0!=t.maxLimit&&(this._hknp.HP_Constraint_SetAxisMode(c,e,this._hknp.ConstraintAxisLimitMode.LIMITED),this._hknp.HP_Constraint_SetAxisMaxLimit(c,e,t.maxLimit))),t.stiffness&&this._hknp.HP_Constraint_SetAxisStiffness(c,e,t.stiffness),t.damping&&this._hknp.HP_Constraint_SetAxisDamping(c,e,t.damping)}else throw Error("Unsupported Constraint Type.");let v=!!l.collision;this._hknp.HP_Constraint_SetCollisionsEnabled(c,v),this._hknp.HP_Constraint_SetEnabled(c,!0)}getBodiesUsingConstraint(e){let t=[];for(let i of e._pluginData){let e=this._constraintToBodyIdPair.get(i[0]);if(e){let i=this._bodies.get(e[0]),r=this._bodies.get(e[1]);i&&r&&t.push({parentBody:i.body,parentBodyIndex:i.index,childBody:r.body,childBodyIndex:r.index})}}return t}addConstraint(e,t,i,r,n){this.initConstraint(i,e,t,r,n)}setEnabled(e,t){for(let i of e._pluginData)this._hknp.HP_Constraint_SetEnabled(i,t)}getEnabled(e){let t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetEnabled(t)[1]}setCollisionsEnabled(e,t){for(let i of e._pluginData)this._hknp.HP_Constraint_SetCollisionsEnabled(i,t)}getCollisionsEnabled(e){let t=e._pluginData&&e._pluginData[0];return!!t&&this._hknp.HP_Constraint_GetCollisionsEnabled(t)[1]}setAxisFriction(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisFriction(r,this._constraintAxisToNative(t),i)}getAxisFriction(e,t){let i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisFriction(i,this._constraintAxisToNative(t))[1]:null}setAxisMode(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisMode(r,this._constraintAxisToNative(t),this._limitModeToNative(i))}getAxisMode(e,t){let i=e._pluginData&&e._pluginData[0];if(i){let e=this._hknp.HP_Constraint_GetAxisMode(i,this._constraintAxisToNative(t))[1];return this._nativeToLimitMode(e)}return null}setAxisMinLimit(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisMinLimit(r,this._constraintAxisToNative(t),i)}getAxisMinLimit(e,t){let i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMinLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMaxLimit(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisMaxLimit(r,this._constraintAxisToNative(t),i)}getAxisMaxLimit(e,t){let i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMaxLimit(i,this._constraintAxisToNative(t))[1]:null}setAxisMotorType(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorType(r,this._constraintAxisToNative(t),this._constraintMotorTypeToNative(i))}getAxisMotorType(e,t){let i=e._pluginData&&e._pluginData[0];return i?this._nativeToMotorType(this._hknp.HP_Constraint_GetAxisMotorType(i,this._constraintAxisToNative(t))[1]):null}setAxisMotorTarget(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorTarget(r,this._constraintAxisToNative(t),i)}getAxisMotorTarget(e,t){return e._pluginData&&e._pluginData[0]?this._hknp.HP_Constraint_GetAxisMotorTarget(e._pluginData,this._constraintAxisToNative(t))[1]:null}setAxisMotorMaxForce(e,t,i){for(let r of e._pluginData)this._hknp.HP_Constraint_SetAxisMotorMaxForce(r,this._constraintAxisToNative(t),i)}getAxisMotorMaxForce(e,t){let i=e._pluginData&&e._pluginData[0];return i?this._hknp.HP_Constraint_GetAxisMotorMaxForce(i,this._constraintAxisToNative(t))[1]:null}disposeConstraint(e){for(let t of e._pluginData)this._hknp.HP_Constraint_SetEnabled(t,!1),this._hknp.HP_Constraint_Release(t);e._pluginData.length=0}_populateHitData(e,t){let i=this._bodies.get(e[0][0]);t.body=i?.body,t.bodyIndex=i?.index,t.shape=this._shapes.get(e[1][0]);let r=e[3],n=e[4],a=e[5];t.setHitData({x:n[0],y:n[1],z:n[2]},{x:r[0],y:r[1],z:r[2]},a)}raycast(e,t,i,r){let n=r?.membership??-1,o=r?.collideWith??-1,s=r?.shouldHitTriggers??!1,l=r?.ignoreBody?[BigInt(r.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],c=Array.isArray(i)?i:[i];for(let i of c)i.reset(e,t);let f=[this._bVecToV3(e),this._bVecToV3(t),[n,o],s,l],u=1!==c.length&&this._multiQueryCollector?this._multiQueryCollector:this._queryCollector;this._hknp.HP_World_CastRayWithCollector(this.world,u,f);let d=this._hknp.HP_QueryCollector_GetNumHits(u)[1];if(d<=0)return;if(!c.length)for(let i=0;i<d;i++){let i=new a.G;i.reset(e,t),c.push(i)}let h=Array(d);for(let t=0;t<d;t++){let[,i]=this._hknp.HP_QueryCollector_GetCastRayResult(u,t)[1],r=i[3];e.subtractFromFloatsToRef(r[0],r[1],r[2],this._tmpVec3[0]);let n=this._tmpVec3[0].lengthSquared();h[t]={hitData:i,distance:n}}h.sort((e,t)=>e.distance-t.distance);for(let e=0;e<Math.min(d,c.length);e++){let t=c[e],i=h[e];this._populateHitData(i.hitData,t),t.setHitDistance(Math.sqrt(i.distance))}}pointProximity(e,t){let i=e?.collisionFilter?.membership??-1,r=e?.collisionFilter?.collideWith??-1;t.reset();let n=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],a=[this._bVecToV3(e.position),e.maxDistance,[i,r],e.shouldHitTriggers,n];if(this._hknp.HP_World_PointProximityWithCollector(this.world,this._queryCollector,a),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){let[e,i]=this._hknp.HP_QueryCollector_GetPointProximityResult(this._queryCollector,0)[1];this._populateHitData(i,t),t.setHitDistance(e)}}shapeProximity(e,t,i){t.reset(),i.reset();let r=e.shape._pluginData,n=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],a=[r,this._bVecToV3(e.position),this._bQuatToV4(e.rotation),e.maxDistance,e.shouldHitTriggers,n];if(this._hknp.HP_World_ShapeProximityWithCollector(this.world,this._queryCollector,a),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){let[e,r,n]=this._hknp.HP_QueryCollector_GetShapeProximityResult(this._queryCollector,0)[1];this._populateHitData(r,t),this._populateHitData(n,i),t.setHitDistance(e),i.setHitDistance(e)}}shapeCast(e,t,i){t.reset(),i.reset();let r=e.shape._pluginData,n=e.ignoreBody?[BigInt(e.ignoreBody._pluginData.hpBodyId[0])]:[BigInt(0)],a=[r,this._bQuatToV4(e.rotation),this._bVecToV3(e.startPosition),this._bVecToV3(e.endPosition),e.shouldHitTriggers,n];if(this._hknp.HP_World_ShapeCastWithCollector(this.world,this._queryCollector,a),this._hknp.HP_QueryCollector_GetNumHits(this._queryCollector)[1]>0){let[e,r,n]=this._hknp.HP_QueryCollector_GetShapeCastResult(this._queryCollector,0)[1];this._populateHitData(r,t),this._populateHitData(n,i),t.setHitFraction(e),i.setHitFraction(e)}}getCollisionObservable(e){let t=e._pluginData.hpBodyId[0],i=this._bodyCollisionObservable.get(t);return i||(i=new h.cP,this._bodyCollisionObservable.set(t,i)),i}getCollisionEndedObservable(e){let t=e._pluginData.hpBodyId[0],i=this._bodyCollisionEndedObservable.get(t);return i||(i=new h.cP,this._bodyCollisionEndedObservable.set(t,i)),i}setCollisionCallbackEnabled(e,t){let i=this._hknp.EventType.COLLISION_STARTED.value|this._hknp.EventType.COLLISION_CONTINUED.value|this._hknp.EventType.COLLISION_FINISHED.value;if(e._pluginDataInstances&&e._pluginDataInstances.length)for(let r=0;r<e._pluginDataInstances.length;r++){let n=e._pluginDataInstances[r];this._hknp.HP_Body_SetEventMask(n.hpBodyId,t?i:0)}else e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,t?i:0)}setCollisionEndedCallbackEnabled(e,t){let i=this._getPluginReference(e),r=this._hknp.HP_Body_GetEventMask(i.hpBodyId)[1];if(r=t?r|this._hknp.EventType.COLLISION_FINISHED.value:r&~this._hknp.EventType.COLLISION_FINISHED.value,e._pluginDataInstances&&e._pluginDataInstances.length)for(let t=0;t<e._pluginDataInstances.length;t++){let i=e._pluginDataInstances[t];this._hknp.HP_Body_SetEventMask(i.hpBodyId,r)}else e._pluginData&&this._hknp.HP_Body_SetEventMask(e._pluginData.hpBodyId,r)}_notifyTriggers(){let e=this._hknp.HP_World_GetTriggerEvents(this.world)[1],t=new v;for(;e;){v.readToRef(this._hknp.HEAPU8.buffer,e,t);let i=this._bodies.get(t.bodyIdA),r=this._bodies.get(t.bodyIdB);if(i&&r){let e={collider:i.body,colliderIndex:i.index,collidedAgainst:r.body,collidedAgainstIndex:r.index,type:this._nativeTriggerCollisionValueToCollisionType(t.type)};this.onTriggerCollisionObservable.notifyObservers(e)}e=this._hknp.HP_World_GetNextTriggerEvent(this.world,e)}}_notifyCollisions(){let e=this._hknp.HP_World_GetCollisionEvents(this.world)[1],t=new g,i=Number(this.world);for(;e;){g.readToRef(this._hknp.HEAPU8.buffer,e,t);let n=this._bodies.get(t.contactOnA.bodyId),a=this._bodies.get(t.contactOnB.bodyId);if(n&&a){let e={collider:n.body,colliderIndex:n.index,collidedAgainst:a.body,collidedAgainstIndex:a.index,type:this._nativeCollisionValueToCollisionType(t.type)};if("COLLISION_FINISHED"===e.type)this.onCollisionEndedObservable.notifyObservers(e);else{t.contactOnB.position.subtractToRef(t.contactOnA.position,this._tmpVec3[0]);let i=r.Pq.Dot(this._tmpVec3[0],t.contactOnA.normal);e.point=t.contactOnA.position,e.distance=i,e.impulse=t.impulseApplied,e.normal=t.contactOnA.normal,this.onCollisionObservable.notifyObservers(e)}if(this._bodyCollisionObservable.size&&"COLLISION_FINISHED"!==e.type){let i=this._bodyCollisionObservable.get(t.contactOnA.bodyId),o=this._bodyCollisionObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);let s=r.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),o){let e={collider:a.body,colliderIndex:a.index,collidedAgainst:n.body,collidedAgainstIndex:n.index,point:t.contactOnB.position,distance:s,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};o.notifyObservers(e)}}else if(this._bodyCollisionEndedObservable.size){let i=this._bodyCollisionEndedObservable.get(t.contactOnA.bodyId),o=this._bodyCollisionEndedObservable.get(t.contactOnB.bodyId);t.contactOnA.position.subtractToRef(t.contactOnB.position,this._tmpVec3[0]);let s=r.Pq.Dot(this._tmpVec3[0],t.contactOnB.normal);if(i&&i.notifyObservers(e),o){let e={collider:a.body,colliderIndex:a.index,collidedAgainst:n.body,collidedAgainstIndex:n.index,point:t.contactOnB.position,distance:s,impulse:t.impulseApplied,normal:t.contactOnB.normal,type:this._nativeCollisionValueToCollisionType(t.type)};o.notifyObservers(e)}}}e=this._hknp.HP_World_GetNextCollisionEvent(i,e)}}get numBodies(){return this._hknp.HP_World_GetNumBodies(this.world)[1]}dispose(){this._queryCollector&&(this._hknp.HP_QueryCollector_Release(this._queryCollector),this._queryCollector=void 0),this._multiQueryCollector&&(this._hknp.HP_QueryCollector_Release(this._multiQueryCollector),this._multiQueryCollector),this.world&&(this._hknp.HP_World_Release(this.world),this.world=void 0)}_v3ToBvecRef(e,t){t.set(e[0],e[1],e[2])}_bVecToV3(e){return[e._x,e._y,e._z]}_bQuatToV4(e){return[e._x,e._y,e._z,e._w]}_constraintMotorTypeToNative(e){switch(e){case 2:return this._hknp.ConstraintMotorType.POSITION;case 1:return this._hknp.ConstraintMotorType.VELOCITY}return this._hknp.ConstraintMotorType.NONE}_nativeToMotorType(e){switch(e){case this._hknp.ConstraintMotorType.POSITION:return 2;case this._hknp.ConstraintMotorType.VELOCITY:return 1}return 0}_materialCombineToNative(e){switch(e){case 0:return this._hknp.MaterialCombine.GEOMETRIC_MEAN;case 1:return this._hknp.MaterialCombine.MINIMUM;case 2:return this._hknp.MaterialCombine.MAXIMUM;case 3:return this._hknp.MaterialCombine.ARITHMETIC_MEAN;case 4:return this._hknp.MaterialCombine.MULTIPLY}}_nativeToMaterialCombine(e){switch(e){case this._hknp.MaterialCombine.GEOMETRIC_MEAN:return 0;case this._hknp.MaterialCombine.MINIMUM:return 1;case this._hknp.MaterialCombine.MAXIMUM:return 2;case this._hknp.MaterialCombine.ARITHMETIC_MEAN:return 3;case this._hknp.MaterialCombine.MULTIPLY:return 4;default:return}}_constraintAxisToNative(e){switch(e){case 0:return this._hknp.ConstraintAxis.LINEAR_X;case 1:return this._hknp.ConstraintAxis.LINEAR_Y;case 2:return this._hknp.ConstraintAxis.LINEAR_Z;case 3:return this._hknp.ConstraintAxis.ANGULAR_X;case 4:return this._hknp.ConstraintAxis.ANGULAR_Y;case 5:return this._hknp.ConstraintAxis.ANGULAR_Z;case 6:return this._hknp.ConstraintAxis.LINEAR_DISTANCE}}_nativeToLimitMode(e){switch(e){case this._hknp.ConstraintAxisLimitMode.FREE:break;case this._hknp.ConstraintAxisLimitMode.LIMITED:return 1;case this._hknp.ConstraintAxisLimitMode.LOCKED:return 2}return 0}_limitModeToNative(e){switch(e){case 0:return this._hknp.ConstraintAxisLimitMode.FREE;case 1:return this._hknp.ConstraintAxisLimitMode.LIMITED;case 2:return this._hknp.ConstraintAxisLimitMode.LOCKED}}_nativeCollisionValueToCollisionType(e){switch(e){case this._hknp.EventType.COLLISION_STARTED.value:break;case this._hknp.EventType.COLLISION_FINISHED.value:return"COLLISION_FINISHED";case this._hknp.EventType.COLLISION_CONTINUED.value:return"COLLISION_CONTINUED"}return"COLLISION_STARTED"}_nativeTriggerCollisionValueToCollisionType(e){switch(e){case 8:break;case 16:return"TRIGGER_EXITED"}return"TRIGGER_ENTERED"}}},15207:function(e,t,i){i.d(t,{P:()=>r.P});var r=i(7469)},27151:function(e,t,i){i.d(t,{Z:()=>a,l:()=>p});var r,n,a,o,s=i(97782),l=i(2044),c=i(73896);(r=a||(a={}))[r.UNSUPPORTED=0]="UNSUPPORTED",r[r.SLIDING=1]="SLIDING",r[r.SUPPORTED=2]="SUPPORTED",(n=o||(o={}))[n.OK=0]="OK",n[n.FAILURE_3D=1]="FAILURE_3D",n[n.FAILURE_2D=2]="FAILURE_2D";class f{}class u{copyFrom(e){this.index=e.index,this.constraint=e.constraint,this.interaction=e.interaction}}class d{constructor(){this.supportPlanes=[,,,,],this.numSupportPlanes=0,this.currentTime=0}getOutput(e){return this.outputInteractions[this.inputConstraints.indexOf(e)]}}function h(e,t,i,r,n){let a=e._bodies,o=s.Pq.FromArray(t[4]),l=-r*i.dot(o);return{position:s.Pq.FromArray(t[3]),normal:o,distance:l,fraction:r,bodyB:a.get(t[0][0]),allowedPenetration:Math.min(Math.max(n-l,0),n)}}class p{constructor(e,t,i){this._orientation=s.PT.Identity(),this._manifold=[],this._contactAngleSensitivity=10,this._tmpMatrix=new s.uq,this._tmpVecs=(0,c.mI)(31,s.Pq.Zero),this.keepDistance=.05,this.keepContactTolerance=.1,this.maxCastIterations=10,this.penetrationRecoverySpeed=1,this.staticFriction=0,this.dynamicFriction=1,this.maxSlopeCosine=.5,this.maxCharacterSpeedForSolver=10,this.up=new s.Pq(0,1,0),this.characterStrength=1e38,this.acceleration=.05,this.maxAcceleration=50,this.characterMass=0,this._position=e.clone(),this._velocity=s.Pq.Zero(),this._lastVelocity=s.Pq.Zero();const r=t.capsuleRadius??.6,n=t.capsuleHeight??1.8;this._tmpVecs[0].set(0,.5*n-r,0),this._tmpVecs[1].set(0,-(.5*n)+r,0),this._ownShape=!t.shape,this._shape=t.shape??new l.cw(this._tmpVecs[0],this._tmpVecs[1],r,i),this._lastInvDeltaTime=1/60,this._lastDisplacement=s.Pq.Zero(),this._scene=i;const a=this._scene.getPhysicsEngine().getPhysicsPlugin()._hknp;this._startCollector=a.HP_QueryCollector_Create(16)[1],this._castCollector=a.HP_QueryCollector_Create(16)[1]}get shape(){return this._shape}set shape(e){this._ownShape&&this._shape.dispose(),this._shape=e,this._ownShape=!1}getPosition(){return this._position}setPosition(e){this._position.copyFrom(e)}getVelocity(){return this._velocity}setVelocity(e){this._velocity.copyFrom(e)}_validateManifold(){let e=[];for(let t=0;t<this._manifold.length;t++)this._manifold[t].bodyB.body.isDisposed||e.push(this._manifold[t]);this._manifold=e}_getPointVelocityToRef(e,t,i){let r=this._tmpVecs[10];this._getComWorldToRef(e,r);let n=this._tmpVecs[11];t.subtractToRef(r,n);let a=this._tmpVecs[12];e.body.getAngularVelocityToRef(a,e.index);let o=this._tmpVecs[13];s.Pq.CrossToRef(a,n,o),o.addToRef(e.body.getLinearVelocity(e.index),i)}_compareContacts(e,t){let i=(1-e.normal.dot(t.normal))*this._contactAngleSensitivity*this._contactAngleSensitivity,r=(e.distance-t.distance)*(e.distance*t.distance),n=this._tmpVecs[7];this._getPointVelocityToRef(e.bodyB,e.position,n);let a=this._tmpVecs[8];this._getPointVelocityToRef(t.bodyB,t.position,a);let o=this._tmpVecs[9];return n.subtractToRef(a,o),10*i+.1*o.lengthSquared()+r}_findContact(e,t,i){let r=-1,n=i;for(let i=0;i<t.length;i++){let a=this._compareContacts(e,t[i]);a<n&&(n=a,r=i)}return r}_updateManifold(e,t,i){let r=this._scene.getPhysicsEngine().getPhysicsPlugin(),n=r._hknp,a=n.HP_QueryCollector_GetNumHits(e)[1];if(a>0){let t=[],i=1e38,o=r._bodies;for(let r=0;r<a;r++){let[a,,l]=n.HP_QueryCollector_GetShapeProximityResult(e,r)[1];i=Math.min(i,a),t.push({position:s.Pq.FromArray(l[3]),normal:s.Pq.FromArray(l[4]),distance:a,fraction:0,bodyB:o.get(l[0][0]),allowedPenetration:Math.min(Math.max(this.keepDistance-a,0),this.keepDistance)})}for(let e=this._manifold.length-1;e>=0;e--){let i=this._manifold[e],r=this._findContact(i,t,1.1);if(r>=0){let n=Math.min(Math.max(this.keepDistance-t[r].distance,0),i.allowedPenetration);this._manifold[e]=t[r],this._manifold[e].allowedPenetration=n,t.splice(r,1)}else this._manifold.splice(e,1)}let l=t.findIndex(e=>e.distance==i);if(l>=0){let e=this._findContact(t[l],this._manifold,.1);if(e>=0){let i=Math.min(Math.max(this.keepDistance-t[l].distance,0),this._manifold[e].allowedPenetration);this._manifold[e]=t[l],this._manifold[e].allowedPenetration=i}else this._manifold.push(t[l])}}else this._manifold.length=0;let o=0,l=n.HP_QueryCollector_GetNumHits(t)[1];if(l>0){let e=null;for(let a=0;a<l;a++){let[s,,l]=n.HP_QueryCollector_GetShapeCastResult(t,a)[1];if(null==e){let t=h(r,l,i,s,this.keepDistance);if(e=l[0][0],-1==this._findContact(t,this._manifold,.1)&&this._manifold.push(t),0==t.bodyB.body.getMotionType(t.bodyB.index))break}else if(e._pluginData&&l[0]!=e._pluginData.hpBodyId){o++;break}}}for(let e=this._manifold.length-1;e>=0;e--){let t=e-1;for(;t>=0&&!(.1>this._compareContacts(this._manifold[e],this._manifold[t]));t--);t>=0&&this._manifold.slice(e,1)}return o}_createSurfaceConstraint(e,t){let i={planeNormal:e.normal.clone(),planeDistance:e.distance,staticFriction:this.staticFriction,dynamicFriction:this.dynamicFriction,extraUpStaticFriction:0,extraDownStaticFriction:0,velocity:s.Pq.Zero(),angularVelocity:s.Pq.Zero(),priority:0},r=Math.max(this.maxSlopeCosine,.1),n=e.normal.dot(this.up),a=e.position.clone();if(n>r){let t=this.getPosition(),i=this._tmpVecs[20];e.position.subtractToRef(t,i);let r=e.normal.dot(i);a.x=t.x+this.up.x*r,a.y=t.y+this.up.y*r,a.z=t.z+this.up.z*r}let o=e.bodyB.body.getMotionType(e.bodyB.index),l=i.velocity.dot(i.planeNormal)*t;return i.planeDistance-=l,0==o?i.priority=2:1==o&&(i.priority=1),i}_addMaxSlopePlane(e,t,i,r,n){let a=r[i].planeNormal.dot(t);if(a>.01&&a<e){let e={planeNormal:r[i].planeNormal.clone(),planeDistance:r[i].planeDistance,velocity:r[i].velocity.clone(),angularVelocity:r[i].angularVelocity.clone(),priority:r[i].priority,dynamicFriction:r[i].dynamicFriction,staticFriction:r[i].staticFriction,extraDownStaticFriction:r[i].extraDownStaticFriction,extraUpStaticFriction:r[i].extraUpStaticFriction},o=e.planeDistance;return e.planeNormal.subtractInPlace(t.scale(a)),e.planeNormal.normalize(),o>=0?e.planeDistance=o*e.planeNormal.dot(r[i].planeNormal):(e.planeDistance=Math.min(0,o+n)/e.planeNormal.dot(r[i].planeNormal),r[i].planeDistance=0,this._resolveConstraintPenetration(e,this.penetrationRecoverySpeed)),r.push(e),!0}return!1}_resolveConstraintPenetration(e,t){e.planeDistance<-1e-6&&(e.planeNormal.scaleToRef(e.planeDistance*t,this._tmpVecs[6]),e.velocity.subtractInPlace(this._tmpVecs[6]))}_createConstraintsFromManifold(e,t){let i=[];for(let e=0;e<this._manifold.length;e++){let r=this._createSurfaceConstraint(this._manifold[e],t);i.push(r),this._addMaxSlopePlane(this.maxSlopeCosine,this.up,e,i,this._manifold[e].allowedPenetration),this._resolveConstraintPenetration(r,this.penetrationRecoverySpeed)}return i}_simplexSolverSortInfo(e){for(let t=0;t<e.numSupportPlanes-1;t++)for(let i=t+1;i<e.numSupportPlanes;i++){let r=e.supportPlanes[t],n=e.supportPlanes[i];if(!(r.constraint.priority<n.constraint.priority)){if(r.constraint.priority==n.constraint.priority&&r.constraint.velocity.lengthSquared()<n.constraint.velocity.lengthSquared())continue;e.supportPlanes[t]=n,e.supportPlanes[i]=r}}}_simplexSolverSolve1d(e,t,i,r){let n=t.velocity,a=this._tmpVecs[22];i.subtractToRef(n,a);let o=a.dot(t.planeNormal),s=a.lengthSquared();a.subtractInPlace(t.planeNormal.scale(o));{let e=o*o,i=a.dot(this.up)>0?t.extraUpStaticFriction:t.extraDownStaticFriction;if(i>0){let o=this.up.cross(t.planeNormal),l=o.lengthSquared(),c=0;if(l>1e-5){o.scaleInPlace(1/Math.sqrt(l)),c=a.dot(o);{let i=c*c;e*(t.staticFriction*t.staticFriction)>=i&&(a.subtractInPlace(o.scale(c)),c=0)}}{let a=s-c*c-e;if(e*((t.staticFriction+i)*(t.staticFriction+i))>=a&&0==c)return void r.copyFrom(n)}}else if(e*(1+t.staticFriction*t.staticFriction)>=s)return void r.copyFrom(n)}if(t.dynamicFriction<1){let e=a.lengthSquared();if(e>=1e-5&&e>1e-4*s){let i=Math.sqrt(s/e);i=t.dynamicFriction+(1-t.dynamicFriction)*i,a.scaleInPlace(i);let r=t.planeNormal.dot(a);a.subtractInPlace(t.planeNormal.scale(r))}}r.copyFrom(a),r.addInPlace(n)}_simplexSolverSolveTest1d(e,t){let i=this._tmpVecs[23];return t.subtractToRef(e.velocity,i),-.001>i.dot(e.planeNormal)}_simplexSolverSolve2d(e,t,i,r,n,a){let o=i.planeNormal.cross(r.planeNormal),l=o.lengthSquared(),c=!1,f=null;for(;;){if(l<=1e-5||c){e.getOutput(i).status=2,e.getOutput(r).status=2,i.priority>r.priority?(this._simplexSolverSolve1d(e,r,n,a),this._simplexSolverSolve1d(e,i,n,a)):(this._simplexSolverSolve1d(e,i,n,a),this._simplexSolverSolve1d(e,r,n,a));return}let u=1/Math.sqrt(l);o.scaleInPlace(u);{let e=i.planeNormal.cross(r.planeNormal),n=r.planeNormal.cross(o),a=o.cross(i.planeNormal),l=i.velocity.add(r.velocity),d=this._tmpVecs[2];d.set(.5*o.dot(l),i.planeNormal.dot(i.velocity),r.planeNormal.dot(r.velocity));let h=s.uq.FromValues(e.x,n.x,a.x,0,e.y,n.y,a.y,0,e.z,n.z,a.z,0,0,0,0,1);if((f=s.Pq.TransformNormal(d,h)).scaleInPlace(u),Math.abs(f.x)>t.x||Math.abs(f.y)>t.y||Math.abs(f.z)>t.z)c=!0;else break}}let u=f,d=this._tmpVecs[24];n.subtractToRef(u,d);let h=d.lengthSquared(),p=this.up.dot(o),m=d.dot(o),_=i.staticFriction+r.staticFriction;p*m>0?_+=(i.extraUpStaticFriction+r.extraUpStaticFriction)*p:_+=(i.extraDownStaticFriction+r.extraDownStaticFriction)*p,_*=.5;let g=(i.dynamicFriction+r.dynamicFriction)*.5,v=m*m;if(_*_*(h-v)>=v)return void a.copyFrom(u);if(g<1&&m*m>1e-4*h){let e=Math.abs(1/m)*Math.sqrt(h)*(1-g)+g;m*=e}a.copyFrom(u),a.addInPlace(o.scale(m))}_simplexSolverSolve3d(e,t,i,r,n,a,o,l){let c=null;{let f=r.planeNormal.cross(n.planeNormal),u=n.planeNormal.cross(i.planeNormal),d=i.planeNormal.cross(r.planeNormal),h=f.dot(i.planeNormal),p=!1;for(;;){if(1e-5>Math.abs(h)||p){a&&(this._simplexSolverSortInfo(e),i=e.supportPlanes[0].constraint,r=e.supportPlanes[1].constraint,n=e.supportPlanes[2].constraint),e.getOutput(i).status=1,e.getOutput(r).status=1,e.getOutput(n).status=1;let s=e.numSupportPlanes;this._simplexSolverSolve2d(e,t,i,r,o,l),s==e.numSupportPlanes&&this._simplexSolverSolve2d(e,t,i,n,o,l),s==e.numSupportPlanes&&this._simplexSolverSolve2d(e,t,r,n,o,l);return}let m=this._tmpVecs[2];m.set(i.planeNormal.dot(i.velocity),r.planeNormal.dot(r.velocity),n.planeNormal.dot(n.velocity));let _=s.uq.FromValues(f.x,f.y,f.z,0,u.x,u.y,u.z,0,d.x,d.y,d.z,0,0,0,0,1);if((c=s.Pq.TransformNormal(m,_)).scaleInPlace(1/h),Math.abs(c.x)>t.x||Math.abs(c.y)>t.y||Math.abs(c.z)>t.z)p=!0;else break}}l.copyFrom(c)}_simplexSolverExamineActivePlanes(e,t,i,r){for(;;)switch(e.numSupportPlanes){case 1:{let t=e.supportPlanes[0].constraint;this._simplexSolverSolve1d(e,t,i,r);return}case 2:{let n=s.Pq.Zero();this._simplexSolverSolve1d(e,e.supportPlanes[1].constraint,i,n),this._simplexSolverSolveTest1d(e.supportPlanes[0].constraint,n)?this._simplexSolverSolve2d(e,t,e.supportPlanes[0].constraint,e.supportPlanes[1].constraint,i,r):(e.supportPlanes[0].copyFrom(e.supportPlanes[1]),e.numSupportPlanes=1,r.copyFrom(n));return}case 3:{let t=s.Pq.Zero();if(this._simplexSolverSolve1d(e,e.supportPlanes[2].constraint,i,r),!this._simplexSolverSolveTest1d(e.supportPlanes[0].constraint,t)&&!this._simplexSolverSolveTest1d(e.supportPlanes[1].constraint,t)){r.copyFrom(t),e.supportPlanes[0].copyFrom(e.supportPlanes[2]),e.numSupportPlanes=1;continue}}{let n=!1;for(let a=0;a<2;a++){let o=s.Pq.Zero();if(this._simplexSolverSolve2d(e,t,e.supportPlanes[a].constraint,e.supportPlanes[2].constraint,i,r),!this._simplexSolverSolveTest1d(e.supportPlanes[1-a].constraint,o)){e.supportPlanes[0].copyFrom(e.supportPlanes[a]),e.supportPlanes[1].copyFrom(e.supportPlanes[2]),e.numSupportPlanes--,n=!0;break}}if(n)continue}this._simplexSolverSolve3d(e,t,e.supportPlanes[0].constraint,e.supportPlanes[1].constraint,e.supportPlanes[2].constraint,!0,i,r);return;case 4:{this._simplexSolverSortInfo(e);let n=!1;for(let r=0;r<3;r++){let a=s.Pq.Zero();if(this._simplexSolverSolve3d(e,t,e.supportPlanes[(r+1)%3].constraint,e.supportPlanes[(r+2)%3].constraint,e.supportPlanes[3].constraint,!1,i,a),!this._simplexSolverSolveTest1d(e.supportPlanes[r].constraint,a)){e.supportPlanes[r].copyFrom(e.supportPlanes[2]),e.supportPlanes[2].copyFrom(e.supportPlanes[3]),e.numSupportPlanes=3,n=!0;break}}if(n)continue;{let n=i.clone(),a=e.supportPlanes[0].constraint,o=e.supportPlanes[1].constraint,s=e.supportPlanes[2].constraint,l=e.supportPlanes[3].constraint,c=e.numSupportPlanes;c==e.numSupportPlanes?this._simplexSolverSolve3d(e,t,a,o,s,!1,n,n):c==e.numSupportPlanes?this._simplexSolverSolve3d(e,t,a,o,l,!1,n,n):c==e.numSupportPlanes?this._simplexSolverSolve3d(e,t,a,s,l,!1,n,n):c==e.numSupportPlanes&&this._simplexSolverSolve3d(e,t,o,s,l,!1,n,n),r.copyFrom(n)}{let t=0;for(let i=0;i<4;i++)t=Math.max(t,e.supportPlanes[i].interaction.status);let i=0;for(;i<4;i++){if(t==e.supportPlanes[i].interaction.status){e.supportPlanes[i].copyFrom(e.supportPlanes[3]);break}e.numSupportPlanes--}}for(let t=0;t<3;t++)e.supportPlanes[t].interaction.status=0;continue}}}_simplexSolverSolve(e,t,i,r,n,a){let o=new f;o.position=s.Pq.Zero(),o.velocity=t.clone(),o.planeInteractions=[];let l=i;for(let t=0;t<e.length;t++)o.planeInteractions.push({touched:!1,stopped:!1,surfaceTime:0,penaltyDistance:0,status:0});let c=new d;for(c.inputConstraints=e,c.outputInteractions=o.planeInteractions,c.supportPlanes[0]=new u,c.supportPlanes[1]=new u,c.supportPlanes[2]=new u,c.supportPlanes[3]=new u;l>0;){let n=-1,s=l;for(let t=0;t<e.length;t++){if(c.numSupportPlanes>=1&&c.supportPlanes[0].index==t||c.numSupportPlanes>=2&&c.supportPlanes[1].index==t||c.numSupportPlanes>=3&&c.supportPlanes[2].index==t||0!=o.planeInteractions[t].status)continue;let i=e[t],r=this._tmpVecs[25];o.velocity.subtractToRef(i.velocity,r);let a=-r.dot(i.planeNormal);if(a<=0)continue;let l=this._tmpVecs[26];i.velocity.scaleToRef(c.currentTime,this._tmpVecs[27]),o.position.subtractToRef(this._tmpVecs[27],l);let f=i.planeNormal.dot(l),u=o.planeInteractions[t].penaltyDistance;u<1e-6&&(f=0),(f+=u)<s*a&&(s=f/a,n=t)}if(s>1e-4){c.currentTime+=s,l-=s,o.position.addInPlace(o.velocity.scale(s));for(let e=0;e<c.numSupportPlanes;e++)c.supportPlanes[e].interaction.surfaceTime+=s,c.supportPlanes[e].interaction.touched=!0;if(o.deltaTime=c.currentTime,c.currentTime>r)break}if(n<0){o.deltaTime=i;break}let f=c.supportPlanes[c.numSupportPlanes++];f.constraint=e[n],f.interaction=o.planeInteractions[n],f.interaction.penaltyDistance=(f.interaction.penaltyDistance+1e-6)*2,f.index=n,this._simplexSolverExamineActivePlanes(c,a,t,o.velocity)}return o}checkSupport(e,t){let i={isSurfaceDynamic:!1,supportedState:0,averageSurfaceNormal:s.Pq.Zero(),averageSurfaceVelocity:s.Pq.Zero(),averageAngularSurfaceVelocity:s.Pq.Zero()};return this.checkSupportToRef(e,t,i),i}checkSupportToRef(e,t,i){this._validateManifold();let r=this._createConstraintsFromManifold(e,0),n=[];for(let e=0;e<r.length;e++)n.push(r[e].velocity.clone()),r[e].velocity.setAll(0);let a=this._tmpVecs[3];a.set(this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver);let o=this._simplexSolverSolve(r,t,e,e,this.up,a);if(i.averageSurfaceVelocity.setAll(0),i.averageAngularSurfaceVelocity.setAll(0),i.averageSurfaceNormal.setAll(0),i.isSurfaceDynamic=!1,o.velocity.equalsWithEpsilon(t,1e-4)){i.supportedState=0;return}if(1e-4>o.velocity.lengthSquared())i.supportedState=2;else{o.velocity.normalize();let e=o.velocity.dot(t);1-e*e<this.maxSlopeCosine*this.maxSlopeCosine?i.supportedState=1:i.supportedState=2}let s=0;for(let e=-0;e<r.length;e++)o.planeInteractions[e].touched&&-.08>r[e].planeNormal.dot(t)&&(i.averageSurfaceNormal.addInPlace(r[e].planeNormal),i.averageSurfaceVelocity.addInPlace(n[e]),i.averageAngularSurfaceVelocity.addInPlace(r[e].angularVelocity),s++);if(s>0&&(i.averageSurfaceNormal.normalize(),i.averageSurfaceVelocity.scaleInPlace(1/s),i.averageAngularSurfaceVelocity.scaleInPlace(1/s)),2==i.supportedState)for(let e=0;e<this._manifold.length;e++){let r=this._manifold[e].bodyB;if(-.08>this._manifold[e].normal.dot(t)&&2==r.body.getMotionType(0)){i.isSurfaceDynamic=!0;break}}}_castWithCollectors(e,t,i,r){let n=this._scene.getPhysicsEngine().getPhysicsPlugin(),a=n._hknp,o=[e.x,e.y,e.z],s=[this._orientation.x,this._orientation.y,this._orientation.z,this._orientation.w];if(null!=r){let e=[this._shape._pluginData,o,s,this.keepDistance+this.keepContactTolerance,!1,[BigInt(0)]];a.HP_World_ShapeProximityWithCollector(n.world,r,e)}{let e=[this._shape._pluginData,s,o,[t.x,t.y,t.z],!1,[BigInt(0)]];a.HP_World_ShapeCastWithCollector(n.world,i,e)}}_resolveContacts(e,t){for(let i=0;i<this._manifold.length;i++){let r=this._manifold[i],n=this._manifold[i].bodyB;if(2==n.body.getMotionType(n.index)){let i=0,a=s.Pq.Zero(),o=r.position,l=this._tmpVecs[19];this._getPointVelocityToRef(n,r.position,l),l.subtractInPlace(this._velocity);let c=l.dot(r.normal),f=-(.9*c);if(r.distance<0&&(f+=.4*r.distance/e),f<0){let t=this._getInverseInertiaWorld(n),o=this._tmpVecs[15];this._getComWorldToRef(n,o);let l=this._tmpVecs[16];r.position.subtractToRef(o,l);let c=this._tmpVecs[17];s.Pq.CrossToRef(l,r.normal,c);let u=this._tmpVecs[18];s.Pq.TransformNormalToRef(c,t,u),i=f/(u.dot(c)+this._getInvMass(n));let d=-this.characterStrength*e;i<d&&(i=d),a=r.normal.scale(i)}else i=0,this._getInvMass(n);{let i=r.normal.dot(t.scale(e));c<0&&(i-=c),i<-1e-12&&a.addInPlace(r.normal.scale(this.characterMass*i))}n.body.applyImpulse(a,o,n.index)}}}_getInverseInertiaWorld(e){let t=e.body.getMassProperties(e.index);if(!t.inertia||!t.inertiaOrientation)return s.uq.IdentityReadOnly;let i=s.uq.FromQuaternionToRef(t.inertiaOrientation,s.AA.Matrix["0"]).invert(),r=s.AA.Matrix["1"],n=i.getRowToRef(0,s.AA.Vector4["0"]);return r.setRowFromFloats(0,t.inertia.x*n.x,t.inertia.x*n.y,t.inertia.x*n.z,0),i.getRowToRef(1,n),r.setRowFromFloats(0,t.inertia.y*n.x,t.inertia.y*n.y,t.inertia.y*n.z,0),i.getRowToRef(2,n),r.setRowFromFloats(0,t.inertia.z*n.x,t.inertia.z*n.y,t.inertia.z*n.z,0),i.multiplyToRef(r,this._tmpMatrix),this._tmpMatrix}_getComWorldToRef(e,t){let i=e.body.getMassProperties(e.index);s.Pq.TransformCoordinatesToRef(i.centerOfMass,e.body.transformNode.getWorldMatrix(),t)}_getInvMass(e){return 1/e.body.getMassProperties(e.index).mass}integrate(e,t,i){let r=this._scene.getPhysicsEngine().getPhysicsPlugin(),n=1/e,a=e,o=s.Pq.Zero();if(this._velocity.equalsWithEpsilon(this._lastVelocity,1e-4*n))this._lastDisplacement.scaleInPlace(a*this._lastInvDeltaTime);else{let e=this._velocity;if(2==t.supportedState){let i=this._tmpVecs[28];this._velocity.subtractToRef(t.averageSurfaceVelocity,i);let r=t.averageSurfaceNormal.dot(i);r<0&&(i.subtractInPlace(t.averageSurfaceNormal.scale(r)),e.copyFrom(i),e.addInPlace(t.averageSurfaceVelocity))}this._lastDisplacement.copyFrom(e),this._lastDisplacement.scaleInPlace(a)}this._lastVelocity.copyFrom(this._velocity),this._lastInvDeltaTime=n,this._validateManifold();for(let t=0;t<this.maxCastIterations&&a>1e-5;t++){this._castWithCollectors(this._position,this._position.add(this._lastDisplacement),this._castCollector,this._startCollector);let t=this._updateManifold(this._startCollector,this._castCollector,this._lastDisplacement),n=this._createConstraintsFromManifold(e,e-a),s=this._tmpVecs[3];s.set(this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver,this.maxCharacterSpeedForSolver);let l=0==this._velocity.lengthSquared()?0:.5*this.keepDistance/this._velocity.length(),c=this._simplexSolverSolve(n,this._velocity,a,l,this.up,s),f=c.position,u=c.deltaTime;o=c.velocity,this._resolveContacts(e,i);let d=-1;if(0!=t||f.lengthSquared()>1e-8&&!this._lastDisplacement.equalsWithEpsilon(f,1e-4)){this._castWithCollectors(this._position,this._position.add(f),this._castCollector,this._startCollector);let e=r._hknp,t=e.HP_QueryCollector_GetNumHits(this._castCollector)[1];if(t>0)for(let i=0;i<t;i++){let[t,n,a]=e.HP_QueryCollector_GetShapeCastResult(this._castCollector,i)[1],o=h(r,a,f,t,this.keepDistance);if(-1==this._findContact(o,this._manifold,.1)){d=this._manifold.length,this._manifold.push(o);break}}}if(d>=0){let e=this._manifold[d],t=1/f.length(),i=f.dot(e.normal)*t,r=-(this.keepDistance/i),n=e.fraction-r*t;n=Math.min(Math.max(n,0),1);let o=f.scale(n);this._position.addInPlace(o),a-=u*n}else this._position.addInPlace(f),a-=u;this._lastDisplacement.copyFrom(f)}this._velocity.copyFrom(o)}calculateMovementToRef(e,t,i,r,n,a,o,l){let c=t.cross(o);if(1e-5>c.lengthSquared())return!1;c.normalize();let f=c.cross(i);f.normalize(),(c=f.cross(i)).normalize();let u=s.uq.FromValues(f.x,f.y,f.z,0,c.x,c.y,c.z,0,i.x,i.y,i.z,0,0,0,0,1),d=u.clone().invert();r.subtractToRef(n,this._tmpVecs[29]);let h=this._tmpVecs[30];s.Pq.TransformNormalToRef(this._tmpVecs[29],d,h);let p=o.cross(t),m=a.dot(t),_=a.dot(p),g=a.length(),v=this._tmpVecs[4];v.set(-m,_,0),v.normalize(),v.scaleInPlace(g);let S=this._tmpVecs[5];v.subtractToRef(h,S);{let t,i=S.lengthSquared(),r=this.maxAcceleration*e;t=i*this.acceleration*this.acceleration>r*r?r/Math.sqrt(i):this.acceleration,S.scaleInPlace(t)}return h.addInPlace(S),s.Pq.TransformNormalToRef(h,u,l),l.addInPlace(n),!0}calculateMovement(e,t,i,r,n,a,o){let l=new s.Pq(0,0,0);return this.calculateMovementToRef(e,t,i,r,n,a,o,l),l}}},58034:function(e,t,i){i.d(t,{L:()=>c});var r=i(73601),n=i(2044),a=i(57480),o=i(97782),s=i(52754),l=i(37619);class c{constructor(e,t,i={mass:0},o){if(this.transformNode=e,this.type=t,this._options=i,this._scene=o,this._disposeShapeWhenDisposed=!0,!this.transformNode)return void a.V.Error("No object was provided. A physics object is obligatory");if(this.transformNode.parent&&0!==this._options.mass&&e.hasThinInstances&&a.V.Warn("A physics body has been created for an object which has a parent and thin instances. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),!this._scene)return;this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution;const s=2*(0!==this._options.mass),l=this._options.startAsleep??!1;this.body=new r.a(e,s,l,this._scene),this._addSizeOptions(),t.getClassName&&"PhysicsShape"===t.getClassName()?(this.shape=t,this._disposeShapeWhenDisposed=!1):this.shape=new n.JN({type:t,parameters:this._options},this._scene),this._options.isTriggerShape&&(this.shape.isTrigger=!0),this.material={friction:this._options.friction,restitution:this._options.restitution},this.body.shape=this.shape,this.shape.material=this.material,this.body.setMassProperties({mass:this._options.mass}),this._nodeDisposeObserver=this.transformNode.onDisposeObservable.add(()=>{this.dispose()})}_getObjectBoundingBox(){return this.transformNode.getRawBoundingInfo?this.transformNode.getRawBoundingInfo().boundingBox:new l.I(new o.Pq(-.5,-.5,-.5),new o.Pq(.5,.5,.5))}_hasVertices(e){return e?.getTotalVertices()>0}_addSizeOptions(){this.transformNode.computeWorldMatrix(!0);let e=this._getObjectBoundingBox(),t=o.AA.Vector3["0"];t.copyFrom(e.extendSize),t.scaleInPlace(2),t.multiplyInPlace(this.transformNode.absoluteScaling),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z);let i=o.AA.Vector3["1"];if(i.copyFrom(e.minimum),i.multiplyInPlace(this.transformNode.absoluteScaling),!this._options.center){let t=new o.Pq;t.copyFrom(e.center),t.multiplyInPlace(this.transformNode.absoluteScaling),this._options.center=t}switch(this.type){case 0:!this._options.radius&&(0,s.WithinEpsilon)(t.x,t.y,1e-4)&&(0,s.WithinEpsilon)(t.x,t.z,1e-4)?this._options.radius=t.x/2:this._options.radius||(a.V.Warn("Non uniform scaling is unsupported for sphere shapes. Setting the radius to the biggest bounding box extent."),this._options.radius=Math.max(t.x,t.y,t.z)/2);break;case 1:{let e=t.x/2;this._options.radius=this._options.radius??e,this._options.pointA=this._options.pointA??new o.Pq(0,i.y+e,0),this._options.pointB=this._options.pointB??new o.Pq(0,i.y+t.y-e,0)}break;case 2:{let e=t.x/2;this._options.radius=this._options.radius??e,this._options.pointA=this._options.pointA??new o.Pq(0,i.y,0),this._options.pointB=this._options.pointB??new o.Pq(0,i.y+t.y,0)}break;case 6:case 4:case 7:if(!this._options.mesh&&this._hasVertices(this.transformNode))this._options.mesh=this.transformNode;else if(!this._options.mesh||!this._hasVertices(this._options.mesh))throw Error("No valid mesh was provided for mesh or convex hull shape parameter. Please provide a mesh with valid geometry (number of vertices greater than 0).");break;case 3:this._options.extents=this._options.extents??new o.Pq(t.x,t.y,t.z),this._options.rotation=this._options.rotation??o.PT.Identity()}}dispose(){this._nodeDisposeObserver&&(this.body.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this.body.dispose(),this._disposeShapeWhenDisposed&&this.shape.dispose()}}},73601:function(e,t,i){i.d(t,{a:()=>a});var r=i(3143),n=i(97782);class a{get disablePreStep(){return this._prestepType==r.f9.DISABLED}set disablePreStep(e){this._prestepType=e?r.f9.DISABLED:r.f9.TELEPORT}constructor(e,t,i,a){if(this._pluginData=void 0,this._pluginDataInstances=[],this._collisionCBEnabled=!1,this._collisionEndedCBEnabled=!1,this.disableSync=!1,this._isDisposed=!1,this._shape=null,this._prestepType=r.f9.DISABLED,!a)return;const o=a.getPhysicsEngine();if(!o)throw Error("No Physics Engine available.");if(this._physicsEngine=o,2!=o.getPluginVersion())throw Error("Plugin version is incorrect. Expected version 2.");const s=o.getPhysicsPlugin();if(!s)throw Error("No Physics Plugin available.");this._physicsPlugin=s,e.rotationQuaternion||(e.rotationQuaternion=n.PT.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z)),this.startAsleep=i,this.disableSync=0==t,e.hasThinInstances?this._physicsPlugin.initBodyInstances(this,t,e):(e.parent&&e.computeWorldMatrix(!0),this._physicsPlugin.initBody(this,t,e.absolutePosition,e.absoluteRotationQuaternion)),this.transformNode=e,e.physicsBody=this,o.addBody(this),this._nodeDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}getClassName(){return"PhysicsBody"}clone(e){let t=new a(e,this.getMotionType(),this.startAsleep,this.transformNode.getScene());return t.shape=this.shape,t.setMassProperties(this.getMassProperties()),t.setLinearDamping(this.getLinearDamping()),t.setAngularDamping(this.getAngularDamping()),t}updateBodyInstances(){let e=this.transformNode;e.hasThinInstances&&this._physicsPlugin.updateBodyInstances(this,e)}get numInstances(){return this._pluginDataInstances.length}get motionType(){return this._physicsPlugin.getMotionType(this)}set shape(e){this._shape=e,e&&this._physicsPlugin.setShape(this,e)}get shape(){return this._shape}getBoundingBox(){return this._physicsPlugin.getBodyBoundingBox(this)}setEventMask(e,t){this._physicsPlugin.setEventMask(this,e,t)}getEventMask(e){return this._physicsPlugin.getEventMask(this,e)}setMotionType(e,t){this.disableSync=void 0===t&&0==e,this._physicsPlugin.setMotionType(this,e,t)}getMotionType(e){return this._physicsPlugin.getMotionType(this,e)}setPrestepType(e){this._prestepType=e}getPrestepType(){return this._prestepType}computeMassProperties(e){return this._physicsPlugin.computeMassProperties(this,e)}setMassProperties(e,t){this._physicsPlugin.setMassProperties(this,e,t)}getMassProperties(e){return this._physicsPlugin.getMassProperties(this,e)}setLinearDamping(e,t){this._physicsPlugin.setLinearDamping(this,e,t)}getLinearDamping(e){return this._physicsPlugin.getLinearDamping(this,e)}setAngularDamping(e,t){this._physicsPlugin.setAngularDamping(this,e,t)}getAngularDamping(e){return this._physicsPlugin.getAngularDamping(this,e)}setLinearVelocity(e,t){this._physicsPlugin.setLinearVelocity(this,e,t)}getLinearVelocityToRef(e,t){this._physicsPlugin.getLinearVelocityToRef(this,e,t)}getLinearVelocity(e){let t=new n.Pq;return this.getLinearVelocityToRef(t,e),t}setAngularVelocity(e,t){this._physicsPlugin.setAngularVelocity(this,e,t)}getAngularVelocityToRef(e,t){this._physicsPlugin.getAngularVelocityToRef(this,e,t)}getAngularVelocity(e){let t=new n.Pq;return this.getAngularVelocityToRef(t,e),t}applyImpulse(e,t,i){this._physicsPlugin.applyImpulse(this,e,t,i)}applyAngularImpulse(e,t){this._physicsPlugin.applyAngularImpulse(this,e,t)}applyForce(e,t,i){this._physicsPlugin.applyForce(this,e,t,i)}getGeometry(){return this._physicsPlugin.getBodyGeometry(this)}getCollisionObservable(){return this._physicsPlugin.getCollisionObservable(this)}getCollisionEndedObservable(){return this._physicsPlugin.getCollisionEndedObservable(this)}setCollisionCallbackEnabled(e){this._collisionCBEnabled=e,this._physicsPlugin.setCollisionCallbackEnabled(this,e)}setCollisionEndedCallbackEnabled(e){this._collisionEndedCBEnabled=e,this._physicsPlugin.setCollisionEndedCallbackEnabled(this,e)}getObjectCenterWorld(e){let t=new n.Pq;return this.getObjectCenterWorldToRef(t,e)}getObjectCenterWorldToRef(e,t){if(this._pluginDataInstances?.length>0){let i=t||0,r=this.transformNode._thinInstanceDataStorage.matrixData;r&&e.set(r[16*i+12],r[16*i+13],r[16*i+14])}else e.copyFrom(this.transformNode.position);return e}addConstraint(e,t,i,r){this._physicsPlugin.addConstraint(this,e,t,i,r)}syncWithBone(e,t,i,r,a,o){let s=this.transformNode;if(s.rotationQuaternion)if(a){let i=n.AA.Quaternion["0"];e.getRotationQuaternionToRef(1,t,i),i.multiplyToRef(a,s.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,s.rotationQuaternion);let l=n.AA.Vector3["0"],c=n.AA.Vector3["1"];o||((o=n.AA.Vector3["2"]).x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,c),e.getAbsolutePositionToRef(t,l),null==r&&i&&(r=i.length()),null!=r&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),s.setAbsolutePosition(l)}iterateOverAllInstances(e){if(this._pluginDataInstances?.length>0)for(let t=0;t<this._pluginDataInstances.length;t++)e(this,t);else e(this,void 0)}setGravityFactor(e,t){this._physicsPlugin.setGravityFactor(this,e,t)}getGravityFactor(e){return this._physicsPlugin.getGravityFactor(this,e)}setTargetTransform(e,t,i){this._physicsPlugin.setTargetTransform(this,e,t,i)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._collisionCBEnabled&&this.setCollisionCallbackEnabled(!1),this._collisionEndedCBEnabled&&this.setCollisionEndedCallbackEnabled(!1),this._nodeDisposeObserver&&(this.transformNode.onDisposeObservable.remove(this._nodeDisposeObserver),this._nodeDisposeObserver=null),this._physicsEngine.removeBody(this),this._physicsPlugin.removeBody(this),this._physicsPlugin.disposeBody(this),this.transformNode.physicsBody=null,this._pluginData=null,this._pluginDataInstances.length=0,this._isDisposed=!0,this.shape=null)}}},13858:function(e,t,i){i.d(t,{G8:()=>n,Hy:()=>c,IX:()=>u,JT:()=>o,Ji:()=>s,Jn:()=>d,Lk:()=>l,Nc:()=>r,lC:()=>f,w6:()=>a});class r{constructor(e,t,i){if(this._pluginData=void 0,!i)throw Error("Missing scene parameter for constraint constructor.");const r=i.getPhysicsEngine();if(!r)throw Error("No Physics Engine available.");if(2!=r.getPluginVersion())throw Error("Plugin version is incorrect. Expected version 2.");const n=r.getPhysicsPlugin();if(!n)throw Error("No Physics Plugin available.");this._physicsPlugin=n,this._options=t,this._type=e}get type(){return this._type}get options(){return this._options}set isEnabled(e){this._physicsPlugin.setEnabled(this,e)}get isEnabled(){return this._physicsPlugin.getEnabled(this)}set isCollisionsEnabled(e){this._physicsPlugin.setCollisionsEnabled(this,e)}get isCollisionsEnabled(){return this._physicsPlugin.getCollisionsEnabled(this)}getBodiesUsingConstraint(){return this._physicsPlugin.getBodiesUsingConstraint(this)}dispose(){this._physicsPlugin.disposeConstraint(this)}}class n{}class a extends r{constructor(e,t,i){super(7,e,i),this.limits=t}setAxisFriction(e,t){this._physicsPlugin.setAxisFriction(this,e,t)}getAxisFriction(e){return this._physicsPlugin.getAxisFriction(this,e)}setAxisMode(e,t){this._physicsPlugin.setAxisMode(this,e,t)}getAxisMode(e){return this._physicsPlugin.getAxisMode(this,e)}setAxisMinLimit(e,t){this._physicsPlugin.setAxisMinLimit(this,e,t)}getAxisMinLimit(e){return this._physicsPlugin.getAxisMinLimit(this,e)}setAxisMaxLimit(e,t){this._physicsPlugin.setAxisMaxLimit(this,e,t)}getAxisMaxLimit(e){return this._physicsPlugin.getAxisMaxLimit(this,e)}setAxisMotorType(e,t){this._physicsPlugin.setAxisMotorType(this,e,t)}getAxisMotorType(e){return this._physicsPlugin.getAxisMotorType(this,e)}setAxisMotorTarget(e,t){this._physicsPlugin.setAxisMotorTarget(this,e,t)}getAxisMotorTarget(e){return this._physicsPlugin.getAxisMotorTarget(this,e)}setAxisMotorMaxForce(e,t){this._physicsPlugin.setAxisMotorMaxForce(this,e,t)}getAxisMotorMaxForce(e){return this._physicsPlugin.getAxisMotorMaxForce(this,e)}}class o extends r{constructor(e,t,i,r,n){super(1,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class s extends r{constructor(e,t){super(2,{maxDistance:e},t)}}class l extends r{constructor(e,t,i,r,n){super(3,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class c extends r{constructor(e,t,i,r,n){super(4,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class f extends r{constructor(e,t,i,r,n){super(5,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class u extends r{constructor(e,t,i,r,n){super(6,{pivotA:e,pivotB:t,axisA:i,axisB:r},n)}}class d extends a{constructor(e,t,i,r,n,a,o,s,l){super({pivotA:e,pivotB:t,axisA:i,axisB:r},[{axis:6,minLimit:n,maxLimit:a,stiffness:o,damping:s}],l)}}},81871:function(e,t,i){i.d(t,{A:()=>o});var r=i(97782),n=i(90310),a=i(74550);class o{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,a.n)("")}constructor(e,t=o.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new r.Pq(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){let t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){let r=new n.G;return this._physicsPlugin.raycast(e,t,r,i),r}raycastMulti(e,t,i){let r=[];return this._physicsPlugin.raycast(e,t,r,i),r}}},26948:function(e,t,i){var r,n;i.d(t,{F:()=>r}),(n=r||(r={}))[n.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",n[n.MINIMUM=1]="MINIMUM",n[n.MAXIMUM=2]="MAXIMUM",n[n.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",n[n.MULTIPLY=4]="MULTIPLY"},2044:function(e,t,i){i.d(t,{Ei:()=>a,JN:()=>n,P8:()=>c,Uy:()=>u,WH:()=>f,XT:()=>s,cL:()=>l,cw:()=>o,fp:()=>h,yA:()=>d});var r=i(97782);class n{constructor(e,t){if(this._pluginData=void 0,this._isTrigger=!1,this._isDisposed=!1,!t)return;const i=t.getPhysicsEngine();if(!i)throw Error("No Physics Engine available.");if(2!=i.getPluginVersion())throw Error("Plugin version is incorrect. Expected version 2.");const r=i.getPhysicsPlugin();if(!r)throw Error("No Physics Plugin available.");if(this._physicsPlugin=r,void 0!==e.pluginData&&null!==e.pluginData)this._pluginData=e.pluginData,this._type=this._physicsPlugin.getShapeType(this);else if(void 0!==e.type&&null!==e.type){this._type=e.type;const t=e.parameters??{};this._physicsPlugin.initShape(this,e.type,t)}}getClassName(){return"PhysicsShape"}get type(){return this._type}set filterMembershipMask(e){this._physicsPlugin.setShapeFilterMembershipMask(this,e)}get filterMembershipMask(){return this._physicsPlugin.getShapeFilterMembershipMask(this)}set filterCollideMask(e){this._physicsPlugin.setShapeFilterCollideMask(this,e)}get filterCollideMask(){return this._physicsPlugin.getShapeFilterCollideMask(this)}set material(e){this._physicsPlugin.setMaterial(this,e),this._material=e}get material(){return this._material||(this._material=this._physicsPlugin.getMaterial(this)),this._material}set density(e){this._physicsPlugin.setDensity(this,e)}get density(){return this._physicsPlugin.getDensity(this)}addChildFromParent(e,t,i){let n=i.computeWorldMatrix(!0),a=e.computeWorldMatrix(!0),o=r.AA.Matrix["0"];n.multiplyToRef(r.uq.Invert(a),o);let s=r.AA.Vector3["0"],l=r.AA.Quaternion["0"],c=r.AA.Vector3["1"];o.decompose(c,l,s),this._physicsPlugin.addChild(this,t,s,l,c)}addChild(e,t,i,r){this._physicsPlugin.addChild(this,e,t,i,r)}removeChild(e){this._physicsPlugin.removeChild(this,e)}getNumChildren(){return this._physicsPlugin.getNumChildren(this)}getBoundingBox(){return this._physicsPlugin.getBoundingBox(this)}set isTrigger(e){this._isTrigger!==e&&(this._isTrigger=e,this._physicsPlugin.setTrigger(this,e))}get isTrigger(){return this._isTrigger}dispose(){this._isDisposed||(this._physicsPlugin.disposeShape(this),this._isDisposed=!0)}}class a extends n{constructor(e,t,i){super({type:0,parameters:{center:e,radius:t}},i)}static FromMesh(e){let t=e.getBoundingInfo(),i=t.boundingSphere.center,r=t.boundingBox.extendSize;return new a(i,Math.max(r.x,r.y,r.z),e.getScene())}}class o extends n{constructor(e,t,i,r){super({type:1,parameters:{pointA:e,pointB:t,radius:i}},r)}static FromMesh(e){let t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,n=new r.Pq(0,t.boundingBox.extendSize.y-i,0);return new o(t.boundingBox.center.add(n),t.boundingBox.center.subtract(n),i,e.getScene())}}class s extends n{constructor(e,t,i,r){super({type:2,parameters:{pointA:e,pointB:t,radius:i}},r)}static FromMesh(e){let t=e.getBoundingInfo(),i=t.boundingBox.extendSize.x,n=new r.Pq(0,t.boundingBox.extendSize.y,0);return new s(t.boundingBox.center.add(n),t.boundingBox.center.subtract(n),i,e.getScene())}}class l extends n{constructor(e,t,i,r){super({type:3,parameters:{center:e,rotation:t,extents:i}},r)}static FromMesh(e){let t=e.getBoundingInfo(),i=t.boundingBox.center,n=t.boundingBox.extendSize.scale(2);return new l(i,r.PT.Identity(),n,e.getScene())}}class c extends n{constructor(e,t){super({type:4,parameters:{mesh:e}},t)}}class f extends n{constructor(e,t){super({type:6,parameters:{mesh:e}},t)}}class u extends n{constructor(e){super({type:5,parameters:{}},e)}}class d extends n{constructor(e,t,i,r,n,a){super({type:7,parameters:{heightFieldSizeX:e,heightFieldSizeZ:t,numHeightFieldSamplesX:i,numHeightFieldSamplesZ:r,heightFieldData:n}},a)}}class h extends n{constructor(e,t){super({type:7,parameters:{groundMesh:e}},t)}}},28399:function(e,t,i){i.d(t,{V:()=>c,k:()=>f});var r=i(97782),n=i(58034),a=i(13858),o=i(29608),s=i(57480),l=i(89671);class c{}class f{constructor(e,t,i){this._boxConfigs=[],this._constraints=[],this._bones=[],this._initialRotation=[],this._initialRotation2=[],this._boneNames=[],this._transforms=[],this._aggregates=[],this._ragdollMode=!1,this._rootBoneName="",this._rootBoneIndex=-1,this._mass=10,this._restitution=0,this._beforeRenderObserver=null,this.pauseSync=!1,this._defaultJoint=3,this._defaultJointMin=-90,this._defaultJointMax=90,this._skeleton=e,this._scene=e.getScene(),this._rootTransformNode=t,this._config=i,this._boxConfigs=[],this._putBoxesInBoneCenter=!1,this._defaultJoint=3,this._init()}getConstraints(){return this._constraints}getAggregate(e){return e<0||e>=this._aggregates.length?this._aggregates[this._rootBoneIndex]:this._aggregates[e]}_createColliders(){this._rootTransformNode.computeWorldMatrix(),this._skeleton.computeAbsoluteMatrices(!0),this._skeleton.prepare(!0);let e=this._config;for(let t=0;t<e.length;t++){let i=void 0!==e[t].bone?[e[t].bone]:e[t].bones;for(let a=0;a<i.length;a++){let c=this._skeleton.bones[this._skeleton.getBoneIndexByName(i[a])];if(void 0==c)return;let f={width:this._config[t].width,depth:this._config[t].depth,height:this._config[t].height,size:this._config[t].size};f.width=f.width??f.size,f.depth=f.depth??f.size,f.height=f.height??f.size;let u=new l.V(i[a]+"_transform",this._scene);f.joint=void 0!==e[t].joint?e[t].joint:this._defaultJoint,f.rotationAxis=void 0!==e[t].rotationAxis?e[t].rotationAxis:o._0.X,f.min=void 0!==e[t].min?e[t].min:this._defaultJointMin,f.max=void 0!==e[t].max?e[t].max:this._defaultJointMax;let d=0;void 0!==e[t].putBoxInBoneCenter&&e[t].putBoxInBoneCenter||this._putBoxesInBoneCenter?(void 0===c.length&&s.V.Log("The length property is not defined for bone "+c.name),d=c.length/2):void 0!==e[t].boxOffset&&(d=e[t].boxOffset),f.boxOffset=d;let h=void 0!==e[t].boneOffsetAxis?e[t].boneOffsetAxis:o._0.Y,p=c.getDirection(h,this._rootTransformNode);f.boneOffsetAxis=h,u.position=c.getAbsolutePosition(this._rootTransformNode).add(p.scale(d));let m=void 0!==e[t].mass?e[t].mass:this._mass,_=void 0!==e[t].restitution?e[t].restitution:this._restitution,g=new n.L(u,3,{mass:m,restitution:_,friction:.6,extents:new r.Pq(f.width,f.height,f.depth)},this._scene);g.body.setCollisionCallbackEnabled(!0),g.body.disablePreStep=!1,g.body.setMotionType(1),this._aggregates.push(g),this._bones.push(c),this._boneNames.push(c.name),this._transforms.push(u),this._boxConfigs.push(f),this._initialRotation.push(c.getRotationQuaternion(1,this._rootTransformNode)),this._initialRotation2.push(c.getRotationQuaternion(1))}}}_initJoints(){this._rootTransformNode.computeWorldMatrix();for(let e=0;e<this._bones.length;e++){if(e==this._rootBoneIndex)continue;let t=this._findNearestParent(e);if(null==t)return void s.V.Warn("Couldn't find a nearest parent bone in the configs for bone called "+this._boneNames[e]);let i=this._boneNames.indexOf(t.name),n=this._bones[e].getAbsolutePosition(this._rootTransformNode).subtract(this._transforms[i].position),o=this._transforms[i].computeWorldMatrix(),l=r.uq.Invert(o);n=r.Pq.TransformCoordinates(this._bones[e].getAbsolutePosition(this._rootTransformNode),l);let c=this._bones[e].getAbsolutePosition(this._rootTransformNode),f=this._transforms[e].position.clone(),u=c.subtract(f),d=this._boxConfigs[e].joint??this._defaultJoint,h=new a.Nc(d,{pivotA:n,pivotB:u,axisA:this._boxConfigs[e].rotationAxis,axisB:this._boxConfigs[e].rotationAxis,collision:!1},this._scene);this._aggregates[i].body.addConstraint(this._aggregates[e].body,h),h.isEnabled=!1,this._constraints.push(h)}}_syncBonesToPhysics(){let e=this._rootTransformNode.getWorldMatrix();for(let t=0;t<this._bones.length;t++){let i=this._aggregates[t].transformNode,n=this._bones[t].getAbsolutePosition();r.Pq.TransformCoordinatesToRef(n,e,i.position),this._bones[t].getDirectionToRef(this._boxConfigs[t].boneOffsetAxis,this._rootTransformNode,r.AA.Vector3["0"]),r.AA.Vector3["0"].scaleInPlace(this._boxConfigs[t].boxOffset??0),i.position.addInPlace(r.AA.Vector3["0"]),this._setBoneOrientationToBody(t)}}_setBoneOrientationToBody(e){let t=this._aggregates[e].transformNode,i=this._bones[e];this._initialRotation[e].conjugateToRef(r.AA.Quaternion["0"]),i.getRotationQuaternionToRef(1,this._rootTransformNode,r.AA.Quaternion["1"]),r.AA.Quaternion["1"].multiplyToRef(r.AA.Quaternion["0"],t.rotationQuaternion),t.rotationQuaternion.normalize()}_syncBonesAndBoxes(){if(!this.pauseSync)if(this._ragdollMode){this._setBodyOrientationToBone(this._rootBoneIndex);let e=this._aggregates[this._rootBoneIndex].body.transformNode.position;this._rootTransformNode.getWorldMatrix().invertToRef(r.AA.Matrix["0"]),r.Pq.TransformCoordinatesToRef(e,r.AA.Matrix["0"],r.AA.Vector3["0"]),this._bones[this._rootBoneIndex].setAbsolutePosition(r.AA.Vector3["0"]);for(let e=0;e<this._bones.length;e++)e!=this._rootBoneIndex&&this._setBodyOrientationToBone(e)}else this._syncBonesToPhysics()}_setBodyOrientationToBone(e){let t=this._rootTransformNode.rotationQuaternion??r.PT.FromEulerAngles(this._rootTransformNode.rotation.x,this._rootTransformNode.rotation.y,this._rootTransformNode.rotation.z),i=this._initialRotation2[e],n=this._aggregates[e].body?.transformNode?.rotationQuaternion;t.multiplyToRef(i,r.AA.Quaternion["1"]),n?.multiplyToRef(r.AA.Quaternion["1"],r.AA.Quaternion["0"]),this._bones[e].setRotationQuaternion(r.AA.Quaternion["0"],1,this._rootTransformNode)}_defineRootBone(){let e=this._skeleton.getChildren();return 1!=e.length?(s.V.Log("Ragdoll creation failed: there can only be one root in the skeleton."),!1):(this._rootBoneName=e[0].name,this._rootBoneIndex=this._boneNames.indexOf(this._rootBoneName),-1!=this._rootBoneIndex||(s.V.Log("Ragdoll creation failed: the array boneNames doesn't have the root bone. The root bone is "+this._skeleton.getChildren()),!1))}_findNearestParent(e){let t=this._bones[e].getParent();do{if(null!=t&&this._boneNames.includes(t.name))break;t=t?.getParent()}while(null!=t);return t}_init(){this._createColliders(),this._defineRootBone()&&(this._initJoints(),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{this._syncBonesAndBoxes()}),this._syncBonesToPhysics())}ragdoll(){for(let e of(this._ragdollMode=!0,this._skeleton.bones))e.linkTransformNode(null);for(let e=0;e<this._constraints.length;e++)this._constraints[e].isEnabled=!0;for(let e=0;e<this._aggregates.length;e++)this._aggregates[e].body.setMotionType(2)}dispose(){for(let e of this._aggregates)e.dispose();for(let e of(this._aggregates.length=0,this._transforms))e.dispose();for(let e of(this._transforms.length=0,this._constraints))e.dispose();this._constraints.length=0,this._beforeRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._beforeRenderObserver=null)}}},95883:function(e,t,i){i.d(t,{U:()=>o});var r=i(65129),n=i(93610),a=i(8276);class o{get camera(){return this._ssaoPostProcess.camera}set camera(e){this._ssaoPostProcess.camera=e,this._ssaoCombinePostProcess.camera=e}set samples(e){this._ssaoPostProcess.samples=e}get samples(){return this._ssaoPostProcess.samples}get totalStrength(){return this._ssaoPostProcess.totalStrength}set totalStrength(e){this._ssaoPostProcess.totalStrength=e}get radius(){return this._ssaoPostProcess.radius}set radius(e){this._ssaoPostProcess.radius=e}get maxZ(){return this._ssaoPostProcess.maxZ}set maxZ(e){this._ssaoPostProcess.maxZ=e}get minZAspect(){return this._ssaoPostProcess.minZAspect}set minZAspect(e){this._ssaoPostProcess.minZAspect=e}get base(){return this._ssaoPostProcess.base}set base(e){this._ssaoPostProcess.base=e}get epsilon(){return this._ssaoPostProcess.epsilon}set epsilon(e){this._ssaoPostProcess.epsilon=e}set bypassBlur(e){this._ssaoBlurXPostProcess.bypassBlur=e,this._ssaoBlurYPostProcess.bypassBlur=e}get bypassBlur(){return this._ssaoBlurXPostProcess.bypassBlur}set expensiveBlur(e){this._ssaoBlurXPostProcess.expensiveBlur=e,this._ssaoBlurYPostProcess.expensiveBlur=e}get expensiveBlur(){return this._ssaoBlurXPostProcess.expensiveBlur}get bilateralSamples(){return this._ssaoBlurXPostProcess.bilateralSamples}set bilateralSamples(e){this._ssaoBlurXPostProcess.bilateralSamples=e,this._ssaoBlurYPostProcess.bilateralSamples=e}get bilateralSoften(){return this._ssaoBlurXPostProcess.bilateralSoften}set bilateralSoften(e){this._ssaoBlurXPostProcess.bilateralSoften=e,this._ssaoBlurYPostProcess.bilateralSoften=e}get bilateralTolerance(){return this._ssaoBlurXPostProcess.bilateralTolerance}set bilateralTolerance(e){this._ssaoBlurXPostProcess.bilateralTolerance=e,this._ssaoBlurYPostProcess.bilateralTolerance=e}get useViewportInCombineStage(){return this._ssaoCombinePostProcess.useViewportInCombineStage}set useViewportInCombineStage(e){this._ssaoCombinePostProcess.useViewportInCombineStage=e}isReady(){return this._ssaoPostProcess.isReady()&&this._ssaoBlurXPostProcess.isReady()&&this._ssaoBlurYPostProcess.isReady()&&this._ssaoCombinePostProcess.isReady()}constructor(e,t){this.name=e,this._scene=t,this._ssaoPostProcess=new r.V(this.name,this._scene),this._ssaoBlurXPostProcess=new n.s(this.name+" BlurX",this._scene.getEngine(),!0),this._ssaoBlurYPostProcess=new n.s(this.name+" BlurY",this._scene.getEngine(),!1),this._ssaoCombinePostProcess=new a.m(this.name+" Combiner",this._scene.getEngine())}dispose(){this._ssaoPostProcess?.dispose(),this._ssaoBlurXPostProcess?.dispose(),this._ssaoBlurYPostProcess?.dispose(),this._ssaoCombinePostProcess?.dispose()}}},20535:function(e,t,i){i.d(t,{w:()=>s});var r=i(97782),n=i(91793),a=i(21973),o=i(79017);class s{get isSSRSupported(){return this._ssrPostProcess.isSSRSupported}set isSSRSupported(e){this._ssrPostProcess.isSSRSupported=e}get maxDistance(){return this._ssrPostProcess.maxDistance}set maxDistance(e){this._ssrPostProcess.maxDistance=e}get step(){return this._ssrPostProcess.step}set step(e){this._ssrPostProcess.step=e}get thickness(){return this._ssrPostProcess.thickness}set thickness(e){this._ssrPostProcess.thickness=e}get strength(){return this._ssrPostProcess.strength}set strength(e){this._ssrPostProcess.strength=e,this._ssrBlurCombinerPostProcess.strength=e}get reflectionSpecularFalloffExponent(){return this._ssrPostProcess.reflectionSpecularFalloffExponent}set reflectionSpecularFalloffExponent(e){this._ssrPostProcess.reflectionSpecularFalloffExponent=e,this._ssrBlurCombinerPostProcess.reflectionSpecularFalloffExponent=e}get maxSteps(){return this._ssrPostProcess.maxSteps}set maxSteps(e){this._ssrPostProcess.maxSteps=e}get roughnessFactor(){return this._ssrPostProcess.roughnessFactor}set roughnessFactor(e){this._ssrPostProcess.roughnessFactor=e}get selfCollisionNumSkip(){return this._ssrPostProcess.selfCollisionNumSkip}set selfCollisionNumSkip(e){this._ssrPostProcess.selfCollisionNumSkip=e}get reflectivityThreshold(){return this._ssrPostProcess.reflectivityThreshold}set reflectivityThreshold(e){e!==this._ssrPostProcess.reflectivityThreshold&&(this._ssrPostProcess.reflectivityThreshold=e,this._ssrBlurCombinerPostProcess.reflectivityThreshold=e)}get blurDispersionStrength(){return this._ssrBlurXPostProcess.blurStrength}set blurDispersionStrength(e){e!==this._ssrBlurXPostProcess.blurStrength&&(this._ssrPostProcess.useBlur=e>0,this._ssrBlurXPostProcess.blurStrength=e,this._ssrBlurYPostProcess.blurStrength=e)}get enableSmoothReflections(){return this._ssrPostProcess.enableSmoothReflections}set enableSmoothReflections(e){this._ssrPostProcess.enableSmoothReflections=e}get environmentTexture(){return this._ssrPostProcess.environmentTexture}set environmentTexture(e){this._ssrPostProcess.environmentTexture=e}get environmentTextureIsProbe(){return this._ssrPostProcess.environmentTextureIsProbe}set environmentTextureIsProbe(e){this._ssrPostProcess.environmentTextureIsProbe=e}get attenuateScreenBorders(){return this._ssrPostProcess.attenuateScreenBorders}set attenuateScreenBorders(e){this._ssrPostProcess.attenuateScreenBorders=e}get attenuateIntersectionDistance(){return this._ssrPostProcess.attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._ssrPostProcess.attenuateIntersectionDistance=e}get attenuateIntersectionIterations(){return this._ssrPostProcess.attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._ssrPostProcess.attenuateIntersectionIterations=e}get attenuateFacingCamera(){return this._ssrPostProcess.attenuateFacingCamera}set attenuateFacingCamera(e){this._ssrPostProcess.attenuateFacingCamera=e}get attenuateBackfaceReflection(){return this._ssrPostProcess.attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._ssrPostProcess.attenuateBackfaceReflection=e}get clipToFrustum(){return this._ssrPostProcess.clipToFrustum}set clipToFrustum(e){this._ssrPostProcess.clipToFrustum=e}get useFresnel(){return this._ssrPostProcess.useFresnel}set useFresnel(e){this._ssrPostProcess.useFresnel=e,this._ssrBlurCombinerPostProcess.useFresnel=e}get enableAutomaticThicknessComputation(){return this._ssrPostProcess.enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._ssrPostProcess.enableAutomaticThicknessComputation!==e&&(this._ssrPostProcess.enableAutomaticThicknessComputation=e)}get inputTextureColorIsInGammaSpace(){return this._ssrPostProcess.inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._ssrPostProcess.inputTextureColorIsInGammaSpace!==e&&(this._ssrPostProcess.inputTextureColorIsInGammaSpace=e,this._ssrBlurCombinerPostProcess.inputTextureColorIsInGammaSpace=e)}get generateOutputInGammaSpace(){return this._ssrPostProcess.generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._ssrPostProcess.generateOutputInGammaSpace!==e&&(this._ssrPostProcess.generateOutputInGammaSpace=e,this._ssrBlurCombinerPostProcess.generateOutputInGammaSpace=e)}get debug(){return this._ssrPostProcess.debug}set debug(e){this._ssrPostProcess.debug!==e&&(this._ssrPostProcess.debug=e,this._ssrBlurCombinerPostProcess.debug=e)}get camera(){return this._ssrPostProcess.camera}set camera(e){this._ssrPostProcess.camera=e,this._ssrBlurCombinerPostProcess.camera=e}get useScreenspaceDepth(){return this._ssrPostProcess.useScreenspaceDepth}set useScreenspaceDepth(e){this._ssrPostProcess.useScreenspaceDepth=e,this._ssrBlurCombinerPostProcess.useScreenspaceDepth=e}get normalsAreInWorldSpace(){return this._ssrPostProcess.normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._ssrPostProcess.normalsAreInWorldSpace=e,this._ssrBlurCombinerPostProcess.normalsAreInWorldSpace=e}get normalsAreUnsigned(){return this._ssrPostProcess.normalsAreUnsigned}set normalsAreUnsigned(e){this._ssrPostProcess.normalsAreUnsigned=e,this._ssrBlurCombinerPostProcess.normalsAreUnsigned=e}isReady(){return this._ssrPostProcess.isReady()&&this._ssrBlurXPostProcess.isReady()&&this._ssrBlurYPostProcess.isReady()&&this._ssrBlurCombinerPostProcess.isReady()}constructor(e,t){this.ssrDownsample=0,this.blurDownsample=0,this.name=e,this._scene=t,this._ssrPostProcess=new n.N(this.name,this._scene),this._ssrBlurXPostProcess=new a.k(this.name+" BlurX",this._scene.getEngine(),new r.I9(1,0)),this._ssrBlurYPostProcess=new a.k(this.name+" BlurY",this._scene.getEngine(),new r.I9(0,1)),this._ssrBlurCombinerPostProcess=new o.F(this.name+" BlurCombiner",this._scene.getEngine()),this._ssrPostProcess.useBlur=this._ssrBlurXPostProcess.blurStrength>0}dispose(){this._ssrPostProcess?.dispose(),this._ssrBlurXPostProcess?.dispose(),this._ssrBlurYPostProcess?.dispose(),this._ssrBlurCombinerPostProcess?.dispose()}}},39005:function(e,t,i){i.d(t,{w:()=>a});var r=i(89270),n=i(94602);Object.defineProperty(i(38241).Z.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(r.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new a(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new n.R}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class a{constructor(e){this.name=r.v.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(r.v.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}},94562:function(e,t,i){i.d(t,{m:()=>o});var r=i(3008),n=i(10363),a=i(76937);class o extends r.${constructor(e,t=null,i){super({name:e,engine:t||n.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,...i}),this.onBindObservable=new a.cP}bind(e=!1){super.bind(e),this.onBindObservable.notifyObservers(this._drawWrapper.effect)}}},93610:function(e,t,i){i.d(t,{s:()=>a});var r=i(3008),n=i(10363);class a extends r.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,77455)))):t.push(Promise.resolve().then(i.bind(i,71064)))}constructor(e,t=null,i,r){super({...r,name:e,engine:t||n.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:a.FragmentUrl,uniforms:a.Uniforms,samplers:a.Samplers,defines:"#define BLUR\n"+(i?"#define BLUR_H\n":"")}),this._bypassBlur=!1,this.textureSize=0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._expensiveBlur=!0,this._isHorizontal=i;const o=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),s=this._getSamplersForBlur(this.bypassBlur);this.updateEffect(o,null,s)}set bypassBlur(e){let t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this.updateEffect(t,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){let t=this._getDefinesForBlur(e,this._bypassBlur);this.updateEffect(t),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}bind(e=!1){super.bind(e);let t=this._drawWrapper.effect;t.setFloat("outSize",this.textureSize),t.setInt("samples",this.bilateralSamples),t.setFloat("soften",this.bilateralSoften),t.setFloat("tolerance",this.bilateralTolerance)}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),this._isHorizontal?i+"#define BLUR_H\n":i}}a.FragmentUrl="ssao2",a.Uniforms=["outSize","samples","soften","tolerance"],a.Samplers=["textureSampler","depthSampler"]},8276:function(e,t,i){i.d(t,{m:()=>o});var r=i(3008),n=i(10363),a=i(97782);class o extends r.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,53110)))):t.push(Promise.resolve().then(i.bind(i,79821)))}constructor(e,t=null,i){super({...i,name:e,engine:t||n.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:o.FragmentUrl,uniforms:o.Uniforms,samplers:o.Samplers}),this.camera=null,this.useViewportInCombineStage=!0}bind(e=!1){super.bind(e);let t=this._drawWrapper.effect;if(this.camera){let e=this.camera.viewport;this.useViewportInCombineStage?t.setVector4("viewport",a.AA.Vector4["0"].copyFromFloats(e.x,e.y,e.width,e.height)):t.setVector4("viewport",a.AA.Vector4["0"].copyFromFloats(0,0,1,1))}}}o.FragmentUrl="ssaoCombine",o.Uniforms=["viewport"],o.Samplers=["originalColor"]},65129:function(e,t,i){i.d(t,{V:()=>c});var r=i(3008),n=i(97782),a=i(45119),o=i(76312),s=i(52754),l=i(46538);class c extends r.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,77455)))):t.push(Promise.resolve().then(i.bind(i,71064)))}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e)}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e)}set samples(e){this._samples=e,this.updateEffect(),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set epsilon(e){this._epsilon=e,this.updateEffect()}get epsilon(){return this._epsilon}updateEffect(){super.updateEffect(this._getDefinesForSSAO())}constructor(e,t,i){super({...i,name:e,engine:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:c.FragmentUrl,uniforms:c.Uniforms,samplers:c.Samplers,defines:`#define SSAO
#define SAMPLES 8
#define EPSILON 0.0001`,shaderLanguage:+!!t.getEngine().isWebGPU}),this.camera=null,this._textureWidth=0,this._textureHeight=0,this._samples=8,this.totalStrength=1,this.radius=2,this.maxZ=100,this.minZAspect=.2,this.base=0,this._epsilon=.02,this._bits=new Uint32Array(1),this._scene=t,this._createRandomTexture(),this.updateEffect(),this._sampleSphere=this._generateHemisphere()}bind(e=!1){super.bind(e);let t=this._drawWrapper.effect,i=this.camera;if(!i)return;let r=i.getProjectionMatrix();if(t.setArray3("sampleSphere",this._sampleSphere),t.setFloat("randTextureTiles",32),t.setFloat("samplesFactor",1/this.samples),t.setFloat("totalStrength",this.totalStrength),t.setFloat2("texelSize",1/this.textureWidth,1/this.textureHeight),t.setFloat("radius",this.radius),t.setFloat("maxZ",this.maxZ),t.setFloat("minZAspect",this.minZAspect),t.setFloat("base",this.base),t.setFloat("near",i.minZ),i.mode===a.i.PERSPECTIVE_CAMERA){t.setMatrix3x3("depthProjection",c.PERSPECTIVE_DEPTH_PROJECTION);let e=Math.tan(i.fov/2);i.fovMode===a.i.FOVMODE_VERTICAL_FIXED?(t.setFloat("xViewport",e*this._scene.getEngine().getAspectRatio(i,!0)),t.setFloat("yViewport",e)):(t.setFloat("xViewport",e),t.setFloat("yViewport",e/this._scene.getEngine().getAspectRatio(i,!0)))}else{let e=this._scene.getEngine().getRenderWidth()/2,r=this._scene.getEngine().getRenderHeight()/2,n=i.orthoLeft??-e,a=i.orthoRight??e,o=i.orthoBottom??-r,s=i.orthoTop??r;t.setMatrix3x3("depthProjection",c.ORTHO_DEPTH_PROJECTION),t.setFloat4("viewport",n,a,o,s)}t.setMatrix("projection",r),t.setTexture("randomSampler",this._randomTexture)}dispose(){this._randomTexture.dispose(),super.dispose()}_createRandomTexture(){let e=new Uint8Array(65536),t=n.I9.Zero();for(let i=0;i<e.length;)t.set((0,s.RandomRange)(0,1),(0,s.RandomRange)(0,1)).normalize().scaleInPlace(255),e[i++]=Math.floor(t.x),e[i++]=Math.floor(t.y),e[i++]=0,e[i++]=255;let i=o.I.CreateRGBATexture(e,128,128,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=l.g.WRAP_ADDRESSMODE,i.wrapV=l.g.WRAP_ADDRESSMODE,this._randomTexture=i}_radicalInverseVdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(0x55555555&this._bits[0])<<1|(0xaaaaaaaa&this._bits[0])>>>1>>>0,this._bits[0]=(0x33333333&this._bits[0])<<2|(0xcccccccc&this._bits[0])>>>2>>>0,this._bits[0]=(0xf0f0f0f&this._bits[0])<<4|(0xf0f0f0f0&this._bits[0])>>>4>>>0,this._bits[0]=(0xff00ff&this._bits[0])<<8|(0xff00ff00&this._bits[0])>>>8>>>0,23283064365386963e-26*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverseVdC(e)]}_hemisphereSampleUniform(e,t){let i=2*t*Math.PI,r=1-.85*e,a=Math.sqrt(1-r*r);return new n.Pq(Math.cos(i)*a,Math.sin(i)*a,r)}_generateHemisphere(){let e,t=this.samples,i=[],r=0;for(;r<t;){if(t<16)e=this._hemisphereSampleUniform(Math.random(),Math.random());else{let i=this._hammersley(r,t);e=this._hemisphereSampleUniform(i[0],i[1])}i.push(e.x,e.y,e.z),r++}return i}_getDefinesForSSAO(){let e=this._epsilon??.02,t=this._samples??8,i=`#define SSAO
#define SAMPLES ${t}
#define EPSILON ${e.toFixed(4)}`;return this.camera?.mode===a.i.ORTHOGRAPHIC_CAMERA&&(i+=`
#define ORTHOGRAPHIC_CAMERA`),i}}c.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],c.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],c.FragmentUrl="ssao2",c.Uniforms=["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","viewport","maxZ","minZAspect","depthProjection"],c.Samplers=["randomSampler","depthSampler","normalSampler"]},79017:function(e,t,i){i.d(t,{F:()=>o});var r=i(3008),n=i(10363),a=i(97782);class o extends r.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,56738)))):t.push(Promise.resolve().then(i.bind(i,61723)))}constructor(e,t=null,i){super({...i,name:e,engine:t||n.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:o.FragmentUrl,uniforms:o.Uniforms,samplers:o.Samplers}),this.strength=1,this.reflectionSpecularFalloffExponent=1,this.camera=null,this._useFresnel=!1,this._useScreenspaceDepth=!1,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._reflectivityThreshold=.04,this._normalsAreInWorldSpace=!1,this._normalsAreUnsigned=!1,this._updateEffectDefines()}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._updateEffectDefines())}get useScreenspaceDepth(){return this._useScreenspaceDepth}set useScreenspaceDepth(e){this._useScreenspaceDepth!==e&&(this._useScreenspaceDepth=e,this._updateEffectDefines())}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._updateEffectDefines())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._updateEffectDefines())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._updateEffectDefines())}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._updateEffectDefines()):this._reflectivityThreshold=e)}get normalsAreInWorldSpace(){return this._normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._normalsAreInWorldSpace!==e&&(this._normalsAreInWorldSpace=e,this._updateEffectDefines())}get normalsAreUnsigned(){return this._normalsAreUnsigned}set normalsAreUnsigned(e){this._normalsAreUnsigned!==e&&(this._normalsAreUnsigned=e,this._updateEffectDefines())}bind(e=!1){super.bind(e);let t=this._drawWrapper.effect;if(t.setFloat("strength",this.strength),t.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),t.setFloat("reflectivityThreshold",this.reflectivityThreshold),this.useFresnel&&this.camera){let e=this.camera.getProjectionMatrix();e.invertToRef(a.AA.Matrix["0"]),t.setMatrix("projection",e),t.setMatrix("invProjectionMatrix",a.AA.Matrix["0"]),t.setMatrix("view",this.camera.getViewMatrix()),this.useScreenspaceDepth&&(t.setFloat("nearPlaneZ",this.camera.minZ),t.setFloat("farPlaneZ",this.camera.maxZ))}}_updateEffectDefines(){let e="";this._debug&&(e+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(e+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(e+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this._useFresnel&&(e+="#define SSR_BLEND_WITH_FRESNEL\n"),this._useScreenspaceDepth&&(e+="#define SSRAYTRACE_SCREENSPACE_DEPTH\n"),0===this._reflectivityThreshold&&(e+="#define SSR_DISABLE_REFLECTIVITY_TEST\n"),this._normalsAreInWorldSpace&&(e+="#define SSR_NORMAL_IS_IN_WORLDSPACE\n"),this._normalsAreUnsigned&&(e+="#define SSR_DECODE_NORMAL\n"),this.updateEffect(e)}}o.FragmentUrl="screenSpaceReflection2BlurCombiner",o.Uniforms=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold","projection","invProjectionMatrix","nearPlaneZ","farPlaneZ","view"],o.Samplers=["textureSampler","depthSampler","normalSampler","mainSampler","reflectivitySampler"]},21973:function(e,t,i){i.d(t,{k:()=>o});var r=i(3008),n=i(10363),a=i(97782);class o extends r.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,58985)))):t.push(Promise.resolve().then(i.bind(i,40676)))}constructor(e,t=null,i,r,s){super({...s,name:e,engine:t||n.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:o.FragmentUrl,uniforms:o.Uniforms,samplers:o.Samplers}),this.textureWidth=0,this.textureHeight=0,this.direction=new a.I9(1,0),this.blurStrength=.03,void 0!==i&&(this.direction=i),void 0!==r&&(this.blurStrength=r)}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat2("texelOffsetScale",1/this.textureWidth*this.direction.x*this.blurStrength,1/this.textureHeight*this.direction.y*this.blurStrength)}}o.FragmentUrl="screenSpaceReflection2Blur",o.Uniforms=["texelOffsetScale"],o.Samplers=["textureSampler"]},91793:function(e,t,i){i.d(t,{N:()=>s});var r=i(3008),n=i(97782);let a=n.uq.Compose(new n.Pq(.5,.5,.5),n.PT.Identity(),new n.Pq(.5,.5,.5)),o=n.uq.Compose(new n.Pq(.5,.5,1),n.PT.Identity(),new n.Pq(.5,.5,0));class s extends r.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,14822)))):t.push(Promise.resolve().then(i.bind(i,9499)))}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._updateEffectDefines()):this._reflectivityThreshold=e)}get useBlur(){return this._useBlur}set useBlur(e){this._useBlur!==e&&(this._useBlur=e,this._updateEffectDefines())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._updateEffectDefines())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._updateEffectDefines())}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._updateEffectDefines())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._updateEffectDefines())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._updateEffectDefines())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e)}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e)}get useScreenspaceDepth(){return this._useScreenspaceDepth}set useScreenspaceDepth(e){this._useScreenspaceDepth!==e&&(this._useScreenspaceDepth=e,this._updateEffectDefines())}get normalsAreInWorldSpace(){return this._normalsAreInWorldSpace}set normalsAreInWorldSpace(e){this._normalsAreInWorldSpace!==e&&(this._normalsAreInWorldSpace=e,this._updateEffectDefines())}get normalsAreUnsigned(){return this._normalsAreUnsigned}set normalsAreUnsigned(e){this._normalsAreUnsigned!==e&&(this._normalsAreUnsigned=e,this._updateEffectDefines())}constructor(e,t,i){super({...i,name:e,engine:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:s.FragmentUrl,uniforms:s.Uniforms,samplers:s.Samplers,shaderLanguage:+!!t.getEngine().isWebGPU}),this.isSSRSupported=!0,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._useBlur=!1,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._textureWidth=0,this._textureHeight=0,this.camera=null,this._useScreenspaceDepth=!1,this._normalsAreInWorldSpace=!1,this._normalsAreUnsigned=!1,this._scene=t,this._updateEffectDefines()}bind(e=!1){super.bind(e);let t=this._drawWrapper.effect,i=this.camera;if(!i)return;let r=i.getViewMatrix(),s=i.getProjectionMatrix();s.invertToRef(n.AA.Matrix["0"]),r.invertToRef(n.AA.Matrix["1"]),t.setMatrix("projection",s),t.setMatrix("view",r),t.setMatrix("invView",n.AA.Matrix["1"]),t.setMatrix("invProjectionMatrix",n.AA.Matrix["0"]),t.setFloat("thickness",this.thickness),t.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),t.setFloat("strength",this.strength),t.setFloat("stepSize",this.step),t.setFloat("maxSteps",this.maxSteps),t.setFloat("roughnessFactor",this.roughnessFactor),t.setFloat("nearPlaneZ",i.minZ),t.setFloat("farPlaneZ",i.maxZ),t.setFloat("maxDistance",this.maxDistance),t.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),t.setFloat("reflectivityThreshold",this._reflectivityThreshold),n.uq.ScalingToRef(this.textureWidth,this.textureHeight,1,n.AA.Matrix["2"]),s.multiplyToRef(this._scene.getEngine().isWebGPU?o:a,n.AA.Matrix["3"]),n.AA.Matrix["3"].multiplyToRef(n.AA.Matrix["2"],n.AA.Matrix["4"]),t.setMatrix("projectionPixel",n.AA.Matrix["4"]),this._environmentTexture&&(t.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(t.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),t.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))}_updateEffectDefines(){let e=[];this.isSSRSupported&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._useScreenspaceDepth&&e.push("#define SSRAYTRACE_SCREENSPACE_DEPTH"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this.useBlur&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),this._normalsAreInWorldSpace&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL"),this.camera&&1===this.camera.mode&&e.push("#define ORTHOGRAPHIC_CAMERA"),this.updateEffect(e.join("\n"))}}s.FragmentUrl="screenSpaceReflection2",s.Uniforms=["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","farPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],s.Samplers=["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"]},59316:function(e,t,i){i.d(t,{n:()=>p});var r=i(45119),n=i(77880),a=i(97782),o=i(3008),s=i(46319),l=i(92233),c=i(91125),f=i(7979);class u extends s.M{constructor(){super(...arguments),this.TAA_JITTER=!1}}class d extends l.y{get manager(){return this._manager}set manager(e){this._manager!==e&&(this.dispose(),this._manager=e,e?._materialPlugins.push(this),this._updateMaterial())}get isEnabled(){return this._manager?.isEnabled??!1}constructor(e){super(e,d.Name,300,new u),this.registerForExtraEvents=!0,this.doNotSerialize=!0}_updateMaterial(){this._enable(this.isEnabled),this.markAllDefinesAsDirty()}isCompatible(){return!0}getClassName(){return"TAAJitterMaterialPlugin"}prepareDefines(e){e.TAA_JITTER=this.isEnabled}getUniforms(e=0){let t=[{name:"taa_jitter",size:2,type:"vec2"}];return 0===e?{ubo:t,vertex:`
                    #ifdef TAA_JITTER
                    uniform vec2 taa_jitter;
                    #endif
                `}:{ubo:t}}hardBindForSubMesh(e){if(this.isEnabled){let t=this._manager.jitter;e.updateFloat2("taa_jitter",t.x,t.y)}}getCustomCode(e,t=0){return"vertex"!==e?null:1===t?{CUSTOM_VERTEX_MAIN_END:`
                    #ifdef TAA_JITTER
                    vertexOutputs.position += vec4f(uniforms.taa_jitter * vertexOutputs.position.w, 0.0, 0.0);
                    #endif
                `}:{CUSTOM_VERTEX_MAIN_END:`
                    #ifdef TAA_JITTER
                    gl_Position.xy += taa_jitter * gl_Position.w;
                    #endif
                `}}dispose(){if(this._manager){let e=this._manager._materialPlugins.indexOf(this);-1!==e&&this._manager._materialPlugins.splice(e,1)}}}d.Name="TAAJitter",(0,f.Y5)("BABYLON.TAAJitterMaterialPlugin",d);class h{get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e)for(let t of(this._isEnabled=e,this._materialPlugins))t._updateMaterial()}constructor(e){for(const t of(this._isEnabled=!0,this.jitter=new a.I9,this._materialPlugins=[],e.materials))this._getPlugin(t);(0,c.YC)(d.Name,e=>this._getPlugin(e))}dispose(){for(let e of((0,c.lM)(d.Name),this._materialPlugins.splice(0,this._materialPlugins.length)))e.manager=null}_getPlugin(e){let t=e.pluginManager?.getPlugin(d.Name);return t||(t=new d(e)),t.manager=this,t}}class p extends o.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,71353)))):t.push(Promise.resolve().then(i.bind(i,42622)))}set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}get disabled(){return this._disabled}set disabled(e){this._disabled!==e&&(this._disabled=e,this._taaMaterialManager&&(this._taaMaterialManager.isEnabled=!e&&this.reprojectHistory),this._reset())}get textureWidth(){return this._textureWidth}set textureWidth(e){this._textureWidth!==e&&(this._textureWidth=e,this._reset())}get textureHeight(){return this._textureHeight}set textureHeight(e){this._textureHeight!==e&&(this._textureHeight=e,this._reset())}get reprojectHistory(){return this._reprojectHistory}set reprojectHistory(e){this._reprojectHistory!==e&&(this._reprojectHistory=e,e&&(this._taaMaterialManager||(this._taaMaterialManager=new h(this._scene)),this._reset()),this._taaMaterialManager&&(this._taaMaterialManager.isEnabled=e&&!this._disabled),this._updateEffect())}get clampHistory(){return this._clampHistory}set clampHistory(e){this._clampHistory!==e&&(this._clampHistory=e,this._updateEffect())}constructor(e,t,i){super({...i,name:e,engine:t.getEngine(),useShaderStore:!0,useAsPostProcess:!0,fragmentShader:p.FragmentUrl,uniforms:p.Uniforms,samplers:p.Samplers}),this._samples=8,this.factor=.05,this._disabled=!1,this._textureWidth=0,this._textureHeight=0,this.disableOnCameraMove=!0,this._reprojectHistory=!1,this._clampHistory=!1,this._firstUpdate=!0,this._scene=t,this._hs=new n.w(this.samples)}_reset(){this._hs.setDimensions(this._textureWidth/2,this._textureHeight/2),this._hs.next(),this._firstUpdate=!0}_updateJitter(){this.reprojectHistory&&this._taaMaterialManager?this._nextJitterOffset(this._taaMaterialManager.jitter):this._updateProjectionMatrix()}_nextJitterOffset(e=new a.I9){return this.camera&&this.camera.hasMoved&&this.disableOnCameraMove||this._hs.next(),e.set(this._hs.x,this._hs.y),e}_updateProjectionMatrix(){if(!this.disabled){if(this.camera&&!this.camera.hasMoved)if(this.camera.mode===r.i.PERSPECTIVE_CAMERA){let e=this.camera.getProjectionMatrix();e.setRowFromFloats(2,this._hs.x,this._hs.y,e.m[10],e.m[11])}else{let e=this.camera.getProjectionMatrix(!0);e.setRowFromFloats(3,this._hs.x+e.m[12],this._hs.y+e.m[13],e.m[14],e.m[15])}this._hs.next()}}bind(e=!1){super.bind(e),this.disabled||(this._drawWrapper.effect.setFloat("factor",this.camera?.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1)}dispose(){this._taaMaterialManager?.dispose(),super.dispose()}_updateEffect(){let e=[],t=["textureSampler","historySampler"];this._reprojectHistory&&(e.push("#define TAA_REPROJECT_HISTORY"),t.push("velocitySampler")),this._clampHistory&&e.push("#define TAA_CLAMP_HISTORY"),this.updateEffect(e.join("\n"),null,t)}}p.FragmentUrl="taa",p.Uniforms=["factor"],p.Samplers=["historySampler"]},13977:function(e,t,i){i.d(t,{K:()=>l});var r=i(97782),n=i(88250),a=i(60109),o=i(94828),s=i(76937);class l{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}get remanence(){return this._remanence}set remanence(e){this._remanence=e}get reset(){return this._reset}set reset(e){this._reset=e}set isMoving(e){this._isMoving=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){let e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:+!!e,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,7339))):t.push(Promise.resolve().then(i.bind(i,95662)))}};this._debugPassPP=new n.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._accumulationParams=new r.IU(0,0,0,0),this.debugEnabled=!1,this.enabled=!0,this.onReadyObservable=new s.cP,this._debugPassName="Shadow Accumulation Debug Pass",this._remanence=.9,this._reset=!0,this._isMoving=!1,this._debugSizeParams=new r.IU(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e=this._engine.isWebGPU;this._outputTexture=new o.p("shadowAccumulationPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowAccumulation",this._scene,{type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,25293))]):await Promise.all([Promise.resolve().then(i.bind(i,20521))])}}),this._outputTexture.refreshRate=1,this._outputTexture.autoClear=!1,this._outputTexture.onGeneratedObservable.addOnce(()=>{this.onReadyObservable.notifyObservers()}),this._setOutputTextureBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)}),this._oldAccumulationCopy=new o.p("oldAccumulationRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,{type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,73368))]):await Promise.all([Promise.resolve().then(i.bind(i,99665))])}},!1),this._oldAccumulationCopy.autoClear=!1,this._oldAccumulationCopy.refreshRate=1,this._oldAccumulationCopy.onBeforeGenerationObservable.add(this._setAccumulationCopyBindings.bind(this)),this._setAccumulationCopyBindings(),this._oldPositionCopy=new o.p("oldLocalPositionRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,{type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,73368))]):await Promise.all([Promise.resolve().then(i.bind(i,99665))])}},!1),this._updatePositionCopy(),this._oldPositionCopy.autoClear=!1,this._oldPositionCopy.refreshRate=1,this._oldPositionCopy.onBeforeGenerationObservable.add(this._updatePositionCopy.bind(this))}_setOutputTextureBindings(){let e=this._isMoving?this.remanence:.99;this._accumulationParams.set(e,+!!this.reset,this._renderPipeline.voxelGridSize,0),this._outputTexture.setTexture("spatialBlurSampler",this._renderPipeline._getSpatialBlurTexture()),this._outputTexture.setVector4("accumulationParameters",this._accumulationParams),this._outputTexture.setTexture("oldAccumulationSampler",this._oldAccumulationCopy?this._oldAccumulationCopy:this._renderPipeline._dummyTexture2d),this._outputTexture.setTexture("prevPositionSampler",this._oldPositionCopy?this._oldPositionCopy:this._renderPipeline._dummyTexture2d);let t=this._scene.geometryBufferRenderer;if(!t)return!1;let i=t.getTextureIndex(a.I.VELOCITY_LINEAR_TEXTURE_TYPE);this._outputTexture.setTexture("motionSampler",t.getGBuffer().textures[i]);let r=t.getTextureIndex(a.I.POSITION_TEXTURE_TYPE);return this._outputTexture.setTexture("positionSampler",t.getGBuffer().textures[r]),this.reset=!1,this._isMoving=!1,!0}_updatePositionCopy(){let e=this._scene.geometryBufferRenderer,t=e.getTextureIndex(a.I.POSITION_TEXTURE_TYPE);this._oldPositionCopy.setTexture("textureSampler",e.getGBuffer().textures[t])}_setAccumulationCopyBindings(){this._oldAccumulationCopy.setTexture("textureSampler",this._outputTexture)}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setOutputTextureBindings()&&this._outputTexture.render()}resize(e=1){let t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};(this._outputTexture.getSize().width!==t.width||this._outputTexture.getSize().height!==t.height)&&(this._outputTexture.resize(t,!1),this._oldAccumulationCopy.resize(t,!1),this._oldPositionCopy.resize({width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},!1),this.reset=!0)}_disposeTextures(){this._oldAccumulationCopy.dispose(),this._oldPositionCopy.dispose(),this._outputTexture.dispose()}isReady(){return this._oldAccumulationCopy&&this._oldAccumulationCopy.isReady()&&this._oldPositionCopy&&this._oldPositionCopy.isReady()&&this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._disposeTextures(),this._debugPassPP&&this._debugPassPP.dispose(),this.onReadyObservable.clear()}}},86173:function(e,t,i){i.d(t,{d:()=>u});var r=i(69081),n=i(46319),a=i(92233),o=i(90875),s=i(1742),l=i(7979),c=i(38782);class f extends n.M{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=!1,this.COLORED_IBL_SHADOWS=!1}}class u extends a.y{get isColored(){return this._isColored}set isColored(e){this._isColored!==e&&(this._isColored=e,this._markAllSubMeshesAsTexturesDirty())}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,u.Name,310,new f),this.shadowOpacity=1,this._isEnabled=!1,this._isColored=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled,e.COLORED_IBL_SHADOWS=this.isColored}getClassName(){return"IBLShadowsPluginMaterial"}getUniforms(){return{ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:`#ifdef RENDER_WITH_IBL_SHADOWS
                    uniform vec2 renderTargetSize;
                    uniform float shadowOpacity;
                #endif`}}getSamplers(e){e.push("iblShadowsTexture")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity))}getCustomCode(e,t){let i;return 1===t?(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    var iblShadowsTextureSampler: sampler;
                    var iblShadowsTexture: texture_2d<f32>;

                    #ifdef COLORED_IBL_SHADOWS
                        fn computeIndirectShadow() -> vec3f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec3f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rgb;
                            return mix(shadowValue, vec3f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #else
                        fn computeIndirectShadow() -> vec2f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;
                            return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #endif
                #endif
            `},this._material instanceof o.d?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                finalIrradiance *= shadowValue;
                                finalRadianceScaled *= mix(vec3f(1.0), shadowValue, roughness);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                finalIrradiance *= vec3f(shadowValue.x);
                                finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:this._material instanceof c.OpenPBRMaterial?i.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                slab_diffuse_ibl *= shadowValue;
                                slab_glossy_ibl *= mix(vec3f(1.0), shadowValue, specularAlphaG);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                slab_diffuse_ibl *= vec3f(shadowValue.x);
                                slab_glossy_ibl *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG));
                            #endif
                        #endif
                    #else
                        slab_diffuse_ibl *= computeIndirectShadow().x;
                    #endif
                #endif
            `:i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        var shadowValue: vec3f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue, 1.0f));
                    #else
                        var shadowValue: vec2f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));
                    #endif
                #endif
            `):(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    uniform sampler2D iblShadowsTexture;
                #ifdef COLORED_IBL_SHADOWS
                    vec3 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec3 shadowValue = texture2D(iblShadowsTexture, uv).rgb;
                        return mix(shadowValue.rgb, vec3(1.0), 1.0 - shadowOpacity);
                    }
                #else
                    vec2 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;
                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);
                    }
                #endif
                #endif
            `},this._material instanceof o.d?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                finalIrradiance.rgb *= shadowValue.rgb;
                                finalRadianceScaled *= mix(vec3(1.0), shadowValue.rgb, roughness);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                finalIrradiance *= shadowValue.x;
                                finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:this._material instanceof c.OpenPBRMaterial?i.CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                slab_diffuse_ibl.rgb *= shadowValue.rgb;
                                slab_glossy_ibl *= mix(vec3(1.0), shadowValue.rgb, specularAlphaG);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                slab_diffuse_ibl *= shadowValue.x;
                                slab_glossy_ibl *= mix(pow(shadowValue.y, 4.0), shadowValue.x, specularAlphaG);
                            #endif
                        #endif
                    #else
                        slab_diffuse_ibl *= computeIndirectShadow().x;
                    #endif
                #endif
            `:i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        vec3 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.rgb);
                    #else
                        vec2 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.x);
                    #endif
                #endif
            `),"vertex"===e?null:i}}u.Name="IBLShadowsPluginMaterial",(0,r.Cg)([(0,s.lK)()],u.prototype,"shadowOpacity",void 0),(0,r.Cg)([(0,s.lK)(),(0,s.$z)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"isEnabled",void 0),(0,l.Y5)("BABYLON.IBLShadowsPluginMaterial",u)},93707:function(e,t,i){i.d(t,{y:()=>s});var r=i(97782),n=i(88250),a=i(60109),o=i(94828);class s{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScale(e){this._worldScale=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){let e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:+!!e,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,7339))):t.push(Promise.resolve().then(i.bind(i,95662)))}};this._debugPassPP=new n.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._worldScale=1,this._blurParameters=new r.IU(0,0,0,0),this.enabled=!0,this._debugPassName="Spatial Blur Debug Pass",this.debugEnabled=!1,this._debugSizeParams=new r.IU(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e=this._engine.isWebGPU;this._outputTexture=new o.p("spatialBlurPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowSpatialBlur",this._scene,{type:0,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,47145))]):await Promise.all([Promise.resolve().then(i.bind(i,13640))])}},!1,!1,0),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._setBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)})}_setBindings(){this._outputTexture.setTexture("voxelTracingSampler",this._renderPipeline._getVoxelTracingTexture()),this._blurParameters.set(1,this._worldScale,0,0),this._outputTexture.setVector4("blurParameters",this._blurParameters);let e=this._scene.geometryBufferRenderer;if(!e)return!1;let t=e.getTextureIndex(a.I.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",e.getGBuffer().textures[t]);let i=e.getTextureIndex(a.I.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",e.getGBuffer().textures[i]),!0}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings()&&this._outputTexture.render()}resize(e=1){let t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};(this._outputTexture.getSize().width!==t.width||this._outputTexture.getSize().height!==t.height)&&this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}},28896:function(e,t,i){i.d(t,{t:()=>m});var r=i(10363),n=i(95298),a=i(98193),o=i(40933),s=i(55322),l=i(97782),c=i(46538),f=i(57480),u=i(76937),d=i(88250),h=i(94828),p=i(3008);class m{getVoxelGrid(){return this._engine.isWebGPU?this._voxelGrid:this._triPlanarVoxelization?this._combinedVoxelGridPT:this._voxelGridZaxis}getDebugPassPP(){return this._voxelDebugPass||this._createDebugPass(),this._voxelDebugPass}get triPlanarVoxelization(){return this._triPlanarVoxelization}set triPlanarVoxelization(e){if(this._engine.isWebGPU){this._triPlanarVoxelization=!0;return}this._triPlanarVoxelization!==e&&(this._triPlanarVoxelization=e,this._disposeVoxelTextures(),this._createTextures())}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}isVoxelizationInProgress(){return this._voxelizationInProgress}get voxelResolutionExp(){return this._voxelResolutionExp}set voxelResolutionExp(e){this._voxelResolutionExp===e&&this._voxelGridZaxis||(this._voxelResolutionExp=Math.round(Math.min(Math.max(e,3),9)),this._voxelResolution=Math.pow(2,this._voxelResolutionExp),this._disposeVoxelTextures(),this._createTextures())}set voxelDebugAxis(e){this._voxelDebugAxis=e}get voxelDebugAxis(){return this._voxelDebugAxis}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}setDebugMipNumber(e){this._debugMipNumber=e}get debugPassName(){return this._debugPassName}get voxelDebugEnabled(){return this._voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelDebugEnabled!==e&&(this._voxelDebugEnabled=e,e&&(this._voxelSlabDebugRT=new o.$("voxelSlabDebug",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},this._scene,{generateDepthBuffer:!0,generateMipMaps:!1,type:0,format:5,samplingMode:1}),this._voxelSlabDebugRT.noPrePassRenderer=!0),this._voxelSlabDebugRT&&this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelDebugEnabled?(this._addRTsForRender([this._voxelSlabDebugRT],this._includedMeshes,this._voxelDebugAxis,1,!0),this._setDebugBindingsBound=this._setDebugBindings.bind(this),this._scene.onBeforeRenderObservable.add(this._setDebugBindingsBound)):this._scene.onBeforeRenderObservable.removeCallback(this._setDebugBindingsBound))}_createDebugPass(){let e=this._engine.isWebGPU;if(!this._voxelDebugPass){let t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams","mipNumber"],samplers:["voxelTexture","voxelSlabTexture"],engine:this._engine,reusable:!1,shaderLanguage:+!!e,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,5642))):t.push(Promise.resolve().then(i.bind(i,78761)))}};this._voxelDebugPass=new d.w(this.debugPassName,"iblVoxelGrid3dDebug",t),this._voxelDebugPass.onApplyObservable.add(e=>{0===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridXaxis):1===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridYaxis):2===this._voxelDebugAxis?e.setTexture("voxelTexture",this._voxelGridZaxis):e.setTexture("voxelTexture",this.getVoxelGrid()),e.setTexture("voxelSlabTexture",this._voxelSlabDebugRT),e.setVector4("sizeParams",this._debugSizeParams),e.setFloat("mipNumber",this._debugMipNumber)})}}constructor(e,t,r=6,n=!0){this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[],this._voxelClearColor=new s.ov(0,0,0,1),this.onVoxelizationCompleteObservable=new u.cP,this._renderTargets=[],this._triPlanarVoxelization=!0,this._voxelizationInProgress=!1,this._invWorldScaleMatrix=l.uq.Identity(),this._voxelResolution=64,this._voxelResolutionExp=6,this._mipArray=[],this._voxelDebugEnabled=!1,this._voxelDebugAxis=-1,this._debugSizeParams=new l.IU(0,0,0,0),this._includedMeshes=[],this._debugMipNumber=0,this._debugPassName="Voxelization Debug Pass",this._scene=e,this._engine=e.getEngine(),this._triPlanarVoxelization=this._engine.isWebGPU||n,this._engine.getCaps().drawBuffersExtension||f.V.Error("Can't do voxel rendering without the draw buffers extension.");const a=this._engine.isWebGPU;this._maxDrawBuffers=this._engine.getCaps().maxDrawBuffers||0,this._copyMipEffectRenderer=new p.J(this._engine),this._copyMipEffectWrapper=new p.$({engine:this._engine,fragmentShader:"copyTexture3DLayerToTexture",useShaderStore:!0,uniformNames:["layerNum"],samplerNames:["textureSampler"],shaderLanguage:+!!a,extraInitializationsAsync:async()=>{a?await Promise.resolve().then(i.bind(i,1067)):await Promise.resolve().then(i.bind(i,29975))}}),this.voxelResolutionExp=r}_generateMipMaps(){let e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._generateMipMap(t)}_generateMipMap(e){let t=this._mipArray[e-1];t&&(t.setTexture("srcMip",1===e?this.getVoxelGrid():this._mipArray[e-2]),t.render())}_copyMipMaps(){let e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._copyMipMap(t)}_copyMipMap(e){let t,i=this._mipArray[e-1];if(!i)return;let r=this.getVoxelGrid();if(t=r instanceof o.$&&r.renderTarget?r.renderTarget:r._rtWrapper){this._copyMipEffectRenderer.saveStates();let r=i.getSize().width;for(let n=0;n<r;n++)this._engine.bindFramebuffer(t,0,r,r,!0,e,n),this._copyMipEffectRenderer.applyEffectWrapper(this._copyMipEffectWrapper),this._copyMipEffectWrapper.effect.setTexture("textureSampler",i),this._copyMipEffectWrapper.effect.setInt("layerNum",n),this._copyMipEffectRenderer.draw(),this._engine.unBindFramebuffer(t,!0);this._copyMipEffectRenderer.restoreStates()}}_computeNumberOfSlabs(){return Math.ceil(this._voxelResolution/this._maxDrawBuffers)}_createTextures(){let e=this._engine.isWebGPU,t={width:this._voxelResolution,height:this._voxelResolution,depth:this._voxelResolution},r={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:5,samplingMode:1},n=this._computeNumberOfSlabs(),a={generateDepthBuffer:!1,generateMipMaps:!0,type:0,format:6,samplingMode:4,shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(i.bind(i,25062)):await Promise.resolve().then(i.bind(i,259))}};this._engine.isWebGPU?(this._voxelGrid=new o.$("voxelGrid",t,this._scene,{...a,format:5,creationFlags:1}),this._voxelGridRT=new o.$("voxelGridRT",{width:Math.min(2*t.width,2048),height:Math.min(2*t.height,2048)},this._scene,r)):this._triPlanarVoxelization?(this._voxelGridXaxis=new o.$("voxelGridXaxis",t,this._scene,r),this._voxelGridYaxis=new o.$("voxelGridYaxis",t,this._scene,r),this._voxelGridZaxis=new o.$("voxelGridZaxis",t,this._scene,r),this._voxelMrtsXaxis=this._createVoxelMRTs("x_axis_",this._voxelGridXaxis,n),this._voxelMrtsYaxis=this._createVoxelMRTs("y_axis_",this._voxelGridYaxis,n),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,n),this._combinedVoxelGridPT=new h.p("combinedVoxelGrid",t,"iblCombineVoxelGrids",this._scene,a,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._combinedVoxelGridPT),1),this._combinedVoxelGridPT.setFloat("layer",0),this._combinedVoxelGridPT.setTexture("voxelXaxisSampler",this._voxelGridXaxis),this._combinedVoxelGridPT.setTexture("voxelYaxisSampler",this._voxelGridYaxis),this._combinedVoxelGridPT.setTexture("voxelZaxisSampler",this._voxelGridZaxis),this._combinedVoxelGridPT.autoClear=!1,this._combinedVoxelGridPT.wrapU=c.g.CLAMP_ADDRESSMODE,this._combinedVoxelGridPT.wrapV=c.g.CLAMP_ADDRESSMODE):(this._voxelGridZaxis=new o.$("voxelGridZaxis",t,this._scene,a),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,n));let s={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1,shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(i.bind(i,32847)):await Promise.resolve().then(i.bind(i,28780))}};this._mipArray=Array(Math.ceil(Math.log2(this._voxelResolution)));for(let e=1;e<=this._mipArray.length;e++){let t=this._voxelResolution>>e,i={width:t,height:t,depth:t};this._mipArray[e-1]=new h.p("voxelMip"+e,i,"iblGenerateVoxelMip",this._scene,s,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._mipArray[e-1]),1);let r=this._mipArray[e-1];r.autoClear=!1,r.wrapU=c.g.CLAMP_ADDRESSMODE,r.wrapV=c.g.CLAMP_ADDRESSMODE,r.setTexture("srcMip",e>1?this._mipArray[e-2]:this.getVoxelGrid()),r.setInt("layerNum",0)}this._createVoxelMaterials()}_createVoxelMRTs(e,t,i){t.wrapU=c.g.CLAMP_ADDRESSMODE,t.wrapV=c.g.CLAMP_ADDRESSMODE,t.noPrePassRenderer=!0;let r=[],n=Array(this._maxDrawBuffers).fill(32879);for(let o=0;o<i;o++){let i=Array(this._maxDrawBuffers).fill(0);i=i.map((e,t)=>o*this._maxDrawBuffers+t);let l=Array(this._maxDrawBuffers).fill("");l=l.map((t,i)=>"voxel_grid_"+e+(o*this._maxDrawBuffers+i));let c=new a.H("mrt_"+e+o,{width:this._voxelResolution,height:this._voxelResolution,depth:this._voxelResolution},this._maxDrawBuffers,this._scene,{types:Array(this._maxDrawBuffers).fill(0),samplingModes:Array(this._maxDrawBuffers).fill(3),generateMipMaps:!1,targetTypes:n,formats:Array(this._maxDrawBuffers).fill(6),faceIndex:Array(this._maxDrawBuffers).fill(0),layerIndex:i,layerCounts:Array(this._maxDrawBuffers).fill(this._voxelResolution),generateDepthBuffer:!1,generateStencilBuffer:!1},l);c.clearColor=new s.ov(0,0,0,1),c.noPrePassRenderer=!0;for(let e=0;e<this._maxDrawBuffers;e++)c.setInternalTexture(t.getInternalTexture(),e);r.push(c)}return r}_disposeVoxelTextures(){this._stopVoxelization();for(let e=0;e<this._voxelMrtsZaxis.length;e++)this._triPlanarVoxelization&&(this._voxelMrtsXaxis[e].dispose(!0),this._voxelMrtsYaxis[e].dispose(!0)),this._voxelMrtsZaxis[e].dispose(!0);for(let e of(this._triPlanarVoxelization&&(this._voxelGridXaxis?.dispose(),this._voxelGridYaxis?.dispose(),this._combinedVoxelGridPT?.dispose()),this._voxelGridZaxis?.dispose(),this._mipArray))e.dispose();this._voxelMaterial?.dispose(),this._voxelSlabDebugMaterial?.dispose(),this._mipArray=[],this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[]}_createVoxelMaterials(){let e=this._engine.isWebGPU;this._voxelMaterial=new n.B("voxelization",this._scene,"iblVoxelGrid",{uniforms:["world","viewMatrix","invTransWorld","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,77802)),Promise.resolve().then(i.bind(i,33552))]):await Promise.all([Promise.resolve().then(i.bind(i,88783)),Promise.resolve().then(i.bind(i,7705))])}}),this._voxelMaterial.cullBackFaces=!1,this._voxelMaterial.backFaceCulling=!1,this._voxelMaterial.depthFunction=r.N.ALWAYS,this._voxelSlabDebugMaterial=new n.B("voxelSlabDebug",this._scene,"iblVoxelSlabDebug",{uniforms:["world","viewMatrix","cameraViewMatrix","projection","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:+!!e,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(i.bind(i,93018)),Promise.resolve().then(i.bind(i,32583))]):await Promise.all([Promise.resolve().then(i.bind(i,2702)),Promise.resolve().then(i.bind(i,22468))])}})}_setDebugBindings(){this._voxelSlabDebugMaterial.setMatrix("projection",this._scene.activeCamera.getProjectionMatrix()),this._voxelSlabDebugMaterial.setMatrix("cameraViewMatrix",this._scene.activeCamera.getViewMatrix())}isReady(){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){let i=this._mipArray[t].isReady();e&&(e=i)}return!!e&&!this._voxelizationInProgress}_stopVoxelization(){this._removeVoxelRTs(this._voxelMrtsXaxis),this._removeVoxelRTs(this._voxelMrtsYaxis),this._removeVoxelRTs(this._voxelMrtsZaxis),this._removeVoxelRTs([this._voxelGridRT])}_removeVoxelRTs(e){let t=this._renderTargets.findIndex(t=>t===e[0]);if(t>=0)this._renderTargets.splice(t,e.length);else{let t=this._scene.customRenderTargets.findIndex(t=>t===e[0]);t>=0&&this._scene.customRenderTargets.splice(t,e.length)}}updateVoxelGrid(e){this._stopVoxelization(),this._includedMeshes=e,this._voxelizationInProgress=!0,this._engine.isWebGPU?(this._voxelGridRT.renderList=e,this._addRTsForRender([this._voxelGridRT],e,0)):(this._triPlanarVoxelization&&(this._addRTsForRender(this._voxelMrtsXaxis,e,0),this._addRTsForRender(this._voxelMrtsYaxis,e,1)),this._addRTsForRender(this._voxelMrtsZaxis,e,2)),this._voxelDebugEnabled&&this._addRTsForRender([this._voxelSlabDebugRT],e,this._voxelDebugAxis,1,!0),this._renderVoxelGridBound=this._renderVoxelGrid.bind(this),this._scene.onAfterRenderObservable.add(this._renderVoxelGridBound)}_renderVoxelGrid(){if(this._voxelizationInProgress){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){let i=this._mipArray[t].isReady();e&&(e=i)}for(let t=0;t<this._renderTargets.length;t++){let i=this._renderTargets[t].isReadyForRendering();e&&(e=i)}if(e){if(this._engine.isWebGPU&&this._voxelGrid&&this._voxelGrid.renderTarget)for(let e=0;e<this._voxelResolution;e++)this._engine.bindFramebuffer(this._voxelGrid.renderTarget,0,void 0,void 0,!0,0,e),this._engine.clear(this._voxelClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._voxelGrid.renderTarget,!0);for(let e of this._renderTargets)e.render();this._stopVoxelization(),this._triPlanarVoxelization&&!this._engine.isWebGPU&&this._combinedVoxelGridPT.render(),this._generateMipMaps(),this._copyMipEffectWrapper.effect.whenCompiledAsync().then(()=>{this._copyMipMaps(),this._scene.onAfterRenderObservable.removeCallback(this._renderVoxelGridBound),this._voxelizationInProgress=!1,this.onVoxelizationCompleteObservable.notifyObservers()})}}}_addRTsForRender(e,t,i,r=0,n=!1){let a,o=1/this._computeNumberOfSlabs();a=0===r?this._voxelMaterial:this._voxelSlabDebugMaterial;for(let r=0;r<e.length;r++){let n=e[r];n.renderList=[];let s=r*o,c=(r+1)*o,f=o/this._maxDrawBuffers,u=new l.Pq(0,0,0),d=new l.Pq(0,0,1);0===i?d=new l.Pq(1,0,0):1===i&&(d=new l.Pq(0,1,0));let h=new l.Pq(0,1,0);if(1===i&&(h=new l.Pq(1,0,0)),n.onBeforeRenderObservable.add(()=>{a.setMatrix("viewMatrix",l.uq.LookAtLH(u,d,h)),a.setMatrix("invWorldScale",this._invWorldScaleMatrix),a.setFloat("nearPlane",s),a.setFloat("farPlane",c),a.setFloat("stepSize",f),this._engine.isWebGPU&&(this._voxelMaterial.useVertexPulling=!0,this._voxelMaterial.setTexture("voxel_storage",this.getVoxelGrid()))}),0===t.length)return;for(let e of t)if(e)for(let t of(e.subMeshes&&e.subMeshes.length>0&&(n.renderList?.push(e),n.setMaterialForRendering(e,a)),e.getChildMeshes()))t.subMeshes&&t.subMeshes.length>0&&(n.renderList?.push(t),n.setMaterialForRendering(t,a))}if(n)for(let t of e)-1===this._scene.customRenderTargets.indexOf(t)&&this._scene.customRenderTargets.push(t);else this._renderTargets=this._renderTargets.concat(e)}resize(){this._voxelSlabDebugRT?.resize({width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight()})}dispose(){this._disposeVoxelTextures(),this._voxelSlabDebugRT&&(this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelSlabDebugRT.dispose()),this._voxelDebugPass&&this._voxelDebugPass.dispose()}}},87324:function(e,t,i){i.d(t,{R:()=>l});var r=i(97782),n=i(88250),a=i(60109),o=i(94828),s=i(57480);class l{get voxelShadowOpacity(){return this._voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelShadowOpacity=e}get ssShadowOpacity(){return this._ssShadowOpacity}set ssShadowOpacity(e){this._ssShadowOpacity=e}get sssSamples(){return this._sssSamples}set sssSamples(e){this._sssSamples=e}get sssStride(){return this._sssStride}set sssStride(e){this._sssStride=e}get sssMaxDist(){return this._sssMaxDist}set sssMaxDist(e){this._sssMaxDist=e}get sssThickness(){return this._sssThickness}set sssThickness(e){this._sssThickness=e}get voxelNormalBias(){return this._voxelNormalBias}set voxelNormalBias(e){this._voxelNormalBias=e}get voxelDirectionBias(){return this._voxelDirectionBias}set voxelDirectionBias(e){this._voxelDirectionBias=e}get sampleDirections(){return this._sampleDirections}set sampleDirections(e){this._sampleDirections=e}get envRotation(){return this._envRotation}set envRotation(e){this._envRotation=e}getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}set coloredShadows(e){this._coloredShadows=e}get coloredShadows(){return this._coloredShadows}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){let e=this._engine.isWebGPU;if(!this._debugPassPP){let t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!0,shaderLanguage:+!!e,extraInitializations:(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,7339))):t.push(Promise.resolve().then(i.bind(i,95662)))}};this._debugPassPP=new n.w(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(e=>{e.setTexture("debugSampler",this._outputTexture),e.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._voxelShadowOpacity=1,this._sssSamples=16,this._sssStride=8,this._sssMaxDist=.05,this._sssThickness=.5,this._ssShadowOpacity=1,this._cameraInvView=r.uq.Identity(),this._cameraInvProj=r.uq.Identity(),this._invWorldScaleMatrix=r.uq.Identity(),this._frameId=0,this._sampleDirections=4,this._shadowParameters=new r.IU(0,0,0,0),this._sssParameters=new r.IU(0,0,0,0),this._opacityParameters=new r.IU(0,0,0,0),this._voxelBiasParameters=new r.IU(0,0,0,0),this._voxelNormalBias=1.4,this._voxelDirectionBias=1.75,this.enabled=!0,this.debugEnabled=!1,this._debugPassName="Voxel Tracing Debug Pass",this._envRotation=0,this._coloredShadows=!1,this._debugVoxelMarchEnabled=!1,this._debugSizeParams=new r.IU(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e=this._createDefines(),t=this._engine.isWebGPU;this._outputTexture=new o.p("voxelTracingPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowVoxelTracing",this._scene,{type:0,format:5,samplingMode:1,generateDepthBuffer:!1,shaderLanguage:+!!t,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(i.bind(i,99050))]):await Promise.all([Promise.resolve().then(i.bind(i,21913))])}}),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.defines=e,this._setBindings(this._scene.activeCamera),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)})}_createDefines(){let e="";return this._scene.useRightHandedSystem&&(e+="#define RIGHT_HANDED\n"),this._debugVoxelMarchEnabled&&(e+="#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u\n"),this._coloredShadows&&(e+="#define COLOR_SHADOWS 1u\n"),e}_setBindings(e){this._outputTexture.defines=this._createDefines(),this._outputTexture.setMatrix("viewMtx",e.getViewMatrix()),this._outputTexture.setMatrix("projMtx",e.getProjectionMatrix()),e.getProjectionMatrix().invertToRef(this._cameraInvProj),e.getViewMatrix().invertToRef(this._cameraInvView),this._outputTexture.setMatrix("invProjMtx",this._cameraInvProj),this._outputTexture.setMatrix("invViewMtx",this._cameraInvView),this._outputTexture.setMatrix("wsNormalizationMtx",this._invWorldScaleMatrix),this._frameId++;let t=0;this._scene.environmentTexture&&(t=this._scene.environmentTexture.rotationY??0),t=(this._scene.useRightHandedSystem?-(t+.5*Math.PI):t-.5*Math.PI)%(2*Math.PI),this._shadowParameters.set(this._sampleDirections,this._frameId,1,t),this._outputTexture.setVector4("shadowParameters",this._shadowParameters);let i=this._renderPipeline._getVoxelGridTexture(),r=Math.floor(Math.log2(i.getSize().width));this._voxelBiasParameters.set(this._voxelNormalBias,this._voxelDirectionBias,r,0),this._outputTexture.setVector4("voxelBiasParameters",this._voxelBiasParameters),this._sssParameters.set(this._sssSamples,this._sssStride,this._sssMaxDist,this._sssThickness),this._outputTexture.setVector4("sssParameters",this._sssParameters),this._opacityParameters.set(this._voxelShadowOpacity,this._ssShadowOpacity,0,0),this._outputTexture.setVector4("shadowOpacity",this._opacityParameters),this._outputTexture.setTexture("voxelGridSampler",i),this._outputTexture.setTexture("blueNoiseSampler",this._renderPipeline._getNoiseTexture());let n=this._scene.iblCdfGenerator;if(!n)return s.V.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because iblCdfGenerator is not enabled."),!1;this._outputTexture.setTexture("icdfSampler",n.getIcdfTexture()),this._coloredShadows&&this._scene.environmentTexture&&this._outputTexture.setTexture("iblSampler",this._scene.environmentTexture);let o=this._scene.geometryBufferRenderer;if(!o)return s.V.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because GeometryBufferRenderer is not enabled."),!1;let l=o.getTextureIndex(a.I.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",o.getGBuffer().textures[l]);let c=o.getTextureIndex(a.I.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",o.getGBuffer().textures[c]),!0}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings(this._scene.activeCamera)&&this._outputTexture.render()}resize(e=1){let t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};(this._outputTexture.getSize().width!==t.width||this._outputTexture.getSize().height!==t.height)&&this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())&&this._scene.iblCdfGenerator&&this._scene.iblCdfGenerator.getIcdfTexture().isReady()&&this._renderPipeline._getVoxelGridTexture().isReady()}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}},77476:function(e,t,i){i.d(t,{b:()=>I});var r=i(38241),n=i(44043),a=i(96700),o=i(97782),s=i(80042),l=i(89270),c=i(37619),f=i(15335),u=i(95298),d=i(55322),h=i(76937),p=i(33909),m=i(98714),_=i(19754),g=i(62355),v=i(57480);Object.defineProperty(r.Z.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(e){this._forceShowBoundingBoxes=e,e&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0}),r.Z.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new I(this)),this._boundingBoxRenderer},Object.defineProperty(a.u.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(e){this._showBoundingBox=e,e&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});let S=o.uq.Identity(),E=new o.Pq,T=new o.Pq,A=S.asArray(),x=new c.I(E,E);class I{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=l.v.NAME_BOUNDINGBOXRENDERER,this.frontColor=new d.v9(1,1,1),this.backColor=new d.v9(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new h.cP,this.onAfterBoxRenderingObservable=new h.cP,this.onResourcesReadyObservable=new h.cP,this.enabled=!0,this._shaderLanguage=0,this.renderList=new s.L(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this._matrixBuffer=null,this._matrices=null,this._useInstances=!1,this._drawWrapperFront=null,this._drawWrapperBack=null,this.scene=e,this.scene.getEngine().isWebGPU&&(this._shaderLanguage=1),e._addComponent(this),this._uniformBufferFront=new m.D(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!0),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new m.D(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!0),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(l.v.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(l.v.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(l.v.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(l.v.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}async whenReadyAsync(e=16,t=3e4){return this._prepareResources(),await new Promise(i=>{(0,g.B)(()=>this._colorShader.isReady(),()=>{i()},(e,t)=>{t?(v.V.Error("BoundingBoxRenderer: Timeout while waiting for the renderer to be ready."),e&&v.V.Error(e)):(v.V.Error("BoundingBoxRenderer: An unexpected error occurred while waiting for the renderer to be ready."),e&&(v.V.Error(e),e.stack&&v.V.Error(e.stack)))},e,t)})}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){let i=t.getBoundingInfo();null!=i&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){let t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new u.B("colorShader",this.scene,"boundingBoxRenderer",{attributes:[n.R.PositionKind,"world0","world1","world2","world3"],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,98647)),Promise.resolve().then(i.bind(i,58909))]):await Promise.all([Promise.resolve().then(i.bind(i,98256)),Promise.resolve().then(i.bind(i,18218))])}},!1),this._colorShader.setDefine("INSTANCES",this._useInstances),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new u.B("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[n.R.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,98647)),Promise.resolve().then(i.bind(i,58909))]):await Promise.all([Promise.resolve().then(i.bind(i,98256)),Promise.resolve().then(i.bind(i,18218))])}},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};let e=this.scene.getEngine(),t=(0,_.KA)({size:1});this._vertexBuffers[n.R.PositionKind]=new n.R(e,t.positions,n.R.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){let e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){let e=this._vertexBuffers[n.R.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this._matrixBuffer&&this._matrixBuffer._rebuild()}reset(){this.renderList.reset()}render(e){if(0===this.renderList.length||!this.enabled)return;if(this._useInstances)return void this._renderInstanced(e);if(this._prepareResources(),!this._colorShader.isReady())return;let t=this.scene.getEngine();t.setDepthWrite(!1);let i=this.scene.getTransformMatrix();for(let r=0;r<this.renderList.length;r++){let n=this.renderList.data[r];if(n._tag!==e)continue;this._createWrappersForBoundingBox(n),this.onBeforeBoxRenderingObservable.notifyObservers(n);let a=n.minimum,s=n.maximum.subtract(a),l=a.add(s.scale(.5)),c=o.uq.Scaling(s.x,s.y,s.z).multiply(o.uq.Translation(l.x,l.y,l.z)).multiply(n.getWorldMatrix()),u=t.useReverseDepthBuffer;if(this.showBackLines){let e=n._drawWrapperBack??this._colorShader._getDrawWrapper();this._colorShader._preBind(e),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?t.setDepthFunctionToLessOrEqual():t.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(e.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",c),this._uniformBufferBack.updateMatrix("viewProjection",i),this._uniformBufferBack.update(),t.drawElementsType(f.i.LineListDrawMode,0,24)}let d=n._drawWrapperFront??this._colorShader._getDrawWrapper();this._colorShader._preBind(d),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",c),this._uniformBufferFront.updateMatrix("viewProjection",i),this._uniformBufferFront.update(),t.drawElementsType(f.i.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(n)}this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){let t=this.scene.getEngine();e._drawWrapperFront=new p.E(t),e._drawWrapperBack=new p.E(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){let t=this.scene.getEngine();void 0===this._renderPassIdForOcclusionQuery&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));let i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();let r=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,r)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));let n=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);let a=e.getBoundingInfo().boundingBox,s=a.minimum,l=a.maximum.subtract(s),c=s.add(l.scale(.5)),u=o.uq.Scaling(l.x,l.y,l.z).multiply(o.uq.Translation(c.x,c.y,c.z)).multiply(a.getWorldMatrix()),d=r._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),n?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(f.i.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}set useInstances(e){this._useInstances=e,this._colorShader&&this._colorShader.setDefine("INSTANCES",e),e||this._cleanupInstances()}get useInstances(){return this._useInstances}_renderInstanced(e){if(0===this.renderList.length||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;let t=this._colorShader,i=this._matrices,r=16*this.renderList.length;(!i||i.length<r||i.length>2*r)&&(i=new Float32Array(r),this._matrices=i),this.onBeforeBoxRenderingObservable.notifyObservers(x);let n=0,a=this.scene.floatingOriginOffset;for(let t=0;t<this.renderList.length;t++){let r=this.renderList.data[t];if(r._tag!==e)continue;let o=r.minimum,s=r.maximum.subtractToRef(o,T),l=o.addToRef(s.scaleToRef(.5,E),E);A[0]=s._x,A[3]=l._x,A[5]=s._y,A[7]=l._y,A[10]=s._z,A[11]=l._z;let c=16*n;S.multiplyToArray(r.getWorldMatrix(),i,c),i[c+12]-=a.x,i[c+13]-=a.y,i[c+14]-=a.z,n++}let o=this.scene.getEngine(),s=o.getDepthFunction()??515,l=o.getDepthWrite();o.setDepthWrite(!1);let c=this._matrixBuffer;c?.isUpdatable()&&c.getData()===i?c.update(i):this._createInstanceBuffer(i),this._createWrappersForBoundingBox(this);let u=o.useReverseDepthBuffer,d=this.scene.getTransformMatrix();if(this.showBackLines){let e=this._drawWrapperBack??t._getDrawWrapper();t._preBind(e),o.bindBuffers(this._vertexBuffers,this._indexBuffer,t.getEffect()),u?o.setDepthFunctionToLessOrEqual():o.setDepthFunctionToGreaterOrEqual();let i=this._uniformBufferBack;i.bindToEffect(e.effect,"BoundingBoxRenderer"),i.updateColor4("color",this.backColor,1),i.updateMatrix("viewProjection",d),i.update(),o.drawElementsType(f.i.LineListDrawMode,0,24,n)}let h=t._getDrawWrapper();t._preBind(h),o.bindBuffers(this._vertexBuffers,this._indexBuffer,t.getEffect()),u?o.setDepthFunctionToGreater():o.setDepthFunctionToLess();let p=this._uniformBufferFront;p.bindToEffect(h.effect,"BoundingBoxRenderer"),p.updateColor4("color",this.frontColor,1),p.updateMatrix("viewProjection",d),p.update(),o.drawElementsType(f.i.LineListDrawMode,0,24,n),this.onAfterBoxRenderingObservable.notifyObservers(x),t.unbind(),o.setDepthFunction(s),o.setDepthWrite(l)}_createInstanceBuffer(e){let t=this._vertexBuffers;this._cleanupInstanceBuffer();let i=new n.h(this.scene.getEngine(),e,!0,16,!1,!0);t.world0=i.createVertexBuffer("world0",0,4),t.world1=i.createVertexBuffer("world1",4,4),t.world2=i.createVertexBuffer("world2",8,4),t.world3=i.createVertexBuffer("world3",12,4),this._matrixBuffer=i}_cleanupInstanceBuffer(){let e=this._vertexBuffers;e.world0&&(e.world0.dispose(),delete e.world0),e.world1&&(e.world1.dispose(),delete e.world1),e.world2&&(e.world2.dispose(),delete e.world2),e.world3&&(e.world3.dispose(),delete e.world3),this._matrices=null,this._matrixBuffer&&(this._matrixBuffer.dispose(),this._matrixBuffer=null)}_cleanupInstances(){this._cleanupInstanceBuffer(),this._drawWrapperFront&&(this._drawWrapperFront.dispose(),this._drawWrapperFront=null),this._drawWrapperBack&&(this._drawWrapperBack.dispose(),this._drawWrapperBack=null)}dispose(){if(void 0!==this._renderPassIdForOcclusionQuery&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();let e=this._vertexBuffers[n.R.PositionKind];e&&(e.dispose(),this._vertexBuffers[n.R.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null),this._cleanupInstances()}}},47651:function(e,t,i){i.d(t,{E:()=>o});var r=i(38241),n=i(66040),a=i(89270);r.Z.prototype.enableDepthRenderer=function(e,t=!1,i=!1,r=3,a=!1,o){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){let s=!!this.getEngine().getCaps().textureFloatRender,l=0;l=!this.getEngine().getCaps().textureHalfFloatRender||i&&s?+!!s:2,this._depthRenderer[e.id]=new n.d(this,l,e,t,r,a,void 0,o)}return this._depthRenderer[e.id]},r.Z.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class o{constructor(e){this.name=a.v.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(a.v.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(a.v.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(let e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(let t in this.scene._depthRenderer){let i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(let t in this.scene._depthRenderer){let i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}n.d._SceneComponentInitialization=e=>{let t=e._getComponent(a.v.NAME_DEPTHRENDERER);t||(t=new o(e),e._addComponent(t))}},50663:function(e,t,i){i.d(t,{o:()=>p,s:()=>h});var r=i(44043),n=i(96700),a=i(64793),o=i(97782),s=i(15335),l=i(95298),c=i(45119),f=i(80042),u=i(33909);n.u.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},n.u.prototype.enableEdgesRendering=function(e=.95,t=!1,i){return this.disableEdgesRendering(),this._edgesRenderer=new h(this,e,t,!0,i),this},Object.defineProperty(n.u.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),a.l.prototype.enableEdgesRendering=function(e=.95,t=!1){return this.disableEdgesRendering(),this._edgesRenderer=new p(this,e,t),this},a.Q.prototype.enableEdgesRendering=function(e=.95,t=!1){return a.l.prototype.enableEdgesRendering.apply(this,arguments),this};class d{constructor(){this.edges=[],this.edgesConnectedCount=0}}class h{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e,t){if(!e._edgeRenderLineShader){let r=new l.B("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"],uniformBuffers:["Scene","Mesh"],shaderLanguage:t,extraInitializationsAsync:async()=>{1===t?await Promise.all([Promise.resolve().then(i.bind(i,30027)),Promise.resolve().then(i.bind(i,50529))]):await Promise.all([Promise.resolve().then(i.bind(i,56685)),Promise.resolve().then(i.bind(i,54700))])}},!1);r.disableDepthWrite=!0,r.backFaceCulling=!1,r.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=r,e.onDisposeObservable.add(()=>{e._edgeRenderLineShader.dispose(),e._edgeRenderLineShader=null})}return e._edgeRenderLineShader}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=.95,i=!1,r=!0,n){this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=[],this._linesNormals=[],this._linesIndices=[],this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new f.L(32),this._shaderLanguage=0,this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=n??null,this._epsilon=t;const a=this._source.getScene().getEngine();a.isWebGPU&&(this._drawWrapper=new u.E(a),this._shaderLanguage=1),this._prepareResources(),r&&(n?.useAlternateEdgeFinder??!0?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareResources(){this._lineShader||(this._lineShader=h._GetShader(this._source.getScene(),this._shaderLanguage))}_rebuild(){let e=this._buffers[r.R.PositionKind];e&&e._rebuild(),(e=this._buffers[r.R.NormalKind])&&e._rebuild();let t=this._source.getScene().getEngine();this._ib=t.createIndexBuffer(this._linesIndices)}dispose(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let e=this._buffers[r.R.PositionKind];e&&(e.dispose(),this._buffers[r.R.PositionKind]=null),(e=this._buffers[r.R.NormalKind])&&(e.dispose(),this._buffers[r.R.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._drawWrapper?.dispose()}_processEdgeForAdjacencies(e,t,i,r,n){return e===i&&t===r||e===r&&t===i?0:e===r&&t===n||e===n&&t===r?1:e===n&&t===i||e===i&&t===n?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,n){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(n,1e-10)||e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(r,1e-10)?1:e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(n,1e-10)?2:-1}_checkEdge(e,t,i,r,n){(void 0===t||o.Pq.Dot(i[e],i[t])<this._epsilon)&&this.createLine(r,n,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){let n=(e,t,i)=>{i>=0&&t.push(i);for(let i=0;i<e.length;++i)t.push(e[i][0])},a=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?a=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(a=2);for(let t=0;t<3;++t)t===a?e[t].sort((e,t)=>e[1]<t[1]?-1:+(e[1]>t[1])):e[t].sort((e,t)=>e[1]>t[1]?-1:+(e[1]<t[1]));let o=[],s=[];n(e[a],o,-1);let l=o.length;for(let o=a+2;o>=a+1;--o)n(e[o%3],s,o!==a+2?r[i[t+(o+1)%3]]:-1);let c=s.length;i.push(r[i[t+a]],o[0],s[0]),i.push(r[i[t+(a+1)%3]],s[c-1],o[l-1]);let f=l<=c,u=f?l:c,d=f?c:l,h=f?l-1:c-1,p=+!f,m=l+c-2,_=0,g=0,v=f?o:s,S=f?s:o,E=0;for(;m-- >0;){let e;p?i.push(v[_],S[g]):i.push(S[g],v[_]),(E+=u)>=d&&_<h?(e=v[++_],E-=d):e=S[++g],i.push(e)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){let e=this._source.getVerticesData(r.R.PositionKind),t=this._source.getIndices();if(!t||!e)return;Array.isArray(t)||(t=Array.from(t));let i=this._options?.useFastVertexMerger??!0,n=i?Math.round(-Math.log(this._options?.epsilonVertexMerge??1e-6)/Math.log(10)):this._options?.epsilonVertexMerge??1e-6,a=[],s=[];if(i){let t={};for(let i=0;i<e.length;i+=3){let r=e[i+0],o=e[i+1],l=e[i+2],c=r.toFixed(n)+"|"+o.toFixed(n)+"|"+l.toFixed(n);if(void 0!==t[c])a.push(t[c]);else{let e=i/3;t[c]=e,a.push(e),s.push(e)}}}else for(let t=0;t<e.length;t+=3){let i=e[t+0],r=e[t+1],o=e[t+2],l=!1;for(let s=0;s<t&&!l;s+=3){let t=e[s+0],c=e[s+1],f=e[s+2];if(Math.abs(i-t)<n&&Math.abs(r-c)<n&&Math.abs(o-f)<n){a.push(s/3),l=!0;break}}l||(a.push(t/3),s.push(t/3))}if(this._options?.applyTessellation){let i=this._options?.epsilonVertexAligned??1e-6,r=[];for(let n=0;n<t.length;n+=3){let o;for(let l=0;l<3;++l){let c=a[t[n+l]],f=a[t[n+(l+1)%3]],u=a[t[n+(l+2)%3]];if(c===f)continue;let d=e[3*c+0],h=e[3*c+1],p=e[3*c+2],m=e[3*f+0],_=e[3*f+1],g=e[3*f+2],v=Math.sqrt((m-d)*(m-d)+(_-h)*(_-h)+(g-p)*(g-p));for(let t=0;t<s.length-1;t++){let a=s[t];if(a===c||a===f||a===u)continue;let S=e[3*a+0],E=e[3*a+1],T=e[3*a+2],A=Math.sqrt((S-d)*(S-d)+(E-h)*(E-h)+(T-p)*(T-p));Math.abs(A+Math.sqrt((S-m)*(S-m)+(E-_)*(E-_)+(T-g)*(T-g))-v)<i&&(o||(o={index:n,edgesPoints:[[],[],[]]},r.push(o)),o.edgesPoints[l].push([a,A]))}}}for(let e=0;e<r.length;++e){let i=r[e];this._tessellateTriangle(i.edgesPoints,i.index,t,a)}r.length=0}let l={};for(let i=0;i<t.length;i+=3){let r;for(let n=0;n<3;++n){let s=a[t[i+n]],c=a[t[i+(n+1)%3]],f=a[t[i+(n+2)%3]];if(s===c||(s===f||c===f)&&this._options?.removeDegeneratedTriangles)continue;if(o.AA.Vector3["0"].copyFromFloats(e[3*s+0],e[3*s+1],e[3*s+2]),o.AA.Vector3["1"].copyFromFloats(e[3*c+0],e[3*c+1],e[3*c+2]),o.AA.Vector3["2"].copyFromFloats(e[3*f+0],e[3*f+1],e[3*f+2]),r||(o.AA.Vector3["1"].subtractToRef(o.AA.Vector3["0"],o.AA.Vector3["3"]),o.AA.Vector3["2"].subtractToRef(o.AA.Vector3["1"],o.AA.Vector3["4"]),(r=o.Pq.Cross(o.AA.Vector3["3"],o.AA.Vector3["4"])).normalize()),s>c){let e=s;s=c,c=e}let u=s+"_"+c,d=l[u];d?d.done||(o.Pq.Dot(r,d.normal)<this._epsilon&&this.createLine(o.AA.Vector3["0"],o.AA.Vector3["1"],this._linesPositions.length/3),d.done=!0):l[u]={normal:r,done:!1,index:i,i:n}}}for(let i in l){let r=l[i];if(!r.done){let i=a[t[r.index+r.i]],n=a[t[r.index+(r.i+1)%3]];o.AA.Vector3["0"].copyFromFloats(e[3*i+0],e[3*i+1],e[3*i+2]),o.AA.Vector3["1"].copyFromFloats(e[3*n+0],e[3*n+1],e[3*n+2]),this.createLine(o.AA.Vector3["0"],o.AA.Vector3["1"],this._linesPositions.length/3)}}let c=this._source.getScene().getEngine();this._buffers[r.R.PositionKind]=new r.R(c,this._linesPositions,r.R.PositionKind,!1),this._buffers[r.R.NormalKind]=new r.R(c,this._linesNormals,r.R.NormalKind,!1,!1,4),this._buffersForInstances[r.R.PositionKind]=this._buffers[r.R.PositionKind],this._buffersForInstances[r.R.NormalKind]=this._buffers[r.R.NormalKind],this._ib=c.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){let e,t,i=this._source.getVerticesData(r.R.PositionKind),n=this._source.getIndices();if(!n||!i)return;let a=[],s=[];for(e=0;e<n.length;e+=3){t=new d;let r=n[e],l=n[e+1],c=n[e+2];t.p0=new o.Pq(i[3*r],i[3*r+1],i[3*r+2]),t.p1=new o.Pq(i[3*l],i[3*l+1],i[3*l+2]),t.p2=new o.Pq(i[3*c],i[3*c+1],i[3*c+2]);let f=o.Pq.Cross(t.p1.subtract(t.p0),t.p2.subtract(t.p1));f.normalize(),s.push(f),a.push(t)}for(e=0;e<a.length;e++){t=a[e];for(let i=e+1;i<a.length;i++){let r=a[i];if(3===t.edgesConnectedCount)break;if(3===r.edgesConnectedCount)continue;let o=n[3*i],s=n[3*i+1],l=n[3*i+2];for(let a=0;a<3;a++){let c=0;if(void 0===t.edges[a]){switch(a){case 0:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(t.p0,t.p1,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(n[3*e],n[3*e+1],o,s,l);break;case 1:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(t.p1,t.p2,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(n[3*e+1],n[3*e+2],o,s,l);break;case 2:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(t.p2,t.p0,r.p0,r.p1,r.p2):this._processEdgeForAdjacencies(n[3*e+2],n[3*e],o,s,l)}if(-1!==c&&(t.edges[a]=i,r.edges[c]=e,t.edgesConnectedCount++,r.edgesConnectedCount++,3===t.edgesConnectedCount))break}}}}for(e=0;e<a.length;e++){let t=a[e];this._checkEdge(e,t.edges[0],s,t.p0,t.p1),this._checkEdge(e,t.edges[1],s,t.p1,t.p2),this._checkEdge(e,t.edges[2],s,t.p2,t.p0)}let l=this._source.getScene().getEngine();this._buffers[r.R.PositionKind]=new r.R(l,this._linesPositions,r.R.PositionKind,!1),this._buffers[r.R.NormalKind]=new r.R(l,this._linesNormals,r.R.NormalKind,!1,!1,4),this._buffersForInstances[r.R.PositionKind]=this._buffers[r.R.PositionKind],this._buffersForInstances[r.R.NormalKind]=this._buffers[r.R.NormalKind],this._ib=l.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){let e=this._source.getScene(),t=e.floatingOriginOffset,i=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera)return void this._lineShader._setDrawWrapper(i);let r=this._source.hasInstances&&this.customInstances.length>0,n=r||this._source.hasThinInstances,a=0;if(n)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),r){let e=this._source._getInstanceDataStorage(),i=this._source._instanceDataStorage.isFrozen;if(a=this.customInstances.length,!e.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!i){let i=0;for(let r=0;r<a;++r)this.customInstances.data[r].copyToArray(e.instancesData,i),e.instancesData[i+12]-=t.x,e.instancesData[i+13]-=t.y,e.instancesData[i+14]-=t.z,i+=16;e.instancesBuffer.updateDirectly(e.instancesData,0,a)}}else a=this._source.thinInstanceCount;let o=e.getEngine();this._lineShader._preBind(),1!==this._source.edgesColor.a?o.setAlphaMode(2):o.setAlphaMode(0),o.bindBuffers(n?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===c.i.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",o.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix(),this._source),o.drawElementsType(s.i.TriangleFillMode,0,this._indicesCount,a),this._lineShader.unbind(),n&&o.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(i)}}class p extends h{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){let e=this._source.getVerticesData(r.R.PositionKind),t=this._source.getIndices();if(!t||!e)return;let i=o.AA.Vector3["0"],n=o.AA.Vector3["1"],a=t.length-1;for(let r=0,s=0;r<a;r+=2,s+=4)o.Pq.FromArrayToRef(e,3*t[r],i),o.Pq.FromArrayToRef(e,3*t[r+1],n),this.createLine(i,n,s);let s=this._source.getScene().getEngine();this._buffers[r.R.PositionKind]=new r.R(s,this._linesPositions,r.R.PositionKind,!1),this._buffers[r.R.NormalKind]=new r.R(s,this._linesNormals,r.R.NormalKind,!1,!1,4),this._ib=s.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}},58945:function(e,t,i){i.d(t,{W:()=>n});var r=i(65148);class n{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,n=1){this._engine=e,this._copyTextureToTexture=new r.b(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:n,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"}),this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil").label=`FluidDepthTextureCopy${t}x${i}x${n}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}},53586:function(e,t,i){i.d(t,{p:()=>o});var r=i(38241),n=i(89270),a=i(60109);Object.defineProperty(r.Z.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),r.Z.prototype.enableGeometryBufferRenderer=function(e=1,t=15,i){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new a.I(this,e,t,i),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},r.Z.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class o{constructor(e){this.name=n.v.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(n.v.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}a.I._SceneComponentInitialization=e=>{let t=e._getComponent(n.v.NAME_GEOMETRYBUFFERRENDERER);t||(t=new o(e),e._addComponent(t))}},86484:function(e,t,i){i.d(t,{Z:()=>o});var r=i(38241),n=i(89270),a=i(1679);Object.defineProperty(r.Z.prototype,"iblCdfGenerator",{get:function(){return this._iblCdfGenerator},set:function(e){e&&(this._iblCdfGenerator=e)},enumerable:!0,configurable:!0}),r.Z.prototype.enableIblCdfGenerator=function(){return this._iblCdfGenerator?this._iblCdfGenerator:(this._iblCdfGenerator=new a.O(this),this._iblCdfGenerator.isSupported)?(this.environmentTexture&&(this._iblCdfGenerator.iblSource=this.environmentTexture),this._iblCdfGenerator):(this._iblCdfGenerator=null,null)},r.Z.prototype.disableIblCdfGenerator=function(){this._iblCdfGenerator&&(this._iblCdfGenerator.dispose(),this._iblCdfGenerator=null)};class o{constructor(e){this.name=n.v.NAME_IBLCDFGENERATOR,this._newIblObserver=null,this.scene=e}register(){this._updateIblSource(),this._newIblObserver=this.scene.onEnvironmentTextureChangedObservable.add(this._updateIblSource.bind(this))}rebuild(){}dispose(){this.scene.onEnvironmentTextureChangedObservable.remove(this._newIblObserver)}_updateIblSource(){this.scene.iblCdfGenerator&&this.scene.environmentTexture&&(this.scene.iblCdfGenerator.iblSource=this.scene.environmentTexture)}}a.O._SceneComponentInitialization=e=>{let t=e._getComponent(n.v.NAME_IBLCDFGENERATOR);t||(t=new o(e),e._addComponent(t))}},9577:function(e,t,i){i.d(t,{c:()=>r});class r{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}},77588:function(e,t,i){i.d(t,{P:()=>r});class r{constructor(e=!1){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3],this.texturesRequired.push(e?10:5)}}},7780:function(e,t,i){i.d(t,{N:()=>r});class r{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}},93418:function(e,t,i){i.d(t,{r:()=>r});class r{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}},69599:function(e,t,i){i.d(t,{i:()=>A});var r=i(57480),n=i(55322),a=i(46538),o=i(88250);i(82386);var s=i(68415);i(34450);let l="fibonacci",c=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
vec2 Golden2dSeq(int i,float n)
{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}
vec2 SampleDiskGolden(int i,int sampleCount)
{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}`;s.l.IncludesShadersStore[l]||(s.l.IncludesShadersStore[l]=c),i(10119);let f="diffusionProfile";s.l.IncludesShadersStore[f]||(s.l.IncludesShadersStore[f]="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];");let u="subSurfaceScatteringPixelShader",d=`#include<helperFunctions>
#include<fibonacci>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp((8.*PI)))*expSum; }
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp(((4.*u)*((c*c)+(4.*u)*(4.*u))));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; 
float xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))
{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=texture2D(depthSampler,vUV).r;}
if (!passedStencilTest) { 
gl_FragColor=inputColor;return;}
float distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;
#endif
float phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);}
totalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}`;s.l.ShadersStore[u]||(s.l.ShadersStore[u]=d),i(14591),i(99245),i(29969);let h="fibonacci",p=`fn rcp(x: f32)->f32
{return 1./x;}
const GOLDEN_RATIO=1.618033988749895;fn Golden2dSeq(i: u32,n: f32)->vec2f
{return vec2f(f32(i)/n+(0.5/n),fract(f32(i)*rcp(GOLDEN_RATIO)));}
fn SampleDiskGolden(i: u32,sampleCount: u32)->vec2f
{let f=Golden2dSeq(i,f32(sampleCount));return vec2f(sqrt(f.x),TWO_PI*f.y);}
`;s.l.IncludesShadersStoreWGSL[h]||(s.l.IncludesShadersStoreWGSL[h]=p),i(76672);let m="diffusionProfile",_=`uniform diffusionS: array<vec3f,5>;uniform diffusionD: array<f32,5>;uniform filterRadii: array<f32,5>;
`;s.l.IncludesShadersStoreWGSL[m]||(s.l.IncludesShadersStoreWGSL[m]=_);let g="subSurfaceScatteringPixelShader",v=`#include<helperFunctions>
#include<fibonacci>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vUV: vec2f;uniform texelSize: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;uniform viewportSize: vec2f;uniform metersPerUnit: f32;const LOG2_E=1.4426950408889634;const SSS_PIXELS_PER_SAMPLE=4.;const _SssSampleBudget=40u;
#define SSS_BILATERAL_FILTER true
fn EvalBurleyDiffusionProfile(r: f32,S: vec3f)->vec3f
{let exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
let expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; }
fn SampleBurleyDiffusionProfile(u_: f32,rcpS: f32)->vec2f
{let u=1.-u_; 
let g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));let n=exp2(log2(g)*(-1.0/3.0)); 
let p=(g*n)*n; 
let c=1.+p+n; 
let d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
let x=(3./LOG2_E)*log2(c)-d; 
let rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));let r=x*rcpS;let rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2f(r,rcpPdf);}
fn ComputeBilateralWeight(xy2: f32,z_: f32,mmPerUnit: f32,S: vec3f,rcpPdf: f32)->vec3f
{
#ifndef SSS_BILATERAL_FILTER
let z=0.;
#else
let z=z_;
#endif
let r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));let area=rcpPdf;
#ifdef SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,vec3f(0.0),vec3f(1.0));
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
fn EvaluateSample(i: u32,n: u32,S: vec3f,d: f32,centerPosVS: vec3f,mmPerUnit: f32,pixelsPerMm: f32,
phase: f32,totalIrradiance: ptr<function,vec3f>,totalWeight: ptr<function,vec3f>)
{let scale =rcp(f32(n));let offset=rcp(f32(n))*0.5;let sinPhase=sin(phase);let cosPhase=cos(phase);let bdp=SampleBurleyDiffusionProfile(f32(i)*scale+offset,d);let r=bdp.x;let rcpPdf=bdp.y;let phi=SampleDiskGolden(i,n).y;let sinPhi=sin(phi);let cosPhi=cos(phi);let sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
let cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
let vec=r*vec2f(cosPsi,sinPsi);let position=fragmentInputs.vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*uniforms.texelSize;let xy2 =r*r;let textureRead=textureSampleLevel(irradianceSampler,irradianceSamplerSampler,position,0.);let viewZ=textureSampleLevel(depthSampler,depthSamplerSampler,position,0.).r;let irradiance =textureRead.rgb;if (testLightingForSSS(textureRead.a))
{let relZ=viewZ-centerPosVS.z;let weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);*totalIrradiance+=weight*irradiance;*totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let irradianceAndDiffusionProfile =textureSampleLevel(irradianceSampler,irradianceSamplerSampler,fragmentInputs.vUV,0.);let centerIrradiance=irradianceAndDiffusionProfile.rgb;let diffusionProfileIndex=u32(round(irradianceAndDiffusionProfile.a*255.));var centerDepth =0.;let inputColor=textureSampleLevel(textureSampler,textureSamplerSampler,fragmentInputs.vUV,0.);let passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=textureSampleLevel(depthSampler,depthSamplerSampler,fragmentInputs.vUV,0.).r;}
if (!passedStencilTest) { 
fragmentOutputs.color=inputColor;return fragmentOutputs;}
let distScale =1.;let S =uniforms.diffusionS[diffusionProfileIndex];let d =uniforms.diffusionD[diffusionProfileIndex];let filterRadius=uniforms.filterRadii[diffusionProfileIndex];let centerPosNDC=fragmentInputs.vUV;let cornerPosNDC=fragmentInputs.vUV+0.5*uniforms.texelSize;let centerPosVS =vec3f(centerPosNDC*uniforms.viewportSize,1.0)*centerDepth; 
let cornerPosVS =vec3f(cornerPosNDC*uniforms.viewportSize,1.0)*centerDepth; 
let mmPerUnit =1000.*(uniforms.metersPerUnit*rcp(distScale));let unitsPerMm=rcp(mmPerUnit);let unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);let pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;let filterArea =PI*square(filterRadius*pixelsPerMm);let sampleCount =u32(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));let sampleBudget=_SssSampleBudget;let albedo =textureSampleLevel(albedoSampler,albedoSamplerSampler,fragmentInputs.vUV,0.).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
let green=vec3f(0.,1.,0.);fragmentOutputs.color=vec4f(green,1.0);return fragmentOutputs;
#endif
fragmentOutputs.color=vec4f(inputColor.rgb+albedo*centerIrradiance,1.0);return fragmentOutputs;}
#ifdef DEBUG_SSS_SAMPLES
let red =vec3f(1.,0.,0.);let blue=vec3f(0.,0.,1.);fragmentOutputs.color=vec4f(mix(blue,red,clamp(f32(sampleCount)/f32(sampleBudget),0.0,1.0)),1.0);return fragmentOutputs;
#endif
let phase=0.;let n=min(sampleCount,sampleBudget);var totalIrradiance=vec3f(0.);var totalWeight =vec3f(0.);for (var i=0u; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,&totalIrradiance,&totalWeight);}
totalWeight=max(totalWeight,vec3f(HALF_MIN));fragmentOutputs.color=vec4f(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3f(0.0)),1.);}
`;s.l.ShadersStoreWGSL[g]||(s.l.ShadersStoreWGSL[g]=v),i(91432);class S extends o.w{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,n=null,o,s,l,c=0){super(e,"subSurfaceScattering",{...{uniforms:["texelSize","viewportSize","metersPerUnit"],samplers:["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],size:"number"==typeof i?i:void 0,camera:n,samplingMode:o,engine:s,reusable:l,textureType:c,...i,blockCompilation:!0},samplingMode:o||a.g.BILINEAR_SAMPLINGMODE}),this._scene=t,this.updateEffect(),this.onApplyObservable.add(e=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration)return void r.V.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");let i=this.texelSize;e.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),e.setFloat2("texelSize",i.x,i.y),e.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),e.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),e.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),e.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),e.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),e.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),e.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}var E=i(89270),T=i(74550);class A{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=E.v.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.clearColor=new n.ov(0,0,0,1),this.addDiffusionProfile(new n.v9(1,1,1)),this._scene=e,A._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return r.V.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[3*t]===e.r&&this._ssDiffusionS[3*t+1]===e.g&&this._ssDiffusionS[3*t+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new S("subSurfaceScattering",this._scene,{size:1,engine:this._scene.getEngine(),shaderLanguage:+!!this._scene.getEngine().isWebGPU}),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){let t=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,t)}_sampleBurleyDiffusionProfile(e,t){let i=1+4*(e=1-e)*(2*e+Math.sqrt(1+4*e*e)),r=Math.pow(i,-1/3);return 3*Math.log((1+i*r*r+r)/(4*e))*t}}A._SceneComponentInitialization=e=>{throw(0,T.n)("SubSurfaceSceneComponent")}},8471:function(e,t,i){var r=i(68415);let n="backgroundFragmentDeclaration",a=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},23919:function(e,t,i){var r=i(68415);i(44243);let n="backgroundUboDeclaration",a=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform mat4 diffuseMatrix;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;};
#include<sceneUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},6973:function(e,t,i){var r=i(68415);let n="backgroundVertexDeclaration",a=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},50421:function(e,t,i){var r=i(68415);let n="boundingBoxRendererFragmentDeclaration",a=`uniform vec4 color;
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},60777:function(e,t,i){var r=i(68415);let n="boundingBoxRendererUboDeclaration",a=`#ifdef WEBGL2
uniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},42987:function(e,t,i){var r=i(68415);let n="boundingBoxRendererVertexDeclaration",a=`uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},20003:function(e,t,i){i.r(t),i.d(t,{bumpFragment:()=>o});var r=i(68415);let n="bumpFragment",a=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},98846:function(e,t,i){i.r(t),i.d(t,{bumpFragmentFunctions:()=>o});var r=i(68415);i(23355);let n="bumpFragmentFunctions",a=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},38181:function(e,t,i){i.r(t),i.d(t,{bumpFragmentMainFunctions:()=>o});var r=i(68415);let n="bumpFragmentMainFunctions",a=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},87805:function(e,t,i){var r=i(68415);let n="bumpVertex",a=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},3106:function(e,t,i){var r=i(68415);let n="bumpVertexDeclaration",a=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},84959:function(e,t,i){var r=i(68415);let n="clusteredLightingFunctions",a=`struct ClusteredLight {vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;vec4 vLightDirection;vec4 vLightFalloff;};
#define inline
ClusteredLight getClusteredLight(sampler2D lightDataTexture,int index) {return ClusteredLight(
texelFetch(lightDataTexture,ivec2(0,index),0),
texelFetch(lightDataTexture,ivec2(1,index),0),
texelFetch(lightDataTexture,ivec2(2,index),0),
texelFetch(lightDataTexture,ivec2(3,index),0),
texelFetch(lightDataTexture,ivec2(4,index),0)
);}
int getClusteredSliceIndex(vec2 sliceData,float viewDepth) {return int(log(viewDepth)*sliceData.x+sliceData.y);}
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},71734:function(e,t,i){var r=i(68415);let n="decalFragment",a=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},80960:function(e,t,i){var r=i(68415);let n="decalFragmentDeclaration",a=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},66378:function(e,t,i){var r=i(68415);let n="decalVertexDeclaration",a=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},17590:function(e,t,i){var r=i(68415);i(44243),i(58950);let n="defaultUboDeclaration",a=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionPosition;vec3 vReflectionSize;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},84380:function(e,t,i){var r=i(68415);let n="depthPrePass",a=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},93911:function(e,t,i){var r=i(68415);let n="fogFragment",a=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},27115:function(e,t,i){i.r(t),i.d(t,{fogFragmentDeclaration:()=>o});var r=i(68415);let n="fogFragmentDeclaration",a=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},77553:function(e,t,i){var r=i(68415);let n="fogVertex",a=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},6769:function(e,t,i){var r=i(68415);let n="fogVertexDeclaration",a=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},40604:function(e,t,i){var r=i(68415);let n="fresnelFunction",a=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},28790:function(e,t,i){var r=i(68415);let n="gaussianSplatting",a=`#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)
mat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],
matrix[0][1],matrix[1][1],matrix[2][1],
matrix[0][2],matrix[1][2],matrix[2][2]);}
#endif
vec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}
#if SH_DEGREE>0
ivec2 getDataUVint(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return ivec2(uint(x+0.5),uint(y+0.5));}
#endif
struct Splat {vec4 center;vec4 color;vec4 covA;vec4 covB;
#if SH_DEGREE>0
uvec4 sh0; 
#endif
#if SH_DEGREE>1
uvec4 sh1;
#endif
#if SH_DEGREE>2
uvec4 sh2;
#endif
};float getSplatIndex(int localIndex)
{float splatIndex;switch (localIndex)
{case 0: splatIndex=splatIndex0.x; break;case 1: splatIndex=splatIndex0.y; break;case 2: splatIndex=splatIndex0.z; break;case 3: splatIndex=splatIndex0.w; break;case 4: splatIndex=splatIndex1.x; break;case 5: splatIndex=splatIndex1.y; break;case 6: splatIndex=splatIndex1.z; break;case 7: splatIndex=splatIndex1.w; break;case 8: splatIndex=splatIndex2.x; break;case 9: splatIndex=splatIndex2.y; break;case 10: splatIndex=splatIndex2.z; break;case 11: splatIndex=splatIndex2.w; break;case 12: splatIndex=splatIndex3.x; break;case 13: splatIndex=splatIndex3.y; break;case 14: splatIndex=splatIndex3.z; break;case 15: splatIndex=splatIndex3.w; break;}
return splatIndex;}
Splat readSplat(float splatIndex)
{Splat splat;vec2 splatUV=getDataUV(splatIndex,dataTextureSize);splat.center=texture2D(centersTexture,splatUV);splat.color=texture2D(colorsTexture,splatUV);splat.covA=texture2D(covariancesATexture,splatUV)*splat.center.w;splat.covB=texture2D(covariancesBTexture,splatUV)*splat.center.w;
#if SH_DEGREE>0
ivec2 splatUVint=getDataUVint(splatIndex,dataTextureSize);splat.sh0=texelFetch(shTexture0,splatUVint,0);
#endif
#if SH_DEGREE>1
splat.sh1=texelFetch(shTexture1,splatUVint,0);
#endif
#if SH_DEGREE>2
splat.sh2=texelFetch(shTexture2,splatUVint,0);
#endif
return splat;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
vec3 computeColorFromSHDegree(vec3 dir,const vec3 sh[16])
{const float SH_C0=0.28209479;const float SH_C1=0.48860251;float SH_C2[5];SH_C2[0]=1.092548430;SH_C2[1]=-1.09254843;SH_C2[2]=0.315391565;SH_C2[3]=-1.09254843;SH_C2[4]=0.546274215;float SH_C3[7];SH_C3[0]=-0.59004358;SH_C3[1]=2.890611442;SH_C3[2]=-0.45704579;SH_C3[3]=0.373176332;SH_C3[4]=-0.45704579;SH_C3[5]=1.445305721;SH_C3[6]=-0.59004358;vec3 result=/*SH_C0**/sh[0];
#if SH_DEGREE>0
float x=dir.x;float y=dir.y;float z=dir.z;result+=- SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];
#if SH_DEGREE>1
float xx=x*x,yy=y*y,zz=z*z;float xy=x*y,yz=y*z,xz=x*z;result+=
SH_C2[0]*xy*sh[4] +
SH_C2[1]*yz*sh[5] +
SH_C2[2]*(2.0*zz-xx-yy)*sh[6] +
SH_C2[3]*xz*sh[7] +
SH_C2[4]*(xx-yy)*sh[8];
#if SH_DEGREE>2
result+=
SH_C3[0]*y*(3.0*xx-yy)*sh[9] +
SH_C3[1]*xy*z*sh[10] +
SH_C3[2]*y*(4.0*zz-xx-yy)*sh[11] +
SH_C3[3]*z*(2.0*zz-3.0*xx-3.0*yy)*sh[12] +
SH_C3[4]*x*(4.0*zz-xx-yy)*sh[13] +
SH_C3[5]*z*(xx-yy)*sh[14] +
SH_C3[6]*x*(xx-3.0*yy)*sh[15];
#endif
#endif
#endif
return result;}
vec4 decompose(uint value)
{vec4 components=vec4(
float((value ) & 255u),
float((value>>uint( 8)) & 255u),
float((value>>uint(16)) & 255u),
float((value>>uint(24)) & 255u));return components*vec4(2./255.)-vec4(1.);}
vec3 computeSH(Splat splat,vec3 dir)
{vec3 sh[16];sh[0]=vec3(0.,0.,0.);
#if SH_DEGREE>0
vec4 sh00=decompose(splat.sh0.x);vec4 sh01=decompose(splat.sh0.y);vec4 sh02=decompose(splat.sh0.z);sh[1]=vec3(sh00.x,sh00.y,sh00.z);sh[2]=vec3(sh00.w,sh01.x,sh01.y);sh[3]=vec3(sh01.z,sh01.w,sh02.x);
#endif
#if SH_DEGREE>1
vec4 sh03=decompose(splat.sh0.w);vec4 sh04=decompose(splat.sh1.x);vec4 sh05=decompose(splat.sh1.y);sh[4]=vec3(sh02.y,sh02.z,sh02.w);sh[5]=vec3(sh03.x,sh03.y,sh03.z);sh[6]=vec3(sh03.w,sh04.x,sh04.y);sh[7]=vec3(sh04.z,sh04.w,sh05.x);sh[8]=vec3(sh05.y,sh05.z,sh05.w);
#endif
#if SH_DEGREE>2
vec4 sh06=decompose(splat.sh1.z);vec4 sh07=decompose(splat.sh1.w);vec4 sh08=decompose(splat.sh2.x);vec4 sh09=decompose(splat.sh2.y);vec4 sh10=decompose(splat.sh2.z);vec4 sh11=decompose(splat.sh2.w);sh[9]=vec3(sh06.x,sh06.y,sh06.z);sh[10]=vec3(sh06.w,sh07.x,sh07.y);sh[11]=vec3(sh07.z,sh07.w,sh08.x);sh[12]=vec3(sh08.y,sh08.z,sh08.w);sh[13]=vec3(sh09.x,sh09.y,sh09.z);sh[14]=vec3(sh09.w,sh10.x,sh10.y);sh[15]=vec3(sh10.z,sh10.w,sh11.x); 
#endif
return computeColorFromSHDegree(dir,sh);}
#else
vec3 computeSH(Splat splat,vec3 dir)
{return vec3(0.,0.,0.);}
#endif
vec4 gaussianSplatting(vec2 meshPos,vec3 worldPos,vec2 scale,vec3 covA,vec3 covB,mat4 worldMatrix,mat4 viewMatrix,mat4 projectionMatrix)
{mat4 modelView=viewMatrix*worldMatrix;vec4 camspace=viewMatrix*vec4(worldPos,1.);vec4 pos2d=projectionMatrix*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds
|| pos2d.y<-bounds || pos2d.y>bounds) {return vec4(0.0,0.0,2.0,1.0);}
mat3 Vrk=mat3(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);bool isOrtho=abs(projectionMatrix[3][3]-1.0)<0.001;mat3 J;if (isOrtho) {J=mat3(
focal.x,0.,0.,
0.,focal.y,0.,
0.,0.,0.
);} else {J=mat3(
focal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.,0.,0.
);}
mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;
#if COMPENSATION
float c00=cov2d[0][0];float c11=cov2d[1][1];float c01=cov2d[0][1];float detOrig=c00*c11-c01*c01;
#endif
cov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;
#if COMPENSATION
vec3 c2d=vec3(cov2d[0][0],c01,cov2d[1][1]);float detBlur=c2d.x*c2d.z-c2d.y*c2d.y;float compensation=sqrt(max(0.,detOrig/detBlur));vColor.w*=compensation;
#endif
float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float epsilon=0.0001;float lambda1=mid+radius+epsilon,lambda2=mid-radius+epsilon;if (lambda2<0.0)
{return vec4(0.0,0.0,2.0,1.0);}
vec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vec2 vCenter=vec2(pos2d);float scaleFactor=isOrtho ? 1.0 : pos2d.w;return vec4(
vCenter 
+ ((meshPos.x*majorAxis
+ meshPos.y*minorAxis)*invViewport*scaleFactor)*scale,pos2d.zw);}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},96590:function(e,t,i){var r=i(68415);i(44243),i(58950);let n="gaussianSplattingUboDeclaration",a=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute vec3 position;attribute vec4 splatIndex0;attribute vec4 splatIndex1;attribute vec4 splatIndex2;attribute vec4 splatIndex3;
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},25554:function(e,t,i){i.d(t,{Q:()=>o});var r=i(68415);let n="gaussianSplattingVertexDeclaration",a="attribute vec3 position;attribute vec4 splatIndex0;attribute vec4 splatIndex1;attribute vec4 splatIndex2;attribute vec4 splatIndex3;uniform mat4 view;uniform mat4 projection;uniform mat4 world;uniform vec4 vEyePosition;";r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},41963:function(e,t,i){var r=i(68415);i(44243);let n="geometryUboDeclaration",a=`#include<sceneUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},977:function(e,t,i){var r=i(68415);let n="geometryVertexDeclaration";r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]="uniform mat4 viewProjection;uniform mat4 view;")},32270:function(e,t,i){var r=i(68415);let n="harmonicsFunctions",a=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},69342:function(e,t,i){var r=i(68415);let n="hdrFilteringFunctions",a=`#if NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.*PI;float phi=uvRange.y*PI;float sinPhi=sin(phi);N.x=cos(theta)*sinPhi;N.z=sin(theta)*sinPhi;N.y=cos(phi);return N;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(
#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT
CUSTOM_IRRADIANCE_FILTERING_INPUT
#else
samplerCube inputTexture,
#endif
vec3 inputN,vec2 filteringInfo,
float diffuseRoughness,
vec3 surfaceAlbedo,
vec3 inputV
#if IBL_CDF_FILTERING
,sampler2D icdfSampler
#endif
)
{vec3 n=normalize(inputN);vec3 result=vec3(0.);
#ifndef IBL_CDF_FILTERING
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);mat3 tbnInverse=mat3(tangent.x,bitangent.x,n.x,tangent.y,bitangent.y,n.y,tangent.z,bitangent.z,n.z);
#endif
float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);
#if IBL_CDF_FILTERING
vec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));float NoL=dot(n,Ls);float NoV=dot(n,inputV);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,inputV);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(inputV+Ls)*0.5;float VoH=dot(inputV,H);
#endif
#else
vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);float NoL=Ls.z; 
vec3 V=tbnInverse*inputV;float NoV=V.z; 
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,V);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(V+Ls)*0.5;float VoH=dot(V,H);
#endif
#endif
if (NoL>0.) {
#if IBL_CDF_FILTERING
float pdf=texture2D(icdfSampler,T).z;vec3 c=textureCubeLodEXT(inputTexture,Ls,0.).rgb;
#else
float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.,maxLevel);
#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION
CUSTOM_IRRADIANCE_FILTERING_FUNCTION
#else
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#endif
#endif
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
#if IBL_CDF_FILTERING
vec3 light=pdf<1e-6 ? vec3(0.0) : vec3(1.0)/vec3(pdf)*c;result+=NoL*diffuseRoughnessTerm*light;
#else
result+=c*diffuseRoughnessTerm;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
result=result/clampedAlbedo;
#endif
return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#ifdef ANISOTROPIC
#define inline
vec3 radianceAnisotropic(
float alphaTangent, 
float alphaBitangent, 
samplerCube inputTexture,
vec3 inputView, 
vec3 inputTangent, 
vec3 inputBitangent, 
vec3 inputNormal, 
vec2 filteringInfo,
vec2 noiseInput 
)
{vec3 V=inputView;vec3 N=inputNormal;vec3 T=inputTangent;vec3 B=inputBitangent;vec3 R=reflect(-V,N);if (alphaTangent==0. && alphaBitangent==0.) {vec3 c=textureCube(inputTexture,R).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;}
vec3 result=vec3(0.);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float effectiveDim=dim0*sqrt(alphaTangent*alphaBitangent);float omegaP=(4.*PI)/(6.*effectiveDim*effectiveDim);const float noiseScale=clamp(log2(float(NUM_SAMPLES))/12.0f,0.0f,1.0f);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);Xi=fract(Xi+noiseInput*mix(0.5f,0.015f,noiseScale)); 
vec3 H_tangent=hemisphereImportanceSampleDggxAnisotropic(Xi,alphaTangent,alphaBitangent);vec3 H=normalize(H_tangent.x*T+H_tangent.y*B+H_tangent.z*N);vec3 L=normalize(2.0*dot(V,H)*H-V);float NoH=max(dot(N,H),0.001);float VoH=max(dot(V,H),0.001);float NoL=max(dot(N,L),0.001);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_BurleyGGX_Anisotropic(
H_tangent.z,H_tangent.x,H_tangent.y,vec2(alphaTangent,alphaBitangent)
);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}
#endif
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},34450:function(e,t,i){i.r(t),i.d(t,{helperFunctions:()=>o});var r=i(68415);let n="helperFunctions",a=`const float PI=3.1415926535897932384626433832795;const float TWO_PI=6.283185307179586;const float HALF_PI=1.5707963267948966;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float RECIPROCAL_PI4=0.07957747154594767;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return saturate(dot(color,LuminanceEncodeApprox));}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =saturate(floor(D)/255.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(saturate(rgb),D);}
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*TWO_PI-PI;float latitude=HALF_PI-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
float sqrtClamped(float value) {return sqrt(max(value,0.));}
float avg(vec3 value) {return dot(value,vec3(0.333333333));}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE) 
uint extractBits(uint value,int offset,int width) {return (value>>offset) & ((1u<<width)-1u);}
int onlyBitPosition(uint value) {return (floatBitsToInt(float(value))>>23)-0x7f;}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},70481:function(e,t,i){var r=i(68415);let n="imageProcessingCompatibility",a=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},62097:function(e,t,i){i.r(t),i.d(t,{imageProcessingDeclaration:()=>o});var r=i(68415);let n="imageProcessingDeclaration",a=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},9704:function(e,t,i){i.r(t),i.d(t,{imageProcessingFunctions:()=>o});var r=i(68415);let n="imageProcessingFunctions",a=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#if TONEMAPPING==3
const float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}
#endif
#if TONEMAPPING==2
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
result.rgb=PBRNeutralToneMapping(result.rgb);
#elif TONEMAPPING==2
result.rgb=ACESFitted(result.rgb);
#elif TONEMAPPING==1
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
result.rgb=max(result.rgb,0.);
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},7620:function(e,t,i){var r=i(68415);let n="importanceSampling",a=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggxAnisotropic(vec2 Xi,float alphaTangent,float alphaBitangent)
{alphaTangent=max(alphaTangent,0.0001);alphaBitangent=max(alphaBitangent,0.0001);float phi=atan(alphaBitangent/alphaTangent*tan(2.0*3.14159265*Xi.x));if (Xi.x>0.5) phi+=3.14159265; 
float cosPhi=cos(phi);float sinPhi=sin(phi);float alpha2=(cosPhi*cosPhi)/(alphaTangent*alphaTangent) +
(sinPhi*sinPhi)/(alphaBitangent*alphaBitangent);float tanTheta2=Xi.y/(1.0-Xi.y)/alpha2;float cosTheta=1.0/sqrt(1.0+tanTheta2);float sinTheta=sqrt(max(0.0,1.0-cosTheta*cosTheta));return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},42225:function(e,t,i){var r=i(68415);let n="intersectionFunctions",a=`float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
vec2 sphereIntersect(vec3 ro,vec3 rd,vec3 ce,float ra) {vec3 oc=ro-ce;float b=dot(oc,rd);float c=dot(oc,oc)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}
vec2 sphereIntersectFromOrigin(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},98911:function(e,t,i){var r=i(68415);let n="kernelBlurFragment",a=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},34217:function(e,t,i){var r=i(68415);let n="kernelBlurFragment2",a=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},34643:function(e,t,i){var r=i(68415);let n="kernelBlurVaryingDeclaration";r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]="varying vec2 sampleCoord{X};")},54185:function(e,t,i){var r=i(68415);let n="kernelBlurVertex";r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};")},66515:function(e,t,i){i.r(t),i.d(t,{lightFragment:()=>o});var r=i(68415);let n="lightFragment",a=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
vec4 diffuse{X}=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#if defined(PBR) && defined(CLUSTLIGHT{X}) && defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
{int sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(
lightDataTexture{X},
tileMaskTexture{X},
light{X}.vLightData,
ivec2(light{X}.vSliceRanges[sliceIndex]),
viewDirectionW,
normalW,
vPositionW,
surfaceAlbedo,
reflectivityOut
#ifdef IRIDESCENCE
,iridescenceIntensity
#endif
#ifdef SS_TRANSLUCENCY
,subSurfaceOut
#endif
#ifdef SPECULARTERM
,AARoughnessFactors.x
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef SHEEN
,sheenOut
#endif
#ifdef CLEARCOAT
,clearcoatOut
#endif
);}
#elif defined(PBR)
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
preInfo.diffuseRoughness=diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission=vec3(0.0);
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
info.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);
#elif defined(SS_TRANSLUCENCY)
#ifndef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance); 
#else
info.diffuse=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#if AREALIGHT{X}
info.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#else
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
{vec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);}
#else
coloredFresnel=fresnelSchlickGGX(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
{float NdotH=dot(normalW,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);}
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,coloredFresnel,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#endif
#ifndef AREALIGHT{X}
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
#ifdef IESLIGHTTEXTURE{X}
info=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X});
#else
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
info=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.rgb,light{X}.vLightHeight.rgb,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,
#ifdef AREALIGHTNOROUGHTNESS
0.5
#else
vReflectionInfos.y
#endif
);
#elif defined(CLUSTLIGHT{X}) && CLUSTLIGHT_BATCH>0
{int sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(lightDataTexture{X},tileMaskTexture{X},viewDirectionW,normalW,light{X}.vLightData,ivec2(light{X}.vSliceRanges[sliceIndex]),glossiness);}
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++)
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SS_TRANSLUCENCY
diffuseTransmissionBase+=info.diffuseTransmission*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},91055:function(e,t,i){i.r(t),i.d(t,{lightFragmentDeclaration:()=>o});var r=i(68415);let n="lightFragmentDeclaration",a=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef AREALIGHT{X}
uniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};
#endif
#ifdef IESLIGHTTEXTURE{X}
uniform sampler2D iesLightTexture{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef CLUSTLIGHT{X}
uniform vec2 vSliceData{X};uniform vec2 vSliceRanges{X}[CLUSTLIGHT_SLICES];uniform sampler2D lightDataTexture{X};uniform highp sampler2D tileMaskTexture{X};
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},35239:function(e,t,i){i.r(t),i.d(t,{lightUboDeclaration:()=>o});var r=i(68415);let n="lightUboDeclaration",a=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#elif defined(CLUSTLIGHT{X})
vec2 vSliceData;vec2 vSliceRanges[CLUSTLIGHT_SLICES];
#endif
#if defined(AREALIGHT{X})
vec4 vLightWidth;vec4 vLightHeight;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef IESLIGHTTEXTURE{X}
uniform sampler2D iesLightTexture{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef CLUSTLIGHT{X}
uniform sampler2D lightDataTexture{X};uniform highp sampler2D tileMaskTexture{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},19541:function(e,t,i){i.r(t),i.d(t,{lightVxFragmentDeclaration:()=>o});var r=i(68415);let n="lightVxFragmentDeclaration",a=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#if defined(AREALIGHT{X})
uniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},56393:function(e,t,i){i.r(t),i.d(t,{lightVxUboDeclaration:()=>o});var r=i(68415);let n="lightVxUboDeclaration",a=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#elif defined(CLUSTLIGHT{X})
vec2 vSliceData;vec2 vSliceRanges[CLUSTLIGHT_SLICES];
#endif
#if defined(AREALIGHT{X})
vec4 vLightWidth;vec4 vLightHeight;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},22649:function(e,t,i){i.r(t),i.d(t,{lightsFragmentFunctions:()=>o});var r=i(68415);i(9709),i(84959);let n="lightsFragmentFunctions",a=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
float getAttenuation(float cosAngle,float exponent) {return max(0.,pow(cosAngle,exponent));}
float getIESAttenuation(float cosAngle,sampler2D iesLightSampler) {float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
lightingInfo basicSpotLighting(vec3 viewDirectionW,vec3 lightVectorW,vec3 vNormal,float attenuation,vec3 diffuseColor,vec3 specularColor,float glossiness) {lightingInfo result; 
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeIESSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness,sampler2D iesLightSampler) { 
vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float dotProduct=dot(lightDirection.xyz,-lightVectorW);float cosAngle=max(0.,dotProduct);if (cosAngle>=lightDirection.w)
{ 
attenuation*=getIESAttenuation(dotProduct,iesLightSampler);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
lightingInfo result;result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{ 
attenuation*=getAttenuation(cosAngle,lightData.w);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
lightingInfo result;result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;
#define inline
lightingInfo computeAreaLighting(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec3 lightPosition,vec3 halfWidth,vec3 halfHeight,vec3 diffuseColor,vec3 specularColor,float roughness) 
{lightingInfo result;areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
vec3 fresnel=( specularColor*data.Fresnel.x+( vec3( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;
#endif
result.diffuse+=diffuseColor*data.Diffuse;return result;}
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
#define inline
lightingInfo computeClusteredLighting(
sampler2D lightDataTexture,
sampler2D tileMaskTexture,
vec3 viewDirectionW,
vec3 vNormal,
vec4 lightData,
ivec2 sliceRange,
float glossiness
) {lightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);lightingInfo info;if (light.vLightDirection.w<0.0) {info=computeLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);} else {info=computeSpotLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDirection,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);}
result.diffuse+=info.diffuse;
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},50265:function(e,t,i){var r=i(68415);i(44243),i(58950);let n="lineUboDeclaration",a=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},66843:function(e,t,i){var r=i(68415);let n="lineVertexDeclaration",a=`uniform mat4 viewProjection;
#define ADDITIONAL_VERTEX_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},20142:function(e,t,i){var r=i(68415);let n="logDepthDeclaration",a=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},88040:function(e,t,i){var r=i(68415);let n="logDepthFragment",a=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},11142:function(e,t,i){var r=i(68415);let n="logDepthVertex",a=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},9709:function(e,t,i){var r=i(68415);let n="ltcHelperFunctions",a=`vec2 LTCUv( const in vec3 N,const in vec3 V,const in float roughness ) {const float LUTSIZE=64.0;const float LUTSCALE=( LUTSIZE-1.0 )/LUTSIZE;const float LUTBIAS=0.5/LUTSIZE;float dotNV=saturate( dot( N,V ) );vec2 uv=vec2( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}
float LTCClippedSphereFormFactor( const in vec3 f ) {float l=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}
vec3 LTCEdgeVectorFormFactor( const in vec3 v1,const in vec3 v2 ) {float x=dot( v1,v2 );float y=abs( x );float a=0.8543985+( 0.4965155+0.0145206*y )*y;float b=3.4175940+( 4.1616724+y )*y;float v=a/b;float thetaSintheta=0.0;if( x>0.0 )
{thetaSintheta=v;}
else
{thetaSintheta=0.5*inversesqrt( max( 1.0-x*x,1e-7 ) )-v;}
return cross( v1,v2 )*thetaSintheta;}
vec3 LTCEvaluate( const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[ 4 ] ) {vec3 v1=rectCoords[ 1 ]-rectCoords[ 0 ];vec3 v2=rectCoords[ 3 ]-rectCoords[ 0 ];vec3 lightNormal=cross( v1,v2 );if( dot( lightNormal,P-rectCoords[ 0 ] )<0.0 ) return vec3( 0.0 );vec3 T1,T2;T1=normalize( V-N*dot( V,N ) );T2=- cross( N,T1 ); 
mat3 mat=mInv*transposeMat3( mat3( T1,T2,N ) );vec3 coords[ 4 ];coords[ 0 ]=mat*( rectCoords[ 0 ]-P );coords[ 1 ]=mat*( rectCoords[ 1 ]-P );coords[ 2 ]=mat*( rectCoords[ 2 ]-P );coords[ 3 ]=mat*( rectCoords[ 3 ]-P );coords[ 0 ]=normalize( coords[ 0 ] );coords[ 1 ]=normalize( coords[ 1 ] );coords[ 2 ]=normalize( coords[ 2 ] );coords[ 3 ]=normalize( coords[ 3 ] );vec3 vectorFormFactor=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 0 ],coords[ 1 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 1 ],coords[ 2 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 2 ],coords[ 3 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 3 ],coords[ 0 ] );float result=LTCClippedSphereFormFactor( vectorFormFactor );return vec3( result );}
struct areaLightData
{vec3 Diffuse;vec3 Specular;vec4 Fresnel;};
#define inline
areaLightData computeAreaLightSpecularDiffuseFresnel(const in sampler2D ltc1,const in sampler2D ltc2,const in vec3 viewDir,const in vec3 normal,const in vec3 position,const in vec3 lightPos,const in vec3 halfWidth,const in vec3 halfHeight,const in float roughness) 
{areaLightData result;vec3 rectCoords[ 4 ];rectCoords[ 0 ]=lightPos+halfWidth-halfHeight; 
rectCoords[ 1 ]=lightPos-halfWidth-halfHeight;rectCoords[ 2 ]=lightPos-halfWidth+halfHeight;rectCoords[ 3 ]=lightPos+halfWidth+halfHeight;
#ifdef SPECULARTERM
vec2 uv=LTCUv( normal,viewDir,roughness );vec4 t1=texture2D( ltc1,uv );vec4 t2=texture2D( ltc2,uv );mat3 mInv=mat3(
vec3( t1.x,0,t1.y ),
vec3( 0,1, 0 ),
vec3( t1.z,0,t1.w )
);result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords );result.Fresnel=t2;
#endif
result.Diffuse=LTCEvaluate( normal,viewDir,position,mat3( 1.0 ),rectCoords );return result;}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},51465:function(e,t,i){var r=i(68415);let n="mainUVVaryingDeclaration",a=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},58950:function(e,t,i){var r=i(68415);let n="meshUboDeclaration",a=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},74100:function(e,t,i){var r=i(68415);let n="mrtFragmentDeclaration",a=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},62059:function(e,t,i){var r=i(68415);let n="oitDeclaration",a=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},72711:function(e,t,i){var r=i(68415);let n="oitFragment",a=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},94085:function(e,t,i){var r=i(68415);let n="openpbrBaseLayerData",a=`vec3 base_color=vec3(0.8);float base_metalness=0.0;float base_diffuse_roughness=0.0;float specular_weight=1.0;float specular_roughness=0.3;vec3 specular_color=vec3(1.0);float specular_roughness_anisotropy=0.0;float specular_ior=1.5;float alpha=1.0;vec2 geometry_tangent=vec2(1.0,0.0);
#ifdef BASE_WEIGHT
vec4 baseWeightFromTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);
#endif
#ifdef BASE_COLOR
vec4 baseColorFromTexture=texture2D(baseColorSampler,vBaseColorUV+uvOffset);
#endif
#ifdef BASE_METALNESS
vec4 metallicFromTexture=texture2D(baseMetalnessSampler,vBaseMetalnessUV+uvOffset);
#endif
#if defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS)
float roughnessFromTexture=metallicFromTexture.g;
#elif defined(SPECULAR_ROUGHNESS)
float roughnessFromTexture=texture2D(specularRoughnessSampler,vSpecularRoughnessUV+uvOffset).r;
#endif
#ifdef GEOMETRY_TANGENT
vec3 geometryTangentFromTexture=texture2D(geometryTangentSampler,vGeometryTangentUV+uvOffset).rgb;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
float anisotropyFromTexture=texture2D(specularRoughnessAnisotropySampler,vSpecularRoughnessAnisotropyUV+uvOffset).r*vSpecularRoughnessAnisotropyInfos.y;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
float baseDiffuseRoughnessFromTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
#ifdef GEOMETRY_OPACITY
vec4 opacityFromTexture=texture2D(geometryOpacitySampler,vGeometryOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalFromTexture=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
#ifdef SPECULAR_COLOR
vec4 specularColorFromTexture=texture2D(specularColorSampler,vSpecularColorUV+uvOffset);
#endif
#ifdef SPECULAR_WEIGHT
#ifdef SPECULAR_WEIGHT_IN_ALPHA
float specularWeightFromTexture=texture2D(specularWeightSampler,vSpecularWeightUV+uvOffset).a;
#else
float specularWeightFromTexture=texture2D(specularWeightSampler,vSpecularWeightUV+uvOffset).r;
#endif
#endif
#if defined(ANISOTROPIC) || defined(FUZZ)
vec3 noise=texture2D(blueNoiseSampler,gl_FragCoord.xy/256.0).xyz;
#endif
base_color=vBaseColor.rgb;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
base_color*=vColor.rgb;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
base_color*=vec3(vBaseWeight);alpha=vBaseColor.a;base_metalness=vReflectanceInfo.x;base_diffuse_roughness=vBaseDiffuseRoughness;specular_roughness=vReflectanceInfo.y;specular_color=vSpecularColor.rgb;specular_weight=vReflectanceInfo.a;specular_ior=vReflectanceInfo.z;specular_roughness_anisotropy=vSpecularAnisotropy.b;geometry_tangent=vSpecularAnisotropy.rg;
#ifdef BASE_COLOR
#ifdef BASE_COLOR_GAMMA
base_color*=toLinearSpace(baseColorFromTexture.rgb);
#else
base_color*=baseColorFromTexture.rgb;
#endif
base_color*=vBaseColorInfos.y;
#endif
#ifdef BASE_WEIGHT
base_color*=baseWeightFromTexture.r;
#endif
#if defined(BASE_COLOR) && defined(ALPHA_FROM_BASE_COLOR_TEXTURE)
alpha*=baseColorFromTexture.a;
#elif defined(GEOMETRY_OPACITY)
alpha*=opacityFromTexture.r;alpha*=vGeometryOpacityInfos.y;
#endif
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#ifdef BASE_METALNESS
#ifdef METALLNESSSTOREINMETALMAPBLUE
base_metalness*=metallicFromTexture.b;
#else
base_metalness*=metallicFromTexture.r;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
base_diffuse_roughness*=baseDiffuseRoughnessFromTexture*vBaseDiffuseRoughnessInfos.y;
#endif
#ifdef SPECULAR_COLOR
#ifdef SPECULAR_COLOR_GAMMA
specular_color*=toLinearSpace(specularColorFromTexture.rgb);
#else
specular_color*=specularColorFromTexture.rgb;
#endif
#endif
#ifdef SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE
specular_weight*=specularColorFromTexture.a;
#elif defined(SPECULAR_WEIGHT)
specular_weight*=specularWeightFromTexture;
#endif
#if defined(SPECULAR_ROUGHNESS) || (defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS))
specular_roughness*=roughnessFromTexture;
#endif
#ifdef GEOMETRY_TANGENT
{vec2 tangentFromTexture=normalize(geometryTangentFromTexture.xy*2.0-1.0);float tangent_angle_texture=atan(tangentFromTexture.y,tangentFromTexture.x);float tangent_angle_uniform=atan(geometry_tangent.y,geometry_tangent.x);float tangent_angle=tangent_angle_texture+tangent_angle_uniform;geometry_tangent=vec2(cos(tangent_angle),sin(tangent_angle));}
#endif
#if defined(GEOMETRY_TANGENT) && \
defined(SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
specular_roughness_anisotropy*=geometryTangentFromTexture.b;
#elif defined(SPECULAR_ROUGHNESS_ANISOTROPY)
specular_roughness_anisotropy*=anisotropyFromTexture;
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,specular_roughness,detailRoughness*2.);float hiLerp=mix(specular_roughness,1.,(detailRoughness-0.5)*2.);specular_roughness=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
float baseAlpha=specular_roughness*specular_roughness;float roughnessT=mix(baseAlpha,1.0,specular_roughness_anisotropy*specular_roughness_anisotropy);float roughnessB=baseAlpha;specular_roughness_anisotropy=1.0-roughnessB/max(roughnessT,0.00001);specular_roughness=sqrt(roughnessT/sqrt(2.0/(1.0+(1.0-specular_roughness_anisotropy)*(1.0-specular_roughness_anisotropy))));
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},80195:function(e,t,i){var r=i(68415);let n="openpbrBlockAmbientOcclusion",a=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT_OCCLUSION)
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT_OCCLUSION
in vec3 ambientOcclusionColorMap_,
in vec2 ambientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT_OCCLUSION
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*ambientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},64817:function(e,t,i){var r=i(68415);let n="openpbrBlockNormalFinal",a=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));coatNormalW*=sign(dot(coatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=gl_FrontFacing ? -normalW : normalW;coatNormalW=gl_FrontFacing ? -coatNormalW : coatNormalW;
#else
normalW=gl_FrontFacing ? normalW : -normalW;coatNormalW=gl_FrontFacing ? coatNormalW : -coatNormalW;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},84803:function(e,t,i){var r=i(68415);let n="openpbrCoatLayerData",a=`float coat_weight=0.0;vec3 coat_color=vec3(1.0);float coat_roughness=0.0;float coat_roughness_anisotropy=0.0;float coat_ior=1.6;float coat_darkening=1.0;vec2 geometry_coat_tangent=vec2(1.0,0.0);
#ifdef COAT_WEIGHT
vec4 coatWeightFromTexture=texture2D(coatWeightSampler,vCoatWeightUV+uvOffset);
#endif
#ifdef COAT_COLOR
vec4 coatColorFromTexture=texture2D(coatColorSampler,vCoatColorUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS
vec4 coatRoughnessFromTexture=texture2D(coatRoughnessSampler,vCoatRoughnessUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
float coatRoughnessAnisotropyFromTexture=texture2D(coatRoughnessAnisotropySampler,vCoatRoughnessAnisotropyUV+uvOffset).r;
#endif
#ifdef COAT_DARKENING
vec4 coatDarkeningFromTexture=texture2D(coatDarkeningSampler,vCoatDarkeningUV+uvOffset);
#endif
#ifdef GEOMETRY_COAT_TANGENT
vec3 geometryCoatTangentFromTexture=texture2D(geometryCoatTangentSampler,vGeometryCoatTangentUV+uvOffset).rgb;
#endif
coat_color=vCoatColor.rgb;coat_weight=vCoatWeight;coat_roughness=vCoatRoughness;coat_roughness_anisotropy=vCoatRoughnessAnisotropy;coat_ior=vCoatIor;coat_darkening=vCoatDarkening;geometry_coat_tangent=vGeometryCoatTangent.rg;
#ifdef COAT_WEIGHT
coat_weight*=coatWeightFromTexture.r;
#endif
#ifdef COAT_COLOR
#ifdef COAT_COLOR_GAMMA
coat_color*=toLinearSpace(coatColorFromTexture.rgb);
#else
coat_color*=coatColorFromTexture.rgb;
#endif
coat_color*=vCoatColorInfos.y;
#endif
#ifdef COAT_ROUGHNESS
#ifdef COAT_ROUGHNESS_FROM_GREEN_CHANNEL
coat_roughness*=coatRoughnessFromTexture.g;
#else
coat_roughness*=coatRoughnessFromTexture.r;
#endif
#endif
#if defined(GEOMETRY_COAT_TANGENT) && defined(COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
coat_roughness_anisotropy*=geometryCoatTangentFromTexture.b;
#elif defined(COAT_ROUGHNESS_ANISOTROPY)
coat_roughness_anisotropy*=coatRoughnessAnisotropyFromTexture;
#endif
#ifdef COAT_DARKENING
coat_darkening*=coatDarkeningFromTexture.r;
#endif
#ifdef GEOMETRY_COAT_TANGENT
{vec2 tangentFromTexture=normalize(geometryCoatTangentFromTexture.xy*2.0-1.0);float tangent_angle_texture=atan(tangentFromTexture.y,tangentFromTexture.x);float tangent_angle_uniform=atan(geometry_coat_tangent.y,geometry_coat_tangent.x);float tangent_angle=tangent_angle_texture+tangent_angle_uniform;geometry_coat_tangent=vec2(cos(tangent_angle),sin(tangent_angle));}
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
float coatAlpha=coat_roughness*coat_roughness;float coatRoughnessT=mix(coatAlpha,1.0,coat_roughness_anisotropy*coat_roughness_anisotropy);float coatRoughnessB=coatAlpha;coat_roughness_anisotropy=1.0-coatRoughnessB/max(coatRoughnessT,0.00001);coat_roughness=sqrt(coatRoughnessT/sqrt(2.0/(1.0+(1.0-coat_roughness_anisotropy)*(1.0-coat_roughness_anisotropy))));
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},22074:function(e,t,i){var r=i(68415);let n="openpbrConductorReflectance",a=`#define pbr_inline
ReflectanceParams conductorReflectance(in vec3 baseColor,in vec3 specularColor,in float specularWeight)
{ReflectanceParams outParams;
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
outParams.coloredF0=baseColor*specularWeight;outParams.coloredF90=specularColor*specularWeight;
#else
outParams.coloredF0=baseColor;outParams.coloredF90=vec3(1.0);
#endif
outParams.F0=1.0;outParams.F90=1.0;return outParams;}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},22129:function(e,t,i){var r=i(68415);let n="openpbrDielectricReflectance",a=`struct ReflectanceParams
{float F0;float F90;vec3 coloredF0;vec3 coloredF90;};
#define pbr_inline
ReflectanceParams dielectricReflectance(
in float insideIOR,in float outsideIOR,in vec3 specularColor,in float specularWeight
)
{ReflectanceParams outParams;float dielectricF0=pow((insideIOR-outsideIOR)/(insideIOR+outsideIOR),2.0);float dielectricF0_NoSpec=pow((1.0-outsideIOR)/(1.0+outsideIOR),2.0);float f90Scale=clamp(2.0*abs(insideIOR-outsideIOR),0.0,1.0);float f90Scale_NoSpec=clamp(2.0*abs(1.0-outsideIOR),0.0,1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
vec3 dielectricColorF90=specularColor.rgb*vec3(f90Scale);vec3 dielectricColorF90_NoSpec=specularColor.rgb*vec3(f90Scale_NoSpec);
#else
vec3 dielectricColorF90=vec3(f90Scale);vec3 dielectricColorF90_NoSpec=vec3(f90Scale_NoSpec);
#endif
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
float maxF0=max(specularColor.r,max(specularColor.g,specularColor.b));outParams.F0=mix(dielectricF0_NoSpec,dielectricF0,specularWeight)*maxF0;
#else
outParams.F0=mix(dielectricF0_NoSpec,dielectricF0,specularWeight);
#endif
outParams.F90=mix(f90Scale_NoSpec,f90Scale,specularWeight);outParams.coloredF0=mix(vec3(dielectricF0_NoSpec),vec3(dielectricF0),specularWeight)*specularColor.rgb;outParams.coloredF90=mix(dielectricColorF90_NoSpec,dielectricColorF90,specularWeight);return outParams;}
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},71874:function(e,t,i){var r=i(68415);let n="openpbrDirectLighting",a=`#ifdef LIGHT{X}
{vec3 slab_diffuse=vec3(0.,0.,0.);vec3 slab_subsurface=vec3(0.,0.,0.);vec3 slab_translucent=vec3(0.,0.,0.);vec3 slab_glossy=vec3(0.,0.,0.);float specularFresnel=0.0;vec3 specularColoredFresnel=vec3(0.,0.,0.);vec3 slab_metal=vec3(0.,0.,0.);vec3 slab_coat=vec3(0.,0.,0.);float coatFresnel=0.0;vec3 slab_fuzz=vec3(0.,0.,0.);float fuzzFresnel=0.0;
#ifdef HEMILIGHT{X}
slab_diffuse=computeHemisphericDiffuseLighting(preInfo{X},lightColor{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
slab_diffuse=computeAreaDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#else
slab_diffuse=computeDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
slab_diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
numLights+=1.0;
#ifdef FUZZ
float fuzzNdotH=max(dot(fuzzNormalW,preInfo{X}.H),0.0);vec3 fuzzBrdf=getFuzzBRDFLookup(fuzzNdotH,sqrt(fuzz_roughness));
#endif
#ifdef THIN_FILM
float thin_film_desaturation_scale=(thin_film_ior-1.0)*sqrt(thin_film_thickness*0.001);
#endif
#if AREALIGHT{X}
slab_glossy=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#ifdef ANISOTROPIC_BASE
slab_glossy=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,
baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,
0.0,lightColor{X}.rgb);
#else
slab_glossy=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),vec3(1.0),specular_roughness,lightColor{X}.rgb);
#endif
float NdotH=dot(normalW,preInfo{X}.H);specularFresnel=fresnelSchlickGGX(NdotH,baseDielectricReflectance.F0,baseDielectricReflectance.F90);specularColoredFresnel=specularFresnel*specular_color;
#ifdef THIN_FILM
float thinFilmIorScale=clamp(2.0*abs(thin_film_ior-1.0),0.0,1.0);vec3 thinFilmDielectricFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseDielectricReflectance.coloredF0);thinFilmDielectricFresnel=mix(thinFilmDielectricFresnel,vec3(dot(thinFilmDielectricFresnel,vec3(0.3333))),thin_film_desaturation_scale);specularColoredFresnel=mix(specularColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);
#endif
}
#endif
#if AREALIGHT{X}
slab_metal=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 coloredFresnel=getF82Specular(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90,specular_roughness);
#else
vec3 coloredFresnel=fresnelSchlickGGX(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90);
#endif
#ifdef THIN_FILM
float thinFilmIorScale=clamp(2.0*abs(thin_film_ior-1.0),0.0,1.0);vec3 thinFilmConductorFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseConductorReflectance.coloredF0);thinFilmConductorFresnel=mix(thinFilmConductorFresnel,vec3(dot(thinFilmConductorFresnel,vec3(0.3333))),thin_film_desaturation_scale);coloredFresnel=mix(coloredFresnel,specular_weight*thinFilmIorScale*thinFilmConductorFresnel,thin_film_weight);
#endif
#ifdef ANISOTROPIC_BASE
slab_metal=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,0.0,lightColor{X}.rgb);
#else
slab_metal=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),coloredFresnel,specular_roughness,lightColor{X}.rgb);
#endif
}
#endif
#if AREALIGHT{X}
slab_coat=computeAreaSpecularLighting(preInfoCoat{X},light{X}.vLightSpecular.rgb,coatReflectance.F0,coatReflectance.F90);
#else
{
#ifdef ANISOTROPIC_COAT
slab_coat=computeAnisotropicSpecularLighting(preInfoCoat{X},viewDirectionW,coatNormalW,
coatGeoInfo.anisotropicTangent,coatGeoInfo.anisotropicBitangent,coatGeoInfo.anisotropy,
0.0,lightColor{X}.rgb);
#else
slab_coat=computeSpecularLighting(preInfoCoat{X},coatNormalW,vec3(coatReflectance.F0),vec3(1.0),coat_roughness,lightColor{X}.rgb);
#endif
float NdotH=dot(coatNormalW,preInfoCoat{X}.H);coatFresnel=fresnelSchlickGGX(NdotH,coatReflectance.F0,coatReflectance.F90);}
#endif
vec3 coatAbsorption=vec3(1.0);if (coat_weight>0.0) {float cosTheta_view=max(preInfoCoat{X}.NdotV,0.001);float cosTheta_light=max(preInfoCoat{X}.NdotL,0.001);float fresnel_view=coatReflectance.F0+(1.0-coatReflectance.F0)*pow(1.0-cosTheta_view,5.0);float fresnel_light=coatReflectance.F0+(1.0-coatReflectance.F0)*pow(1.0-cosTheta_light,5.0);float averageReflectance=(fresnel_view+fresnel_light)*0.5;float darkened_transmission=(1.0-averageReflectance)/(1.0+averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);float sin2=1.0-cosTheta_view*cosTheta_view;sin2=sin2/(coat_ior*coat_ior);float cos_t=sqrt(1.0-sin2);float coatPathLength=1.0/cos_t;vec3 colored_transmission=pow(coat_color,vec3(coatPathLength));coatAbsorption=mix(vec3(1.0),colored_transmission*darkened_transmission,coat_weight);}
#ifdef FUZZ
fuzzFresnel=fuzzBrdf.z;vec3 fuzzNormalW=mix(normalW,coatNormalW,coat_weight);float fuzzNdotV=max(dot(fuzzNormalW,viewDirectionW.xyz),0.0);float fuzzNdotL=max(dot(fuzzNormalW,preInfo{X}.L),0.0);slab_fuzz=lightColor{X}.rgb*preInfo{X}.attenuation*evalFuzz(preInfo{X}.L,fuzzNdotL,fuzzNdotV,fuzzTangent,fuzzBitangent,fuzzBrdf);
#else
vec3 fuzz_color=vec3(0.0);
#endif
slab_diffuse*=base_color.rgb;vec3 material_opaque_base=mix(slab_diffuse,slab_subsurface,subsurface_weight);vec3 material_dielectric_base=mix(material_opaque_base,slab_translucent,transmission_weight);vec3 material_dielectric_gloss=material_dielectric_base*(1.0-specularFresnel)+slab_glossy*specularColoredFresnel;vec3 material_base_substrate=mix(material_dielectric_gloss,slab_metal,base_metalness);vec3 material_coated_base=layer(material_base_substrate,slab_coat,coatFresnel,coatAbsorption,vec3(1.0));material_surface_direct+=layer(material_coated_base,slab_fuzz,fuzzFresnel*fuzz_weight,vec3(1.0),fuzz_color);}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},37380:function(e,t,i){var r=i(68415);let n="openpbrDirectLightingInit",a=`#ifdef LIGHT{X}
preLightingInfo preInfo{X};preLightingInfo preInfoCoat{X};vec4 lightColor{X}=light{X}.vLightDiffuse;float shadow{X}=1.;
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef SPOTLIGHT{X}
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(DIRLIGHT{X})
preInfo{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,specular_roughness);preInfoCoat{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,coatNormalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,coat_roughness);
#endif
preInfo{X}.NdotV=baseGeoInfo.NdotV;preInfoCoat{X}.NdotV=coatGeoInfo.NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo{X}.attenuation=1.0;
#endif
preInfoCoat{X}.attenuation=preInfo{X}.attenuation;
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo{X}.roughness=specular_roughness;preInfoCoat{X}.roughness=coat_roughness;
#else
preInfo{X}.roughness=adjustRoughnessFromLightProperties(specular_roughness,light{X}.vLightSpecular.a,preInfo{X}.lightDistance);preInfoCoat{X}.roughness=adjustRoughnessFromLightProperties(coat_roughness,light{X}.vLightSpecular.a,preInfoCoat{X}.lightDistance);
#endif
preInfo{X}.diffuseRoughness=base_diffuse_roughness;preInfo{X}.surfaceAlbedo=base_color.rgb;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},57522:function(e,t,i){var r=i(68415);let n="openpbrEnvironmentLighting",a=`#ifdef REFLECTION
#ifdef FUZZ
vec3 environmentFuzzBrdf=getFuzzBRDFLookup(fuzzGeoInfo.NdotV,sqrt(fuzz_roughness));
#endif
vec3 baseDiffuseEnvironmentLight=sampleIrradiance(
normalW
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,vReflectionDominantDirection
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
,vReflectionInfos
,viewDirectionW
,base_diffuse_roughness
,base_color
);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.,0.,0.);
#else
vec2 reflectionCoords=vec2(0.,0.);
#endif
float specularAlphaG=specular_roughness*specular_roughness;
#ifdef ANISOTROPIC_BASE
vec3 baseSpecularEnvironmentLight=sampleRadianceAnisotropic(specularAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,baseGeoInfo
,normalW
,viewDirectionW
,vPositionW
,noise
,reflectionSampler
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#else
reflectionCoords=createReflectionCoords(vPositionW,normalW);vec3 baseSpecularEnvironmentLight=sampleRadiance(specularAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,baseGeoInfo
,reflectionSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#endif
#ifdef ANISOTROPIC_BASE
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG*specularAlphaG*max(1.0-baseGeoInfo.anisotropy,0.3));
#else
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG);
#endif
vec3 coatEnvironmentLight=vec3(0.,0.,0.);if (coat_weight>0.0) {
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.,0.,0.);
#else
vec2 reflectionCoords=vec2(0.,0.);
#endif
reflectionCoords=createReflectionCoords(vPositionW,coatNormalW);float coatAlphaG=coat_roughness*coat_roughness;
#ifdef ANISOTROPIC_COAT
coatEnvironmentLight=sampleRadianceAnisotropic(coatAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,coatGeoInfo
,coatNormalW
,viewDirectionW
,vPositionW
,noise
,reflectionSampler
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#else
coatEnvironmentLight=sampleRadiance(coatAlphaG,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,coatGeoInfo
,reflectionSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#endif
}
#ifdef FUZZ
float modifiedFuzzRoughness=clamp(fuzz_roughness*(1.0-0.5*environmentFuzzBrdf.y),0.0,1.0);vec3 fuzzEnvironmentLight=vec3(0.0);float totalWeight=0.0;float fuzzIblFresnel=sqrt(environmentFuzzBrdf.z);for (int i=0; i<FUZZ_IBL_SAMPLES; ++i) {float angle=(float(i)+noise.x)*(3.141592*2.0/float(FUZZ_IBL_SAMPLES));vec3 fiberCylinderNormal=normalize(cos(angle)*fuzzTangent+sin(angle)*fuzzBitangent);float fiberBend=min(environmentFuzzBrdf.x*environmentFuzzBrdf.x*modifiedFuzzRoughness,1.0);fiberCylinderNormal=normalize(mix(fiberCylinderNormal,fuzzNormalW,fiberBend));float sampleWeight=max(dot(viewDirectionW,fiberCylinderNormal),0.0);vec3 fuzzReflectionCoords=createReflectionCoords(vPositionW,fiberCylinderNormal);vec3 radianceSample=sampleRadiance(modifiedFuzzRoughness,vReflectionMicrosurfaceInfos.rgb,vReflectionInfos
,fuzzGeoInfo
,reflectionSampler
,fuzzReflectionCoords
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);fuzzEnvironmentLight+=sampleWeight*mix(radianceSample,baseDiffuseEnvironmentLight,fiberBend);totalWeight+=sampleWeight;}
fuzzEnvironmentLight/=totalWeight;
#endif
float dielectricIblFresnel=getReflectanceFromBRDFLookup(vec3(baseDielectricReflectance.F0),vec3(baseDielectricReflectance.F90),baseGeoInfo.environmentBrdf).r;vec3 dielectricIblColoredFresnel=dielectricIblFresnel*specular_color;
#ifdef THIN_FILM
float thinFilmIorScale=clamp(2.0*abs(thin_film_ior-1.0),0.0,1.0);vec3 thinFilmDielectricFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseDielectricReflectance.coloredF0);float thin_film_desaturation_scale=(thin_film_ior-1.0)*sqrt(thin_film_thickness*0.001*baseGeoInfo.NdotV);thinFilmDielectricFresnel=mix(thinFilmDielectricFresnel,vec3(dot(thinFilmDielectricFresnel,vec3(0.3333))),thin_film_desaturation_scale);dielectricIblColoredFresnel=mix(dielectricIblColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);
#endif
vec3 conductorIblFresnel=conductorIblFresnel(baseConductorReflectance,baseGeoInfo.NdotV,specular_roughness,baseGeoInfo.environmentBrdf);
#ifdef THIN_FILM
vec3 thinFilmConductorFresnel=specular_weight*evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseConductorReflectance.coloredF0);thinFilmConductorFresnel=mix(thinFilmConductorFresnel,vec3(dot(thinFilmConductorFresnel,vec3(0.3333))),thin_film_desaturation_scale);conductorIblFresnel=mix(conductorIblFresnel,thinFilmConductorFresnel,thin_film_weight*thinFilmIorScale);
#endif
float coatIblFresnel=0.0;if (coat_weight>0.0) {coatIblFresnel=getReflectanceFromBRDFLookup(vec3(coatReflectance.F0),vec3(coatReflectance.F90),coatGeoInfo.environmentBrdf).r;}
vec3 slab_diffuse_ibl=vec3(0.,0.,0.);vec3 slab_glossy_ibl=vec3(0.,0.,0.);vec3 slab_metal_ibl=vec3(0.,0.,0.);vec3 slab_coat_ibl=vec3(0.,0.,0.);slab_diffuse_ibl=baseDiffuseEnvironmentLight*vLightingIntensity.z;slab_diffuse_ibl*=aoOut.ambientOcclusionColor;slab_glossy_ibl=baseSpecularEnvironmentLight*vLightingIntensity.z;slab_metal_ibl=baseSpecularEnvironmentLight*conductorIblFresnel*vLightingIntensity.z;vec3 coatAbsorption=vec3(1.0);if (coat_weight>0.0) {slab_coat_ibl=coatEnvironmentLight*vLightingIntensity.z;float hemisphere_avg_fresnel=coatReflectance.F0+0.5*(1.0-coatReflectance.F0);float averageReflectance=(coatIblFresnel+hemisphere_avg_fresnel)*0.5;float roughnessFactor=1.0-coat_roughness*0.5;averageReflectance*=roughnessFactor;float darkened_transmission=(1.0-averageReflectance)*(1.0-averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);float sin2=1.0-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);float cos_t=sqrt(1.0-sin2);float coatPathLength=1.0/cos_t;vec3 colored_transmission=pow(coat_color,vec3(coatPathLength));coatAbsorption=mix(vec3(1.0),colored_transmission*darkened_transmission,coat_weight);}
#ifdef FUZZ
vec3 slab_fuzz_ibl=fuzzEnvironmentLight*vLightingIntensity.z;
#endif
vec3 slab_subsurface_ibl=vec3(0.,0.,0.);vec3 slab_translucent_base_ibl=vec3(0.,0.,0.);slab_diffuse_ibl*=base_color.rgb;
#define CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION
vec3 material_opaque_base_ibl=mix(slab_diffuse_ibl,slab_subsurface_ibl,subsurface_weight);vec3 material_dielectric_base_ibl=mix(material_opaque_base_ibl,slab_translucent_base_ibl,transmission_weight);vec3 material_dielectric_gloss_ibl=material_dielectric_base_ibl*(1.0-dielectricIblFresnel)+slab_glossy_ibl*dielectricIblColoredFresnel;vec3 material_base_substrate_ibl=mix(material_dielectric_gloss_ibl,slab_metal_ibl,base_metalness);vec3 material_coated_base_ibl=layer(material_base_substrate_ibl,slab_coat_ibl,coatIblFresnel,coatAbsorption,vec3(1.0));
#ifdef FUZZ
material_surface_ibl=layer(material_coated_base_ibl,slab_fuzz_ibl,fuzzIblFresnel*fuzz_weight,vec3(1.0),fuzz_color);
#else
material_surface_ibl=material_coated_base_ibl;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},39775:function(e,t,i){var r=i(68415);i(80960);let n="openpbrFragmentDeclaration",a=`uniform vec4 vEyePosition;uniform float vBaseWeight;uniform vec4 vBaseColor;uniform float vBaseDiffuseRoughness;uniform vec4 vReflectanceInfo;uniform vec4 vSpecularColor;uniform vec3 vSpecularAnisotropy;uniform float vCoatWeight;uniform vec3 vCoatColor;uniform float vCoatRoughness;uniform float vCoatRoughnessAnisotropy;uniform float vCoatIor;uniform float vCoatDarkening;uniform float vFuzzWeight;uniform vec3 vFuzzColor;uniform float vFuzzRoughness;uniform vec2 vGeometryCoatTangent;uniform vec3 vEmissionColor;uniform float vThinFilmWeight;uniform vec2 vThinFilmThickness;uniform float vThinFilmIor;uniform vec4 vLightingIntensity;uniform float visibility;
#ifdef BASE_COLOR
uniform vec2 vBaseColorInfos;
#endif
#ifdef BASE_WEIGHT
uniform vec2 vBaseWeightInfos;
#endif
#ifdef BASE_METALNESS
uniform vec2 vBaseMetalnessInfos;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef SPECULAR_WEIGHT
uniform vec2 vSpecularWeightInfos;
#endif
#ifdef SPECULAR_COLOR
uniform vec2 vSpecularColorInfos;
#endif
#ifdef SPECULAR_ROUGHNESS
uniform vec2 vSpecularRoughnessInfos;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
uniform vec2 vSpecularRoughnessAnisotropyInfos;
#endif
#ifdef SPECULAR_IOR
uniform vec2 vSpecularIorInfos;
#endif
#ifdef AMBIENT_OCCLUSION
uniform vec2 vAmbientOcclusionInfos;
#endif
#ifdef GEOMETRY_NORMAL
uniform vec2 vGeometryNormalInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef GEOMETRY_TANGENT
uniform vec2 vGeometryTangentInfos;
#endif
#ifdef GEOMETRY_COAT_NORMAL
uniform vec2 vGeometryCoatNormalInfos;
#endif
#ifdef GEOMETRY_OPACITY
uniform vec2 vGeometryOpacityInfos;
#endif
#ifdef EMISSION_COLOR
uniform vec2 vEmissionColorInfos;
#endif
#ifdef COAT_WEIGHT
uniform vec2 vCoatWeightInfos;
#endif
#ifdef COAT_COLOR
uniform vec2 vCoatColorInfos;
#endif
#ifdef COAT_ROUGHNESS
uniform vec2 vCoatRoughnessInfos;
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
uniform vec2 vCoatRoughnessAnisotropyInfos;
#endif
#ifdef COAT_IOR
uniform vec2 vCoatIorInfos;
#endif
#ifdef COAT_DARKENING
uniform vec2 vCoatDarkeningInfos;
#endif
#ifdef FUZZ_WEIGHT
uniform vec2 vFuzzWeightInfos;
#endif
#ifdef FUZZ_COLOR
uniform vec2 vFuzzColorInfos;
#endif
#ifdef FUZZ_ROUGHNESS
uniform vec2 vFuzzRoughnessInfos;
#endif
#ifdef GEOMETRY_COAT_TANGENT
uniform vec2 vGeometryCoatTangentInfos;
#endif
#ifdef THIN_FILM_WEIGHT
uniform vec2 vThinFilmWeightInfos;
#endif
#ifdef THIN_FILM_THICKNESS
uniform vec2 vThinFilmThicknessInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)
uniform vec3 vReflectionDominantDirection;
#endif
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},82224:function(e,t,i){var r=i(68415);i(23355);let n="openpbrFragmentSamplersDeclaration",a=`#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_SAMPLERNAME_,baseColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_SAMPLERNAME_,baseMetalness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_SAMPLERNAME_,specularWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_SAMPLERNAME_,specularColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_SAMPLERNAME_,specularRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_SAMPLERNAME_,specularRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_SAMPLERNAME_,coatWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_SAMPLERNAME_,coatColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_SAMPLERNAME_,coatRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_SAMPLERNAME_,coatRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_SAMPLERNAME_,coatDarkening)
#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight,_SAMPLERNAME_,fuzzWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor,_SAMPLERNAME_,fuzzColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness,_SAMPLERNAME_,fuzzRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_SAMPLERNAME_,geometryOpacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_SAMPLERNAME_,geometryTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_TANGENT,_VARYINGNAME_,GeometryCoatTangent,_SAMPLERNAME_,geometryCoatTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_SAMPLERNAME_,emissionColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_SAMPLERNAME_,thinFilmWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_SAMPLERNAME_,thinFilmThickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_SAMPLERNAME_,ambientOcclusion)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef FUZZENVIRONMENTBRDF
uniform sampler2D environmentFuzzBrdfSampler;
#endif
#if defined(ANISOTROPIC) || defined(FUZZ)
uniform sampler2D blueNoiseSampler;
#endif
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfSampler;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},49589:function(e,t,i){var r=i(68415);let n="openpbrFuzzLayerData",a=`float fuzz_weight=0.0;vec3 fuzz_color=vec3(1.0);float fuzz_roughness=0.0;
#ifdef FUZZ
#ifdef FUZZ_WEIGHT
vec4 fuzzWeightFromTexture=texture2D(fuzzWeightSampler,vFuzzWeightUV+uvOffset);
#endif
#ifdef FUZZ_COLOR
vec4 fuzzColorFromTexture=texture2D(fuzzColorSampler,vFuzzColorUV+uvOffset);
#endif
#ifdef FUZZ_ROUGHNESS
vec4 fuzzRoughnessFromTexture=texture2D(fuzzRoughnessSampler,vFuzzRoughnessUV+uvOffset);
#endif
fuzz_color=vFuzzColor.rgb;fuzz_weight=vFuzzWeight;fuzz_roughness=vFuzzRoughness;
#ifdef FUZZ_WEIGHT
fuzz_weight*=fuzzWeightFromTexture.r;
#endif
#ifdef FUZZ_COLOR
#ifdef FUZZ_COLOR_GAMMA
fuzz_color*=toLinearSpace(fuzzColorFromTexture.rgb);
#else
fuzz_color*=fuzzColorFromTexture.rgb;
#endif
fuzz_color*=vFuzzColorInfos.y;
#endif
#if defined(FUZZ_ROUGHNESS) && defined(FUZZ_ROUGHNESS_FROM_TEXTURE_ALPHA)
fuzz_roughness*=fuzzRoughnessFromTexture.a;
#elif defined(FUZZ_ROUGHNESS)
fuzz_roughness*=fuzzRoughnessFromTexture.r;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},42727:function(e,t,i){var r=i(68415);let n="openpbrGeometryInfo",a=`struct geometryInfoOutParams
{float NdotV;float NdotVUnclamped;vec3 environmentBrdf;float horizonOcclusion;};struct geometryInfoAnisoOutParams
{float NdotV;float NdotVUnclamped;vec3 environmentBrdf;float horizonOcclusion;float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;mat3 TBN;};
#define pbr_inline
geometryInfoOutParams geometryInfo(
in vec3 normalW,in vec3 viewDirectionW,in float roughness,in vec3 geometricNormalW
)
{geometryInfoOutParams outParams;outParams.NdotVUnclamped=dot(normalW,viewDirectionW);outParams.NdotV=absEps(outParams.NdotVUnclamped);
#if defined(ENVIRONMENTBRDF)
outParams.environmentBrdf=getBRDFLookup(outParams.NdotV,roughness);
#else
outParams.environmentBrdf=vec3(0.0);
#endif
outParams.horizonOcclusion=1.0;
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef HORIZONOCCLUSION
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL)
#ifdef REFLECTIONMAP_3D
outParams.horizonOcclusion=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
return outParams;}
#define pbr_inline
geometryInfoAnisoOutParams geometryInfoAniso(
in vec3 normalW,in vec3 viewDirectionW,in float roughness,in vec3 geometricNormalW
,in vec3 vAnisotropy,in mat3 TBN
)
{geometryInfoOutParams geoInfo=geometryInfo(normalW,viewDirectionW,roughness,geometricNormalW);geometryInfoAnisoOutParams outParams;outParams.NdotV=geoInfo.NdotV;outParams.NdotVUnclamped=geoInfo.NdotVUnclamped;outParams.environmentBrdf=geoInfo.environmentBrdf;outParams.horizonOcclusion=geoInfo.horizonOcclusion;outParams.anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));outParams.anisotropicTangent=normalize(anisoTBN*anisotropyDirection);outParams.anisotropicBitangent=normalize(cross(anisoTBN[2],outParams.anisotropicTangent));outParams.TBN=TBN;return outParams;}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},7725:function(e,t,i){var r=i(68415);let n="openpbrIblFunctions",a=`#ifdef REFLECTION
vec3 sampleIrradiance(
in vec3 surfaceNormal
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradianceSH
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,in mat4 iblMatrix
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,in vec3 reflectionDominantDirection
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
,in vec2 vReflectionInfos
,in vec3 viewDirectionW
,in float diffuseRoughness
,in vec3 surfaceAlbedo
) {vec3 environmentIrradiance=vec3(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
vec3 irradianceVector=(iblMatrix*vec4(surfaceNormal,0)).xyz;vec3 irradianceView=(iblMatrix*vec4(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
{float NdotV=max(dot(surfaceNormal,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);}
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradianceSH;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec4 environmentIrradianceFromTexture=sampleReflection(irradianceSampler,irradianceVector);
#else
vec4 environmentIrradianceFromTexture=sampleReflection(irradianceSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradianceFromTexture.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradianceFromTexture);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
vec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=vReflectionInfos.x;return environmentIrradiance;}
#define pbr_inline
#ifdef REFLECTIONMAP_3D
vec3 createReflectionCoords(
#else
vec2 createReflectionCoords(
#endif
in vec3 vPositionW
,in vec3 normalW
)
{vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
#define inline
vec3 sampleRadiance(
in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in geometryInfoOutParams geoInfo
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,const vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,const vec2 reflectionCoords
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vec3(vReflectionInfos.x);return environmentRadiance.rgb;}
#if defined(ANISOTROPIC)
#define pbr_inline
#define inline
vec3 sampleRadianceAnisotropic(
in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in geometryInfoAnisoOutParams geoInfo
,const vec3 normalW
,const vec3 viewDirectionW
,const vec3 positionW
,const vec3 noise
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);float alphaT=alphaG*sqrt(2.0/(1.0+(1.0-geoInfo.anisotropy)*(1.0-geoInfo.anisotropy)));float alphaB=(1.0-geoInfo.anisotropy)*alphaT;alphaG=alphaB;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
vec3 view=(reflectionMatrix*vec4(viewDirectionW,0.0)).xyz;vec3 tangent=(reflectionMatrix*vec4(geoInfo.anisotropicTangent,0.0)).xyz;vec3 bitangent=(reflectionMatrix*vec4(geoInfo.anisotropicBitangent,0.0)).xyz;vec3 normal=(reflectionMatrix*vec4(normalW,0.0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
view.z*=-1.0;tangent.z*=-1.0;bitangent.z*=-1.0;normal.z*=-1.0;
#endif
environmentRadiance =
vec4(radianceAnisotropic(alphaT,alphaB,reflectionSampler,
view,tangent,
bitangent,normal,
vReflectionFilteringInfo,noise.xy),
1.0);
#else
const int samples=16;vec4 radianceSample=vec4(0.0);vec3 reflectionCoords=vec3(0.0);float sample_weight=0.0;float total_weight=0.0;float step=1.0/float(max(samples-1,1));for (int i=0; i<samples; ++i) {float t=mix(-1.0,1.0,float(i)*step);t+=step*2.0*noise.x;sample_weight=max(1.0-abs(t),0.001);sample_weight*=sample_weight;t*=min(4.0*alphaT*geoInfo.anisotropy,1.0);vec3 bentNormal;if (t<0.0) {float blend=t+1.0;bentNormal=normalize(mix(-geoInfo.anisotropicTangent,normalW,blend));} else if (t>0.0) {float blend=t;bentNormal=normalize(mix(normalW,geoInfo.anisotropicTangent,blend));} else {bentNormal=normalW;}
reflectionCoords=createReflectionCoords(positionW,bentNormal);radianceSample=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#ifdef RGBDREFLECTION
environmentRadiance.rgb+=sample_weight*fromRGBD(radianceSample);
#elif defined(GAMMAREFLECTION)
environmentRadiance.rgb+=sample_weight*toLinearSpace(radianceSample.rgb);
#else
environmentRadiance.rgb+=sample_weight*radianceSample.rgb;
#endif
total_weight+=sample_weight;}
environmentRadiance=vec4(environmentRadiance.xyz/float(total_weight),1.0);
#endif
environmentRadiance.rgb*=vec3(vReflectionInfos.x);return environmentRadiance.rgb;}
#endif
#define pbr_inline
vec3 conductorIblFresnel(in ReflectanceParams reflectance,in float NdotV,in float roughness,in vec3 environmentBrdf)
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 albedoF0=mix(reflectance.coloredF0,pow(reflectance.coloredF0,vec3(1.4)),roughness);return getF82Specular(NdotV,albedoF0,reflectance.coloredF90,roughness);
#else
return getReflectanceFromBRDFLookup(reflectance.coloredF0,reflectance.coloredF90,environmentBrdf);
#endif
}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},36156:function(e,t,i){var r=i(68415);let n="openpbrNormalMapFragment",a=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(GEOMETRY_NORMAL)
float normalScale=vGeometryNormalInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(GEOMETRY_NORMAL)
vec2 TBNUV=gl_FrontFacing ? vGeometryNormalUV : -vGeometryNormalUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC) || defined(FUZZ)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
#else
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef GEOMETRY_COAT_NORMAL
coatNormalW=perturbNormal(TBN,texture2D(geometryCoatNormalSampler,vGeometryCoatNormalUV+uvOffset).xyz,vGeometryCoatNormalInfos.y);
#endif
#ifdef GEOMETRY_NORMAL
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(geometryNormalSampler,vGeometryNormalUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(geometryNormalSampler,vGeometryNormalUV+uvOffset).xyz,vGeometryNormalInfos.y);
#else
vec3 sampledNormal=texture2D(geometryNormalSampler,vGeometryNormalUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(sampledNormal.xy+detailNormal.xy,sampledNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;sampledNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=sampledNormal*dot(sampledNormal,detailNormal)/sampledNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vGeometryNormalInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},69043:function(e,t,i){var r=i(68415);i(23355);let n="openpbrNormalMapFragmentFunctions",a=`#if defined(GEOMETRY_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_SAMPLERNAME_,geometryNormal)
#endif
#if defined(GEOMETRY_COAT_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_SAMPLERNAME_,geometryCoatNormal)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(GEOMETRY_NORMAL) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(geometryNormalSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(geometryNormalSampler,vGeometryNormalUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},78608:function(e,t,i){var r=i(68415);let n="openpbrNormalMapFragmentMainFunctions",a=`#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(FUZZ) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},79530:function(e,t,i){var r=i(68415);let n="openpbrNormalMapVertex",a=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(FUZZ)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},45020:function(e,t,i){var r=i(68415);let n="openpbrNormalMapVertexDeclaration",a=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(GEOMETRY_COAT_NORMAL) || defined(ANISOTROPIC) || defined(FUZZ)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},86613:function(e,t,i){var r=i(68415);let n="openpbrThinFilmLayerData",a=`#ifdef THIN_FILM
float thin_film_weight=vThinFilmWeight;float thin_film_thickness=vThinFilmThickness.r*1000.0; 
float thin_film_ior=vThinFilmIor;
#ifdef THIN_FILM_WEIGHT
float thinFilmWeightFromTexture=texture2D(thinFilmWeightSampler,vThinFilmWeightUV+uvOffset).r*vThinFilmWeightInfos.y;
#endif
#ifdef THIN_FILM_THICKNESS
float thinFilmThicknessFromTexture=texture2D(thinFilmThicknessSampler,vThinFilmThicknessUV+uvOffset).g*vThinFilmThicknessInfos.y;
#endif
#ifdef THIN_FILM_WEIGHT
thin_film_weight*=thinFilmWeightFromTexture;
#endif
#ifdef THIN_FILM_THICKNESS
thin_film_thickness*=thinFilmThicknessFromTexture;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},93431:function(e,t,i){var r=i(68415);i(44243),i(58950);let n="openpbrUboDeclaration",a=`layout(std140,column_major) uniform;uniform Material {vec2 vTangentSpaceParams;vec4 vLightingIntensity;float pointSize;vec2 vDebugMode;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vReflectionFilteringInfo;vec3 vReflectionDominantDirection;vec3 vReflectionColor;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;float vBaseWeight;vec4 vBaseColor;float vBaseDiffuseRoughness;vec4 vReflectanceInfo;vec4 vSpecularColor;vec3 vSpecularAnisotropy;float vCoatWeight;vec3 vCoatColor;float vCoatRoughness;float vCoatRoughnessAnisotropy;float vCoatIor;float vCoatDarkening;float vFuzzWeight;vec3 vFuzzColor;float vFuzzRoughness;vec2 vGeometryCoatTangent;vec3 vEmissionColor;float vThinFilmWeight;vec2 vThinFilmThickness;float vThinFilmIor;vec2 vBaseWeightInfos;mat4 baseWeightMatrix;vec2 vBaseColorInfos;mat4 baseColorMatrix;vec2 vBaseDiffuseRoughnessInfos;mat4 baseDiffuseRoughnessMatrix;vec2 vBaseMetalnessInfos;mat4 baseMetalnessMatrix;vec2 vSpecularWeightInfos;mat4 specularWeightMatrix;vec2 vSpecularColorInfos;mat4 specularColorMatrix;vec2 vSpecularRoughnessInfos;mat4 specularRoughnessMatrix;vec2 vSpecularRoughnessAnisotropyInfos;mat4 specularRoughnessAnisotropyMatrix;vec2 vCoatWeightInfos;mat4 coatWeightMatrix;vec2 vCoatColorInfos;mat4 coatColorMatrix;vec2 vCoatRoughnessInfos;mat4 coatRoughnessMatrix;vec2 vCoatRoughnessAnisotropyInfos;mat4 coatRoughnessAnisotropyMatrix;vec2 vCoatDarkeningInfos;mat4 coatDarkeningMatrix;vec2 vFuzzWeightInfos;mat4 fuzzWeightMatrix;vec2 vFuzzColorInfos;mat4 fuzzColorMatrix;vec2 vFuzzRoughnessInfos;mat4 fuzzRoughnessMatrix;vec2 vGeometryNormalInfos;mat4 geometryNormalMatrix;vec2 vGeometryTangentInfos;mat4 geometryTangentMatrix;vec2 vGeometryCoatNormalInfos;mat4 geometryCoatNormalMatrix;vec2 vGeometryCoatTangentInfos;mat4 geometryCoatTangentMatrix;vec2 vGeometryOpacityInfos;mat4 geometryOpacityMatrix;vec2 vEmissionColorInfos;mat4 emissionColorMatrix;vec2 vThinFilmWeightInfos;mat4 thinFilmWeightMatrix;vec2 vThinFilmThicknessInfos;mat4 thinFilmThicknessMatrix;vec2 vAmbientOcclusionInfos;mat4 ambientOcclusionMatrix;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},85013:function(e,t,i){var r=i(68415);i(66378);let n="openpbrVertexDeclaration",a=`uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
#ifdef BASE_COLOR
uniform vec2 vBaseColorInfos;uniform mat4 baseColorMatrix;
#endif
#ifdef BASE_WEIGHT
uniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;
#endif
uniform float vBaseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT_OCCLUSION
uniform vec2 vAmbientOcclusionInfos;uniform mat4 ambientOcclusionMatrix;
#endif
#ifdef EMISSION_COLOR
uniform vec2 vEmissionColorInfos;uniform mat4 emissionColorMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef BASE_METALNESS
uniform vec2 vBaseMetalnessInfos;uniform mat4 baseMetalnessMatrix;
#endif
#ifdef SPECULAR_WEIGHT
uniform vec2 vSpecularWeightInfos;uniform mat4 specularWeightMatrix;
#endif
#ifdef SPECULAR_COLOR
uniform vec2 vSpecularColorInfos;uniform mat4 specularColorMatrix;
#endif
#ifdef SPECULAR_ROUGHNESS
uniform vec2 vSpecularRoughnessInfos;uniform mat4 specularRoughnessMatrix;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
uniform vec2 vSpecularRoughnessAnisotropyInfos;uniform mat4 specularRoughnessAnisotropyMatrix;
#endif
#ifdef COAT_WEIGHT
uniform vec2 vCoatWeightInfos;uniform mat4 coatWeightMatrix;
#endif
#ifdef COAT_COLOR
uniform vec2 vCoatColorInfos;uniform mat4 coatColorMatrix;
#endif
#ifdef COAT_ROUGHNESS
uniform vec2 vCoatRoughnessInfos;uniform mat4 coatRoughnessMatrix;
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
uniform vec2 vCoatRoughnessAnisotropyInfos;uniform mat4 coatRoughnessAnisotropyMatrix;
#endif
#ifdef COAT_IOR
uniform vec2 vCoatIorInfos;uniform mat4 coatIorMatrix;
#endif
#ifdef COAT_DARKENING
uniform vec2 vCoatDarkeningInfos;uniform mat4 coatDarkeningMatrix;
#endif
#ifdef FUZZ_WEIGHT
uniform vec2 vFuzzWeightInfos;uniform mat4 fuzzWeightMatrix;
#endif
#ifdef FUZZ_COLOR
uniform vec2 vFuzzColorInfos;uniform mat4 fuzzColorMatrix;
#endif
#ifdef FUZZ_ROUGHNESS
uniform vec2 vFuzzRoughnessInfos;uniform mat4 fuzzRoughnessMatrix;
#endif
#ifdef GEOMETRY_NORMAL
uniform vec2 vGeometryNormalInfos;uniform mat4 geometryNormalMatrix;
#endif
#ifdef GEOMETRY_TANGENT
uniform vec2 vGeometryTangentInfos;uniform mat4 geometryTangentMatrix;
#endif
#ifdef GEOMETRY_COAT_NORMAL
uniform vec2 vGeometryCoatNormalInfos;uniform mat4 geometryCoatNormalMatrix;
#endif
#ifdef THIN_FILM_WEIGHT
uniform vec2 vThinFilmWeightInfos;uniform mat4 thinFilmWeightMatrix;
#endif
#ifdef THIN_FILM_THICKNESS
uniform vec2 vThinFilmThicknessInfos;uniform mat4 thinFilmThicknessMatrix;
#endif
#ifdef GEOMETRY_OPACITY
uniform mat4 geometryOpacityMatrix;uniform vec2 vGeometryOpacityInfos;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
uniform vec4 cameraInfo;
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},31896:function(e,t,i){var r=i(68415);let n="pbrBRDFFunctions",a=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#define BRDF_DIFFUSE_MODEL_EON 0
#define BRDF_DIFFUSE_MODEL_BURLEY 1
#define BRDF_DIFFUSE_MODEL_LAMBERT 2
#define BRDF_DIFFUSE_MODEL_LEGACY 3
#define DIELECTRIC_SPECULAR_MODEL_GLTF 0
#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1
#define CONDUCTOR_SPECULAR_MODEL_GLTF 0
#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1
#if !defined(PBR_VERTEX_SHADER) && !defined(OPENPBR_VERTEX_SHADER)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR 
vec3 getF82Specular(float NdotV,vec3 F0,vec3 edgeTint,float roughness) {const float cos_theta_max=0.142857143; 
const float one_minus_cos_theta_max_to_the_fifth=0.462664366; 
const float one_minus_cos_theta_max_to_the_sixth=0.396569457; 
vec3 white_minus_F0=vec3(1.0)-F0;vec3 b_numerator=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3(1.0)-edgeTint);const float b_denominator=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const float b_denominator_reciprocal=1.0/b_denominator;vec3 b=b_numerator*b_denominator_reciprocal; 
float cos_theta=max(roughness,NdotV);float one_minus_cos_theta=1.0-cos_theta;vec3 offset_from_F0=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0);return clamp(F0+offset_from_F0,0.0,1.0);}
#endif
#ifdef FUZZENVIRONMENTBRDF
vec3 getFuzzBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(perceptualRoughness,NdotV);vec4 brdfLookup=texture2D(environmentFuzzBrdfSampler,UV);const vec2 RiRange=vec2(0.0,0.75);const vec2 ARange =vec2(0.005,0.88);const vec2 BRange =vec2(-0.18,0.002);brdfLookup.r=mix(ARange.x, ARange.y, brdfLookup.r);brdfLookup.g=mix(BRange.x, BRange.y, brdfLookup.g);brdfLookup.b=mix(RiRange.x,RiRange.y,brdfLookup.b);return brdfLookup.rgb;}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
const float constant1_FON=0.5-2.0/(3.0*PI);const float constant2_FON=2.0/3.0-28.0/(15.0*PI);float E_FON_approx(float mu,float roughness)
{float sigma=roughness; 
float mucomp=1.0-mu;float mucomp2=mucomp*mucomp;const mat2 Gcoeffs=mat2(0.0571085289,-0.332181442,
0.491881867,0.0714429953);float GoverPi=dot(Gcoeffs*vec2(mucomp,mucomp2),vec2(1.0,mucomp2));return (1.0+sigma*GoverPi)/(1.0+constant1_FON*sigma);}
vec3 diffuseBRDF_EON(vec3 albedo,float roughness,float NdotL,float NdotV,float LdotV)
{vec3 rho=albedo;float sigma=roughness; 
float mu_i=NdotL; 
float mu_o=NdotV; 
float s=LdotV-mu_i*mu_o; 
float sovertF=s>0.0 ? s/max(mu_i,mu_o) : s; 
float AF=1.0/(1.0+constant1_FON*sigma); 
vec3 f_ss=(rho*RECIPROCAL_PI)*AF*(1.0+sigma*sovertF); 
float EFo=E_FON_approx(mu_o,sigma); 
float EFi=E_FON_approx(mu_i,sigma); 
float avgEF=AF*(1.0+constant2_FON*sigma); 
vec3 rho_ms=(rho*rho)*avgEF/(vec3(1.0)-rho*(1.0-avgEF));const float eps=1.0e-7;vec3 f_ms=(rho_ms*RECIPROCAL_PI)*max(eps,1.0-EFo) 
* max(eps,1.0-EFi)
/ max(eps,1.0-avgEF);return (f_ss+f_ms);}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
#endif 
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},63346:function(e,t,i){var r=i(68415);let n="pbrBlockImageProcessing",a=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},17404:function(e,t,i){var r=i(68415);let n="pbrBlockNormalGeometric",a=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},27724:function(e,t,i){var r=i(68415);let n="pbrBlockPrePass",a=`#if SCENE_MRT_COUNT>0
float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;
#else
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#elif defined(PREPASS_COLOR)
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
gl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},14152:function(e,t,i){var r=i(68415);let n="pbrDebug",a=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallic);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=baseSpecularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},52437:function(e,t,i){var r=i(68415);let n="pbrDirectLightingFalloffFunctions",a=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_IES(vec3 lightDirection,vec3 directionToLightCenterW,sampler2D iesLightSampler)
{float cosAngle=dot(-lightDirection,directionToLightCenterW);float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},9135:function(e,t,i){var r=i(68415);let n="pbrDirectLightingFunctions",a=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SS_TRANSLUCENCY
vec3 diffuseTransmission;
#endif
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaDiffuseLighting(preLightingInfo info,vec3 lightColor) {return info.areaLightDiffuse*lightColor;}
#endif
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {vec3 diffuseTerm=vec3(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
vec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {vec3 transmittanceNdotL=vec3(0.);float NdotL=absEps(info.NdotLUnclamped);
#ifndef SS_TRANSLUCENCY_LEGACY
if (info.NdotLUnclamped<0.0) {
#endif
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
#ifndef SS_TRANSLUCENCY_LEGACY
}
vec3 diffuseTerm=vec3(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
vec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
#else
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
#endif
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 fresnel,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaSpecularLighting(preLightingInfo info,vec3 specularColor,vec3 reflectance0,vec3 reflectance90) {vec3 fresnel=specularColor*info.areaLightFresnel.x*reflectance0+( vec3( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#ifdef FUZZ
float evalFuzz(vec3 L,float NdotL,float NdotV,vec3 T,vec3 B,vec3 ltcLut)
{if (NdotL<=0.0 || NdotV<=0.0)
return 0.0;mat3 M=mat3(
vec3(ltcLut.r,0.0,0.0),
vec3(ltcLut.g,1.0,0.0),
vec3(0.0,0.0,1.0)
);vec3 Llocal=vec3(dot(L,T),dot(L,B),NdotL);vec3 Lwarp=normalize(M*Llocal);float cosThetaWarp=max(Lwarp.z,0.0);return cosThetaWarp*NdotL;}
#endif
#if defined(ANISOTROPIC) && defined(ANISOTROPIC_OPENPBR)
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=vec3(distribution*smithVisibility);return specTerm*info.attenuation*info.NdotL*lightColor;}
#elif defined(ANISOTROPIC)
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},39564:function(e,t,i){var r=i(68415);i(9709);let n="pbrDirectLightingSetupFunctions",a=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float LdotV;float roughness;float diffuseRoughness;vec3 surfaceAlbedo;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 areaLightDiffuse;
#ifdef SPECULARTERM
vec3 areaLightSpecular;vec4 areaLightFresnel;
#endif
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;preLightingInfo computeAreaPreLightingInfo(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec4 lightData,vec3 halfWidth,vec3 halfHeight,float roughness )
{preLightingInfo result;result.lightOffset=lightData.xyz-vPosition;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightData.xyz,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse=data.Diffuse;result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},61133:function(e,t,i){var r=i(68415);i(51465);let n="pbrFragmentExtraDeclaration",a=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},61198:function(e,t,i){var r=i(68415);let n="pbrHelperFunctions",a=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#elif ANISOTROPIC_OPENPBR
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=alphaG*sqrt(2.0/(1.0+(1.0-anisotropy)*(1.0-anisotropy)));float alphaB=max(alphaT*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},23821:function(e,t,i){var r=i(68415);let n="pbrIBLFunctions",a=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},53271:function(e,t,i){var r=i(68415);i(44243),i(58950);let n="pbrUboDeclaration",a=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec2 vBaseWeightInfos;vec2 vBaseDiffuseRoughnessInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec3 vBumpInfos;mat4 albedoMatrix;mat4 baseWeightMatrix;mat4 baseDiffuseRoughnessMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;vec4 vAlbedoColor;float baseWeight;float baseDiffuseRoughness;vec4 vLightingIntensity;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec4 cameraInfo;vec2 vReflectionInfos;mat4 reflectionMatrix;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vReflectionFilteringInfo;vec3 vReflectionDominantDirection;vec3 vReflectionColor;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},37863:function(e,t,i){var r=i(68415);let n="prePassDeclaration",a=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_LOCAL_POSITION
varying highp vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying highp float vNormViewDepth;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},22149:function(e,t,i){var r=i(68415);let n="prePassVertex",a=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
vNormViewDepth=((view*worldPos).z-cameraInfo.x)/(cameraInfo.y-cameraInfo.x);
#endif
#ifdef PREPASS_LOCAL_POSITION
vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},46189:function(e,t,i){var r=i(68415);let n="prePassVertexDeclaration",a=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying float vNormViewDepth;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},94538:function(e,t,i){i.r(t),i.d(t,{reflectionFunction:()=>o});var r=i(68415);let n="reflectionFunction",a=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},23355:function(e,t,i){var r=i(68415);let n="samplerFragmentDeclaration",a=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},16833:function(e,t,i){var r=i(68415);let n="samplerVertexDeclaration",a=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},1987:function(e,t,i){var r=i(68415);let n="samplerVertexImplementation",a=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2Updated,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},91635:function(e,t,i){var r=i(68415);let n="sceneFragmentDeclaration",a=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},44243:function(e,t,i){var r=i(68415);let n="sceneUboDeclaration",a=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},70345:function(e,t,i){var r=i(68415);let n="sceneVertexDeclaration",a=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},24768:function(e,t,i){var r=i(68415);let n="screenSpaceRayTrace",a=`float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
float linearizeDepth(float depth,float near,float far) {
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
return -(near*far)/(far-depth*(far-near));
#else
return (near*far)/(far-depth*(far-near));
#endif
}
#endif
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera
param stride Step in horizontal or vertical pixels between samples. This is a float
because integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPoint Camera space location of the ray hit
*/
#define inline
bool traceScreenSpaceRay1(
vec3 csOrigin,
vec3 csDirection,
mat4 projectToPixelMatrix,
sampler2D csZBuffer,
vec2 csZBufferSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
sampler2D csZBackBuffer,
float csZBackSizeFactor,
#endif
float csZThickness,
float nearPlaneZ,
float farPlaneZ,
float stride,
float jitterFraction,
float maxSteps,
float maxRayTraceDistance,
float selfCollisionNumSkip,
out vec2 startPixel,
out vec2 hitPixel,
out vec3 csHitPoint,
out float numIterations
#ifdef SSRAYTRACE_DEBUG
,out vec3 debugColor
#endif
)
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#else
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#endif
vec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
float xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||
(pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0; 
pqk+=dPQK,++stepCount)
{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
float t=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
if (sceneZMax==0.0) sceneZMax=1e8;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) sceneBackZ=-1e8;hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) sceneBackZ=1e8;hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
(refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=-projection[2].z*depth+projection[3].z;
#else
ndc.z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=projection[2].z*depth+projection[3].z;
#else
ndc.z=projection[2].z+projection[3].z/depth;
#endif
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},90413:function(e,t,i){i.r(t),i.d(t,{shadowMapFragment:()=>o});var r=i(68415);let n="shadowMapFragment",a=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
depthSM=clamp(depthSM,0.0,1.0);
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},42180:function(e,t,i){var r=i(68415);i(51171);let n="bayerDitherFunctions",a=`float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}
float bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
float bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o="shadowMapFragmentExtraDeclaration",s=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform vec2 softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;r.l.IncludesShadersStore[o]||(r.l.IncludesShadersStore[o]=s)},59289:function(e,t,i){var r=i(68415);i(44243),i(58950);let n="shadowMapUboDeclaration",a=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},64264:function(e,t,i){var r=i(68415);i(70345);let n="meshVertexDeclaration",a=`uniform mat4 world;uniform float visibility;
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o="shadowMapVertexDeclaration",s=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;r.l.IncludesShadersStore[o]||(r.l.IncludesShadersStore[o]=s)},34913:function(e,t,i){var r=i(68415);let n="shadowMapVertexExtraDeclaration",a=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},74859:function(e,t,i){i.r(t),i.d(t,{shadowMapVertexMetric:()=>o});var r=i(68415);let n="shadowMapVertexMetric",a=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},5029:function(e,t,i){var r=i(68415);let n="shadowMapVertexNormalBias",a=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},39505:function(e,t,i){i.r(t),i.d(t,{shadowsFragmentFunctions:()=>o});var r=i(68415);let n="shadowsFragmentFunctions",a=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define SMALLEST_ABOVE_ZERO 1.1754943508e-38
#define GREATEST_LESS_THAN_ONE 0.99999994
#define DISABLE_UNIFORMITY_ANALYSIS
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
#ifdef USE_REVERSE_DEPTHBUFFER
uvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);
#else
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
#endif
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
#ifdef USE_REVERSE_DEPTHBUFFER
uvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);
#else
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
#endif
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
#ifdef USE_REVERSE_DEPTHBUFFER
uvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);
#else
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
#endif
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
#ifdef USE_REVERSE_DEPTHBUFFER
uvDepth.z=clamp(ZINCLIP,SMALLEST_ABOVE_ZERO,1.);
#else
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
#endif
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},75180:function(e,t,i){i.r(t),i.d(t,{shadowsVertex:()=>o});var r=i(68415);let n="shadowsVertex",a=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a);let o={name:n,shader:a}},10119:function(e,t,i){var r=i(68415);let n="subSurfaceScatteringFunctions",a=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},82276:function(e,t,i){var r=i(68415);let n="uvAttributeDeclaration",a=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},62930:function(e,t,i){var r=i(68415);let n="uvVariableDeclaration",a=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},40888:function(e,t,i){var r=i(68415);let n="vertexColorMixing",a=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=colorUpdated;
#else
vColor.rgb*=colorUpdated.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a)},66903:function(e,t,i){i.r(t),i.d(t,{chromaticAberrationPixelShader:()=>o});var r=i(68415);let n="chromaticAberrationPixelShader",a=`uniform sampler2D textureSampler; 
uniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);vec4 r=texture2D(textureSampler,ref_coords_r);vec4 g=texture2D(textureSampler,ref_coords_g);vec4 b=texture2D(textureSampler,ref_coords_b);float a=clamp(r.a+g.a+b.a,0.,1.);gl_FragColor=vec4(r.r,g.g,b.b,a);}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},55601:function(e,t,i){i.r(t),i.d(t,{colorPixelShader:()=>o});var r=i(68415);i(71531),i(27115),i(32887),i(93911);let n="colorPixelShader",a=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#include<fogFragment>(color,gl_FragColor)
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},88923:function(e,t,i){i.r(t),i.d(t,{colorVertexShader:()=>o});var r=i(68415);i(44218),i(2608),i(97425),i(6769),i(47995),i(45969),i(15546),i(55750),i(57457),i(77553),i(40888);let n="colorVertexShader",a=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform mat4 view;
#endif
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},48458:function(e,t,i){i.r(t),i.d(t,{defaultPixelShader:()=>l});var r=i(68415);i(80960);let n="defaultFragmentDeclaration",a=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#if defined(REFLECTION) || (defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED))
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(17590),i(37863),i(62059),i(51465),i(34450),i(91055),i(35239),i(22649),i(39505),i(23355),i(40604),i(94538),i(62097),i(9704),i(38181),i(98846),i(71531),i(20142),i(27115),i(32887),i(20003),i(71734),i(84380),i(66515),i(88040),i(93911),i(72711);let o="defaultPixelShader",s=`#define CUSTOM_FRAGMENT_EXTENSION
#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;float aggShadow=0.;float numLights=0.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#if SCENE_MRT_COUNT>0
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
gl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.l.ShadersStore[o]||(r.l.ShadersStore[o]=s);let l={name:o,shader:s}},21173:function(e,t,i){i.r(t),i.d(t,{defaultVertexShader:()=>l});var r=i(68415);i(66378);let n="defaultVertexDeclaration",a=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
uniform vec4 cameraInfo;
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(17590),i(82276),i(34450),i(44218),i(2608),i(47995),i(46189),i(51465),i(16833),i(3106),i(97425),i(6769),i(19541),i(56393),i(26680),i(70637),i(20142),i(12030),i(91141),i(45969),i(15546),i(55750),i(22149),i(62930),i(1987),i(87805),i(57457),i(77553),i(75180),i(40888),i(30614),i(11142);let o="defaultVertexShader",s=`#define CUSTOM_VERTEX_EXTENSION
#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
vViewDepth=(view*worldPos).z;
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;r.l.ShadersStore[o]||(r.l.ShadersStore[o]=s);let l={name:o,shader:s}},70046:function(e,t,i){var r=i(68415);let n="depthOfFieldPixelShader",a=`uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; 
uniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;
#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1 
vec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)
{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}
vec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}
float sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}
float getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}
vec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}
if (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}
col/=total_weight; 
if (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}
return col;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); 
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); 
float depth=texture2D(depthSampler,distorted_coords).r; 
float distance=near+(far-near)*depth; 
vec4 color=texture2D(textureSampler,vUV); 
float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }
float edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}
float blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}
else {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}
if (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}
if (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},12617:function(e,t,i){var r=i(68415);let n="equirectangularPanoramaPixelShader",a=`#ifdef GL_ES
precision highp float;
#endif
#define M_PI 3.1415926535897932384626433832795
varying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(
- sin( longitude )*sin( latitude ),
cos( latitude ),
- cos( longitude )*sin( latitude )
);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},64530:function(e,t,i){i.r(t),i.d(t,{gaussianSplattingPixelShader:()=>l});var r=i(68415);i(71531),i(20142),i(27115),i(88040),i(93911);let n="gaussianSplattingFragmentDeclaration",a=`vec4 gaussianColor(vec4 inColor)
{float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*inColor.a;
#include<logDepthFragment>
vec3 color=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4(color,B);}
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(32887);let o="gaussianSplattingPixelShader",s=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplattingFragmentDeclaration>
void main () { 
#include<clipPlaneFragment>
gl_FragColor=gaussianColor(vColor);}
`;r.l.ShadersStore[o]||(r.l.ShadersStore[o]=s);let l={name:o,shader:s}},30425:function(e,t,i){i.r(t),i.d(t,{gaussianSplattingVertexShader:()=>o});var r=i(68415);i(25554),i(96590),i(97425),i(6769),i(20142),i(34450),i(28790),i(57457),i(77553),i(11142);let n="gaussianSplattingVertexShader",a=`#include<__decl__gaussianSplattingVertex>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform float kernelSize;uniform vec3 eyePosition;uniform vec3 viewDirectionFactor;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;
#if SH_DEGREE>0
uniform highp usampler2D shTexture0;
#endif
#if SH_DEGREE>1
uniform highp usampler2D shTexture1;
#endif
#if SH_DEGREE>2
uniform highp usampler2D shTexture2;
#endif
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplatting>
void main () {float splatIndex=getSplatIndex(int(position.z+0.5));Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPos=world*vec4(splat.center.xyz,1.0);vColor=splat.color;vPosition=position.xy;
#if SH_DEGREE>0
mat3 worldRot=mat3(world);mat3 normWorldRot=inverseMat3(worldRot);vec3 dir=normalize(normWorldRot*(worldPos.xyz-eyePosition));dir*=viewDirectionFactor;vColor.xyz=splat.color.xyz+computeSH(splat,dir);
#endif
gl_Position=gaussianSplatting(position.xy,worldPos.xyz,vec2(1.,1.),covA,covB,world,view,projection);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},9248:function(e,t,i){var r=i(68415);let n="gaussianSplattingDepthPixelShader",a=`precision highp float;varying vec2 vPosition;varying vec4 vColor;void main(void) {float A=-dot(vPosition,vPosition);
#if defined(SM_SOFTTRANSPARENTSHADOW) && SM_SOFTTRANSPARENTSHADOW==1
float alpha=exp(A)*vColor.a;if (A<-4.) discard;
#else
if (A<-1.) discard;
#endif
}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},43118:function(e,t,i){var r=i(68415);i(25554),i(96590),i(28790);let n="gaussianSplattingDepthVertexShader",a=`#include<__decl__gaussianSplattingVertex>
uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform float kernelSize;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;varying vec2 vPosition;varying vec4 vColor;
#include<gaussianSplatting>
void main(void) {float splatIndex=getSplatIndex(int(position.z+0.5));Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPosGS=world*vec4(splat.center.xyz,1.0);vPosition=position.xy;vColor=splat.color;gl_Position=gaussianSplatting(position.xy,worldPosGS.xyz,vec2(1.,1.),covA,covB,world,view,projection);}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},91149:function(e,t,i){var r=i(68415);let n="clipPlaneFragmentDeclaration2",a=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(62097),i(20142),i(34450),i(9704),i(27115),i(32887),i(88040),i(93911);let o="gpuRenderParticlesPixelShader",s=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#include<fogFragmentDeclaration>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#include<fogFragment>(color,gl_FragColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;r.l.ShadersStore[o]||(r.l.ShadersStore[o]=s)},1763:function(e,t,i){var r=i(68415);let n="clipPlaneVertexDeclaration2",a=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;out float fClipDistance6;
#endif
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(6769),i(20142),i(57457),i(77553),i(11142);let o="gpuRenderParticlesVertexShader",s=`precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;attribute float age;attribute float life;attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=min(1.0,age/life);
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x;
#ifdef BILLBOARD
vec4 rotatedCorner;rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}`;r.l.ShadersStore[o]||(r.l.ShadersStore[o]=s)},60552:function(e,t,i){var r=i(68415);let n="gpuTransformPixelShader",a=`#version 300 es
void main() {discard;}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},61254:function(e,t,i){var r=i(68415);i(44218),i(2608),i(26680),i(70637),i(12030),i(91141),i(15546),i(55750);let n="gpuTransformVertexShader",a=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
out vec3 outPosition;const mat4 identity=mat4(
vec4(1.0,0.0,0.0,0.0),
vec4(0.0,1.0,0.0,0.0),
vec4(0.0,0.0,1.0,0.0),
vec4(0.0,0.0,0.0,1.0)
);void main(void) {vec3 positionUpdated=position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
mat4 finalWorld=identity;
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);outPosition=worldPos.xyz;}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},49668:function(e,t,i){var r=i(68415);let n="gpuUpdateParticlesPixelShader",a=`#version 300 es
void main() {discard;}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},20162:function(e,t,i){var r=i(68415);let n="gpuUpdateParticlesVertexShader",a=`#version 300 es
#define PI 3.14159
uniform float currentCount;uniform float timeDelta;uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;
#ifdef FLOWMAP
uniform mat4 flowMapProjection;uniform float flowMapStrength;uniform sampler2D flowMapSampler;
#endif
#ifndef COLORGRADIENTS
uniform vec4 color1;uniform vec4 color2;
#endif
uniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;uniform float radiusRange;uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;uniform float height;uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;uniform float coneAngle;uniform vec2 height;
#ifdef DIRECTEDCONEEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;in float life;in vec4 seed;in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}
vec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}
void main() {float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); 
vec3 randoms3=getRandomVec3(seed.z);
#ifdef DIRECTEDCONEEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
if (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef FLOWMAP
vec4 clipSpace=(flowMapProjection*vec4(position,1.));vec3 ndcSpace=clipSpace.xyz/clipSpace.w;vec2 flowMapUV=ndcSpace.xy*0.5+0.5;vec4 flowMapValue=texture(flowMapSampler,flowMapUV);vec3 flowMapDirection=(flowMapValue.xyz*2.0-1.0)*flowMapValue.w;updatedDirection+=flowMapDirection*timeDelta*flowMapStrength;
#endif
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}
else {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},82386:function(e,t,i){i.r(t),i.d(t,{imageProcessingPixelShader:()=>o});var r=i(68415);i(62097),i(34450),i(9704);let n="imageProcessingPixelShader",a=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 result=texture2D(textureSampler,vUV);result.rgb=max(result.rgb,vec3(0.));
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},59045:function(e,t,i){var r=i(68415);let n="lensHighlightsPixelShader",a=`uniform sampler2D textureSampler; 
uniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}
float w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;gl_FragColor=blurred;}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},96525:function(e,t,i){i.r(t),i.d(t,{lightProxyPixelShader:()=>o});var r=i(68415);let n="lightProxyPixelShader",a=`flat varying vec2 vLimits;flat varying highp uint vMask;void main(void) {if (gl_FragCoord.y<vLimits.x || gl_FragCoord.y>vLimits.y) {discard;}
gl_FragColor=vec4(vMask,0,0,1);}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},77824:function(e,t,i){i.r(t),i.d(t,{lightProxyVertexShader:()=>o});var r=i(68415);i(70345),i(44243),i(84959);let n="lightProxyVertexShader",a=`attribute vec3 position;flat varying vec2 vLimits;flat varying highp uint vMask;
#include<__decl__sceneVertex>
uniform sampler2D lightDataTexture;uniform vec3 tileMaskResolution;
#include<clusteredLightingFunctions>
void main(void) {ClusteredLight light=getClusteredLight(lightDataTexture,gl_InstanceID);float range=light.vLightFalloff.x;vec4 viewPosition=view*vec4(light.vLightData.xyz,1);vec4 viewPositionSq=viewPosition*viewPosition;vec2 distSq=viewPositionSq.xy+viewPositionSq.z;vec2 sinSq=(range*range)/distSq;vec2 cosSq=max(1.0-sinSq,0.01);vec2 sinCos=position.xy*sqrt(sinSq*cosSq);vec2 rotatedX=mat2(cosSq.x,-sinCos.x,sinCos.x,cosSq.x)*viewPosition.xz;vec2 rotatedY=mat2(cosSq.y,-sinCos.y,sinCos.y,cosSq.y)*viewPosition.yz;vec4 projX=projection*vec4(rotatedX.x,0,rotatedX.y,1);vec4 projY=projection*vec4(0,rotatedY.x,rotatedY.y,1);vec2 projPosition=vec2(projX.x/max(projX.w,0.01),projY.y/max(projY.w,0.01));projPosition=mix(position.xy,projPosition,greaterThan(cosSq,vec2(0.01)));vec2 halfTileRes=tileMaskResolution.xy/2.0;vec2 tilePosition=(projPosition+1.0)*halfTileRes;tilePosition=mix(floor(tilePosition)-0.01,ceil(tilePosition)+0.01,greaterThan(position.xy,vec2(0)));float offset=float(gl_InstanceID/CLUSTLIGHT_BATCH)*tileMaskResolution.y;tilePosition.y=(tilePosition.y+offset)/tileMaskResolution.z;gl_Position=vec4(tilePosition/halfTileRes-1.0,0,1);vLimits=vec2(offset,offset+tileMaskResolution.y);vMask=1u<<(gl_InstanceID % CLUSTLIGHT_BATCH);}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},81458:function(e,t,i){var r=i(68415);let n="noisePixelShader",a=`uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)
{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}
float interpolationNoise(vec2 p)
{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); 
return ym;}
float perlinNoise2D(float x,float y)
{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)
{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}
return sum;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},74265:function(e,t,i){i.r(t),i.d(t,{pbrPixelShader:()=>Q});var r=i(68415);i(37863),i(62059),i(80960);let n="pbrFragmentDeclaration",a=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform float baseWeight;uniform float baseDiffuseRoughness;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef BASE_WEIGHT
uniform vec2 vBaseWeightInfos;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)
uniform vec3 vReflectionDominantDirection;
#endif
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize;
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(53271),i(61133),i(91055),i(35239),i(23355);let o="samplerFragmentAlternateDeclaration",s=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;r.l.IncludesShadersStore[o]||(r.l.IncludesShadersStore[o]=s);let l="pbrFragmentSamplersDeclaration",c=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfSampler;
#endif
`;r.l.IncludesShadersStore[l]||(r.l.IncludesShadersStore[l]=c),i(62097),i(71531),i(20142),i(27115),i(34450),i(10119),i(7620),i(61198),i(9704),i(39505),i(32270),i(39564),i(52437),i(31896),i(69342),i(9135),i(23821),i(38181),i(98846),i(94538),i(71734);let f="pbrBlockAlbedoOpacity",u=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
albedoOpacityOutParams albedoOpacityBlock(
in vec4 vAlbedoColor
#ifdef ALBEDO
,in vec4 albedoTexture
,in vec2 albedoInfos
#endif
,in float baseWeight
#ifdef BASE_WEIGHT
,in vec4 baseWeightTexture
,in vec2 vBaseWeightInfos
#endif
#ifdef OPACITY
,in vec4 opacityMap
,in vec2 vOpacityInfos
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
#ifdef DECAL
,in vec4 decalColor
,in vec4 vDecalInfos
#endif
)
{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASE_WEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;r.l.IncludesShadersStore[f]||(r.l.IncludesShadersStore[f]=u);let d="pbrBlockReflectivity",h=`struct reflectivityOutParams
{float microSurface;float roughness;float diffuseRoughness;float reflectanceF0;vec3 reflectanceF90;vec3 colorReflectanceF0;vec3 colorReflectanceF90;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;float metallic;float specularWeight;vec3 dielectricColorF0;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
vec3 metallicF0;
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
reflectivityOutParams reflectivityBlock(
in vec4 reflectivityColor
#ifdef METALLICWORKFLOW
,in vec3 surfaceAlbedo
,in vec4 metallicReflectanceFactors
#endif
,in float baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,in float baseDiffuseRoughnessTexture
,in vec2 baseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,in vec3 reflectivityInfos
,in vec4 surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,in vec3 ambientOcclusionColorIn
#endif
#ifdef MICROSURFACEMAP
,in vec4 microSurfaceTexel
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
)
{reflectivityOutParams outParams;float microSurface=reflectivityColor.a;vec3 surfaceReflectivityColor=reflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;float ior=surfaceReflectivityColor.b;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;float dielectricF0=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=vec3(dielectricF0)*surfaceReflectivityColor;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo=baseColor.rgb*(vec3(1.0)-vec3(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);
#else
outParams.surfaceAlbedo=baseColor.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
{vec3 reflectivityColor=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}
#else
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
float maxF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0,outParams.metallic);
#else
outParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.reflectanceF90=vec3(outParams.specularWeight);float f90Scale=1.0;
#else
float f90Scale=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(outParams.specularWeight*f90Scale,1.0,outParams.metallic));
#endif
outParams.dielectricColorF0=vec3(dielectricF0*surfaceReflectivityColor);vec3 metallicColorF0=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
vec3 dielectricColorF90=surfaceReflectivityColor*vec3(outParams.specularWeight)*vec3(f90Scale);
#else
vec3 dielectricColorF90=vec3(outParams.specularWeight*f90Scale);
#endif
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 conductorColorF90=surfaceReflectivityColor;
#else
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
vec3 conductorColorF90=outParams.reflectanceF90;
#else
vec3 conductorColorF90=vec3(1.0);
#endif
#endif
outParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
outParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3(1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
outParams.colorReflectanceF90=surfaceReflectivityColor;
#else
outParams.colorReflectanceF90=vec3(1.0);
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;float diffuseRoughness=baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
diffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;
#endif
outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}
`;r.l.IncludesShadersStore[d]||(r.l.IncludesShadersStore[d]=h);let p="pbrBlockAmbientOcclusion",m=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;r.l.IncludesShadersStore[p]||(r.l.IncludesShadersStore[p]=m);let _="pbrBlockAlphaFresnel",g=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
alphaFresnelOutParams alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface
)
{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;r.l.IncludesShadersStore[_]||(r.l.IncludesShadersStore[_]=g);let v="pbrBlockAnisotropic",S=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
anisotropicOutParams anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW
)
{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;r.l.IncludesShadersStore[v]||(r.l.IncludesShadersStore[v]=S);let E="pbrBlockReflection",T=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
reflectionOutParams reflectionBlock(
in vec3 vPositionW
,in vec3 normalW
,in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,in float NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,in float roughness
#endif
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,in mat4 reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,in vec3 reflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
,in vec3 viewDirectionW
,in float diffuseRoughness
,in vec3 surfaceAlbedo
)
{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
vec3 irradianceView=vec3(reflectionMatrix*vec4(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
float NdotV=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,irradianceVector);
#else
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
vec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;r.l.IncludesShadersStore[E]||(r.l.IncludesShadersStore[E]=T);let A="pbrBlockSheen",x=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
sheenOutParams sheenBlock(
in vec4 vSheenColor
#ifdef SHEEN_ROUGHNESS
,in float vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 sheenMapRoughnessData
#endif
#endif
,in float roughness
#ifdef SHEEN_TEXTURE
,in vec4 sheenMapData
,in float sheenMapLevel
#endif
,in float reflectance
#ifdef SHEEN_LINKWITHALBEDO
,in vec3 baseColor
,in vec3 surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,in float NdotV
,in vec3 environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,in vec2 AARoughnessFactors
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,in vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,in vec2 reflectionCoords
#endif
,in float NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,in float seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,in float eho
#endif
#endif
)
{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;r.l.IncludesShadersStore[A]||(r.l.IncludesShadersStore[A]=x);let I="pbrBlockClearcoat",R=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
clearcoatOutParams clearcoatBlock(
in vec3 vPositionW
,in vec3 geometricNormalW
,in vec3 viewDirectionW
,in vec2 vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 clearCoatMapRoughnessData
#endif
,in vec3 specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,in vec4 vClearCoatTintParams
,in float clearCoatColorAtDistance
,in vec4 vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,in vec4 clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,in vec2 vClearCoatBumpInfos
,in vec4 clearCoatBumpMapData
,in vec2 vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,in mat3 vTBN
#else
,in vec2 vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,in mat4 normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,in vec3 faceNormal
#endif
#ifdef REFLECTION
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,in float frontFacingMultiplier
#endif
)
{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;r.l.IncludesShadersStore[I]||(r.l.IncludesShadersStore[I]=R);let C="pbrBlockIridescence",b=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
iridescenceOutParams iridescenceBlock(
in vec4 vIridescenceParams
,in float viewAngle
,in vec3 specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,in vec2 iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,in vec2 iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,in float NdotVUnclamped
,in vec2 vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#endif
)
{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;r.l.IncludesShadersStore[C]||(r.l.IncludesShadersStore[C]=b);let y="pbrBlockSubSurface",L=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
float refractionOpacity;
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
subSurfaceOutParams subSurfaceBlock(
in vec3 vSubSurfaceIntensity
,in vec2 vThicknessParam
,in vec4 vTintColor
,in vec3 normalW
,in vec3 vSpecularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,in vec4 thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,in vec4 refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,in vec4 translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,in mat4 reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in vec3 irradianceVector_
#endif
#if defined(REALTIME_FILTERING)
,in samplerCube reflectionSampler
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,in vec3 surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in vec4 vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,in float alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,in float NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,in float roughness
#endif
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
#ifdef SS_DISPERSION
,in float dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,in vec3 vDiffusionDistance
,in vec4 vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,in vec4 translucencyColorMap
#endif
#endif
)
{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=vSpecularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo*=outParams.refractionOpacity;
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*vSpecularEnvironmentReflectance)/(1.0+vSpecularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,vSpecularEnvironmentReflectance,refractionIntensity);
#endif
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3(1.0)-vSpecularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
return outParams;}
#endif
`;r.l.IncludesShadersStore[y]||(r.l.IncludesShadersStore[y]=L),i(84959);let M="pbrBlockReflectance0",P=`float reflectanceF0=reflectivityOut.reflectanceF0;vec3 specularEnvironmentR0=reflectivityOut.colorReflectanceF0;vec3 specularEnvironmentR90=reflectivityOut.colorReflectanceF90;
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;r.l.IncludesShadersStore[M]||(r.l.IncludesShadersStore[M]=P);let N="pbrClusteredLightingFunctions",D=`#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
#define inline
lightingInfo computeClusteredLighting(
sampler2D lightDataTexture,
sampler2D tileMaskTexture,
vec4 lightData,
ivec2 sliceRange,
vec3 V,
vec3 N,
vec3 posW,
vec3 surfaceAlbedo,
reflectivityOutParams reflectivityOut
#ifdef IRIDESCENCE
,float iridescenceIntensity
#endif
#ifdef SS_TRANSLUCENCY
,subSurfaceOutParams subSurfaceOut
#endif
#ifdef SPECULARTERM
,float AARoughnessFactor
#endif
#ifdef ANISOTROPIC
,anisotropicOutParams anisotropicOut
#endif
#ifdef SHEEN
,sheenOutParams sheenOut
#endif
#ifdef CLEARCOAT
,clearcoatOutParams clearcoatOut
#endif
) {float NdotV=absEps(dot(N,V));
#include<pbrBlockReflectance0>
#ifdef CLEARCOAT
specularEnvironmentR0=clearcoatOut.specularEnvironmentR0;
#endif
lightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);preLightingInfo preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if (light.vLightDirection.w>=0.0) {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}
preInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
lightingInfo info;
#ifdef SS_TRANSLUCENCY
#ifdef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR
vec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);vec3 coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);
#else
vec3 coloredFresnel=fresnelSchlickGGX(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
float NdotH=dot(N,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
float absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
result.diffuse+=info.diffuse;
#ifdef SS_TRANSLUCENCY
result.diffuseTransmission+=info.diffuseTransmission;
#endif
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
#ifdef CLEARCOAT
result.clearCoat+=info.clearCoat;
#endif
#ifdef SHEEN
result.sheen+=info.sheen;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;r.l.IncludesShadersStore[N]||(r.l.IncludesShadersStore[N]=D),i(32887),i(17404),i(20003);let O="pbrBlockNormalFinal",F=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=gl_FrontFacing ? -normalW : normalW;
#else
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#endif
`;r.l.IncludesShadersStore[O]||(r.l.IncludesShadersStore[O]=F),i(84380);let w="pbrBlockLightmapInit",B=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;r.l.IncludesShadersStore[w]||(r.l.IncludesShadersStore[w]=B);let U="pbrBlockGeometryInfo",G=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;r.l.IncludesShadersStore[U]||(r.l.IncludesShadersStore[U]=G);let V="pbrBlockReflectance",k=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 baseSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(reflectanceF0),reflectivityOut.reflectanceF90,environmentBrdf);
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 metalEnvironmentReflectance=reflectivityOut.specularWeight*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricEnvironmentReflectance=getReflectanceFromBRDFLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);vec3 colorSpecularEnvironmentReflectance=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);
#else
vec3 colorSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);
#endif
#ifdef RADIANCEOCCLUSION
colorSpecularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
colorSpecularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 colorSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));vec3 baseSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3(reflectanceF0),reflectivityOut.reflectanceF90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
colorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
colorSpecularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;r.l.IncludesShadersStore[V]||(r.l.IncludesShadersStore[V]=k);let z="pbrBlockDirectLighting",H=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SS_TRANSLUCENCY
vec3 diffuseTransmissionBase=vec3(0.,0.,0.);
#endif
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
#if defined(SPECULARTERM) && defined(LIGHT0)
vec3 coloredFresnel;
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;r.l.IncludesShadersStore[z]||(r.l.IncludesShadersStore[z]=H),i(66515);let W="pbrBlockFinalLitComponents",X=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 baseSpecularEnergyConservationFactor=getEnergyConservationFactor(vec3(reflectanceF0),environmentBrdf);vec3 coloredEnergyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectanceF0)*surfaceAlbedo.rgb;
#endif
#endif
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)
vec3 baseSpecularEnergy=vec3(baseSpecularEnvironmentReflectance);
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
baseSpecularEnergy*=baseSpecularEnergyConservationFactor;
#endif
#endif
finalIrradiance*=clamp(vec3(1.0)-baseSpecularEnergy,0.0,1.0);
#endif
#endif
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;r.l.IncludesShadersStore[W]||(r.l.IncludesShadersStore[W]=X);let Y="pbrBlockFinalUnlitComponents",$=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo;
#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)
finalDiffuse*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)
finalDiffuse+=diffuseTransmissionBase;
#endif
finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;r.l.IncludesShadersStore[Y]||(r.l.IncludesShadersStore[Y]=$);let q="pbrBlockFinalColorComposition",Z=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;r.l.IncludesShadersStore[q]||(r.l.IncludesShadersStore[q]=Z),i(88040),i(93911),i(63346),i(27724),i(72711),i(14152);let j="pbrPixelShader",K=`#define PBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_EXTENSION
#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#if SCENE_MRT_COUNT>0
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#endif
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
#include<pbrClusteredLightingFunctions>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef BASE_WEIGHT
vec4 baseWeightTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,vAlbedoInfos
#endif
,baseWeight
#ifdef BASE_WEIGHT
,baseWeightTexture
,vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
#ifdef DECAL
,decalColor
,vDecalInfos
#endif
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else 
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
float baseDiffuseRoughnessTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
reflectivityOut=reflectivityBlock(
vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
,baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture
,vBaseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;float diffuseRoughness=reflectivityOut.diffuseRoughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
vPositionW
,normalW
,alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,vReflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
,viewDirectionW
,diffuseRoughness
,baseColor
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenOut=sheenBlock(
vSheenColor
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,vSheenInfos.y
#endif
,reflectanceF0
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
vPositionW
,geometricNormalW
,viewDirectionW
,vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams
,clearCoatColorAtDistance
,vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos
,clearCoatBumpMapData
,vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,(gl_FrontFacing ? 1. : -1.)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpace(translucencyColorMap);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
vec3 vSpecularEnvironmentReflectance=vec3(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)));
#endif
subSurfaceOut=subSurfaceBlock(
vSubSurfaceIntensity
,vThicknessParam
,vTintColor
,normalW
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
,vSpecularEnvironmentReflectance
#else
,baseSpecularEnvironmentReflectance
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,vPositionW
,viewDirectionW
,view
,vRefractionInfos
,refractionMatrix
,vRefractionMicrosurfaceInfos
,vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,vRefractionPosition
,vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance
,vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.l.ShadersStore[j]||(r.l.ShadersStore[j]=K);let Q={name:j,shader:K}},29248:function(e,t,i){i.r(t),i.d(t,{pbrVertexShader:()=>l});var r=i(68415);i(66378);let n="pbrVertexDeclaration",a=`uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef BASE_WEIGHT
uniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;
#endif
uniform float baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
uniform vec4 cameraInfo;
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;r.l.IncludesShadersStore[n]||(r.l.IncludesShadersStore[n]=a),i(53271),i(82276),i(51465),i(34450),i(31896),i(44218),i(2608),i(47995),i(46189),i(16833),i(32270),i(3106),i(97425),i(6769),i(19541),i(56393),i(26680),i(70637),i(20142),i(12030),i(91141),i(45969),i(15546),i(55750),i(22149),i(62930),i(1987),i(87805),i(57457),i(77553),i(75180),i(40888),i(11142);let o="pbrVertexShader",s=`#define PBR_VERTEX_SHADER
#define CUSTOM_VERTEX_EXTENSION
precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);float NdotV=max(dot(vNormalW,viewDirectionW),0.0);vec3 roughNormal=mix(vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*baseDiffuseRoughness);vec3 reflectionVector=vec3(reflectionMatrix*vec4(roughNormal,0)).xyz;
#else
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
vViewDepth=(view*worldPos).z;
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;r.l.ShadersStore[o]||(r.l.ShadersStore[o]=s);let l={name:o,shader:s}},10703:function(e,t,i){var r=i(68415);let n="refractionPixelShader";r.l.ShadersStore[n]||(r.l.ShadersStore[n]="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}")},25483:function(e,t,i){i.r(t),i.d(t,{screenSpaceCurvaturePixelShader:()=>o});var r=i(68415);let n="screenSpaceCurvaturePixelShader",a=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{if (curvature<0.5/control)
return curvature*(1.0-curvature*control);return 0.25/control;}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},4705:function(e,t,i){var r=i(68415);let n="screenSpaceReflectionPixelShader",a=`uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;
#endif
uniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;
#ifdef SSR_SUPPORTED
struct ReflectionInfo {vec3 color;vec4 coords;};/**
* According to specular,see https:
*/
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}
/**
* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit
* by sampling multiple reflection pixels.
*/
ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)
{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)
hitCoord-=dir;else
hitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}
projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}
/**
* Tests the given world position (hitCoord) according to the given reflection vector (dir)
* until it finds a collision (means that depth is enough close to say "it's the pixel to sample!").
*/
ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)
{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;
#ifdef RIGHT_HANDED_SCENE
depth*=-1.0;
#endif
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;
#endif
}}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}
vec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);
#ifdef RIGHT_HANDED_SCENE
reflected.z*=-1.0;
#endif
float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},40177:function(e,t,i){i.r(t),i.d(t,{sharpenPixelShader:()=>o});var r=i(68415);let n="sharpenPixelShader",a=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},95623:function(e,t,i){var r=i(68415);i(27115),i(20142),i(88040),i(93911);let n="spriteMapPixelShader",a=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
precision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
float mt;const float fdStep=1.0*0.25;const float aFrameSteps=MAX_ANIMATION_FRAMES==0.0 ? 0.0 : 1.0/MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID) {float fX=frameID/spriteCount;return mat4(
TEXTUREFUNC(frameMap,vec2(fX,0.0),0.0),
TEXTUREFUNC(frameMap,vec2(fX,fdStep*1.0),0.0),
TEXTUREFUNC(frameMap,vec2(fX,fdStep*2.0),0.0),
vec4(0.0)
);}
void main() {vec4 color=vec4(0.0);vec2 tileUV=fract(tUV);vec2 tileID=floor(tUV);vec2 sheetUnits=1.0/spriteMapSize;float spriteUnits=1.0/spriteCount;vec2 stageUnits=1.0/stageSize;for(int i=0; i<LAYERS; i++) {float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.0),0.0);if(animationData.y>0.0) {mt=mod(time*animationData.z,1.0);for(float f=0.0; f<MAX_ANIMATION_FRAMES; f++) {if(animationData.y>mt) {frameID=animationData.x;break;}
animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.0);}}
mat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;
#ifdef FR_CW
if (frameData[2].z==1.0) {tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;}
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
#else
if (frameData[2].z==1.0) {
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
}
#endif
vec4 nc=TEXTUREFUNC(spriteSheet,tileUV*frameSize+offset,0.0);if (i==0) {color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}
color.xyz*=colorMul;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},66593:function(e,t,i){var r=i(68415);i(6769),i(20142),i(11142);let n="spriteMapVertexShader",a=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform mat4 world;uniform mat4 view;uniform mat4 projection;uniform vec2 stageSize;uniform float stageScale;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
void main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; 
vec3 viewPos=(view*world*p).xyz; 
gl_Position=projection*vec4(viewPos,1.0); 
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},73704:function(e,t,i){var r=i(68415);let n="ssaoPixelShader",a=`uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)
{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}
void main()
{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)
{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}
float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}
#endif
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},79821:function(e,t,i){i.r(t),i.d(t,{ssaoCombinePixelShader:()=>o});var r=i(68415);let n="ssaoCombinePixelShader",a=`uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 uv=viewport.xy+vUV*viewport.zw;vec4 ssaoColor=texture2D(textureSampler,uv);vec4 sceneColor=texture2D(originalColor,uv);gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},63873:function(e,t,i){var r=i(68415);i(51171);let n="standardPixelShader",a=`uniform sampler2D textureSampler;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
#if defined(PASS_POST_PROCESS)
void main(void)
{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}
gl_FragColor=average;}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)
{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)
{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}
void main(void)
{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)
{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}
accumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;void main(void)
{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];void main()
{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)
{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));
#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}
average=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)
{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()
{vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;
#endif
gl_FragColor=color;}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)
{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}
float noise(in vec2 p)
{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);}
float fbm(vec2 p)
{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}
vec3 pattern(vec2 uv)
{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}
float luminance(vec3 color)
{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);}
void main(void)
{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)
{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}
vec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)
{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)
{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)
factor=1.0;else if (dist<0.1)
factor=20.0*(0.1-dist);else if (dist<0.5)
factor=0.0;else
factor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)
{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}
gl_FragColor=result/float(nSamples);}
#endif
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},68742:function(e,t,i){var r=i(68415);let n="stereoscopicInterlacePixelShader",a=`const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},42622:function(e,t,i){i.r(t),i.d(t,{taaPixelShader:()=>o});var r=i(68415);let n="taaPixelShader",a=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;
#ifdef TAA_REPROJECT_HISTORY
uniform sampler2D velocitySampler;
#endif
uniform float factor;void main() {ivec2 pos=ivec2(gl_FragCoord.xy);vec4 c=texelFetch(textureSampler,pos,0);
#ifdef TAA_REPROJECT_HISTORY
vec4 v=texelFetch(velocitySampler,pos,0);vec4 h=texture2D(historySampler,vUV+v.xy);
#else
vec4 h=texelFetch(historySampler,pos,0);
#endif
#ifdef TAA_CLAMP_HISTORY
vec4 cmin=vec4(1);vec4 cmax=vec4(0);for (int x=-1; x<=1; x+=1) {for (int y=-1; y<=1; y+=1) {vec4 c=texelFetch(textureSampler,pos+ivec2(x,y),0);cmin=min(cmin,c);cmax=max(cmax,c);}}
h=clamp(h,cmin,cmax);
#endif
gl_FragColor=mix(h,c,factor);}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a);let o={name:n,shader:a}},37687:function(e,t,i){var r=i(68415);let n="velocityPixelShader",a=`precision highp float;
#define CUSTOM_FRAGMENT_BEGIN
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
highp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},63473:function(e,t,i){var r=i(68415);i(47995),i(45969);let n="velocityVertexShader",a=`#define CUSTOM_VERTEX_BEGIN
#define VELOCITY
attribute vec3 position;
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform mat4 previousViewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;
#endif
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}
#elif
clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},33874:function(e,t,i){var r=i(68415);let n="volumetricLightScatteringPixelShader",a=`uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}
vec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),realColor.a))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},35045:function(e,t,i){var r=i(68415);let n="volumetricLightScatteringPassPixelShader",a=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},58895:function(e,t,i){var r=i(68415);i(44218),i(2608),i(26680),i(70637),i(47995),i(12030),i(91141),i(45969),i(15546),i(55750);let n="volumetricLightScatteringPassVertexShader",a=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV2)
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
}
`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},5520:function(e,t,i){var r=i(68415);let n="vrMultiviewToSingleviewPixelShader",a=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;r.l.ShadersStore[n]||(r.l.ShadersStore[n]=a)},62894:function(e,t,i){var r=i(68415);i(21968);let n="backgroundUboDeclaration",a=`uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos : vec2f;uniform diffuseMatrix : mat4x4f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;uniform vReflectionInfos : vec2f;uniform reflectionMatrix : mat4x4f;uniform vReflectionMicrosurfaceInfos : vec3f;
#include<sceneUboDeclaration>
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},96510:function(e,t,i){i.r(t),i.d(t,{bumpFragmentWGSL:()=>o});var r=i(68415);let n="bumpFragment",a=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(BUMP)
var normalScale: f32=uniforms.vBumpInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#elif defined(BUMP)
var TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#else
var TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);
#else
var bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},34137:function(e,t,i){i.r(t),i.d(t,{bumpFragmentFunctionsWGSL:()=>o});var r=i(68415);i(85370);let n="bumpFragmentFunctions",a=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},64562:function(e,t,i){i.r(t),i.d(t,{bumpFragmentMainFunctionsWGSL:()=>o});var r=i(68415);let n="bumpFragmentMainFunctions",a=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; 
var a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; 
var a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(
(a11*b11-a12*b10+a13*b09)/det,
(a02*b10-a01*b11-a03*b09)/det,
(a31*b05-a32*b04+a33*b03)/det,
(a22*b04-a21*b05-a23*b03)/det,
(a12*b08-a10*b11-a13*b07)/det,
(a00*b11-a02*b08+a03*b07)/det,
(a32*b02-a30*b05-a33*b01)/det,
(a20*b05-a22*b02+a23*b01)/det,
(a10*b10-a11*b08+a13*b06)/det,
(a01*b08-a00*b10-a03*b06)/det,
(a30*b04-a31*b02+a33*b00)/det,
(a21*b02-a20*b04-a23*b00)/det,
(a11*b07-a10*b09-a12*b06)/det,
(a00*b09-a01*b07+a02*b06)/det,
(a31*b01-a30*b03-a32*b00)/det,
(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{var output=normal;
#ifdef NORMALXYSCALE
output=normalize(output* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*output);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},95284:function(e,t,i){var r=i(68415);let n="bumpVertex",a=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},83218:function(e,t,i){var r=i(68415);let n="bumpVertexDeclaration",a=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},40128:function(e,t,i){i.r(t),i.d(t,{clipPlaneFragmentWGSL:()=>o});var r=i(68415);let n="clipPlaneFragment",a=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fragmentInputs.fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fragmentInputs.fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fragmentInputs.fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fragmentInputs.fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fragmentInputs.fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fragmentInputs.fClipDistance6>0.0)
{discard;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},5430:function(e,t,i){i.r(t),i.d(t,{clipPlaneFragmentDeclarationWGSL:()=>o});var r=i(68415);let n="clipPlaneFragmentDeclaration",a=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},16866:function(e,t,i){var r=i(68415);let n="clusteredLightingFunctions",a=`struct ClusteredLight {vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
vLightDirection: vec4f,
vLightFalloff: vec4f,}
fn getClusteredLight(lightDataTexture: texture_2d<f32>,index: u32)->ClusteredLight {return ClusteredLight(
textureLoad(lightDataTexture,vec2u(0,index),0),
textureLoad(lightDataTexture,vec2u(1,index),0),
textureLoad(lightDataTexture,vec2u(2,index),0),
textureLoad(lightDataTexture,vec2u(3,index),0),
textureLoad(lightDataTexture,vec2u(4,index),0)
);}
fn getClusteredSliceIndex(sliceData: vec2f,viewDepth: f32)->i32 {return i32(log(viewDepth)*sliceData.x+sliceData.y);}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},82473:function(e,t,i){var r=i(68415);let n="decalFragment",a=`#ifdef DECAL
var decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;
#ifdef GAMMADECAL
decalTempColor=toLinearSpaceVec3(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalTempAlpha=decalColor.a*decalColor.a;
#endif
surfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},18157:function(e,t,i){var r=i(68415);i(21968),i(88279);let n="defaultUboDeclaration",a=`uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},15953:function(e,t,i){var r=i(68415);let n="depthPrePass",a=`#ifdef DEPTHPREPASS
fragmentOutputs.color= vec4f(0.,0.,0.,1.0);return fragmentOutputs;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},99756:function(e,t,i){var r=i(68415);let n="fogFragment",a=`#ifdef FOG
var fog: f32=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color= vec4f(mix(uniforms.vFogColor,color.rgb,fog),color.a);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},85402:function(e,t,i){i.r(t),i.d(t,{fogFragmentDeclarationWGSL:()=>o});var r=i(68415);let n="fogFragmentDeclaration",a=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
const E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32
{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},31290:function(e,t,i){var r=i(68415);let n="fogVertex",a=`#ifdef FOG
#ifdef SCENE_UBO
vertexOutputs.vFogDistance=(scene.view*worldPos).xyz;
#else
vertexOutputs.vFogDistance=(uniforms.view*worldPos).xyz;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},93996:function(e,t,i){var r=i(68415);let n="fogVertexDeclaration",a=`#ifdef FOG
varying vFogDistance: vec3f;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},85439:function(e,t,i){var r=i(68415);let n="fresnelFunction",a=`#ifdef FRESNEL
fn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32
{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},97573:function(e,t,i){var r=i(68415);let n="gaussianSplatting",a=`fn getDataUV(index: f32,dataTextureSize: vec2f)->vec2<f32> {let y: f32=floor(index/dataTextureSize.x);let x: f32=index-y*dataTextureSize.x;return vec2f((x+0.5),(y+0.5));}
struct Splat {center: vec4f,
color: vec4f,
covA: vec4f,
covB: vec4f,
#if SH_DEGREE>0
sh0: vec4<u32>,
#endif
#if SH_DEGREE>1
sh1: vec4<u32>,
#endif
#if SH_DEGREE>2
sh2: vec4<u32>,
#endif
};fn getSplatIndex(localIndex: i32,splatIndex0: vec4f,splatIndex1: vec4f,splatIndex2: vec4f,splatIndex3: vec4f)->f32 {var splatIndex: f32;switch (localIndex)
{case 0:
{splatIndex=splatIndex0.x;break;}
case 1:
{splatIndex=splatIndex0.y;break;}
case 2:
{splatIndex=splatIndex0.z;break;}
case 3:
{splatIndex=splatIndex0.w;break;}
case 4:
{splatIndex=splatIndex1.x;break;}
case 5:
{splatIndex=splatIndex1.y;break;}
case 6:
{splatIndex=splatIndex1.z;break;}
case 7:
{splatIndex=splatIndex1.w;break;}
case 8:
{splatIndex=splatIndex2.x;break;}
case 9:
{splatIndex=splatIndex2.y;break;}
case 10:
{splatIndex=splatIndex2.z;break;}
case 11:
{splatIndex=splatIndex2.w;break;}
case 12:
{splatIndex=splatIndex3.x;break;}
case 13:
{splatIndex=splatIndex3.y;break;}
case 14:
{splatIndex=splatIndex3.z;break;}
default:
{splatIndex=splatIndex3.w;break;}}
return splatIndex;}
fn readSplat(splatIndex: f32,dataTextureSize: vec2f)->Splat {var splat: Splat;let splatUV=getDataUV(splatIndex,dataTextureSize);let splatUVi32=vec2<i32>(i32(splatUV.x),i32(splatUV.y));splat.center=textureLoad(centersTexture,splatUVi32,0);splat.color=textureLoad(colorsTexture,splatUVi32,0);splat.covA=textureLoad(covariancesATexture,splatUVi32,0)*splat.center.w;splat.covB=textureLoad(covariancesBTexture,splatUVi32,0)*splat.center.w;
#if SH_DEGREE>0
splat.sh0=textureLoad(shTexture0,splatUVi32,0);
#endif
#if SH_DEGREE>1
splat.sh1=textureLoad(shTexture1,splatUVi32,0);
#endif
#if SH_DEGREE>2
splat.sh2=textureLoad(shTexture2,splatUVi32,0);
#endif
return splat;}
fn computeColorFromSHDegree(dir: vec3f,sh: array<vec3<f32>,16>)->vec3f
{let SH_C0: f32=0.28209479;let SH_C1: f32=0.48860251;var SH_C2: array<f32,5>=array<f32,5>(
1.092548430,
-1.09254843,
0.315391565,
-1.09254843,
0.546274215
);var SH_C3: array<f32,7>=array<f32,7>(
-0.59004358,
2.890611442,
-0.45704579,
0.373176332,
-0.45704579,
1.445305721,
-0.59004358
);var result: vec3f=/*SH_C0**/sh[0];
#if SH_DEGREE>0
let x: f32=dir.x;let y: f32=dir.y;let z: f32=dir.z;result+=-SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];
#if SH_DEGREE>1
let xx: f32=x*x;let yy: f32=y*y;let zz: f32=z*z;let xy: f32=x*y;let yz: f32=y*z;let xz: f32=x*z;result+=
SH_C2[0]*xy*sh[4] +
SH_C2[1]*yz*sh[5] +
SH_C2[2]*(2.0f*zz-xx-yy)*sh[6] +
SH_C2[3]*xz*sh[7] +
SH_C2[4]*(xx-yy)*sh[8];
#if SH_DEGREE>2
result+=
SH_C3[0]*y*(3.0f*xx-yy)*sh[9] +
SH_C3[1]*xy*z*sh[10] +
SH_C3[2]*y*(4.0f*zz-xx-yy)*sh[11] +
SH_C3[3]*z*(2.0f*zz-3.0f*xx-3.0f*yy)*sh[12] +
SH_C3[4]*x*(4.0f*zz-xx-yy)*sh[13] +
SH_C3[5]*z*(xx-yy)*sh[14] +
SH_C3[6]*x*(xx-3.0f*yy)*sh[15];
#endif
#endif
#endif
return result;}
fn decompose(value: u32)->vec4f
{let components : vec4f=vec4f(
f32((value ) & 255u),
f32((value>>u32( 8)) & 255u),
f32((value>>u32(16)) & 255u),
f32((value>>u32(24)) & 255u));return components*vec4f(2./255.)-vec4f(1.);}
fn computeSH(splat: Splat,dir: vec3f)->vec3f
{var sh: array<vec3<f32>,16>;sh[0]=vec3f(0.,0.,0.);
#if SH_DEGREE>0
let sh00: vec4f=decompose(splat.sh0.x);let sh01: vec4f=decompose(splat.sh0.y);let sh02: vec4f=decompose(splat.sh0.z);sh[1]=vec3f(sh00.x,sh00.y,sh00.z);sh[2]=vec3f(sh00.w,sh01.x,sh01.y);sh[3]=vec3f(sh01.z,sh01.w,sh02.x);
#endif
#if SH_DEGREE>1
let sh03: vec4f=decompose(splat.sh0.w);let sh04: vec4f=decompose(splat.sh1.x);let sh05: vec4f=decompose(splat.sh1.y);sh[4]=vec3f(sh02.y,sh02.z,sh02.w);sh[5]=vec3f(sh03.x,sh03.y,sh03.z);sh[6]=vec3f(sh03.w,sh04.x,sh04.y);sh[7]=vec3f(sh04.z,sh04.w,sh05.x);sh[8]=vec3f(sh05.y,sh05.z,sh05.w);
#endif
#if SH_DEGREE>2
let sh06: vec4f=decompose(splat.sh1.z);let sh07: vec4f=decompose(splat.sh1.w);let sh08: vec4f=decompose(splat.sh2.x);let sh09: vec4f=decompose(splat.sh2.y);let sh10: vec4f=decompose(splat.sh2.z);let sh11: vec4f=decompose(splat.sh2.w);sh[9]=vec3f(sh06.x,sh06.y,sh06.z);sh[10]=vec3f(sh06.w,sh07.x,sh07.y);sh[11]=vec3f(sh07.z,sh07.w,sh08.x);sh[12]=vec3f(sh08.y,sh08.z,sh08.w);sh[13]=vec3f(sh09.x,sh09.y,sh09.z);sh[14]=vec3f(sh09.w,sh10.x,sh10.y);sh[15]=vec3f(sh10.z,sh10.w,sh11.x); 
#endif
return computeColorFromSHDegree(dir,sh);}
fn gaussianSplatting(
meshPos: vec2<f32>,
worldPos: vec3<f32>,
scale: vec2<f32>,
covA: vec3<f32>,
covB: vec3<f32>,
worldMatrix: mat4x4<f32>,
viewMatrix: mat4x4<f32>,
projectionMatrix: mat4x4<f32>,
focal: vec2f,
invViewport: vec2f,
kernelSize: f32
)->vec4f {let modelView=viewMatrix*worldMatrix;let camspace=viewMatrix*vec4f(worldPos,1.0);let pos2d=projectionMatrix*camspace;let bounds=1.2*pos2d.w;if (pos2d.z<0. || pos2d.x<-bounds || pos2d.x>bounds || pos2d.y<-bounds || pos2d.y>bounds) {return vec4f(0.0,0.0,2.0,1.0);}
let Vrk=mat3x3<f32>(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);let isOrtho=abs(projectionMatrix[3][3]-1.0)<0.001;var J: mat3x3<f32>;if (isOrtho) {J=mat3x3<f32>(
focal.x,0.0,0.0,
0.0,focal.y,0.0,
0.0,0.0,0.0
);} else {J=mat3x3<f32>(
focal.x/camspace.z,0.0,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.0,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.0,0.0,0.0
);}
let invy=mat3x3<f32>(
1.0,0.0,0.0,
0.0,-1.0,0.0,
0.0,0.0,1.0
);let T=invy*transpose(mat3x3<f32>(
modelView[0].xyz,
modelView[1].xyz,
modelView[2].xyz))*J;var cov2d=transpose(T)*Vrk*T;
#if COMPENSATION
let c00: f32=cov2d[0][0];let c11: f32=cov2d[1][1];let c01: f32=cov2d[0][1];let detOrig: f32=c00*c11-c01*c01;
#endif
cov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;
#if COMPENSATION
let c2d: vec3f=vec3f(cov2d[0][0],c01,cov2d[1][1]);let detBlur: f32=c2d.x*c2d.z-c2d.y*c2d.y;let compensation: f32=sqrt(max(0.,detOrig/detBlur));vertexOutputs.vColor.w*=compensation;
#endif
let mid=(cov2d[0][0]+cov2d[1][1])/2.0;let radius=length(vec2<f32>((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));let lambda1=mid+radius;let lambda2=mid-radius;if (lambda2<0.0) {return vec4f(0.0,0.0,2.0,1.0);}
let diagonalVector=normalize(vec2<f32>(cov2d[0][1],lambda1-cov2d[0][0]));let majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;let minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2<f32>(diagonalVector.y,-diagonalVector.x);let vCenter=vec2<f32>(pos2d.x,pos2d.y);let scaleFactor=select(pos2d.w,1.0,isOrtho);return vec4f(
vCenter+((meshPos.x*majorAxis+meshPos.y*minorAxis)*invViewport*scaleFactor)*scale,
pos2d.z,
pos2d.w
);}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},70877:function(e,t,i){var r=i(68415);i(40513),i(99756);let n="gaussianSplattingFragmentDeclaration",a=`fn gaussianColor(inColor: vec4f,inPosition: vec2f)->vec4f
{var A : f32=-dot(inPosition,inPosition);if (A>-4.0)
{var B: f32=exp(A)*inColor.a;
#include<logDepthFragment>
var color: vec3f=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4f(color,B);} else {return vec4f(0.0);}}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},32627:function(e,t,i){var r=i(68415);let n="harmonicsFunctions",a=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00
+ uniforms.vSphericalL1_1*(normal.y)
+ uniforms.vSphericalL10*(normal.z)
+ uniforms.vSphericalL11*(normal.x)
+ uniforms.vSphericalL2_2*(normal.y*normal.x)
+ uniforms.vSphericalL2_1*(normal.y*normal.z)
+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ uniforms.vSphericalL21*(normal.z*normal.x)
+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},6777:function(e,t,i){var r=i(68415);let n="hdrFilteringFunctions",a=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
fn radicalInverse_VdC(value: u32)->f32 
{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }
fn hammersley(i: u32,N: u32)->vec2f
{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}
fn log4(x: f32)->f32 {return log2(x)/2.;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
const NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(
#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT
CUSTOM_IRRADIANCE_FILTERING_INPUT
#else
inputTexture: texture_cube<f32>,inputSampler: sampler,
#endif
inputN: vec3f,
filteringInfo: vec2f,
diffuseRoughness: f32,
surfaceAlbedo: vec3f,
inputV: vec3f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>,icdfSamplerSampler: sampler
#endif
)->vec3f
{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);
#ifndef IBL_CDF_FILTERING
var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var tbnInverse: mat3x3f=transpose(tbn);
#endif
var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);
#ifdef IBL_CDF_FILTERING
var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var NoL: f32=dot(n,Ls);var NoV: f32=dot(n,inputV);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,inputV);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(inputV+Ls)*0.5;var VoH: f32=dot(inputV,H);
#endif 
#else
var Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);var V: vec3f=tbnInverse*inputV;var NoV: f32=dot(Ns,V);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,V);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(V+Ls)*0.5;var VoH: f32=dot(V,H);
#endif
#endif
if (NoL>0.) {
#ifdef IBL_CDF_FILTERING
var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,0.0).rgb;
#else
var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);
#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION
CUSTOM_IRRADIANCE_FILTERING_FUNCTION
#else
var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;
#endif
#endif
#ifdef GAMMA_INPUT
c=toLinearSpaceVec3(c);
#endif
var diffuseRoughnessTerm: vec3f=vec3f(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
#ifdef IBL_CDF_FILTERING
var light: vec3f=vec3f(0.0);if (pdf>1e-6) {light=vec3f(1.0)/vec3f(pdf)*c;}
result+=NoL*diffuseRoughnessTerm*light;
#else
result+=c*diffuseRoughnessTerm;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
result=result/clampedAlbedo;
#endif
return result;}
fn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#ifdef ANISOTROPIC
fn radianceAnisotropic(
alphaTangent: f32, 
alphaBitangent: f32, 
inputTexture: texture_cube<f32>,
inputSampler: sampler,
inputView: vec3f, 
inputTangent: vec3f, 
inputBitangent: vec3f, 
inputNormal: vec3f, 
filteringInfo: vec2f,
noiseInput: vec2f 
)->vec3f {var V: vec3f=inputView;var N: vec3f=inputNormal;var T: vec3f=inputTangent;var B: vec3f=inputBitangent;var R: vec3f=reflect(-V,N);var c: vec3f=textureSample(inputTexture,inputSampler,R).rgb;if (alphaTangent==0.f && alphaBitangent==0.f) {
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;}
var result: vec3f=vec3f(0.f);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var effectiveDim: f32=dim0*sqrt(alphaTangent*alphaBitangent);var omegaP: f32=(4.f*PI)/(6.f*effectiveDim*effectiveDim);let noiseScale: f32=clamp(log2(f32(NUM_SAMPLES))/12.0f,0.0f,1.0f);var weight: f32=0.f;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);Xi=fract(Xi+noiseInput*mix(0.5f,0.015f,noiseScale)); 
var H_tangent: vec3f=hemisphereImportanceSampleDggxAnisotropic(Xi,alphaTangent,alphaBitangent);var H: vec3f=normalize(H_tangent.x*T+H_tangent.y*B+H_tangent.z*N);var L: vec3f=normalize(2.0f*dot(V,H)*H-V);var NoH: f32=max(dot(N,H),0.001f);var VoH: f32=max(dot(V,H),0.001f);var NoL: f32=max(dot(N,L),0.001f);if (NoL>0.f) {var pdf_inversed: f32=4./normalDistributionFunction_BurleyGGX_Anisotropic(
H_tangent.z,H_tangent.x,H_tangent.y,vec2(alphaTangent,alphaBitangent)
);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0f,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}
#endif
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},8420:function(e,t,i){var r=i(68415);let n="imageProcessingCompatibility",a=`#ifdef IMAGEPROCESSINGPOSTPROCESS
fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb, vec3f(2.2)),fragmentOutputs.color.a);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},71196:function(e,t,i){i.r(t),i.d(t,{imageProcessingDeclarationWGSL:()=>o});var r=i(68415);let n="imageProcessingDeclaration",a=`#ifdef EXPOSURE
uniform exposureLinear: f32;
#endif
#ifdef CONTRAST
uniform contrast: f32;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vInverseScreenSize: vec2f;
#endif
#ifdef VIGNETTE
uniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;
#endif
#ifdef COLORCURVES
uniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
var txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;
#else
var txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;
#endif
uniform colorTransformSettings: vec4f;
#endif
#ifdef DITHER
uniform ditherIntensity: f32;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},18125:function(e,t,i){i.r(t),i.d(t,{imageProcessingFunctionsWGSL:()=>o});var r=i(68415);let n="imageProcessingFunctions",a=`#if TONEMAPPING==3
const PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}
var d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}
#endif
#if TONEMAPPING==2
const ACESInputMat: mat3x3f= mat3x3f(
vec3f(0.59719,0.07600,0.02840),
vec3f(0.35458,0.90834,0.13383),
vec3f(0.04823,0.01566,0.83777)
);const ACESOutputMat: mat3x3f= mat3x3f(
vec3f( 1.60475,-0.10208,-0.00327),
vec3f(-0.53108, 1.10813,-0.07276),
vec3f(-0.07367,-0.00605, 1.07602)
);fn RRTAndODTFit(v: vec3f)->vec3f
{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
fn ACESFitted(color: vec3f)->vec3f
{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
fn applyImageProcessing(result: vec4f)->vec4f {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
var rgb=result.rgb;;
#ifdef EXPOSURE
rgb*=uniforms.exposureLinear;
#endif
#ifdef VIGNETTE
var viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
var vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
rgb=mix(vignetteColor,rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
rgb=PBRNeutralToneMapping(rgb);
#elif TONEMAPPING==2
rgb=ACESFitted(rgb);
#elif TONEMAPPING==1
const tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);
#endif
rgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);
#ifdef CONTRAST
var resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}
rgb=max(rgb,vec3f(0.));
#endif
#ifdef COLORGRADING
var colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;
#ifdef COLORGRADING3D
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;
#else
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;
#endif
rgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);
#endif
#ifdef COLORCURVES
var luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);
#endif
#ifdef DITHER
var rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return vec4f(rgb,result.a);}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},58361:function(e,t,i){var r=i(68415);let n="importanceSampling",a=`fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggxAnisotropic(Xi: vec2f,alphaTangent: f32,alphaBitangent: f32)->vec3f
{let alphaT: f32=max(alphaTangent,0.0001);let alphaB: f32=max(alphaBitangent,0.0001);var phi: f32=atan(alphaB/alphaT*tan(2.0f*PI*Xi.x));if (Xi.x>0.5) {phi+=PI; }
let cosPhi: f32=cos(phi);let sinPhi: f32=sin(phi);let alpha2: f32=(cosPhi*cosPhi)/(alphaTangent*alphaTangent) +
(sinPhi*sinPhi)/(alphaB*alphaB);let tanTheta2: f32=Xi.y/(1.0f-Xi.y)/alpha2;let cosTheta: f32=1.0f/sqrt(1.0f+tanTheta2);let sinTheta: f32=sqrt(max(0.0f,1.0f-cosTheta*cosTheta));return vec3f(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}
fn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { 
var phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},38726:function(e,t,i){var r=i(68415);let n="instancesDeclaration",a=`#ifdef INSTANCES
attribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},2674:function(e,t,i){var r=i(68415);let n="intersectionFunctions",a=`fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }
var o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}
fn sphereIntersect(ro: vec3f,rd: vec3f,ce: vec3f,ra: f32)->vec2f {var oc: vec3f=ro-ce;var b: f32=dot(oc,rd);var c: f32=dot(oc,oc)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}
fn sphereIntersectFromOrigin(ro: vec3f,rd: vec3f,ra: f32)->vec2f {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},90706:function(e,t,i){var r=i(68415);let n="kernelBlurFragment",a=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},41570:function(e,t,i){var r=i(68415);let n="kernelBlurFragment2",a=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},5954:function(e,t,i){var r=i(68415);let n="kernelBlurVaryingDeclaration";r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]="varying sampleCoord{X}: vec2f;")},45160:function(e,t,i){var r=i(68415);let n="kernelBlurVertex";r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};")},6620:function(e,t,i){i.r(t),i.d(t,{lightFragmentWGSL:()=>o});var r=i(68415);let n="lightFragment",a=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
var diffuse{X}: vec4f=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#if defined(PBR) && defined(CLUSTLIGHT{X})
{let sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,fragmentInputs.vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(
lightDataTexture{X},
&tileMaskBuffer{X},
light{X}.vLightData,
vec2u(light{X}.vSliceRanges[sliceIndex].xy),
viewDirectionW,
normalW,
fragmentInputs.vPositionW,
surfaceAlbedo,
reflectivityOut,
#ifdef IRIDESCENCE
iridescenceIntensity,
#endif
#ifdef SS_TRANSLUCENCY
subSurfaceOut,
#endif
#ifdef SPECULARTERM
AARoughnessFactors.x,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef SHEEN
sheenOut,
#endif
#ifdef CLEARCOAT
clearcoatOut,
#endif
);}
#elif defined(PBR)
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
preInfo.diffuseRoughness=diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission=vec3f(0.0);
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
info.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);
#elif defined(SS_TRANSLUCENCY)
#ifndef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance); 
#else
info.diffuse=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#if AREALIGHT{X}
info.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#else
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
{let metalFresnel: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel: vec3f=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);}
#else
coloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
{let NdotH: f32=dot(normalW,preInfo.H);let fresnel: vec3f=fresnelSchlickGGXVec3(NdotH,vec3f(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3f(1.0)-fresnel);}
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,coloredFresnel,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#endif
#ifndef AREALIGHT{X}
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
#ifdef IESLIGHTTEXTURE{X}
info=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif define(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
info=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,
#ifdef AREALIGHTNOROUGHTNESS
0.5
#else
uniforms.vReflectionInfos.y
#endif
);
#elif defined(CLUSTLIGHT{X})
{let sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,fragmentInputs.vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(lightDataTexture{X},&tileMaskBuffer{X},viewDirectionW,normalW,light{X}.vLightData,vec2u(light{X}.vSliceRanges[sliceIndex].xy),glossiness);}
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSMDEBUG{X}
var shadowDebug{X}: vec3f;
#endif
#ifdef SHADOWCSM{X}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
var index{X}: i32=-1;
#else
var index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;
#endif
var diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++)
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;
#else
diff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
var frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;var nextShadow: f32=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SS_TRANSLUCENCY
diffuseTransmissionBase+=info.diffuseTransmission*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},33060:function(e,t,i){i.r(t),i.d(t,{lightUboDeclarationWGSL:()=>o});var r=i(68415);let n="lightUboDeclaration",a=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#elif defined(CLUSTLIGHT{X})
vSliceData: vec2f,
vSliceRanges: array<vec4f,CLUSTLIGHT_SLICES>,
#endif
#if defined(AREALIGHT{X})
vLightWidth: vec4f,
vLightHeight: vec4f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef IESLIGHTTEXTURE{X}
var iesLightTexture{X}Sampler: sampler;var iesLightTexture{X}: texture_2d<f32>;
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;
#endif
#ifdef CLUSTLIGHT{X}
var lightDataTexture{X}: texture_2d<f32>;var<storage,read> tileMaskBuffer{X}: array<u32>;
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;
#else 
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d_array<f32>;
#endif
#ifdef SHADOWCSMDEBUG{X}
const vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>
(
vec3f ( 1.5,0.0,0.0 ),
vec3f ( 0.0,1.5,0.0 ),
vec3f ( 0.0,0.0,5.5 ),
vec3f ( 1.5,0.0,5.5 ),
vec3f ( 1.5,1.5,0.0 ),
vec3f ( 1.0,1.0,1.0 ),
vec3f ( 0.0,1.0,5.5 ),
vec3f ( 0.5,3.5,0.75 )
);
#endif
#elif defined(SHADOWCUBE{X})
var shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; 
var depthTexture{X}: texture_2d<f32>;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;
#else
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d<f32>;
#endif
uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},39044:function(e,t,i){var r=i(68415);let n="lightVxFragmentDeclaration",a=`#ifdef LIGHT{X}
uniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;
#ifdef SPECULARTERM
uniform vLightSpecular{X}: vec4f;
#else
var vLightSpecular{X}: vec4f= vec4f(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
uniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;
#endif
#ifdef SPOTLIGHT{X}
uniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;
#elif defined(POINTLIGHT{X})
uniform vLightFalloff{X}: vec4f;
#elif defined(HEMILIGHT{X})
uniform vLightGround{X}: vec3f;
#endif
#if defined(AREALIGHT{X})
uniform vLightWidth{X}: vec4f;uniform vLightHeight{X}: vec4f;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},86834:function(e,t,i){i.r(t),i.d(t,{lightVxUboDeclarationWGSL:()=>o});var r=i(68415);let n="lightVxUboDeclaration",a=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#elif defined(CLUSTLIGHT{X})
vSliceData: vec2f,
vSliceRanges: array<vec4f,CLUSTLIGHT_SLICES>,
#endif
#if defined(AREALIGHT{X})
vLightWidth: vec4f,
vLightHeight: vec4f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},21198:function(e,t,i){i.r(t),i.d(t,{lightsFragmentFunctionsWGSL:()=>o});var r=i(68415);i(4528),i(16866);let n="lightsFragmentFunctions",a=`struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef NDOTL
ndl: f32,
#endif
};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)
{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn getAttenuation(cosAngle: f32,exponent: f32)->f32 {return max(0.,pow(cosAngle,exponent));}
fn getIESAttenuation(cosAngle: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32 {var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeBasicSpotLighting(viewDirectionW: vec3f,lightVectorW: vec3f,vNormal: vec3f,attenuation: f32,diffuseColor: vec3f,specularColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn computeIESSpotLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var dotProduct=dot(lightDirection.xyz,-lightVectorW);var cosAngle: f32=max(0.,dotProduct);if (cosAngle>=lightDirection.w)
{attenuation*=getIESAttenuation(dotProduct,iesLightTexture,iesLightTextureSampler);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
var result: lightingInfo;result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{attenuation*=getAttenuation(cosAngle,lightData.w);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
var result: lightingInfo;result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaLighting(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightPosition:vec3f,halfWidth:vec3f, halfHeight:vec3f,diffuseColor:vec3f,specularColor:vec3f,roughness:f32 )->lightingInfo
{var result: lightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
var fresnel:vec3f=( specularColor*data.Fresnel.x+( vec3f( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;
#endif
result.diffuse+=diffuseColor*data.Diffuse;return result;}
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
fn computeClusteredLighting(
lightDataTexture: texture_2d<f32>,
tileMaskBuffer: ptr<storage,array<u32>>,
viewDirectionW: vec3f,
vNormal: vec3f,
lightData: vec4f,
sliceRange: vec2u,
glossiness: f32
)->lightingInfo {var result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; 
let maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var info: lightingInfo;if light.vLightDirection.w<0.0 {info=computeLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);} else {info=computeSpotLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDirection,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);}
result.diffuse+=info.diffuse;
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},91873:function(e,t,i){var r=i(68415);let n="logDepthDeclaration",a=`#ifdef LOGARITHMICDEPTH
uniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},40513:function(e,t,i){var r=i(68415);let n="logDepthFragment",a=`#ifdef LOGARITHMICDEPTH
fragmentOutputs.fragDepth=log2(fragmentInputs.vFragmentDepth)*uniforms.logarithmicDepthConstant*0.5;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},98731:function(e,t,i){var r=i(68415);let n="logDepthVertex",a=`#ifdef LOGARITHMICDEPTH
vertexOutputs.vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vertexOutputs.vFragmentDepth))*uniforms.logarithmicDepthConstant;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},4528:function(e,t,i){var r=i(68415);let n="ltcHelperFunctions",a=`fn LTCUv(N: vec3f,V: vec3f,roughness: f32)->vec2f {var LUTSIZE: f32=64.0;var LUTSCALE: f32=( LUTSIZE-1.0 )/LUTSIZE;var LUTBIAS:f32=0.5/LUTSIZE;var dotNV:f32=saturate( dot( N,V ) );var uv:vec2f=vec2f( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}
fn LTCClippedSphereFormFactor( f:vec3f )->f32 {var l: f32=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}
fn LTCEdgeVectorFormFactor( v1:vec3f,v2:vec3f )->vec3f {var x:f32=dot( v1,v2 );var y:f32=abs( x );var a:f32=0.8543985+( 0.4965155+0.0145206*y )*y;var b:f32=3.4175940+( 4.1616724+y )*y;var v:f32=a/b;var thetaSintheta:f32=0.0;if( x>0.0 )
{thetaSintheta=v;}
else
{thetaSintheta=0.5*inverseSqrt( max( 1.0-x*x,0.00000001 ) )-v;}
return cross( v1,v2 )*thetaSintheta;}
fn LTCEvaluate( N:vec3f,V:vec3f,P:vec3f,mInv: mat3x3<f32>,rectCoords0:vec3f,rectCoords1:vec3f,rectCoords2:vec3f,rectCoords3:vec3f )->vec3f {var v1:vec3f=rectCoords1-rectCoords0;var v2:vec3f=rectCoords3-rectCoords0;var lightNormal:vec3f=cross( v1,v2 );if( dot( lightNormal,P-rectCoords0 )<0.0 ){return vec3f( 0.0 );}
var T1:vec3f=normalize( V-N*dot( V,N ) );var T2:vec3f=- cross( N,T1 ); 
var mat: mat3x3<f32>=mInv*transposeMat3( mat3x3<f32>( T1,T2,N ) );var coords0: vec3f=mat*( rectCoords0-P );var coords1: vec3f=mat*( rectCoords1-P );var coords2: vec3f=mat*( rectCoords2-P );var coords3: vec3f=mat*( rectCoords3-P );coords0=normalize( coords0 );coords1=normalize( coords1 );coords2=normalize( coords2 );coords3=normalize( coords3 );var vectorFormFactor:vec3f=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords0,coords1 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords1,coords2 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords2,coords3 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords3,coords0 );var result:f32=LTCClippedSphereFormFactor( vectorFormFactor );return vec3f( result );}
struct areaLightData
{Diffuse: vec3f,
Specular: vec3f,
Fresnel: vec4f};fn computeAreaLightSpecularDiffuseFresnel(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDir: vec3f,normal:vec3f,position:vec3f,lightPos:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->areaLightData {var result: areaLightData;var rectCoords0:vec3f=lightPos+halfWidth-halfHeight; 
var rectCoords1:vec3f=lightPos-halfWidth-halfHeight;var rectCoords2:vec3f=lightPos-halfWidth+halfHeight;var rectCoords3:vec3f=lightPos+halfWidth+halfHeight;
#ifdef SPECULARTERM
var uv:vec2f=LTCUv( normal,viewDir,roughness );var t1:vec4f=textureSample( ltc1,ltc1Sampler,uv );var t2:vec4f=textureSample( ltc2,ltc2Sampler,uv );var mInv:mat3x3<f32>=mat3x3<f32>(
vec3f( t1.x,0,t1.y ),
vec3f( 0,1, 0 ),
vec3f( t1.z,0,t1.w )
);result.Fresnel=t2;result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );
#endif
var mInvEmpty:mat3x3<f32>=mat3x3<f32>(
vec3f( 1,0,0 ),
vec3f( 0,1,0 ),
vec3f( 0,0,1 )
);result.Diffuse+=LTCEvaluate( normal,viewDir,position,mInvEmpty,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );return result;}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},12064:function(e,t,i){var r=i(68415);let n="mainUVVaryingDeclaration",a=`#ifdef MAINUV{X}
varying vMainUV{X}: vec2f;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},10822:function(e,t,i){var r=i(68415);let n="oitDeclaration",a=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#define MAX_DEPTH 99999.0
var oitDepthSamplerSampler: sampler;var oitDepthSampler: texture_2d<f32>;var oitFrontColorSamplerSampler: sampler;var oitFrontColorSampler: texture_2d<f32>;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},86576:function(e,t,i){var r=i(68415);let n="oitFragment",a=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
var fragDepth: f32=fragmentInputs.position.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
var halfFloat: u32=pack2x16float( vec2f(fragDepth));var full: vec2f=unpack2x16float(halfFloat);fragDepth=full.x;
#endif
var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var lastDepth: vec2f=textureLoad(oitDepthSampler,fragCoord,0).rg;var lastFrontColor: vec4f=textureLoad(oitFrontColorSampler,fragCoord,0);fragmentOutputs.depth=vec2f(-MAX_DEPTH);fragmentOutputs.frontColor=lastFrontColor;fragmentOutputs.backColor= vec4f(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
var furthestDepth: f32=-lastDepth.x;var nearestDepth: f32=lastDepth.y;
#else
var nearestDepth: f32=-lastDepth.x;var furthestDepth: f32=lastDepth.y;
#endif
var alphaMultiplier: f32=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return fragmentOutputs;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
fragmentOutputs.depth=vec2f(-fragDepth,fragDepth);return fragmentOutputs;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},18456:function(e,t,i){var r=i(68415);let n="openpbrBaseLayerData",a=`var base_color=vec3f(0.8);var base_metalness: f32=0.0;var base_diffuse_roughness: f32=0.0;var specular_weight: f32=1.0;var specular_roughness: f32=0.3;var specular_color: vec3f=vec3f(1.0);var specular_roughness_anisotropy: f32=0.0;var specular_ior: f32=1.5;var alpha: f32=1.0;var geometry_tangent: vec2f=vec2f(1.0,0.0);
#ifdef BASE_WEIGHT
let baseWeightFromTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);
#endif
#ifdef BASE_COLOR
let baseColorFromTexture: vec4f=textureSample(baseColorSampler,baseColorSamplerSampler,fragmentInputs.vBaseColorUV+uvOffset);
#endif
#ifdef BASE_METALNESS
let metallicFromTexture: vec4f=textureSample(baseMetalnessSampler,baseMetalnessSamplerSampler,fragmentInputs.vBaseMetalnessUV+uvOffset);
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
let baseDiffuseRoughnessFromTexture: f32=textureSample(baseDiffuseRoughnessSampler,baseDiffuseRoughnessSamplerSampler,fragmentInputs.vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
#ifdef GEOMETRY_TANGENT
let geometryTangentFromTexture: vec3f=textureSample(geometryTangentSampler,geometryTangentSamplerSampler,fragmentInputs.vGeometryTangentUV+uvOffset).rgb;
#endif
#ifdef SPECULAR_ROUGHNESS_ANISOTROPY
let anisotropyFromTexture: f32=textureSample(specularRoughnessAnisotropySampler,specularRoughnessAnisotropySamplerSampler,fragmentInputs.vSpecularRoughnessAnisotropyUV+uvOffset).r*uniforms.vSpecularRoughnessAnisotropyInfos.y;
#endif
#ifdef GEOMETRY_OPACITY
let opacityFromTexture: vec4f=textureSample(geometryOpacitySampler,geometryOpacitySamplerSampler,fragmentInputs.vGeometryOpacityUV+uvOffset);
#endif
#ifdef DECAL
let decalFromTexture: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
#ifdef SPECULAR_COLOR
let specularColorFromTexture: vec4f=textureSample(specularColorSampler,specularColorSamplerSampler,fragmentInputs.vSpecularColorUV+uvOffset);
#endif
#if defined(SPECULAR_WEIGHT)
#ifdef SPECULAR_WEIGHT_IN_ALPHA
let specularWeightFromTexture: f32=textureSample(specularWeightSampler,specularWeightSamplerSampler,fragmentInputs.vSpecularWeightUV+uvOffset).a;
#else
let specularWeightFromTexture: f32=textureSample(specularWeightSampler,specularWeightSamplerSampler,fragmentInputs.vSpecularWeightUV+uvOffset).r;
#endif
#endif
#if defined(ANISOTROPIC) || defined(FUZZ)
let noise=textureSample(blueNoiseSampler,blueNoiseSamplerSampler,fragmentInputs.position.xy/256.0).xyz;
#endif
#if defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS)
let roughnessFromTexture: f32=metallicFromTexture.g;
#elif defined(SPECULAR_ROUGHNESS)
let roughnessFromTexture: f32=textureSample(specularRoughnessSampler,specularRoughnessSamplerSampler,fragmentInputs.vSpecularRoughnessUV+uvOffset).r;
#endif
base_color=uniforms.vBaseColor.rgb;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
base_color*=fragmentInputs.vColor.rgb;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
base_color*=vec3(uniforms.vBaseWeight);alpha=uniforms.vBaseColor.a;base_metalness=uniforms.vReflectanceInfo.x;base_diffuse_roughness=uniforms.vBaseDiffuseRoughness;specular_roughness=uniforms.vReflectanceInfo.y;specular_color=uniforms.vSpecularColor.rgb;specular_weight=uniforms.vReflectanceInfo.a;specular_ior=uniforms.vReflectanceInfo.z;specular_roughness_anisotropy=uniforms.vSpecularAnisotropy.b;geometry_tangent=uniforms.vSpecularAnisotropy.rg;
#ifdef BASE_COLOR
#ifdef BASE_COLOR_GAMMA
base_color*=toLinearSpace(baseColorFromTexture.rgb);
#else
base_color*=baseColorFromTexture.rgb;
#endif
base_color*=uniforms.vBaseColorInfos.y;
#endif
#ifdef BASE_WEIGHT
base_color*=baseWeightFromTexture.r;
#endif
#if defined(BASE_COLOR) && defined(ALPHA_FROM_BASE_COLOR_TEXTURE)
alpha*=baseColorFromTexture.a;
#elif defined(GEOMETRY_OPACITY)
alpha*=opacityFromTexture.a;alpha*=uniforms.vGeometryOpacityInfos.y;
#endif
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#ifdef BASE_METALNESS
#ifdef METALLNESSSTOREINMETALMAPBLUE
base_metalness*=metallicFromTexture.b;
#else
base_metalness*=metallicFromTexture.r;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
base_diffuse_roughness*=baseDiffuseRoughnessFromTexture*uniforms.vBaseDiffuseRoughnessInfos.y;
#endif
#ifdef SPECULAR_COLOR
#ifdef SPECULAR_COLOR_GAMMA
specular_color*=toLinearSpace(specularColorFromTexture.rgb);
#else
specular_color*=specularColorFromTexture.rgb;
#endif
#endif
#ifdef SPECULAR_WEIGHT_FROM_SPECULAR_COLOR_TEXTURE
specular_weight*=specularColorFromTexture.a;
#elif defined(SPECULAR_WEIGHT)
specular_weight*=specularWeightFromTexture;
#endif
#if defined(SPECULAR_ROUGHNESS) || (defined(ROUGHNESSSTOREINMETALMAPGREEN) && defined(BASE_METALNESS))
specular_roughness*=roughnessFromTexture;
#endif
#ifdef GEOMETRY_TANGENT
{let tangentFromTexture: vec2f=normalize(geometryTangentFromTexture.xy*vec2f(2.0f)-vec2f(1.0f));let tangent_angle_texture: f32=atan2(tangentFromTexture.y,tangentFromTexture.x);let tangent_angle_uniform: f32=atan2(geometry_tangent.y,geometry_tangent.x);let tangent_angle: f32=tangent_angle_texture+tangent_angle_uniform;geometry_tangent=vec2f(cos(tangent_angle),sin(tangent_angle));}
#endif
#if defined(GEOMETRY_TANGENT) && defined(SPECULAR_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
specular_roughness_anisotropy*=geometryTangentFromTexture.b;
#elif defined(SPECULAR_ROUGHNESS_ANISOTROPY)
specular_roughness_anisotropy*=anisotropyFromTexture;
#endif
#ifdef DETAIL
let detailRoughness: f32=mix(0.5f,detailColor.b,vDetailInfos.w);let loLerp: f32=mix(0.f,specular_roughness,detailRoughness*2.f);let hiLerp: f32=mix(specular_roughness,1.f,(detailRoughness-0.5f)*2.f);specular_roughness=mix(loLerp,hiLerp,step(detailRoughness,0.5f));
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
let baseAlpha: f32=specular_roughness*specular_roughness;let roughnessT: f32=mix(baseAlpha,1.0f,specular_roughness_anisotropy*specular_roughness_anisotropy);let roughnessB: f32=baseAlpha;specular_roughness_anisotropy=1.0f-roughnessB/max(roughnessT,0.00001f);specular_roughness=sqrt(roughnessT/sqrt(2.0f/(1.0f+(1.0f-specular_roughness_anisotropy)*(1.0f-specular_roughness_anisotropy))));
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},54230:function(e,t,i){var r=i(68415);let n="openpbrBlockAmbientOcclusion",a=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT_OCCLUSION)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT_OCCLUSION
ambientOcclusionColorMap_: vec3f,
ambientInfos: vec2f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT_OCCLUSION
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*ambientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},47142:function(e,t,i){var r=i(68415);let n="openpbrBlockNormalFinal",a=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));coatNormalW*=sign(dot(coatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=select(normalW,-normalW,fragmentInputs.frontFacing);coatNormalW=select(coatNormalW,-coatNormalW,fragmentInputs.frontFacing);
#else
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);coatNormalW=select(-coatNormalW,coatNormalW,fragmentInputs.frontFacing);
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},78518:function(e,t,i){var r=i(68415);let n="openpbrCoatLayerData",a=`var coat_weight: f32=0.0f;var coat_color: vec3f=vec3f(1.0f);var coat_roughness: f32=0.0f;var coat_roughness_anisotropy: f32=0.0f;var coat_ior: f32=1.6f;var coat_darkening: f32=1.0f;var geometry_coat_tangent: vec2f=vec2f(1.0f,0.0f);
#ifdef COAT_WEIGHT
var coatWeightFromTexture: vec4f=textureSample(coatWeightSampler,coatWeightSamplerSampler,fragmentInputs.vCoatWeightUV+uvOffset);
#endif
#ifdef COAT_COLOR
var coatColorFromTexture: vec4f=textureSample(coatColorSampler,coatColorSamplerSampler,fragmentInputs.vCoatColorUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS
var coatRoughnessFromTexture: vec4f=textureSample(coatRoughnessSampler,coatRoughnessSamplerSampler,fragmentInputs.vCoatRoughnessUV+uvOffset);
#endif
#ifdef COAT_ROUGHNESS_ANISOTROPY
var coatRoughnessAnisotropyFromTexture: f32=textureSample(coatRoughnessAnisotropySampler,coatRoughnessAnisotropySamplerSampler,fragmentInputs.vCoatRoughnessAnisotropyUV+uvOffset).r;
#endif
#ifdef COAT_DARKENING
var coatDarkeningFromTexture: vec4f=textureSample(coatDarkeningSampler,coatDarkeningSamplerSampler,fragmentInputs.vCoatDarkeningUV+uvOffset);
#endif
#ifdef GEOMETRY_COAT_TANGENT
var geometryCoatTangentFromTexture: vec3f=textureSample(geometryCoatTangentSampler,geometryCoatTangentSamplerSampler,fragmentInputs.vGeometryCoatTangentUV+uvOffset).rgb;
#endif
coat_color=uniforms.vCoatColor.rgb;coat_weight=uniforms.vCoatWeight;coat_roughness=uniforms.vCoatRoughness;coat_roughness_anisotropy=uniforms.vCoatRoughnessAnisotropy;coat_ior=uniforms.vCoatIor;coat_darkening=uniforms.vCoatDarkening;geometry_coat_tangent=uniforms.vGeometryCoatTangent.rg;
#ifdef COAT_WEIGHT
coat_weight*=coatWeightFromTexture.r;
#endif
#ifdef COAT_COLOR
#ifdef COAT_COLOR_GAMMA
coat_color*=toLinearSpace(coatColorFromTexture.rgb);
#else
coat_color*=coatColorFromTexture.rgb;
#endif
coat_color*=uniforms.vCoatColorInfos.y;
#endif
#ifdef COAT_ROUGHNESS
#ifdef COAT_ROUGHNESS_FROM_GREEN_CHANNEL
coat_roughness*=coatRoughnessFromTexture.g;
#else
coat_roughness*=coatRoughnessFromTexture.r;
#endif
#endif
#if defined(GEOMETRY_COAT_TANGENT) && defined(COAT_ROUGHNESS_ANISOTROPY_FROM_TANGENT_TEXTURE)
coat_roughness_anisotropy*=geometryCoatTangentFromTexture.b;
#elif defined(COAT_ROUGHNESS_ANISOTROPY)
coat_roughness_anisotropy*=coatRoughnessAnisotropyFromTexture;
#endif
#ifdef COAT_DARKENING
coat_darkening*=coatDarkeningFromTexture.r;
#endif
#ifdef GEOMETRY_COAT_TANGENT
{let tangentFromTexture: vec2f=normalize(geometryCoatTangentFromTexture.xy*vec2f(2.0f)-vec2f(1.0f));let tangent_angle_texture: f32=atan2(tangentFromTexture.y,tangentFromTexture.x);let tangent_angle_uniform: f32=atan2(geometry_coat_tangent.y,geometry_coat_tangent.x);let tangent_angle: f32=tangent_angle_texture+tangent_angle_uniform;geometry_coat_tangent=vec2f(cos(tangent_angle),sin(tangent_angle));}
#endif
#ifdef USE_GLTF_STYLE_ANISOTROPY
let coatAlpha: f32=coat_roughness*coat_roughness;let coatRoughnessT: f32=mix(coatAlpha,1.0f,coat_roughness_anisotropy*coat_roughness_anisotropy);let coatRoughnessB: f32=coatAlpha;coat_roughness_anisotropy=1.0f-coatRoughnessB/max(coatRoughnessT,0.00001f);coat_roughness=sqrt(coatRoughnessT/sqrt(2.0f/(1.0f+(1.0f-coat_roughness_anisotropy)*(1.0f-coat_roughness_anisotropy))));
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},89937:function(e,t,i){var r=i(68415);let n="openpbrConductorReflectance",a=`#define pbr_inline
fn conductorReflectance(baseColor: vec3f,specularColor: vec3f,specularWeight: f32)->ReflectanceParams
{var outParams: ReflectanceParams;
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
outParams.coloredF0=baseColor*specularWeight;outParams.coloredF90=specularColor*specularWeight;
#else
outParams.coloredF0=baseColor;outParams.coloredF90=vec3f(1.0f);
#endif
outParams.F0=1.0f;outParams.F90=1.0f;return outParams;}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},85720:function(e,t,i){var r=i(68415);let n="openpbrDielectricReflectance",a=`struct ReflectanceParams
{F0: f32,
F90: f32,
coloredF0: vec3f,
coloredF90: vec3f,};
#define pbr_inline
fn dielectricReflectance(
insideIOR: f32,outsideIOR: f32,specularColor: vec3f,specularWeight: f32
)->ReflectanceParams
{var outParams: ReflectanceParams;let dielectricF0=pow((insideIOR-outsideIOR)/(insideIOR+outsideIOR),2.0);
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
let maxF0=max(specularColor.r,max(specularColor.g,specularColor.b));outParams.F0=dielectricF0*maxF0*specularWeight;
#else
outParams.F0=dielectricF0*specularWeight;
#endif
let f90Scale=clamp(2.0f*abs(insideIOR-outsideIOR),0.0f,1.0f);outParams.F90=f90Scale*specularWeight;outParams.coloredF0=vec3f(dielectricF0*specularWeight)*specularColor.rgb;
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
let dielectricColorF90: vec3f=specularColor.rgb*vec3f(f90Scale)*specularWeight;
#else
let dielectricColorF90: vec3f=vec3f(f90Scale)*specularWeight;
#endif
outParams.coloredF90=dielectricColorF90;return outParams;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},64933:function(e,t,i){var r=i(68415);let n="openpbrDirectLighting",a=`#ifdef LIGHT{X}
{var slab_diffuse: vec3f=vec3f(0.f,0.f,0.f);var slab_subsurface: vec3f=vec3f(0.f,0.f,0.f);var slab_translucent: vec3f=vec3f(0.f,0.f,0.f);var slab_glossy: vec3f=vec3f(0.f,0.f,0.f);var specularFresnel: f32=0.0f;var specularColoredFresnel: vec3f=vec3f(0.f,0.f,0.f);var slab_metal: vec3f=vec3f(0.f,0.f,0.f);var slab_coat: vec3f=vec3f(0.f,0.f,0.f);var coatFresnel: f32=0.0f;var slab_fuzz: vec3f=vec3f(0.f,0.f,0.f);var fuzzFresnel: f32=0.0f;
#ifdef HEMILIGHT{X}
slab_diffuse=computeHemisphericDiffuseLighting(preInfo{X},lightColor{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
slab_diffuse=computeAreaDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#else
slab_diffuse=computeDiffuseLighting(preInfo{X},lightColor{X}.rgb);
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
slab_diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
numLights+=1.0f;
#ifdef FUZZ
let fuzzNdotH: f32=max(dot(fuzzNormalW,preInfo{X}.H),0.0f);let fuzzBrdf: vec3f=getFuzzBRDFLookup(fuzzNdotH,sqrt(fuzz_roughness));
#endif
#ifdef THIN_FILM
let thin_film_desaturation_scale: f32=(thin_film_ior-1.0f)*sqrt(thin_film_thickness*0.001f);
#endif
#if AREALIGHT{X}
slab_glossy=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#ifdef ANISOTROPIC_BASE
slab_glossy=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,
baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,
0.0f,lightColor{X}.rgb);
#else
slab_glossy=computeSpecularLighting(preInfo{X},normalW,vec3(1.0),vec3(1.0),specular_roughness,lightColor{X}.rgb);
#endif
let NdotH: f32=dot(normalW,preInfo{X}.H);specularFresnel=fresnelSchlickGGX(NdotH,baseDielectricReflectance.F0,baseDielectricReflectance.F90);specularColoredFresnel=specularFresnel*specular_color;
#ifdef THIN_FILM
let thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);var thinFilmDielectricFresnel: vec3f=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseDielectricReflectance.coloredF0);thinFilmDielectricFresnel=mix(thinFilmDielectricFresnel,vec3f(dot(thinFilmDielectricFresnel,vec3f(0.3333f))),thin_film_desaturation_scale);specularColoredFresnel=mix(specularColoredFresnel,thinFilmDielectricFresnel*specular_color,thin_film_weight*thinFilmIorScale);
#endif
}
#endif
#if AREALIGHT{X}
slab_metal=computeAreaSpecularLighting(preInfo{X},light{X}.vLightSpecular.rgb,baseConductorReflectance.F0,baseConductorReflectance.F90);
#else
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
var coloredFresnel: vec3f=getF82Specular(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90,specular_roughness);
#else
var coloredFresnel: vec3f=fresnelSchlickGGX(preInfo{X}.VdotH,baseConductorReflectance.coloredF0,baseConductorReflectance.coloredF90);
#endif
#ifdef THIN_FILM
let thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);var thinFilmConductorFresnel=evalIridescence(thin_film_outside_ior,thin_film_ior,preInfo{X}.VdotH,thin_film_thickness,baseConductorReflectance.coloredF0);thinFilmConductorFresnel=mix(thinFilmConductorFresnel,vec3f(dot(thinFilmConductorFresnel,vec3f(0.3333f))),thin_film_desaturation_scale);coloredFresnel=mix(coloredFresnel,specular_weight*thinFilmIorScale*thinFilmConductorFresnel,thin_film_weight);
#endif
#ifdef ANISOTROPIC_BASE
slab_metal=computeAnisotropicSpecularLighting(preInfo{X},viewDirectionW,normalW,baseGeoInfo.anisotropicTangent,baseGeoInfo.anisotropicBitangent,baseGeoInfo.anisotropy,0.0,lightColor{X}.rgb);
#else
slab_metal=computeSpecularLighting(preInfo{X},normalW,vec3f(baseConductorReflectance.coloredF0),coloredFresnel,specular_roughness,lightColor{X}.rgb);
#endif
}
#endif
#if AREALIGHT{X}
slab_coat=computeAreaSpecularLighting(preInfoCoat{X},light{X}.vLightSpecular.rgb,coatReflectance.F0,coatReflectance.F90);
#else
{
#ifdef ANISOTROPIC_COAT
slab_coat=computeAnisotropicSpecularLighting(preInfoCoat{X},viewDirectionW,coatNormalW,
coatGeoInfo.anisotropicTangent,coatGeoInfo.anisotropicBitangent,coatGeoInfo.anisotropy,0.0,
lightColor{X}.rgb);
#else
slab_coat=computeSpecularLighting(preInfoCoat{X},coatNormalW,vec3f(coatReflectance.F0),vec3f(1.0f),coat_roughness,lightColor{X}.rgb);
#endif
let NdotH: f32=dot(coatNormalW,preInfoCoat{X}.H);coatFresnel=fresnelSchlickGGX(NdotH,coatReflectance.F0,coatReflectance.F90);}
#endif
var coatAbsorption=vec3f(1.0f);if (coat_weight>0.0) {let cosTheta_view: f32=max(preInfoCoat{X}.NdotV,0.001f);let cosTheta_light: f32=max(preInfoCoat{X}.NdotL,0.001f);let fresnel_view: f32=coatReflectance.F0+(1.0f-coatReflectance.F0)*pow(1.0f-cosTheta_view,5.0);let fresnel_light: f32=coatReflectance.F0+(1.0f-coatReflectance.F0)*pow(1.0f-cosTheta_light,5.0);let averageReflectance: f32=(fresnel_view+fresnel_light)*0.5;var darkened_transmission: f32=(1.0f-averageReflectance)/(1.0f+averageReflectance);darkened_transmission=mix(1.0f,darkened_transmission,coat_darkening);var sin2: f32=1.0f-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);let cos_t: f32=sqrt(1.0f-sin2);let coatPathLength=1.0f/cos_t;let colored_transmission: vec3f=pow(coat_color,vec3f(coatPathLength));coatAbsorption=mix(vec3f(1.0f),colored_transmission*vec3f(darkened_transmission),coat_weight);}
#ifdef FUZZ
fuzzFresnel=fuzzBrdf.z;let fuzzNormalW=mix(normalW,coatNormalW,coat_weight);let fuzzNdotV: f32=max(dot(fuzzNormalW,viewDirectionW.xyz),0.0f);let fuzzNdotL: f32=max(dot(fuzzNormalW,preInfo{X}.L),0.0);slab_fuzz=lightColor{X}.rgb*preInfo{X}.attenuation*evalFuzz(preInfo{X}.L,fuzzNdotL,fuzzNdotV,fuzzTangent,fuzzBitangent,fuzzBrdf);
#else
let fuzz_color=vec3f(0.0);
#endif
slab_diffuse*=base_color.rgb;let material_opaque_base: vec3f=mix(slab_diffuse,slab_subsurface,subsurface_weight);let material_dielectric_base: vec3f=mix(material_opaque_base,slab_translucent,transmission_weight);let material_dielectric_gloss: vec3f=material_dielectric_base*(1.0f-specularFresnel)+slab_glossy*specularColoredFresnel;let material_base_substrate: vec3f=mix(material_dielectric_gloss,slab_metal,base_metalness);let material_coated_base: vec3f=layer(material_base_substrate,slab_coat,coatFresnel,coatAbsorption,vec3f(1.0f));material_surface_direct+=layer(material_coated_base,slab_fuzz,fuzzFresnel*fuzz_weight,vec3f(1.0f),fuzz_color);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},47399:function(e,t,i){var r=i(68415);let n="openpbrDirectLightingInit",a=`#ifdef LIGHT{X}
var preInfo{X}: preLightingInfo;var preInfoCoat{X}: preLightingInfo;let lightColor{X}: vec4f=light{X}.vLightDiffuse;var shadow{X}: f32=1.0f;
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#define CUSTOM_LIGHT{X}_COLOR 
#ifdef SPOTLIGHT{X}
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);preInfoCoat{X}=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(DIRLIGHT{X})
preInfo{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);preInfoCoat{X}=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,coatNormalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,specular_roughness);preInfoCoat{X}=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,coatNormalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,coat_roughness);
#endif
preInfo{X}.NdotV=baseGeoInfo.NdotV;preInfoCoat{X}.NdotV=coatGeoInfo.NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo{X}.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo{X}.L,iesLightTexture{X});
#else
preInfo{X}.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo{X}.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo{X}.attenuation=computeDistanceLightFalloff_GLTF(preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Physical(preInfo{X}.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo{X}.attenuation=computeDistanceLightFalloff_Standard(preInfo{X}.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo{X}.attenuation=computeDistanceLightFalloff(preInfo{X}.lightOffset,preInfo{X}.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo{X}.attenuation=1.0f;
#endif
preInfoCoat{X}.attenuation=preInfo{X}.attenuation;
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo{X}.roughness=specular_roughness;preInfoCoat{X}.roughness=coat_roughness;
#else
preInfo{X}.roughness=adjustRoughnessFromLightProperties(specular_roughness,light{X}.vLightSpecular.a,preInfo{X}.lightDistance);preInfoCoat{X}.roughness=adjustRoughnessFromLightProperties(coat_roughness,light{X}.vLightSpecular.a,preInfoCoat{X}.lightDistance);
#endif
preInfo{X}.diffuseRoughness=base_diffuse_roughness;preInfo{X}.surfaceAlbedo=base_color.rgb;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},75511:function(e,t,i){var r=i(68415);let n="openpbrEnvironmentLighting",a=`#ifdef REFLECTION
#ifdef FUZZ
let environmentFuzzBrdf: vec3f=getFuzzBRDFLookup(fuzzGeoInfo.NdotV,sqrt(fuzz_roughness));
#endif
var baseDiffuseEnvironmentLight: vec3f=sampleIrradiance(
normalW
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance 
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,uniforms.reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,uniforms.vReflectionDominantDirection
#endif
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
,uniforms.vReflectionInfos
,viewDirectionW
,base_diffuse_roughness
,base_color
);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=vec3f(0.f,0.f,0.f);
#else
var reflectionCoords: vec2f=vec2f(0.f,0.f);
#endif
let specularAlphaG: f32=specular_roughness*specular_roughness;
#ifdef ANISOTROPIC_BASE
var baseSpecularEnvironmentLight: vec3f=sampleRadianceAnisotropic(specularAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,baseGeoInfo
,normalW
,viewDirectionW
,fragmentInputs.vPositionW
,noise
,reflectionSampler
,reflectionSamplerSampler
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#else
reflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,normalW);var baseSpecularEnvironmentLight: vec3f=sampleRadiance(specularAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,baseGeoInfo
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#endif
#ifdef ANISOTROPIC_BASE
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG*specularAlphaG *max(1.0f-baseGeoInfo.anisotropy,0.3f));
#else
baseSpecularEnvironmentLight=mix(baseSpecularEnvironmentLight.rgb,baseDiffuseEnvironmentLight,specularAlphaG);
#endif
var coatEnvironmentLight: vec3f=vec3f(0.f,0.f,0.f);if (coat_weight>0.0) {
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=vec3f(0.f,0.f,0.f);
#else
var reflectionCoords: vec2f=vec2f(0.f,0.f);
#endif
reflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,coatNormalW);var coatAlphaG: f32=coat_roughness*coat_roughness;
#ifdef ANISOTROPIC_COAT
coatEnvironmentLight=sampleRadianceAnisotropic(coatAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,coatGeoInfo
,coatNormalW
,viewDirectionW
,fragmentInputs.vPositionW
,noise
,reflectionSampler
,reflectionSamplerSampler
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#else
coatEnvironmentLight=sampleRadiance(coatAlphaG,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,coatGeoInfo
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#endif
}
#ifdef FUZZ
let modifiedFuzzRoughness: f32=clamp(fuzz_roughness*(1.0f-0.5f*environmentFuzzBrdf.y),0.0f,1.0f);var fuzzEnvironmentLight=vec3f(0.0f,0.0f,0.0f);var totalWeight=0.0f;let fuzzIblFresnel: f32=sqrt(environmentFuzzBrdf.z);for (var i: i32=0; i<i32(FUZZ_IBL_SAMPLES); i++) {var angle: f32=(f32(i)+noise.x)*(3.141592f*2.0f/f32(FUZZ_IBL_SAMPLES));var fiberCylinderNormal: vec3f=normalize(cos(angle)*fuzzTangent+sin(angle)*fuzzBitangent);let fiberBend=min(environmentFuzzBrdf.x*environmentFuzzBrdf.x*modifiedFuzzRoughness,1.0f);fiberCylinderNormal=normalize(mix(fiberCylinderNormal,fuzzNormalW,fiberBend));let sampleWeight=max(dot(viewDirectionW,fiberCylinderNormal),0.0f);var fuzzReflectionCoords=createReflectionCoords(fragmentInputs.vPositionW,fiberCylinderNormal);let radianceSample: vec3f=sampleRadiance(modifiedFuzzRoughness,uniforms.vReflectionMicrosurfaceInfos.rgb,uniforms.vReflectionInfos
,fuzzGeoInfo
,reflectionSampler
,reflectionSamplerSampler
,fuzzReflectionCoords
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);fuzzEnvironmentLight+=sampleWeight*mix(radianceSample,baseDiffuseEnvironmentLight,fiberBend);totalWeight+=sampleWeight;}
fuzzEnvironmentLight/=totalWeight;
#endif
let dielectricIblFresnel: f32=getReflectanceFromBRDFWithEnvLookup(vec3f(baseDielectricReflectance.F0),vec3f(baseDielectricReflectance.F90),baseGeoInfo.environmentBrdf).r;var dielectricIblColoredFresnel: vec3f=dielectricIblFresnel*specular_color;
#ifdef THIN_FILM
let thinFilmIorScale: f32=clamp(2.0f*abs(thin_film_ior-1.0f),0.0f,1.0f);var thin_film_dielectric: vec3f=evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseDielectricReflectance.coloredF0);let thin_film_desaturation_scale=(thin_film_ior-1.0)*sqrt(thin_film_thickness*0.001f*baseGeoInfo.NdotV);thin_film_dielectric=mix(thin_film_dielectric,vec3(dot(thin_film_dielectric,vec3f(0.3333f))),thin_film_desaturation_scale);dielectricIblColoredFresnel=mix(dielectricIblColoredFresnel,thin_film_dielectric*specular_color,thin_film_weight*thinFilmIorScale);
#endif
var conductorIblFresnel: vec3f=conductorIblFresnel(baseConductorReflectance,baseGeoInfo.NdotV,specular_roughness,baseGeoInfo.environmentBrdf);
#ifdef THIN_FILM
var thinFilmConductorFresnel: vec3f=specular_weight*evalIridescence(thin_film_outside_ior,thin_film_ior,baseGeoInfo.NdotV,thin_film_thickness,baseConductorReflectance.coloredF0);thinFilmConductorFresnel=mix(thinFilmConductorFresnel,vec3(dot(thinFilmConductorFresnel,vec3f(0.3333f))),thin_film_desaturation_scale);conductorIblFresnel=mix(conductorIblFresnel,thinFilmConductorFresnel,thin_film_weight*thinFilmIorScale);
#endif
var coatIblFresnel: f32=0.0;if (coat_weight>0.0) {coatIblFresnel=getReflectanceFromBRDFWithEnvLookup(vec3f(coatReflectance.F0),vec3f(coatReflectance.F90),coatGeoInfo.environmentBrdf).r;}
var slab_diffuse_ibl: vec3f=vec3f(0.,0.,0.);var slab_glossy_ibl: vec3f=vec3f(0.,0.,0.);var slab_metal_ibl: vec3f=vec3f(0.,0.,0.);var slab_coat_ibl: vec3f=vec3f(0.,0.,0.);slab_diffuse_ibl=baseDiffuseEnvironmentLight*uniforms.vLightingIntensity.z;slab_diffuse_ibl*=aoOut.ambientOcclusionColor;slab_glossy_ibl=baseSpecularEnvironmentLight*uniforms.vLightingIntensity.z;slab_metal_ibl=baseSpecularEnvironmentLight*conductorIblFresnel*uniforms.vLightingIntensity.z;var coatAbsorption=vec3f(1.0);if (coat_weight>0.0) {slab_coat_ibl=coatEnvironmentLight*uniforms.vLightingIntensity.z;let hemisphere_avg_fresnel: f32=coatReflectance.F0+0.5f*(1.0f-coatReflectance.F0);var averageReflectance: f32=(coatIblFresnel+hemisphere_avg_fresnel)*0.5f;let roughnessFactor=1.0f-coat_roughness*0.5f;averageReflectance*=roughnessFactor;var darkened_transmission: f32=(1.0f-averageReflectance)*(1.0f-averageReflectance);darkened_transmission=mix(1.0,darkened_transmission,coat_darkening);var sin2: f32=1.0f-coatGeoInfo.NdotV*coatGeoInfo.NdotV;sin2=sin2/(coat_ior*coat_ior);let cos_t: f32=sqrt(1.0f-sin2);let coatPathLength=1.0f/cos_t;let colored_transmission: vec3f=pow(coat_color,vec3f(coatPathLength));coatAbsorption=mix(vec3f(1.0f),colored_transmission*vec3f(darkened_transmission),coat_weight);}
#ifdef FUZZ
let slab_fuzz_ibl=fuzzEnvironmentLight*uniforms.vLightingIntensity.z;
#endif
var slab_subsurface_ibl: vec3f=vec3f(0.,0.,0.);var slab_translucent_base_ibl: vec3f=vec3f(0.,0.,0.);slab_diffuse_ibl*=base_color.rgb;
#define CUSTOM_FRAGMENT_BEFORE_IBLLAYERCOMPOSITION
let material_opaque_base_ibl: vec3f=mix(slab_diffuse_ibl,slab_subsurface_ibl,subsurface_weight);let material_dielectric_base_ibl: vec3f=mix(material_opaque_base_ibl,slab_translucent_base_ibl,transmission_weight);let material_dielectric_gloss_ibl: vec3f=material_dielectric_base_ibl*(1.0-dielectricIblFresnel)+slab_glossy_ibl*dielectricIblColoredFresnel;let material_base_substrate_ibl: vec3f=mix(material_dielectric_gloss_ibl,slab_metal_ibl,base_metalness);let material_coated_base_ibl: vec3f=layer(material_base_substrate_ibl,slab_coat_ibl,coatIblFresnel,coatAbsorption,vec3f(1.0f));
#ifdef FUZZ
material_surface_ibl=layer(material_coated_base_ibl,slab_fuzz_ibl,fuzzIblFresnel*fuzz_weight,vec3(1.0),fuzz_color);
#else
material_surface_ibl=material_coated_base_ibl;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},7377:function(e,t,i){var r=i(68415);i(85370);let n="openpbrFragmentSamplersDeclaration",a=`#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_COLOR,_VARYINGNAME_,BaseColor,_SAMPLERNAME_,baseColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_METALNESS,_VARYINGNAME_,BaseMetalness,_SAMPLERNAME_,baseMetalness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_WEIGHT,_VARYINGNAME_,SpecularWeight,_SAMPLERNAME_,specularWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_COLOR,_VARYINGNAME_,SpecularColor,_SAMPLERNAME_,specularColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS,_VARYINGNAME_,SpecularRoughness,_SAMPLERNAME_,specularRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,SpecularRoughnessAnisotropy,_SAMPLERNAME_,specularRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_WEIGHT,_VARYINGNAME_,CoatWeight,_SAMPLERNAME_,coatWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_COLOR,_VARYINGNAME_,CoatColor,_SAMPLERNAME_,coatColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS,_VARYINGNAME_,CoatRoughness,_SAMPLERNAME_,coatRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_ROUGHNESS_ANISOTROPY,_VARYINGNAME_,CoatRoughnessAnisotropy,_SAMPLERNAME_,coatRoughnessAnisotropy)
#include<samplerFragmentDeclaration>(_DEFINENAME_,COAT_DARKENING,_VARYINGNAME_,CoatDarkening,_SAMPLERNAME_,coatDarkening)
#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_WEIGHT,_VARYINGNAME_,FuzzWeight,_SAMPLERNAME_,fuzzWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_COLOR,_VARYINGNAME_,FuzzColor,_SAMPLERNAME_,fuzzColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,FUZZ_ROUGHNESS,_VARYINGNAME_,FuzzRoughness,_SAMPLERNAME_,fuzzRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_OPACITY,_VARYINGNAME_,GeometryOpacity,_SAMPLERNAME_,geometryOpacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_TANGENT,_VARYINGNAME_,GeometryTangent,_SAMPLERNAME_,geometryTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_TANGENT,_VARYINGNAME_,GeometryCoatTangent,_SAMPLERNAME_,geometryCoatTangent)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSION_COLOR,_VARYINGNAME_,EmissionColor,_SAMPLERNAME_,emissionColor)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_WEIGHT,_VARYINGNAME_,ThinFilmWeight,_SAMPLERNAME_,thinFilmWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,THIN_FILM_THICKNESS,_VARYINGNAME_,ThinFilmThickness,_SAMPLERNAME_,thinFilmThickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT_OCCLUSION,_VARYINGNAME_,AmbientOcclusion,_SAMPLERNAME_,ambientOcclusion)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef FUZZENVIRONMENTBRDF
var environmentFuzzBrdfSamplerSampler: sampler;var environmentFuzzBrdfSampler: texture_2d<f32>;
#endif
#if defined(ANISOTROPIC) || defined(FUZZ)
var blueNoiseSamplerSampler: sampler;var blueNoiseSampler: texture_2d<f32>;
#endif
#ifdef IBL_CDF_FILTERING
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},23412:function(e,t,i){var r=i(68415);let n="openpbrFuzzLayerData",a=`var fuzz_weight: f32=0.0f;var fuzz_color: vec3f=vec3f(1.0);var fuzz_roughness: f32=0.0f;
#ifdef FUZZ
#ifdef FUZZ_WEIGHT
let fuzzWeightFromTexture: vec4=textureSample(fuzzWeightSampler,fuzzWeightSamplerSampler,fragmentInputs.vFuzzWeightUV+uvOffset);
#endif
#ifdef FUZZ_COLOR
var fuzzColorFromTexture: vec4=textureSample(fuzzColorSampler,fuzzColorSamplerSampler,fragmentInputs.vFuzzColorUV+uvOffset);
#endif
#ifdef FUZZ_ROUGHNESS
let fuzzRoughnessFromTexture: vec4=textureSample(fuzzRoughnessSampler,fuzzRoughnessSamplerSampler,fragmentInputs.vFuzzRoughnessUV+uvOffset);
#endif
fuzz_color=uniforms.vFuzzColor.rgb;fuzz_weight=uniforms.vFuzzWeight;fuzz_roughness=uniforms.vFuzzRoughness;
#ifdef FUZZ_WEIGHT
fuzz_weight*=fuzzWeightFromTexture.r;
#endif
#ifdef FUZZ_COLOR
#ifdef FUZZ_COLOR_GAMMA
fuzz_color*=toLinearSpace(fuzzColorFromTexture.rgb);
#else
fuzz_color*=fuzzColorFromTexture.rgb;
#endif
fuzz_color*=uniforms.vFuzzColorInfos.y;
#endif
#if defined(FUZZ_ROUGHNESS) && defined(FUZZ_ROUGHNESS_FROM_TEXTURE_ALPHA)
fuzz_roughness*=fuzzRoughnessFromTexture.a;
#elif defined(FUZZ_ROUGHNESS)
fuzz_roughness*=fuzzRoughnessFromTexture.r;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},21436:function(e,t,i){var r=i(68415);let n="openpbrGeometryInfo",a=`struct geometryInfoOutParams
{NdotV: f32,
NdotVUnclamped: f32,
environmentBrdf: vec3f,
horizonOcclusion: f32};struct geometryInfoAnisoOutParams
{NdotV: f32,
NdotVUnclamped: f32,
environmentBrdf: vec3f,
horizonOcclusion: f32,
anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
TBN: mat3x3<f32>};fn geometryInfo(
normalW: vec3f,viewDirectionW: vec3f,roughness: f32,geometricNormalW: vec3f
)->geometryInfoOutParams
{var outParams: geometryInfoOutParams;outParams.NdotVUnclamped=dot(normalW,viewDirectionW);outParams.NdotV=absEps(outParams.NdotVUnclamped);
#if defined(ENVIRONMENTBRDF)
outParams.environmentBrdf=getBRDFLookup(outParams.NdotV,roughness);
#else
outParams.environmentBrdf=vec3f(0.0);
#endif
outParams.horizonOcclusion=1.0f;
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef HORIZONOCCLUSION
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL)
#ifdef REFLECTIONMAP_3D
outParams.horizonOcclusion=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
return outParams;}
fn geometryInfoAniso(
normalW: vec3f,viewDirectionW: vec3f,roughness: f32,geometricNormalW: vec3f
,vAnisotropy: vec3f,TBN: mat3x3<f32>
)->geometryInfoAnisoOutParams
{let geoInfo: geometryInfoOutParams=geometryInfo(normalW,viewDirectionW,roughness,geometricNormalW);var outParams: geometryInfoAnisoOutParams;outParams.NdotV=geoInfo.NdotV;outParams.NdotVUnclamped=geoInfo.NdotVUnclamped;outParams.environmentBrdf=geoInfo.environmentBrdf;outParams.horizonOcclusion=geoInfo.horizonOcclusion;outParams.anisotropy=vAnisotropy.b;let anisotropyDirection: vec3f=vec3f(vAnisotropy.xy,0.);let anisoTBN: mat3x3<f32>=mat3x3<f32>(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));outParams.anisotropicTangent=normalize(anisoTBN*anisotropyDirection);outParams.anisotropicBitangent=normalize(cross(anisoTBN[2],outParams.anisotropicTangent));outParams.TBN=TBN;return outParams;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},74594:function(e,t,i){var r=i(68415);let n="openpbrIblFunctions",a=`#ifdef REFLECTION
fn sampleIrradiance(
surfaceNormal: vec3f
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradianceSH: vec3f
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,iblMatrix: mat4x4f
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,reflectionDominantDirection: vec3f
#endif
#endif
#ifdef REALTIME_FILTERING
,reflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
,reflectionInfos: vec2f
,viewDirectionW: vec3f
,diffuseRoughness: f32
,surfaceAlbedo: vec3f
)->vec3f {var environmentIrradiance=vec3f(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
var irradianceVector=(iblMatrix*vec4f(surfaceNormal,0.0f)).xyz;let irradianceView=(iblMatrix*vec4f(viewDirectionW,0.0f)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
{let NdotV=max(dot(surfaceNormal,viewDirectionW),0.0f);irradianceVector=mix(irradianceVector,irradianceView,(0.5f*(1.0f-NdotV))*diffuseRoughness);}
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0f;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0f;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradianceSH;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,reflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
let environmentIrradianceFromTexture: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);
#else
let environmentIrradianceFromTexture: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradianceFromTexture.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradianceFromTexture);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
let Ls: vec3f=normalize(reflectionDominantDirection);let NoL: f32=dot(irradianceVector,Ls);let NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm=vec3f(1.0f);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
let LoV: f32=dot (Ls,irradianceView);let mag: f32=length(reflectionDominantDirection)*2.0f;let clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1f),vec3f(1.0f));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0f),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0f,1.0f)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
let H: vec3f=(irradianceView+Ls)*0.5f;let VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=reflectionInfos.x;return environmentIrradiance;}
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(vPositionW: vec3f,normalW: vec3f)->vec3f
#else
fn createReflectionCoords(vPositionW: vec3f,normalW: vec3f)->vec2f
#endif
{var reflectionVector: vec3f=computeReflectionCoords(vec4f(vPositionW,1.0f),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0f-reflectionCoords.y;
#endif
return reflectionCoords;}
fn sampleRadiance(
alphaG: f32
,reflectionMicrosurfaceInfos: vec3f
,reflectionInfos: vec2f
,geoInfo: geometryInfoOutParams
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifdef REALTIME_FILTERING
,reflectionFilteringInfo: vec2f
#endif
)->vec3f {var environmentRadiance: vec4f=vec4f(0.f,0.f,0.f,0.f);
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,alphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(reflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,alphaG);
#endif
reflectionLOD=reflectionLOD*reflectionMicrosurfaceInfos.y+reflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
environmentRadiance=vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionFilteringInfo),1.0f);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
return environmentRadiance.rgb;}
#if defined(ANISOTROPIC)
fn sampleRadianceAnisotropic(
alphaG: f32
,reflectionMicrosurfaceInfos: vec3f
,reflectionInfos: vec2f
,geoInfo: geometryInfoAnisoOutParams
,normalW: vec3f
,viewDirectionW: vec3f
,positionW: vec3f
,noise: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifdef REALTIME_FILTERING
,reflectionFilteringInfo: vec2f
#endif
)->vec3f {var environmentRadiance: vec4f=vec4f(0.f,0.f,0.f,0.f);let alphaT=alphaG*sqrt(2.0f/(1.0f+(1.0f-geoInfo.anisotropy)*(1.0f-geoInfo.anisotropy)));let alphaB=(1.0f-geoInfo.anisotropy)*alphaT;let modifiedAlphaG=alphaB;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,modifiedAlphaG,geoInfo.NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(reflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(reflectionMicrosurfaceInfos.x,modifiedAlphaG);
#endif
reflectionLOD=reflectionLOD*reflectionMicrosurfaceInfos.y+reflectionMicrosurfaceInfos.z;
#ifdef REALTIME_FILTERING
var view=(uniforms.reflectionMatrix*vec4f(viewDirectionW,0.0f)).xyz;var tangent=(uniforms.reflectionMatrix*vec4f(geoInfo.anisotropicTangent,0.0f)).xyz;var bitangent=(uniforms.reflectionMatrix*vec4f(geoInfo.anisotropicBitangent,0.0f)).xyz;var normal=(uniforms.reflectionMatrix*vec4f(normalW,0.0f)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
view.z*=-1.0f;tangent.z*=-1.0f;bitangent.z*=-1.0f;normal.z*=-1.0f;
#endif
environmentRadiance =
vec4f(radianceAnisotropic(alphaT,alphaB,reflectionSampler,reflectionSamplerSampler,
view,tangent,
bitangent,normal,
reflectionFilteringInfo,noise.xy),
1.0f);
#else
const samples: i32=16;var radianceSample=vec4f(0.0);var accumulatedRadiance=vec3f(0.0);var reflectionCoords=vec3f(0.0);var sample_weight=0.0f;var total_weight=0.0f;let step=1.0f/f32(max(samples-1,1));for (var i: i32=0; i<samples; i++) {var t: f32=mix(-1.0,1.0,f32(i)*step);t+=step*2.0*noise.x;sample_weight=max(1.0-abs(t),0.001);sample_weight*=sample_weight;t*=min(4.0*alphaT*geoInfo.anisotropy,1.0);var bentNormal: vec3f;if (t<0.0) {let blend: f32=t+1.0;bentNormal=normalize(mix(-geoInfo.anisotropicTangent,normalW,blend));} else if (t>0.0) {let blend: f32=t;bentNormal=normalize(mix(normalW,geoInfo.anisotropicTangent,blend));} else {bentNormal=normalW;}
reflectionCoords=createReflectionCoords(positionW,bentNormal);radianceSample=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#ifdef RGBDREFLECTION
accumulatedRadiance+=vec3f(sample_weight)*fromRGBD(radianceSample);
#elif defined(GAMMAREFLECTION)
accumulatedRadiance+=vec3f(sample_weight)*toLinearSpace(radianceSample.rgb);
#else
accumulatedRadiance+=vec3f(sample_weight)*radianceSample.rgb;
#endif
total_weight+=sample_weight;}
environmentRadiance=vec4f(accumulatedRadiance/vec3f(total_weight),1.0f);
#endif
environmentRadiance=vec4f(environmentRadiance.rgb*reflectionInfos.xxx,environmentRadiance.a);return environmentRadiance.rgb;}
#endif
fn conductorIblFresnel(reflectance: ReflectanceParams,NdotV: f32,roughness: f32,environmentBrdf: vec3f)->vec3f
{
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let albedoF0: vec3f=mix(reflectance.coloredF0,pow(reflectance.coloredF0,vec3f(1.4f)),roughness);return getF82Specular(NdotV,albedoF0,reflectance.coloredF90,roughness);
#else
return getReflectanceFromBRDFLookup(reflectance.coloredF0,reflectance.coloredF90,environmentBrdf);
#endif
}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},62253:function(e,t,i){var r=i(68415);let n="openpbrNormalMapFragment",a=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(GEOMETRY_NORMAL) || defined(GEOMETRY_COAT_NORMAL) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(GEOMETRY_NORMAL)
var normalScale: f32=uniforms.vGeometryNormalInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#elif defined(GEOMETRY_NORMAL)
var TBNUV: vec2f=select(-fragmentInputs.vGeometryNormalUV,fragmentInputs.vGeometryNormalUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC) || defined(FUZZ)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2);
#else
var TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
#else
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef GEOMETRY_COAT_NORMAL
coatNormalW=perturbNormal(TBN,textureSample(geometryCoatNormalSampler,geometryCoatNormalSamplerSampler,fragmentInputs.vGeometryCoatNormalUV+uvOffset).xyz,uniforms.vGeometryCoatNormalInfos.y);
#endif
#ifdef GEOMETRY_NORMAL
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV+uvOffset).xyz,uniforms.vGeometryNormalInfos.y);
#else
var sampledNormal: vec3f=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(sampledNormal.xy+detailNormal.xy,sampledNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);sampledNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=sampledNormal*dot(sampledNormal,detailNormal)/sampledNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,uniforms.vGeometryNormalInfos.y);
#endif
#elif defined(DETAIL)
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},67260:function(e,t,i){var r=i(68415);i(85370);let n="openpbrNormalMapFragmentFunctions",a=`#if defined(GEOMETRY_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_NORMAL,_VARYINGNAME_,GeometryNormal,_SAMPLERNAME_,geometryNormal)
#endif
#if defined(GEOMETRY_COAT_NORMAL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,GEOMETRY_COAT_NORMAL,_VARYINGNAME_,GeometryCoatNormal,_SAMPLERNAME_,geometryCoatNormal)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(GEOMETRY_NORMAL) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(geometryNormalSampler,geometryNormalSamplerSampler,fragmentInputs.vGeometryNormalUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},25015:function(e,t,i){var r=i(68415);let n="openpbrNormalMapFragmentMainFunctions",a=`#if defined(GEOMETRY_NORMAL) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(FUZZ) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; 
var a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; 
var a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(
(a11*b11-a12*b10+a13*b09)/det,
(a02*b10-a01*b11-a03*b09)/det,
(a31*b05-a32*b04+a33*b03)/det,
(a22*b04-a21*b05-a23*b03)/det,
(a12*b08-a10*b11-a13*b07)/det,
(a00*b11-a02*b08+a03*b07)/det,
(a32*b02-a30*b05-a33*b01)/det,
(a20*b05-a22*b02+a23*b01)/det,
(a10*b10-a11*b08+a13*b06)/det,
(a01*b08-a00*b10-a03*b06)/det,
(a30*b04-a31*b02+a33*b00)/det,
(a21*b02-a20*b04-a23*b00)/det,
(a11*b07-a10*b09-a12*b06)/det,
(a00*b09-a01*b07+a02*b06)/det,
(a31*b01-a30*b03-a32*b00)/det,
(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{var output=normal;
#ifdef NORMALXYSCALE
output=normalize(output* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*output);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},32839:function(e,t,i){var r=i(68415);let n="openpbrNormalMapVertex",a=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(FUZZ)
#if defined(TANGENT) && defined(NORMAL)
var tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},8635:function(e,t,i){var r=i(68415);let n="openpbrNormalMapVertexDeclaration",a=`#if defined(GEOMETRY_NORMAL) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(FUZZ)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},12844:function(e,t,i){var r=i(68415);let n="openpbrThinFilmLayerData",a=`#ifdef THIN_FILM
var thin_film_weight: f32=uniforms.vThinFilmWeight;var thin_film_thickness: f32=uniforms.vThinFilmThickness.r*1000.0f; 
var thin_film_ior: f32=uniforms.vThinFilmIor;
#ifdef THIN_FILM_WEIGHT
var thinFilmWeightFromTexture: f32=textureSample(thinFilmWeightSampler,thinFilmWeightSamplerSampler,fragmentInputs.vThinFilmWeightUV+uvOffset).r*uniforms.vThinFilmWeightInfos.y;
#endif
#ifdef THIN_FILM_THICKNESS
var thinFilmThicknessFromTexture: f32=textureSample(thinFilmThicknessSampler,thinFilmThicknessSamplerSampler,fragmentInputs.vThinFilmThicknessUV+uvOffset).g*uniforms.vThinFilmThicknessInfos.y;
#endif
#ifdef THIN_FILM_WEIGHT
thin_film_weight*=thinFilmWeightFromTexture;
#endif
#ifdef THIN_FILM_THICKNESS
thin_film_thickness*=thinFilmThicknessFromTexture;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},77512:function(e,t,i){var r=i(68415);i(21968),i(88279);let n="openpbrUboDeclaration",a=`uniform vTangentSpaceParams: vec2f;uniform vLightingIntensity: vec4f;uniform pointSize: f32;uniform vDebugMode: vec2f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionDominantDirection: vec3f;uniform vReflectionColor: vec3f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;uniform vBaseWeight: f32;uniform vBaseColor: vec4f;uniform vBaseDiffuseRoughness: f32;uniform vReflectanceInfo: vec4f;uniform vSpecularColor: vec4f;uniform vSpecularAnisotropy: vec3f;uniform vCoatWeight: f32;uniform vCoatColor: vec3f;uniform vCoatRoughness: f32;uniform vCoatRoughnessAnisotropy: f32;uniform vCoatIor: f32;uniform vCoatDarkening : f32;uniform vFuzzWeight: f32;uniform vFuzzColor: vec3f;uniform vFuzzRoughness: f32;uniform vGeometryCoatTangent: vec2f;uniform vEmissionColor: vec3f;uniform vThinFilmWeight: f32;uniform vThinFilmThickness: vec2f;uniform vThinFilmIor: f32;uniform vBaseWeightInfos: vec2f;uniform baseWeightMatrix: mat4x4f;uniform vBaseColorInfos: vec2f;uniform baseColorMatrix: mat4x4f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform vBaseMetalnessInfos: vec2f;uniform baseMetalnessMatrix: mat4x4f;uniform vSpecularWeightInfos: vec2f;uniform specularWeightMatrix: mat4x4f;uniform vSpecularColorInfos: vec2f;uniform specularColorMatrix: mat4x4f;uniform vSpecularRoughnessInfos: vec2f;uniform specularRoughnessMatrix: mat4x4f;uniform vSpecularRoughnessAnisotropyInfos: vec2f;uniform specularRoughnessAnisotropyMatrix: mat4x4f;uniform vCoatWeightInfos: vec2f;uniform coatWeightMatrix: mat4x4f;uniform vCoatColorInfos: vec2f;uniform coatColorMatrix: mat4x4f;uniform vCoatRoughnessInfos: vec2f;uniform coatRoughnessMatrix: mat4x4f;uniform vCoatRoughnessAnisotropyInfos: vec2f;uniform coatRoughnessAnisotropyMatrix: mat4x4f;uniform vCoatDarkeningInfos : vec2f;uniform coatDarkeningMatrix : mat4x4f;uniform vFuzzWeightInfos: vec2f;uniform fuzzWeightMatrix: mat4x4f;uniform vFuzzColorInfos: vec2f;uniform fuzzColorMatrix: mat4x4f;uniform vFuzzRoughnessInfos: vec2f;uniform fuzzRoughnessMatrix: mat4x4f;uniform vGeometryNormalInfos: vec2f;uniform geometryNormalMatrix: mat4x4f;uniform vGeometryTangentInfos: vec2f;uniform geometryTangentMatrix: mat4x4f;uniform vGeometryCoatNormalInfos: vec2f;uniform geometryCoatNormalMatrix: mat4x4f;uniform vGeometryCoatTangentInfos: vec2f;uniform geometryCoatTangentMatrix: mat4x4f;uniform vGeometryOpacityInfos: vec2f;uniform geometryOpacityMatrix: mat4x4f;uniform vEmissionInfos: vec2f;uniform emissionMatrix: mat4x4f;uniform vThinFilmWeightInfos: vec2f;uniform thinFilmWeightMatrix: mat4x4f;uniform vThinFilmThicknessInfos: vec2f;uniform thinFilmThicknessMatrix: mat4x4f;uniform vAmbientOcclusionInfos: vec2f;uniform ambientOcclusionMatrix: mat4x4f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},91762:function(e,t,i){i.r(t),i.d(t,{packingFunctionsWGSL:()=>o});var r=i(68415);let n="packingFunctions",a=`fn pack(depth: f32)->vec4f
{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},15945:function(e,t,i){var r=i(68415);let n="pbrBRDFFunctions",a=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#define BRDF_DIFFUSE_MODEL_EON 0
#define BRDF_DIFFUSE_MODEL_BURLEY 1
#define BRDF_DIFFUSE_MODEL_LAMBERT 2
#define BRDF_DIFFUSE_MODEL_LEGACY 3
#define DIELECTRIC_SPECULAR_MODEL_GLTF 0
#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1
#define CONDUCTOR_SPECULAR_MODEL_GLTF 0
#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1
#if !defined(PBR_VERTEX_SHADER) && !defined(OPENPBR_VERTEX_SHADER)
#ifdef MS_BRDF_ENERGY_CONSERVATION
fn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR 
fn getF82Specular(NdotV: f32,F0: vec3f,edgeTint: vec3f,roughness: f32)->vec3f {const cos_theta_max: f32=0.142857143; 
const one_minus_cos_theta_max_to_the_fifth: f32=0.462664366; 
const one_minus_cos_theta_max_to_the_sixth: f32=0.396569457; 
let white_minus_F0: vec3f=vec3f(1.0f)-F0;let b_numerator: vec3f=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3f(1.0)-edgeTint);const b_denominator: f32=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const b_denominator_reciprocal: f32=1.0f/b_denominator;let b: vec3f=b_numerator*b_denominator_reciprocal; 
let cos_theta: f32=max(roughness,NdotV);let one_minus_cos_theta: f32=1.0-cos_theta;let offset_from_F0: vec3f=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0f);return clamp(F0+offset_from_F0,vec3f(0.0f),vec3f(1.0f));}
#endif
#ifdef FUZZENVIRONMENTBRDF
fn getFuzzBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {let UV: vec2f=vec2f(perceptualRoughness,NdotV);var brdfLookup: vec4f=textureSample(environmentFuzzBrdfSampler,environmentFuzzBrdfSamplerSampler,UV);const RiRange: vec2f=vec2f(0.0f,0.75f);const ARange: vec2f=vec2f(0.005f,0.88f);const BRange: vec2f=vec2f(-0.18f,0.002f);brdfLookup.r=mix(ARange.x, ARange.y, brdfLookup.r);brdfLookup.g=mix(BRange.x, BRange.y, brdfLookup.g);brdfLookup.b=mix(RiRange.x,RiRange.y,brdfLookup.b);return brdfLookup.rgb;}
#endif
#ifdef ENVIRONMENTBRDF
fn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);
#endif
return brdfLookup.rgb;}
fn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
fn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
fn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32
{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
fn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
fn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
fn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
fn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
fn getR0RemappedForClearCoat(f0: vec3f)->vec3f {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
var s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const XYZ_TO_REC709: mat3x3f= mat3x3f(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
fn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}
fn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}
fn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}
fn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
var cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}
var phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); 
var R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}
if (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}
if (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}
var opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)
{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}
return max(I, vec3f(0.0));}
#endif
fn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32
{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
fn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32
{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
fn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
fn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {
#ifdef MOBILE
var GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
var a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
fn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
var alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
fn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
fn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
fn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
fn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
fn l(x: f32,alphaG: f32)->f32
{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
fn lambdaSheen(cosTheta: f32,alphaG: f32)->f32
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
fn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
const constant1_FON: f32=0.5f-2.0f/(3.0f*PI);const constant2_FON: f32=2.0f/3.0f-28.0f/(15.0f*PI);fn E_FON_approx(mu: f32,roughness: f32)->f32
{var sigma: f32=roughness; 
var mucomp: f32=1.0f-mu;var mucomp2: f32=mucomp*mucomp;const Gcoeffs: mat2x2f=mat2x2f(0.0571085289f,-0.332181442f,
0.491881867f,0.0714429953f);var GoverPi: f32=dot(Gcoeffs*vec2f(mucomp,mucomp2),vec2f(1.0f,mucomp2));return (1.0f+sigma*GoverPi)/(1.0f+constant1_FON*sigma);}
fn diffuseBRDF_EON(albedo: vec3f,roughness: f32,NdotL: f32,NdotV: f32,LdotV: f32)->vec3f
{var rho: vec3f=albedo;var sigma: f32=roughness; 
var mu_i: f32=NdotL; 
var mu_o: f32=NdotV; 
var s: f32=LdotV-mu_i*mu_o; 
var sovertF: f32=select(s,s/max(mu_i,mu_o),s>0.0f); 
var AF: f32=1.0f/(1.0f+constant1_FON*sigma); 
var f_ss: vec3f=(rho*RECIPROCAL_PI)*AF*(1.0f+sigma*sovertF); 
var EFo: f32=E_FON_approx(mu_o,sigma); 
var EFi: f32=E_FON_approx(mu_i,sigma); 
var avgEF: f32=AF*(1.0f+constant2_FON*sigma); 
var rho_ms: vec3f=(rho*rho)*avgEF/(vec3f(1.0f)-rho*(1.0f-avgEF));const eps: f32=1.0e-7f;var f_ms: vec3f=(rho_ms*RECIPROCAL_PI)*max(eps,1.0f-EFo) 
* max(eps,1.0f-EFi)
/ max(eps,1.0f-avgEF);return (f_ss+f_ms);}
fn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
fn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
fn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}
#endif
#endif 
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},80725:function(e,t,i){var r=i(68415);i(82473);let n="pbrBlockAlbedoOpacity",a=`struct albedoOpacityOutParams
{surfaceAlbedo: vec3f,
alpha: f32};
#define pbr_inline
fn albedoOpacityBlock(
vAlbedoColor: vec4f
#ifdef ALBEDO
,albedoTexture: vec4f
,albedoInfos: vec2f
#endif
,baseWeight: f32
#ifdef BASE_WEIGHT
,baseWeightTexture: vec4f
,vBaseWeightInfos: vec2f
#endif
#ifdef OPACITY
,opacityMap: vec4f
,vOpacityInfos: vec2f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
#ifdef DECAL
,decalColor: vec4f
,vDecalInfos: vec4f
#endif
)->albedoOpacityOutParams
{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=fragmentInputs.vColor.rgb;
#endif
#ifdef DETAIL
var detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASE_WEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},6528:function(e,t,i){var r=i(68415);let n="pbrBlockAlphaFresnel",a=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}
#define pbr_inline
fn alphaFresnelBlock(
normalW: vec3f,
viewDirectionW: vec3f,
alpha: f32,
microSurface: f32
)->alphaFresnelOutParams
{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;
#ifdef LINEARALPHAFRESNEL
var opacity0: f32=opacityPerceptual;
#else
var opacity0: f32=opacityPerceptual*opacityPerceptual;
#endif
var opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE) {discard;}
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},70634:function(e,t,i){var r=i(68415);let n="pbrBlockAmbientOcclusion",a=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap_: vec3f,
vAmbientInfos: vec4f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},8986:function(e,t,i){var r=i(68415);let n="pbrBlockAnisotropic",a=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
anisotropicNormal: vec3f,
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
anisotropyMapData: vec3f
#endif
};
#define pbr_inline
fn anisotropicBlock(
vAnisotropy: vec3f,
roughness: f32,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData: vec3f,
#endif
TBN: mat3x3f,
normalW: vec3f,
viewDirectionW: vec3f
)->anisotropicOutParams
{ 
var outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
var amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
amd=amd*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);
#else
anisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);
#endif
#endif
var anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},91621:function(e,t,i){var r=i(68415);let n="pbrBlockClearcoat",a=`struct clearcoatOutParams
{specularEnvironmentR0: vec3f,
conservationFactor: f32,
clearCoatNormalW: vec3f,
clearCoatAARoughnessFactors: vec2f,
clearCoatIntensity: f32,
clearCoatRoughness: f32,
#ifdef REFLECTION
finalClearCoatRadianceScaled: vec3f,
#endif
#ifdef CLEARCOAT_TINT
absorption: vec3f,
clearCoatNdotVRefract: f32,
clearCoatColor: vec3f,
clearCoatThickness: f32,
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
energyConservationFactorClearCoat: vec3f,
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
TBNClearCoat: mat3x3f,
#endif
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData: vec2f,
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
clearCoatTintMapData: vec4f,
#endif
#ifdef REFLECTION
environmentClearCoatRadiance: vec4f,
clearCoatEnvironmentReflectance: vec3f,
#endif
clearCoatNdotV: f32
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
fn clearcoatBlock(
vPositionW: vec3f
,geometricNormalW: vec3f
,viewDirectionW: vec3f
,vClearCoatParams: vec2f
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData: vec4f
#endif
,specularEnvironmentR0: vec3f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams: vec4f
,clearCoatColorAtDistance: f32
,vClearCoatRefractionParams: vec4f
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData: vec4f
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos: vec2f
,clearCoatBumpMapData: vec4f
,vClearCoatBumpUV: vec2f
#if defined(TANGENT) && defined(NORMAL)
,vTBN: mat3x3f
#else
,vClearCoatTangentSpaceParams: vec2f
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix: mat4x4f
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal: vec3f
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,frontFacingMultiplier: f32
#endif 
)->clearcoatOutParams
{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
var clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
var specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
var specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
var clearCoatNormalScale: f32=1.0;
#else
var clearCoatNormalScale: f32=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBNClearCoat: mat3x3f=vTBN;
#else
var TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
var clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
var environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
var clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
var environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;
#else
var clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
environmentClearCoatRadiance=sampleReflectionTexture(
clearCoatAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,clearCoatNdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,clearCoatRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,clearCoatReflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
var fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},42542:function(e,t,i){var r=i(68415);let n="pbrBlockDirectLighting",a=`var diffuseBase: vec3f=vec3f(0.,0.,0.);
#ifdef SS_TRANSLUCENCY
var diffuseTransmissionBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SPECULARTERM
var specularBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef CLEARCOAT
var clearCoatBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SHEEN
var sheenBase: vec3f=vec3f(0.,0.,0.);
#endif
#if defined(SPECULARTERM) && defined(LIGHT0)
var coloredFresnel: vec3f=vec3f(0.,0.,0.);
#endif
var preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; 
var aggShadow: f32=0.;var numLights: f32=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
var absorption: vec3f=vec3f(0.);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},65228:function(e,t,i){var r=i(68415);let n="pbrBlockFinalColorComposition",a=`var finalColor: vec4f= vec4f(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);
#else
finalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);
#endif
#endif
#endif
finalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},45678:function(e,t,i){var r=i(68415);let n="pbrBlockFinalLitComponents",a=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
var baseSpecularEnergyConservationFactor: vec3f=getEnergyConservationFactor(vec3f(reflectanceF0),environmentBrdf);var coloredEnergyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo=vec3f(1.-reflectanceF0)*surfaceAlbedo.rgb;
#endif
#endif
#endif
#ifdef REFLECTION
var finalIrradiance: vec3f=reflectionOut.environmentIrradiance;
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)
var baseSpecularEnergy: vec3f=vec3f(baseSpecularEnvironmentReflectance);
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
baseSpecularEnergy*=baseSpecularEnergyConservationFactor;
#endif
#endif
finalIrradiance*=clamp(vec3f(1.0)-baseSpecularEnergy,vec3f(0.0),vec3f(1.0));
#endif
#endif
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
var finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
var finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
var finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
var luminanceOverAlpha: f32=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},80379:function(e,t,i){var r=i(68415);let n="pbrBlockFinalUnlitComponents",a=`var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo;
#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)
finalDiffuse*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)
finalDiffuse+=diffuseTransmissionBase;
#endif
finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
var emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= uniforms.vEmissiveInfos.y;
#endif
finalEmissive*=uniforms.vLightingIntensity.y;
#ifdef AMBIENT
var ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);
#else
var ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},90763:function(e,t,i){var r=i(68415);let n="pbrBlockGeometryInfo",a=`var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
var environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
var ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;
#else
var ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);
#endif
var seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},26745:function(e,t,i){var r=i(68415);let n="pbrBlockImageProcessing",a=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
finalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},27907:function(e,t,i){var r=i(68415);let n="pbrBlockIridescence",a=`struct iridescenceOutParams
{iridescenceIntensity: f32,
iridescenceIOR: f32,
iridescenceThickness: f32,
specularEnvironmentR0: vec3f};
#ifdef IRIDESCENCE
fn iridescenceBlock(
vIridescenceParams: vec4f
,viewAngle_: f32
,specularEnvironmentR0: vec3f
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData: vec2f
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData: vec2f
#endif
#ifdef CLEARCOAT
,NdotVUnclamped: f32
,vClearCoatParams: vec2f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#endif
)->iridescenceOutParams
{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;var viewAngle=viewAngle_;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
var iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; 
#ifdef CLEARCOAT
var clearCoatIntensity: f32=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));
#endif
var iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},4223:function(e,t,i){var r=i(68415);let n="pbrBlockLightmapInit",a=`#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},97234:function(e,t,i){var r=i(68415);let n="pbrBlockNormalFinal",a=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=select(normalW,-normalW,fragmentInputs.frontFacing);
#else
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},59391:function(e,t,i){var r=i(68415);let n="pbrBlockNormalGeometric",a=`var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(input.vNormalW);
#else
var normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;
#endif
var geometricNormalW: vec3f=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},69491:function(e,t,i){var r=i(68415);let n="pbrBlockPrePass",a=`#if SCENE_MRT_COUNT>0
var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
var sqAlbedo : vec3f=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
var irradiance : vec3f=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); 
#else
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); 
#endif
#elif defined(PREPASS_COLOR)
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
fragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4f(fragmentInputs.vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},26457:function(e,t,i){var r=i(68415);let n="pbrBlockReflectance",a=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),environmentBrdf);
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let metalEnvironmentReflectance: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);var colorSpecularEnvironmentReflectance: vec3f=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);
#else
var colorSpecularEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);
#endif
#ifdef RADIANCEOCCLUSION
colorSpecularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
colorSpecularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
var colorSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),sqrt(microSurface));
#endif
#ifdef CLEARCOAT
colorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
colorSpecularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},62469:function(e,t,i){var r=i(68415);let n="pbrBlockReflectance0",a=`var reflectanceF0: f32=reflectivityOut.reflectanceF0;var specularEnvironmentR0: vec3f=reflectivityOut.colorReflectanceF0;var specularEnvironmentR90: vec3f= reflectivityOut.reflectanceF90;
#ifdef ALPHAFRESNEL
var reflectance90: f32=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},94726:function(e,t,i){var r=i(68415);let n="pbrBlockReflection",a=`#ifdef REFLECTION
struct reflectionOutParams
{environmentRadiance: vec4f
,environmentIrradiance: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionCoords: vec3f
#else
,reflectionCoords: vec2f
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector: vec3f
#endif
#endif
#endif
};
#define pbr_inline
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec3f
{var reflectionCoords: vec3f;
#else
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec2f
{ 
var reflectionCoords: vec2f;
#endif
#ifdef ANISOTROPIC
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
fn sampleReflectionTexture(
alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif 
)->vec4f
{var environmentRadiance: vec4f;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
var automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);
#else
var requestedReflectionLOD: f32=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
textureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
var envRadiance=environmentRadiance.rgb;
#ifdef RGBDREFLECTION
envRadiance=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
envRadiance=toLinearSpaceVec3(environmentRadiance.rgb);
#endif
envRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}
#define pbr_inline
fn reflectionBlock(
vPositionW: vec3f
,normalW: vec3f
,alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance: vec3f
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix: mat4x4f
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler 
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler 
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,reflectionDominantDirection: vec3f
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
,viewDirectionW: vec3f
,diffuseRoughness: f32
,surfaceAlbedo: vec3f
)->reflectionOutParams
{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f= vec3f(0.);
#else
var reflectionCoords: vec2f= vec2f(0.);
#endif
reflectionCoords=createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif 
);environmentRadiance=sampleReflectionTexture(
alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#else
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
var irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;
#else
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#endif
var irradianceView: vec3f= (reflectionMatrix* vec4f(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
var NdotV: f32=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);
#else
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
var Ls: vec3f=normalize(reflectionDominantDirection);var NoL: f32=dot(irradianceVector,Ls);var NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm: vec3f=vec3f(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,irradianceView);var mag: f32=length(reflectionDominantDirection)*2.0f;var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0f)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(irradianceView+Ls)*0.5f;var VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance4.rgb*diffuseRoughnessTerm;
#else
environmentIrradiance=environmentIrradiance4.rgb;
#endif
#ifdef RGBDREFLECTION
environmentIrradiance=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4f(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},17049:function(e,t,i){var r=i(68415);let n="pbrBlockReflectivity",a=`struct reflectivityOutParams
{microSurface: f32,
roughness: f32,
diffuseRoughness: f32,
reflectanceF0: f32,
reflectanceF90: vec3f,
colorReflectanceF0: vec3f,
colorReflectanceF90: vec3f,
#ifdef METALLICWORKFLOW
surfaceAlbedo: vec3f,
metallic: f32,
specularWeight: f32,
dielectricColorF0: vec3f,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
ambientOcclusionColor: vec3f,
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
#ifdef REFLECTIVITY
surfaceMetallicColorMap: vec4f,
#endif
metallicF0: vec3f,
#else
#ifdef REFLECTIVITY
surfaceReflectivityColorMap: vec4f,
#endif
#endif
#endif
};
#define pbr_inline
fn reflectivityBlock(
reflectivityColor: vec4f
#ifdef METALLICWORKFLOW
,surfaceAlbedo: vec3f
,metallicReflectanceFactors: vec4f
#endif
,baseDiffuseRoughness: f32
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture: f32
,baseDiffuseRoughnessInfos: vec2f
#endif
#ifdef REFLECTIVITY
,reflectivityInfos: vec3f
,surfaceMetallicOrReflectivityColorMap: vec4f
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,ambientOcclusionColorIn: vec3f
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel: vec4f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
)->reflectivityOutParams
{var outParams: reflectivityOutParams;var microSurface: f32=reflectivityColor.a;var surfaceReflectivityColor: vec3f=reflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var metallicRoughness: vec2f=surfaceReflectivityColor.rg;var ior: f32=surfaceReflectivityColor.b;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
var aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
var detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;var dielectricF0 : f32=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=dielectricF0*surfaceReflectivityColor;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo=baseColor.rgb*(vec3f(1.0)-vec3f(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);
#else
outParams.surfaceAlbedo=baseColor.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
{let reflectivityColor: vec3f=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}
#else
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
let maxF0: f32=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0f,outParams.metallic);
#else
outParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.reflectanceF90=vec3(outParams.specularWeight);var f90Scale: f32=1.0;
#else
var f90Scale: f32=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(
outParams.specularWeight*f90Scale,1.0,outParams.metallic));
#endif
outParams.dielectricColorF0=vec3f(dielectricF0*surfaceReflectivityColor);var metallicColorF0: vec3f=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
let dielectricColorF90
: vec3f=surfaceReflectivityColor *
vec3f(outParams.specularWeight*f90Scale);
#else
let dielectricColorF90
: vec3f=vec3f(outParams.specularWeight*f90Scale);
#endif
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let conductorColorF90: vec3f=surfaceReflectivityColor;
#else
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
let conductorColorF90: vec3f=outParams.reflectanceF90;
#else
let conductorColorF90: vec3f=vec3f(1.0f);
#endif
#endif
outParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
outParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3f(1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
outParams.colorReflectanceF90=surfaceReflectivityColor;
#else
outParams.colorReflectanceF90=vec3(1.0);
#endif
#endif
microSurface=saturate(microSurface);var roughness: f32=1.-microSurface;var diffuseRoughness: f32=baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
diffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;
#endif
outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},45354:function(e,t,i){var r=i(68415);let n="pbrBlockSheen",a=`#ifdef SHEEN
struct sheenOutParams
{sheenIntensity: f32
,sheenColor: vec3f
,sheenRoughness: f32
#ifdef SHEEN_LINKWITHALBEDO
,surfaceAlbedo: vec3f
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
,sheenAlbedoScaling: f32
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,finalSheenRadianceScaled: vec3f
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,sheenEnvironmentReflectance: vec3f
#endif
#endif
};
#define pbr_inline
fn sheenBlock(
vSheenColor: vec4f
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness: f32
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData: vec4f
#endif
#endif
,roughness: f32
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
,sheenMapLevel: f32
#endif
,reflectance: f32
#ifdef SHEEN_LINKWITHALBEDO
,baseColor: vec3f
,surfaceAlbedo: vec3f
#endif
#ifdef ENVIRONMENTBRDF
,NdotV: f32
,environmentBrdf: vec3f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors: vec2f
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
,NdotVUnclamped: f32
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo: f32
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho: f32
#endif
#endif
)->sheenOutParams
{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
var sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
var sheenColor: vec3f=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor*=toLinearSpaceVec3(sheenMapData.rgb);
#else
sheenColor*=sheenMapData.rgb;
#endif
sheenColor*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
var sheenRoughness: f32=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
var sheenRoughness: f32=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
var environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
var environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);
#else
var environmentSheenBrdf: vec3f=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
var sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
var environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(
sheenAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,sheenRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},28938:function(e,t,i){var r=i(68415);let n="pbrBlockSubSurface",a=`struct subSurfaceOutParams
{specularEnvironmentReflectance: vec3f,
#ifdef SS_REFRACTION
finalRefraction: vec3f,
surfaceAlbedo: vec3f,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha: f32,
#endif
refractionOpacity: f32,
#endif
#ifdef SS_TRANSLUCENCY
transmittance: vec3f,
translucencyIntensity: f32,
#ifdef REFLECTION
refractionIrradiance: vec3f,
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap: vec4f,
#endif
#ifdef SS_REFRACTION
environmentRefraction: vec4f,
refractionTransmittance: vec3f
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
fn sampleEnvironmentRefraction(
ior: f32
,thickness: f32
,refractionLOD: f32
,normalW: vec3f
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef ANISOTROPIC
var refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
var refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;
#else
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;
#endif
var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
var lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
var automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);
#else
var requestedRefractionLOD: f32=lod;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
var lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
textureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
textureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
var refraction=environmentRefraction.rgb;
#ifdef SS_RGBDREFRACTION
refraction=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
refraction=toLinearSpaceVec3(environmentRefraction.rgb);
#endif
return vec4f(refraction,environmentRefraction.a);}
#endif
#define pbr_inline
fn subSurfaceBlock(
vSubSurfaceIntensity: vec3f
,vThicknessParam: vec2f
,vTintColor: vec4f
,normalW: vec3f
,specularEnvironmentReflectance: vec3f
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap: vec4f
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap: vec4f
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap: vec4f
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix: mat4x4f
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector_: vec3f
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo: vec3f
#endif
#ifdef SS_REFRACTION
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,vLightingIntensity: vec4f
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha: f32
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped: f32
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness: f32
#endif
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
#ifdef SS_DISPERSION
,dispersion: f32
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance: vec3f
,vTranslucencyColor: vec4f
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap: vec4f
#endif
#endif
)->subSurfaceOutParams
{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
var refractionIntensity: f32=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
var translucencyIntensity: f32=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
var thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
var thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
var thickness: f32=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
var transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
var ior: f32=vRefractionInfos.y;
#else
var ior: f32=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
var refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
var refraction_ior: f32=vRefractionInfos.y;
#ifdef SS_DISPERSION
var realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];
#endif
var envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#else
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);
#endif
#ifdef SS_REFRACTION
var refractionTransmittance: vec3f= vec3f(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
var maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);
#else
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo*=outParams.refractionOpacity;
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
var bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3f(1.0)-specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
var irradianceVector: vec3f=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
var refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
var refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var irradianceCoords: vec3f=irradianceVector;
#else
var irradianceCoords: vec2f=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
var temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;
#ifdef RGBDREFLECTION
refractionIrradiance=fromRGBD(temp).rgb;
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance=toLinearSpaceVec3(refractionIrradiance);
#endif
#else
var refractionIrradiance: vec3f= vec3f(0.);
#endif
refractionIrradiance*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance;
#endif
return outParams;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},74809:function(e,t,i){var r=i(68415);let n="pbrDebug",a=`#if DEBUGMODE>0
if (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;
#if DEBUGMODE==1
color=fragmentInputs.vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
color=fragmentInputs.vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
color=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
color=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
color=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
color= vec3f(input.vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
color= vec3f(input.vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
color=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
color=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
color=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
color=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
color=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
color=lightmapColor;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
color= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
color=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
color=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
color=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
color=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
color=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
color=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
color=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
color=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
color=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
color=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
color=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
color=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
color=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
color=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
color=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
color= vec3f(reflectivityOut.metallic);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
color=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
color= vec3f(roughness);
#elif DEBUGMODE==64
color= vec3f(alphaG);
#elif DEBUGMODE==65
color= vec3f(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
color=clearcoatOut.clearCoatColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
color=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
color=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
color= vec3f(microSurface);
#elif DEBUGMODE==73
color=uniforms.vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
color=uniforms.vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
color=uniforms.vEmissiveColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
color= vec3f(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
color= vec3f(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
color= vec3f(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=baseSpecularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
color=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
color= vec3f(luminanceOverAlpha);
#elif DEBUGMODE==87
color= vec3f(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
color= vec3f(albedoTexture.a);
#elif DEBUGMODE==89
color=aoOut.ambientOcclusionColor;
#else
var stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);
#endif
color*=uniforms.vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
color=normalize(color)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
color=toGammaSpaceVec3(color);
#endif
fragmentOutputs.color=vec4f(color,1.0);
#ifdef PREPASS
fragmentOutputs.fragData0=toLinearSpaceVec3(color); 
fragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return fragmentOutputs;
#endif
}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},93154:function(e,t,i){var r=i(68415);let n="pbrDirectLightingFalloffFunctions",a=`fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32
{return max(0.,1.0-length(lightOffset)/range);}
fn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32
{return 1.0/maxEps(lightDistanceSquared);}
fn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32
{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
fn computeDirectionalLightFalloff_IES(lightDirection: vec3f,directionToLightCenterW: vec3f,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32
{var cosAngle: f32=dot(-lightDirection,directionToLightCenterW);var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
fn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32
{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
fn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32
{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; 
var concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
fn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32
{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
fn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},7632:function(e,t,i){var r=i(68415);i(16866),i(62469);let n="pbrDirectLightingFunctions",a=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{diffuse: vec3f,
#ifdef SS_TRANSLUCENCY
diffuseTransmission: vec3f,
#endif
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef CLEARCOAT
clearCoat: vec4f,
#endif
#ifdef SHEEN
sheen: vec3f
#endif
};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
var lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
fn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {return info.areaLightDiffuse*lightColor;}
#endif
fn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: vec3f=vec3f(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}
#ifdef SS_TRANSLUCENCY
fn computeDiffuseTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var transmittanceNdotL=vec3f(0.0);var NdotL: f32=absEps(info.NdotLUnclamped);
#ifndef SS_TRANSLUCENCY_LEGACY
if (info.NdotLUnclamped<0.0) {
#endif
var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);
#ifndef SS_TRANSLUCENCY_LEGACY
}
var diffuseTerm : vec3f=vec3f(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3f(diffuseBRDF_Burley(
info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3f(diffuseBRDF_Burley(
info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,
info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return (transmittanceNdotL*diffuseTerm)*info.attenuation*lightColor;
#else
let diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
#endif
}
#endif
#ifdef SPECULARTERM
fn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,fresnel: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var modifiedFresnel: vec3f=fresnel;
#ifdef IRIDESCENCE
modifiedFresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
var smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
var smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
var specTerm: vec3f=modifiedFresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaSpecularLighting(info: preLightingInfo,specularColor: vec3f,reflectance0: vec3f,reflectance90: vec3f)->vec3f {var fresnel:vec3f =reflectance0*specularColor*info.areaLightFresnel.x+( vec3f( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#ifdef FUZZ
fn evalFuzz(L: vec3f,NdotL: f32,NdotV: f32,T: vec3f,B: vec3f,ltcLut: vec3f)->f32
{if (NdotL<=0.0f || NdotV<=0.0f) {return 0.0f;}
let M=mat3x3f(
vec3f(ltcLut.r,0.0f,0.0f),
vec3f(ltcLut.g,1.0f,0.0f),
vec3f(0.0f,0.0f,1.0f)
);let Llocal: vec3f=vec3f(dot(L,T),dot(L,B),NdotL);let Lwarp: vec3f=normalize(M*Llocal);let cosThetaWarp: f32=max(Lwarp.z,0.0f);return cosThetaWarp*NdotL;}
#endif
#if defined(ANISOTROPIC) && defined(ANISOTROPIC_OPENPBR)
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=vec3f(distribution*smithVisibility);return specTerm*info.attenuation*info.NdotL*lightColor;}
#elif defined(ANISOTROPIC)
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
fn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
fn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
fn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
var visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
var visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
var sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
fn computeClusteredLighting(
lightDataTexture: texture_2d<f32>,
tileMaskBuffer: ptr<storage,array<u32>>,
lightData: vec4f,
sliceRange: vec2u,
V: vec3f,
N: vec3f,
posW: vec3f,
surfaceAlbedo: vec3f,
reflectivityOut: reflectivityOutParams,
#ifdef IRIDESCENCE
iridescenceIntensity: f32,
#endif
#ifdef SS_TRANSLUCENCY
subSurfaceOut: subSurfaceOutParams,
#endif
#ifdef SPECULARTERM
AARoughnessFactor: f32,
#endif
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
#ifdef SHEEN
sheenOut: sheenOutParams,
#endif
#ifdef CLEARCOAT
clearcoatOut: clearcoatOutParams,
#endif
)->lightingInfo {let NdotV=absEps(dot(N,V));
#include<pbrBlockReflectance0>
#ifdef CLEARCOAT
specularEnvironmentR0=clearcoatOut.specularEnvironmentR0;
#endif
var result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; 
let maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if light.vLightDirection.w>=0.0 {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}
preInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
var info: lightingInfo;
#ifdef SS_TRANSLUCENCY
#ifdef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR
let metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);let coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);
#else
let coloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
let NdotH=dot(N,preInfo.H);let fresnel=fresnelSchlickGGXVec3(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
let absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
result.diffuse+=info.diffuse;
#ifdef SS_TRANSLUCENCY
result.diffuseTransmission+=info.diffuseTransmission;
#endif
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
#ifdef CLEARCOAT
result.clearCoat+=info.clearCoat;
#endif
#ifdef SHEEN
result.sheen+=info.sheen;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},32063:function(e,t,i){var r=i(68415);i(4528);let n="pbrDirectLightingSetupFunctions",a=`struct preLightingInfo
{lightOffset: vec3f,
lightDistanceSquared: f32,
lightDistance: f32,
attenuation: f32,
L: vec3f,
H: vec3f,
NdotV: f32,
NdotLUnclamped: f32,
NdotL: f32,
VdotH: f32,
LdotV: f32,
roughness: f32,
diffuseRoughness: f32,
surfaceAlbedo: vec3f,
#ifdef IRIDESCENCE
iridescenceIntensity: f32
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
areaLightDiffuse: vec3f,
#ifdef SPECULARTERM
areaLightSpecular: vec3f,
areaLightFresnel: vec4f
#endif
#endif
};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);return result;}
fn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaPreLightingInfo(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightCenter:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->preLightingInfo {var result: preLightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightCenter,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse+=data.Diffuse;return result;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},41134:function(e,t,i){var r=i(68415);i(12064);let n="pbrFragmentExtraDeclaration",a=`varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying vViewDepth: f32;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},96925:function(e,t,i){var r=i(68415);i(85370);let n="samplerFragmentAlternateDeclaration",a=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o="pbrFragmentSamplersDeclaration",s=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
var clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
var sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
var refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;
#endif
#else
var refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;
#endif
`;r.l.IncludesShadersStoreWGSL[o]||(r.l.IncludesShadersStoreWGSL[o]=s)},94655:function(e,t,i){var r=i(68415);let n="pbrHelperFunctions",a=`#define MINIMUMVARIANCE 0.0005
fn convertRoughnessToAverageSlope(roughness: f32)->f32
{return roughness*roughness+MINIMUMVARIANCE;}
fn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}
fn getAARoughnessFactors(normalVector: vec3f)->vec2f {
#ifdef SPECULARAA
var nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2f(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#elif ANISOTROPIC_OPENPBR
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=alphaG*sqrt(2.0/(1.0+(1.0-anisotropy)*(1.0-anisotropy)));var alphaB: f32=max(alphaT*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
#else
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
fn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}
fn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
fn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}
fn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
fn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32
{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},76702:function(e,t,i){var r=i(68415);let n="pbrIBLFunctions",a=`#if defined(REFLECTION) || defined(SS_REFRACTION)
fn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}
fn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
fn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
fn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
fn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}
fn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},69884:function(e,t,i){var r=i(68415);i(21968),i(88279);let n="pbrUboDeclaration",a=`uniform vAlbedoInfos: vec2f;uniform vBaseWeightInfos: vec2f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform baseWeightMatrix: mat4x4f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform vAlbedoColor: vec4f;uniform baseWeight: f32;uniform baseDiffuseRoughness: f32;uniform vLightingIntensity: vec4f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform cameraInfo: vec4f;uniform vReflectionInfos: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionDominantDirection: vec3f;uniform vReflectionColor: vec3f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},27378:function(e,t,i){var r=i(68415);let n="prePassDeclaration",a=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying vNormViewDepth: f32;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},65490:function(e,t,i){var r=i(68415);let n="prePassVertex",a=`#ifdef PREPASS_DEPTH
vertexOutputs.vViewPos=(scene.view*worldPos).rgb;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
vertexOutputs.vNormViewDepth=((scene.view*worldPos).z-uniforms.cameraInfo.x)/(uniforms.cameraInfo.y-uniforms.cameraInfo.x);
#endif
#ifdef PREPASS_LOCAL_POSITION
vertexOutputs.vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},96980:function(e,t,i){var r=i(68415);let n="prePassVertexDeclaration",a=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying vNormViewDepth: f32;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},71499:function(e,t,i){i.r(t),i.d(t,{reflectionFunctionWGSL:()=>o});var r=i(68415);let n="reflectionFunction",a=`fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }
fn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }
fn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}
fn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}
fn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}
fn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix*(view*worldPos)).xyz;}
fn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}
#ifdef REFLECTION
fn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);
#endif
#ifndef REFLECTIONMAP_CUBIC
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3f(0,0,0);
#endif
}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},85370:function(e,t,i){var r=i(68415);let n="samplerFragmentDeclaration",a=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
var _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},20556:function(e,t,i){var r=i(68415);let n="samplerVertexDeclaration",a=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying v_VARYINGNAME_UV: vec2f;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},56600:function(e,t,i){var r=i(68415);let n="samplerVertexImplementation",a=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (uniforms.v_INFONAME_==0.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uvUpdated,1.0,0.0)).xy;}
#ifdef UV2
else if (uniforms.v_INFONAME_==1.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uv2Updated,1.0,0.0)).xy;}
#endif
#ifdef UV3
else if (uniforms.v_INFONAME_==2.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv3,1.0,0.0)).xy;}
#endif
#ifdef UV4
else if (uniforms.v_INFONAME_==3.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv4,1.0,0.0)).xy;}
#endif
#ifdef UV5
else if (uniforms.v_INFONAME_==4.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv5,1.0,0.0)).xy;}
#endif
#ifdef UV6
else if (uniforms.v_INFONAME_==5.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv6,1.0,0.0)).xy;}
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},45071:function(e,t,i){var r=i(68415);let n="screenSpaceRayTrace",a=`fn distanceSquared(a: vec2f,b: vec2f)->f32 { 
var temp=a-b; 
return dot(temp,temp); }
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
fn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
return -(near*far)/(far-depth*(far-near));
#else
return (near*far)/(far-depth*(far-near));
#endif
}
#endif
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera. Should be the actual near plane if screen-space depth is enabled.
param farPlaneZ The far plane for the camera. Used when screen-space depth is enabled.
param stride Step in horizontal or vertical pixels between samples. This is a var because: f32 integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avar self: voidnull collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPovar Camera: i32 space location of the ray hit
*/
fn traceScreenSpaceRay1(
csOrigin: vec3f,
csDirection: vec3f,
projectToPixelMatrix: mat4x4f,
csZBuffer: texture_2d<f32>,
csZBufferSize: vec2f,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
csZBackBuffer: texture_2d<f32>,
csZBackSizeFactor: f32,
#endif
csZThickness: f32,
nearPlaneZ: f32,
farPlaneZ: f32,
stride: f32,
jitterFraction: f32,
maxSteps: f32,
maxRayTraceDistance: f32,
selfCollisionNumSkip: f32,
startPixel: ptr<function,vec2f>,
hitPixel: ptr<function,vec2f>,
csHitPoint: ptr<function,vec3f>,
numIterations: ptr<function,f32>
#ifdef SSRAYTRACE_DEBUG
,debugColor: ptr<function,vec3f>
#endif
)->bool
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
var rayLength: f32=select(maxRayTraceDistance,(-nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ);
#else
var rayLength: f32=select(maxRayTraceDistance,(nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ);
#endif
var csEndPoint: vec3f=csOrigin+csDirection*rayLength;*hitPixel= vec2f(-1.0,-1.0);var H0: vec4f=projectToPixelMatrix* vec4f(csOrigin,1.0);var H1: vec4f=projectToPixelMatrix* vec4f(csEndPoint,1.0);var k0: f32=1.0/H0.w;var k1: f32=1.0/H1.w;var Q0: vec3f=csOrigin*k0;var Q1: vec3f=csEndPoint*k1;var P0: vec2f=H0.xy*k0;var P1: vec2f=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
var xMax: f32=csZBufferSize.x-0.5;var xMin=0.5;var yMax=csZBufferSize.y-0.5;var yMin=0.5;var alpha: f32=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-select(yMin,yMax,(P1.y>yMax)))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-select(xMin,xMax,(P1.x>xMax)))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
var stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f= vec2f(stepDirection,delta.y*invdx);var dQ: vec3f=(Q1-Q0)*invdx;var dk: f32=(k1-k0)*invdx;var zMin: f32=min(csEndPoint.z,csOrigin.z);var zMax: f32=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;var pqk: vec4f= vec4f(P0,Q0.z,k0);var dPQK: vec4f= vec4f(dP,dQ.z,dk);*startPixel=select(P0.xy,P0.yx,permute);var prevZMaxEstimate: f32=csOrigin.z;var rayZMin: f32=prevZMaxEstimate;var rayZMax=prevZMaxEstimate;var sceneZMax: f32=rayZMax+1e4;var end: f32=P1.x*stepDirection;var hit: bool=false;var stepCount: f32;for (stepCount=0.0;(stepCount<=selfCollisionNumSkip) ||
((pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0);pqk+=dPQK 
)
{*hitPixel=select(pqk.xy,pqk.yx,permute);rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
var t: f32=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
if (sceneZMax==0.0) { sceneZMax=1e8; }
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) { sceneBackZ=-1e8; }
hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
if (sceneBackZ==0.0) { sceneBackZ=1e8; }
hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
stepCount+=1.0;}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;var invStride: f32=1.0/stride;dPQK*=invStride;var refinementStepCount: f32=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
((refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0));pqk+=dPQK)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);*hitPixel=select(pqk.xy,pqk.yx,permute);sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
refinementStepCount+=1.0;}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0=vec3f(Q0.xy+dQ.xy*stepCount,pqk.z);*csHitPoint=Q0/pqk.w;*numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {*debugColor= vec3f(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {*debugColor= vec3f(1,0,0);} else if (sceneZMax==0.0) {*debugColor= vec3f(1,1,0);} else {*debugColor= vec3f(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32,projection: mat4x4f,invProjectionMatrix: mat4x4f)->vec3f {var xy=texCoord*2.0-1.0;var z: f32;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
z=-projection[2].z*depth+projection[3].z;
#else
z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
z=projection[2].z*depth+projection[3].z;
#else
z=projection[2].z+projection[3].z/depth;
#endif
#endif
var w=1.0;var ndc=vec4f(xy,z,w);var eyePos: vec4f=invProjectionMatrix*ndc;var result=eyePos.xyz/eyePos.w;return result;}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},56206:function(e,t,i){i.r(t),i.d(t,{shadowMapFragmentWGSL:()=>o});var r=i(68415);let n="shadowMapFragment",a=`var depthSM: f32=fragmentInputs.vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
depthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
depthSM=clamp(depthSM,0.0,1.0);
#ifdef USE_REVERSE_DEPTHBUFFER
fragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
fragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
fragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);
#else
fragmentOutputs.color=pack(depthSM);
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},72870:function(e,t,i){var r=i(68415);i(91762);let n="bayerDitherFunctions",a=`fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}
fn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5*((_P)%(4.0))); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
fn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5 *((_P)%(4.0))); 
var P4: vec2f=floor(0.25*((_P)%(8.0))); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o="shadowMapFragmentExtraDeclaration",s=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform softTransparentShadowSM: vec2f;
#endif
varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
uniform lightDataSM: vec3f;varying vPositionWSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;r.l.IncludesShadersStoreWGSL[o]||(r.l.IncludesShadersStoreWGSL[o]=s)},984:function(e,t,i){i.r(t),i.d(t,{shadowsFragmentFunctionsWGSL:()=>o});var r=i(68415);let n="shadowsFragmentFunctions",a=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
fn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32
{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
fn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
return select(1.0,darkness,depth>shadow);}
fn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};
#else
if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};
#endif
return min(1.0,visibility+darkness);}
fn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
fn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
fn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}
fn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}
fn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
#else
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32
{
#ifdef IS_NDC_HALF_ZRANGE
return clipSpace.z;
#else
return uvDepth.z;
#endif
}
const GREATEST_LESS_THAN_ONE: f32=0.99999994;
#define DISABLE_UNIFORMITY_ANALYSIS
fn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (
vec3f(0.06407013,0.05409927,0.),
vec3f(0.7366577,0.5789394,0.),
vec3f(-0.6270542,-0.5320278,0.),
vec3f(-0.4096107,0.8411095,0.),
vec3f(0.6849564,-0.4990818,0.),
vec3f(-0.874181,-0.04579735,0.),
vec3f(0.9989998,0.0009880066,0.),
vec3f(-0.004920578,-0.9151649,0.),
vec3f(0.1805763,0.9747483,0.),
vec3f(-0.2138451,0.2635818,0.),
vec3f(0.109845,0.3884785,0.),
vec3f(0.06876755,-0.3581074,0.),
vec3f(0.374073,-0.7661266,0.),
vec3f(0.3079132,-0.1216763,0.),
vec3f(-0.3794335,-0.8271583,0.),
vec3f(-0.203878,-0.07715034,0.),
vec3f(0.5912697,0.1469799,0.),
vec3f(-0.88069,0.3031784,0.),
vec3f(0.5040108,0.8283722,0.),
vec3f(-0.5844124,0.5494877,0.),
vec3f(0.6017799,-0.1726654,0.),
vec3f(-0.5554981,0.1559997,0.),
vec3f(-0.3016369,-0.3900928,0.),
vec3f(-0.5550632,-0.1723762,0.),
vec3f(0.925029,0.2995041,0.),
vec3f(-0.2473137,0.5538505,0.),
vec3f(0.9183037,-0.2862392,0.),
vec3f(0.2469421,0.6718712,0.),
vec3f(0.3916397,-0.4328209,0.),
vec3f(-0.03576927,-0.6220032,0.),
vec3f(-0.04661255,0.7995201,0.),
vec3f(0.4402924,0.3640312,0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.)
);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (
vec3f(-0.613392,0.617481,0.),
vec3f(0.170019,-0.040254,0.),
vec3f(-0.299417,0.791925,0.),
vec3f(0.645680,0.493210,0.),
vec3f(-0.651784,0.717887,0.),
vec3f(0.421003,0.027070,0.),
vec3f(-0.817194,-0.271096,0.),
vec3f(-0.705374,-0.668203,0.),
vec3f(0.977050,-0.108615,0.),
vec3f(0.063326,0.142369,0.),
vec3f(0.203528,0.214331,0.),
vec3f(-0.667531,0.326090,0.),
vec3f(-0.098422,-0.295755,0.),
vec3f(-0.885922,0.215369,0.),
vec3f(0.566637,0.605213,0.),
vec3f(0.039766,-0.396100,0.),
vec3f(0.751946,0.453352,0.),
vec3f(0.078707,-0.715323,0.),
vec3f(-0.075838,-0.529344,0.),
vec3f(0.724479,-0.580798,0.),
vec3f(0.222999,-0.215125,0.),
vec3f(-0.467574,-0.405438,0.),
vec3f(-0.248268,-0.814753,0.),
vec3f(0.354411,-0.887570,0.),
vec3f(0.175817,0.382366,0.),
vec3f(0.487472,-0.063082,0.),
vec3f(-0.084078,0.898312,0.),
vec3f(0.488876,-0.783441,0.),
vec3f(0.470016,0.217933,0.),
vec3f(-0.696890,-0.549791,0.),
vec3f(-0.149693,0.605762,0.),
vec3f(0.034211,0.979980,0.),
vec3f(0.503098,-0.308878,0.),
vec3f(-0.016205,-0.872921,0.),
vec3f(0.385784,-0.393902,0.),
vec3f(-0.146886,-0.859249,0.),
vec3f(0.643361,0.164098,0.),
vec3f(0.634388,-0.049471,0.),
vec3f(-0.688894,0.007843,0.),
vec3f(0.464034,-0.188818,0.),
vec3f(-0.440840,0.137486,0.),
vec3f(0.364483,0.511704,0.),
vec3f(0.034028,0.325968,0.),
vec3f(0.099094,-0.308023,0.),
vec3f(0.693960,-0.366253,0.),
vec3f(0.678884,-0.204688,0.),
vec3f(0.001801,0.780328,0.),
vec3f(0.145177,-0.898984,0.),
vec3f(0.062655,-0.611866,0.),
vec3f(0.315226,-0.604297,0.),
vec3f(-0.780145,0.486251,0.),
vec3f(-0.371868,0.882138,0.),
vec3f(0.200476,0.494430,0.),
vec3f(-0.494552,-0.711051,0.),
vec3f(0.612476,0.705252,0.),
vec3f(-0.578845,-0.768792,0.),
vec3f(-0.772454,-0.090976,0.),
vec3f(0.504440,0.372295,0.),
vec3f(0.155736,0.065157,0.),
vec3f(0.391522,0.849605,0.),
vec3f(-0.620106,-0.328104,0.),
vec3f(0.789239,-0.419965,0.),
vec3f(-0.545396,0.538133,0.),
vec3f(-0.178564,-0.596057,0.)
);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}
fn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}
blockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
exitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}
var offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}
fn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
fn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
fn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
fn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},62475:function(e,t,i){i.r(t),i.d(t,{shadowsVertexWGSL:()=>o});var r=i(68415);let n="shadowsVertex",a=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;
#if SHADOWCSMNUM_CASCADES{X}>0
vertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#if SHADOWCSMNUM_CASCADES{X}>1
vertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>2
vertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>3
vertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a);let o={name:n,shader:a}},76672:function(e,t,i){var r=i(68415);let n="subSurfaceScatteringFunctions",a=`fn testLightingForSSS(diffusionProfile: f32)->bool
{return diffusionProfile<1.;}`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},92697:function(e,t,i){var r=i(68415);let n="uvAttributeDeclaration",a=`#ifdef UV{X}
attribute uv{X}: vec2f;
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},65529:function(e,t,i){var r=i(68415);let n="uvVariableDeclaration",a=`#ifdef MAINUV{X}
#if !defined(UV{X})
var uv{X}: vec2f=vec2f(0.,0.);
#else
var uv{X}: vec2f=vertexInputs.uv{X};
#endif
vertexOutputs.vMainUV{X}=uv{X};
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},81647:function(e,t,i){var r=i(68415);let n="vertexColorMixing",a=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vertexOutputs.vColor=vec4f(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vertexOutputs.vColor*=vertexInputs.color;
#else
vertexOutputs.vColor=vec4f(vertexOutputs.vColor.rgb*vertexInputs.color.rgb,vertexOutputs.vColor.a);
#endif
#endif
#ifdef INSTANCESCOLOR
vertexOutputs.vColor*=vertexInputs.instanceColor;
#endif
#endif
`;r.l.IncludesShadersStoreWGSL[n]||(r.l.IncludesShadersStoreWGSL[n]=a)},98486:function(e,t,i){var r=i(68415);let n="boundingInfoComputeShader",a=`struct Results {minX : atomic<i32>,
minY : atomic<i32>,
minZ : atomic<i32>,
maxX : atomic<i32>,
maxY : atomic<i32>,
maxZ : atomic<i32>,
dummy1 : i32,
dummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}
fn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}
fn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
const identity=mat4x4f(
vec4f(1.0,0.0,0.0,0.0),
vec4f(0.0,1.0,0.0,0.0),
vec4f(0.0,0.0,1.0,0.0),
vec4f(0.0,0.0,0.0,1.0)
);struct Settings {morphTargetTextureInfo: vec3f,
morphTargetCount: f32,
indexResult : u32,};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;
#if NUM_BONE_INFLUENCERS>0
@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;
#if NUM_BONE_INFLUENCERS>4
@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;
#endif
#endif
#ifdef MORPHTARGETS
@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;
#endif
#ifdef MORPHTARGETS
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}
fn readVector4FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec4f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0);}
#endif
@compute @workgroup_size(256,1,1)
fn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}
let position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
let matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;
#endif 
#endif 
finalWorld=finalWorld*influence;
#endif
#ifdef MORPHTARGETS
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (f32(i)>=settings.morphTargetCount) {break;}
positionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}
#endif
var worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a)},45228:function(e,t,i){i.r(t),i.d(t,{gaussianSplattingPixelShaderWGSL:()=>o});var r=i(68415);i(5430),i(91873),i(85402),i(70877),i(40128);let n="gaussianSplattingPixelShader",a=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplattingFragmentDeclaration>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
fragmentOutputs.color=gaussianColor(input.vColor,input.vPosition);}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},36698:function(e,t,i){i.r(t),i.d(t,{gaussianSplattingVertexShaderWGSL:()=>o});var r=i(68415);i(21968),i(88279),i(29969),i(36136),i(93996),i(91873),i(97573),i(62350),i(31290),i(98731);let n="gaussianSplattingVertexShader",a=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#include<helperFunctions>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute splatIndex0: vec4f;attribute splatIndex1: vec4f;attribute splatIndex2: vec4f;attribute splatIndex3: vec4f;attribute position: vec3f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;uniform kernelSize: f32;uniform eyePosition: vec3f;uniform viewDirectionFactor: vec3f;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;
#if SH_DEGREE>0
var shTexture0: texture_2d<u32>;
#endif
#if SH_DEGREE>1
var shTexture1: texture_2d<u32>;
#endif
#if SH_DEGREE>2
var shTexture2: texture_2d<u32>;
#endif
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplatting>
@vertex
fn main(input : VertexInputs)->FragmentInputs {let splatIndex: f32=getSplatIndex(i32(input.position.z+0.5),input.splatIndex0,input.splatIndex1,input.splatIndex2,input.splatIndex3);var splat: Splat=readSplat(splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position.xy;
#if SH_DEGREE>0
let worldRot: mat3x3f= mat3x3f(mesh.world[0].xyz,mesh.world[1].xyz,mesh.world[2].xyz);let normWorldRot: mat3x3f=inverseMat3(worldRot);var dir: vec3f=normalize(normWorldRot*(worldPos.xyz-uniforms.eyePosition.xyz));dir*=uniforms.viewDirectionFactor;vertexOutputs.vColor=vec4f(splat.color.xyz+computeSH(splat,dir),splat.color.w);
#else
vertexOutputs.vColor=splat.color;
#endif
vertexOutputs.position=gaussianSplatting(input.position.xy,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport,uniforms.kernelSize);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},46745:function(e,t,i){var r=i(68415);i(70877),i(72870);let n="gaussianSplattingDepthPixelShader",a=`#include<gaussianSplattingFragmentDeclaration>
#include<shadowMapFragmentExtraDeclaration>
varying vPosition: vec2f;varying vColor: vec4f;fn checkDiscard(inPosition: vec2f,inColor: vec4f)->vec4f {var A : f32=-dot(inPosition,inPosition);var alpha : f32=exp(A)*inColor.a;
#if defined(SM_SOFTTRANSPARENTSHADOW) && SM_SOFTTRANSPARENTSHADOW==1
if (A<-4.) {discard;}
#else
if (A<-1.) {discard;}
#endif
return vec4f(inColor.rgb,alpha);}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=checkDiscard(fragmentInputs.vPosition,fragmentInputs.vColor);
#if defined(SM_SOFTTRANSPARENTSHADOW) && SM_SOFTTRANSPARENTSHADOW==1
var alpha : f32=fragmentOutputs.color.a;
#endif
}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a)},47763:function(e,t,i){var r=i(68415);i(21968),i(88279),i(97573);let n="gaussianSplattingDepthVertexShader",a=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute splatIndex0: vec4f;attribute splatIndex1: vec4f;attribute splatIndex2: vec4f;attribute splatIndex3: vec4f;attribute position: vec3f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;uniform kernelSize: f32;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;varying vPosition: vec2f;varying vColor: vec4f;
#include<gaussianSplatting>
@vertex
fn main(input : VertexInputs)->FragmentInputs {let splatIndex: f32=getSplatIndex(i32(input.position.z+0.5),input.splatIndex0,input.splatIndex1,input.splatIndex2,input.splatIndex3);var splat: Splat=readSplat(splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position.xy;vertexOutputs.vColor=splat.color;vertexOutputs.position=gaussianSplatting(input.position.xy,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport,uniforms.kernelSize);}`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a)},76808:function(e,t,i){var r=i(68415);let n="gpuUpdateParticlesComputeShader",a=`struct Particle {position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifdef FLOWMAP
flowMapProjection : mat4x4<f32>,
flowMapStrength : f32,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
#ifdef DIRECTEDCONEEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
#ifdef FLOWMAP
@binding(12) @group(1) var flowMapSampler : sampler;@binding(13) @group(1) var flowMapTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}
@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}
let PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); 
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
#ifdef DIRECTEDCONEEMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
if (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef FLOWMAP
var clipSpace=(params.flowMapProjection*vec4f(position,1.));var ndcSpace=clipSpace.xyz/clipSpace.w;var flowMapUV=ndcSpace.xy*0.5+0.5;var flowMapValue=textureSampleLevel(flowMapTexture,flowMapSampler,flowMapUV,0.);var flowMapDirection=(flowMapValue.xyz*2.0-1.0)*flowMapValue.w;updatedDirection+=flowMapDirection*timeDelta*params.flowMapStrength;
#endif
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}
else {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a)},99245:function(e,t,i){i.r(t),i.d(t,{imageProcessingPixelShaderWGSL:()=>o});var r=i(68415);i(71196),i(29969),i(18125);let n="imageProcessingPixelShader",a=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);result=vec4f(max(result.rgb,vec3f(0.)),result.a);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result=vec4f(toLinearSpaceVec3(result.rgb),result.a);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
fragmentOutputs.color=result;}`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},69871:function(e,t,i){i.r(t),i.d(t,{lightProxyPixelShaderWGSL:()=>o});var r=i(68415);let n="lightProxyPixelShader",a=`flat varying vOffset: u32;flat varying vMask: u32;uniform tileMaskResolution: vec3f;var<storage,read_write> tileMaskBuffer: array<atomic<u32>>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let maskResolution=vec2u(uniforms.tileMaskResolution.yz);let tilePosition=vec2u(fragmentInputs.position.xy);let tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y+fragmentInputs.vOffset;atomicOr(&tileMaskBuffer[tileIndex],fragmentInputs.vMask);}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},29081:function(e,t,i){i.r(t),i.d(t,{lightProxyVertexShaderWGSL:()=>o});var r=i(68415);i(21968),i(16866);let n="lightProxyVertexShader",a=`attribute position: vec3f;flat varying vOffset: u32;flat varying vMask: u32;
#include<sceneUboDeclaration>
var lightDataTexture: texture_2d<f32>;uniform tileMaskResolution: vec3f;uniform halfTileRes: vec2f;
#include<clusteredLightingFunctions>
@vertex
fn main(input: VertexInputs)->FragmentInputs {let light=getClusteredLight(lightDataTexture,vertexInputs.instanceIndex);let range=light.vLightFalloff.x;let viewPosition=scene.view*vec4f(light.vLightData.xyz,1);let viewPositionSq=viewPosition*viewPosition;let distSq=viewPositionSq.xy+viewPositionSq.z;let sinSq=(range*range)/distSq;let cosSq=max(1.0-sinSq,vec2f(0.01));let sinCos=vertexInputs.position.xy*sqrt(sinSq*cosSq);let rotatedX=mat2x2f(cosSq.x,-sinCos.x,sinCos.x,cosSq.x)*viewPosition.xz;let rotatedY=mat2x2f(cosSq.y,-sinCos.y,sinCos.y,cosSq.y)*viewPosition.yz;let projX=scene.projection*vec4f(rotatedX.x,0,rotatedX.y,1);let projY=scene.projection*vec4f(0,rotatedY.x,rotatedY.y,1);var projPosition=vec2f(projX.x/max(projX.w,0.01),projY.y/max(projY.w,0.01));projPosition=select(vertexInputs.position.xy,projPosition,cosSq>vec2(0.01));let halfTileRes=uniforms.tileMaskResolution.xy/2.0;var tilePosition=(projPosition+1.0)*halfTileRes;tilePosition=select(floor(tilePosition)-0.01,ceil(tilePosition)+0.01,vertexInputs.position.xy>vec2f(0));vertexOutputs.position=vec4f(tilePosition/halfTileRes-1.0,0,1);vertexOutputs.vOffset=vertexInputs.instanceIndex/CLUSTLIGHT_BATCH;vertexOutputs.vMask=1u<<(vertexInputs.instanceIndex % CLUSTLIGHT_BATCH);}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},70084:function(e,t,i){var r=i(68415);let n="lightingVolumeComputeShader",a=`struct Params {invViewProjMatrix : mat4x4f,
startVertexIndex: u32,
step: f32,
tesselation: u32,};@group(0) @binding(0) var shadowMap : texture_2d<f32>;@group(0) @binding(1) var<uniform> params : Params;@group(0) @binding(2) var<storage,read_write> positions : array<f32>;@compute @workgroup_size(8,8,1)
fn main(@builtin(global_invocation_id) global_id : vec3u) {let coord=global_id.xy;
#ifdef KEEP_EDGES
if (any(coord>=vec2u(params.tesselation)) || any(coord<=vec2u(0))) {
#else
if (any(coord>=vec2u(params.tesselation+1))) {
#endif
return;}
let stepY=floor(params.step*f32(coord.y));let depthCoord=vec2u(u32(floor(f32(coord.x)*params.step)),u32(stepY));var depth=textureLoad(shadowMap,depthCoord,0).r;
#ifdef MOVE_FAR_DEPTH_TO_NEAR
if (depth==1.0) {depth=0.0;}
#endif
let halfTesselation=f32(params.tesselation>>1);let ndc=vec4f((f32(coord.x)-halfTesselation)/halfTesselation,(f32(coord.y)-halfTesselation)/halfTesselation,depth,1.0);var worldCoords=params.invViewProjMatrix*ndc;let idx=params.startVertexIndex+(coord.y*(params.tesselation+1)+coord.x)*3;positions[idx]=worldCoords.x/worldCoords.w;positions[idx+1]=worldCoords.y/worldCoords.w;positions[idx+2]=worldCoords.z/worldCoords.w;}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a)},91432:function(e,t,i){i.r(t),i.d(t,{postprocessVertexShaderWGSL:()=>o});var r=i(68415);let n="postprocessVertexShader",a=`attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},71353:function(e,t,i){i.r(t),i.d(t,{taaPixelShaderWGSL:()=>o});var r=i(68415);let n="taaPixelShader",a=`varying vUV: vec2f;var textureSampler: texture_2d<f32>;var historySampler: texture_2d<f32>;
#ifdef TAA_REPROJECT_HISTORY
var historySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;
#endif
uniform factor: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let pos=vec2i(fragmentInputs.position.xy);let c=textureLoad(textureSampler,pos,0);
#ifdef TAA_REPROJECT_HISTORY
let v=textureLoad(velocitySampler,pos,0);var h=textureSample(historySampler,historySamplerSampler,input.vUV+v.xy);
#else
var h=textureLoad(historySampler,pos,0);
#endif
#ifdef TAA_CLAMP_HISTORY
var cmin=vec4f(1);var cmax=vec4f(0);for (var x=-1; x<=1; x+=1) {for (var y=-1; y<=1; y+=1) {let c=textureLoad(textureSampler,pos+vec2i(x,y),0);cmin=min(cmin,c);cmax=max(cmax,c);}}
h=clamp(h,cmin,cmax);
#endif
fragmentOutputs.color= mix(h,c,uniforms.factor);}
`;r.l.ShadersStoreWGSL[n]||(r.l.ShadersStoreWGSL[n]=a);let o={name:n,shader:a}},19313:function(){},88052:function(e,t,i){i.d(t,{j:()=>l});var r=i(44043),n=i(33909),a=i(57480),o=i(35846),s=i(97782);class l{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){let t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&a.V.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,n=null,a){let o;this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=a?.pixelPerfect??!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=n,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new r.h(e,this._vertexData,!0,this._vertexBufferSize);const s=this._buffer.createVertexBuffer(r.R.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),l=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing);let c=6;if(this._useInstancing){const t=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new r.h(e,t,!1,2),o=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else o=this._buffer.createVertexBuffer("offsets",c,2,this._vertexBufferSize,this._useInstancing),c+=2;const f=this._buffer.createVertexBuffer("inverts",c,2,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer("cellInfo",c+2,4,this._vertexBufferSize,this._useInstancing),d=this._buffer.createVertexBuffer(r.R.ColorKind,c+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[r.R.PositionKind]=s,this._vertexBuffers.options=l,this._vertexBuffers.offsets=o,this._vertexBuffers.inverts=f,this._vertexBuffers.cellInfo=u,this._vertexBuffers[r.R.ColorKind]=d,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!l.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,23531)),Promise.resolve().then(i.bind(i,50849))])):await Promise.all([Promise.resolve().then(i.bind(i,91260)),Promise.resolve().then(i.bind(i,75318))]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){if(this._isDisposed||!this._shadersLoaded)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new n.E(this._engine),this._drawWrapperDepth=new n.E(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+="#define PIXEL_PERFECT\n"),this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode&&this._fogEnabled&&(e+="#define FOG\n"),this._useLogarithmicDepth&&(e+="#define LOGARITHMICDEPTH\n"),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[r.R.PositionKind,"options","offsets","inverts","cellInfo",r.R.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperBase.effect._refCount++,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,n=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!e.length)return;let a=this._drawWrapperBase,l=this._drawWrapperDepth,c=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode,f=a.effect;if(!f.isReady())return;let u=this._engine,d=!!(this._scene&&this._scene.useRightHandedSystem),h=Math.min(this._capacity,e.length),p=0,m=!0,_=this._scene?.floatingOriginOffset||s.Pq.ZeroReadOnly;for(let i=0;i<h;i++){let r=e[i];if(!r||!r.isVisible)continue;m=!1,r._animate(t);let a=this.texture.getBaseSize();this._appendSpriteVertex(p++,r,0,0,a,d,n,_),this._useInstancing||(this._appendSpriteVertex(p++,r,1,0,a,d,n,_),this._appendSpriteVertex(p++,r,1,1,a,d,n,_),this._appendSpriteVertex(p++,r,0,1,a,d,n,_))}if(m)return;this._buffer.update(this._vertexData);let g=!!u.depthCullingState.cull,v=u.depthCullingState.zOffset,S=u.depthCullingState.zOffsetUnits;if(u.setState(g,v,!1,!1,void 0,void 0,S),u.enableEffect(a),f.setTexture("diffuseSampler",this.texture),f.setMatrix("view",i),f.setMatrix("projection",r),c){let e=this._scene;f.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),f.setColor3("vFogColor",e.fogColor)}this.useLogarithmicDepth&&this._scene&&(0,o.D)(a.defines,f,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=u.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,f)),u.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):u.bindBuffers(this._vertexBuffers,this._indexBuffer,f),u.depthCullingState.depthFunc=u.useReverseDepthBuffer?518:515,this.disableDepthWrite||(f.setBool("alphaTest",!0),u.setColorWrite(!1),u.enableEffect(l),this._useInstancing?u.drawArraysType(7,0,4,p):u.drawElementsType(0,0,p/4*6),u.enableEffect(a),u.setColorWrite(!0),f.setBool("alphaTest",!1)),u.setAlphaMode(this.blendMode),this._useInstancing?u.drawArraysType(7,0,4,p):u.drawElementsType(0,0,p/4*6),this.autoResetAlpha&&u.setAlphaMode(0),d&&this._scene.getEngine().setState(g,v,!1,!0,void 0,void 0,S),u.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,n,a,o,s){let l=e*this._vertexBufferSize;if(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),o)o(t,n);else{t.cellIndex||(t.cellIndex=0);let e=n.width/this.cellWidth,i=t.cellIndex/e|0;t._xOffset=(t.cellIndex-i*e)*this.cellWidth/n.width,t._yOffset=i*this.cellHeight/n.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x-s.x,this._vertexData[l+1]=t.position.y-s.y,this._vertexData[l+2]=t.position.z-s.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=i,this._vertexData[l+7]=r),a?this._vertexData[l+8]=+!t.invertU:this._vertexData[l+8]=+!!t.invertU,this._vertexData[l+9]=+!!t.invertV,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/n.width,this._vertexData[l+13]=t._ySize/n.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){let e=[],t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){for(let e in this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild(),this._vertexBuffers)this._vertexBuffers[e]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}l.ForceGLSL=!1},91196:function(e,t,i){i.d(t,{X:()=>r});class r{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,n){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=n,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}},49606:function(){},49518:function(e,t,i){i.d(t,{H:()=>s,r:()=>o});var r=i(76937),n=i(57884),a=i(88267);class o extends n.B{constructor(e,t,i,r,n,a,o=null){super(e,t,i,r,a),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=n,this.createRTTProvider=a,this._originalInternalTexture=o}}class s extends a.T{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this.onRenderTargetTextureCreatedObservable=new r.cP,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t="none"){let i=this._lastSubImages.get(t),r=+("right"==t),n=e.colorTextureWidth??e.textureWidth,a=e.colorTextureHeight??e.textureHeight;if(!this._renderTargetTextures[r]||i?.textureWidth!==n||i?.textureHeight!==a){let i,o=e.depthStencilTextureWidth??n,s=e.depthStencilTextureHeight??a;(n===o||a===s)&&(i=e.depthStencilTexture),this._renderTargetTextures[r]=this._createRenderTargetTexture(n,a,null,e.colorTexture,i,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:a},this.onRenderTargetTextureCreatedObservable.notifyObservers({texture:this._renderTargetTextures[r],eye:t})}return this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){let t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){let t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e?.eye)}_setViewportForSubImage(e,t){let i=t.colorTextureWidth??t.textureWidth,r=t.colorTextureHeight??t.textureHeight,n=t.viewport;e.x=n.x/i,e.y=n.y/r,e.width=n.width/i,e.height=n.height/r}trySetViewportForView(e,t){let i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}},1159:function(e,t,i){i.d(t,{g:()=>n,y:()=>o});var r=i(49518);class n extends r.r{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,e=>new a(e,i,this)),this.layer=e}}class a extends r.H{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){let t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){let i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}let o={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1,clearOnAccess:!1}},57884:function(e,t,i){i.d(t,{B:()=>r});class r{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){let t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,n){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=n,this._rttWrapper=null}}},14036:function(){},27450:function(e,t,i){i.r(t),i.d(t,{FlowGraphGLTFDataProvider:()=>a});var r=i(16065),n=i(23911);class a extends r.e{constructor(e){super();const t=e.glTF,i=t.animations?.map(e=>e._babylonAnimationGroup)||[];this.animationGroups=this.registerDataOutput("animationGroups",n.Vv,i);const r=t.nodes?.map(e=>e._babylonTransformNode)||[];this.nodes=this.registerDataOutput("nodes",n.Vv,r)}getClassName(){return"FlowGraphGLTFDataProvider"}}},23751:function(e,t,i){i.d(t,{tQ:()=>p,Wt:()=>h,ZU:()=>m,oR:()=>_});var r=i(97782),n=i(96892),a=i(55322),o=i(53727);let s=[{regex:RegExp("^/nodes/\\d+/extensions/")}];class l{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t,i=this._gltf,r=this._infoTree;if(!e.startsWith("/"))throw Error("Path must start with a /");let n=e.split("/");if(n.shift(),n[n.length-1].includes(".length")){let e=n[n.length-1].split(".");n.pop(),n.push(...e)}let a=!1;for(let o of n){let n="length"===o;if(n&&!r.__array__)throw Error(`Path ${e} is invalid`);if(r.__ignoreObjectTree__&&(a=!0),r.__array__&&!n)r=r.__array__;else if(!(r=r[o]))throw Error(`Path ${e} is invalid`);if(!a)if(void 0===i){if(!s.find(t=>t.regex.test(e)))throw Error(`Path ${e} is invalid`)}else n||(i=i?.[o]);(r.__target__||n)&&(t=i)}return{object:t,info:r}}}function c(e,t,i,r){let n=f(e,t);return r?n[i][r]:n[i]}function f(e,t,i){return e._data?.[i?.fillMode??n.Y.MATERIAL_TriangleFillMode]?.babylonMaterial}function u(e,t){return{offset:{componentsCount:2,type:"Vector2",get:(i,n,a)=>{let o=c(i,a,e,t);return new r.I9(o?.uOffset,o?.vOffset)},getTarget:f,set:(i,r,n,a)=>{let o=c(r,a,e,t);o.uOffset=i.x,o.vOffset=i.y},getPropertyName:[()=>`${e}${t?"."+t:""}.uOffset`,()=>`${e}${t?"."+t:""}.vOffset`]},rotation:{type:"number",get:(i,r,n)=>c(i,n,e,t)?.wAng,getTarget:f,set:(i,r,n,a)=>c(r,a,e,t).wAng=i,getPropertyName:[()=>`${e}${t?"."+t:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(i,n,a)=>{let o=c(i,a,e,t);return new r.I9(o?.uScale,o?.vScale)},getTarget:f,set:(i,r,n,a)=>{let o=c(r,a,e,t);o.uScale=i.x,o.vScale=i.y},getPropertyName:[()=>`${e}${t?"."+t:""}.uScale`,()=>`${e}${t?"."+t:""}.vScale`]}}}let d={cameras:{__array__:{__target__:!0,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:e=>new r.I9(e._babylonCamera?.orthoLeft??0,e._babylonCamera?.orthoRight??0),set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.orthoLeft=e.x,t._babylonCamera.orthoRight=e.y)},getTarget:e=>e,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:e=>new r.I9(e._babylonCamera?.orthoBottom??0,e._babylonCamera?.orthoTop??0),set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.orthoBottom=e.x,t._babylonCamera.orthoTop=e.y)},getTarget:e=>e,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:e=>e._babylonCamera?.maxZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.maxZ=e)},getTarget:e=>e,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:e=>e._babylonCamera?.minZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.minZ=e)},getTarget:e=>e,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:e=>e._babylonCamera?.getEngine().getAspectRatio(e._babylonCamera),getTarget:e=>e,getPropertyName:[()=>"aspectRatio"],isReadOnly:!0},yfov:{type:"number",get:e=>e._babylonCamera?.fov,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.fov=e)},getTarget:e=>e,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:e=>e._babylonCamera?.maxZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.maxZ=e)},getTarget:e=>e,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:e=>e._babylonCamera?.minZ,set:(e,t)=>{t._babylonCamera&&(t._babylonCamera.minZ=e)},getTarget:e=>e,getPropertyName:[()=>"minZ"]}}}},nodes:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e._babylonTransformNode),getPropertyName:[()=>"length"]},__array__:{__target__:!0,translation:{type:"Vector3",get:e=>e._babylonTransformNode?.position,set:(e,t)=>t._babylonTransformNode?.position.copyFrom(e),getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:e=>e._babylonTransformNode?.rotationQuaternion,set:(e,t)=>t._babylonTransformNode?.rotationQuaternion?.copyFrom(e),getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:e=>e._babylonTransformNode?.scaling,set:(e,t)=>t._babylonTransformNode?.scaling.copyFrom(e),getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:e=>e._numMorphTargets,getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:!0,type:"number",get:(e,t)=>void 0!==t?e._primitiveBabylonMeshes?.[0].morphTargetManager?.getTarget(t).influence:void 0,getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(e,t)=>[0],getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:e=>r.uq.Compose(e._babylonTransformNode?.scaling,e._babylonTransformNode?.rotationQuaternion,e._babylonTransformNode?.position),getTarget:e=>e._babylonTransformNode,isReadOnly:!0},globalMatrix:{type:"Matrix",get:e=>{let t=r.uq.Identity(),i=e.parent;for(;i&&i.parent;)i=i.parent;let n=e._babylonTransformNode?.position._isDirty||e._babylonTransformNode?.rotationQuaternion?._isDirty||e._babylonTransformNode?.scaling._isDirty;if(i){let r=i._babylonTransformNode?.computeWorldMatrix(!0).invert();r&&e._babylonTransformNode?.computeWorldMatrix(n)?.multiplyToRef(r,t)}else e._babylonTransformNode&&t.copyFrom(e._babylonTransformNode.computeWorldMatrix(n));return t},getTarget:e=>e._babylonTransformNode,isReadOnly:!0},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:e=>e._babylonTransformNode?.getChildren(e=>e instanceof o.n,!0)[0]?.intensity,getTarget:e=>e._babylonTransformNode?.getChildren(e=>e instanceof o.n,!0)[0],set:(e,t)=>{if(t._babylonTransformNode){let i=t._babylonTransformNode.getChildren(e=>e instanceof o.n,!0)[0];i&&(i.intensity=e)}}},color:{type:"Color3",get:e=>e._babylonTransformNode?.getChildren(e=>e instanceof o.n,!0)[0]?.diffuse,getTarget:e=>e._babylonTransformNode?.getChildren(e=>e instanceof o.n,!0)[0],set:(e,t)=>{if(t._babylonTransformNode){let i=t._babylonTransformNode.getChildren(e=>e instanceof o.n,!0)[0];i&&(i.diffuse=e)}}}},KHR_node_visibility:{visible:{type:"boolean",get:e=>!!e._primitiveBabylonMeshes&&e._primitiveBabylonMeshes[0].isVisible,getTarget:()=>void 0,set:(e,t)=>{t._primitiveBabylonMeshes&&t._primitiveBabylonMeshes.forEach(t=>t.isVisible=e)}}}}}},materials:{__array__:{__target__:!0,emissiveFactor:{type:"Color3",get:(e,t,i)=>f(e,t,i).emissiveColor,set:(e,t,i,r)=>f(t,i,r).emissiveColor.copyFrom(e),getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:u("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(e,t,i)=>c(e,i,"bumpTexture")?.level,set:(e,t,i,r)=>{let n=c(t,r,"bumpTexture");n&&(n.level=e)},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:u("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(e,t,i)=>f(e,t,i).ambientTextureStrength,set:(e,t,i,r)=>{let n=f(t,i,r);n&&(n.ambientTextureStrength=e)},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:u("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(e,t,i)=>{let r=f(e,t,i);return a.ov.FromColor3(r.albedoColor,r.alpha)},set:(e,t,i,r)=>{let n=f(t,i,r);n.albedoColor.set(e.r,e.g,e.b),n.alpha=e.a},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:u("albedoTexture")}},metallicFactor:{type:"number",get:(e,t,i)=>f(e,t,i).metallic,set:(e,t,i,r)=>{let n=f(t,i,r);n&&(n.metallic=e)},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(e,t,i)=>f(e,t,i).roughness,set:(e,t,i,r)=>{let n=f(t,i,r);n&&(n.roughness=e)},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:u("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(e,t,i)=>f(e,t,i).anisotropy.intensity,set:(e,t,i,r)=>{f(t,i,r).anisotropy.intensity=e},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(e,t,i)=>f(e,t,i).anisotropy.angle,set:(e,t,i,r)=>{f(t,i,r).anisotropy.angle=e},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:u("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(e,t,i)=>f(e,t,i).clearCoat.intensity,set:(e,t,i,r)=>{f(t,i,r).clearCoat.intensity=e},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(e,t,i)=>f(e,t,i).clearCoat.roughness,set:(e,t,i,r)=>{f(t,i,r).clearCoat.roughness=e},getTarget:(e,t,i)=>f(e,t,i),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:u("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(e,t,i)=>f(e,t,i).clearCoat.bumpTexture?.level,getTarget:f,set:(e,t,i,r)=>f(t,i,r).clearCoat.bumpTexture.level=e},extensions:{KHR_texture_transform:u("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:u("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(e,t,i)=>f(e,t,i).subSurface.dispersion,getTarget:f,set:(e,t,i,r)=>f(t,i,r).subSurface.dispersion=e}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(e,t,i)=>f(e,t,i).emissiveIntensity,getTarget:f,set:(e,t,i,r)=>f(t,i,r).emissiveIntensity=e}},KHR_materials_ior:{ior:{type:"number",get:(e,t,i)=>f(e,t,i).indexOfRefraction,getTarget:f,set:(e,t,i,r)=>f(t,i,r).indexOfRefraction=e}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(e,t,i)=>f(e,t,i).iridescence.intensity,getTarget:f,set:(e,t,i,r)=>f(t,i,r).iridescence.intensity=e},iridescenceIor:{type:"number",get:(e,t,i)=>f(e,t,i).iridescence.indexOfRefraction,getTarget:f,set:(e,t,i,r)=>f(t,i,r).iridescence.indexOfRefraction=e},iridescenceTexture:{extensions:{KHR_texture_transform:u("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(e,t,i)=>f(e,t,i).iridescence.maximumThickness,getTarget:f,set:(e,t,i,r)=>f(t,i,r).iridescence.maximumThickness=e},iridescenceThicknessMinimum:{type:"number",get:(e,t,i)=>f(e,t,i).iridescence.minimumThickness,getTarget:f,set:(e,t,i,r)=>f(t,i,r).iridescence.minimumThickness=e},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:u("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(e,t,i)=>f(e,t,i).sheen.color,getTarget:f,set:(e,t,i,r)=>f(t,i,r).sheen.color.copyFrom(e)},sheenColorTexture:{extensions:{KHR_texture_transform:u("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(e,t,i)=>f(e,t,i).sheen.intensity,getTarget:f,set:(e,t,i,r)=>f(t,i,r).sheen.intensity=e},sheenRoughnessTexture:{extensions:{KHR_texture_transform:u("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(e,t,i)=>f(e,t,i).metallicF0Factor,getTarget:f,set:(e,t,i,r)=>f(t,i,r).metallicF0Factor=e,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(e,t,i)=>f(e,t,i).metallicReflectanceColor,getTarget:f,set:(e,t,i,r)=>f(t,i,r).metallicReflectanceColor.copyFrom(e),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:u("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:u("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(e,t,i)=>f(e,t,i).subSurface.refractionIntensity,getTarget:f,set:(e,t,i,r)=>f(t,i,r).subSurface.refractionIntensity=e,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:u("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(e,t,i)=>f(e,t,i).subSurface.translucencyIntensity,getTarget:f,set:(e,t,i,r)=>f(t,i,r).subSurface.translucencyIntensity=e},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:u("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(e,t,i)=>f(e,t,i).subSurface.translucencyColor,getTarget:f,set:(e,t,i,r)=>e&&f(t,i,r).subSurface.translucencyColor?.copyFrom(e)},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:u("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(e,t,i)=>f(e,t,i).subSurface.tintColor,getTarget:f,set:(e,t,i,r)=>f(t,i,r).subSurface.tintColor.copyFrom(e)},attenuationDistance:{type:"number",get:(e,t,i)=>f(e,t,i).subSurface.tintColorAtDistance,getTarget:f,set:(e,t,i,r)=>f(t,i,r).subSurface.tintColorAtDistance=e},thicknessFactor:{type:"number",get:(e,t,i)=>f(e,t,i).subSurface.maximumThickness,getTarget:f,set:(e,t,i,r)=>f(t,i,r).subSurface.maximumThickness=e},thicknessTexture:{extensions:{KHR_texture_transform:u("subSurface","thicknessTexture")}}}}}},extensions:{KHR_lights_punctual:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e._babylonLight),getPropertyName:[e=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:e=>e._babylonLight?.diffuse,set:(e,t)=>t._babylonLight?.diffuse.copyFrom(e),getTarget:e=>e._babylonLight,getPropertyName:[e=>"diffuse"]},intensity:{type:"number",get:e=>e._babylonLight?.intensity,set:(e,t)=>t._babylonLight?t._babylonLight.intensity=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"intensity"]},range:{type:"number",get:e=>e._babylonLight?.range,set:(e,t)=>t._babylonLight?t._babylonLight.range=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"range"]},spot:{innerConeAngle:{type:"number",get:e=>e._babylonLight?.innerAngle,set:(e,t)=>t._babylonLight?t._babylonLight.innerAngle=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"innerConeAngle"]},outerConeAngle:{type:"number",get:e=>e._babylonLight?.angle,set:(e,t)=>t._babylonLight?t._babylonLight.angle=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"outerConeAngle"]}}}}},EXT_lights_area:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e._babylonLight),getPropertyName:[e=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:e=>e._babylonLight?.diffuse,set:(e,t)=>t._babylonLight?.diffuse.copyFrom(e),getTarget:e=>e._babylonLight,getPropertyName:[e=>"diffuse"]},intensity:{type:"number",get:e=>e._babylonLight?.intensity,set:(e,t)=>t._babylonLight?t._babylonLight.intensity=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"intensity"]},size:{type:"number",get:e=>e._babylonLight?.height,set:(e,t)=>t._babylonLight?t._babylonLight.height=e:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"size"]},rect:{aspect:{type:"number",get:e=>e._babylonLight?.width/e._babylonLight?.height,set:(e,t)=>t._babylonLight?t._babylonLight.width=e*t._babylonLight.height:void 0,getTarget:e=>e._babylonLight,getPropertyName:[e=>"aspect"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e._babylonLight),getPropertyName:[e=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e._babylonTexture),getPropertyName:[e=>"length"]},__array__:{__target__:!0,intensity:{type:"number",get:e=>e._babylonTexture?.level,set:(e,t)=>{t._babylonTexture&&(t._babylonTexture.level=e)},getTarget:e=>e._babylonTexture},rotation:{type:"Quaternion",get:e=>e._babylonTexture&&r.PT.FromRotationMatrix(e._babylonTexture?.getReflectionTextureMatrix()),set:(e,t)=>{t._babylonTexture&&(t._babylonTexture.getScene()?.useRightHandedSystem||(e=r.PT.Inverse(e)),r.uq.FromQuaternionToRef(e,t._babylonTexture.getReflectionTextureMatrix()))},getTarget:e=>e._babylonTexture}}}}},animations:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e._babylonAnimationGroup),getPropertyName:[()=>"length"]},__array__:{}},meshes:{length:{type:"number",get:e=>e.length,getTarget:e=>e.map(e=>e.primitives[0]._instanceData?.babylonSourceMesh),getPropertyName:[()=>"length"]},__array__:{}}};function h(e){return new l(e,d)}function p(e){let t=e.split("/").map(e=>e.replace(/{}/g,"__array__")),i=d;for(let e of t)e&&(i=i[e]);if(i&&i.type&&i.get)return i}function m(e,t){let i=e.split("/").map(e=>e.replace(/{}/g,"__array__")),r=d;for(let e of i)e&&(r=r[e]);r&&r.type&&r.get&&(r.interpolation=t)}function _(e,t){let i=e.split("/").map(e=>e.replace(/{}/g,"__array__")),r=d;for(let e of i)if(e){if(!r[e]){if("?"===e){r.__ignoreObjectTree__=!0;continue}r[e]={},"__array__"===e&&(r[e].__target__=!0)}r=r[e]}Object.assign(r,t)}},13695:function(e,t,i){i.r(t),i.d(t,{AnimationPropertyInfo:()=>c,TransformNodeAnimationPropertyInfo:()=>f,WeightAnimationPropertyInfo:()=>u,getQuaternion:()=>s,getVector3:()=>o,getWeights:()=>l});var r=i(47627),n=i(97782),a=i(23751);function o(e,t,i,r){return n.Pq.FromArray(t,i).scaleInPlace(r)}function s(e,t,i,r){return n.PT.FromArray(t,i).scaleInPlace(r)}function l(e,t,i,r){let n=Array(e._numMorphTargets);for(let e=0;e<n.length;e++)n[e]=t[i++]*r;return n}class c{constructor(e,t,i,r){this.type=e,this.name=t,this.getValue=i,this.getStride=r}_buildAnimation(e,t,i){let n=new r.X5(e,this.name,t,this.type);return n.setKeys(i,!0),n}}class f extends c{buildAnimations(e,t,i,r){let n=[];return n.push({babylonAnimatable:e._babylonTransformNode,babylonAnimation:this._buildAnimation(t,i,r)}),n}}class u extends c{buildAnimations(e,t,i,n){let a=[];if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){let s=new r.X5(`${t}_${o}`,this.name,i,this.type);if(s.setKeys(n.map(e=>({frame:e.frame,inTangent:e.inTangent?e.inTangent[o]:void 0,value:e.value[o],outTangent:e.outTangent?e.outTangent[o]:void 0,interpolation:e.interpolation})),!0),e._primitiveBabylonMeshes){for(let t of e._primitiveBabylonMeshes)if(t.morphTargetManager){let e=t.morphTargetManager.getTarget(o),i=s.clone();e.animations.push(i),a.push({babylonAnimatable:e,babylonAnimation:i})}}}return a}}(0,a.ZU)("/nodes/{}/translation",[new f(r.X5.ANIMATIONTYPE_VECTOR3,"position",o,()=>3)]),(0,a.ZU)("/nodes/{}/rotation",[new f(r.X5.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",s,()=>4)]),(0,a.ZU)("/nodes/{}/scale",[new f(r.X5.ANIMATIONTYPE_VECTOR3,"scaling",o,()=>3)]),(0,a.ZU)("/nodes/{}/weights",[new u(r.X5.ANIMATIONTYPE_FLOAT,"influence",l,e=>e._numMorphTargets)])},17165:function(e,t,i){i.r(t),i.d(t,{OpenPBRMaterialLoadingAdapter:()=>r});class r{constructor(e){this._material=e}get material(){return this._material}get isUnlit(){return this._material.unlit}set isUnlit(e){this._material.unlit=e}set backFaceCulling(e){this._material.backFaceCulling=e}get backFaceCulling(){return this._material.backFaceCulling}set twoSidedLighting(e){this._material.twoSidedLighting=e}get twoSidedLighting(){return this._material.twoSidedLighting}set alphaCutOff(e){}get alphaCutOff(){return .5}set useAlphaFromBaseColorTexture(e){this._material._useAlphaFromBaseColorTexture=e}get useAlphaFromBaseColorTexture(){return!1}get transparencyAsAlphaCoverage(){return!1}set transparencyAsAlphaCoverage(e){}set baseColor(e){this._material.baseColor=e}get baseColor(){return this._material.baseColor}set baseColorTexture(e){this._material.baseColorTexture=e}get baseColorTexture(){return this._material.baseColorTexture}set baseDiffuseRoughness(e){this._material.baseDiffuseRoughness=e}get baseDiffuseRoughness(){return this._material.baseDiffuseRoughness}set baseDiffuseRoughnessTexture(e){this._material.baseDiffuseRoughnessTexture=e}get baseDiffuseRoughnessTexture(){return this._material.baseDiffuseRoughnessTexture}set baseMetalness(e){this._material.baseMetalness=e}get baseMetalness(){return this._material.baseMetalness}set baseMetalnessTexture(e){this._material.baseMetalnessTexture=e}get baseMetalnessTexture(){return this._material.baseMetalnessTexture}set useRoughnessFromMetallicTextureGreen(e){this._material._useRoughnessFromMetallicTextureGreen=e}set useMetallicFromMetallicTextureBlue(e){this._material._useMetallicFromMetallicTextureBlue=e}enableSpecularEdgeColor(e=!1){}set specularWeight(e){this._material.specularWeight=e}get specularWeight(){return this._material.specularWeight}set specularWeightTexture(e){this._material.specularColorTexture===e?(this._material.specularWeightTexture=null,this._material._useSpecularWeightFromSpecularColorTexture=!0,this._material._useSpecularWeightFromAlpha=!0):this._material.specularWeightTexture=e}get specularWeightTexture(){return this._material.specularWeightTexture}set specularColor(e){this._material.specularColor=e}get specularColor(){return this._material.specularColor}set specularColorTexture(e){this._material.specularColorTexture=e,this._material.specularWeightTexture===this._material.specularColorTexture&&(this._material.specularWeightTexture=null,this._material._useSpecularWeightFromSpecularColorTexture=!0,this._material._useSpecularWeightFromAlpha=!0)}get specularColorTexture(){return this._material.specularColorTexture}set specularRoughness(e){this._material.specularRoughness=e}get specularRoughness(){return this._material.specularRoughness}set specularRoughnessTexture(e){this._material.specularRoughnessTexture=e}get specularRoughnessTexture(){return this._material.specularRoughnessTexture}set specularIor(e){this._material.specularIor=e}get specularIor(){return this._material.specularIor}set emissionColor(e){this._material.emissionColor=e}get emissionColor(){return this._material.emissionColor}set emissionLuminance(e){this._material.emissionLuminance=e}get emissionLuminance(){return this._material.emissionLuminance}set emissionColorTexture(e){this._material.emissionColorTexture=e}get emissionColorTexture(){return this._material.emissionColorTexture}set ambientOcclusionTexture(e){this._material.ambientOcclusionTexture=e}get ambientOcclusionTexture(){return this._material.ambientOcclusionTexture}set ambientOcclusionTextureStrength(e){let t=this._material.ambientOcclusionTexture;t&&(t.level=e)}get ambientOcclusionTextureStrength(){let e=this._material.ambientOcclusionTexture;return e?.level??1}configureCoat(){}set coatWeight(e){this._material.coatWeight=e}get coatWeight(){return this._material.coatWeight}set coatWeightTexture(e){this._material.coatWeightTexture=e}get coatWeightTexture(){return this._material.coatWeightTexture}set coatColor(e){this._material.coatColor=e}set coatColorTexture(e){this._material.coatColorTexture=e}set coatRoughness(e){this._material.coatRoughness=e}get coatRoughness(){return this._material.coatRoughness}set coatRoughnessTexture(e){this._material.coatRoughnessTexture=e,e&&(this._material._useCoatRoughnessFromGreenChannel=!0)}get coatRoughnessTexture(){return this._material.coatRoughnessTexture}set coatIor(e){this._material.coatIor=e}set coatDarkening(e){this._material.coatDarkening=e}set coatDarkeningTexture(e){this._material.coatDarkeningTexture=e}set coatRoughnessAnisotropy(e){this._material.coatRoughnessAnisotropy=e}get coatRoughnessAnisotropy(){return this._material.coatRoughnessAnisotropy}set geometryCoatTangentAngle(e){this._material.geometryCoatTangentAngle=e}set geometryCoatTangentTexture(e){this._material.geometryCoatTangentTexture=e,e&&(this._material._useCoatRoughnessAnisotropyFromTangentTexture=!0)}get geometryCoatTangentTexture(){return this._material.geometryCoatTangentTexture}set transmissionWeight(e){}set transmissionWeightTexture(e){}get transmissionWeight(){return 0}set transmissionDispersionAbbeNumber(e){}configureTransmission(){}set transmissionDepth(e){}set transmissionColor(e){}set volumeThicknessTexture(e){}set volumeThickness(e){}configureSubsurface(){}set subsurfaceWeight(e){}get subsurfaceWeight(){return 0}set subsurfaceWeightTexture(e){}set subsurfaceColor(e){}set subsurfaceColorTexture(e){}configureFuzz(){}set fuzzWeight(e){this._material.fuzzWeight=e}set fuzzWeightTexture(e){this._material.fuzzWeightTexture=e}set fuzzColor(e){this._material.fuzzColor=e}set fuzzColorTexture(e){this._material.fuzzColorTexture=e}set fuzzRoughness(e){this._material.fuzzRoughness=e}set fuzzRoughnessTexture(e){this._material.fuzzRoughnessTexture=e,this._material._useFuzzRoughnessFromTextureAlpha=!0}set specularRoughnessAnisotropy(e){this._material.specularRoughnessAnisotropy=e}get specularRoughnessAnisotropy(){return this._material.specularRoughnessAnisotropy}set geometryTangentAngle(e){this._material.geometryTangentAngle=e}set geometryTangentTexture(e){this._material.geometryTangentTexture=e,this._material._useSpecularRoughnessAnisotropyFromTangentTexture=!0}get geometryTangentTexture(){return this._material.geometryTangentTexture}configureGltfStyleAnisotropy(e=!0){this._material._useGltfStyleAnisotropy=e}set thinFilmWeight(e){this._material.thinFilmWeight=e}set thinFilmIor(e){this._material.thinFilmIor=e}set thinFilmThicknessMinimum(e){this._material.thinFilmThicknessMin=e/1e3}set thinFilmThicknessMaximum(e){this._material.thinFilmThickness=e/1e3}set thinFilmWeightTexture(e){this._material.thinFilmWeightTexture=e}set thinFilmThicknessTexture(e){this._material.thinFilmThicknessTexture=e,this._material._useThinFilmThicknessFromTextureGreen=!0}set unlit(e){this._material.unlit=e}set geometryOpacity(e){this._material.geometryOpacity=e}get geometryOpacity(){return this._material.geometryOpacity}set geometryNormalTexture(e){this._material.geometryNormalTexture=e}get geometryNormalTexture(){return this._material.geometryNormalTexture}setNormalMapInversions(e,t){}set geometryCoatNormalTexture(e){this._material.geometryCoatNormalTexture=e}get geometryCoatNormalTexture(){return this._material.geometryCoatNormalTexture}set geometryCoatNormalTextureScale(e){this._material.geometryCoatNormalTexture&&(this._material.geometryCoatNormalTexture.level=e)}}},15077:function(e,t,i){i.r(t),i.d(t,{PBRMaterialLoadingAdapter:()=>a});var r=i(55322),n=i(96892);class a{constructor(e){this._material=e,this._material.enableSpecularAntiAliasing=!0}get material(){return this._material}get isUnlit(){return this._material.unlit}set isUnlit(e){this._material.unlit=e}set backFaceCulling(e){this._material.backFaceCulling=e}get backFaceCulling(){return this._material.backFaceCulling}set twoSidedLighting(e){this._material.twoSidedLighting=e}get twoSidedLighting(){return this._material.twoSidedLighting}set alphaCutOff(e){this._material.alphaCutOff=e}get alphaCutOff(){return this._material.alphaCutOff}set useAlphaFromBaseColorTexture(e){this._material.useAlphaFromAlbedoTexture=e}get useAlphaFromBaseColorTexture(){return this._material.useAlphaFromAlbedoTexture}get transparencyAsAlphaCoverage(){return this._material.useRadianceOverAlpha||this._material.useSpecularOverAlpha}set transparencyAsAlphaCoverage(e){this._material.useRadianceOverAlpha=!e,this._material.useSpecularOverAlpha=!e}set baseColor(e){this._material.albedoColor=e}get baseColor(){return this._material.albedoColor}set baseColorTexture(e){this._material.albedoTexture=e}get baseColorTexture(){return this._material.albedoTexture}set baseDiffuseRoughness(e){this._material.baseDiffuseRoughness=e,e>0&&(this._material.brdf.baseDiffuseModel=n.Y.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR)}get baseDiffuseRoughness(){return this._material.baseDiffuseRoughness??0}set baseDiffuseRoughnessTexture(e){this._material.baseDiffuseRoughnessTexture=e}get baseDiffuseRoughnessTexture(){return this._material.baseDiffuseRoughnessTexture}set baseMetalness(e){this._material.metallic=e}get baseMetalness(){return this._material.metallic??1}set baseMetalnessTexture(e){this._material.metallicTexture=e}get baseMetalnessTexture(){return this._material.metallicTexture}set useRoughnessFromMetallicTextureGreen(e){this._material.useRoughnessFromMetallicTextureGreen=e,this._material.useRoughnessFromMetallicTextureAlpha=!e}set useMetallicFromMetallicTextureBlue(e){this._material.useMetallnessFromMetallicTextureBlue=e}enableSpecularEdgeColor(e=!1){e&&(this._material.brdf.dielectricSpecularModel=n.Y.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR,this._material.brdf.conductorSpecularModel=n.Y.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR)}set specularWeight(e){this._material.metallicF0Factor=e}get specularWeight(){return this._material.metallicF0Factor??1}set specularWeightTexture(e){e?(this._material.metallicReflectanceTexture=e,this._material.useOnlyMetallicFromMetallicReflectanceTexture=!0):(this._material.metallicReflectanceTexture=null,this._material.useOnlyMetallicFromMetallicReflectanceTexture=!1)}get specularWeightTexture(){return this._material.metallicReflectanceTexture}set specularColor(e){this._material.metallicReflectanceColor=e}get specularColor(){return this._material.metallicReflectanceColor}set specularColorTexture(e){this._material.reflectanceTexture=e}get specularColorTexture(){return this._material.reflectanceTexture}set specularRoughness(e){this._material.roughness=e}get specularRoughness(){return this._material.roughness??1}set specularRoughnessTexture(e){this.baseMetalnessTexture||(this._material.metallicTexture=e)}get specularRoughnessTexture(){return this._material.metallicTexture}set specularIor(e){this._material.indexOfRefraction=e}get specularIor(){return this._material.indexOfRefraction}set emissionColor(e){this._material.emissiveColor=e}get emissionColor(){return this._material.emissiveColor}set emissionLuminance(e){this._material.emissiveIntensity=e}get emissionLuminance(){return this._material.emissiveIntensity}set emissionColorTexture(e){this._material.emissiveTexture=e}get emissionColorTexture(){return this._material.emissiveTexture}set ambientOcclusionTexture(e){this._material.ambientTexture=e,e&&(this._material.useAmbientInGrayScale=!0)}get ambientOcclusionTexture(){return this._material.ambientTexture}set ambientOcclusionTextureStrength(e){this._material.ambientTextureStrength=e}get ambientOcclusionTextureStrength(){return this._material.ambientTextureStrength??1}configureCoat(){this._material.clearCoat.isEnabled=!0,this._material.clearCoat.useRoughnessFromMainTexture=!1,this._material.clearCoat.remapF0OnInterfaceChange=!1}set coatWeight(e){this._material.clearCoat.isEnabled=!0,this._material.clearCoat.intensity=e}get coatWeight(){return this._material.clearCoat.intensity}set coatWeightTexture(e){this._material.clearCoat.isEnabled=!0,this._material.clearCoat.texture=e}get coatWeightTexture(){return this._material.clearCoat.texture}set coatColor(e){this._material.clearCoat.isTintEnabled=e!=r.v9.White(),this._material.clearCoat.tintColor=e}set coatColorTexture(e){this._material.clearCoat.tintTexture=e}set coatRoughness(e){this._material.clearCoat.isEnabled=!0,this._material.clearCoat.roughness=e}get coatRoughness(){return this._material.clearCoat.roughness??0}set coatRoughnessTexture(e){this._material.clearCoat.isEnabled=!0,this._material.clearCoat.useRoughnessFromMainTexture=!1,this._material.clearCoat.textureRoughness=e}get coatRoughnessTexture(){return this._material.clearCoat.textureRoughness}set coatIor(e){this._material.clearCoat.indexOfRefraction=e}set coatDarkening(e){}set coatDarkeningTexture(e){}set coatRoughnessAnisotropy(e){}get coatRoughnessAnisotropy(){return 0}set geometryCoatTangentAngle(e){}set geometryCoatTangentTexture(e){}get geometryCoatTangentTexture(){return null}set transmissionWeight(e){this._material.subSurface.isRefractionEnabled=e>0,this._material.subSurface.refractionIntensity=e}get transmissionWeight(){return this._material.subSurface.refractionIntensity}set transmissionWeightTexture(e){this._material.subSurface.isRefractionEnabled=!0,this._material.subSurface.refractionIntensityTexture=e,this._material.subSurface.useGltfStyleTextures=!0}set transmissionDepth(e){this._material.subSurface.tintColorAtDistance=e}set transmissionColor(e){this._material.subSurface.tintColor=e}set transmissionDispersionAbbeNumber(e){e>0?(this._material.subSurface.isDispersionEnabled=!0,this._material.subSurface.dispersion=20/e):(this._material.subSurface.isDispersionEnabled=!1,this._material.subSurface.dispersion=0)}configureTransmission(){this._material.subSurface.volumeIndexOfRefraction=1,this._material.subSurface.useAlbedoToTintRefraction=!0,this._material.subSurface.minimumThickness=0,this._material.subSurface.maximumThickness=0}set volumeThicknessTexture(e){this._material.subSurface.thicknessTexture=e,this._material.subSurface.useGltfStyleTextures=!0}set volumeThickness(e){this._material.subSurface.minimumThickness=0,this._material.subSurface.maximumThickness=e,this._material.subSurface.useThicknessAsDepth=!0,e>0&&(this._material.subSurface.volumeIndexOfRefraction=this._material.indexOfRefraction)}configureSubsurface(){this._material.subSurface.useGltfStyleTextures=!0,this._material.subSurface.volumeIndexOfRefraction=1,this._material.subSurface.minimumThickness=0,this._material.subSurface.maximumThickness=0,this._material.subSurface.useAlbedoToTintTranslucency=!1}set subsurfaceWeight(e){this._material.subSurface.isTranslucencyEnabled=e>0,this._material.subSurface.translucencyIntensity=e}get subsurfaceWeight(){return this._material.subSurface.isTranslucencyEnabled?this._material.subSurface.translucencyIntensity:0}set subsurfaceWeightTexture(e){this._material.subSurface.translucencyIntensityTexture=e}set subsurfaceColor(e){this._material.subSurface.tintColor=e}set subsurfaceColorTexture(e){this._material.subSurface.translucencyColorTexture=e}configureFuzz(){this._material.sheen.isEnabled=!0,this._material.sheen.useRoughnessFromMainTexture=!1,this._material.sheen.albedoScaling=!0}set fuzzWeight(e){this._material.sheen.isEnabled=!0,this._material.sheen.intensity=e}set fuzzWeightTexture(e){this._material.sheen.texture||(this._material.sheen.texture=e)}set fuzzColor(e){this._material.sheen.isEnabled=!0,this._material.sheen.color=e}set fuzzColorTexture(e){this._material.sheen.texture=e}set fuzzRoughness(e){this._material.sheen.isEnabled=!0,this._material.sheen.roughness=e}set fuzzRoughnessTexture(e){this._material.sheen.isEnabled=!0,this._material.sheen.textureRoughness=e}set specularRoughnessAnisotropy(e){this._material.anisotropy.isEnabled=!0,this._material.anisotropy.intensity=e}get specularRoughnessAnisotropy(){return this._material.anisotropy.intensity}set geometryTangentAngle(e){this._material.anisotropy.isEnabled=!0,this._material.anisotropy.angle=e}set geometryTangentTexture(e){this._material.anisotropy.isEnabled=!0,this._material.anisotropy.texture=e}get geometryTangentTexture(){return this._material.anisotropy.texture}configureGltfStyleAnisotropy(e=!0){}set thinFilmWeight(e){this._material.iridescence.isEnabled=e>0,this._material.iridescence.intensity=e}set thinFilmIor(e){this._material.iridescence.indexOfRefraction=e}set thinFilmThicknessMinimum(e){this._material.iridescence.minimumThickness=e}set thinFilmThicknessMaximum(e){this._material.iridescence.maximumThickness=e}set thinFilmWeightTexture(e){this._material.iridescence.texture=e}set thinFilmThicknessTexture(e){this._material.iridescence.thicknessTexture=e}set transmissionDispersion(e){this._material._dispersion=e}set unlit(e){this._material.unlit=e}set geometryOpacity(e){this._material.alpha=e}get geometryOpacity(){return this._material.alpha}set geometryNormalTexture(e){this._material.bumpTexture=e,this._material.forceIrradianceInFragment=!0}get geometryNormalTexture(){return this._material.bumpTexture}setNormalMapInversions(e,t){this._material.invertNormalMapX=e,this._material.invertNormalMapY=t}set geometryCoatNormalTexture(e){this._material.clearCoat.isEnabled=!0,this._material.clearCoat.bumpTexture=e}get geometryCoatNormalTexture(){return this._material.clearCoat.bumpTexture}set geometryCoatNormalTextureScale(e){this._material.clearCoat.bumpTexture&&(this._material.clearCoat.bumpTexture.level=e)}}},84023:function(e,t,i){i.r(t),i.d(t,{OBJFileLoader:()=>rb,GLTFLoaderDefaultOptions:()=>eo,GLTF2:()=>y,GLTFValidation:()=>Q,BVHFileLoader:()=>Y,MTLFileLoader:()=>rR,SolidParser:()=>rC,GLTF1:()=>b,STLFileLoader:()=>rL,GLTFFileLoader:()=>el,GLTFLoaderState:()=>g,GLTFLoaderAnimationStartMode:()=>_,GLTFLoaderCoordinateSystemMode:()=>m,ReadBvh:()=>z,SPLATFileLoader:()=>rU});var r,n,a,o,s,l,c,f,u,d,h,p,m,_,g,v,S,E,T,A,x,I,R,C,b={};i.r(b),i.d(b,{EBlendingFunction:()=>R,EComponentType:()=>v,ECullingType:()=>I,EParameterType:()=>E,EShaderType:()=>S,ETextureFilterType:()=>A,ETextureFormat:()=>x,ETextureWrapMode:()=>T,GLTFBinaryExtension:()=>eQ,GLTFLoader:()=>ej,GLTFLoaderBase:()=>eZ,GLTFLoaderExtension:()=>eK,GLTFMaterialsCommonExtension:()=>eJ,GLTFUtils:()=>ey});var y={};i.r(y),i.d(y,{AddObjectAccessorToKey:()=>e7.oR,AnimationPropertyInfo:()=>tl.AnimationPropertyInfo,ArrayItem:()=>ta,EXT_lights_area:()=>tO,EXT_lights_ies:()=>tC,EXT_lights_image_based:()=>tp,EXT_mesh_gpu_instancing:()=>t_,EXT_meshopt_compression:()=>tS,EXT_texture_avif:()=>tx,EXT_texture_webp:()=>tT,ExtrasAsMetadata:()=>rx,FlowGraphGLTFDataProvider:()=>rI.FlowGraphGLTFDataProvider,GLTFFileLoader:()=>el,GLTFLoader:()=>ts,GetMappingForKey:()=>e7.tQ,GetPathToObjectConverter:()=>e7.Wt,InteractivityGraphToFlowGraphParser:()=>rc,KHR_animation_pointer:()=>iq,KHR_draco_mesh_compression:()=>tL,KHR_interactivity:()=>rd,KHR_lights:()=>tP,KHR_materials_anisotropy:()=>t$,KHR_materials_clearcoat:()=>tk,KHR_materials_coat:()=>tH,KHR_materials_diffuse_roughness:()=>il,KHR_materials_diffuse_transmission:()=>it,KHR_materials_dispersion:()=>io,KHR_materials_emissive_strength:()=>tZ,KHR_materials_fuzz:()=>tJ,KHR_materials_ior:()=>t3,KHR_materials_iridescence:()=>tX,KHR_materials_pbrSpecularGlossiness:()=>tB,KHR_materials_sheen:()=>tK,KHR_materials_specular:()=>t1,KHR_materials_transmission:()=>t7,KHR_materials_unlit:()=>tG,KHR_materials_variants:()=>t5,KHR_materials_volume:()=>ir,KHR_mesh_quantization:()=>iu,KHR_node_hoverability:()=>rT,KHR_node_selectability:()=>rg,KHR_node_visibility:()=>rm,KHR_texture_basisu:()=>ih,KHR_texture_transform:()=>im,KHR_xmp_json_ld:()=>ig,LoadBoundingInfoFromPositionAccessor:()=>to,MSFT_audio_emitter:()=>iJ,MSFT_lod:()=>i1,MSFT_minecraftMesh:()=>i3,MSFT_sRGBFactors:()=>i5,OpenPBRMaterialLoadingAdapter:()=>tc.OpenPBRMaterialLoadingAdapter,PBRMaterialLoadingAdapter:()=>tf.PBRMaterialLoadingAdapter,SetInterpolationForKey:()=>e7.ZU,TransformNodeAnimationPropertyInfo:()=>tl.TransformNodeAnimationPropertyInfo,WeightAnimationPropertyInfo:()=>tl.WeightAnimationPropertyInfo,_AddInteractivityObjectModel:()=>rh,addNewInteractivityFlowGraphMapping:()=>rt,getAllSupportedNativeNodeTypes:()=>ro,getMappingForDeclaration:()=>re,getMappingForFullOperationName:()=>i7,getQuaternion:()=>tl.getQuaternion,getVector3:()=>tl.getVector3,getWeights:()=>tl.getWeights,gltfTypeToBabylonType:()=>rl,registerGLTFExtension:()=>e6,registeredGLTFExtensions:()=>e8,unregisterGLTFExtension:()=>e9});var L=i(47627),M=i(36819),P=i(51610),N=i(97782),D=i(49477);let O="Xposition",F="Yposition",w="Zposition",B="Xrotation",U="Yrotation",G="Zrotation";class V{constructor(e){this.loopMode=L.X5.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=k(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}function k(){return{name:"",type:"",offset:new N.Pq,channels:[],children:[],frames:[],parent:null}}function z(e,t,i,r){let n=e.split("\n"),{loopMode:a}=r;t._blockEntityCollection=!!i;let o=new P.E("","",t);o._parentContainer=i,t._blockEntityCollection=!1;let s=new V(o);s.loopMode=a;let l=n.shift();if(!l||"HIERARCHY"!==l.trim().toUpperCase())throw Error("HIERARCHY expected");let c=n.shift();if(!c)throw Error("Unexpected end of file after HIERARCHY");let f=function e(t,i,r,n){let a=k();a.parent=r,n.list.push(a);let o=i.trim().split(/\s+/);if("END"===o[0].toUpperCase()&&"SITE"===o[1].toUpperCase()?(a.type="ENDSITE",a.name="ENDSITE"):(a.name=o[1],a.type=o[0].toUpperCase()),t.shift()?.trim()!="{")throw Error("Expected opening { after type & name");let s=t.shift()?.trim().split(/\s+/);if(!s)throw Error("Unexpected end of file: missing OFFSET");if("OFFSET"!=(o=s)[0].toUpperCase())throw Error("Expected OFFSET, but got: "+o[0]);if(4!=o.length)throw Error("OFFSET: Invalid number of values");let l=new N.Pq(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]));if(isNaN(l.x)||isNaN(l.y)||isNaN(l.z))throw Error("OFFSET: Invalid values");if(a.offset=l,"ENDSITE"!=a.type){if(!(o=t.shift()?.trim().split(/\s+/)))throw Error("Unexpected end of file: missing CHANNELS");if("CHANNELS"!=o[0].toUpperCase())throw Error("Expected CHANNELS definition");let e=parseInt(o[1]);a.channels=o.splice(2,e),a.children=[]}for(;t.length>0;){let i=t.shift()?.trim();if("}"===i)return a;i&&a.children.push(e(t,i,a,n))}throw Error("Unexpected end of file: missing closing brace")}(n,c.trim(),null,s),u=n.shift();if(!u||"MOTION"!==u.trim().toUpperCase())throw Error("MOTION expected");let d=n.shift();if(!d)throw Error("Unexpected end of file before frame count");let h=d.trim().split(/[\s]+/);if(h.length<2)throw Error("Invalid frame count line");let p=parseInt(h[1]);if(isNaN(p))throw Error("Failed to read number of frames.");s.numFrames=p;let m=n.shift();if(!m)throw Error("Unexpected end of file before frame time");let _=m.trim().split(/[\s]+/);if(_.length<3)throw Error("Invalid frame time line");let g=parseFloat(_[2]);if(isNaN(g))throw Error("Failed to read frame time.");if(g<=0)throw Error("Failed to read frame time. Invalid value "+g);s.frameRate=1/g;for(let e=0;e<p;++e){let t=n.shift();t&&!function e(t,i,r,n){if("ENDSITE"===r.type)return;let a={frame:0,position:new N.Pq,rotation:new N.PT};a.frame=i,a.position=new N.Pq,a.rotation=new N.PT,r.frames.push(a);let o=N.uq.Identity();for(let e=0;e<r.channels.length;++e){let i=r.channels[e],s=t[n.i++];if(!s)continue;let l=parseFloat(s.trim());if(i.endsWith("position"))switch(i){case O:a.position.x=l;break;case F:a.position.y=l;break;case w:a.position.z=l}else if(i.endsWith("rotation")){let e,t=D.S0.ToRadians(l);switch(i){case B:e=N.uq.RotationX(t);break;case U:e=N.uq.RotationY(t);break;case G:e=N.uq.RotationZ(t)}o=e.multiply(o)}}for(let s of(N.PT.FromRotationMatrixToRef(o,a.rotation),r.children))e(t,i,s,n)}(t.trim().split(/[\s]+/)||[],e,f,{i:0})}return s.root=f,!function e(t,i,r){let n,a,o,s=(n=t.offset.x,a=t.offset.y,o=t.offset.z,N.uq.Translation(n,a,o)),l=new M.$(t.name,r.skeleton,i,s);for(let e of function(e,t){if(0===e.frames.length)return[];let i=[],r=e.channels.some(e=>e===O||e===F||e===w),n=e.channels.some(e=>e===B||e===U||e===G),a=new L.X5(`${e.name}_pos`,"position",t.frameRate,L.X5.ANIMATIONTYPE_VECTOR3,t.loopMode),o=new L.X5(`${e.name}_rot`,"rotationQuaternion",t.frameRate,L.X5.ANIMATIONTYPE_QUATERNION,t.loopMode),s=[],l=[];for(let t=0;t<e.frames.length;t++){let i=e.frames[t];r&&i.position&&s.push({frame:i.frame,value:i.position.clone()}),n&&l.push({frame:i.frame,value:i.rotation.clone()})}return s.length>0&&(a.setKeys(s),i.push(a)),l.length>0&&(o.setKeys(l),i.push(o)),i}(t,r))e.getKeys()&&e.getKeys().length>0&&l.animations.push(e);for(let i of t.children)e(i,l,r)}(s.root,null,s),s.skeleton.returnToRest(),s.skeleton}var H=i(48621),W=i(90802);let X={".bvh":{isBinary:!1}};class Y{constructor(e){this.name="bvh",this.extensions=X,this._loadingOptions={...Y._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:L.X5.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new Y(e.bvh)}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return"HIERARCHY"==e.split("\n")[0]}isNotBvhHeader(e){return!this.isBvhHeader(e)}importMeshAsync(e,t,i){if("string"!=typeof i)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(i))return Promise.reject("BVH loader expects HIERARCHY header.");try{let e=z(i,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[e],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(e){return Promise.reject(e)}}loadAsync(e,t){return"string"!=typeof t?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then(()=>{})}loadAssetContainerAsync(e,t){if("string"!=typeof t)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");let i=new W.WZ(e);try{let r=z(t,e,i,this._loadingOptions);return i.skeletons.push(r),Promise.resolve(i)}catch(e){return Promise.reject(e)}}}(0,H.qS)(new Y);var $=i(76937),q=i(57480),Z=i(28915);function j(e,t,i,r){let n={externalResourceFunction:r};return i&&(n.uri="file:"===t?i:t+i),ArrayBuffer.isView(e)?GLTFValidator.validateBytes(e,n):GLTFValidator.validateString(e,n)}function K(){let e=[];onmessage=t=>{let i=t.data;switch(i.id){case"init":importScripts(i.url);break;case"validate":j(i.data,i.rootUrl,i.fileName,t=>new Promise((i,r)=>{let n=e.length;e.push({resolve:i,reject:r}),postMessage({id:"getExternalResource",index:n,uri:t})})).then(e=>{postMessage({id:"validate.resolve",value:e})},e=>{postMessage({id:"validate.reject",reason:e})});break;case"getExternalResource.resolve":e[i.index].resolve(i.value);break;case"getExternalResource.reject":e[i.index].reject(i.reason)}}}class Q{static ValidateAsync(e,t,i,r){return"function"==typeof Worker?new Promise((n,a)=>{let o=`${j}(${K})()`,s=new Worker(URL.createObjectURL(new Blob([o],{type:"application/javascript"}))),l=e=>{s.removeEventListener("error",l),s.removeEventListener("message",c),a(e)},c=e=>{let t=e.data;switch(t.id){case"getExternalResource":r(t.uri).then(e=>{s.postMessage({id:"getExternalResource.resolve",index:t.index,value:e},[e.buffer])},e=>{s.postMessage({id:"getExternalResource.reject",index:t.index,reason:e})});break;case"validate.resolve":s.removeEventListener("error",l),s.removeEventListener("message",c),n(t.value),s.terminate();break;case"validate.reject":s.removeEventListener("error",l),s.removeEventListener("message",c),a(t.reason),s.terminate()}};if(s.addEventListener("error",l),s.addEventListener("message",c),s.postMessage({id:"init",url:D.S0.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){let r=e.slice();s.postMessage({id:"validate",data:r,rootUrl:t,fileName:i},[r.buffer])}else s.postMessage({id:"validate",data:e,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=D.S0.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>j(e,t,i,r)))}}Q.Configuration={url:`${D.S0._DefaultCdnUrl}/gltf_validator.js`};let J="Z2xURg",ee="gltf",et={".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}};var ei=i(91083),er=i(2824);function en(e,t,i){try{return Promise.resolve(new Uint8Array(e,t,i))}catch(e){return Promise.reject(e)}}(r=m||(m={}))[r.AUTO=0]="AUTO",r[r.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED",(n=_||(_={}))[n.NONE=0]="NONE",n[n.FIRST=1]="FIRST",n[n.ALL=2]="ALL",(a=g||(g={}))[a.LOADING=0]="LOADING",a[a.READY=1]="READY",a[a.COMPLETE=2]="COMPLETE";class ea{constructor(){this.alwaysComputeBoundingBox=!1,this.alwaysComputeSkeletonRootNode=!1,this.animationStartMode=_.FIRST,this.compileMaterials=!1,this.compileShadowGenerators=!1,this.coordinateSystemMode=m.AUTO,this.createInstances=!0,this.loadAllMaterials=!1,this.loadMorphTargets=!0,this.loadNodeAnimations=!0,this.loadOnlyMaterials=!1,this.loadSkins=!0,this.skipMaterials=!1,this.targetFps=60,this.transparencyAsCoverage=!1,this.useClipPlane=!1,this.useGltfTextureNames=!1,this.useRangeRequests=!1,this.useSRGBBuffers=!0,this.validate=!1,this.useOpenPBR=!1}}let eo=new ea;class es extends ea{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e)}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useOpenPBR=e.useOpenPBR??this.useOpenPBR,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate)}}class el extends es{constructor(e){super(),this.onParsedObservable=new $.cP,this.onMeshLoadedObservable=new $.cP,this.onSkinLoadedObservable=new $.cP,this.onTextureLoadedObservable=new $.cP,this.onMaterialLoadedObservable=new $.cP,this.onCameraLoadedObservable=new $.cP,this.onCompleteObservable=new $.cP,this.onErrorObservable=new $.cP,this.onDisposeObservable=new $.cP,this.onExtensionLoadedObservable=new $.cP,this.onValidatedObservable=new $.cP,this._loader=null,this._state=null,this._requests=[],this.name=ee,this.extensions=et,this.onLoaderStateChangedObservable=new $.cP,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign({...eo},e))}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){for(let e of(this._loader&&(this._loader.dispose(),this._loader=null),this._requests))e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,i,r,n,a,o,s){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,i,r,o,s),null;this._progressCallback=n;let l=t.name||D.S0.GetFilename(t);if(!a)return this._loadFile(e,t,t=>{try{this._validate(e,t,i,l),r({json:this._parseJson(t)})}catch{o&&o()}},!1,o);if(this.useRangeRequests){this.validate&&q.V.Warn("glTF validation is not supported when range requests are enabled");let i={abort:()=>{},onCompleteObservable:new $.cP};return this._unpackBinaryAsync(new Z.s({readAsync:(i,r)=>new Promise((n,a)=>{this._loadFile(e,t,e=>{n(new Uint8Array(e))},!0,e=>{a(e)},e=>{e.setRequestHeader("Range",`bytes=${i}-${i+r-1}`)})}),byteLength:0})).then(e=>{i.onCompleteObservable.notifyObservers(i),r(e)},o?e=>o(void 0,e):void 0),i}return this._loadFile(e,t,t=>{this._validate(e,new Uint8Array(t,0,t.byteLength),i,l),this._unpackBinaryAsync(new Z.s({readAsync:(e,i)=>en(t,e,i),byteLength:t.byteLength})).then(e=>{r(e)},o?e=>o(void 0,e):void 0)},!0,o)}_loadBinary(e,t,i,r,n,a){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i,a),this._unpackBinaryAsync(new Z.s({readAsync:(e,i)=>(function(e,t,i){try{if(t<0||t>=e.byteLength)throw RangeError("Offset is out of range.");if(t+i>e.byteLength)throw RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(e.buffer,e.byteOffset+t,i))}catch(e){return Promise.reject(e)}})(t,e,i),byteLength:t.byteLength})).then(e=>{r(e)},n?e=>n(void 0,e):void 0)}importMeshAsync(e,t,i,r,n,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(i),this._loader.importMeshAsync(e,t,null,i,r,n,a)))}loadAsync(e,t,i,r,n){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,i,r,n)))}loadAssetContainerAsync(e,t,i,r,n){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(t);let a=new W.WZ(e),o=[];this.onMaterialLoadedObservable.add(e=>{o.push(e)});let s=[];this.onTextureLoadedObservable.add(e=>{s.push(e)});let l=[];this.onCameraLoadedObservable.add(e=>{l.push(e)});let c=[];return this.onMeshLoadedObservable.add(e=>{e.morphTargetManager&&c.push(e.morphTargetManager)}),this._loader.importMeshAsync(null,e,a,t,i,r,n).then(e=>(Array.prototype.push.apply(a.geometries,e.geometries),Array.prototype.push.apply(a.meshes,e.meshes),Array.prototype.push.apply(a.particleSystems,e.particleSystems),Array.prototype.push.apply(a.skeletons,e.skeletons),Array.prototype.push.apply(a.animationGroups,e.animationGroups),Array.prototype.push.apply(a.materials,o),Array.prototype.push.apply(a.textures,s),Array.prototype.push.apply(a.lights,e.lights),Array.prototype.push.apply(a.transformNodes,e.transformNodes),Array.prototype.push.apply(a.cameras,l),Array.prototype.push.apply(a.morphTargetManagers,c),a))})}canDirectLoad(e){let t;return -1!==(t=e).indexOf("asset")&&-1!==t.indexOf("version")||t.startsWith("data:base64,"+J)||t.startsWith("data:;base64,"+J)||t.startsWith("data:application/octet-stream;base64,"+J)||t.startsWith("data:model/gltf-binary;base64,"+J)}directLoad(e,t){if(t.startsWith("base64,"+J)||t.startsWith(";base64,"+J)||t.startsWith("application/octet-stream;base64,"+J)||t.startsWith("model/gltf-binary;base64,"+J)){let i=(0,ei.rz)(t);return this._validate(e,new Uint8Array(i,0,i.byteLength)),this._unpackBinaryAsync(new Z.s({readAsync:(e,t)=>en(i,e,t),byteLength:i.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new el(e[ee])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(e=>{t(e)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(g[this._state]))}_loadFile(e,t,i,r,n,a){let o=e._loadFile(t,i,e=>{this._onProgress(e,o)},!0,r,n,a);return o.onCompleteObservable.add(()=>{o._lengthComputable=!0,o._total=o._loaded}),this._requests.push(o),o}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let i=!0,r=0,n=0;for(let e of this._requests){if(void 0===e._lengthComputable||void 0===e._loaded||void 0===e._total)return;i=i&&e._lengthComputable,r+=e._loaded,n+=e._total}this._progressCallback({lengthComputable:i,loaded:r,total:i?n:0})}_validate(e,t,i="",r=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Q.ValidateAsync(t,i,r,t=>this.preprocessUrlAsync(i+t).then(t=>e._loadFileAsync(t,void 0,!0,!0).then(e=>new Uint8Array(e,0,e.byteLength)))).then(e=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(e),this.onValidatedObservable.clear()},e=>{this._endPerformanceCounter("Validate JSON"),D.S0.Warn(`Failed to validate: ${e.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){let t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);let i=el._parseVersion(t.version);if(!i)throw Error("Invalid version: "+t.version);if(void 0!==t.minVersion){let e=el._parseVersion(t.minVersion);if(!e)throw Error("Invalid minimum version: "+t.minVersion);if(el._compareVersion(e,{major:2,minor:0})>0)throw Error("Incompatible minimum version: "+t.minVersion)}let r={1:el._CreateGLTF1Loader,2:el._CreateGLTF2Loader}[i.major];if(!r)throw Error("Unsupported version: "+t.version);return r(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);let t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{let t,i=e.readUint32();if(0x46546c67!==i)throw new er.bu("Unexpected magic: "+i,er.tG.GLTFLoaderUnexpectedMagicError);let r=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${r}`);let n=e.readUint32();switch(!this.useRangeRequests&&n!==e.buffer.byteLength&&q.V.Warn(`Length in header does not match actual data length: ${n} != ${e.buffer.byteLength}`),r){case 1:t=this._unpackBinaryV1Async(e,n);break;case 2:t=this._unpackBinaryV2Async(e,n);break;default:throw Error("Unsupported version: "+r)}return this._endPerformanceCounter("Unpack Binary"),t})}_unpackBinaryV1Async(e,t){let i=e.readUint32(),r=e.readUint32();if(0!==r)throw Error(`Unexpected content format: ${r}`);let n=t-e.byteOffset,a={json:this._parseJson(e.readString(i)),bin:null};if(0!==n){let t=e.byteOffset;a.bin={readAsync:(i,r)=>e.buffer.readAsync(t+i,r),byteLength:n}}return Promise.resolve(a)}_unpackBinaryV2Async(e,t){let i=e.readUint32();if(0x4e4f534a!==e.readUint32())throw Error("First chunk format is not JSON");return e.byteOffset+i===t?e.loadAsync(i).then(()=>({json:this._parseJson(e.readString(i)),bin:null})):e.loadAsync(i+8).then(()=>{let r={json:this._parseJson(e.readString(i)),bin:null},n=()=>{let i=e.readUint32();switch(e.readUint32()){case 0x4e4f534a:throw Error("Unexpected JSON chunk");case 5130562:{let t=e.byteOffset;r.bin={readAsync:(i,r)=>e.buffer.readAsync(t+i,r),byteLength:i},e.skipBytes(i);break}default:e.skipBytes(i)}return e.byteOffset!==t?e.loadAsync(8).then(n):Promise.resolve(r)};return n()})}static _parseVersion(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};let t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){let t=el._logSpaces.substring(0,2*this._logIndentLevel);q.V.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){D.S0.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){D.S0.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}el.IncrementalLoading=!0,el.HomogeneousCoordinates=!1,el._logSpaces="                                ",(0,H.qS)(new el),(o=v||(v={}))[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.FLOAT=5126]="FLOAT",(s=S||(S={}))[s.FRAGMENT=35632]="FRAGMENT",s[s.VERTEX=35633]="VERTEX",(l=E||(E={}))[l.BYTE=5120]="BYTE",l[l.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",l[l.SHORT=5122]="SHORT",l[l.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",l[l.INT=5124]="INT",l[l.UNSIGNED_INT=5125]="UNSIGNED_INT",l[l.FLOAT=5126]="FLOAT",l[l.FLOAT_VEC2=35664]="FLOAT_VEC2",l[l.FLOAT_VEC3=35665]="FLOAT_VEC3",l[l.FLOAT_VEC4=35666]="FLOAT_VEC4",l[l.INT_VEC2=35667]="INT_VEC2",l[l.INT_VEC3=35668]="INT_VEC3",l[l.INT_VEC4=35669]="INT_VEC4",l[l.BOOL=35670]="BOOL",l[l.BOOL_VEC2=35671]="BOOL_VEC2",l[l.BOOL_VEC3=35672]="BOOL_VEC3",l[l.BOOL_VEC4=35673]="BOOL_VEC4",l[l.FLOAT_MAT2=35674]="FLOAT_MAT2",l[l.FLOAT_MAT3=35675]="FLOAT_MAT3",l[l.FLOAT_MAT4=35676]="FLOAT_MAT4",l[l.SAMPLER_2D=35678]="SAMPLER_2D",(c=T||(T={}))[c.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",c[c.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",c[c.REPEAT=10497]="REPEAT",(f=A||(A={}))[f.NEAREST=9728]="NEAREST",f[f.LINEAR=9728]="LINEAR",f[f.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",f[f.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",f[f.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",f[f.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",(u=x||(x={}))[u.ALPHA=6406]="ALPHA",u[u.RGB=6407]="RGB",u[u.RGBA=6408]="RGBA",u[u.LUMINANCE=6409]="LUMINANCE",u[u.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",(d=I||(I={}))[d.FRONT=1028]="FRONT",d[d.BACK=1029]="BACK",d[d.FRONT_AND_BACK=1032]="FRONT_AND_BACK",(h=R||(R={}))[h.ZERO=0]="ZERO",h[h.ONE=1]="ONE",h[h.SRC_COLOR=768]="SRC_COLOR",h[h.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",h[h.DST_COLOR=774]="DST_COLOR",h[h.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",h[h.SRC_ALPHA=770]="SRC_ALPHA",h[h.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",h[h.DST_ALPHA=772]="DST_ALPHA",h[h.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",h[h.CONSTANT_COLOR=32769]="CONSTANT_COLOR",h[h.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",h[h.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",h[h.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",h[h.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE";var ec=i(55322),ef=i(45119),eu=i(65113),ed=i(15947),eh=i(15335),ep=i(91716),em=i(93874),e_=i(95298),eg=i(46538),ev=i(58720),eS=i(44043),eE=i(59903),eT=i(57536),eA=i(96700),ex=i(84774),eI=i(14464),eR=i(32803),eC=i(95881),eb=i(53727);class ey{static SetMatrix(e,t,i,r,n){let a=null;if("MODEL"===i.semantic?a=t.getWorldMatrix():"PROJECTION"===i.semantic?a=e.getProjectionMatrix():"VIEW"===i.semantic?a=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===i.semantic?a=N.uq.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===i.semantic?a=t.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===i.semantic?a=t.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===i.semantic?a=t.getWorldMatrix().invert():"VIEWINVERSE"===i.semantic?a=e.getViewMatrix().invert():"PROJECTIONINVERSE"===i.semantic?a=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===i.semantic?a=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===i.semantic?a=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===i.semantic&&(a=N.uq.Transpose(t.getWorldMatrix().invert())),a)switch(i.type){case E.FLOAT_MAT2:n.setMatrix2x2(r,N.uq.GetAsMatrix2x2(a));break;case E.FLOAT_MAT3:n.setMatrix3x3(r,N.uq.GetAsMatrix3x3(a));break;case E.FLOAT_MAT4:n.setMatrix(r,a)}}static SetUniform(e,t,i,r){switch(r){case E.FLOAT:return e.setFloat(t,i),!0;case E.FLOAT_VEC2:return e.setVector2(t,N.I9.FromArray(i)),!0;case E.FLOAT_VEC3:return e.setVector3(t,N.Pq.FromArray(i)),!0;case E.FLOAT_VEC4:return e.setVector4(t,N.IU.FromArray(i)),!0;default:return!1}}static GetWrapMode(e){switch(e){case T.CLAMP_TO_EDGE:return eg.g.CLAMP_ADDRESSMODE;case T.MIRRORED_REPEAT:return eg.g.MIRROR_ADDRESSMODE;case T.REPEAT:default:return eg.g.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case A.LINEAR:case A.LINEAR_MIPMAP_NEAREST:case A.LINEAR_MIPMAP_LINEAR:return eg.g.TRILINEAR_SAMPLINGMODE;case A.NEAREST:case A.NEAREST_MIPMAP_NEAREST:return eg.g.NEAREST_SAMPLINGMODE;default:return eg.g.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,i,r,n){i=t.byteOffset+i;let a=e.loadedBufferViews[t.buffer];if(i+r>a.byteLength)throw Error("Buffer access is out of range");let o=a.buffer;switch(i+=a.byteOffset,n){case v.BYTE:return new Int8Array(o,i,r);case v.UNSIGNED_BYTE:return new Uint8Array(o,i,r);case v.SHORT:return new Int16Array(o,i,r);case v.UNSIGNED_SHORT:return new Uint16Array(o,i,r);default:return new Float32Array(o,i,r)}}static GetBufferFromAccessor(e,t){let i=e.bufferViews[t.bufferView],r=t.count*ey.GetByteStrideFromType(t);return ey.GetBufferFromBufferView(e,i,t.byteOffset,r,t.componentType)}static DecodeBufferToText(e){let t="",i=e.byteLength;for(let r=0;r<i;++r)t+=String.fromCharCode(e[r]);return t}static GetDefaultMaterial(e){return ey._DefaultMaterial||(ed.M.ShadersStore.GLTFDefaultMaterialVertexShader="precision highp float;\n\nuniform mat4 worldView;\nuniform mat4 projection;\n\nattribute vec3 position;\n\nvoid main(void)\n{\n    gl_Position = projection * worldView * vec4(position, 1.0);\n}",ed.M.ShadersStore.GLTFDefaultMaterialPixelShader="precision highp float;\n\nuniform vec4 u_emission;\n\nvoid main(void)\n{\n    gl_FragColor = u_emission;\n}",ey._DefaultMaterial=new e_.B("GLTFDefaultMaterial",e,{vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},{attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:[],needAlphaBlending:!1}),ey._DefaultMaterial.setColor4("u_emission",new ec.ov(.5,.5,.5,1))),ey._DefaultMaterial}}ey._DefaultMaterial=null;var eL=i(96892);(p=C||(C={}))[p.IDENTIFIER=1]="IDENTIFIER",p[p.UNKNOWN=2]="UNKNOWN",p[p.END_OF_INPUT=3]="END_OF_INPUT";class eM{constructor(e){this._pos=0,this.currentToken=C.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return C.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=C.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=C.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}let eP=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],eN=["world","view","projection","worldView","worldViewProjection","mBones"],eD=["translation","rotation","scale"],eO=["position","rotationQuaternion","scaling"],eF=(e,t,i)=>{for(let r in e){let n=e[r];i[t][r]=n}},ew=e=>{if(e)for(let t=0;t<e.length/2;t++)e[2*t+1]=1-e[2*t+1]},eB=e=>{if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";else if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){let t=Number(e.semantic.split("_")[1]);return"uv"+(0===t?"":t+1)}return null},eU=e=>{let t=null;if(e.translation||e.rotation||e.scale){let i=N.Pq.FromArray(e.scale||[1,1,1]),r=N.PT.FromArray(e.rotation||[0,0,0,1]),n=N.Pq.FromArray(e.translation||[0,0,0]);t=N.uq.Compose(i,r,n)}else t=N.uq.FromArray(e.matrix);return t},eG=(e,t,i,r)=>{for(let e=0;e<r.bones.length;e++)if(r.bones[e].name===i)return r.bones[e];let n=e.nodes;for(let a in n){let o=n[a];if(!o.jointName)continue;let s=o.children;for(let n=0;n<s.length;n++){let l=e.nodes[s[n]];if(l.jointName&&l.jointName===i){let i=eU(o),n=new M.$(o.name||"",r,eG(e,t,o.jointName,r),i);return n.id=a,n}}}return null},eV=(e,t)=>{for(let i=0;i<e.length;i++){let r=e[i];for(let e=0;e<r.node.children.length;e++)if(r.node.children[e]===t)return r.bone}return null},ek=(e,t)=>{let i=e.nodes,r=i[t];if(r)return{node:r,id:t};for(let e in i)if((r=i[e]).jointName===t)return{node:r,id:e};return null},ez=(e,t)=>{for(let i=0;i<e.jointNames.length;i++)if(e.jointNames[i]===t)return!0;return!1},eH=(e,t,i,r,n)=>{let a;if(n||(e.scene._blockEntityCollection=!!e.assetContainer,(n=new ex.e(t.name||"",e.scene))._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,n.id=r),!t.babylonNode)return n;let o=[],s=null,l=[],c=[],f=[],u=[];for(let t=0;t<i.length;t++){let r=i[t],n=e.meshes[r];if(n)for(let t=0;t<n.primitives.length;t++){let i=new ev.P,r=n.primitives[t];r.mode;let a=r.attributes,d=null,h=null;for(let t in a)if(d=e.accessors[a[t]],h=ey.GetBufferFromAccessor(e,d),"NORMAL"===t)i.normals=new Float32Array(h.length),i.normals.set(h);else if("POSITION"===t){if(el.HomogeneousCoordinates){i.positions=new Float32Array(h.length-h.length/4);for(let e=0;e<h.length;e+=4)i.positions[e]=h[e],i.positions[e+1]=h[e+1],i.positions[e+2]=h[e+2]}else i.positions=new Float32Array(h.length),i.positions.set(h);c.push(i.positions.length)}else if(-1!==t.indexOf("TEXCOORD_")){let e=Number(t.split("_")[1]),r=eS.R.UVKind+(0===e?"":e+1),n=new Float32Array(h.length);n.set(h),ew(n),i.set(n,r)}else"JOINT"===t?(i.matricesIndices=new Float32Array(h.length),i.matricesIndices.set(h)):"WEIGHT"===t?(i.matricesWeights=new Float32Array(h.length),i.matricesWeights.set(h)):"COLOR"===t&&(i.colors=new Float32Array(h.length),i.colors.set(h));if(d=e.accessors[r.indices])i.indices=new Int32Array((h=ey.GetBufferFromAccessor(e,d)).length),i.indices.set(h),u.push(i.indices.length);else{let e=[];for(let t=0;t<i.positions.length/3;t++)e.push(t);i.indices=new Int32Array(e),u.push(i.indices.length)}s?s.merge(i):s=i;let p=e.scene.getMaterialById(r.material);o.push(null===p?ey.GetDefaultMaterial(e.scene):p),l.push(0===l.length?0:l[l.length-1]+c[c.length-2]),f.push(0===f.length?0:f[f.length-1]+u[u.length-2])}}e.scene._blockEntityCollection=!!e.assetContainer,o.length>1?(a=new ep.F("multimat"+r,e.scene)).subMaterials=o:a=new em.F("multimat"+r,e.scene),1===o.length&&(a=o[0]),a._parentContainer=e.assetContainer,n.material||(n.material=a),new eE.V(r,e.scene,s,!1,n),n.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,n.subMeshes=[];let d=0;for(let t=0;t<i.length;t++){let r=i[t],a=e.meshes[r];if(a)for(let e=0;e<a.primitives.length;e++)a.primitives[e].mode,eT.K.AddToMesh(d,l[d],c[d],f[d],u[d],n,n,!0),d++}return n},eW=(e,t,i,r)=>{e.position&&(e.position=t),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=i),e.scaling&&(e.scaling=r)},eX=(e,t,i,r=!1)=>{let n=e.nodes[t],a=null;if(r=!e.importOnlyMeshes||!!r||!e.importMeshesNames||-1!==e.importMeshesNames.indexOf(n.name||"")||0===e.importMeshesNames.length,!n.jointName&&r&&null!==(a=((e,t,i)=>{let r=null;if(e.importOnlyMeshes&&(t.skin||t.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(t.name||""))return null;if(t.skin){if(t.meshes){let n=e.skins[t.skin],a=eH(e,t,t.meshes,i,t.babylonNode);a.skeleton=e.scene.getLastSkeletonById(t.skin),null===a.skeleton&&(a.skeleton=((e,t,i,r)=>{if(r||(r=new P.E(t.name||"","",e.scene)),!t.babylonSkeleton)return r;let n=[],a=[];((e,t,i,r)=>{for(let n in e.nodes){let a=e.nodes[n];if(!a.jointName||ez(i,a.jointName))continue;let o=eU(a),s=new M.$(a.name||"",t,null,o);s.id=n,r.push({bone:s,node:a,id:n})}for(let e=0;e<r.length;e++){let t=r[e],i=t.node.children;for(let e=0;e<i.length;e++){let n=null;for(let t=0;t<r.length;t++)if(r[t].id===i[e]){n=r[t];break}n&&(n.bone._parent=t.bone,t.bone.children.push(n.bone))}}})(e,r,t,n),r.bones=[];for(let i=0;i<t.jointNames.length;i++){let o=ek(e,t.jointNames[i]);if(!o)continue;let s=o.node;if(!s){D.S0.Warn("Joint named "+t.jointNames[i]+" does not exist");continue}let l=o.id,c=e.scene.getBoneById(l);if(c){r.bones.push(c);continue}let f=!1,u=null;for(let n=0;n<i;n++){let i=ek(e,t.jointNames[n]);if(!i)continue;let a=i.node;if(!a){D.S0.Warn("Joint named "+t.jointNames[n]+" does not exist when looking for parent");continue}let o=a.children;if(o){f=!1;for(let i=0;i<o.length;i++)if(o[i]===l){u=eG(e,t,t.jointNames[n],r),f=!0;break}if(f)break}}let d=eU(s);!u&&n.length>0&&(u=eV(n,l))&&-1===a.indexOf(u)&&a.push(u),new M.$(s.jointName||"",r,u,d).id=l}let o=r.bones;r.bones=[];for(let i=0;i<t.jointNames.length;i++){let n=ek(e,t.jointNames[i]);if(n){for(let e=0;e<o.length;e++)if(o[e].id===n.id){r.bones.push(o[e]);break}}}r.prepare();for(let e=0;e<a.length;e++)r.bones.push(a[e]);return r})(e,n,0,n.babylonSkeleton),n.babylonSkeleton||(n.babylonSkeleton=a.skeleton)),r=a}}else if(t.meshes)r=eH(e,t,t.mesh?[t.mesh]:t.meshes,i,t.babylonNode);else if(!t.light||t.babylonNode||e.importOnlyMeshes){if(t.camera&&!t.babylonNode&&!e.importOnlyMeshes){let i=e.cameras[t.camera];if(i){if(e.scene._blockEntityCollection=!!e.assetContainer,"orthographic"===i.type){let i=new eu.S(t.camera,N.Pq.Zero(),e.scene,!1);i.name=t.name||"",i.mode=ef.i.ORTHOGRAPHIC_CAMERA,i.attachControl(),r=i,i._parentContainer=e.assetContainer}else if("perspective"===i.type){let n=i[i.type],a=new eu.S(t.camera,N.Pq.Zero(),e.scene,!1);a.name=t.name||"",a.attachControl(),n.aspectRatio||(n.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),n.znear&&n.zfar&&(a.maxZ=n.zfar,a.minZ=n.znear),r=a,a._parentContainer=e.assetContainer}e.scene._blockEntityCollection=!1}}}else{let i=e.lights[t.light];if(i){if("ambient"===i.type){let n=i[i.type],a=new eI.g(t.light,N.Pq.Zero(),e.scene);a.name=t.name||"",n.color&&(a.diffuse=ec.v9.FromArray(n.color)),r=a}else if("directional"===i.type){let n=i[i.type],a=new eR.Z(t.light,N.Pq.Zero(),e.scene);a.name=t.name||"",n.color&&(a.diffuse=ec.v9.FromArray(n.color)),r=a}else if("point"===i.type){let n=i[i.type],a=new eC.H(t.light,N.Pq.Zero(),e.scene);a.name=t.name||"",n.color&&(a.diffuse=ec.v9.FromArray(n.color)),r=a}else if("spot"===i.type){let n=i[i.type],a=new eb.n(t.light,N.Pq.Zero(),N.Pq.Zero(),0,0,e.scene);a.name=t.name||"",n.color&&(a.diffuse=ec.v9.FromArray(n.color)),n.fallOfAngle&&(a.angle=n.fallOfAngle),n.fallOffExponent&&(a.exponent=n.fallOffExponent),r=a}}}if(!t.jointName){if(t.babylonNode)return t.babylonNode;else if(null===r){e.scene._blockEntityCollection=!!e.assetContainer;let i=new ex.e(t.name||"",e.scene);i._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,t.babylonNode=i,r=i}}if(null!==r){if(t.matrix&&r instanceof ex.e){var n=r;if(t.matrix){let e=new N.Pq(0,0,0),i=new N.PT,r=new N.Pq(0,0,0);N.uq.FromArray(t.matrix).decompose(r,i,e),eW(n,e,i,r)}else t.translation&&t.rotation&&t.scale&&eW(n,N.Pq.FromArray(t.translation),N.PT.FromArray(t.rotation),N.Pq.FromArray(t.scale));n.computeWorldMatrix(!0)}else{let e=t.translation||[0,0,0],i=t.rotation||[0,0,0,1],n=t.scale||[1,1,1];eW(r,N.Pq.FromArray(e),N.PT.FromArray(i),N.Pq.FromArray(n))}r.updateCache(!0),t.babylonNode=r}return r})(e,n,t))&&(a.id=t,a.parent=i),n.children)for(let t=0;t<n.children.length;t++)eX(e,n.children[t],a,r)},eY=e=>{let t=e.currentScene;if(t)for(let i=0;i<t.nodes.length;i++)eX(e,t.nodes[i],null);else for(let i in e.scenes){t=e.scenes[i];for(let i=0;i<t.nodes.length;i++)eX(e,t.nodes[i],null)}(e=>{for(let t in e.animations){let i=e.animations[t];if(!i.channels||!i.samplers)continue;let r=null;for(let n=0;n<i.channels.length;n++){let a=i.channels[n],o=i.samplers[a.sampler];if(!o)continue;let s=null,l=null;i.parameters?(s=i.parameters[o.input],l=i.parameters[o.output]):(s=o.input,l=o.output);let c=ey.GetBufferFromAccessor(e,e.accessors[s]),f=ey.GetBufferFromAccessor(e,e.accessors[l]),u=a.target.id,d=e.scene.getNodeById(u);if(null===d&&(d=e.scene.getNodeByName(u)),null===d){D.S0.Warn("Creating animation named "+t+". But cannot find node named "+u+" to attach to");continue}let h=d instanceof M.$,p=a.target.path,m=eD.indexOf(p);-1!==m&&(p=eO[m]);let _=L.X5.ANIMATIONTYPE_MATRIX;h||("rotationQuaternion"===p?(_=L.X5.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new N.PT):_=L.X5.ANIMATIONTYPE_VECTOR3);let g=null,v=[],S=0,E=!1;h&&r&&r.getKeys().length===c.length&&(g=r,E=!0),E||(e.scene._blockEntityCollection=!!e.assetContainer,g=new L.X5(t,h?"_matrix":p,1,_,L.X5.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(let e=0;e<c.length;e++){let t=null;if("rotationQuaternion"===p?(t=N.PT.FromArray([f[S],f[S+1],f[S+2],f[S+3]]),S+=4):(t=N.Pq.FromArray([f[S],f[S+1],f[S+2]]),S+=3),h){let i=d,n=N.Pq.Zero(),a=new N.PT,o=N.Pq.Zero(),s=i.getBaseMatrix();E&&r&&(s=r.getKeys()[e].value),s.decompose(o,a,n),"position"===p?n=t:"rotationQuaternion"===p?a=t:o=t,t=N.uq.Compose(o,a,n)}E?r&&(r.getKeys()[e].value=t):v.push({frame:c[e],value:t})}!E&&g&&(g.setKeys(v),d.animations.push(g)),r=g,e.scene.stopAnimation(d),e.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}})(e);for(let t=0;t<e.scene.skeletons.length;t++){let i=e.scene.skeletons[t];e.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},e$=(e,t,i)=>{for(let r in t.uniforms){let n=t.uniforms[r],a=t.parameters[n];if(e.currentIdentifier===r&&a.semantic&&!a.source&&!a.node){let e=eP.indexOf(a.semantic);if(-1!==e)return delete i[r],eN[e]}}return e.currentIdentifier},eq=e=>{for(let t in e.materials)eK.LoadMaterialAsync(e,t,()=>{},()=>{})};class eZ{static CreateRuntime(e,t,i){let r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&eF(e.extensions,"extensions",r),e.extensionsUsed&&eF(e.extensionsUsed,"extensionsUsed",r),e.buffers&&((e,t)=>{for(let i in e){let r=e[i];t.buffers[i]=r,t.buffersCount++}})(e.buffers,r),e.bufferViews&&eF(e.bufferViews,"bufferViews",r),e.accessors&&eF(e.accessors,"accessors",r),e.meshes&&eF(e.meshes,"meshes",r),e.lights&&eF(e.lights,"lights",r),e.cameras&&eF(e.cameras,"cameras",r),e.nodes&&eF(e.nodes,"nodes",r),e.images&&eF(e.images,"images",r),e.textures&&eF(e.textures,"textures",r),e.shaders&&((e,t)=>{for(let i in e){let r=e[i];t.shaders[i]=r,t.shaderscount++}})(e.shaders,r),e.programs&&eF(e.programs,"programs",r),e.samplers&&eF(e.samplers,"samplers",r),e.techniques&&eF(e.techniques,"techniques",r),e.materials&&eF(e.materials,"materials",r),e.animations&&eF(e.animations,"animations",r),e.skins&&eF(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,i,r,n){let a=e.buffers[t];D.S0.IsBase64(a.uri)?setTimeout(()=>i(new Uint8Array(D.S0.DecodeBase64(a.uri)))):D.S0.LoadFile(e.rootUrl+a.uri,e=>i(new Uint8Array(e)),n,void 0,!0,e=>{e&&r(e.status+" "+e.statusText)})}static LoadTextureBufferAsync(e,t,i,r){let n=e.textures[t];if(!n||!n.source)return void r("");if(n.babylonTexture)return void i(null);let a=e.images[n.source];D.S0.IsBase64(a.uri)?setTimeout(()=>i(new Uint8Array(D.S0.DecodeBase64(a.uri)))):D.S0.LoadFile(e.rootUrl+a.uri,e=>i(new Uint8Array(e)),void 0,void 0,!0,e=>{e&&r(e.status+" "+e.statusText)})}static CreateTextureAsync(e,t,i,r){let n=e.textures[t];if(n.babylonTexture)return void r(n.babylonTexture);let a=e.samplers[n.sampler],o=a.minFilter===A.NEAREST_MIPMAP_NEAREST||a.minFilter===A.NEAREST_MIPMAP_LINEAR||a.minFilter===A.LINEAR_MIPMAP_NEAREST||a.minFilter===A.LINEAR_MIPMAP_LINEAR,s=eg.g.BILINEAR_SAMPLINGMODE,l=null==i?new Blob:new Blob([i]),c=URL.createObjectURL(l),f=()=>URL.revokeObjectURL(c),u=new eg.g(c,e.scene,!o,!0,s,f,f);void 0!==a.wrapS&&(u.wrapU=ey.GetWrapMode(a.wrapS)),void 0!==a.wrapT&&(u.wrapV=ey.GetWrapMode(a.wrapT)),u.name=t,n.babylonTexture=u,r(u)}static LoadShaderStringAsync(e,t,i,r){let n=e.shaders[t];if(D.S0.IsBase64(n.uri)){let e=atob(n.uri.split(",")[1]);i&&i(e)}else D.S0.LoadFile(e.rootUrl+n.uri,i,void 0,void 0,!1,e=>{e&&r&&r(e.status+" "+e.statusText)})}static LoadMaterialAsync(e,t,i,r){let n=e.materials[t];if(!n.technique){r&&r("No technique found.");return}let a=e.techniques[n.technique];if(!a){e.scene._blockEntityCollection=!!e.assetContainer;let r=new em.F(t,e.scene);r._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,r.diffuseColor=new ec.v9(.5,.5,.5),r.sideOrientation=eh.i.CounterClockWiseSideOrientation,i(r);return}let o=e.programs[a.program],s=a.states,l=ed.M.ShadersStore[o.vertexShader+"VertexShader"],c=ed.M.ShadersStore[o.fragmentShader+"PixelShader"],f="",u="",d=new eM(l),h=new eM(c),p={},m=[],_=[],g=[];for(let e in a.uniforms){let t=a.uniforms[e],i=a.parameters[t];if(p[e]=i,!i.semantic||i.node||i.source)i.type===E.SAMPLER_2D?g.push(e):m.push(e);else{let t=eP.indexOf(i.semantic);-1!==t?(m.push(eN[t]),delete p[e]):m.push(e)}}for(let e in a.attributes){let t=a.attributes[e],i=a.parameters[t];if(i.semantic){let e=eB(i);e&&_.push(e)}}for(;!d.isEnd()&&d.getNextToken();){if(d.currentToken!==C.IDENTIFIER){f+=d.currentString;continue}let e=!1;for(let t in a.attributes){let i=a.attributes[t],r=a.parameters[i];if(d.currentIdentifier===t&&r.semantic){f+=eB(r),e=!0;break}}e||(f+=e$(d,a,p))}for(;!h.isEnd()&&h.getNextToken();){if(h.currentToken!==C.IDENTIFIER){u+=h.currentString;continue}u+=e$(h,a,p)}let v={vertex:o.vertexShader+t,fragment:o.fragmentShader+t},S={attributes:_,uniforms:m,samplers:g,needAlphaBlending:s&&s.enable&&-1!==s.enable.indexOf(3042)};ed.M.ShadersStore[o.vertexShader+t+"VertexShader"]=f,ed.M.ShadersStore[o.fragmentShader+t+"PixelShader"]=u;let T=new e_.B(t,e.scene,v,S);if(T.onError=(e,t)=>{T.dispose(!0),r("Cannot compile program named "+o.name+". Error: "+t+". Default material will be applied")},T.onCompiled=t=>{((e,t,i,r,n)=>{let a=r.values||i.parameters,o=i.uniforms;for(let i in n){let s=n[i],l=s.type,c=a[o[i]];if(void 0===c&&(c=s.value),!c)continue;let f=e=>i=>{s.value&&e&&(t.setTexture(e,i),delete n[e])};l===E.SAMPLER_2D?eK.LoadTextureAsync(e,r.values?c:s.value,f(i),()=>f(null)):s.value&&ey.SetUniform(t,i,r.values?c:s.value,l)&&delete n[i]}})(e,T,a,n,p),T.onBind=t=>{((e,t,i,r,n,a,o)=>{let s=a.values||n.parameters;for(let o in i){let l=i[o],c=l.type;if(c===E.FLOAT_MAT2||c===E.FLOAT_MAT3||c===E.FLOAT_MAT4)if(!l.semantic||l.source||l.node){if(l.semantic&&(l.source||l.node)){let e=t.scene.getNodeByName(l.source||l.node||"");if(null===e&&(e=t.scene.getNodeById(l.source||l.node||"")),null===e)continue;ey.SetMatrix(t.scene,e,l,o,r.getEffect())}}else ey.SetMatrix(t.scene,e,l,o,r.getEffect());else{let e=s[n.uniforms[o]];if(!e)continue;if(c===E.SAMPLER_2D){let i=t.textures[a.values?e:l.value].babylonTexture;if(null==i)continue;r.getEffect().setTexture(o,i)}else ey.SetUniform(r.getEffect(),o,e,c)}}o(r)})(t,e,p,T,a,n,i)}},T.sideOrientation=eh.i.CounterClockWiseSideOrientation,s&&s.functions){let e=s.functions;e.cullFace&&e.cullFace[0]!==I.BACK&&(T.backFaceCulling=!1);let t=e.blendFuncSeparate;t&&(t[0]===R.SRC_ALPHA&&t[1]===R.ONE_MINUS_SRC_ALPHA&&t[2]===R.ONE&&t[3]===R.ONE?T.alphaMode=eL.Y.ALPHA_COMBINE:t[0]===R.ONE&&t[1]===R.ONE&&t[2]===R.ZERO&&t[3]===R.ONE?T.alphaMode=eL.Y.ALPHA_ONEONE:t[0]===R.SRC_ALPHA&&t[1]===R.ONE&&t[2]===R.ZERO&&t[3]===R.ONE?T.alphaMode=eL.Y.ALPHA_ADD:t[0]===R.ZERO&&t[1]===R.ONE_MINUS_SRC_COLOR&&t[2]===R.ONE&&t[3]===R.ONE?T.alphaMode=eL.Y.ALPHA_SUBTRACT:t[0]===R.DST_COLOR&&t[1]===R.ZERO&&t[2]===R.ONE&&t[3]===R.ONE?T.alphaMode=eL.Y.ALPHA_MULTIPLY:t[0]===R.SRC_ALPHA&&t[1]===R.ONE_MINUS_SRC_COLOR&&t[2]===R.ONE&&t[3]===R.ONE&&(T.alphaMode=eL.Y.ALPHA_MAXIMIZED))}}}class ej{static RegisterExtension(e){ej.Extensions[e.name]?D.S0.Error('Tool with the same name "'+e.name+'" already exists'):ej.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,i,r,n,a,o,s){return t.useRightHandedSystem=!0,eK.LoadRuntimeAsync(t,i,r,t=>{t.assetContainer=n,t.importOnlyMeshes=!0,""===e?t.importMeshesNames=[]:"string"==typeof e?t.importMeshesNames=[e]:!e||e instanceof Array?(t.importMeshesNames=[],D.S0.Warn("Argument meshesNames must be of type string or string[]")):t.importMeshesNames=[e],this._createNodes(t);let i=[],r=[];for(let e in t.nodes){let r=t.nodes[e];r.babylonNode instanceof eA.u&&i.push(r.babylonNode)}for(let e in t.skins){let i=t.skins[e];i.babylonSkeleton instanceof P.E&&r.push(i.babylonSkeleton)}this._loadBuffersAsync(t,()=>{this._loadShadersAsync(t,()=>{eq(t),eY(t),!el.IncrementalLoading&&a&&a(i,r)})}),el.IncrementalLoading&&a&&a(i,r)},s),!0}importMeshAsync(e,t,i,r,n,a){return new Promise((o,s)=>{this._importMeshAsync(e,t,r,n,i,(e,t)=>{o({meshes:e,particleSystems:[],skeletons:t,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},a,e=>{s(Error(e))})})}_loadAsync(e,t,i,r,n,a){e.useRightHandedSystem=!0,eK.LoadRuntimeAsync(e,t,i,e=>{eK.LoadRuntimeExtensionsAsync(e,()=>{this._createNodes(e),this._loadBuffersAsync(e,()=>{this._loadShadersAsync(e,()=>{eq(e),eY(e),el.IncrementalLoading||r()})}),el.IncrementalLoading&&r()},a)},a)}async loadAsync(e,t,i,r){return await new Promise((n,a)=>{this._loadAsync(e,t,i,()=>{n()},r,e=>{a(Error(e))})})}_loadShadersAsync(e,t){let i=!1,r=(i,r)=>{eK.LoadShaderStringAsync(e,i,n=>{n instanceof ArrayBuffer||(e.loadedShaderCount++,n&&(ed.M.ShadersStore[i+(r.type===S.VERTEX?"VertexShader":"PixelShader")]=n),e.loadedShaderCount===e.shaderscount&&t())},()=>{D.S0.Error("Error when loading shader program named "+i+" located at "+r.uri)})};for(let t in e.shaders){i=!0;let n=e.shaders[t];n?r.bind(this,t,n)():D.S0.Error("No shader named: "+t)}i||t()}_loadBuffersAsync(e,t){let i=!1,r=(i,r)=>{eK.LoadBufferAsync(e,i,n=>{e.loadedBufferCount++,n&&(n.byteLength!=e.buffers[i].byteLength&&D.S0.Error("Buffer named "+i+" is length "+n.byteLength+". Expected: "+r.byteLength),e.loadedBufferViews[i]=n),e.loadedBufferCount===e.buffersCount&&t()},()=>{D.S0.Error("Error when loading buffer named "+i+" located at "+r.uri)})};for(let t in e.buffers){i=!0;let n=e.buffers[t];n?r.bind(this,t,n)():D.S0.Error("No buffer named: "+t)}i||t()}_createNodes(e){let t=e.currentScene;if(t)for(let i=0;i<t.nodes.length;i++)eX(e,t.nodes[i],null);else for(let i in e.scenes){t=e.scenes[i];for(let i=0;i<t.nodes.length;i++)eX(e,t.nodes[i],null)}}}ej.Extensions={};class eK{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,r,n){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,r,n){return!1}loadTextureBufferAsync(e,t,i,r){return!1}createTextureAsync(e,t,i,r,n){return!1}loadShaderStringAsync(e,t,i,r){return!1}loadMaterialAsync(e,t,i,r){return!1}static LoadRuntimeAsync(e,t,i,r,n){eK._ApplyExtensions(a=>a.loadRuntimeAsync(e,t,i,r,n),()=>{setTimeout(()=>{r&&r(eZ.CreateRuntime(t.json,e,i))})})}static LoadRuntimeExtensionsAsync(e,t,i){eK._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,i),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,i,r,n){eK._ApplyExtensions(a=>a.loadBufferAsync(e,t,i,r,n),()=>{eZ.LoadBufferAsync(e,t,i,r,n)})}static LoadTextureAsync(e,t,i,r){eK._LoadTextureBufferAsync(e,t,n=>{n&&eK._CreateTextureAsync(e,t,n,i,r)},r)}static LoadShaderStringAsync(e,t,i,r){eK._ApplyExtensions(n=>n.loadShaderStringAsync(e,t,i,r),()=>{eZ.LoadShaderStringAsync(e,t,i,r)})}static LoadMaterialAsync(e,t,i,r){eK._ApplyExtensions(n=>n.loadMaterialAsync(e,t,i,r),()=>{eZ.LoadMaterialAsync(e,t,i,r)})}static _LoadTextureBufferAsync(e,t,i,r){eK._ApplyExtensions(n=>n.loadTextureBufferAsync(e,t,i,r),()=>{eZ.LoadTextureBufferAsync(e,t,i,r)})}static _CreateTextureAsync(e,t,i,r,n){eK._ApplyExtensions(a=>a.createTextureAsync(e,t,i,r,n),()=>{eZ.CreateTextureAsync(e,t,i,r)})}static _ApplyExtensions(e,t){for(let t in ej.Extensions)if(e(ej.Extensions[t]))return;t()}}el._CreateGLTF1Loader=()=>new ej;class eQ extends eK{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,r){let n=t.json.extensionsUsed;return!!n&&-1!==n.indexOf(this.name)&&!!t.bin&&(this._bin=t.bin,r(eZ.CreateRuntime(t.json,e,i)),!0)}loadBufferAsync(e,t,i,r){return -1!==e.extensionsUsed.indexOf(this.name)&&"binary_glTF"===t&&(this._bin.readAsync(0,this._bin.byteLength).then(i,e=>r(e.message)),!0)}loadTextureBufferAsync(e,t,i){let r=e.textures[t],n=e.images[r.source];if(!n.extensions||!(this.name in n.extensions))return!1;let a=n.extensions[this.name],o=e.bufferViews[a.bufferView];return i(ey.GetBufferFromBufferView(e,o,0,o.byteLength,v.UNSIGNED_BYTE)),!0}loadShaderStringAsync(e,t,i){let r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;let n=r.extensions[this.name],a=e.bufferViews[n.bufferView],o=ey.GetBufferFromBufferView(e,a,0,a.byteLength,v.UNSIGNED_BYTE);return setTimeout(()=>{i(ey.DecodeBufferToText(o))}),!0}}ej.RegisterExtension(new eQ);class eJ extends eK{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;let t=e.extensions[this.name];if(!t)return!1;let i=t.lights;if(i)for(let t in i){let r=i[t];switch(r.type){case"ambient":{let t=new eI.g(r.name,new N.Pq(0,1,0),e.scene),i=r.ambient;i&&(t.diffuse=ec.v9.FromArray(i.color||[1,1,1]));break}case"point":{let t=new eC.H(r.name,new N.Pq(10,10,10),e.scene),i=r.point;i&&(t.diffuse=ec.v9.FromArray(i.color||[1,1,1]));break}case"directional":{let t=new eR.Z(r.name,new N.Pq(0,-1,0),e.scene),i=r.directional;i&&(t.diffuse=ec.v9.FromArray(i.color||[1,1,1]));break}case"spot":{let t=r.spot;t&&(new eb.n(r.name,new N.Pq(0,10,0),new N.Pq(0,-1,0),t.fallOffAngle||Math.PI,t.fallOffExponent||0,e.scene).diffuse=ec.v9.FromArray(t.color||[1,1,1]));break}default:D.S0.Warn('GLTF Material Common extension: light type "'+r.type+"” not supported")}}return!1}loadMaterialAsync(e,t,i,r){let n=e.materials[t];if(!n||!n.extensions)return!1;let a=n.extensions[this.name];if(!a)return!1;let o=new em.F(t,e.scene);return o.sideOrientation=eh.i.CounterClockWiseSideOrientation,"CONSTANT"===a.technique&&(o.disableLighting=!0),o.backFaceCulling=void 0!==a.doubleSided&&!a.doubleSided,o.alpha=void 0===a.values.transparency?1:a.values.transparency,o.specularPower=void 0===a.values.shininess?0:a.values.shininess,"string"==typeof a.values.ambient?this._loadTexture(e,a.values.ambient,o,"ambientTexture",r):o.ambientColor=ec.v9.FromArray(a.values.ambient||[0,0,0]),"string"==typeof a.values.diffuse?this._loadTexture(e,a.values.diffuse,o,"diffuseTexture",r):o.diffuseColor=ec.v9.FromArray(a.values.diffuse||[0,0,0]),"string"==typeof a.values.emission?this._loadTexture(e,a.values.emission,o,"emissiveTexture",r):o.emissiveColor=ec.v9.FromArray(a.values.emission||[0,0,0]),"string"==typeof a.values.specular?this._loadTexture(e,a.values.specular,o,"specularTexture",r):o.specularColor=ec.v9.FromArray(a.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,r,n){eZ.LoadTextureBufferAsync(e,t,n=>{eZ.CreateTextureAsync(e,t,n,e=>i[r]=e)},n)}}ej.RegisterExtension(new eJ);var e0=i(67939),e1=i(89671),e2=i(99039),e3=i(17428),e4=i(28836);let e5=new Map,e8=e5;function e6(e,t,i){e9(e)&&q.V.Warn(`Extension with the name '${e}' already exists`),e5.set(e,{isGLTFExtension:t,factory:i})}function e9(e){return e5.delete(e)}var e7=i(23751),te=i(19516),tt=i(55514),ti=i(57610);let tr=new ti.d(()=>Promise.resolve().then(i.bind(i,49556))),tn=new ti.d(()=>Promise.resolve().then(i.bind(i,13695)));class ta{static Get(e,t,i){if(!t||void 0==i||!t[i])throw Error(`${e}: Failed to find index (${i})`);return t[i]}static TryGet(e,t){return e&&void 0!=t&&e[t]?e[t]:null}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}function to(e){if(e.min&&e.max){let t=e.min,i=e.max,r=N.AA.Vector3["0"].copyFromFloats(t[0],t[1],t[2]),n=N.AA.Vector3["1"].copyFromFloats(i[0],i[1],i[2]);if(e.normalized&&5126!==e.componentType){let t=1;switch(e.componentType){case 5120:t=127;break;case 5121:t=255;break;case 5122:t=32767;break;case 5123:t=65535}let i=1/t;r.scaleInPlace(i),n.scaleInPlace(i)}return new e4.j(r,n)}return null}class ts{static RegisterExtension(e,t){e6(e,!1,t)}static UnregisterExtension(e){return e9(e)}get gltf(){if(!this._gltf)throw Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=[],this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=[],this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=[],this._materialAdapterCache=new WeakMap,this._pbrMaterialImpl=null,this._parent=e}_getOrCreateMaterialAdapter(e){let t=this._materialAdapterCache.get(e);if(!t){if(this._pbrMaterialImpl)t=new this._pbrMaterialImpl.adapterClass(e);else throw Error("Appropriate material adapter class not found");this._materialAdapterCache.set(e,t)}return t}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}async importMeshAsync(e,t,i,r,n,a,o=""){return await Promise.resolve().then(async()=>{this._babylonScene=t,this._assetContainer=i,this._loadData(r);let a=null;if(e){let t={};if(this._gltf.nodes)for(let e of this._gltf.nodes)e.name&&(t[e.name]=e.index);a=(e instanceof Array?e:[e]).map(e=>{let i=t[e];if(void 0===i)throw Error(`Failed to find node '${e}'`);return i})}return await this._loadAsync(n,o,a,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}async loadAsync(e,t,i,r,n=""){return this._babylonScene=e,this._loadData(t),await this._loadAsync(i,n,null,()=>void 0)}async _loadAsync(e,t,r,n){return await Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync(),this.parent.skipMaterials||null!=this._pbrMaterialImpl||(this.parent.useOpenPBR||this.isExtensionUsed("KHR_materials_openpbr")?this._pbrMaterialImpl={materialClass:(await Promise.resolve().then(i.bind(i,38782))).OpenPBRMaterial,adapterClass:(await Promise.resolve().then(i.bind(i,17165))).OpenPBRMaterialLoadingAdapter}:this._pbrMaterialImpl={materialClass:(await Promise.resolve().then(i.bind(i,27550))).PBRMaterial,adapterClass:(await Promise.resolve().then(i.bind(i,15077))).PBRMaterialLoadingAdapter});let a=`${g[g.LOADING]} => ${g[g.READY]}`,o=`${g[g.LOADING]} => ${g[g.COMPLETE]}`;this._parent._startPerformanceCounter(a),this._parent._startPerformanceCounter(o),this._parent._setState(g.LOADING),this._extensionsOnLoading();let s=[],l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(r)s.push(this.loadSceneAsync("/nodes",{nodes:r,index:-1}));else if(void 0!=this._gltf.scene||this._gltf.scenes&&this._gltf.scenes[0]){let e=ta.Get("/scene",this._gltf.scenes,this._gltf.scene||0);s.push(this.loadSceneAsync(`/scenes/${e.index}`,e))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let e=0;e<this._gltf.materials.length;++e){let t=this._gltf.materials[e],i="/materials/"+e,r=eh.i.TriangleFillMode;s.push(this._loadMaterialAsync(i,t,null,r,()=>{}))}this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&s.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&s.push(this._compileShadowGeneratorsAsync());let c=Promise.all(s).then(()=>{for(let e of(this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0),this._babylonScene.materials))void 0!==e.maxSimultaneousLights&&(e.maxSimultaneousLights=Math.max(e.maxSimultaneousLights,this._babylonScene.lights.length));return this._extensionsOnReady(),this._parent._setState(g.READY),this._skipStartAnimationStep||this._startAnimations(),n()});return await c.then(e=>(this._parent._endPerformanceCounter(a),D.S0.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(o),this._parent._setState(g.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},e=>{this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()})}),e))}).catch(e=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(e),this._parent.onErrorObservable.clear(),this.dispose()),e})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){let t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){let i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&q.V.Warn(`Binary buffer length (${i.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else q.V.Warn("Unexpected BIN chunk")}}_setupData(){if(ta.Assign(this._gltf.accessors),ta.Assign(this._gltf.animations),ta.Assign(this._gltf.buffers),ta.Assign(this._gltf.bufferViews),ta.Assign(this._gltf.cameras),ta.Assign(this._gltf.images),ta.Assign(this._gltf.materials),ta.Assign(this._gltf.meshes),ta.Assign(this._gltf.nodes),ta.Assign(this._gltf.samplers),ta.Assign(this._gltf.scenes),ta.Assign(this._gltf.skins),ta.Assign(this._gltf.textures),this._gltf.nodes){let e={};for(let t of this._gltf.nodes)if(t.children)for(let i of t.children)e[i]=t.index;let t=this._createRootNode();for(let i of this._gltf.nodes){let r=e[i.index];i.parent=void 0===r?t:this._gltf.nodes[r]}}}async _loadExtensionsAsync(){let e=[];if(e8.forEach((t,i)=>{this.parent.extensionOptions[i]?.enabled===!1?t.isGLTFExtension&&this.isExtensionUsed(i)&&q.V.Warn(`Extension ${i} is used but has been explicitly disabled.`):(!t.isGLTFExtension||this.isExtensionUsed(i))&&e.push((async()=>{let e=await t.factory(this);return e.name!==i&&q.V.Warn(`The name of the glTF loader extension instance does not match the registered name: ${e.name} !== ${i}`),this._parent.onExtensionLoadedObservable.notifyObservers(e),e})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(let e of this._gltf.extensionsRequired)if(!this._extensions.some(t=>t.name===e&&t.enabled)){if(this.parent.extensionOptions[e]?.enabled===!1)throw Error(`Required extension ${e} is disabled`);throw Error(`Required extension ${e} is not available`)}}}_createRootNode(){if(void 0!==this._parent.customRootNode)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:null===this._rootBabylonMesh?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;let e=new ex.e("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);let t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case m.AUTO:this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],ts._LoadTransform(t,this._rootBabylonMesh));break;case m.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){let i=this._extensionsLoadSceneAsync(e,t);if(i)return i;let r=[];if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(let i of t.nodes){let t=ta.Get(`${e}/nodes/${i}`,this._gltf.nodes,i);r.push(this.loadNodeAsync(`/nodes/${t.index}`,t,e=>{e.parent=this._rootBabylonMesh}))}for(let e of this._postSceneLoadActions)e();return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(let i of e._primitiveBabylonMeshes)t(i)}_getGeometries(){let e=[],t=this._gltf.nodes;if(t)for(let i of t)this._forEachPrimitive(i,t=>{let i=t.geometry;i&&-1===e.indexOf(i)&&e.push(i)});return e}_getMeshes(){let e=[];this._rootBabylonMesh instanceof eA.u&&e.push(this._rootBabylonMesh);let t=this._gltf.nodes;if(t)for(let i of t)this._forEachPrimitive(i,t=>{e.push(t)});return e}_getTransformNodes(){let e=[],t=this._gltf.nodes;if(t)for(let i of t)i._babylonTransformNode&&"TransformNode"===i._babylonTransformNode.getClassName()&&e.push(i._babylonTransformNode),i._babylonTransformNodeForSkin&&e.push(i._babylonTransformNodeForSkin);return e}_getSkeletons(){let e=[],t=this._gltf.skins;if(t)for(let i of t)i._data&&e.push(i._data.babylonSkeleton);return e}_getAnimationGroups(){let e=[],t=this._gltf.animations;if(t)for(let i of t)i._babylonAnimationGroup&&e.push(i._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case _.NONE:break;case _.FIRST:{let e=this._getAnimationGroups();0!==e.length&&e[0].start(!0);break}case _.ALL:for(let e of this._getAnimationGroups())e.start(!0);break;default:return void q.V.Error(`Invalid animation start mode (${this._parent.animationStartMode})`)}}loadNodeAsync(e,t,i=()=>{}){let r=this._extensionsLoadNodeAsync(e,t,i);if(r)return r;if(t._babylonTransformNode)throw Error(`${e}: Invalid recursive node hierarchy`);let n=[];this.logOpen(`${e} ${t.name||""}`);let a=r=>{if(ts.AddPointerMetadata(r,e),ts._LoadTransform(t,r),void 0!=t.camera){let i=ta.Get(`${e}/camera`,this._gltf.cameras,t.camera);n.push(this.loadCameraAsync(`/cameras/${i.index}`,i,e=>{e.parent=r,this._babylonScene.useRightHandedSystem||(r.scaling.x=-1)}))}if(t.children)for(let i of t.children){let t=ta.Get(`${e}/children/${i}`,this._gltf.nodes,i);n.push(this.loadNodeAsync(`/nodes/${t.index}`,t,e=>{e.parent=r}))}i(r)},o=void 0!=t.mesh,s=this._parent.loadSkins&&void 0!=t.skin;if(!o||s){let e=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let i=new e1.V(e,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,void 0==t.mesh?t._babylonTransformNode=i:t._babylonTransformNodeForSkin=i,a(i)}if(o)if(s){let i=ta.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);n.push(this._loadMeshAsync(`/meshes/${i.index}`,t,i,i=>{let r=t._babylonTransformNodeForSkin;i.metadata=(0,te.$)(r.metadata,i.metadata||{});let a=ta.Get(`${e}/skin`,this._gltf.skins,t.skin);n.push(this._loadSkinAsync(`/skins/${a.index}`,t,a,e=>{this._forEachPrimitive(t,t=>{t.skeleton=e}),this._postSceneLoadActions.push(()=>{if(void 0!=a.skeleton){let e=ta.Get(`/skins/${a.index}/skeleton`,this._gltf.nodes,a.skeleton).parent;t.index===e.index?i.parent=r.parent:i.parent=e._babylonTransformNode}else i.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:r,skinnedNode:i})})}))}))}else{let i=ta.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);n.push(this._loadMeshAsync(`/meshes/${i.index}`,t,i,a))}return this.logClose(),Promise.all(n).then(()=>(this._forEachPrimitive(t,e=>{!e.isAnInstance&&e.geometry&&e.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,i,r){let n=i.primitives;if(!n||!n.length)throw Error(`${e}: Primitives are missing`);void 0==n[0].index&&ta.Assign(n);let a=[];this.logOpen(`${e} ${i.name||""}`);let o=t.name||`node${t.index}`;if(1===n.length){let r=i.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${r.index}`,o,t,i,r,e=>{t._babylonTransformNode=e,t._primitiveBabylonMeshes=[e]}))}else for(let r of(this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new e1.V(o,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[],n))a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${r.index}`,`${o}_primitive${r.index}`,t,i,r,e=>{e.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(e)}));return r(t._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,i,r,n,a){let o,s,l=this._extensionsLoadMeshPrimitiveAsync(e,t,i,r,n,a);if(l)return l;this.logOpen(`${e}`);let c=0===this._disableInstancedMesh&&this._parent.createInstances&&void 0==i.skin&&!r.primitives[0].targets;if(c&&n._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,(o=n._instanceData.babylonSourceMesh.createInstance(t))._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s=n._instanceData.promise;else{let a=[];this._babylonScene._blockEntityCollection=!!this._assetContainer;let l=new ex.e(t,this._babylonScene);if(l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.sideOrientation=this._babylonScene.useRightHandedSystem?eh.i.CounterClockWiseSideOrientation:eh.i.ClockWiseSideOrientation,this._createMorphTargets(e,i,r,n,l),a.push(this._loadVertexDataAsync(e,n,l).then(async t=>await this._loadMorphTargetsAsync(e,n,l,t).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,t.applyToMesh(l),t._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)}))),!this.parent.skipMaterials){let t=ts._GetDrawMode(e,n.mode);if(void 0==n.material){let e=this._defaultBabylonMaterialData[t];e||(e=this._createDefaultMaterial("__GLTFLoader._default",t),this._parent.onMaterialLoadedObservable.notifyObservers(e),this._defaultBabylonMaterialData[t]=e),l.material=e}else{let i=ta.Get(`${e}/material`,this._gltf.materials,n.material);a.push(this._loadMaterialAsync(`/materials/${i.index}`,i,l,t,e=>{l.material=e}))}}s=Promise.all(a),c&&(n._instanceData={babylonSourceMesh:l,promise:s}),o=l}return ts.AddPointerMetadata(o,e),this._parent.onMeshLoadedObservable.notifyObservers(o),a(o),this.logClose(),s.then(()=>o)}_loadVertexDataAsync(e,t,i){let r=this._extensionsLoadVertexDataAsync(e,t,i);if(r)return r;let n=t.attributes;if(!n)throw Error(`${e}: Attributes are missing`);let a=[],o=new eE.V(i.name,this._babylonScene);if(void 0==t.indices)i.isUnIndexed=!0;else{let i=ta.Get(`${e}/indices`,this._gltf.accessors,t.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${i.index}`,i).then(e=>{o.setIndices(e)}))}let s=(t,r,s)=>{if(void 0==n[t])return;i._delayInfo=i._delayInfo||[],-1===i._delayInfo.indexOf(r)&&i._delayInfo.push(r);let l=ta.Get(`${e}/attributes/${t}`,this._gltf.accessors,n[t]);a.push(this._loadVertexAccessorAsync(`/accessors/${l.index}`,l,r).then(e=>{if(e.getKind()===eS.R.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!i.skeleton){let e=to(l);e&&(o._boundingInfo=e,o.useBoundingInfoFromGeometry=!0)}o.setVerticesBuffer(e,l.count)})),r==eS.R.MatricesIndicesExtraKind&&(i.numBoneInfluencers=8),s&&s(l)};return s("POSITION",eS.R.PositionKind),s("NORMAL",eS.R.NormalKind),s("TANGENT",eS.R.TangentKind),s("TEXCOORD_0",eS.R.UVKind),s("TEXCOORD_1",eS.R.UV2Kind),s("TEXCOORD_2",eS.R.UV3Kind),s("TEXCOORD_3",eS.R.UV4Kind),s("TEXCOORD_4",eS.R.UV5Kind),s("TEXCOORD_5",eS.R.UV6Kind),s("JOINTS_0",eS.R.MatricesIndicesKind),s("WEIGHTS_0",eS.R.MatricesWeightsKind),s("JOINTS_1",eS.R.MatricesIndicesExtraKind),s("WEIGHTS_1",eS.R.MatricesWeightsExtraKind),s("COLOR_0",eS.R.ColorKind,e=>{"VEC4"===e.type&&(i.hasVertexAlpha=!0)}),Promise.all(a).then(()=>o)}_createMorphTargets(e,t,i,r,n){if(!r.targets||!this._parent.loadMorphTargets)return;if(void 0==t._numMorphTargets)t._numMorphTargets=r.targets.length;else if(r.targets.length!==t._numMorphTargets)throw Error(`${e}: Primitives do not have the same number of targets`);let a=i.extras?i.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,n.morphTargetManager=new e3.j(this._babylonScene),n.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.morphTargetManager.areUpdatesFrozen=!0;for(let e=0;e<r.targets.length;e++){let r=t.weights?t.weights[e]:i.weights?i.weights[e]:0,o=a?a[e]:`morphTarget${e}`;n.morphTargetManager.addTarget(new e2.M(o,r,n.getScene()))}}_loadMorphTargetsAsync(e,t,i,r){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();let n=[],a=i.morphTargetManager;for(let i=0;i<a.numTargets;i++){let o=a.getTarget(i);n.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${i}`,r,t.targets[i],o))}return Promise.all(n).then(()=>{a.areUpdatesFrozen=!1})}async _loadMorphTargetVertexDataAsync(e,t,i,r){let n=[],a=(r,a,o)=>{if(void 0==i[r])return;let s=t.getVertexBuffer(a);if(!s)return;let l=ta.Get(`${e}/${r}`,this._gltf.accessors,i[r]);n.push(this._loadFloatAccessorAsync(`/accessors/${l.index}`,l).then(e=>{o(s,e)}))};return a("POSITION",eS.R.PositionKind,(e,t)=>{let i=new Float32Array(t.length);e.forEach(t.length,(e,r)=>{i[r]=t[r]+e}),r.setPositions(i)}),a("NORMAL",eS.R.NormalKind,(e,t)=>{let i=new Float32Array(t.length);e.forEach(i.length,(e,r)=>{i[r]=t[r]+e}),r.setNormals(i)}),a("TANGENT",eS.R.TangentKind,(e,t)=>{let i=new Float32Array(t.length/3*4),n=0;e.forEach(t.length/3*4,(e,r)=>{(r+1)%4!=0&&(i[n]=t[n]+e,n++)}),r.setTangents(i)}),a("TEXCOORD_0",eS.R.UVKind,(e,t)=>{let i=new Float32Array(t.length);e.forEach(t.length,(e,r)=>{i[r]=t[r]+e}),r.setUVs(i)}),a("TEXCOORD_1",eS.R.UV2Kind,(e,t)=>{let i=new Float32Array(t.length);e.forEach(t.length,(e,r)=>{i[r]=t[r]+e}),r.setUV2s(i)}),a("COLOR_0",eS.R.ColorKind,(t,i)=>{let n=null,a=t.getSize();if(3===a){n=new Float32Array(i.length/3*4),t.forEach(i.length,(e,t)=>{let r=Math.floor(t/3),a=t%3;n[4*r+a]=i[3*r+a]+e});for(let e=0;e<i.length/3;++e)n[4*e+3]=1}else if(4===a)n=new Float32Array(i.length),t.forEach(i.length,(e,t)=>{n[t]=i[t]+e});else throw Error(`${e}: Invalid number of components (${a}) for COLOR_0 attribute`);r.setColors(n)}),await Promise.all(n).then(()=>{})}static _LoadTransform(e,t){if(void 0!=e.skin)return;let i=N.Pq.Zero(),r=N.PT.Identity(),n=N.Pq.One();e.matrix?N.uq.FromArray(e.matrix).decompose(n,r,i):(e.translation&&(i=N.Pq.FromArray(e.translation)),e.rotation&&(r=N.PT.FromArray(e.rotation)),e.scale&&(n=N.Pq.FromArray(e.scale))),t.position=i,t.rotationQuaternion=r,t.scaling=n}_loadSkinAsync(e,t,i,r){if(!this._parent.loadSkins)return Promise.resolve();let n=this._extensionsLoadSkinAsync(e,t,i);if(n)return n;if(i._data)return r(i._data.babylonSkeleton),i._data.promise;let a=`skeleton${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let o=new P.E(i.name||a,a,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,i,o);let s=this._loadSkinInverseBindMatricesDataAsync(e,i).then(e=>{this._updateBoneMatrices(o,e)});return i._data={babylonSkeleton:o,promise:s},r(o),s}_loadBones(e,t,i){if(void 0==t.skeleton||this._parent.alwaysComputeSkeletonRootNode){let i=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(i)if(void 0===t.skeleton)t.skeleton=i.index;else{let r=ta.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);r===i||((e,t)=>{for(;t.parent;t=t.parent)if(t.parent===e)return!0;return!1})(r,i)||(q.V.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=i.index)}else q.V.Warn(`${e}: Failed to find common root`)}let r={};for(let n of t.joints){let a=ta.Get(`${e}/joints/${n}`,this._gltf.nodes,n);this._loadBone(a,t,i,r)}}_findSkeletonRootNode(e,t){if(0===t.length)return null;let i={};for(let r of t){let t=[],n=ta.Get(`${e}/${r}`,this._gltf.nodes,r);for(;-1!==n.index;)t.unshift(n),n=n.parent;i[r]=t}let r=null;for(let e=0;;++e){let n=i[t[0]];if(e>=n.length)return r;let a=n[e];for(let o=1;o<t.length;++o)if(e>=(n=i[t[o]]).length||a!==n[e])return r;r=a}}_loadBone(e,t,i,r){e._isJoint=!0;let n=r[e.index];if(n)return n;let a=null;e.index!==t.skeleton&&(e.parent&&-1!==e.parent.index?a=this._loadBone(e.parent,t,i,r):void 0!==t.skeleton&&q.V.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));let o=t.joints.indexOf(e.index);return n=new M.$(e.name||`joint${e.index}`,i,a,this._getNodeMatrix(e),null,null,o),r[e.index]=n,this._postSceneLoadActions.push(()=>{n.linkTransformNode(e._babylonTransformNode)}),n}_loadSkinInverseBindMatricesDataAsync(e,t){if(void 0==t.inverseBindMatrices)return Promise.resolve(null);let i=ta.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)}_updateBoneMatrices(e,t){for(let i of e.bones){let e=N.uq.Identity(),r=i._index;t&&-1!==r&&(N.uq.FromArrayToRef(t,16*r,e),e.invertToRef(e));let n=i.getParent();n&&e.multiplyToRef(n.getAbsoluteInverseBindMatrix(),e),i.updateMatrix(e,!1,!1),i._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?N.uq.FromArray(e.matrix):N.uq.Compose(e.scale?N.Pq.FromArray(e.scale):N.Pq.One(),e.rotation?N.PT.FromArray(e.rotation):N.PT.Identity(),e.translation?N.Pq.FromArray(e.translation):N.Pq.Zero())}loadCameraAsync(e,t,i=()=>{}){let r=this._extensionsLoadCameraAsync(e,t,i);if(r)return r;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;let n=new eu.S(t.name||`camera${t.index}`,N.Pq.Zero(),this._babylonScene,!1);switch(n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonCamera=n,n.setTarget(new N.Pq(0,0,-1)),t.type){case"perspective":{let i=t.perspective;if(!i)throw Error(`${e}: Camera perspective properties are missing`);n.fov=i.yfov,n.minZ=i.znear,n.maxZ=i.zfar||0;break}case"orthographic":if(!t.orthographic)throw Error(`${e}: Camera orthographic properties are missing`);n.mode=ef.i.ORTHOGRAPHIC_CAMERA,n.orthoLeft=-t.orthographic.xmag,n.orthoRight=t.orthographic.xmag,n.orthoBottom=-t.orthographic.ymag,n.orthoTop=t.orthographic.ymag,n.minZ=t.orthographic.znear,n.maxZ=t.orthographic.zfar;break;default:throw Error(`${e}: Invalid camera type (${t.type})`)}return ts.AddPointerMetadata(n,e),this._parent.onCameraLoadedObservable.notifyObservers(n),i(n),this.logClose(),Promise.all([]).then(()=>n)}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");let e=this._gltf.animations;if(!e)return Promise.resolve();let t=[];for(let i=0;i<e.length;i++){let r=e[i];t.push(this.loadAnimationAsync(`/animations/${r.index}`,r).then(e=>{0===e.targetedAnimations.length&&e.dispose()}))}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Load animations")})}loadAnimationAsync(e,t){this._parent._startPerformanceCounter("Load animation");let i=this._extensionsLoadAnimationAsync(e,t);return i||tr.value.then(({AnimationGroup:i})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;let r=new i(t.name||`animation${t.index}`,this._babylonScene);r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=r;let n=[];for(let i of(ta.Assign(t.channels),ta.Assign(t.samplers),t.channels))n.push(this._loadAnimationChannelAsync(`${e}/channels/${i.index}`,e,t,i,(e,t)=>{e.animations=e.animations||[],e.animations.push(t),r.addTargetedAnimation(t,e)}));return this._parent._endPerformanceCounter("Load animation"),Promise.all(n).then(()=>(r.normalize(0),r))})}_loadAnimationChannelAsync(e,t,i,r,n){let a=this._extensionsLoadAnimationChannelAsync(e,t,i,r,n);if(a)return a;if(void 0==r.target.node)return Promise.resolve();let o=ta.Get(`${e}/target/node`,this._gltf.nodes,r.target.node),s=r.target.path,l="weights"===s;return(!l||o._numMorphTargets)&&(l||o._babylonTransformNode)&&(this._parent.loadNodeAnimations||l||o._isJoint)?tn.value.then(()=>{let a;switch(s){case"translation":a=(0,e7.tQ)("/nodes/{}/translation")?.interpolation;break;case"rotation":a=(0,e7.tQ)("/nodes/{}/rotation")?.interpolation;break;case"scale":a=(0,e7.tQ)("/nodes/{}/scale")?.interpolation;break;case"weights":a=(0,e7.tQ)("/nodes/{}/weights")?.interpolation;break;default:throw Error(`${e}/target/path: Invalid value (${r.target.path})`)}if(!a)throw Error(`${e}/target/path: Could not find interpolation properties for target path (${r.target.path})`);let l={object:o,info:a};return this._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,l,n)}):Promise.resolve()}_loadAnimationChannelFromTargetInfoAsync(e,t,i,r,n,a){let o=this.parent.targetFps,s=1/o,l=ta.Get(`${e}/sampler`,i.samplers,r.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${r.sampler}`,l).then(e=>{let t=0,l=n.object;for(let c of n.info){let n=c.getStride(l),f=e.input,u=e.output,d=Array(f.length),h=0;switch(e.interpolation){case"STEP":for(let e=0;e<f.length;e++){let t=c.getValue(l,u,h,1);h+=n,d[e]={frame:f[e]*o,value:t,interpolation:1}}break;case"CUBICSPLINE":for(let e=0;e<f.length;e++){let t=c.getValue(l,u,h,s);h+=n;let i=c.getValue(l,u,h,1);h+=n;let r=c.getValue(l,u,h,s);h+=n,d[e]={frame:f[e]*o,inTangent:t,value:i,outTangent:r}}break;case"LINEAR":for(let e=0;e<f.length;e++){let t=c.getValue(l,u,h,1);h+=n,d[e]={frame:f[e]*o,value:t}}}if(h>0){let e=`${i.name||`animation${i.index}`}_channel${r.index}_${t}`;for(let i of c.buildAnimations(l,e,o,d))t++,a(i.babylonAnimatable,i.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;let i=t.interpolation||"LINEAR";switch(i){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}let r=ta.Get(`${e}/input`,this._gltf.accessors,t.input),n=ta.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${r.index}`,r),this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)]).then(([e,t])=>({input:e,interpolation:i,output:t})),t._data}loadBufferAsync(e,t,i,r){let n=this._extensionsLoadBufferAsync(e,t,i,r);if(n)return n;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(t=>{try{return new Uint8Array(t.buffer,t.byteOffset+i,r)}catch(t){throw Error(`${e}: ${t.message}`)}})}loadBufferViewAsync(e,t){let i=this._extensionsLoadBufferViewAsync(e,t);if(i)return i;if(t._data)return t._data;let r=ta.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${r.index}`,r,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,i){if(t._data)return t._data;let r=ts._GetNumComponents(e,t.type),n=r*eS.R.GetTypeByteLength(t.componentType),a=r*t.count;if(void 0==t.bufferView)t._data=Promise.resolve(new i(a));else{let o=ta.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${o.index}`,o).then(s=>{if(5126===t.componentType&&!t.normalized&&(!o.byteStride||o.byteStride===n))return ts._GetTypedArray(e,t.componentType,s,t.byteOffset,a);{let e=new i(a);return eS.R.ForEach(s,t.byteOffset||0,o.byteStride||n,r,t.componentType,e.length,t.normalized||!1,(t,i)=>{e[i]=t}),e}})}if(t.sparse){let a=t.sparse;t._data=t._data.then(o=>{let s=ta.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),l=ta.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${s.index}`,s),this.loadBufferViewAsync(`/bufferViews/${l.index}`,l)]).then(([s,l])=>{let c,f=ts._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,s,a.indices.byteOffset,a.count),u=r*a.count;if(5126!==t.componentType||t.normalized){let o=ts._GetTypedArray(`${e}/sparse/values`,t.componentType,l,a.values.byteOffset,u);c=new i(u),eS.R.ForEach(o,0,n,r,t.componentType,c.length,t.normalized||!1,(e,t)=>{c[t]=e})}else c=ts._GetTypedArray(`${e}/sparse/values`,t.componentType,l,a.values.byteOffset,u);let d=0;for(let e=0;e<f.length;e++){let t=f[e]*r;for(let e=0;e<r;e++)o[t++]=c[d++]}return o})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if("SCALAR"!==t.type)throw Error(`${e}/type: Invalid value ${t.type}`);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){let i=ts._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,i)}else{let i=ta.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(i=>ts._GetTypedArray(e,t.componentType,i,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;let t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(e=>new eS.h(t,e,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,i){if(t._babylonVertexBuffer?.[i])return t._babylonVertexBuffer[i];t._babylonVertexBuffer||(t._babylonVertexBuffer={});let r=this._babylonScene.getEngine();if(t.sparse||void 0==t.bufferView)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(e=>new eS.R(r,e,i,!1));else{let n=ta.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[i]=this._loadVertexBufferViewAsync(n).then(a=>{let o=ts._GetNumComponents(e,t.type);return new eS.R(r,a,i,!1,void 0,n.byteStride,void 0,t.byteOffset,o,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[i]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,i){let r=[],n=this._getOrCreateMaterialAdapter(i);return t&&(t.baseColorFactor?(n.baseColor=ec.v9.FromArray(t.baseColorFactor),n.geometryOpacity=t.baseColorFactor[3]):n.baseColor=ec.v9.White(),n.baseMetalness=void 0==t.metallicFactor?1:t.metallicFactor,n.specularRoughness=void 0==t.roughnessFactor?1:t.roughnessFactor,t.baseColorTexture&&r.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,e=>{e.name=`${i.name} (Base Color)`,n.baseColorTexture=e})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,e=>{e.name=`${i.name} (Metallic Roughness)`,n.baseMetalnessTexture=e,n.specularRoughnessTexture=e})),n.useRoughnessFromMetallicTextureGreen=!0,n.useMetallicFromMetallicTextureBlue=!0)),Promise.all(r).then(()=>{})}_loadMaterialAsync(e,t,i,r,n=()=>{}){let a=this._extensionsLoadMaterialAsync(e,t,i,r,n);if(a)return a;t._data=t._data||{};let o=t._data[r];if(!o){this.logOpen(`${e} ${t.name||""}`);let i=this.createMaterial(e,t,r);o={babylonMaterial:i,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,i)},t._data[r]=o,ts.AddPointerMetadata(i,e),this._parent.onMaterialLoadedObservable.notifyObservers(i),this.logClose()}return i&&(o.babylonMeshes.push(i),i.onDisposeObservable.addOnce(()=>{let e=o.babylonMeshes.indexOf(i);-1!==e&&o.babylonMeshes.splice(e,1)})),n(o.babylonMaterial),o.promise.then(()=>o.babylonMaterial)}_createDefaultMaterial(e,t){if(!this._pbrMaterialImpl)throw Error("PBR Material class not loaded");this._babylonScene._blockEntityCollection=!!this._assetContainer;let i=new this._pbrMaterialImpl.materialClass(e,this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.fillMode=t,i.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE;let r=this._getOrCreateMaterialAdapter(i);return r.transparencyAsAlphaCoverage=this._parent.transparencyAsCoverage,r.baseMetalness=1,r.specularRoughness=1,i}createMaterial(e,t,i){let r=this._extensionsCreateMaterial(e,t,i);if(r)return r;let n=t.name||`material${t.index}`;return this._createDefaultMaterial(n,i)}loadMaterialPropertiesAsync(e,t,i){let r=this._extensionsLoadMaterialPropertiesAsync(e,t,i);if(r)return r;let n=[];return n.push(this.loadMaterialBasePropertiesAsync(e,t,i)),t.pbrMetallicRoughness&&n.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,i)),this.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,i){let r,n,a=[],o=this._getOrCreateMaterialAdapter(i);o.emissionColor=t.emissiveFactor?ec.v9.FromArray(t.emissiveFactor):new ec.v9(0,0,0),t.doubleSided&&(o.backFaceCulling=!1,o.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,a.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,e=>{e.name=`${i.name} (Normal)`,o.geometryNormalTexture=e,t.normalTexture?.scale!=void 0&&(e.level=t.normalTexture.scale)})),o.setNormalMapInversions(!this._babylonScene.useRightHandedSystem,this._babylonScene.useRightHandedSystem));let s=1;return t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,a.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,e=>{e.name=`${i.name} (Occlusion)`,r=e})),void 0!=t.occlusionTexture.strength&&(s=t.occlusionTexture.strength)),t.emissiveTexture&&a.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,e=>{e.name=`${i.name} (Emissive)`,n=e})),Promise.all(a).then(()=>{r&&(o.ambientOcclusionTexture=r,o.ambientOcclusionTextureStrength=s),n&&(o.emissionColorTexture=n)})}loadMaterialAlphaProperties(e,t,i){if(!this._pbrMaterialImpl)throw Error(`${e}: Material type not supported`);let r=this._getOrCreateMaterialAdapter(i),n=r.baseColorTexture;switch(t.alphaMode||"OPAQUE"){case"OPAQUE":i.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE,i.alpha=1;break;case"MASK":i.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHATEST,r.alphaCutOff=void 0==t.alphaCutoff?.5:t.alphaCutoff,n&&(n.hasAlpha=!0);break;case"BLEND":i.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHABLEND,n&&(n.hasAlpha=!0,r.useAlphaFromBaseColorTexture=!0);break;default:throw Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,i=()=>{}){let r=this._extensionsLoadTextureInfoAsync(e,t,i);if(r)return r;if(this.logOpen(`${e}`),t.texCoord>=6)throw Error(`${e}/texCoord: Invalid value (${t.texCoord})`);let n=ta.Get(`${e}/index`,this._gltf.textures,t.index);n._textureInfo=t;let a=this._loadTextureAsync(`/textures/${t.index}`,n,r=>{r.coordinatesIndex=t.texCoord||0,ts.AddPointerMetadata(r,e),this._parent.onTextureLoadedObservable.notifyObservers(r),i(r)});return this.logClose(),a}_loadTextureAsync(e,t,i=()=>{}){let r=this._extensionsLoadTextureAsync(e,t,i);if(r)return r;this.logOpen(`${e} ${t.name||""}`);let n=void 0==t.sampler?ts.DefaultSampler:ta.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),a=ta.Get(`${e}/source`,this._gltf.images,t.source),o=this._createTextureAsync(e,n,a,i,void 0,!t._textureInfo.nonColorData);return this.logClose(),o}_createTextureAsync(e,t,i,r=()=>{},n,a){let o=this._loadSampler(`/samplers/${t.index}`,t),s=[],l=new e0.c;this._babylonScene._blockEntityCollection=!!this._assetContainer;let c={noMipmap:o.noMipMaps,invertY:!1,samplingMode:o.samplingMode,onLoad:()=>{this._disposed||l.resolve()},onError:(t,i)=>{this._disposed||l.reject(Error(`${e}: ${i&&i.message?i.message:t||"Failed to load texture"}`))},mimeType:i.mimeType??(0,ei.ny)(i.uri??""),loaderOptions:n,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},f=new eg.g(null,this._babylonScene,c);return f._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.push(l.promise),s.push(this.loadImageAsync(`/images/${i.index}`,i).then(e=>{let t=i.uri||`${this._fileName}#image${i.index}`,r=`data:${this._uniqueRootUrl}${t}`;f.updateURL(r,e);let n=f.getInternalTexture();n&&(n.label=i.name)})),f.wrapU=o.wrapU,f.wrapV=o.wrapV,r(f),this._parent.useGltfTextureNames&&(f.name=i.name||i.uri||`image${i.index}`),Promise.all(s).then(()=>f)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:ts._GetTextureSamplingMode(e,t),wrapU:ts._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:ts._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{let i=ta.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}this.logClose()}return t._data}loadUriAsync(e,t,i){let r=this._extensionsLoadUriAsync(e,t,i);if(r)return r;if(!ts._ValidateUri(i))throw Error(`${e}: '${i}' is invalid`);if((0,ei.f2)(i)){let t=new Uint8Array((0,ei.rz)(i));return this.log(`${e}: Decoded ${i.substring(0,64)}... (${t.length} bytes)`),Promise.resolve(t)}return this.log(`${e}: Loading ${i}`),this._parent.preprocessUrlAsync(this._rootUrl+i).then(t=>new Promise((r,n)=>{this._parent._loadFile(this._babylonScene,t,t=>{this._disposed||(this.log(`${e}: Loaded ${i} (${t.byteLength} bytes)`),r(new Uint8Array(t)))},!0,t=>{n(new ei.hX(`${e}: Failed to load '${i}'${t?": "+t.status+" "+t.statusText:""}`,t))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};let i=e._internalMetadata=e._internalMetadata||{},r=i.gltf=i.gltf||{};(r.pointers=r.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=void 0==t?10497:t){case 33071:return eg.g.CLAMP_ADDRESSMODE;case 33648:return eg.g.MIRROR_ADDRESSMODE;case 10497:return eg.g.WRAP_ADDRESSMODE;default:return q.V.Warn(`${e}: Invalid value (${t})`),eg.g.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){let i=void 0==t.magFilter?9729:t.magFilter,r=void 0==t.minFilter?9987:t.minFilter;if(9729===i)switch(r){case 9728:return eg.g.LINEAR_NEAREST;case 9729:return eg.g.LINEAR_LINEAR;case 9984:return eg.g.LINEAR_NEAREST_MIPNEAREST;case 9985:return eg.g.LINEAR_LINEAR_MIPNEAREST;case 9986:return eg.g.LINEAR_NEAREST_MIPLINEAR;case 9987:return eg.g.LINEAR_LINEAR_MIPLINEAR;default:return q.V.Warn(`${e}/minFilter: Invalid value (${r})`),eg.g.LINEAR_LINEAR_MIPLINEAR}switch(9728!==i&&q.V.Warn(`${e}/magFilter: Invalid value (${i})`),r){case 9728:return eg.g.NEAREST_NEAREST;case 9729:return eg.g.NEAREST_LINEAR;case 9984:return eg.g.NEAREST_NEAREST_MIPNEAREST;case 9985:return eg.g.NEAREST_LINEAR_MIPNEAREST;case 9986:return eg.g.NEAREST_NEAREST_MIPLINEAR;case 9987:return eg.g.NEAREST_LINEAR_MIPLINEAR;default:return q.V.Warn(`${e}/minFilter: Invalid value (${r})`),eg.g.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return(0,tt.w)(t)}catch(t){throw Error(`${e}: ${t.message}`)}}static _GetTypedArray(e,t,i,r,n){let a=i.buffer;r=i.byteOffset+(r||0);let o=ts._GetTypedArrayConstructor(`${e}/componentType`,t),s=eS.R.GetTypeByteLength(t);return r%s!=0?(q.V.Warn(`${e}: Copying buffer as byte offset (${r}) is not a multiple of component type byte length (${s})`),new o(a.slice(r,r+n*s),0)):new o(a,r,n)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return D.S0.IsBase64(e)||-1===e.indexOf("..")}static _GetDrawMode(e,t){switch(void 0==t&&(t=4),t){case 0:return eh.i.PointListDrawMode;case 1:return eh.i.LineListDrawMode;case 2:return eh.i.LineLoopDrawMode;case 3:return eh.i.LineStripDrawMode;case 4:return eh.i.TriangleFillMode;case 5:return eh.i.TriangleStripDrawMode;case 6:return eh.i.TriangleFanDrawMode}throw Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");let e=[];if(this._gltf.materials){for(let t of this._gltf.materials)if(t._data)for(let i in t._data){let r=t._data[i];for(let t of r.babylonMeshes){t.computeWorldMatrix(!0);let i=r.babylonMaterial;e.push(i.forceCompilationAsync(t)),e.push(i.forceCompilationAsync(t,{useInstances:!0})),this._parent.useClipPlane&&(e.push(i.forceCompilationAsync(t,{clipPlane:!0})),e.push(i.forceCompilationAsync(t,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");let e=[];for(let t of this._babylonScene.lights){let i=t.getShadowGenerator();i&&e.push(i.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(let t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,i){for(let r of this._extensions)if(r.enabled){let n=`${r.name}.${t}`;e._activeLoaderExtensionFunctions=e._activeLoaderExtensionFunctions||{};let a=e._activeLoaderExtensionFunctions;if(!a[n]){a[n]=!0;try{let e=i(r);if(e)return e}finally{delete a[n]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",i=>i.loadSceneAsync&&i.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,i){return this._applyExtensions(t,"loadNode",r=>r.loadNodeAsync&&r.loadNodeAsync(e,t,i))}_extensionsLoadCameraAsync(e,t,i){return this._applyExtensions(t,"loadCamera",r=>r.loadCameraAsync&&r.loadCameraAsync(e,t,i))}_extensionsLoadVertexDataAsync(e,t,i){return this._applyExtensions(t,"loadVertexData",r=>r._loadVertexDataAsync&&r._loadVertexDataAsync(e,t,i))}_extensionsLoadMeshPrimitiveAsync(e,t,i,r,n,a){return this._applyExtensions(n,"loadMeshPrimitive",o=>o._loadMeshPrimitiveAsync&&o._loadMeshPrimitiveAsync(e,t,i,r,n,a))}_extensionsLoadMaterialAsync(e,t,i,r,n){return this._applyExtensions(t,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(e,t,i,r,n))}_extensionsCreateMaterial(e,t,i){return this._applyExtensions(t,"createMaterial",r=>r.createMaterial&&r.createMaterial(e,t,i))}_extensionsLoadMaterialPropertiesAsync(e,t,i){return this._applyExtensions(t,"loadMaterialProperties",r=>r.loadMaterialPropertiesAsync&&r.loadMaterialPropertiesAsync(e,t,i))}_extensionsLoadTextureInfoAsync(e,t,i){return this._applyExtensions(t,"loadTextureInfo",r=>r.loadTextureInfoAsync&&r.loadTextureInfoAsync(e,t,i))}_extensionsLoadTextureAsync(e,t,i){return this._applyExtensions(t,"loadTexture",r=>r._loadTextureAsync&&r._loadTextureAsync(e,t,i))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",i=>i.loadAnimationAsync&&i.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,i,r,n){return this._applyExtensions(i,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(e,t,i,r,n))}_extensionsLoadSkinAsync(e,t,i){return this._applyExtensions(i,"loadSkin",r=>r._loadSkinAsync&&r._loadSkinAsync(e,t,i))}_extensionsLoadUriAsync(e,t,i){return this._applyExtensions(t,"loadUri",r=>r._loadUriAsync&&r._loadUriAsync(e,t,i))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",i=>i.loadBufferViewAsync&&i.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,i,r){return this._applyExtensions(t,"loadBuffer",n=>n.loadBufferAsync&&n.loadBufferAsync(e,t,i,r))}static LoadExtensionAsync(e,t,i,r){if(!t.extensions)return null;let n=t.extensions[i];return n?r(`${e}/extensions/${i}`,n):null}static LoadExtraAsync(e,t,i,r){if(!t.extras)return null;let n=t.extras[i];return n?r(`${e}/extras/${i}`,n):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}ts.DefaultSampler={index:-1},el._CreateGLTF2Loader=e=>new ts(e);var tl=i(13695),tc=i(17165),tf=i(15077),tu=i(60316),td=i(40739);let th="EXT_lights_image_based";class tp{constructor(e){this.name=th,this._loader=e,this.enabled=this._loader.isExtensionUsed(th)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return ts.LoadExtensionAsync(e,t,this.name,async(i,r)=>{this._loader._allMaterialsDirtyRequired=!0;let n=[];n.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);let a=ta.Get(`${i}/light`,this._lights,r.light);return n.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,a).then(e=>{this._loader.babylonScene.environmentTexture=e})),this._loader.logClose(),await Promise.all(n).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){let i=[];this._loader.logOpen(`${e}`);let r=Array(t.specularImages.length);for(let n=0;n<t.specularImages.length;n++){let a=t.specularImages[n];r[n]=Array(a.length);for(let t=0;t<a.length;t++){let o=`${e}/specularImages/${n}/${t}`;this._loader.logOpen(`${o}`);let s=a[t],l=ta.Get(o,this._loader.gltf.images,s);i.push(this._loader.loadImageAsync(`/images/${s}`,l).then(e=>{r[n][t]=e})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(async()=>{let i=new td.p(this._loader.babylonScene,null,t.specularImageSize);if(i.name=t.name||"environment",t._babylonTexture=i,void 0!=t.intensity&&(i.level=t.intensity),t.rotation){let e=N.PT.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(e=N.PT.Inverse(e)),N.uq.FromQuaternionToRef(e,i.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw Error(`${e}: Irradiance coefficients are missing`);let n=tu.O.FromArray(t.irradianceCoefficients);n.scaleInPlace(t.intensity),n.convertIrradianceToLambertianRadiance();let a=tu.Q.FromHarmonics(n),o=(r.length-1)/Math.log2(t.specularImageSize);return await i.updateRGBDAsync(r,a,o)})}return t._loaded.then(()=>t._babylonTexture)}}e9(th),e6(th,!0,e=>new tp(e)),i(82646);let tm="EXT_mesh_gpu_instancing";class t_{constructor(e){this.name=tm,this._loader=e,this.enabled=this._loader.isExtensionUsed(tm)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(e,r)=>{this._loader._disableInstancedMesh++;let n=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return await n;let a=[],o=0,s=t=>{if(void 0==r.attributes[t])return void a.push(Promise.resolve(null));let i=ta.Get(`${e}/attributes/${t}`,this._loader.gltf.accessors,r.attributes[t]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${i.bufferView}`,i)),0===o)o=i.count;else if(o!==i.count)throw Error(`${e}/attributes: Instance buffer accessors do not have the same count.`)};return s("TRANSLATION"),s("ROTATION"),s("SCALE"),s("_COLOR_0"),await n.then(async e=>{let[i,r,n,s]=await Promise.all(a),l=new Float32Array(16*o);N.AA.Vector3["0"].copyFromFloats(0,0,0),N.AA.Quaternion["0"].copyFromFloats(0,0,0,1),N.AA.Vector3["1"].copyFromFloats(1,1,1);for(let e=0;e<o;++e)i&&N.Pq.FromArrayToRef(i,3*e,N.AA.Vector3["0"]),r&&N.PT.FromArrayToRef(r,4*e,N.AA.Quaternion["0"]),n&&N.Pq.FromArrayToRef(n,3*e,N.AA.Vector3["1"]),N.uq.ComposeToRef(N.AA.Vector3["1"],N.AA.Quaternion["0"],N.AA.Vector3["0"],N.AA.Matrix["0"]),N.AA.Matrix["0"].copyToArray(l,16*e);for(let e of t._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",l,16,!0),s&&(s.length===3*o?e.thinInstanceSetBuffer("color",s,3,!0):s.length===4*o?e.thinInstanceSetBuffer("color",s,4,!0):q.V.Warn("Unexpected size of _COLOR_0 attribute for mesh "+e.name));return e})})}}e9(tm),e6(tm,!0,e=>new t_(e));var tg=i(7712);let tv="EXT_meshopt_compression";class tS{constructor(e){this.name=tv,this.enabled=e.isExtensionUsed(tv),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return ts.LoadExtensionAsync(e,t,this.name,async(i,r)=>{if(t._meshOptData)return await t._meshOptData;let n=ta.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return t._meshOptData=this._loader.loadBufferAsync(`/buffers/${n.index}`,n,r.byteOffset||0,r.byteLength).then(async e=>await tg.v.Default.decodeGltfBufferAsync(e,r.count,r.byteStride,r.mode,r.filter)),await t._meshOptData})}}e9(tv),e6(tv,!0,e=>new tS(e));let tE="EXT_texture_webp";class tT{constructor(e){this.name=tE,this._loader=e,this.enabled=e.isExtensionUsed(tE)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=void 0==t.sampler?ts.DefaultSampler:ta.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=ta.Get(`${r}/source`,this._loader.gltf.images,n.source);return await this._loader._createTextureAsync(e,a,o,e=>{i(e)},void 0,!t._textureInfo.nonColorData)})}}e9(tE),e6(tE,!0,e=>new tT(e));let tA="EXT_texture_avif";class tx{constructor(e){this.name=tA,this._loader=e,this.enabled=e.isExtensionUsed(tA)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=void 0==t.sampler?ts.DefaultSampler:ta.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=ta.Get(`${r}/source`,this._loader.gltf.images,n.source);return await this._loader._createTextureAsync(e,a,o,e=>{i(e)},void 0,!t._textureInfo.nonColorData)})}}e9(tA),e6(tA,!0,e=>new tx(e));var tI=i(86983);let tR="EXT_lights_ies";class tC{constructor(e){this.name=tR,this._loader=e,this.enabled=this._loader.isExtensionUsed(tR)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,ta.Assign(this._lights)}}loadNodeAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a,o,s;this._loader._allMaterialsDirtyRequired=!0;let l=await this._loader.loadNodeAsync(e,t,e=>{let t=(o=ta.Get(r,this._lights,n.light)).name||e.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,(a=new eb.n(t,N.Pq.Zero(),N.Pq.Backward(),0,1,this._loader.babylonScene)).angle=Math.PI/2,a.innerAngle=0,a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,o._babylonLight=a,a.falloffType=tI.v.FALLOFF_GLTF,a.diffuse=n.color?ec.v9.FromArray(n.color):ec.v9.White(),a.intensity=n.multiplier||1,a.range=Number.MAX_VALUE,a.parent=e,this._loader._babylonLights.push(a),ts.AddPointerMetadata(a,r),i(e)});if(o.uri)s=await this._loader.loadUriAsync(e,o,o.uri);else{let t=ta.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,o.bufferView);s=await this._loader.loadBufferViewAsync(`/bufferViews/${t.index}`,t)}return a.iesProfileTexture=new eg.g(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,s,!0,void 0,void 0,void 0,void 0,".ies"),l})}}e9(tR),e6(tR,!0,e=>new tC(e));var tb=i(32437);let ty="KHR_draco_mesh_compression";class tL{constructor(e){this.name=ty,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=tb.Y.DefaultAvailable&&this._loader.isExtensionUsed(ty)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{if(void 0!=t.mode&&4!==t.mode&&5!==t.mode)throw Error(`${e}: Unsupported mode ${t.mode}`);let a={},o={},s=(e,r)=>{let s=n.attributes[e];if(void 0!=s&&(i._delayInfo=i._delayInfo||[],-1===i._delayInfo.indexOf(r)&&i._delayInfo.push(r),a[r]=s,this.useNormalizedFlagFromAccessor)){let i=ta.TryGet(this._loader.gltf.accessors,t.attributes[e]);i&&(o[r]=i.normalized||!1)}};s("POSITION",eS.R.PositionKind),s("NORMAL",eS.R.NormalKind),s("TANGENT",eS.R.TangentKind),s("TEXCOORD_0",eS.R.UVKind),s("TEXCOORD_1",eS.R.UV2Kind),s("TEXCOORD_2",eS.R.UV3Kind),s("TEXCOORD_3",eS.R.UV4Kind),s("TEXCOORD_4",eS.R.UV5Kind),s("TEXCOORD_5",eS.R.UV6Kind),s("JOINTS_0",eS.R.MatricesIndicesKind),s("WEIGHTS_0",eS.R.MatricesWeightsKind),s("COLOR_0",eS.R.ColorKind);let l=ta.Get(r,this._loader.gltf.bufferViews,n.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then(async r=>{let n=this.dracoDecoder||tb.Y.Default,s=ta.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),l=this._loader.parent.alwaysComputeBoundingBox||i.skeleton||!s?null:to(s);return await n._decodeMeshToGeometryForGltfAsync(i.name,this._loader.babylonScene,r,a,o,l).catch(t=>{throw Error(`${e}: ${t.message}`)})})),await l._dracoBabylonGeometry})}}e9(ty),e6(ty,!0,e=>new tL(e));let tM="KHR_lights_punctual";class tP{constructor(e){this.name=tM,this._loader=e,this.enabled=this._loader.isExtensionUsed(tM)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,ta.Assign(this._lights)}}loadNodeAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,e=>{let t,a=ta.Get(r,this._lights,n.light),o=a.name||e.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a.type){case"directional":{let e=new eR.Z(o,N.Pq.Backward(),this._loader.babylonScene);e.position.setAll(0),t=e;break}case"point":t=new eC.H(o,N.Pq.Zero(),this._loader.babylonScene);break;case"spot":{let e=new eb.n(o,N.Pq.Zero(),N.Pq.Backward(),0,1,this._loader.babylonScene);e.angle=2*(a.spot&&a.spot.outerConeAngle||Math.PI/4),e.innerAngle=2*(a.spot&&a.spot.innerConeAngle||0),t=e;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,Error(`${r}: Invalid light type (${a.type})`)}t._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,a._babylonLight=t,t.falloffType=tI.v.FALLOFF_GLTF,t.diffuse=a.color?ec.v9.FromArray(a.color):ec.v9.White(),t.intensity=void 0==a.intensity?1:a.intensity,t.range=void 0==a.range?Number.MAX_VALUE:a.range,t.parent=e,this._loader._babylonLights.push(t),ts.AddPointerMetadata(t,r),i(e)})))}}e9(tM),e6(tM,!0,e=>new tP(e));var tN=i(44242);let tD="EXT_lights_area";class tO{constructor(e){this.name=tD,this._loader=e,this.enabled=this._loader.isExtensionUsed(tD)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,ta.Assign(this._lights)}}loadNodeAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,e=>{let t,a=ta.Get(r,this._lights,n.light),o=a.name||e.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer;let s=void 0!==a.size?a.size:1;switch(a.type){case"rect":{let e=a.rect?.aspect!==void 0?a.rect.aspect*s:s;t=new tN.u(o,N.Pq.Zero(),e,s,this._loader.babylonScene);break}case"disk":{let e=Math.sqrt(s*s*.25*Math.PI);t=new tN.u(o,N.Pq.Zero(),e,e,this._loader.babylonScene);break}default:throw this._loader.babylonScene._blockEntityCollection=!1,Error(`${r}: Invalid area light type (${a.type})`)}t._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,a._babylonLight=t,t.falloffType=tI.v.FALLOFF_GLTF,t.diffuse=a.color?ec.v9.FromArray(a.color):ec.v9.White(),t.intensity=void 0==a.intensity?1:a.intensity;let l=new e1.V(`${o}_orientation`,this._loader.babylonScene);l.rotationQuaternion=N.PT.RotationAxis(N.Pq.Up(),Math.PI),l.parent=e,t.parent=l,this._loader._babylonLights.push(t),ts.AddPointerMetadata(t,r),i(e)})))}}e9(tD),e6(tD,!0,e=>new tO(e));var tF=i(27550);let tw="KHR_materials_pbrSpecularGlossiness";class tB{constructor(e){this.name=tw,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(tw)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),a.push(this._loadSpecularGlossinessPropertiesAsync(r,n,i)),this._loader.loadMaterialAlphaProperties(e,t,i),await Promise.all(a).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i){if(!(i instanceof tF.PBRMaterial))throw Error(`${e}: Material type not supported`);let r=[];return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=ec.v9.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=ec.v9.White(),i.reflectivityColor=t.specularFactor?ec.v9.FromArray(t.specularFactor):ec.v9.White(),i.microSurface=void 0==t.glossinessFactor?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,e=>{e.name=`${i.name} (Diffuse)`,i.albedoTexture=e})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,e=>{e.name=`${i.name} (Specular Glossiness)`,i.reflectivityTexture=e,i.reflectivityTexture.hasAlpha=!0})),i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}}e9(tw),e6(tw,!0,e=>new tB(e));let tU="KHR_materials_unlit";class tG{constructor(e){this.name=tU,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(tU)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async()=>await this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[],a=t.pbrMetallicRoughness;return a&&(a.baseColorFactor&&(r.baseColor=ec.v9.FromArray(a.baseColorFactor),r.geometryOpacity=a.baseColorFactor[3]),a.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,a.baseColorTexture,e=>{e.name=`${i.name} (Base Color)`,r.baseColorTexture=e}))),r.isUnlit=!0,t.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then(()=>{})}}e9(tU),e6(tU,!0,e=>new tG(e));let tV="KHR_materials_clearcoat";class tk{constructor(e){this.name=tV,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(tV)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadClearCoatPropertiesAsync(r,n,i)),await Promise.all(a)})}_loadClearCoatPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];return r.configureCoat(),r.coatWeight=void 0!==t.clearcoatFactor?t.clearcoatFactor:0,r.coatRoughness=void 0!==t.clearcoatRoughnessFactor?t.clearcoatRoughnessFactor:0,t.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,e=>{e.name=`${i.name} (ClearCoat)`,r.coatWeightTexture=e})),t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,e=>{e.name=`${i.name} (ClearCoat Roughness)`,r.coatRoughnessTexture=e}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,e=>{e.name=`${i.name} (ClearCoat Normal)`,r.geometryCoatNormalTexture=e,t.clearcoatNormalTexture?.scale!=void 0&&(r.geometryCoatNormalTextureScale=t.clearcoatNormalTexture.scale)})),r.setNormalMapInversions(!i.getScene().useRightHandedSystem,i.getScene().useRightHandedSystem)),Promise.all(n).then(()=>{})}}e9(tV),e6(tV,!0,e=>new tk(e));let tz="KHR_materials_coat";class tH{constructor(e){this.name=tz,this.order=191,this.useOpenPBR=!1,this._loader=e,this.enabled=this._loader.isExtensionUsed(tz)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),t.extensions&&t.extensions.KHR_materials_openpbr&&(this.useOpenPBR=!0),a.push(this._loadCoatPropertiesAsync(r,n,i)),await Promise.all(a)})}_loadCoatPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];r.configureCoat(),r.coatWeight=void 0!==t.coatFactor?t.coatFactor:0,r.coatRoughness=void 0!==t.coatRoughnessFactor?t.coatRoughnessFactor:0,t.coatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/coatTexture`,t.coatTexture,e=>{e.name=`${i.name} (Coat)`,r.coatWeightTexture=e})),t.coatRoughnessTexture&&(t.coatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/coatRoughnessTexture`,t.coatRoughnessTexture,e=>{e.name=`${i.name} (Coat Roughness)`,r.coatRoughnessTexture=e}))),t.coatNormalTexture&&(t.coatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/coatNormalTexture`,t.coatNormalTexture,e=>{e.name=`${i.name} (Coat Normal)`,r.geometryCoatNormalTexture=e,t.coatNormalTexture?.scale!=void 0&&(r.geometryCoatNormalTextureScale=t.coatNormalTexture.scale)})),r.setNormalMapInversions(!i.getScene().useRightHandedSystem,i.getScene().useRightHandedSystem)),r.coatDarkening=void 0!==t.coatDarkeningFactor?t.coatDarkeningFactor:1,r.coatIor=void 0!==t.coatIor?t.coatIor:1.5;let a=ec.v9.White();void 0!==t.coatColorFactor&&a.fromArray(t.coatColorFactor),r.coatColor=a,t.coatColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/coatColorTexture`,t.coatColorTexture,e=>{e.name=`${i.name} (Coat Color)`,r.coatColorTexture=e}));let o=t.coatAnisotropyStrength??0,s=t.coatAnisotropyRotation??0;return r.coatRoughnessAnisotropy=o,r.geometryCoatTangentAngle=s,this.useOpenPBR||r.configureGltfStyleAnisotropy(!0),t.coatAnisotropyTexture&&(t.coatAnisotropyTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/coatAnisotropyTexture`,t.coatAnisotropyTexture,e=>{e.name=`${i.name} (Coat Anisotropy)`,r.geometryCoatTangentTexture=e}))),Promise.all(n).then(()=>{})}}e9(tz),e6(tz,!0,e=>new tH(e));let tW="KHR_materials_iridescence";class tX{constructor(e){this.name=tW,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(tW)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIridescencePropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];return r.thinFilmWeight=t.iridescenceFactor??0,r.thinFilmIor=t.iridescenceIor??t.iridescenceIOR??1.3,r.thinFilmThicknessMinimum=t.iridescenceThicknessMinimum??100,r.thinFilmThicknessMaximum=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,e=>{e.name=`${i.name} (Iridescence)`,r.thinFilmWeightTexture=e})),t.iridescenceThicknessTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,e=>{e.name=`${i.name} (Iridescence Thickness)`,r.thinFilmThicknessTexture=e})),Promise.all(n).then(()=>{})}}e9(tW),e6(tW,!0,e=>new tX(e));let tY="KHR_materials_anisotropy";class t${constructor(e){this.name=tY,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(tY)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadAnisotropyPropertiesAsync(r,n,i)),await Promise.all(a)})}async _loadAnisotropyPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[],a=t.anisotropyStrength??0,o=t.anisotropyRotation??0;r.specularRoughnessAnisotropy=a,r.geometryTangentAngle=o;let s=t.extensions??{};s.EXT_materials_anisotropy_openpbr&&s.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled||r.configureGltfStyleAnisotropy(!0),t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,e=>{e.name=`${i.name} (Anisotropy Intensity)`,r.geometryTangentTexture=e}))),await Promise.all(n)}}e9(tY),e6(tY,!0,e=>new t$(e));let tq="KHR_materials_emissive_strength";class tZ{constructor(e){this.name=tq,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(tq)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>(await this._loader.loadMaterialPropertiesAsync(e,t,i),this._loadEmissiveProperties(r,n,i),await Promise.resolve()))}_loadEmissiveProperties(e,t,i){void 0!==t.emissiveStrength&&(this._loader._getOrCreateMaterialAdapter(i).emissionLuminance=t.emissiveStrength)}}e9(tq),e6(tq,!0,e=>new tZ(e));let tj="KHR_materials_sheen";class tK{constructor(e){this.name=tj,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(tj)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadSheenPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];r.configureFuzz();let a=void 0!==t.sheenColorFactor?ec.v9.FromArray(t.sheenColorFactor):ec.v9.Black(),o=void 0!==t.sheenRoughnessFactor?t.sheenRoughnessFactor:0;return r.fuzzWeight=1,r.fuzzColor=a,r.fuzzRoughness=o,t.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,e=>{e.name=`${i.name} (Sheen Color)`,r.fuzzColorTexture=e})),t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,e=>{e.name=`${i.name} (Sheen Roughness)`,r.fuzzRoughnessTexture=e}))),Promise.all(n).then(()=>{})}}e9(tj),e6(tj,!0,e=>new tK(e));let tQ="KHR_materials_fuzz";class tJ{constructor(e){this.name=tQ,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(tQ)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadFuzzPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadFuzzPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];return r.configureFuzz(),r.fuzzWeight=void 0!==t.fuzzFactor?t.fuzzFactor:0,r.fuzzColor=void 0!==t.fuzzColorFactor?ec.v9.FromArray(t.fuzzColorFactor):ec.v9.White(),r.fuzzRoughness=void 0!==t.fuzzRoughnessFactor?t.fuzzRoughnessFactor:.5,t.fuzzTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/fuzzTexture`,t.fuzzTexture,e=>{e.name=`${i.name} (Fuzz)`,r.fuzzWeightTexture=e})),t.fuzzColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/fuzzColorTexture`,t.fuzzColorTexture,e=>{e.name=`${i.name} (Fuzz Color)`,r.fuzzColorTexture=e})),t.fuzzRoughnessTexture&&(t.fuzzRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/fuzzRoughnessTexture`,t.fuzzRoughnessTexture,e=>{e.name=`${i.name} (Fuzz Roughness)`,r.fuzzRoughnessTexture=e}))),Promise.all(n).then(()=>{})}}e9(tQ),e6(tQ,!0,e=>new tJ(e));let t0="KHR_materials_specular";class t1{constructor(e){this.name=t0,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(t0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadSpecularPropertiesAsync(r,n,i));let o=this._loader._getOrCreateMaterialAdapter(i);return n.extensions&&n.extensions.EXT_materials_specular_edge_color&&n.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&o.enableSpecularEdgeColor(!0),await Promise.all(a).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];return r.specularWeight=t.specularFactor??1,r.specularColor=void 0!==t.specularColorFactor?ec.v9.FromArray(t.specularColorFactor):new ec.v9(1,1,1),t.specularTexture&&(t.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,e=>{e.name=`${i.name} (Specular)`,r.specularWeightTexture=e}))),t.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,e=>{e.name=`${i.name} (Specular Color)`,r.specularColorTexture=e})),Promise.all(n).then(()=>{})}}e9(t0),e6(t0,!0,e=>new t1(e));let t2="KHR_materials_ior";class t3{constructor(e){this.name=t2,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(t2)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIorPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(e,t,i){return this._loader._getOrCreateMaterialAdapter(i).specularIor=void 0!==t.ior?t.ior:t3._DEFAULT_IOR,Promise.resolve()}}t3._DEFAULT_IOR=1.5,e9(t2),e6(t2,!0,e=>new t3(e));let t4="KHR_materials_variants";class t5{constructor(e){this.name=t4,this._loader=e,this.enabled=this._loader.isExtensionUsed(t4)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(e){let t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return t5.GetAvailableVariants(e)}static SelectVariant(e,t){let i=this._GetExtensionMetadata(e);if(!i)throw Error(`Cannot select variant on a glTF mesh that does not have the ${t4} extension`);let r=e=>{let t=i.variants[e];if(t)for(let e of t)e.mesh.material=e.material};if(t instanceof Array)for(let e of t)r(e);else r(t);i.lastSelected=t}selectVariant(e,t){t5.SelectVariant(e,t)}static Reset(e){let t=this._GetExtensionMetadata(e);if(!t)throw Error(`Cannot reset on a glTF mesh that does not have the ${t4} extension`);for(let e of t.original)e.mesh.material=e.material;t.lastSelected=null}reset(e){t5.Reset(e)}static GetLastSelectedVariant(e){let t=this._GetExtensionMetadata(e);if(!t)throw Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${t4} extension`);return t.lastSelected}getLastSelectedVariant(e){return t5.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){return e?._internalMetadata?.gltf?.[t4]||null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._variants=t.variants}}onReady(){let e=this._loader.rootBabylonMesh;if(e){let t=this._loader.parent.extensionOptions[t4];t?.defaultVariant&&t5.SelectVariant(e,t.defaultVariant),t?.onLoaded?.({get variants(){return t5.GetAvailableVariants(e)},get selectedVariant(){let t=t5.GetLastSelectedVariant(e);if(!t)return t5.GetAvailableVariants(e)[0];if(Array.isArray(t))return t[0];return t},set selectedVariant(variantName){t5.SelectVariant(e,variantName)}})}}_loadMeshPrimitiveAsync(e,t,i,r,n,a){return ts.LoadExtensionAsync(e,n,this.name,async(o,s)=>{let l=[];return l.push(this._loader._loadMeshPrimitiveAsync(e,t,i,r,n,t=>{if(a(t),t instanceof ex.e){let i=ts._GetDrawMode(e,n.mode),r=this._loader.rootBabylonMesh,a=r?r._internalMetadata=r._internalMetadata||{}:{},c=a.gltf=a.gltf||{},f=c[t4]=c[t4]||{lastSelected:null,original:[],variants:{}};f.original.push({mesh:t,material:t.material});for(let e=0;e<s.mappings.length;++e){let n=s.mappings[e],a=ta.Get(`${o}/mappings/${e}/material`,this._loader.gltf.materials,n.material);l.push(this._loader._loadMaterialAsync(`#/materials/${n.material}`,a,t,i,e=>{for(let i=0;i<n.variants.length;++i){let a=n.variants[i],o=ta.Get(`/extensions/${t4}/variants/${a}`,this._variants,a);f.variants[o.name]=f.variants[o.name]||[],f.variants[o.name].push({mesh:t,material:e}),t.onClonedObservable.add(e=>{let i=null,n=e;do{if(!(n=n.parent))return;i=t5._GetExtensionMetadata(n)}while(null===i);if(r&&i===t5._GetExtensionMetadata(r)){for(let e in n._internalMetadata={},r._internalMetadata)n._internalMetadata[e]=r._internalMetadata[e];for(let e in n._internalMetadata.gltf=[],r._internalMetadata.gltf)n._internalMetadata.gltf[e]=r._internalMetadata.gltf[e];for(let e of(n._internalMetadata.gltf[t4]={lastSelected:null,original:[],variants:{}},i.original))n._internalMetadata.gltf[t4].original.push({mesh:e.mesh,material:e.material});for(let e in i.variants)if(Object.prototype.hasOwnProperty.call(i.variants,e))for(let t of(n._internalMetadata.gltf[t4].variants[e]=[],i.variants[e]))n._internalMetadata.gltf[t4].variants[e].push({mesh:t.mesh,material:t.material});i=n._internalMetadata.gltf[t4]}for(let r of i.original)r.mesh===t&&(r.mesh=e);for(let r of i.variants[o.name])r.mesh===t&&(r.mesh=e)})}}))}}})),await Promise.all(l).then(([e])=>e)})}}e9(t4),e6(t4,!0,e=>new t5(e));var t8=i(40933);class t6{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:eL.Y.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...t6._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new $.cP,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(t=>this._options[t]!==e[t]).length)return;let t={...this._options,...e},i=this._options;this._options=t,t.renderSize===i.renderSize&&t.renderTargetTextureType===i.renderTargetTextureType&&t.generateMipmaps===i.generateMipmaps&&this._opaqueRenderTarget?(this._opaqueRenderTarget.samples=t.samples,this._opaqueRenderTarget.lodGenerationScale=t.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=t.lodGenerationOffset):this._setupRenderTargets()}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e?.subSurface?.isRefractionEnabled}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),D.S0.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,-1===this._transparentMeshesCache.indexOf(e)&&this._transparentMeshesCache.push(e)):-1===this._opaqueMeshesCache.indexOf(e)&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);-1!==t&&this._transparentMeshesCache.splice(t,1),-1!==(t=this._opaqueMeshesCache.indexOf(e))&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){let t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);if(this._shouldRenderAsTransmission(e.material)){if(e.material){let t=e.material.subSurface;t&&(t.refractionTexture=this._opaqueRenderTarget)}-1!==i?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):-1===t&&this._transparentMeshesCache.push(e)}else -1!==t?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):-1===i&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){return this._opaqueRenderTarget?.getInternalTexture()!==null}_setupRenderTargets(){let e;for(let t of(this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new t8.$("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0,this._opaqueRenderTarget.onBeforeBindObservable.add(t=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?t.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(t.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e}),this._transparentMeshesCache))this._shouldRenderAsTransmission(t.material)&&(t.material.refractionTexture=this._opaqueRenderTarget)}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}let t9="KHR_materials_transmission";class t7{constructor(e){this.name=t9,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(t9),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadTransparentPropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,r){let n=this._loader._getOrCreateMaterialAdapter(i),a=void 0!==r.transmissionFactor?r.transmissionFactor:0;if(0===a)return Promise.resolve();if(n.configureTransmission(),n.transmissionWeight=a,a>0){let e=i.getScene();e._transmissionHelper?e._transmissionHelper?._isRenderTargetValid()||e._transmissionHelper?._setupRenderTargets():new t6({},i.getScene())}let o=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=!0,o=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,e=>{e.name=`${i.name} (Transmission)`,n.transmissionWeightTexture=e})),o.then(()=>{})}}e9(t9),e6(t9,!0,e=>new t7(e));let ie="KHR_materials_diffuse_transmission";class it{constructor(e){this.name=ie,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(ie),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadTranslucentPropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,r){let n=this._loader._getOrCreateMaterialAdapter(i);n.configureSubsurface(),n.subsurfaceWeight=r.diffuseTransmissionFactor??0,n.subsurfaceColor=void 0!==r.diffuseTransmissionColorFactor?ec.v9.FromArray(r.diffuseTransmissionColorFactor):ec.v9.White();let a=[];return r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(e=>{e.name=`${i.name} (Diffuse Transmission)`,n.subsurfaceWeightTexture=e}))),r.diffuseTransmissionColorTexture&&a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(e=>{e.name=`${i.name} (Diffuse Transmission Color)`,n.subsurfaceColorTexture=e})),Promise.all(a).then(()=>{})}}e9(ie),e6(ie,!0,e=>new it(e));let ii="KHR_materials_volume";class ir{constructor(e){this.name=ii,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(ii),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadVolumePropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,r){let n=this._loader._getOrCreateMaterialAdapter(i);if(0===n.transmissionWeight&&0===n.subsurfaceWeight||!r.thicknessFactor)return Promise.resolve();n.transmissionDepth=void 0!==r.attenuationDistance?r.attenuationDistance:Number.MAX_VALUE,n.transmissionColor=void 0!==r.attenuationColor&&3==r.attenuationColor.length?ec.v9.FromArray(r.attenuationColor):ec.v9.White(),n.volumeThickness=r.thicknessFactor??0;let a=[];return r.thicknessTexture&&(r.thicknessTexture.nonColorData=!0,a.push(this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture,e=>{e.name=`${i.name} (Thickness)`,n.volumeThicknessTexture=e}))),Promise.all(a).then(()=>{})}}e9(ii),e6(ii,!0,e=>new ir(e));let ia="KHR_materials_dispersion";class io{constructor(e){this.name=ia,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(ia)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadDispersionPropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,i,r){let n=this._loader._getOrCreateMaterialAdapter(i);return n.transmissionWeight>0||!r.dispersion||(n.transmissionDispersionAbbeNumber=20/r.dispersion),Promise.resolve()}}e9(ia),e6(ia,!0,e=>new io(e));let is="KHR_materials_diffuse_roughness";class il{constructor(e){this.name=is,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(is)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=[];return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadDiffuseRoughnessPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadDiffuseRoughnessPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),n=[];return r.baseDiffuseRoughness=t.diffuseRoughnessFactor??0,t.diffuseRoughnessTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,t.diffuseRoughnessTexture,e=>{e.name=`${i.name} (Diffuse Roughness)`,r.baseDiffuseRoughnessTexture=e})),Promise.all(n).then(()=>{})}}e9(is),e6(is,!0,e=>new il(e));let ic="KHR_mesh_quantization";class iu{constructor(e){this.name=ic,this.enabled=e.isExtensionUsed(ic)}dispose(){}}e9(ic),e6(ic,!0,e=>new iu(e));let id="KHR_texture_basisu";class ih{constructor(e){this.name=id,this._loader=e,this.enabled=e.isExtensionUsed(id)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=void 0==t.sampler?ts.DefaultSampler:ta.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=ta.Get(`${r}/source`,this._loader.gltf.images,n.source);return await this._loader._createTextureAsync(e,a,o,e=>{i(e)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}e9(id),e6(id,!0,e=>new ih(e));let ip="KHR_texture_transform";class im{constructor(e){this.name=ip,this._loader=e,this.enabled=this._loader.isExtensionUsed(ip)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(r,n)=>await this._loader.loadTextureInfoAsync(e,t,e=>{if(!(e instanceof eg.g))throw Error(`${r}: Texture type not supported`);n.offset&&(e.uOffset=n.offset[0],e.vOffset=n.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,n.rotation&&(e.wAng=-n.rotation),n.scale&&(e.uScale=n.scale[0],e.vScale=n.scale[1]),void 0!=n.texCoord&&(e.coordinatesIndex=n.texCoord),i(e)}))}}e9(ip),e6(ip,!0,e=>new im(e));let i_="KHR_xmp_json_ld";class ig{constructor(e){this.name=i_,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(i_)}dispose(){this._loader=null}onLoading(){if(null===this._loader.rootBabylonMesh)return;let e=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(e&&t){let i=+t.packet;e.packets&&i<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[i])}}}function iv(e,t,i,r){return ec.v9.FromArray(t,i).scale(r)}function iS(e,t,i,r){return t[i]*r}function iE(e,t,i,r){return-t[i]*r}function iT(e,t,i,r){return t[i+1]*r}function iA(e,t,i,r){return t[i]*r*2}function ix(e){return{scale:[new iR(L.X5.ANIMATIONTYPE_FLOAT,`${e}.uScale`,iS,()=>2),new iR(L.X5.ANIMATIONTYPE_FLOAT,`${e}.vScale`,iT,()=>2)],offset:[new iR(L.X5.ANIMATIONTYPE_FLOAT,`${e}.uOffset`,iS,()=>2),new iR(L.X5.ANIMATIONTYPE_FLOAT,`${e}.vOffset`,iT,()=>2)],rotation:[new iR(L.X5.ANIMATIONTYPE_FLOAT,`${e}.wAng`,iE,()=>1)]}}e9(i_),e6(i_,!0,e=>new ig(e));class iI extends tl.AnimationPropertyInfo{buildAnimations(e,t,i,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,i,r)}]}}class iR extends tl.AnimationPropertyInfo{buildAnimations(e,t,i,r){let n=[];for(let a in e._data)n.push({babylonAnimatable:e._data[a].babylonMaterial,babylonAnimation:this._buildAnimation(t,i,r)});return n}}class iC extends tl.AnimationPropertyInfo{buildAnimations(e,t,i,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,i,r)}]}}class ib extends tl.AnimationPropertyInfo{buildAnimations(e,t,i,r){return e._primitiveBabylonMeshes?e._primitiveBabylonMeshes.map(e=>({babylonAnimatable:e,babylonAnimation:this._buildAnimation(t,i,r)})):[]}}(0,e7.ZU)("/cameras/{}/orthographic/xmag",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"orthoLeft",iE,()=>1),new iI(L.X5.ANIMATIONTYPE_FLOAT,"orthoRight",iT,()=>1)]),(0,e7.ZU)("/cameras/{}/orthographic/ymag",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"orthoBottom",iE,()=>1),new iI(L.X5.ANIMATIONTYPE_FLOAT,"orthoTop",iT,()=>1)]),(0,e7.ZU)("/cameras/{}/orthographic/zfar",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"maxZ",iS,()=>1)]),(0,e7.ZU)("/cameras/{}/orthographic/znear",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"minZ",iS,()=>1)]),(0,e7.ZU)("/cameras/{}/perspective/yfov",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"fov",iS,()=>1)]),(0,e7.ZU)("/cameras/{}/perspective/zfar",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"maxZ",iS,()=>1)]),(0,e7.ZU)("/cameras/{}/perspective/znear",[new iI(L.X5.ANIMATIONTYPE_FLOAT,"minZ",iS,()=>1)]),(0,e7.ZU)("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new iR(L.X5.ANIMATIONTYPE_COLOR3,"albedoColor",iv,()=>4),new iR(L.X5.ANIMATIONTYPE_FLOAT,"alpha",function(e,t,i,r){return t[i+3]*r},()=>4)]),(0,e7.ZU)("/materials/{}/pbrMetallicRoughness/metallicFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"metallic",iS,()=>1)]),(0,e7.ZU)("/materials/{}/pbrMetallicRoughness/metallicFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"roughness",iS,()=>1)]);let iy=ix("albedoTexture");(0,e7.ZU)("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",iy.scale),(0,e7.ZU)("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",iy.offset),(0,e7.ZU)("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",iy.rotation);let iL=ix("metallicTexture");(0,e7.ZU)("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",iL.scale),(0,e7.ZU)("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",iL.offset),(0,e7.ZU)("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",iL.rotation),(0,e7.ZU)("/materials/{}/emissiveFactor",[new iR(L.X5.ANIMATIONTYPE_COLOR3,"emissiveColor",iv,()=>3)]);let iM=ix("bumpTexture");(0,e7.ZU)("/materials/{}/normalTexture/scale",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"bumpTexture.level",iS,()=>1)]),(0,e7.ZU)("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",iM.scale),(0,e7.ZU)("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",iM.offset),(0,e7.ZU)("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",iM.rotation),(0,e7.ZU)("/materials/{}/occlusionTexture/strength",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",iS,()=>1)]);let iP=ix("ambientTexture");(0,e7.ZU)("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",iP.scale),(0,e7.ZU)("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",iP.offset),(0,e7.ZU)("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",iP.rotation);let iN=ix("emissiveTexture");(0,e7.ZU)("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",iN.scale),(0,e7.ZU)("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",iN.offset),(0,e7.ZU)("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",iN.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"anisotropy.angle",iS,()=>1)]);let iD=ix("anisotropy.texture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",iD.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",iD.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",iD.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",iS,()=>1)]);let iO=ix("clearCoat.texture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",iO.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",iO.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",iO.rotation);let iF=ix("clearCoat.bumpTexture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",iF.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",iF.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",iF.rotation);let iw=ix("clearCoat.textureRoughness");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",iw.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",iw.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",iw.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"emissiveIntensity",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_ior/ior",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"indexOfRefraction",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"iridescence.intensity",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",iS,()=>1)]);let iB=ix("iridescence.texture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",iB.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",iB.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",iB.rotation);let iU=ix("iridescence.thicknessTexture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",iU.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",iU.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",iU.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new iR(L.X5.ANIMATIONTYPE_COLOR3,"sheen.color",iv,()=>3)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"sheen.roughness",iS,()=>1)]);let iG=ix("sheen.texture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",iG.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",iG.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",iG.rotation);let iV=ix("sheen.textureRoughness");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",iV.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",iV.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",iV.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"metallicF0Factor",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new iR(L.X5.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",iv,()=>3)]);let ik=ix("metallicReflectanceTexture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",ik.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",ik.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",ik.rotation);let iz=ix("reflectanceTexture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",iz.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",iz.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",iz.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",iS,()=>1)]);let iH=ix("subSurface.refractionIntensityTexture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",iH.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",iH.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",iH.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new iR(L.X5.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",iv,()=>3)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",iS,()=>1)]),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",iS,()=>1)]);let iW=ix("subSurface.thicknessTexture");(0,e7.ZU)("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",iW.scale),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",iW.offset),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",iW.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new iR(L.X5.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",iS,()=>1)]);let iX=ix("subSurface.translucencyIntensityTexture");(0,e7.ZU)("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",iX.scale),(0,e7.ZU)("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",iX.offset),(0,e7.ZU)("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",iX.rotation),(0,e7.ZU)("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new iR(L.X5.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",iv,()=>3)]);let iY=ix("subSurface.translucencyColorTexture");(0,e7.ZU)("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",iY.scale),(0,e7.ZU)("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",iY.offset),(0,e7.ZU)("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",iY.rotation),(0,e7.ZU)("/extensions/KHR_lights_punctual/lights/{}/color",[new iC(L.X5.ANIMATIONTYPE_COLOR3,"diffuse",iv,()=>3)]),(0,e7.ZU)("/extensions/KHR_lights_punctual/lights/{}/intensity",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"intensity",iS,()=>1)]),(0,e7.ZU)("/extensions/KHR_lights_punctual/lights/{}/range",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"range",iS,()=>1)]),(0,e7.ZU)("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"innerAngle",iA,()=>1)]),(0,e7.ZU)("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"angle",iA,()=>1)]),(0,e7.ZU)("/extensions/EXT_lights_area/lights/{}/color",[new iC(L.X5.ANIMATIONTYPE_COLOR3,"diffuse",iv,()=>3)]),(0,e7.ZU)("/extensions/EXT_lights_area/lights/{}/intensity",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"intensity",iS,()=>1)]),(0,e7.ZU)("/extensions/EXT_lights_area/lights/{}/size",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"radius",iS,()=>1)]),(0,e7.ZU)("/extensions/EXT_lights_area/lights/{}/rect/aspect",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"radius",iS,()=>1)]),(0,e7.ZU)("/nodes/{}/extensions/EXT_lights_ies/color",[new iC(L.X5.ANIMATIONTYPE_COLOR3,"diffuse",iv,()=>3)]),(0,e7.ZU)("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new iC(L.X5.ANIMATIONTYPE_FLOAT,"intensity",iS,()=>1)]),(0,e7.ZU)("/nodes/{}/extensions/KHR_node_visibility/visible",[new ib(L.X5.ANIMATIONTYPE_FLOAT,"isVisible",iS,()=>1)]);let i$="KHR_animation_pointer";class iq{constructor(e){this.name=i$,this._loader=e,this._pathToObjectConverter=(0,e7.Wt)(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(i$)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,i,r,n){let a=r.target.extensions?.KHR_animation_pointer;if(!a||!this._pathToObjectConverter)return null;"pointer"!==r.target.path&&q.V.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),void 0!=r.target.node&&q.V.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);let o=`${e}/extensions/${this.name}`,s=a.pointer;if(!s)throw Error(`${o}: Pointer is missing`);try{let a=this._pathToObjectConverter.convert(s);if(!a.info.interpolation)throw Error(`${o}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,{object:a.object,info:a.info.interpolation},n)}catch(e){return q.V.Warn(`${o}/pointer: Invalid pointer (${s}) skipped`),null}}}e9(i$),e6(i$,!0,e=>new iq(e));var iZ=i(52147),ij=i(83771),iK=i(9516);i(99949);let iQ="MSFT_audio_emitter";class iJ{constructor(e){this.name=iQ,this._loader=e,this.enabled=this._loader.isExtensionUsed(iQ)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,ta.Assign(this._clips),ta.Assign(this._emitters)}}loadSceneAsync(e,t){return ts.LoadExtensionAsync(e,t,this.name,async(i,r)=>{let n=[];for(let a of(n.push(this._loader.loadSceneAsync(e,t)),r.emitters)){let e=ta.Get(`${i}/emitters`,this._emitters,a);if(void 0!=e.refDistance||void 0!=e.maxDistance||void 0!=e.rolloffFactor||void 0!=e.distanceModel||void 0!=e.innerAngle||void 0!=e.outerAngle)throw Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);n.push(this._loadEmitterAsync(`${i}/emitters/${e.index}`,e))}await Promise.all(n)})}loadNodeAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(e,r)=>{let n=[],a=await this._loader.loadNodeAsync(e,t,t=>{for(let i of r.emitters){let r=ta.Get(`${e}/emitters`,this._emitters,i);n.push(this._loadEmitterAsync(`${e}/emitters/${r.index}`,r).then(()=>{for(let e of r._babylonSounds)e.attachToMesh(t),(void 0!=r.innerAngle||void 0!=r.outerAngle)&&(e.setLocalDirectionToMesh(N.Pq.Forward()),e.setDirectionalCone(2*D.S0.ToDegrees(void 0==r.innerAngle?Math.PI:r.innerAngle),2*D.S0.ToDegrees(void 0==r.outerAngle?Math.PI:r.outerAngle),0))}))}i(t)});return await Promise.all(n),a})}loadAnimationAsync(e,t){return ts.LoadExtensionAsync(e,t,this.name,async(i,r)=>{let n=await this._loader.loadAnimationAsync(e,t),a=[];for(let o of(ta.Assign(r.events),r.events))a.push(this._loadAnimationEventAsync(`${i}/events/${o.index}`,e,t,o,n));return await Promise.all(a),n})}_loadClipAsync(e,t){let i;if(t._objectURL)return t._objectURL;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{let r=ta.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=i.then(e=>URL.createObjectURL(new Blob([e],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){let e=[],i=t.name||`emitter${t.index}`,r={loop:!1,autoplay:!1,volume:void 0==t.volume?1:t.volume};for(let n=0;n<t.clips.length;n++){let a=`/extensions/${this.name}/clips`,o=ta.Get(a,this._clips,t.clips[n].clip);e.push(this._loadClipAsync(`${a}/${t.clips[n].clip}`,o).then(e=>{let a=t._babylonSounds[n]=new ij.A(i,e,this._loader.babylonScene,null,r);a.refDistance=t.refDistance||1,a.maxDistance=t.maxDistance||256,a.rolloffFactor=t.rolloffFactor||1,a.distanceModel=t.distanceModel||"exponential"}))}let n=Promise.all(e).then(()=>{let e=t.clips.map(e=>e.weight||1),i=new iK.r(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(i.directionalConeInnerAngle=2*D.S0.ToDegrees(t.innerAngle)),t.outerAngle&&(i.directionalConeOuterAngle=2*D.S0.ToDegrees(t.outerAngle)),t.volume&&(i.volume=t.volume),t._babylonData.sound=i});t._babylonData={loaded:n}}return t._babylonData.loaded}_getEventAction(e,t,i,r,n){switch(i){case"play":return e=>{t.play((n||0)+(e-r))};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,r,n){if(0==n.targetedAnimations.length)return Promise.resolve();let a=n.targetedAnimations[0],o=r.emitter,s=ta.Get(`/extensions/${this.name}/emitters`,this._emitters,o);return this._loadEmitterAsync(e,s).then(()=>{let t=s._babylonData.sound;if(t){let i=new iZ.p(r.time,this._getEventAction(e,t,r.action,r.time,r.startOffset));a.animation.addEvent(i),n.onAnimationGroupEndObservable.add(()=>{t.stop()}),n.onAnimationGroupPauseObservable.add(()=>{t.pause()})}})}}e9(iQ),e6(iQ,!0,e=>new iJ(e));let i0="MSFT_lod";class i1{constructor(e){this.name=i0,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new $.cP,this.onMaterialLODsLoadedObservable=new $.cP,this._bufferLODs=[],this._nodeIndexLOD=null,this._nodeSignalLODs=[],this._nodePromiseLODs=[],this._nodeBufferLODs=[],this._materialIndexLOD=null,this._materialSignalLODs=[],this._materialPromiseLODs=[],this._materialBufferLODs=[],this._loader=e,this.maxLODsToLoad=this._loader.parent.extensionOptions[i0]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(i0)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){let t=Promise.all(this._nodePromiseLODs[e]).then(()=>{0!==e&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){let t=Promise.all(this._materialPromiseLODs[e]).then(()=>{0!==e&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){let i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return ts.LoadExtensionAsync(e,t,this.name,async(e,r)=>{let n,a=this._getLODs(e,t,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${e}`);for(let e=0;e<a.length;e++){let t=a[e];0!==e&&(this._nodeIndexLOD=e,this._nodeSignalLODs[e]=this._nodeSignalLODs[e]||new e0.c);let r=e=>{i(e),e.setEnabled(!1)},o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,r).then(t=>{if(0!==e){let t=a[e-1];t._babylonTransformNode&&(this._disposeTransformNode(t._babylonTransformNode),delete t._babylonTransformNode)}return t.setEnabled(!0),t});this._nodePromiseLODs[e]=this._nodePromiseLODs[e]||[],0===e?n=o:(this._nodeIndexLOD=null,this._nodePromiseLODs[e].push(o))}return this._loader.logClose(),await n})}_loadMaterialAsync(e,t,i,r,n){return this._nodeIndexLOD?null:ts.LoadExtensionAsync(e,t,this.name,async(e,a)=>{let o,s=this._getLODs(e,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${e}`);for(let e=0;e<s.length;e++){let t=s[e];0!==e&&(this._materialIndexLOD=e);let a=this._loader._loadMaterialAsync(`/materials/${t.index}`,t,i,r,t=>{0===e&&n(t)}).then(t=>{if(0!==e){n(t);let i=s[e-1]._data;i[r]&&(this._disposeMaterials([i[r].babylonMaterial]),delete i[r])}return t});this._materialPromiseLODs[e]=this._materialPromiseLODs[e]||[],0===e?o=a:(this._materialIndexLOD=null,this._materialPromiseLODs[e].push(a))}return this._loader.logClose(),await o})}_loadUriAsync(e,t,i){if(null!==this._nodeIndexLOD){this._loader.log("deferred");let r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new e0.c,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(async()=>await this._loader.loadUriAsync(e,t,i))}if(null!==this._materialIndexLOD){this._loader.log("deferred");let r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new e0.c,this._materialSignalLODs[r].promise.then(async()=>await this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);let t=async(e,t)=>{let n=i+r-1,a=e[t];return a?(a.start=Math.min(a.start,i),a.end=Math.max(a.end,n)):(a={start:i,end:n,loaded:new e0.c},e[t]=a),await a.loaded.promise.then(e=>new Uint8Array(e.buffer,e.byteOffset+i-a.start,r))};return(this._loader.log("deferred"),null!==this._nodeIndexLOD)?t(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?t(this._materialBufferLODs,this._materialIndexLOD):t(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){let i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(e=>{i.loaded.resolve(e)},e=>{i.loaded.reject(e)}))}_getLODs(e,t,i,r){if(this.maxLODsToLoad<=0)throw Error("maxLODsToLoad must be greater than zero");let n=[];for(let t=r.length-1;t>=0;t--)if(n.push(ta.Get(`${e}/ids/${r[t]}`,i,r[t])),n.length===this.maxLODsToLoad)return n;return n.push(t),n}_disposeTransformNode(e){let t=[],i=e.material;for(let r of(i&&t.push(i),e.getChildMeshes()))r.material&&t.push(r.material);e.dispose();let r=t.filter(e=>this._loader.babylonScene.meshes.every(t=>t.material!=e));this._disposeMaterials(r)}_disposeMaterials(e){let t={};for(let i of e){for(let e of i.getActiveTextures())t[e.uniqueId]=e;i.dispose()}for(let e in t)for(let i of this._loader.babylonScene.materials)i.hasTexture(t[e])&&delete t[e];for(let e in t)t[e].dispose()}}e9(i0),e6(i0,!0,e=>new i1(e));let i2="MSFT_minecraftMesh";class i3{constructor(e){this.name=i2,this._loader=e,this.enabled=this._loader.isExtensionUsed(i2)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtraAsync(e,t,this.name,async(r,n)=>{if(n){if(!this._loader._pbrMaterialImpl)throw Error(`${r}: Material type not supported`);let n=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,await n}})}}e9(i2),e6(i2,!0,e=>new i3(e));let i4="MSFT_sRGBFactors";class i5{constructor(e){this.name=i4,this._loader=e,this.enabled=this._loader.isExtensionUsed(i4)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ts.LoadExtraAsync(e,t,this.name,async(r,n)=>{if(n){let r=this._loader._getOrCreateMaterialAdapter(i),n=this._loader.loadMaterialPropertiesAsync(e,t,i),a=i.getScene().getEngine().useExactSrgbConversions;return r.baseColorTexture||r.baseColor.toLinearSpaceToRef(r.baseColor,a),r.specularColorTexture||r.specularColor.toLinearSpaceToRef(r.specularColor,a),await n}})}}e9(i4),e6(i4,!0,e=>new i5(e));var i8=i(99750),i6=i(2777),i9=i(23911);function i7(e){let[t,i]=e.split(":");return re({op:t,extension:i})}function re(e,t=!0){let i=e.extension?ri[e.extension]?.[e.op]:rr[e.op];if(!i&&(q.V.Warn(`No mapping found for operation ${e.op} and extension ${e.extension||"KHR_interactivity"}`),t)){let t={},i={flows:{}};if(e.inputValueSockets)for(let i in t.values={},e.inputValueSockets)t.values[i]={name:i};return e.outputValueSockets&&(i.values={},Object.keys(e.outputValueSockets).forEach(e=>{i.values[e]={name:e}})),{blocks:[],inputs:t,outputs:i}}return i}function rt(e,t,i){ri[t]||(ri[t]={}),ri[t][e]=i}let ri={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},rr={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(e,t,i,r,n){if("event/send"!==t.op||!e.configuration||1!==Object.keys(e.configuration).length)throw Error("Receive event should have a single configuration object, the event itself");let a=e.configuration.event.value[0];if("number"!=typeof a)throw Error("Event id should be a number");let o=r.arrays.events[a],s=n[0];return s.config||(s.config={}),s.config.eventId=o.eventId,s.config.eventData=o.eventData,n}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(e,t){if(!e.configuration)return q.V.Error("Receive event should have a configuration object"),{valid:!1,error:"Receive event should have a configuration object"};let i=e.configuration.event;if(!i)return q.V.Error("Receive event should have a single configuration object, the event itself"),{valid:!1,error:"Receive event should have a single configuration object, the event itself"};let r=i.value[0];return"number"!=typeof r?(q.V.Error("Event id should be a number"),{valid:!1,error:"Event id should be a number"}):t.events?.[r]?{valid:!0}:(q.V.Error(`Event with id ${r} not found`),{valid:!1,error:`Event with id ${r} not found`})},extraProcessor(e,t,i,r,n){if("event/receive"!==t.op||!e.configuration||1!==Object.keys(e.configuration).length)throw Error("Receive event should have a single configuration object, the event itself");let a=e.configuration.event.value[0];if("number"!=typeof a)throw Error("Event id should be a number");let o=r.arrays.events[a],s=n[0];return s.config||(s.config={}),s.config.eventId=o.eventId,s.config.eventData=o.eventData,n}},"math/E":rn("FlowGraphEBlock"),"math/Pi":rn("FlowGraphPIBlock"),"math/Inf":rn("FlowGraphInfBlock"),"math/NaN":rn("FlowGraphNaNBlock"),"math/abs":rn("FlowGraphAbsBlock"),"math/sign":rn("FlowGraphSignBlock"),"math/trunc":rn("FlowGraphTruncBlock"),"math/floor":rn("FlowGraphFloorBlock"),"math/ceil":rn("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n){var a;return(a=n[0]).config||(a.config={}),n[0].config.roundHalfAwayFromZero=!0,n}},"math/fract":rn("FlowGraphFractBlock"),"math/neg":rn("FlowGraphNegationBlock"),"math/add":rn("FlowGraphAddBlock",["a","b"],!0),"math/sub":rn("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(e,t,i,r,n){var a;(a=n[0]).config||(a.config={}),n[0].config.useMatrixPerComponent=!0,n[0].config.preventIntegerFloatArithmetic=!0;let o=-1;return Object.keys(e.values||{}).find(t=>e.values?.[t].type!==void 0&&(o=e.values[t].type,!0)),-1!==o&&(n[0].config.type=r.arrays.types[o].flowGraphType),n},validation:e=>e.values?ra(e):{valid:!0}},"math/div":rn("FlowGraphDivideBlock",["a","b"],!0),"math/rem":rn("FlowGraphModuloBlock",["a","b"]),"math/min":rn("FlowGraphMinBlock",["a","b"]),"math/max":rn("FlowGraphMaxBlock",["a","b"]),"math/clamp":rn("FlowGraphClampBlock",["a","b","c"]),"math/saturate":rn("FlowGraphSaturateBlock"),"math/mix":rn("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":rn("FlowGraphEqualityBlock",["a","b"]),"math/lt":rn("FlowGraphLessThanBlock",["a","b"]),"math/le":rn("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":rn("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":rn("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":rn("FlowGraphIsNaNBlock"),"math/isInf":rn("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":rn("FlowGraphSinBlock"),"math/cos":rn("FlowGraphCosBlock"),"math/tan":rn("FlowGraphTanBlock"),"math/asin":rn("FlowGraphASinBlock"),"math/acos":rn("FlowGraphACosBlock"),"math/atan":rn("FlowGraphATanBlock"),"math/atan2":rn("FlowGraphATan2Block",["a","b"]),"math/sinh":rn("FlowGraphSinhBlock"),"math/cosh":rn("FlowGraphCoshBlock"),"math/tanh":rn("FlowGraphTanhBlock"),"math/asinh":rn("FlowGraphASinhBlock"),"math/acosh":rn("FlowGraphACoshBlock"),"math/atanh":rn("FlowGraphATanhBlock"),"math/exp":rn("FlowGraphExponentialBlock"),"math/log":rn("FlowGraphLogBlock"),"math/log2":rn("FlowGraphLog2Block"),"math/log10":rn("FlowGraphLog10Block"),"math/sqrt":rn("FlowGraphSquareRootBlock"),"math/cbrt":rn("FlowGraphCubeRootBlock"),"math/pow":rn("FlowGraphPowerBlock",["a","b"]),"math/length":rn("FlowGraphLengthBlock"),"math/normalize":rn("FlowGraphNormalizeBlock"),"math/dot":rn("FlowGraphDotBlock",["a","b"]),"math/cross":rn("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":rn("FlowGraphTransposeBlock"),"math/determinant":rn("FlowGraphDeterminantBlock"),"math/inverse":rn("FlowGraphInvertMatrixBlock"),"math/matMul":rn("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n,a){let o=n[0].dataInputs.find(e=>"rotationQuaternion"===e.name);if(!o)throw Error("Rotation quaternion input not found");return a._connectionValues[o.uniqueId]&&(a._connectionValues[o.uniqueId].type="Quaternion"),n}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":rn("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n){var a;return(a=n[0]).config||(a.config={}),n[0].config.type="Quaternion",n}},"math/quatAngleBetween":rn("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":rn("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":rn("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n){var a;return(a=n[0]).config||(a.config={}),n[0].config.inputIsColumnMajor=!0,n}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n){var a;return(a=n[0]).config||(a.config={}),n[0].config.inputIsColumnMajor=!0,n}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n){var a;return(a=n[0]).config||(a.config={}),n[0].config.inputIsColumnMajor=!0,n}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n,a){var o;(o=n[0]).config||(o.config={});let s=n[0].dataInputs[0];return n[0].config.valueType=a._connectionValues[s.uniqueId]?.type??"FlowGraphInteger",n}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n,a){var o;(o=n[0]).config||(o.config={});let s=n[0].dataInputs[0],l=n[0].dataInputs[1];return n[0].config.valueType=a._connectionValues[s.uniqueId]?.type??a._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",n}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n,a){var o;(o=n[0]).config||(o.config={});let s=n[0].dataInputs[0],l=n[0].dataInputs[1];return n[0].config.valueType=a._connectionValues[s.uniqueId]?.type??a._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",n}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,i,r,n,a){var o;(o=n[0]).config||(o.config={});let s=n[0].dataInputs[0],l=n[0].dataInputs[1];return n[0].config.valueType=a._connectionValues[s.uniqueId]?.type??a._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",n}},"math/asr":rn("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":rn("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":rn("FlowGraphLeadingZerosBlock"),"math/ctz":rn("FlowGraphTrailingZerosBlock"),"math/popcnt":rn("FlowGraphOneBitsCounterBlock"),"math/rad":rn("FlowGraphDegToRadBlock"),"math/deg":rn("FlowGraphRadToDegBlock"),"type/boolToInt":rn("FlowGraphBooleanToInt"),"type/boolToFloat":rn("FlowGraphBooleanToFloat"),"type/intToBool":rn("FlowGraphIntToBoolean"),"type/intToFloat":rn("FlowGraphIntToFloat"),"type/floatToInt":rn("FlowGraphFloatToInt"),"type/floatToBool":rn("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(e,t,i,r,n){let a=n[0];return a.config||(a.config={}),a.config.outputSignalCount=Object.keys(e.flows||[]).length,a.signalOutputs.forEach((e,t)=>{e.name="out_"+t}),n}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(e){if(e.configuration&&e.configuration.cases){let t=e.configuration.cases.value;if(!t.every(e=>"number"==typeof e&&/^-?\d+$/.test(e.toString())))return q.V.Warn("Switch cases should be integers. Using empty array instead."),e.configuration.cases.value=[],{valid:!0};let i=new Set(t);e.configuration.cases.value=Array.from(i)}return{valid:!0}},extraProcessor(e,t,i,r,n){if("flow/switch"!==t.op||!e.flows||0===Object.keys(e.flows).length)throw Error("Switch should have a single configuration object, the cases array");return n[0].signalOutputs.forEach(e=>{"default"!==e.name&&(e.name="out_"+e.name)}),n}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(e,t,i,r,n){let a=n[0];return a.config||(a.config={}),a.config.incrementIndexWhenLoopDone=!0,n}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(e,t,i,r,n){if("flow/multiGate"!==t.op||!e.flows||0===Object.keys(e.flows).length)throw Error("MultiGate should have a single configuration object, the number of output flows");let a=n[0];return a.config||(a.config={}),a.config.outputSignalCount=Object.keys(e.flows).length,a.signalOutputs.forEach((e,t)=>{e.name="out_"+t}),n}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation:e=>("number"!=typeof e.configuration?.inputFlows?.value[0]&&(e.configuration=e.configuration||{inputFlows:{value:[0]}},e.configuration.inputFlows.value=[0]),{valid:!0})},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation:e=>e.configuration?.variable?.value?{valid:!0}:(q.V.Error("Variable get block should have a variable configuration"),{valid:!1,error:"Variable get block should have a variable configuration"}),configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer:(e,t)=>[t.getVariableName(e[0])]}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer:(e,t)=>[t.getVariableName(e[0])]}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer:(e,t)=>[e[0].map(e=>t.getVariableName(e))]}},extraProcessor:(e,t,i,r,n)=>(n[0].dataInputs.forEach(e=>{e.name=r.getVariableName(+e.name)}),n)},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer:(e,t)=>[t.getVariableName(e[0])]},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:e=>!0===e[0]?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(e,t,i,r,n){var a,o;let s=n[0],l=e.configuration?.variable.value[0];if("number"!=typeof l)throw q.V.Error("Variable index is not defined for variable interpolation block"),Error("Variable index is not defined for variable interpolation block");let c=r.arrays.staticVariables[l];void 0===s.config.animationType.value&&(r.arrays.staticVariables,s.config.animationType.value=(0,i9.U_)(c.type));let f=n[4];return f.config||(f.config={}),(a=f.config).variable||(a.variable={}),f.config.variable.value=r.getVariableName(l),(o=n[3]).config||(o.config={}),n}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor:(e,t,i,r,n)=>(n.forEach(e=>{"FlowGraphJsonPointerParserBlock"===e.className&&(e.config||(e.config={}),e.config.outputValue=!0)}),n)},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor:(e,t,i,r,n)=>(n.forEach(e=>{"FlowGraphJsonPointerParserBlock"===e.className&&(e.config||(e.config={}),e.config.outputValue=!0)}),n)},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor:(e,t,i,r,n)=>(n.forEach(t=>{"FlowGraphJsonPointerParserBlock"===t.className?(t.config||(t.config={}),t.config.outputValue=!0):"FlowGraphInterpolationBlock"===t.className&&(t.config||(t.config={}),Object.keys(e.values||[]).forEach(i=>{let n=e.values?.[i];if("value"===i&&n){let e=n.type;void 0!==e&&(t.config.animationType=r.arrays.types[e].flowGraphType)}}))}),n)},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(e,t)=>[e[0]*t._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(e,t)=>[e[0]*t._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(e,t,i,r,n,a,o){let s=n[n.length-1];return s.config||(s.config={}),s.config.glTF=o,n}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(e,t,i,r,n,a,o){let s=n[n.length-1];return s.config||(s.config={}),s.config.glTF=o,n}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(e,t)=>[e[0]*t._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(e,t,i,r,n,a,o){let s=n[n.length-1];return s.config||(s.config={}),s.config.glTF=o,n}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(e){if(e.configuration&&e.configuration.cases){let t=e.configuration.cases.value;if(!t.every(e=>"number"==typeof e&&/^-?\d+$/.test(e.toString())))return q.V.Warn("Switch cases should be integers. Using empty array instead."),e.configuration.cases.value=[],{valid:!0};let i=new Set(t);e.configuration.cases.value=Array.from(i)}return{valid:!0}},extraProcessor(e,t,i,r,n){let a=n[0];return a.dataInputs.forEach(e=>{"default"!==e.name&&"case"!==e.name&&(e.name="in_"+e.name)}),a.config||(a.config={}),a.config.treatCasesAsIntegers=!0,n}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function rn(e,t=["a"],i){return{blocks:[e],inputs:{values:t.reduce((e,t)=>(e[t]={name:t},e),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(e,t,r,n,a){var o;if(i){(o=a[0]).config||(o.config={}),a[0].config.preventIntegerFloatArithmetic=!0;let t=-1;Object.keys(e.values||{}).find(i=>e.values?.[i].type!==void 0&&(t=e.values[i].type,!0)),-1!==t&&(a[0].config.type=n.arrays.types[t].flowGraphType)}return a},validation:e=>i?ra(e):{valid:!0}}}function ra(e){if(e.values){let t=Object.keys(e.values).map(t=>e.values[t].type).filter(e=>void 0!==e);if(!t.every(e=>e===t[0]))return{valid:!1,error:"All inputs must be of the same type"}}return{valid:!0}}function ro(){return Object.keys(rr)}var rs=i(10793);let rl={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}};class rc{constructor(e,t,i=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=i,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(let e of this._interactivityGraph.types)this._types.push(rl[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(let e of this._interactivityGraph.declarations){let t=re(e);if(!t)throw q.V.Error(["No mapping found for declaration",e]),Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(let e of this._interactivityGraph.variables){let t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){let i=this._types[e.type];if(!i)throw q.V.Error(["No type found for variable",e]),Error("Error parsing variables");if(e.value&&e.value.length!==i.length)throw q.V.Error(["Invalid value length for variable",e,i]),Error("Error parsing variables");let r=e.value||[];if(!r.length)switch(i.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9)}return"number"===i.elementType&&"string"==typeof r[0]&&(r[0]=parseFloat(r[0])),{type:i.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(let e of this._interactivityGraph.events){let t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(t=>{let i=e.values?.[t];if(!i)throw q.V.Error(["No value found for event key",t]),Error("Error parsing events");let r=this._types[i.type];if(!r)throw q.V.Error(["No type found for event value",i]),Error("Error parsing events");let n=void 0!==i.value?this._parseVariable(i):void 0;return{id:t,type:r.flowGraphType,eventData:!0,value:n}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(let e of this._interactivityGraph.nodes){if("number"!=typeof e.declaration)throw q.V.Error(["No declaration found for node",e]),Error("Error parsing nodes");let t=this._mappings[e.declaration];if(!t)throw q.V.Error(["No mapping found for node",e]),Error("Error parsing nodes");if(t.flowGraphMapping.validation){let i=t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf);if(!i.valid)throw Error(`Error validating interactivity node ${this._interactivityGraph.declarations?.[e.declaration].op} - ${i.error}`)}let i=[];for(let r of t.flowGraphMapping.blocks){let n=this._getEmptyBlock(r,t.fullOperationName);this._parseNodeConfiguration(e,n,t.flowGraphMapping,r),i.push(n)}this._nodes.push({blocks:i,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:(0,rs.z)(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,i,r){let n=t.config;if(e.configuration)for(let t of Object.keys(e.configuration)){let a=e.configuration?.[t];if(!a)throw q.V.Error(["No value found for node configuration",t]),Error("Error parsing node configuration");let o=i.configuration?.[t];if(o&&o.toBlock?o.toBlock===r:0===i.blocks.indexOf(r)){let e=o?.name||t;a&&void 0!==a.value||void 0===o?.defaultValue?a.value.length>=0?n[e]={value:1===a.value.length?a.value[0]:a.value}:q.V.Warn(["Invalid value for node configuration",a]):n[e]={value:o.defaultValue},o&&o.dataTransformer&&(n[e].value=o.dataTransformer([n[e].value],this)[0])}}}_parseNodeConnections(e){for(let t=0;t<this._nodes.length;t++){let i=this._interactivityGraph.nodes?.[t];if(!i)throw q.V.Error(["No node found for interactivity node",this._nodes[t]]),Error("Error parsing node connections");let r=this._nodes[t],n=this._mappings[i.declaration];if(!n)throw q.V.Error(["No mapping found for node",i]),Error("Error parsing node connections");let a=i.flows||{};for(let e of Object.keys(a).sort()){let t=a[e],i=n.flowGraphMapping.outputs?.flows?.[e],o=i?.name||e,s=this._createNewSocketConnection(o,!0);(i&&i.toBlock&&r.blocks.find(e=>e.className===i.toBlock)||r.blocks[0]).signalOutputs.push(s);let l=t.node,c=this._nodes[l];if(!c)throw q.V.Error(["No node found for input node id",l]),Error("Error parsing node connections");let f=i7(c.fullOperationName);if(!f)throw q.V.Error(["No mapping found for input node",c]),Error("Error parsing node connections");let u=f.inputs?.flows?.[t.socket||"in"],d=!1;if(!u)for(let e in f.inputs?.flows)e.startsWith("[")&&e.endsWith("]")&&(d=!0,u=f.inputs?.flows?.[e]);let h=u?d?u.name.replace("$1",t.socket||""):u.name:t.socket||"in",p=u&&u.toBlock&&c.blocks.find(e=>e.className===u.toBlock)||c.blocks[0],m=p.signalInputs.find(e=>e.name===h);m||(m=this._createNewSocketConnection(h),p.signalInputs.push(m)),m.connectedPointIds.push(s.uniqueId),s.connectedPointIds.push(m.uniqueId)}let o=i.values||{};for(let t of Object.keys(o)){let i=o[t],a=n.flowGraphMapping.inputs?.values?.[t],s=!1;if(!a)for(let e in n.flowGraphMapping.inputs?.values)e.startsWith("[")&&e.endsWith("]")&&(s=!0,a=n.flowGraphMapping.inputs?.values?.[e]);let l=a?s?a.name.replace("$1",t):a.name:t,c=this._createNewSocketConnection(l);if((a&&a.toBlock&&r.blocks.find(e=>e.className===a.toBlock)||r.blocks[0]).dataInputs.push(c),void 0!==i.value){let t=this._parseVariable(i,a&&a.dataTransformer);e._connectionValues[c.uniqueId]=t}else if(void 0!==i.node){let e=i.node,t=i.socket||"value",r=this._nodes[e];if(!r)throw q.V.Error(["No node found for output socket reference",i]),Error("Error parsing node connections");let n=i7(r.fullOperationName);if(!n)throw q.V.Error(["No mapping found for output socket reference",i]),Error("Error parsing node connections");let a=n.outputs?.values?.[t],o=!1;if(!a)for(let e in n.outputs?.values)e.startsWith("[")&&e.endsWith("]")&&(o=!0,a=n.outputs?.values?.[e]);let s=a?o?a.name.replace("$1",t):a?.name:t,l=a&&a.toBlock&&r.blocks.find(e=>e.className===a.toBlock)||r.blocks[0],f=l.dataOutputs.find(e=>e.name===s);f||(f=this._createNewSocketConnection(s,!0),l.dataOutputs.push(f)),c.connectedPointIds.push(f.uniqueId),f.connectedPointIds.push(c.uniqueId)}else throw q.V.Error(["Invalid value for value connection",i]),Error("Error parsing node connections")}if(n.flowGraphMapping.interBlockConnectors)for(let e of n.flowGraphMapping.interBlockConnectors){let t=e.input,i=e.output,n=e.isVariable;this._connectFlowGraphNodes(t,i,r.blocks[e.inputBlockIndex],r.blocks[e.outputBlockIndex],n)}if(n.flowGraphMapping.extraProcessor){let t=this._interactivityGraph.declarations?.[i.declaration];if(!t)throw q.V.Error(["No declaration found for extra processor",i]),Error("Error parsing node connections");r.blocks=n.flowGraphMapping.extraProcessor(i,t,n.flowGraphMapping,this,r.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:(0,rs.z)(),name:e,_connectionType:+!!t,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,i,r,n){let a=n?i.dataInputs:i.signalInputs,o=n?r.dataOutputs:r.signalOutputs,s=a.find(t=>t.name===e)||this._createNewSocketConnection(e),l=o.find(e=>e.name===t)||this._createNewSocketConnection(t,!0);a.find(t=>t.name===e)||a.push(s),o.find(e=>e.name===t)||o.push(l),s.connectedPointIds.push(l.uniqueId),l.connectedPointIds.push(s.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){let e={uniqueId:(0,rs.z)(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let t=0;t<this._staticVariables.length;t++){let i=this._staticVariables[t];e._userVariables[this.getVariableName(t)]=i}return{rightHanded:!0,allBlocks:this._nodes.reduce((e,t)=>e.concat(t.blocks),[]),executionContexts:[e]}}}var rf=i(3572);let ru="KHR_interactivity";class rd{constructor(e){this._loader=e,this.name=ru,this.enabled=this._loader.isExtensionUsed(ru),this._pathConverter=(0,e7.Wt)(this._loader.gltf),e._skipStartAnimationStep=!0;const t=e.babylonScene;t&&rh(t)}dispose(){this._loader=null,delete this._pathConverter}async onReady(){if(!this._loader.babylonScene||!this._pathConverter)return;let e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity;if(!t)return;let i=new i8.x({scene:e});i.dispatchEventsSynchronously=!1;let r=t.graphs.map(e=>new rc(e,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph());await Promise.all(r.map(async e=>await (0,i6.cB)(e,{coordinator:i,pathConverter:this._pathConverter}))),i.start()}}function rh(e){(0,e7.oR)("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!e.activeCamera)return new N.PT(NaN,NaN,NaN,NaN);let t=N.PT.FromRotationMatrix(e.activeCamera.getWorldMatrix()).normalize();return e.useRightHandedSystem||(t.w*=-1,t.x*=-1),t},type:"Quaternion",getTarget:()=>e.activeCamera}),(0,e7.oR)("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!e.activeCamera)return new N.Pq(NaN,NaN,NaN);let t=e.activeCamera.getWorldMatrix().getTranslation();return e.useRightHandedSystem||(t.x*=-1),t},type:"Vector3",getTarget:()=>e.activeCamera}),(0,e7.oR)("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>e._babylonAnimationGroup?.isPlaying??!1,type:"boolean",getTarget:e=>e._babylonAnimationGroup}),(0,e7.oR)("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>(e._babylonAnimationGroup?.from??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),(0,e7.oR)("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>(e._babylonAnimationGroup?.to??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),(0,e7.oR)("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),(0,e7.oR)("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup})}(0,rf.Q)(ru,"FlowGraphGLTFDataProvider",async()=>(await Promise.resolve().then(i.bind(i,27450))).FlowGraphGLTFDataProvider),e9(ru),e6(ru,!0,e=>new rd(e));let rp="KHR_node_visibility";(0,e7.oR)("/nodes/{}/extensions/KHR_node_visibility/visible",{get:e=>{let t=e._babylonTransformNode;return!t||void 0===t.isVisible||t.isVisible},set:(e,t)=>{t._primitiveBabylonMeshes?.forEach(e=>{e.inheritVisibility=!0}),t._babylonTransformNode&&(t._babylonTransformNode.isVisible=e),t._primitiveBabylonMeshes?.forEach(t=>{t.isVisible=e})},getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});class rm{constructor(e){this.name=rp,this._loader=e,this.enabled=e.isExtensionUsed(rp)}onReady(){if(!this._loader)return;let e=this._loader.gltf.nodes;if(e)for(let t of e){let e=t._babylonTransformNode;e&&(e.inheritVisibility=!0,t.extensions&&t.extensions.KHR_node_visibility&&!1===t.extensions.KHR_node_visibility.visible&&(e.isVisible=!1))}}dispose(){delete this._loader}}e9(rp),e6(rp,!0,e=>new rm(e));let r_="KHR_node_selectability";rt("event/onSelect",r_,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer:e=>["pickedMesh_"+e[0]]}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(e,t,i,r,n,a,o){let s=n[n.length-1];s.config=s.config||{},s.config.glTF=o;let l=e.configuration?.nodeIndex?.value[0];if(void 0===l||"number"!=typeof l)throw Error("nodeIndex not found in configuration");let c="pickedMesh_"+l;return n[1].config.variable=c,a._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},n}}),(0,e7.oR)("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:e=>{let t=e._babylonTransformNode;return!t||void 0===t.isPickable||t.isPickable},set:(e,t)=>{t._primitiveBabylonMeshes?.forEach(t=>{t.isPickable=e})},getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});class rg{constructor(e){this.name=r_,this._loader=e,this.enabled=e.isExtensionUsed(r_)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_selectability&&e.extensions?.KHR_node_selectability.selectable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(e=>{e.isPickable=!1})})}dispose(){this._loader=null}}e9(r_),e6(r_,!0,e=>new rg(e));let rv="KHR_node_hoverability",rS="targetMeshPointerOver_";rt("event/onHoverIn",rv,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer:e=>[rS+e[0]]}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(e,t,i,r,n,a,o){let s=n[n.length-1];s.config=s.config||{},s.config.glTF=o;let l=e.configuration?.nodeIndex?.value[0];if(void 0===l||"number"!=typeof l)throw Error("nodeIndex not found in configuration");let c=rS+l;return n[1].config.variable=c,a._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},n}});let rE="targetMeshPointerOut_";rt("event/onHoverOut",rv,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer:e=>[rE+e[0]]}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(e,t,i,r,n,a,o){let s=n[n.length-1];s.config=s.config||{},s.config.glTF=o;let l=e.configuration?.nodeIndex?.value[0];if(void 0===l||"number"!=typeof l)throw Error("nodeIndex not found in configuration");let c=rE+l;return n[1].config.variable=c,a._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},n}}),(0,e7.oR)("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:e=>{let t=e._babylonTransformNode;return!t||void 0===t.pointerOverDisableMeshTesting||t.pointerOverDisableMeshTesting},set:(e,t)=>{t._primitiveBabylonMeshes?.forEach(t=>{t.pointerOverDisableMeshTesting=!e})},getTarget:e=>e._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});class rT{constructor(e){this.name=rv,this._loader=e,this.enabled=e.isExtensionUsed(rv)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_hoverability&&e.extensions?.KHR_node_hoverability.hoverable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(e=>{e.pointerOverDisableMeshTesting=!0})})}dispose(){this._loader=null}}e9(rv),e6(rv,!0,e=>new rT(e));let rA="ExtrasAsMetadata";class rx{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){let i=e.metadata=e.metadata||{};(i.gltf=i.gltf||{}).extras=t.extras}}constructor(e){this.name=rA,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,e=>{this._assignExtras(e,t),i(e)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,e=>{this._assignExtras(e,t),i(e)})}createMaterial(e,t,i){let r=this._loader.createMaterial(e,t,i);return this._assignExtras(r,t),r}}e9(rA),e6(rA,!1,e=>new rx(e));var rI=i(27450);class rR{constructor(){this.materials=[]}parseMTL(e,t,i,r){let n;if(t instanceof ArrayBuffer)return;let a=t.split("\n"),o=/\s+/,s=null;for(let t=0;t<a.length;t++){let l=a[t].trim();if(0===l.length||"#"===l.charAt(0))continue;let c=l.indexOf(" "),f=c>=0?l.substring(0,c):l;f=f.toLowerCase();let u=c>=0?l.substring(c+1).trim():"";if("newmtl"===f)s&&this.materials.push(s),e._blockEntityCollection=!!r,(s=new em.F(u,e))._parentContainer=r,e._blockEntityCollection=!1;else if("kd"===f&&s)n=u.split(o,3).map(parseFloat),s.diffuseColor=ec.v9.FromArray(n);else if("ka"===f&&s)n=u.split(o,3).map(parseFloat),s.ambientColor=ec.v9.FromArray(n);else if("ks"===f&&s)n=u.split(o,3).map(parseFloat),s.specularColor=ec.v9.FromArray(n);else if("ke"===f&&s)n=u.split(o,3).map(parseFloat),s.emissiveColor=ec.v9.FromArray(n);else if("ns"===f&&s)s.specularPower=parseFloat(u);else if("d"===f&&s)s.alpha=parseFloat(u);else if("map_ka"===f&&s)s.ambientTexture=rR._GetTexture(i,u,e);else if("map_kd"===f&&s)s.diffuseTexture=rR._GetTexture(i,u,e);else if("map_ks"===f&&s)s.specularTexture=rR._GetTexture(i,u,e);else if("map_ns"===f);else if("map_bump"===f&&s){let t=u.split(o),r=t.indexOf("-bm"),n=null;r>=0&&(n=t[r+1],t.splice(r,2)),s.bumpTexture=rR._GetTexture(i,t.join(" "),e),s.bumpTexture&&null!==n&&(s.bumpTexture.level=parseFloat(n))}else"map_d"===f&&s&&(s.opacityTexture=rR._GetTexture(i,u,e))}s&&this.materials.push(s)}static _GetTexture(e,t,i){if(!t)return null;let r=e;if("file:"===e){let e=t.lastIndexOf("\\");-1===e&&(e=t.lastIndexOf("/")),e>-1?r+=t.substring(e+1):r+=t}else r+=t;return new eg.g(r,i,!1,rR.INVERT_TEXTURE_Y)}}rR.INVERT_TEXTURE_Y=!0;class rC{constructor(e,t,i){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._extColors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new ec.ov(.5,.5,.5,1),this._hasLineData=!1,this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=i}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});let i=e[t[0]].normals.indexOf(t[1]);return -1===i?-1:e[t[0]].idx[i]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});let i=e[t[0]].normals.indexOf(t[1]);return 1!=i&&t[2]===e[t[0]].uv[i]?e[t[0]].idx[i]:-1}_setData(e){let t;e.indiceUvsFromObj??(e.indiceUvsFromObj=-1),e.indiceNormalFromObj??(e.indiceNormalFromObj=-1),-1===(t=this._loadingOptions.optimizeWithUV?this._isInArrayUV(this._tuplePosNorm,[e.indicePositionFromObj,e.indiceNormalFromObj,e.indiceUvsFromObj]):this._isInArray(this._tuplePosNorm,[e.indicePositionFromObj,e.indiceNormalFromObj]))?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(e.positionVectorFromOBJ),void 0!==e.textureVectorFromOBJ&&this._wrappedUvsForBabylon.push(e.textureVectorFromOBJ),void 0!==e.normalsVectorFromOBJ&&this._wrappedNormalsForBabylon.push(e.normalsVectorFromOBJ),void 0!==e.positionColorsFromOBJ&&this._wrappedColorsForBabylon.push(e.positionColorsFromOBJ),this._tuplePosNorm[e.indicePositionFromObj].normals.push(e.indiceNormalFromObj),this._tuplePosNorm[e.indicePositionFromObj].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e.indicePositionFromObj].uv.push(e.indiceUvsFromObj)):this._indicesForBabylon.push(t)}_unwrapData(){try{for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x*this._handednessSign,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._wrappedNormalsForBabylon.length&&this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x*this._handednessSign,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._wrappedUvsForBabylon.length&&this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._unwrappedColorsForBabylon.length&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}catch(e){throw Error("Unable to unwrap data while parsing OBJ data.")}}_getTriangles(e,t){for(let i=t;i<e.length-1;i++)this._pushTriangle(e,i)}_getColor(e){return this._loadingOptions.importVertexColors?this._extColors[e]??this._colors[e]:void 0}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){let t=parseInt(this._triangles[e])-1;this._setData({indicePositionFromObj:t,positionVectorFromOBJ:this._positions[t],positionColorsFromOBJ:this._getColor(t)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){let t=this._triangles[e].split("/"),i=parseInt(t[0])-1,r=parseInt(t[1])-1;this._setData({indicePositionFromObj:i,indiceUvsFromObj:r,positionVectorFromOBJ:this._positions[i],textureVectorFromOBJ:this._uvs[r],positionColorsFromOBJ:this._getColor(i)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){let t=this._triangles[e].split("/"),i=parseInt(t[0])-1,r=parseInt(t[1])-1,n=parseInt(t[2])-1;this._setData({indicePositionFromObj:i,indiceUvsFromObj:r,indiceNormalFromObj:n,positionVectorFromOBJ:this._positions[i],textureVectorFromOBJ:this._uvs[r],normalsVectorFromOBJ:this._normals[n]})}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){let t=this._triangles[e].split("//"),i=parseInt(t[0])-1,r=parseInt(t[1])-1;this._setData({indicePositionFromObj:i,indiceNormalFromObj:r,positionVectorFromOBJ:this._positions[i],normalsVectorFromOBJ:this._normals[r],positionColorsFromOBJ:this._getColor(i)})}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let e=0;e<this._triangles.length;e++){let t=this._triangles[e].split("/"),i=this._positions.length+parseInt(t[0]),r=this._uvs.length+parseInt(t[1]),n=this._normals.length+parseInt(t[2]);this._setData({indicePositionFromObj:i,indiceUvsFromObj:r,indiceNormalFromObj:n,positionVectorFromOBJ:this._positions[i],textureVectorFromOBJ:this._uvs[r],normalsVectorFromOBJ:this._normals[n],positionColorsFromOBJ:this._getColor(i)})}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice()),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon.slice()),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._handledMesh.hasLines=this._hasLineData,this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0,this._hasLineData=!1)}_optimizeNormals(e){let t=e.getVerticesData(eS.R.PositionKind),i=e.getVerticesData(eS.R.NormalKind),r={};if(!t||!i)return;for(let e=0;e<t.length/3;e++){let i=t[3*e+0]+"_"+t[3*e+1]+"_"+t[3*e+2],n=r[i];n||(n=[],r[i]=n),n.push(e)}let n=new N.Pq;for(let e in r){let t=r[e];if(t.length<2)continue;let a=t[0];for(let e=1;e<t.length;++e){let r=t[e];i[3*a+0]+=i[3*r+0],i[3*a+1]+=i[3*r+1],i[3*a+2]+=i[3*r+2]}n.copyFromFloats(i[3*a+0],i[3*a+1],i[3*a+2]),n.normalize();for(let e=0;e<t.length;++e){let r=t[e];i[3*r+0]=n.x,i[3*r+1]=n.y,i[3*r+2]=n.z}}e.setVerticesData(eS.R.NormalKind,i)}static _IsLineElement(e){return e.startsWith("l")}static _IsObjectElement(e){return e.startsWith("o")}static _IsGroupElement(e){return e.startsWith("g")}static _GetZbrushMRGB(e,t){if(!e.startsWith("mrgb"))return null;if(e=e.replace("mrgb","").trim(),t)return[];let i=e.match(/[a-z0-9]/g);if(!i||i.length%8!=0)return[];let r=[];for(let e=0;e<i.length/8;e++){let t=i[8*e+2]+i[8*e+3],n=i[8*e+4]+i[8*e+5],a=i[8*e+6]+i[8*e+7];r.push(new ec.ov(parseInt(t,16)/255,parseInt(n,16)/255,parseInt(a,16)/255,1))}return r}parse(e,t,i,r,n){t=(t=t.replace(/#MRGB/g,"mrgb")).replace(/#.*$/gm,"").trim(),this._loadingOptions.useLegacyBehavior?(this._pushTriangle=(e,t)=>this._triangles.push(e[0],e[t],e[t+1]),this._handednessSign=1):i.useRightHandedSystem?(this._pushTriangle=(e,t)=>this._triangles.push(e[0],e[t+1],e[t]),this._handednessSign=1):(this._pushTriangle=(e,t)=>this._triangles.push(e[0],e[t],e[t+1]),this._handednessSign=-1);let a=t.split("\n"),o=[],s=[];o.push(s);for(let e=0;e<a.length;e++){let t=a[e].trim().replace(/\s\s/g," ");if(0!==t.length&&"#"!==t.charAt(0))if((rC._IsGroupElement(t)||rC._IsObjectElement(t))&&(s=[],o.push(s)),rC._IsLineElement(t)){let e=t.split(" ");for(let t=1;t<e.length-1;t++)s.push(`l ${e[t]} ${e[t+1]}`)}else s.push(t)}let l=o.flat();for(let e=0;e<l.length;e++){let t,i=l[e].trim().replace(/\s\s/g," ");if(0!==i.length&&"#"!==i.charAt(0))if(rC.VertexPattern.test(i)){if(t=i.match(/[^ ]+/g),this._positions.push(new N.Pq(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]))),this._loadingOptions.importVertexColors)if(t.length>=7){let e=parseFloat(t[4]),i=parseFloat(t[5]),r=parseFloat(t[6]);this._colors.push(new ec.ov(e>1?e/255:e,i>1?i/255:i,r>1?r/255:r,7===t.length||void 0===t[7]?1:parseFloat(t[7])))}else this._colors.push(this._grayColor)}else if(null!==(t=rC.NormalPattern.exec(i)))this._normals.push(new N.Pq(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])));else if(null!==(t=rC.UVPattern.exec(i)))this._uvs.push(new N.I9(parseFloat(t[1])*this._loadingOptions.UVScaling.x,parseFloat(t[2])*this._loadingOptions.UVScaling.y));else if(null!==(t=rC.FacePattern3.exec(i)))this._setDataForCurrentFaceWithPattern3(t[1].trim().split(" "),1);else if(null!==(t=rC.FacePattern4.exec(i)))this._setDataForCurrentFaceWithPattern4(t[1].trim().split(" "),1);else if(null!==(t=rC.FacePattern5.exec(i)))this._setDataForCurrentFaceWithPattern5(t[1].trim().split(" "),1);else if(null!==(t=rC.FacePattern2.exec(i)))this._setDataForCurrentFaceWithPattern2(t[1].trim().split(" "),1);else if(null!==(t=rC.FacePattern1.exec(i)))this._setDataForCurrentFaceWithPattern1(t[1].trim().split(" "),1);else if(null!==(t=rC.LinePattern1.exec(i)))this._setDataForCurrentFaceWithPattern1(t[1].trim().split(" "),0),this._hasLineData=!0;else if(null!==(t=rC.LinePattern2.exec(i)))this._setDataForCurrentFaceWithPattern2(t[1].trim().split(" "),0),this._hasLineData=!0;else if(t=rC._GetZbrushMRGB(i,!this._loadingOptions.importVertexColors))for(let e of t)this._extColors.push(e);else if(null!==(t=rC.LinePattern3.exec(i)))this._setDataForCurrentFaceWithPattern3(t[1].trim().split(" "),0),this._hasLineData=!0;else if(rC.GroupDescriptor.test(i)||rC.ObjectDescriptor.test(i)){let e={name:i.substring(2).trim(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:rC.ObjectDescriptor.test(i)};this._addPreviousObjMesh(),this._meshesFromObj.push(e),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(rC.UseMtlDescriptor.test(i)){if(this._materialNameFromObj=i.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();let e={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(e),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else rC.MtlLibGroupDescriptor.test(i)?n(i.substring(7).trim()):rC.SmoothDescriptor.test(i)||q.V.Log("Unhandled expression at line : "+i)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._unwrappedNormalsForBabylon.length&&(this._handledMesh.normals=this._unwrappedNormalsForBabylon),this._unwrappedUVForBabylon.length&&(this._handledMesh.uvs=this._unwrappedUVForBabylon),this._unwrappedColorsForBabylon.length&&(this._handledMesh.colors=this._unwrappedColorsForBabylon),this._handledMesh.hasLines=this._hasLineData),!this._hasMeshes){let e=null;if(this._indicesForBabylon.length)this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData();else{for(let e of this._positions)this._unwrappedPositionsForBabylon.push(e.x,e.y,e.z);if(this._normals.length)for(let e of this._normals)this._unwrappedNormalsForBabylon.push(e.x,e.y,e.z);if(this._uvs.length)for(let e of this._uvs)this._unwrappedUVForBabylon.push(e.x,e.y);if(this._extColors.length)for(let e of this._extColors)this._unwrappedColorsForBabylon.push(e.r,e.g,e.b,e.a);else if(this._colors.length)for(let e of this._colors)this._unwrappedColorsForBabylon.push(e.r,e.g,e.b,e.a);!this._materialNameFromObj&&((e=new em.F(eE.V.RandomId(),i)).pointsCloud=!0,this._materialNameFromObj=e.name,this._normals.length||(e.disableLighting=!0,e.emissiveColor=ec.v9.White()))}this._meshesFromObj.push({name:eE.V.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:e,isObject:!0,hasLines:this._hasLineData})}for(let t=0;t<this._meshesFromObj.length;t++){if(e&&this._meshesFromObj[t].name){if(e instanceof Array){if(-1===e.indexOf(this._meshesFromObj[t].name))continue}else if(this._meshesFromObj[t].name!==e)continue}this._handledMesh=this._meshesFromObj[t],i._blockEntityCollection=!!r;let n=new ex.e(this._meshesFromObj[t].name,i);if(n._parentContainer=r,i._blockEntityCollection=!1,this._handledMesh._babylonMesh=n,!this._handledMesh.isObject){for(let e=t-1;e>=0;--e)if(this._meshesFromObj[e].isObject&&this._meshesFromObj[e]._babylonMesh){n.parent=this._meshesFromObj[e]._babylonMesh;break}}if(this._materialToUse.push(this._meshesFromObj[t].materialName),this._handledMesh.hasLines&&(n._internalMetadata??(n._internalMetadata={}),n._internalMetadata._isLine=!0),this._handledMesh.positions?.length===0){this._babylonMeshesArray.push(n);continue}let a=new ev.P;if(a.indices=this._handledMesh.indices,a.positions=this._handledMesh.positions,this._loadingOptions.computeNormals||!this._handledMesh.normals){let e=[];ev.P.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,e),a.normals=e}else a.normals=this._handledMesh.normals;this._handledMesh.uvs&&(a.uvs=this._handledMesh.uvs),this._handledMesh.colors&&(a.colors=this._handledMesh.colors),a.applyToMesh(n),this._loadingOptions.invertY&&(n.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(n),this._babylonMeshesArray.push(n),this._handledMesh.directMaterial&&(n.material=this._handledMesh.directMaterial)}}}rC.ObjectDescriptor=/^o/,rC.GroupDescriptor=/^g/,rC.MtlLibGroupDescriptor=/^mtllib /,rC.UseMtlDescriptor=/^usemtl /,rC.SmoothDescriptor=/^s /,rC.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/,rC.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,rC.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/,rC.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/,rC.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,rC.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,rC.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,rC.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/,rC.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/,rC.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/,rC.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;class rb{static get INVERT_TEXTURE_Y(){return rR.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){rR.INVERT_TEXTURE_Y=e}constructor(e){this.name="obj",this.extensions=".obj",this._assetContainer=null,this._loadingOptions={...rb._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{computeNormals:rb.COMPUTE_NORMALS,optimizeNormals:rb.OPTIMIZE_NORMALS,importVertexColors:rb.IMPORT_VERTEX_COLORS,invertY:rb.INVERT_Y,invertTextureY:rb.INVERT_TEXTURE_Y,UVScaling:rb.UV_SCALING,materialLoadingFailsSilently:rb.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:rb.OPTIMIZE_WITH_UV,skipMaterials:rb.SKIP_MATERIALS,useLegacyBehavior:rb.USE_LEGACY_BEHAVIOR}}_loadMTL(e,t,i,r){let n=t+e;D.S0.LoadFile(n,i,void 0,void 0,!1,(e,t)=>{r(n,t)})}createPlugin(e){return new rb(e.obj)}canDirectLoad(){return!1}importMeshAsync(e,t,i,r){return this._parseSolidAsync(e,t,i,r).then(e=>({meshes:e,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}loadAsync(e,t,i){return this.importMeshAsync(null,e,t,i).then(()=>{})}loadAssetContainerAsync(e,t,i){let r=new W.WZ(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,i).then(e=>(e.meshes.forEach(e=>r.meshes.push(e)),e.meshes.forEach(e=>{let t=e.material;t&&-1==r.materials.indexOf(t)&&(r.materials.push(t),t.getActiveTextures().forEach(e=>{-1==r.textures.indexOf(e)&&r.textures.push(e)}))}),this._assetContainer=null,r)).catch(e=>{throw this._assetContainer=null,e})}_parseSolidAsync(e,t,i,r){let n="",a=new rR,o=[],s=[];i=i.replace(/#.*$/gm,"").trim(),new rC(o,s,this._loadingOptions).parse(e,i,t,this._assetContainer,e=>{n=e});let l=[];return""===n||this._loadingOptions.skipMaterials||l.push(new Promise((e,i)=>{this._loadMTL(n,r,l=>{try{a.parseMTL(t,l,r,this._assetContainer);for(let e=0;e<a.materials.length;e++){let t,i=0,r=[];for(;(t=o.indexOf(a.materials[e].name,i))>-1;)r.push(t),i=t+1;if(-1===t&&0===r.length)a.materials[e].dispose();else for(let t=0;t<r.length;t++){let i=s[r[t]],n=a.materials[e];i.material=n,i.getTotalIndices()||(n.pointsCloud=!0)}}e()}catch(t){D.S0.Warn(`Error processing MTL file: '${n}'`),this._loadingOptions.materialLoadingFailsSilently?e():i(t)}},(t,r)=>{D.S0.Warn(`Error downloading MTL file: '${n}'`),this._loadingOptions.materialLoadingFailsSilently?e():i(r)})})),Promise.all(l).then(()=>{let e=e=>!!e._internalMetadata?._isLine;return s.forEach(i=>{if(e(i)){let r=i.material??new em.F(i.name+"_line",t);r.getBindedMeshes().filter(t=>!e(t)).length>0&&(r=r.clone(r.name+"_line")??r),r.wireframe=!0,i.material=r,i._internalMetadata&&(i._internalMetadata._isLine=void 0)}}),s})}}rb.OPTIMIZE_WITH_UV=!0,rb.INVERT_Y=!1,rb.IMPORT_VERTEX_COLORS=!1,rb.COMPUTE_NORMALS=!1,rb.OPTIMIZE_NORMALS=!1,rb.UV_SCALING=new N.I9(1,1),rb.SKIP_MATERIALS=!1,rb.MATERIAL_LOADING_FAILS_SILENTLY=!0,rb.USE_LEGACY_BEHAVIOR=!1,(0,H.qS)(new rb);let ry={".stl":{isBinary:!0}};class rL{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name="stl",this.extensions=ry}importMesh(e,t,i,r,n){let a;if("string"!=typeof i){if(this._isBinary(i)){let e=new ex.e("stlmesh",t);return this._parseBinary(e,i),n&&n.push(e),!0}i=new TextDecoder().decode(new Uint8Array(i))}for(;a=this.solidPattern.exec(i);){let i=a[1],r=a[3];if(r&&i!=r)return D.S0.Error("Error in STL, solid name != endsolid name"),!1;if(e&&i){if(e instanceof Array){if(!e.indexOf(i))continue}else if(i!==e)continue}i=i||"stlmesh";let o=new ex.e(i,t);this._parseASCII(o,a[2]),n&&n.push(o)}return!0}load(e,t,i){return this.importMesh(null,e,t,i,null)}loadAssetContainer(e,t,i){let r=new W.WZ(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,i,r.meshes),e._blockEntityCollection=!1,r}_isBinary(e){let t=new DataView(e);if(t.byteLength<=80)return!1;if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;let i=[115,111,108,105,100];for(let e=0;e<5;e++)if(t.getUint8(e)!==i[e])return!0;return!1}_parseBinary(e,t){let i=new DataView(t),r=i.getUint32(80,!0),n=0,a=new Float32Array(3*r*3),o=new Float32Array(3*r*3),s=new Uint32Array(3*r),l=0;for(let e=0;e<r;e++){let t=84+50*e,r=i.getFloat32(t,!0),c=i.getFloat32(t+4,!0),f=i.getFloat32(t+8,!0);for(let e=1;e<=3;e++){let s=t+12*e;a[n]=i.getFloat32(s,!0),o[n]=r,rL.DO_NOT_ALTER_FILE_COORDINATES?(a[n+1]=i.getFloat32(s+4,!0),a[n+2]=i.getFloat32(s+8,!0),o[n+1]=c,o[n+2]=f):(a[n+2]=i.getFloat32(s+4,!0),a[n+1]=i.getFloat32(s+8,!0),o[n+2]=c,o[n+1]=f),n+=3}rL.DO_NOT_ALTER_FILE_COORDINATES?(s[l]=l,s[l+1]=l+2,s[l+2]=l+1,l+=3):(s[l]=l++,s[l]=l++,s[l]=l++)}e.setVerticesData(eS.R.PositionKind,a),e.setVerticesData(eS.R.NormalKind,o),e.setIndices(s),e.computeWorldMatrix(!0)}_parseASCII(e,t){let i,r=[],n=[],a=[],o=0;for(;i=this.facetsPattern.exec(t);){let e,t=i[1],s=this.normalPattern.exec(t);if(this.normalPattern.lastIndex=0,!s)continue;let l=[Number(s[1]),Number(s[5]),Number(s[3])];for(;e=this.vertexPattern.exec(t);)rL.DO_NOT_ALTER_FILE_COORDINATES?(r.push(Number(e[1]),Number(e[3]),Number(e[5])),n.push(l[0],l[2],l[1])):(r.push(Number(e[1]),Number(e[5]),Number(e[3])),n.push(l[0],l[1],l[2]));rL.DO_NOT_ALTER_FILE_COORDINATES?(a.push(o,o+2,o+1),o+=3):a.push(o++,o++,o++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(eS.R.PositionKind,r),e.setVerticesData(eS.R.NormalKind,n),e.setIndices(a),e.computeWorldMatrix(!0)}}rL.DO_NOT_ALTER_FILE_COORDINATES=!1,(0,H.qS)(new rL);let rM="splat",rP={".splat":{isBinary:!0},".ply":{isBinary:!0},".spz":{isBinary:!0},".json":{isBinary:!1},".sog":{isBinary:!0}};var rN=i(60769),rD=i(13436),rO=i(49145);async function rF(e,t,i){let r=new Promise((r,n)=>{let a=i.createCanvasImage();if(!a)throw Error("Failed to create ImageBitmap");if(a.onload=()=>{try{let e=i.createCanvas(a.width,a.height);if(!e)throw Error("Failed to create canvas");let t=e.getContext("2d");if(!t)throw Error("Failed to get 2D context");t.drawImage(a,0,0);let n=t.getImageData(0,0,e.width,e.height);r({bits:new Uint8Array(n.data.buffer),width:n.width})}catch(e){n(`Error loading image ${a.src} with exception: ${e}`)}},a.onerror=e=>{n(`Error loading image ${a.src} with exception: ${e}`)},a.crossOrigin="anonymous","string"==typeof e){if(!t)throw Error("filename is required when using a URL");a.src=e+t}else{let t=new Blob([e],{type:"image/webp"});a.src=URL.createObjectURL(t)}});return await r}async function rw(e,t,i){let r=e.count?e.count:e.means.shape[0],n=new ArrayBuffer(32*r),a=new Float32Array(n),o=new Float32Array(n),s=new Uint8ClampedArray(n),l=new Uint8ClampedArray(n),c=e=>Math.sign(e)*(Math.exp(Math.abs(e))-1),f=t[0].bits,u=t[1].bits;if(!Array.isArray(e.means.mins)||!Array.isArray(e.means.maxs))throw Error("Missing arrays in SOG data.");for(let t=0;t<r;t++){let i=4*t;for(let r=0;r<3;r++){let n=e.means.mins[r],o=e.means.maxs[r],s=u[i+r]<<8|f[i+r],l=rO.X.Lerp(n,o,s/65535);a[8*t+r]=c(l)}}let d=t[2].bits;if(2===e.version){if(!e.scales.codebook)throw Error("Missing codebook in SOG version 2 scales data.");for(let t=0;t<r;t++){let i=4*t;for(let r=0;r<3;r++){let n=Math.exp(e.scales.codebook[d[i+r]]);o[8*t+3+r]=n}}}else{if(!Array.isArray(e.scales.mins)||!Array.isArray(e.scales.maxs))throw Error("Missing arrays in SOG scales data.");for(let t=0;t<r;t++){let i=4*t;for(let r=0;r<3;r++){let n=d[i+r],a=Math.exp(rO.X.Lerp(e.scales.mins[r],e.scales.maxs[r],n/255));o[8*t+3+r]=a}}}let h=t[4].bits;if(2===e.version){if(!e.sh0.codebook)throw Error("Missing codebook in SOG version 2 sh0 data.");for(let t=0;t<r;t++){let i=4*t;for(let r=0;r<3;r++){let n=.5+.28209479177387814*e.sh0.codebook[h[i+r]];s[32*t+24+r]=Math.max(0,Math.min(255,Math.round(255*n)))}s[32*t+24+3]=h[i+3]}}else{if(!Array.isArray(e.sh0.mins)||!Array.isArray(e.sh0.maxs))throw Error("Missing arrays in SOG sh0 data.");for(let t=0;t<r;t++){let i=4*t;for(let r=0;r<4;r++){let n,a=e.sh0.mins[r],o=e.sh0.maxs[r],l=h[i+r],c=rO.X.Lerp(a,o,l/255);n=r<3?.5+.28209479177387814*c:1/(1+Math.exp(-c)),s[32*t+24+r]=Math.max(0,Math.min(255,Math.round(255*n)))}}}let p=e=>(e/255-.5)*2/Math.SQRT2,m=t[3].bits;for(let e=0;e<r;e++){let t,i=m[4*e+0],r=m[4*e+1],n=m[4*e+2],a=m[4*e+3],o=p(i),s=p(r),c=p(n),f=Math.sqrt(Math.max(0,1-(o*o+s*s+c*c)));switch(a-252){case 0:t=[f,o,s,c];break;case 1:t=[o,f,s,c];break;case 2:t=[o,s,f,c];break;case 3:t=[o,s,c,f];break;default:throw Error("Invalid quaternion mode")}l[32*e+28+0]=127.5*t[0]+127.5,l[32*e+28+1]=127.5*t[1]+127.5,l[32*e+28+2]=127.5*t[2]+127.5,l[32*e+28+3]=127.5*t[3]+127.5}if(e.shN){let a=e.shN.bands?[0,3,8,15][e.shN.bands]:e.shN.shape[1]/3,o=t[5].bits,s=t[6].bits,l=t[5].width,c=Math.ceil(3*a/16),f=[],u=i.getEngine().getCaps().maxTextureSize,d=Math.ceil(r/u);for(let e=0;e<c;e++){let e=new Uint8Array(d*u*16);f.push(e)}if(2===e.version){if(!e.shN.codebook)throw Error("Missing codebook in SOG version 2 shN data.");for(let t=0;t<r;t++){let i=s[4*t+0]+(s[4*t+1]<<8),r=i%64*a,n=Math.floor(i/64);for(let i=0;i<a;i++)for(let a=0;a<3;a++){let s=3*i+a,c=f[Math.floor(s/16)],u=s%16,d=16*t,h=127.5*e.shN.codebook[o[(r+i)*4+a+n*l*4]]+127.5;c[u+d]=Math.max(0,Math.min(255,h))}}}else for(let t=0;t<r;t++){let i=s[4*t+0]+(s[4*t+1]<<8),r=i%64*a,n=Math.floor(i/64),c=e.shN.mins,u=e.shN.maxs;for(let e=0;e<3;e++)for(let i=0;i<a/3;i++){let a=3*i+e,s=f[Math.floor(a/16)],d=a%16,h=16*t,p=127.5*rO.X.Lerp(c,u,o[(r+i)*4+e+n*l*4]/255)+127.5;s[d+h]=Math.max(0,Math.min(255,p))}}return await new Promise(e=>{e({mode:0,data:n,hasVertexColors:!1,sh:f})})}return await new Promise(e=>{e({mode:0,data:n,hasVertexColors:!1})})}async function rB(e,t,i){let r,n;if(e instanceof Map){let t=(n=e).get("meta.json");if(!t)throw Error("meta.json not found in files Map");r=JSON.parse(new TextDecoder().decode(t))}else r=e;let a=[...r.means.files,...r.scales.files,...r.quats.files,...r.sh0.files];r.shN&&a.push(...r.shN.files);let o=await Promise.all(a.map(async e=>{if(!(n&&n.has(e)))return await rF(t,e,i.getEngine());{let t=n.get(e);return await rF(t,e,i.getEngine())}}));return await rw(r,o,i)}class rU{constructor(e=rU._DefaultLoadingOptions){this.name=rM,this._assetContainer=null,this.extensions=rP,this._loadingOptions=e}createPlugin(e){return new rU(e[rM])}async importMeshAsync(e,t,i,r,n,a){return await this._parseAsync(e,t,i,r).then(e=>({meshes:e,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}static _BuildPointCloud(e,t){if(!t.byteLength)return!1;let i=new Uint8Array(t),r=new Float32Array(t),n=i.length/32;return e.addPoints(n,function(e,t){let n=r[8*t+0],a=r[8*t+1],o=r[8*t+2];e.position=new N.Pq(n,a,o);let s=i[32*t+24+0]/255,l=i[32*t+24+1]/255,c=i[32*t+24+2]/255;e.color=new ec.ov(s,l,c,1)}),!0}static _BuildMesh(e,t){let i=new ex.e("PLYMesh",e),r=new Uint8Array(t.data),n=new Float32Array(t.data),a=r.length/32,o=[],s=new ev.P;for(let e=0;e<a;e++){let t=n[8*e+0],i=n[8*e+1],r=n[8*e+2];o.push(t,i,r)}if(t.hasVertexColors){let e=new Float32Array(4*a);for(let t=0;t<a;t++){let i=r[32*t+24+0]/255,n=r[32*t+24+1]/255,a=r[32*t+24+2]/255;e[4*t+0]=i,e[4*t+1]=n,e[4*t+2]=a,e[4*t+3]=1}s.colors=e}return s.positions=o,s.indices=t.faces,s.applyToMesh(i),i}async _unzipWithFFlateAsync(e){let t=this._loadingOptions.fflate;t||(void 0===window.fflate&&await D.S0.LoadScriptAsync(this._loadingOptions.deflateURL??"https://unpkg.com/fflate/umd/index.js"),t=window.fflate);let{unzipSync:i}=t,r=i(e),n=new Map;for(let[e,t]of Object.entries(r))n.set(e,t);return n}_parseAsync(e,t,i,r){let n=[],a=e=>{t._blockEntityCollection=!!this._assetContainer;let i=new rN.t("GaussianSplatting",null,t,this._loadingOptions.keepInRam);i._parentContainer=this._assetContainer,i.viewDirectionFactor.set(1,-1,1),n.push(i),i.updateData(e.data,e.sh),t._blockEntityCollection=!1};if("string"==typeof i){let e=JSON.parse(i);if(e&&e.means&&e.scales&&e.quats&&e.sh0)return new Promise(i=>{rB(e,r,t).then(e=>{a(e),i(n)}).catch(()=>{throw Error("Failed to parse SOG data.")})})}let o=i instanceof ArrayBuffer?new Uint8Array(i):i;if(80===o[0]&&75===o[1])return new Promise(e=>{this._unzipWithFFlateAsync(o).then(i=>{rB(i,r,t).then(t=>{a(t),e(n)}).catch(()=>{throw Error("Failed to parse SOG zip data.")})})});let s=new ReadableStream({start(e){e.enqueue(new Uint8Array(i)),e.close()}}),l=new DecompressionStream("gzip"),c=s.pipeThrough(l);return new Promise(e=>{new Response(c).arrayBuffer().then(i=>{(function(e,t,i){let r=new Uint8Array(e),n=new Uint32Array(e.slice(0,12)),a=n[2],o=r[12],s=r[13],l=r[14],c=r[15],f=n[1];if(c||0x5053474e!=n[0]||2!=f&&3!=f)return new Promise(e=>{e({mode:3,data:u,hasVertexColors:!1})});let u=new ArrayBuffer(32*a),d=1/(1<<s),h=new Int32Array(1),p=new Uint8Array(h.buffer),m=function(e,t){return p[0]=e[t+0],p[1]=e[t+1],p[2]=e[t+2],p[3]=128&e[t+2]?255:0,h[0]*d},_=16,g=new Float32Array(u),v=new Float32Array(u),S=new Uint8ClampedArray(u),E=new Uint8ClampedArray(u),T=1,A=0;i.flipY||(T=-1,A=255);for(let e=0;e<a;e++)g[8*e+0]=m(r,_+0),g[8*e+1]=T*m(r,_+3),g[8*e+2]=T*m(r,_+6),_+=9;for(let e=0;e<a;e++){for(let t=0;t<3;t++){let i=(r[_+a+3*e+t]-127.5)/38.25;S[32*e+24+t]=rO.X.Clamp((.5+.282*i)*255,0,255)}S[32*e+24+3]=r[_+e]}_+=4*a;for(let e=0;e<a;e++)v[8*e+3+0]=Math.exp(r[_+0]/16-10),v[8*e+3+1]=Math.exp(r[_+1]/16-10),v[8*e+3+2]=Math.exp(r[_+2]/16-10),_+=3;if(f>=3){let e=Math.SQRT1_2;for(let t=0;t<a;t++){let i=[r[_+0],r[_+1],r[_+2],r[_+3]],n=i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24),a=[],o=n>>>30,s=n,l=0;for(let t=3;t>=0;--t)if(t!==o){let i=511&s,r=s>>>9&1;s>>>=10,a[t]=i/511*e,1===r&&(a[t]=-a[t]),l+=a[t]*a[t]}let c=1-l;a[o]=Math.sqrt(Math.max(c,0)),a[1]*=T,a[2]*=T;let f=[3,0,1,2];for(let e=0;e<4;e++)E[32*t+28+e]=Math.round(127.5+127.5*a[f[e]]);_+=4}}else for(let e=0;e<a;e++){let t=r[_+0],i=r[_+1]*T+A,n=r[_+2]*T+A,a=t/127.5-1,o=i/127.5-1,s=n/127.5-1;E[32*e+28+1]=t,E[32*e+28+2]=i,E[32*e+28+3]=n;let l=1-(a*a+o*o+s*s);E[32*e+28+0]=127.5+127.5*Math.sqrt(l<0?0:l),_+=3}if(o){let e=3*((o+1)*(o+1)-1),i=Math.ceil(e/16),n=_,s=[],c=t.getEngine().getCaps().maxTextureSize,f=Math.ceil(a/c);for(let e=0;e<i;e++){let e=new Uint8Array(f*c*16);s.push(e)}for(let t=0;t<a;t++)for(let i=0;i<e;i++){let e=r[n++];s[Math.floor(i/16)][i%16+16*t]=e}return new Promise(e=>{e({mode:0,data:u,hasVertexColors:!1,sh:s,trainedWithAntialiasing:!!l})})}return new Promise(e=>{e({mode:0,data:u,hasVertexColors:!1,trainedWithAntialiasing:!!l})})})(i,t,this._loadingOptions).then(i=>{t._blockEntityCollection=!!this._assetContainer;let r=new rN.t("GaussianSplatting",null,t,this._loadingOptions.keepInRam);if(i.trainedWithAntialiasing){let e=r.material;e.kernelSize=.1,e.compensation=!0}r._parentContainer=this._assetContainer,n.push(r),r.updateData(i.data,i.sh),t._blockEntityCollection=!1,e(n)})}).catch(()=>{rU._ConvertPLYToSplat(i).then(async i=>{switch(t._blockEntityCollection=!!this._assetContainer,i.mode){case 0:{let e=new rN.t("GaussianSplatting",null,t,this._loadingOptions.keepInRam);e._parentContainer=this._assetContainer,n.push(e),e.updateData(i.data,i.sh),(i.compressed||!i.rawSplat)&&e.viewDirectionFactor.set(-1,-1,1)}break;case 1:{let e=new rD.y("PointCloud",1,t);rU._BuildPointCloud(e,i.data)?await e.buildMeshAsync().then(e=>{n.push(e)}):e.dispose()}break;case 2:if(i.faces)n.push(rU._BuildMesh(t,i));else throw Error("PLY mesh doesn't contain face informations.");break;default:throw Error("Unsupported Splat mode")}t._blockEntityCollection=!1,e(n)})})})}loadAssetContainerAsync(e,t,i){let r=new W.WZ(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,i).then(e=>{for(let t of e.meshes)r.meshes.push(t);return this._assetContainer=null,r}).catch(e=>{throw this._assetContainer=null,e})}loadAsync(e,t,i){return this.importMeshAsync(null,e,t,i).then(()=>{})}static _ConvertPLYToSplat(e){var t;let i,r=new Uint8Array(e),n=new TextDecoder().decode(r.slice(0,10240)),a="end_header\n",o=n.indexOf(a);if(o<0||!n)return new Promise(t=>{t({mode:0,data:e,rawSplat:!0})});let s=parseInt(/element vertex (\d+)\n/.exec(n)[1]),l=/element face (\d+)\n/.exec(n),c=0;l&&(c=parseInt(l[1]));let f=/element chunk (\d+)\n/.exec(n),u=0;f&&(u=parseInt(f[1]));let d=0,h=0,p={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};(t=i||(i={}))[t.Vertex=0]="Vertex",t[t.Chunk=1]="Chunk",t[t.SH=2]="SH";let m=1,_=[],g=[];for(let e of n.slice(0,o).split("\n"))if(e.startsWith("property ")){let[,t,i]=e.split(" ");1==m?(g.push({name:i,type:t,offset:h}),h+=p[t]):0==m?(_.push({name:i,type:t,offset:d}),d+=p[t]):2==m&&_.push({name:i,type:t,offset:d}),p[t]||q.V.Warn(`Unsupported property type: ${t}.`)}else if(e.startsWith("element ")){let[,t]=e.split(" ");"chunk"==t?m=1:"vertex"==t?m=0:"sh"==t&&(m=2)}let v=d,S=h;return rN.t.ConvertPLYWithSHToSplatAsync(e).then(async t=>{let i=new DataView(e,o+a.length),r=S*u+v*s,n=[];if(c)for(let e=0;e<c;e++){let e=i.getUint8(r);if(3==e){r+=1;for(let t=0;t<e;t++){let e=i.getUint32(r+(2-t)*4,!0);n.push(e)}r+=12}}if(u)return await new Promise(e=>{e({mode:0,data:t.buffer,sh:t.sh,faces:n,hasVertexColors:!1,compressed:!0,rawSplat:!1})});let l=0,f=0,d=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],h=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let e=0;e<_.length;e++){let t=_[e];d.includes(t.name)&&l++,h.includes(t.name)&&f++}let p=l==d.length&&3==f,m=c?2:+!p;return await new Promise(e=>{e({mode:m,data:t.buffer,sh:t.sh,faces:n,hasVertexColors:!!f,compressed:!1,rawSplat:!1})})})}}rU._DefaultLoadingOptions={keepInRam:!1,flipY:!1},(0,H.qS)(new rU)},60617:function(e,t,i){function r(){}function n(e){return null==e?r:function(){return this.querySelector(e)}}function a(){return[]}function o(e){return null==e?a:function(){return this.querySelectorAll(e)}}function s(e){return function(){return this.matches(e)}}function l(e){return function(t){return t.matches(e)}}i.d(t,{rLf:()=>it,JLW:()=>t9,exT:()=>function e(){var t,i,r=(i=(t=(function(){var e,t,i,r,n,a=0,o=1,s=tS,l=!1;function c(t){return null==t||isNaN(t*=1)?n:s(0===i?.5:(t=(r(t)-e)*i,l?Math.max(0,Math.min(1,t)):t))}function f(e){return function(t){var i,r;return arguments.length?([i,r]=t,s=e(i,r),c):[s(0),s(1)]}}return c.domain=function(n){return arguments.length?([a,o]=n,e=r(a*=1),t=r(o*=1),i=e===t?0:1/(t-e),c):[a,o]},c.clamp=function(e){return arguments.length?(l=!!e,c):l},c.interpolator=function(e){return arguments.length?(s=e,c):s},c.range=f(function e(t,i){var r,n,a=typeof i;return null==i||"boolean"===a?te(i):("number"===a?ex:"string"===a?(n=e$(i))?(i=n,ti):to:i instanceof e$?ti:i instanceof Date?function(e,t){var i=new Date;return e*=1,t*=1,function(r){return i.setTime(e*(1-r)+t*r),i}}:!ArrayBuffer.isView(r=i)||r instanceof DataView?Array.isArray(i)?function(t,i){var r,n=i?i.length:0,a=t?Math.min(n,t.length):0,o=Array(a),s=Array(n);for(r=0;r<a;++r)o[r]=e(t[r],i[r]);for(;r<n;++r)s[r]=i[r];return function(e){for(r=0;r<a;++r)s[r]=o[r](e);return s}}:"function"!=typeof i.valueOf&&"function"!=typeof i.toString||isNaN(i)?function(t,i){var r,n={},a={};for(r in(null===t||"object"!=typeof t)&&(t={}),(null===i||"object"!=typeof i)&&(i={}),i)r in t?n[r]=e(t[r],i[r]):a[r]=i[r];return function(e){for(r in n)a[r]=n[r](e);return a}}:ex:function(e,t){t||(t=[]);var i,r=e?Math.min(t.length,e.length):0,n=t.slice();return function(a){for(i=0;i<r;++i)n[i]=e[i]*(1-a)+t[i]*a;return n}})(t,i)}),c.rangeRound=f(tv),c.unknown=function(e){return arguments.length?(n=e,c):n},function(n){return r=n,e=n(a),t=n(o),i=e===t?0:1/(t-e),c}})()(tS)).domain,t.ticks=function(e){var t=i();return function(e,t,i){if(t*=1,e*=1,!((i*=1)>0))return[];if(e===t)return[e];let r=t<e,[n,a,o]=r?tI(t,e,i):tI(e,t,i);if(!(a>=n))return[];let s=a-n+1,l=Array(s);if(r)if(o<0)for(let e=0;e<s;++e)l[e]=-((a-e)/o);else for(let e=0;e<s;++e)l[e]=(a-e)*o;else if(o<0)for(let e=0;e<s;++e)l[e]=-((n+e)/o);else for(let e=0;e<s;++e)l[e]=(n+e)*o;return l}(t[0],t[t.length-1],null==e?10:e)},t.tickFormat=function(e,t){var r=i();return function(e,t,i,r){let n,a;var o,s,l,c,f,u=(s=e,l=+t,s*=1,c=+i,a=(n=l<s)?tR(l,s,c):tR(s,l,c),(n?-1:1)*(a<0?-(1/a):a));switch((r=tb(null==r?",f":r)).type){case"s":var p=Math.max(Math.abs(e),Math.abs(t));return null!=r.precision||isNaN(f=Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(tM(p)/3)))-tM(Math.abs(u))))||(r.precision=f),h(r,p);case"":case"e":case"g":case"p":case"r":null!=r.precision||isNaN(f=Math.max(0,tM(Math.abs(Math.max(Math.abs(e),Math.abs(t)))-(o=Math.abs(o=u)))-tM(o))+1)||(r.precision=f-("e"===r.type));break;case"f":case"%":null!=r.precision||isNaN(f=Math.max(0,-tM(Math.abs(u))))||(r.precision=f-("%"===r.type)*2)}return d(r)}(r[0],r[r.length-1],null==e?10:e,t)},t.nice=function(e){null==e&&(e=10);var r,n,a=i(),o=0,s=a.length-1,l=a[o],c=a[s],f=10;for(c<l&&(n=l,l=c,c=n,n=o,o=s,s=n);f-- >0;){if((n=tR(l,c,e))===r)return a[o]=l,a[s]=c,i(a);if(n>0)l=Math.floor(l/n)*n,c=Math.ceil(c/n)*n;else if(n<0)l=Math.ceil(l*n)/n,c=Math.floor(c*n)/n;else break;r=n}return t},t);return r.copy=function(){return e().domain(r.domain()).interpolator(r.interpolator()).clamp(r.clamp()).unknown(r.unknown())},tE.apply(r,arguments)},GAA:()=>tU});var c,f,u,d,h,p=Array.prototype.find;function m(){return this.firstElementChild}var _=Array.prototype.filter;function g(){return Array.from(this.children)}function v(e){return Array(e.length)}function S(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}function E(e,t,i,r,n,a){for(var o,s=0,l=t.length,c=a.length;s<c;++s)(o=t[s])?(o.__data__=a[s],r[s]=o):i[s]=new S(e,a[s]);for(;s<l;++s)(o=t[s])&&(n[s]=o)}function T(e,t,i,r,n,a,o){var s,l,c,f=new Map,u=t.length,d=a.length,h=Array(u);for(s=0;s<u;++s)(l=t[s])&&(h[s]=c=o.call(l,l.__data__,s,t)+"",f.has(c)?n[s]=l:f.set(c,l));for(s=0;s<d;++s)c=o.call(e,a[s],s,a)+"",(l=f.get(c))?(r[s]=l,l.__data__=a[s],f.delete(c)):i[s]=new S(e,a[s]);for(s=0;s<u;++s)(l=t[s])&&f.get(h[s])===l&&(n[s]=l)}function A(e){return e.__data__}function x(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}S.prototype={constructor:S,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}};var I="http://www.w3.org/1999/xhtml";let R={svg:"http://www.w3.org/2000/svg",xhtml:I,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function C(e){var t=e+="",i=t.indexOf(":");return i>=0&&"xmlns"!==(t=e.slice(0,i))&&(e=e.slice(i+1)),R.hasOwnProperty(t)?{space:R[t],local:e}:e}function b(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function y(e,t){return e.style.getPropertyValue(t)||b(e).getComputedStyle(e,null).getPropertyValue(t)}function L(e){return e.trim().split(/^|\s+/)}function M(e){return e.classList||new P(e)}function P(e){this._node=e,this._names=L(e.getAttribute("class")||"")}function N(e,t){for(var i=M(e),r=-1,n=t.length;++r<n;)i.add(t[r])}function D(e,t){for(var i=M(e),r=-1,n=t.length;++r<n;)i.remove(t[r])}function O(){this.textContent=""}function F(){this.innerHTML=""}function w(){this.nextSibling&&this.parentNode.appendChild(this)}function B(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function U(e){var t=C(e);return(t.local?function(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}:function(e){return function(){var t=this.ownerDocument,i=this.namespaceURI;return i===I&&t.documentElement.namespaceURI===I?t.createElement(e):t.createElementNS(i,e)}})(t)}function G(){return null}function V(){var e=this.parentNode;e&&e.removeChild(this)}function k(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function z(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function H(e){return function(){var t=this.__on;if(t){for(var i,r=0,n=-1,a=t.length;r<a;++r)(i=t[r],e.type&&i.type!==e.type||i.name!==e.name)?t[++n]=i:this.removeEventListener(i.type,i.listener,i.options);++n?t.length=n:delete this.__on}}}function W(e,t,i){return function(){var r,n=this.__on,a=function(e){t.call(this,e,this.__data__)};if(n){for(var o=0,s=n.length;o<s;++o)if((r=n[o]).type===e.type&&r.name===e.name){this.removeEventListener(r.type,r.listener,r.options),this.addEventListener(r.type,r.listener=a,r.options=i),r.value=t;return}}this.addEventListener(e.type,a,i),r={type:e.type,name:e.name,value:t,listener:a,options:i},n?n.push(r):this.__on=[r]}}function X(e,t,i){var r=b(e),n=r.CustomEvent;"function"==typeof n?n=new n(t,i):(n=r.document.createEvent("Event"),i?(n.initEvent(t,i.bubbles,i.cancelable),n.detail=i.detail):n.initEvent(t,!1,!1)),e.dispatchEvent(n)}P.prototype={add:function(e){0>this._names.indexOf(e)&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};var Y=[null];function $(e,t){this._groups=e,this._parents=t}function q(){return new $([[document.documentElement]],Y)}$.prototype=q.prototype={constructor:$,select:function(e){"function"!=typeof e&&(e=n(e));for(var t=this._groups,i=t.length,r=Array(i),a=0;a<i;++a)for(var o,s,l=t[a],c=l.length,f=r[a]=Array(c),u=0;u<c;++u)(o=l[u])&&(s=e.call(o,o.__data__,u,l))&&("__data__"in o&&(s.__data__=o.__data__),f[u]=s);return new $(r,this._parents)},selectAll:function(e){if("function"==typeof e){var t;t=e,e=function(){var e;return e=t.apply(this,arguments),null==e?[]:Array.isArray(e)?e:Array.from(e)}}else e=o(e);for(var i=this._groups,r=i.length,n=[],a=[],s=0;s<r;++s)for(var l,c=i[s],f=c.length,u=0;u<f;++u)(l=c[u])&&(n.push(e.call(l,l.__data__,u,c)),a.push(l));return new $(n,a)},selectChild:function(e){var t;return this.select(null==e?m:(t="function"==typeof e?e:l(e),function(){return p.call(this.children,t)}))},selectChildren:function(e){var t;return this.selectAll(null==e?g:(t="function"==typeof e?e:l(e),function(){return _.call(this.children,t)}))},filter:function(e){"function"!=typeof e&&(e=s(e));for(var t=this._groups,i=t.length,r=Array(i),n=0;n<i;++n)for(var a,o=t[n],l=o.length,c=r[n]=[],f=0;f<l;++f)(a=o[f])&&e.call(a,a.__data__,f,o)&&c.push(a);return new $(r,this._parents)},data:function(e,t){if(!arguments.length)return Array.from(this,A);var i=t?T:E,r=this._parents,n=this._groups;"function"!=typeof e&&(v=e,e=function(){return v});for(var a=n.length,o=Array(a),s=Array(a),l=Array(a),c=0;c<a;++c){var f=r[c],u=n[c],d=u.length,h="object"==typeof(g=e.call(f,f&&f.__data__,c,r))&&"length"in g?g:Array.from(g),p=h.length,m=s[c]=Array(p),_=o[c]=Array(p);i(f,u,m,_,l[c]=Array(d),h,t);for(var g,v,S,x,I=0,R=0;I<p;++I)if(S=m[I]){for(I>=R&&(R=I+1);!(x=_[R])&&++R<p;);S._next=x||null}}return(o=new $(o,r))._enter=s,o._exit=l,o},enter:function(){return new $(this._enter||this._groups.map(v),this._parents)},exit:function(){return new $(this._exit||this._groups.map(v),this._parents)},join:function(e,t,i){var r=this.enter(),n=this,a=this.exit();return"function"==typeof e?(r=e(r))&&(r=r.selection()):r=r.append(e+""),null!=t&&(n=t(n))&&(n=n.selection()),null==i?a.remove():i(a),r&&n?r.merge(n).order():n},merge:function(e){for(var t=e.selection?e.selection():e,i=this._groups,r=t._groups,n=i.length,a=r.length,o=Math.min(n,a),s=Array(n),l=0;l<o;++l)for(var c,f=i[l],u=r[l],d=f.length,h=s[l]=Array(d),p=0;p<d;++p)(c=f[p]||u[p])&&(h[p]=c);for(;l<n;++l)s[l]=i[l];return new $(s,this._parents)},selection:function(){return this},order:function(){for(var e=this._groups,t=-1,i=e.length;++t<i;)for(var r,n=e[t],a=n.length-1,o=n[a];--a>=0;)(r=n[a])&&(o&&4^r.compareDocumentPosition(o)&&o.parentNode.insertBefore(r,o),o=r);return this},sort:function(e){function t(t,i){return t&&i?e(t.__data__,i.__data__):!t-!i}e||(e=x);for(var i=this._groups,r=i.length,n=Array(r),a=0;a<r;++a){for(var o,s=i[a],l=s.length,c=n[a]=Array(l),f=0;f<l;++f)(o=s[f])&&(c[f]=o);c.sort(t)}return new $(n,this._parents).order()},call:function(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var e=this._groups,t=0,i=e.length;t<i;++t)for(var r=e[t],n=0,a=r.length;n<a;++n){var o=r[n];if(o)return o}return null},size:function(){let e=0;for(let t of this)++e;return e},empty:function(){return!this.node()},each:function(e){for(var t=this._groups,i=0,r=t.length;i<r;++i)for(var n,a=t[i],o=0,s=a.length;o<s;++o)(n=a[o])&&e.call(n,n.__data__,o,a);return this},attr:function(e,t){var i=C(e);if(arguments.length<2){var r=this.node();return i.local?r.getAttributeNS(i.space,i.local):r.getAttribute(i)}return this.each((null==t?i.local?function(e){return function(){this.removeAttributeNS(e.space,e.local)}}:function(e){return function(){this.removeAttribute(e)}}:"function"==typeof t?i.local?function(e,t){return function(){var i=t.apply(this,arguments);null==i?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,i)}}:function(e,t){return function(){var i=t.apply(this,arguments);null==i?this.removeAttribute(e):this.setAttribute(e,i)}}:i.local?function(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}:function(e,t){return function(){this.setAttribute(e,t)}})(i,t))},style:function(e,t,i){return arguments.length>1?this.each((null==t?function(e){return function(){this.style.removeProperty(e)}}:"function"==typeof t?function(e,t,i){return function(){var r=t.apply(this,arguments);null==r?this.style.removeProperty(e):this.style.setProperty(e,r,i)}}:function(e,t,i){return function(){this.style.setProperty(e,t,i)}})(e,t,null==i?"":i)):y(this.node(),e)},property:function(e,t){return arguments.length>1?this.each((null==t?function(e){return function(){delete this[e]}}:"function"==typeof t?function(e,t){return function(){var i=t.apply(this,arguments);null==i?delete this[e]:this[e]=i}}:function(e,t){return function(){this[e]=t}})(e,t)):this.node()[e]},classed:function(e,t){var i=L(e+"");if(arguments.length<2){for(var r=M(this.node()),n=-1,a=i.length;++n<a;)if(!r.contains(i[n]))return!1;return!0}return this.each(("function"==typeof t?function(e,t){return function(){(t.apply(this,arguments)?N:D)(this,e)}}:t?function(e){return function(){N(this,e)}}:function(e){return function(){D(this,e)}})(i,t))},text:function(e){return arguments.length?this.each(null==e?O:("function"==typeof e?function(e){return function(){var t=e.apply(this,arguments);this.textContent=null==t?"":t}}:function(e){return function(){this.textContent=e}})(e)):this.node().textContent},html:function(e){return arguments.length?this.each(null==e?F:("function"==typeof e?function(e){return function(){var t=e.apply(this,arguments);this.innerHTML=null==t?"":t}}:function(e){return function(){this.innerHTML=e}})(e)):this.node().innerHTML},raise:function(){return this.each(w)},lower:function(){return this.each(B)},append:function(e){var t="function"==typeof e?e:U(e);return this.select(function(){return this.appendChild(t.apply(this,arguments))})},insert:function(e,t){var i="function"==typeof e?e:U(e),r=null==t?G:"function"==typeof t?t:n(t);return this.select(function(){return this.insertBefore(i.apply(this,arguments),r.apply(this,arguments)||null)})},remove:function(){return this.each(V)},clone:function(e){return this.select(e?z:k)},datum:function(e){return arguments.length?this.property("__data__",e):this.node().__data__},on:function(e,t,i){var r,n,a=(e+"").trim().split(/^|\s+/).map(function(e){var t="",i=e.indexOf(".");return i>=0&&(t=e.slice(i+1),e=e.slice(0,i)),{type:e,name:t}}),o=a.length;if(arguments.length<2){var s=this.node().__on;if(s){for(var l,c=0,f=s.length;c<f;++c)for(r=0,l=s[c];r<o;++r)if((n=a[r]).type===l.type&&n.name===l.name)return l.value}return}for(r=0,s=t?W:H;r<o;++r)this.each(s(a[r],t,i));return this},dispatch:function(e,t){return this.each(("function"==typeof t?function(e,t){return function(){return X(this,e,t.apply(this,arguments))}}:function(e,t){return function(){return X(this,e,t)}})(e,t))},[Symbol.iterator]:function*(){for(var e=this._groups,t=0,i=e.length;t<i;++t)for(var r,n=e[t],a=0,o=n.length;a<o;++a)(r=n[a])&&(yield r)}};var Z={value:()=>{}};function j(){for(var e,t=0,i=arguments.length,r={};t<i;++t){if(!(e=arguments[t]+"")||e in r||/[\s.]/.test(e))throw Error("illegal type: "+e);r[e]=[]}return new K(r)}function K(e){this._=e}function Q(e,t,i){for(var r=0,n=e.length;r<n;++r)if(e[r].name===t){e[r]=Z,e=e.slice(0,r).concat(e.slice(r+1));break}return null!=i&&e.push({name:t,value:i}),e}K.prototype=j.prototype={constructor:K,on:function(e,t){var i,r=this._,n=(e+"").trim().split(/^|\s+/).map(function(e){var t="",i=e.indexOf(".");if(i>=0&&(t=e.slice(i+1),e=e.slice(0,i)),e&&!r.hasOwnProperty(e))throw Error("unknown type: "+e);return{type:e,name:t}}),a=-1,o=n.length;if(arguments.length<2){for(;++a<o;)if((i=(e=n[a]).type)&&(i=function(e,t){for(var i,r=0,n=e.length;r<n;++r)if((i=e[r]).name===t)return i.value}(r[i],e.name)))return i;return}if(null!=t&&"function"!=typeof t)throw Error("invalid callback: "+t);for(;++a<o;)if(i=(e=n[a]).type)r[i]=Q(r[i],e.name,t);else if(null==t)for(i in r)r[i]=Q(r[i],e.name,null);return this},copy:function(){var e={},t=this._;for(var i in t)e[i]=t[i].slice();return new K(e)},call:function(e,t){if((i=arguments.length-2)>0)for(var i,r,n=Array(i),a=0;a<i;++a)n[a]=arguments[a+2];if(!this._.hasOwnProperty(e))throw Error("unknown type: "+e);for(r=this._[e],a=0,i=r.length;a<i;++a)r[a].value.apply(t,n)},apply:function(e,t,i){if(!this._.hasOwnProperty(e))throw Error("unknown type: "+e);for(var r=this._[e],n=0,a=r.length;n<a;++n)r[n].value.apply(t,i)}};var J,ee,et=0,ei=0,er=0,en=0,ea=0,eo=0,es="object"==typeof performance&&performance.now?performance:Date,el="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function ec(){return ea||(el(ef),ea=es.now()+eo)}function ef(){ea=0}function eu(){this._call=this._time=this._next=null}function ed(e,t,i){var r=new eu;return r.restart(e,t,i),r}function eh(){ea=(en=es.now())+eo,et=ei=0;try{ec(),++et;for(var e,t=J;t;)(e=ea-t._time)>=0&&t._call.call(void 0,e),t=t._next;--et}finally{et=0,function(){for(var e,t,i=J,r=1/0;i;)i._call?(r>i._time&&(r=i._time),e=i,i=i._next):(t=i._next,i._next=null,i=e?e._next=t:J=t);ee=e,em(r)}(),ea=0}}function ep(){var e=es.now(),t=e-en;t>1e3&&(eo-=t,en=e)}function em(e){!et&&(ei&&(ei=clearTimeout(ei)),e-ea>24?(e<1/0&&(ei=setTimeout(eh,e-es.now()-eo)),er&&(er=clearInterval(er))):(er||(en=es.now(),er=setInterval(ep,1e3)),et=1,el(eh)))}function e_(e,t,i){var r=new eu;return t=null==t?0:+t,r.restart(i=>{r.stop(),e(i+t)},t,i),r}eu.prototype=ed.prototype={constructor:eu,restart:function(e,t,i){if("function"!=typeof e)throw TypeError("callback is not a function");i=(null==i?ec():+i)+(null==t?0:+t),this._next||ee===this||(ee?ee._next=this:J=this,ee=this),this._call=e,this._time=i,em()},stop:function(){this._call&&(this._call=null,this._time=1/0,em())}};var eg=j("start","end","cancel","interrupt"),ev=[];function eS(e,t,i,r,n,a){var o=e.__transition;if(o){if(i in o)return}else e.__transition={};!function(e,t,i){var r,n=e.__transition;function a(l){var c,f,u,d;if(1!==i.state)return s();for(c in n)if((d=n[c]).name===i.name){if(3===d.state)return e_(a);4===d.state?(d.state=6,d.timer.stop(),d.on.call("interrupt",e,e.__data__,d.index,d.group),delete n[c]):+c<t&&(d.state=6,d.timer.stop(),d.on.call("cancel",e,e.__data__,d.index,d.group),delete n[c])}if(e_(function(){3===i.state&&(i.state=4,i.timer.restart(o,i.delay,i.time),o(l))}),i.state=2,i.on.call("start",e,e.__data__,i.index,i.group),2===i.state){for(c=0,i.state=3,r=Array(u=i.tween.length),f=-1;c<u;++c)(d=i.tween[c].value.call(e,e.__data__,i.index,i.group))&&(r[++f]=d);r.length=f+1}}function o(t){for(var n=t<i.duration?i.ease.call(null,t/i.duration):(i.timer.restart(s),i.state=5,1),a=-1,o=r.length;++a<o;)r[a].call(e,n);5===i.state&&(i.on.call("end",e,e.__data__,i.index,i.group),s())}function s(){for(var r in i.state=6,i.timer.stop(),delete n[t],n)return;delete e.__transition}n[t]=i,i.timer=ed(function(e){i.state=1,i.timer.restart(a,i.delay,i.time),i.delay<=e&&a(e-i.delay)},0,i.time)}(e,i,{name:t,index:r,group:n,on:eg,tween:ev,time:a.time,delay:a.delay,duration:a.duration,ease:a.ease,timer:null,state:0})}function eE(e,t){var i=eA(e,t);if(i.state>0)throw Error("too late; already scheduled");return i}function eT(e,t){var i=eA(e,t);if(i.state>3)throw Error("too late; already running");return i}function eA(e,t){var i=e.__transition;if(!i||!(i=i[t]))throw Error("transition not found");return i}function ex(e,t){return e*=1,t*=1,function(i){return e*(1-i)+t*i}}var eI=180/Math.PI,eR={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function eC(e,t,i,r,n,a){var o,s,l;return(o=Math.sqrt(e*e+t*t))&&(e/=o,t/=o),(l=e*i+t*r)&&(i-=e*l,r-=t*l),(s=Math.sqrt(i*i+r*r))&&(i/=s,r/=s,l/=s),e*r<t*i&&(e=-e,t=-t,l=-l,o=-o),{translateX:n,translateY:a,rotate:Math.atan2(t,e)*eI,skewX:Math.atan(l)*eI,scaleX:o,scaleY:s}}function eb(e,t,i,r){function n(e){return e.length?e.pop()+" ":""}return function(a,o){var s,l,c,f,u=[],d=[];return a=e(a),o=e(o),!function(e,r,n,a,o,s){if(e!==n||r!==a){var l=o.push("translate(",null,t,null,i);s.push({i:l-4,x:ex(e,n)},{i:l-2,x:ex(r,a)})}else(n||a)&&o.push("translate("+n+t+a+i)}(a.translateX,a.translateY,o.translateX,o.translateY,u,d),s=a.rotate,l=o.rotate,s!==l?(s-l>180?l+=360:l-s>180&&(s+=360),d.push({i:u.push(n(u)+"rotate(",null,r)-2,x:ex(s,l)})):l&&u.push(n(u)+"rotate("+l+r),c=a.skewX,f=o.skewX,c!==f?d.push({i:u.push(n(u)+"skewX(",null,r)-2,x:ex(c,f)}):f&&u.push(n(u)+"skewX("+f+r),!function(e,t,i,r,a,o){if(e!==i||t!==r){var s=a.push(n(a)+"scale(",null,",",null,")");o.push({i:s-4,x:ex(e,i)},{i:s-2,x:ex(t,r)})}else(1!==i||1!==r)&&a.push(n(a)+"scale("+i+","+r+")")}(a.scaleX,a.scaleY,o.scaleX,o.scaleY,u,d),a=o=null,function(e){for(var t,i=-1,r=d.length;++i<r;)u[(t=d[i]).i]=t.x(e);return u.join("")}}}var ey=eb(function(e){let t=new("function"==typeof DOMMatrix?DOMMatrix:WebKitCSSMatrix)(e+"");return t.isIdentity?eR:eC(t.a,t.b,t.c,t.d,t.e,t.f)},"px, ","px)","deg)"),eL=eb(function(e){return null==e?eR:(c||(c=document.createElementNS("http://www.w3.org/2000/svg","g")),c.setAttribute("transform",e),e=c.transform.baseVal.consolidate())?eC((e=e.matrix).a,e.b,e.c,e.d,e.e,e.f):eR},", ",")",")");function eM(e,t,i){var r=e._id;return e.each(function(){var e=eT(this,r);(e.value||(e.value={}))[t]=i.apply(this,arguments)}),function(e){return eA(e,r).value[t]}}function eP(e,t,i){e.prototype=t.prototype=i,i.constructor=e}function eN(e,t){var i=Object.create(e.prototype);for(var r in t)i[r]=t[r];return i}function eD(){}var eO="\\s*([+-]?\\d+)\\s*",eF="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",ew="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",eB=/^#([0-9a-f]{3,8})$/,eU=RegExp(`^rgb\\(${eO},${eO},${eO}\\)$`),eG=RegExp(`^rgb\\(${ew},${ew},${ew}\\)$`),eV=RegExp(`^rgba\\(${eO},${eO},${eO},${eF}\\)$`),ek=RegExp(`^rgba\\(${ew},${ew},${ew},${eF}\\)$`),ez=RegExp(`^hsl\\(${eF},${ew},${ew}\\)$`),eH=RegExp(`^hsla\\(${eF},${ew},${ew},${eF}\\)$`),eW={aliceblue:0xf0f8ff,antiquewhite:0xfaebd7,aqua:65535,aquamarine:8388564,azure:0xf0ffff,beige:0xf5f5dc,bisque:0xffe4c4,black:0,blanchedalmond:0xffebcd,blue:255,blueviolet:9055202,brown:0xa52a2a,burlywood:0xdeb887,cadetblue:6266528,chartreuse:8388352,chocolate:0xd2691e,coral:0xff7f50,cornflowerblue:6591981,cornsilk:0xfff8dc,crimson:0xdc143c,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:0xb8860b,darkgray:0xa9a9a9,darkgreen:25600,darkgrey:0xa9a9a9,darkkhaki:0xbdb76b,darkmagenta:9109643,darkolivegreen:5597999,darkorange:0xff8c00,darkorchid:0x9932cc,darkred:9109504,darksalmon:0xe9967a,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:0xff1493,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:0xb22222,floralwhite:0xfffaf0,forestgreen:2263842,fuchsia:0xff00ff,gainsboro:0xdcdcdc,ghostwhite:0xf8f8ff,gold:0xffd700,goldenrod:0xdaa520,gray:8421504,green:32768,greenyellow:0xadff2f,grey:8421504,honeydew:0xf0fff0,hotpink:0xff69b4,indianred:0xcd5c5c,indigo:4915330,ivory:0xfffff0,khaki:0xf0e68c,lavender:0xe6e6fa,lavenderblush:0xfff0f5,lawngreen:8190976,lemonchiffon:0xfffacd,lightblue:0xadd8e6,lightcoral:0xf08080,lightcyan:0xe0ffff,lightgoldenrodyellow:0xfafad2,lightgray:0xd3d3d3,lightgreen:9498256,lightgrey:0xd3d3d3,lightpink:0xffb6c1,lightsalmon:0xffa07a,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:0xb0c4de,lightyellow:0xffffe0,lime:65280,limegreen:3329330,linen:0xfaf0e6,magenta:0xff00ff,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:0xba55d3,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:0xc71585,midnightblue:1644912,mintcream:0xf5fffa,mistyrose:0xffe4e1,moccasin:0xffe4b5,navajowhite:0xffdead,navy:128,oldlace:0xfdf5e6,olive:8421376,olivedrab:7048739,orange:0xffa500,orangered:0xff4500,orchid:0xda70d6,palegoldenrod:0xeee8aa,palegreen:0x98fb98,paleturquoise:0xafeeee,palevioletred:0xdb7093,papayawhip:0xffefd5,peachpuff:0xffdab9,peru:0xcd853f,pink:0xffc0cb,plum:0xdda0dd,powderblue:0xb0e0e6,purple:8388736,rebeccapurple:6697881,red:0xff0000,rosybrown:0xbc8f8f,royalblue:4286945,saddlebrown:9127187,salmon:0xfa8072,sandybrown:0xf4a460,seagreen:3050327,seashell:0xfff5ee,sienna:0xa0522d,silver:0xc0c0c0,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:0xfffafa,springgreen:65407,steelblue:4620980,tan:0xd2b48c,teal:32896,thistle:0xd8bfd8,tomato:0xff6347,turquoise:4251856,violet:0xee82ee,wheat:0xf5deb3,white:0xffffff,whitesmoke:0xf5f5f5,yellow:0xffff00,yellowgreen:0x9acd32};function eX(){return this.rgb().formatHex()}function eY(){return this.rgb().formatRgb()}function e$(e){var t,i;return e=(e+"").trim().toLowerCase(),(t=eB.exec(e))?(i=t[1].length,t=parseInt(t[1],16),6===i?eq(t):3===i?new eK(t>>8&15|t>>4&240,t>>4&15|240&t,(15&t)<<4|15&t,1):8===i?eZ(t>>24&255,t>>16&255,t>>8&255,(255&t)/255):4===i?eZ(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|240&t,((15&t)<<4|15&t)/255):null):(t=eU.exec(e))?new eK(t[1],t[2],t[3],1):(t=eG.exec(e))?new eK(255*t[1]/100,255*t[2]/100,255*t[3]/100,1):(t=eV.exec(e))?eZ(t[1],t[2],t[3],t[4]):(t=ek.exec(e))?eZ(255*t[1]/100,255*t[2]/100,255*t[3]/100,t[4]):(t=ez.exec(e))?e3(t[1],t[2]/100,t[3]/100,1):(t=eH.exec(e))?e3(t[1],t[2]/100,t[3]/100,t[4]):eW.hasOwnProperty(e)?eq(eW[e]):"transparent"===e?new eK(NaN,NaN,NaN,0):null}function eq(e){return new eK(e>>16&255,e>>8&255,255&e,1)}function eZ(e,t,i,r){return r<=0&&(e=t=i=NaN),new eK(e,t,i,r)}function ej(e,t,i,r){var n;return 1==arguments.length?((n=e)instanceof eD||(n=e$(n)),n)?new eK((n=n.rgb()).r,n.g,n.b,n.opacity):new eK:new eK(e,t,i,null==r?1:r)}function eK(e,t,i,r){this.r=+e,this.g=+t,this.b=+i,this.opacity=+r}function eQ(){return`#${e2(this.r)}${e2(this.g)}${e2(this.b)}`}function eJ(){let e=e0(this.opacity);return`${1===e?"rgb(":"rgba("}${e1(this.r)}, ${e1(this.g)}, ${e1(this.b)}${1===e?")":`, ${e})`}`}function e0(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function e1(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function e2(e){return((e=e1(e))<16?"0":"")+e.toString(16)}function e3(e,t,i,r){return r<=0?e=t=i=NaN:i<=0||i>=1?e=t=NaN:t<=0&&(e=NaN),new e5(e,t,i,r)}function e4(e){if(e instanceof e5)return new e5(e.h,e.s,e.l,e.opacity);if(e instanceof eD||(e=e$(e)),!e)return new e5;if(e instanceof e5)return e;var t=(e=e.rgb()).r/255,i=e.g/255,r=e.b/255,n=Math.min(t,i,r),a=Math.max(t,i,r),o=NaN,s=a-n,l=(a+n)/2;return s?(o=t===a?(i-r)/s+(i<r)*6:i===a?(r-t)/s+2:(t-i)/s+4,s/=l<.5?a+n:2-a-n,o*=60):s=l>0&&l<1?0:o,new e5(o,s,l,e.opacity)}function e5(e,t,i,r){this.h=+e,this.s=+t,this.l=+i,this.opacity=+r}function e8(e){return(e=(e||0)%360)<0?e+360:e}function e6(e){return Math.max(0,Math.min(1,e||0))}function e9(e,t,i){return(e<60?t+(i-t)*e/60:e<180?i:e<240?t+(i-t)*(240-e)/60:t)*255}function e7(e,t,i,r,n){var a=e*e,o=a*e;return((1-3*e+3*a-o)*t+(4-6*a+3*o)*i+(1+3*e+3*a-3*o)*r+o*n)/6}eP(eD,e$,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:eX,formatHex:eX,formatHex8:function(){return this.rgb().formatHex8()},formatHsl:function(){return e4(this).formatHsl()},formatRgb:eY,toString:eY}),eP(eK,ej,eN(eD,{brighter(e){return e=null==e?1.4285714285714286:Math.pow(1.4285714285714286,e),new eK(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=null==e?.7:Math.pow(.7,e),new eK(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new eK(e1(this.r),e1(this.g),e1(this.b),e0(this.opacity))},displayable(){return -.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:eQ,formatHex:eQ,formatHex8:function(){return`#${e2(this.r)}${e2(this.g)}${e2(this.b)}${e2((isNaN(this.opacity)?1:this.opacity)*255)}`},formatRgb:eJ,toString:eJ})),eP(e5,function(e,t,i,r){return 1==arguments.length?e4(e):new e5(e,t,i,null==r?1:r)},eN(eD,{brighter(e){return e=null==e?1.4285714285714286:Math.pow(1.4285714285714286,e),new e5(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=null==e?.7:Math.pow(.7,e),new e5(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+(this.h<0)*360,t=isNaN(e)||isNaN(this.s)?0:this.s,i=this.l,r=i+(i<.5?i:1-i)*t,n=2*i-r;return new eK(e9(e>=240?e-240:e+120,n,r),e9(e,n,r),e9(e<120?e+240:e-120,n,r),this.opacity)},clamp(){return new e5(e8(this.h),e6(this.s),e6(this.l),e0(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){let e=e0(this.opacity);return`${1===e?"hsl(":"hsla("}${e8(this.h)}, ${100*e6(this.s)}%, ${100*e6(this.l)}%${1===e?")":`, ${e})`}`}}));let te=e=>()=>e;function tt(e,t){var i=t-e;return i?function(t){return e+t*i}:te(isNaN(e)?t:e)}let ti=function e(t){var i,r=1==(i=+t)?tt:function(e,t){var r,n,a;return t-e?(r=e,n=t,r=Math.pow(r,a=i),n=Math.pow(n,a)-r,a=1/a,function(e){return Math.pow(r+e*n,a)}):te(isNaN(e)?t:e)};function n(e,t){var i=r((e=ej(e)).r,(t=ej(t)).r),n=r(e.g,t.g),a=r(e.b,t.b),o=tt(e.opacity,t.opacity);return function(t){return e.r=i(t),e.g=n(t),e.b=a(t),e.opacity=o(t),e+""}}return n.gamma=e,n}(1);function tr(e){return function(t){var i,r,n=t.length,a=Array(n),o=Array(n),s=Array(n);for(i=0;i<n;++i)r=ej(t[i]),a[i]=r.r||0,o[i]=r.g||0,s[i]=r.b||0;return a=e(a),o=e(o),s=e(s),r.opacity=1,function(e){return r.r=a(e),r.g=o(e),r.b=s(e),r+""}}}tr(function(e){var t=e.length-1;return function(i){var r=i<=0?i=0:i>=1?(i=1,t-1):Math.floor(i*t),n=e[r],a=e[r+1],o=r>0?e[r-1]:2*n-a,s=r<t-1?e[r+2]:2*a-n;return e7((i-r/t)*t,o,n,a,s)}}),tr(function(e){var t=e.length;return function(i){var r=Math.floor(((i%=1)<0?++i:i)*t),n=e[(r+t-1)%t],a=e[r%t],o=e[(r+1)%t],s=e[(r+2)%t];return e7((i-r/t)*t,n,a,o,s)}});var tn=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,ta=RegExp(tn.source,"g");function to(e,t){var i,r,n,a,o,s=tn.lastIndex=ta.lastIndex=0,l=-1,c=[],f=[];for(e+="",t+="";(n=tn.exec(e))&&(a=ta.exec(t));)(o=a.index)>s&&(o=t.slice(s,o),c[l]?c[l]+=o:c[++l]=o),(n=n[0])===(a=a[0])?c[l]?c[l]+=a:c[++l]=a:(c[++l]=null,f.push({i:l,x:ex(n,a)})),s=ta.lastIndex;return s<t.length&&(o=t.slice(s),c[l]?c[l]+=o:c[++l]=o),c.length<2?f[0]?(i=f[0].x,function(e){return i(e)+""}):(r=t,function(){return r}):(t=f.length,function(e){for(var i,r=0;r<t;++r)c[(i=f[r]).i]=i.x(e);return c.join("")})}function ts(e,t){var i;return("number"==typeof t?ex:t instanceof e$?ti:(i=e$(t))?(t=i,ti):to)(e,t)}var tl=q.prototype.constructor;function tc(e){return function(){this.style.removeProperty(e)}}var tf=0;function tu(e,t,i,r){this._groups=e,this._parents=t,this._name=i,this._id=r}var td=q.prototype;tu.prototype=(function(e){return q().transition(e)}).prototype={constructor:tu,select:function(e){var t=this._name,i=this._id;"function"!=typeof e&&(e=n(e));for(var r=this._groups,a=r.length,o=Array(a),s=0;s<a;++s)for(var l,c,f=r[s],u=f.length,d=o[s]=Array(u),h=0;h<u;++h)(l=f[h])&&(c=e.call(l,l.__data__,h,f))&&("__data__"in l&&(c.__data__=l.__data__),d[h]=c,eS(d[h],t,i,h,d,eA(l,i)));return new tu(o,this._parents,t,i)},selectAll:function(e){var t=this._name,i=this._id;"function"!=typeof e&&(e=o(e));for(var r=this._groups,n=r.length,a=[],s=[],l=0;l<n;++l)for(var c,f=r[l],u=f.length,d=0;d<u;++d)if(c=f[d]){for(var h,p=e.call(c,c.__data__,d,f),m=eA(c,i),_=0,g=p.length;_<g;++_)(h=p[_])&&eS(h,t,i,_,p,m);a.push(p),s.push(c)}return new tu(a,s,t,i)},selectChild:td.selectChild,selectChildren:td.selectChildren,filter:function(e){"function"!=typeof e&&(e=s(e));for(var t=this._groups,i=t.length,r=Array(i),n=0;n<i;++n)for(var a,o=t[n],l=o.length,c=r[n]=[],f=0;f<l;++f)(a=o[f])&&e.call(a,a.__data__,f,o)&&c.push(a);return new tu(r,this._parents,this._name,this._id)},merge:function(e){if(e._id!==this._id)throw Error();for(var t=this._groups,i=e._groups,r=t.length,n=i.length,a=Math.min(r,n),o=Array(r),s=0;s<a;++s)for(var l,c=t[s],f=i[s],u=c.length,d=o[s]=Array(u),h=0;h<u;++h)(l=c[h]||f[h])&&(d[h]=l);for(;s<r;++s)o[s]=t[s];return new tu(o,this._parents,this._name,this._id)},selection:function(){return new tl(this._groups,this._parents)},transition:function(){for(var e=this._name,t=this._id,i=++tf,r=this._groups,n=r.length,a=0;a<n;++a)for(var o,s=r[a],l=s.length,c=0;c<l;++c)if(o=s[c]){var f=eA(o,t);eS(o,e,i,c,s,{time:f.time+f.delay+f.duration,delay:0,duration:f.duration,ease:f.ease})}return new tu(r,this._parents,e,i)},call:td.call,nodes:td.nodes,node:td.node,size:td.size,empty:td.empty,each:td.each,on:function(e,t){var i,r,n,a,o,s,l=this._id;return arguments.length<2?eA(this.node(),l).on.on(e):this.each((i=l,r=e,n=t,s=(r+"").trim().split(/^|\s+/).every(function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||"start"===e})?eE:eT,function(){var e=s(this,i),t=e.on;t!==a&&(o=(a=t).copy()).on(r,n),e.on=o}))},attr:function(e,t){var i=C(e),r="transform"===i?eL:ts;return this.attrTween(e,"function"==typeof t?(i.local?function(e,t,i){var r,n,a;return function(){var o,s,l=i(this);return null==l?void this.removeAttributeNS(e.space,e.local):(o=this.getAttributeNS(e.space,e.local))===(s=l+"")?null:o===r&&s===n?a:(n=s,a=t(r=o,l))}}:function(e,t,i){var r,n,a;return function(){var o,s,l=i(this);return null==l?void this.removeAttribute(e):(o=this.getAttribute(e))===(s=l+"")?null:o===r&&s===n?a:(n=s,a=t(r=o,l))}})(i,r,eM(this,"attr."+e,t)):null==t?(i.local?function(e){return function(){this.removeAttributeNS(e.space,e.local)}}:function(e){return function(){this.removeAttribute(e)}})(i):(i.local?function(e,t,i){var r,n,a=i+"";return function(){var o=this.getAttributeNS(e.space,e.local);return o===a?null:o===r?n:n=t(r=o,i)}}:function(e,t,i){var r,n,a=i+"";return function(){var o=this.getAttribute(e);return o===a?null:o===r?n:n=t(r=o,i)}})(i,r,t))},attrTween:function(e,t){var i="attr."+e;if(arguments.length<2)return(i=this.tween(i))&&i._value;if(null==t)return this.tween(i,null);if("function"!=typeof t)throw Error();var r=C(e);return this.tween(i,(r.local?function(e,t){var i,r;function n(){var n=t.apply(this,arguments);return n!==r&&(i=(r=n)&&function(t){this.setAttributeNS(e.space,e.local,n.call(this,t))}),i}return n._value=t,n}:function(e,t){var i,r;function n(){var n=t.apply(this,arguments);return n!==r&&(i=(r=n)&&function(t){this.setAttribute(e,n.call(this,t))}),i}return n._value=t,n})(r,t))},style:function(e,t,i){var r,n,a,o,s,l,c,f,u,d,h,p,m,_,g,v,S,E,T,A,x,I="transform"==(e+="")?ey:ts;return null==t?this.styleTween(e,(r=e,function(){var e=y(this,r),t=(this.style.removeProperty(r),y(this,r));return e===t?null:e===n&&t===a?o:o=I(n=e,a=t)})).on("end.style."+e,tc(e)):"function"==typeof t?this.styleTween(e,(s=e,l=eM(this,"style."+e,t),function(){var e=y(this,s),t=l(this),i=t+"";return null==t&&(this.style.removeProperty(s),i=t=y(this,s)),e===i?null:e===c&&i===f?u:(f=i,u=I(c=e,t))})).each((d=this._id,S="end."+(v="style."+(h=e)),function(){var e=eT(this,d),t=e.on,i=null==e.value[v]?g||(g=tc(h)):void 0;(t!==p||_!==i)&&(m=(p=t).copy()).on(S,_=i),e.on=m})):this.styleTween(e,(E=e,x=t+"",function(){var e=y(this,E);return e===x?null:e===T?A:A=I(T=e,t)}),i).on("end.style."+e,null)},styleTween:function(e,t,i){var r="style."+(e+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(null==t)return this.tween(r,null);if("function"!=typeof t)throw Error();return this.tween(r,function(e,t,i){var r,n;function a(){var a=t.apply(this,arguments);return a!==n&&(r=(n=a)&&function(t){this.style.setProperty(e,a.call(this,t),i)}),r}return a._value=t,a}(e,t,null==i?"":i))},text:function(e){var t,i;return this.tween("text","function"==typeof e?(t=eM(this,"text",e),function(){var e=t(this);this.textContent=null==e?"":e}):(i=null==e?"":e+"",function(){this.textContent=i}))},textTween:function(e){var t="text";if(arguments.length<1)return(t=this.tween(t))&&t._value;if(null==e)return this.tween(t,null);if("function"!=typeof e)throw Error();return this.tween(t,function(e){var t,i;function r(){var r=e.apply(this,arguments);return r!==i&&(t=(i=r)&&function(e){this.textContent=r.call(this,e)}),t}return r._value=e,r}(e))},remove:function(){var e;return this.on("end.remove",(e=this._id,function(){var t=this.parentNode;for(var i in this.__transition)if(+i!==e)return;t&&t.removeChild(this)}))},tween:function(e,t){var i=this._id;if(e+="",arguments.length<2){for(var r,n=eA(this.node(),i).tween,a=0,o=n.length;a<o;++a)if((r=n[a]).name===e)return r.value;return null}return this.each((null==t?function(e,t){var i,r;return function(){var n=eT(this,e),a=n.tween;if(a!==i){r=i=a;for(var o=0,s=r.length;o<s;++o)if(r[o].name===t){(r=r.slice()).splice(o,1);break}}n.tween=r}}:function(e,t,i){var r,n;if("function"!=typeof i)throw Error();return function(){var a=eT(this,e),o=a.tween;if(o!==r){n=(r=o).slice();for(var s={name:t,value:i},l=0,c=n.length;l<c;++l)if(n[l].name===t){n[l]=s;break}l===c&&n.push(s)}a.tween=n}})(i,e,t))},delay:function(e){var t=this._id;return arguments.length?this.each(("function"==typeof e?function(e,t){return function(){eE(this,e).delay=+t.apply(this,arguments)}}:function(e,t){return t*=1,function(){eE(this,e).delay=t}})(t,e)):eA(this.node(),t).delay},duration:function(e){var t=this._id;return arguments.length?this.each(("function"==typeof e?function(e,t){return function(){eT(this,e).duration=+t.apply(this,arguments)}}:function(e,t){return t*=1,function(){eT(this,e).duration=t}})(t,e)):eA(this.node(),t).duration},ease:function(e){var t=this._id;return arguments.length?this.each(function(e,t){if("function"!=typeof t)throw Error();return function(){eT(this,e).ease=t}}(t,e)):eA(this.node(),t).ease},easeVarying:function(e){var t;if("function"!=typeof e)throw Error();return this.each((t=this._id,function(){var i=e.apply(this,arguments);if("function"!=typeof i)throw Error();eT(this,t).ease=i}))},end:function(){var e,t,i=this,r=i._id,n=i.size();return new Promise(function(a,o){var s={value:o},l={value:function(){0==--n&&a()}};i.each(function(){var i=eT(this,r),n=i.on;n!==e&&((t=(e=n).copy())._.cancel.push(s),t._.interrupt.push(s),t._.end.push(l)),i.on=t}),0===n&&a()})},[Symbol.iterator]:td[Symbol.iterator]};var th={time:null,delay:0,duration:250,ease:function(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}};q.prototype.interrupt=function(e){return this.each(function(){!function(e,t){var i,r,n,a=e.__transition,o=!0;if(a){for(n in t=null==t?null:t+"",a){if((i=a[n]).name!==t){o=!1;continue}r=i.state>2&&i.state<5,i.state=6,i.timer.stop(),i.on.call(r?"interrupt":"cancel",e,e.__data__,i.index,i.group),delete a[n]}o&&delete e.__transition}}(this,e)})},q.prototype.transition=function(e){var t,i;e instanceof tu?(t=e._id,e=e._name):(t=++tf,(i=th).time=ec(),e=null==e?null:e+"");for(var r=this._groups,n=r.length,a=0;a<n;++a)for(var o,s=r[a],l=s.length,c=0;c<l;++c)(o=s[c])&&eS(o,e,t,c,s,i||function(e,t){for(var i;!(i=e.__transition)||!(i=i[t]);)if(!(e=e.parentNode))throw Error(`transition ${t} not found`);return i}(o,t));return new tu(r,this._parents,e,t)};let{abs:tp,max:tm,min:t_}=Math;function tg(e){return{type:e}}["w","e"].map(tg),["n","s"].map(tg),["n","w","e","s","nw","ne","sw","se"].map(tg);function tv(e,t){return e*=1,t*=1,function(i){return Math.round(e*(1-i)+t*i)}}function tS(e){return e}function tE(e,t){switch(arguments.length){case 0:break;case 1:"function"==typeof e?this.interpolator(e):this.range(e);break;default:this.domain(e),"function"==typeof t?this.interpolator(t):this.range(t)}return this}let tT=Math.sqrt(50),tA=Math.sqrt(10),tx=Math.sqrt(2);function tI(e,t,i){let r,n,a,o=(t-e)/Math.max(0,i),s=Math.floor(Math.log10(o)),l=o/Math.pow(10,s),c=l>=tT?10:l>=tA?5:l>=tx?2:1;return(s<0?(r=Math.round(e*(a=Math.pow(10,-s)/c)),n=Math.round(t*a),r/a<e&&++r,n/a>t&&--n,a=-a):(r=Math.round(e/(a=Math.pow(10,s)*c)),n=Math.round(t/a),r*a<e&&++r,n*a>t&&--n),n<r&&.5<=i&&i<2)?tI(e,t,2*i):[r,n,a]}function tR(e,t,i){return tI(e*=1,t*=1,i*=1)[2]}var tC=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function tb(e){var t;if(!(t=tC.exec(e)))throw Error("invalid format: "+e);return new ty({fill:t[1],align:t[2],sign:t[3],symbol:t[4],zero:t[5],width:t[6],comma:t[7],precision:t[8]&&t[8].slice(1),trim:t[9],type:t[10]})}function ty(e){this.fill=void 0===e.fill?" ":e.fill+"",this.align=void 0===e.align?">":e.align+"",this.sign=void 0===e.sign?"-":e.sign+"",this.symbol=void 0===e.symbol?"":e.symbol+"",this.zero=!!e.zero,this.width=void 0===e.width?void 0:+e.width,this.comma=!!e.comma,this.precision=void 0===e.precision?void 0:+e.precision,this.trim=!!e.trim,this.type=void 0===e.type?"":e.type+""}function tL(e,t){if((i=(e=t?e.toExponential(t-1):e.toExponential()).indexOf("e"))<0)return null;var i,r=e.slice(0,i);return[r.length>1?r[0]+r.slice(2):r,+e.slice(i+1)]}function tM(e){return(e=tL(Math.abs(e)))?e[1]:NaN}function tP(e,t){var i=tL(e,t);if(!i)return e+"";var r=i[0],n=i[1];return n<0?"0."+Array(-n).join("0")+r:r.length>n+1?r.slice(0,n+1)+"."+r.slice(n+1):r+Array(n-r.length+2).join("0")}tb.prototype=ty.prototype,ty.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(void 0===this.width?"":Math.max(1,0|this.width))+(this.comma?",":"")+(void 0===this.precision?"":"."+Math.max(0,0|this.precision))+(this.trim?"~":"")+this.type};let tN={"%":(e,t)=>(100*e).toFixed(t),b:e=>Math.round(e).toString(2),c:e=>e+"",d:function(e){return Math.abs(e=Math.round(e))>=1e21?e.toLocaleString("en").replace(/,/g,""):e.toString(10)},e:(e,t)=>e.toExponential(t),f:(e,t)=>e.toFixed(t),g:(e,t)=>e.toPrecision(t),o:e=>Math.round(e).toString(8),p:(e,t)=>tP(100*e,t),r:tP,s:function(e,t){var i=tL(e,t);if(!i)return e+"";var r=i[0],n=i[1],a=n-(f=3*Math.max(-8,Math.min(8,Math.floor(n/3))))+1,o=r.length;return a===o?r:a>o?r+Array(a-o+1).join("0"):a>0?r.slice(0,a)+"."+r.slice(a):"0."+Array(1-a).join("0")+tL(e,Math.max(0,t+a-1))[0]},X:e=>Math.round(e).toString(16).toUpperCase(),x:e=>Math.round(e).toString(16)};function tD(e){return e}var tO=Array.prototype.map,tF=["y","z","a","f","p","n","\xb5","m","","k","M","G","T","P","E","Z","Y"];function tw(e){for(var t=e.length/6|0,i=Array(t),r=0;r<t;)i[r]="#"+e.slice(6*r,6*++r);return i}function tB(e){var t=e.length;return function(i){return e[Math.max(0,Math.min(t-1,Math.floor(i*t)))]}}d=(u=function(e){var t,i,r,n=void 0===e.grouping||void 0===e.thousands?tD:(t=tO.call(e.grouping,Number),i=e.thousands+"",function(e,r){for(var n=e.length,a=[],o=0,s=t[0],l=0;n>0&&s>0&&(l+s+1>r&&(s=Math.max(1,r-l)),a.push(e.substring(n-=s,n+s)),!((l+=s+1)>r));)s=t[o=(o+1)%t.length];return a.reverse().join(i)}),a=void 0===e.currency?"":e.currency[0]+"",o=void 0===e.currency?"":e.currency[1]+"",s=void 0===e.decimal?".":e.decimal+"",l=void 0===e.numerals?tD:(r=tO.call(e.numerals,String),function(e){return e.replace(/[0-9]/g,function(e){return r[+e]})}),c=void 0===e.percent?"%":e.percent+"",u=void 0===e.minus?"−":e.minus+"",d=void 0===e.nan?"NaN":e.nan+"";function h(e){var t=(e=tb(e)).fill,i=e.align,r=e.sign,h=e.symbol,p=e.zero,m=e.width,_=e.comma,g=e.precision,v=e.trim,S=e.type;"n"===S?(_=!0,S="g"):tN[S]||(void 0===g&&(g=12),v=!0,S="g"),(p||"0"===t&&"="===i)&&(p=!0,t="0",i="=");var E="$"===h?a:"#"===h&&/[boxX]/.test(S)?"0"+S.toLowerCase():"",T="$"===h?o:/[%p]/.test(S)?c:"",A=tN[S],x=/[defgprs%]/.test(S);function I(e){var a,o,c,h=E,I=T;if("c"===S)I=A(e)+I,e="";else{var R=(e*=1)<0||1/e<0;if(e=isNaN(e)?d:A(Math.abs(e),g),v&&(e=function(e){e:for(var t,i=e.length,r=1,n=-1;r<i;++r)switch(e[r]){case".":n=t=r;break;case"0":0===n&&(n=r),t=r;break;default:if(!+e[r])break e;n>0&&(n=0)}return n>0?e.slice(0,n)+e.slice(t+1):e}(e)),R&&0==+e&&"+"!==r&&(R=!1),h=(R?"("===r?r:u:"-"===r||"("===r?"":r)+h,I=("s"===S?tF[8+f/3]:"")+I+(R&&"("===r?")":""),x){for(a=-1,o=e.length;++a<o;)if(48>(c=e.charCodeAt(a))||c>57){I=(46===c?s+e.slice(a+1):e.slice(a))+I,e=e.slice(0,a);break}}}_&&!p&&(e=n(e,1/0));var C=h.length+e.length+I.length,b=C<m?Array(m-C+1).join(t):"";switch(_&&p&&(e=n(b+e,b.length?m-I.length:1/0),b=""),i){case"<":e=h+e+I+b;break;case"=":e=h+b+e+I;break;case"^":e=b.slice(0,C=b.length>>1)+h+e+I+b.slice(C);break;default:e=b+h+e+I}return l(e)}return g=void 0===g?6:/[gprs]/.test(S)?Math.max(1,Math.min(21,g)):Math.max(0,Math.min(20,g)),I.toString=function(){return e+""},I}return{format:h,formatPrefix:function(e,t){var i=h(((e=tb(e)).type="f",e)),r=3*Math.max(-8,Math.min(8,Math.floor(tM(t)/3))),n=Math.pow(10,-r),a=tF[8+r/3];return function(e){return i(n*e)+a}}}}({thousands:",",grouping:[3],currency:["$",""]})).format,h=u.formatPrefix;let tU=tB(tw("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725"));function tG(e){return function(){return e}}tB(tw("00000401000501010601010802010902020b02020d03030f03031204041405041606051806051a07061c08071e0907200a08220b09240c09260d0a290e0b2b100b2d110c2f120d31130d34140e36150e38160f3b180f3d19103f1a10421c10441d11471e114920114b21114e22115024125325125527125829115a2a115c2c115f2d11612f116331116533106734106936106b38106c390f6e3b0f703d0f713f0f72400f74420f75440f764510774710784910784a10794c117a4e117b4f127b51127c52137c54137d56147d57157e59157e5a167e5c167f5d177f5f187f601880621980641a80651a80671b80681c816a1c816b1d816d1d816e1e81701f81721f817320817521817621817822817922827b23827c23827e24828025828125818326818426818627818827818928818b29818c29818e2a81902a81912b81932b80942c80962c80982d80992d809b2e7f9c2e7f9e2f7fa02f7fa1307ea3307ea5317ea6317da8327daa337dab337cad347cae347bb0357bb2357bb3367ab5367ab73779b83779ba3878bc3978bd3977bf3a77c03a76c23b75c43c75c53c74c73d73c83e73ca3e72cc3f71cd4071cf4070d0416fd2426fd3436ed5446dd6456cd8456cd9466bdb476adc4869de4968df4a68e04c67e24d66e34e65e44f64e55064e75263e85362e95462ea5661eb5760ec5860ed5a5fee5b5eef5d5ef05f5ef1605df2625df2645cf3655cf4675cf4695cf56b5cf66c5cf66e5cf7705cf7725cf8745cf8765cf9785df9795df97b5dfa7d5efa7f5efa815ffb835ffb8560fb8761fc8961fc8a62fc8c63fc8e64fc9065fd9266fd9467fd9668fd9869fd9a6afd9b6bfe9d6cfe9f6dfea16efea36ffea571fea772fea973feaa74feac76feae77feb078feb27afeb47bfeb67cfeb77efeb97ffebb81febd82febf84fec185fec287fec488fec68afec88cfeca8dfecc8ffecd90fecf92fed194fed395fed597fed799fed89afdda9cfddc9efddea0fde0a1fde2a3fde3a5fde5a7fde7a9fde9aafdebacfcecaefceeb0fcf0b2fcf2b4fcf4b6fcf6b8fcf7b9fcf9bbfcfbbdfcfdbf")),tB(tw("00000401000501010601010802010a02020c02020e03021004031204031405041706041907051b08051d09061f0a07220b07240c08260d08290e092b10092d110a30120a32140b34150b37160b39180c3c190c3e1b0c411c0c431e0c451f0c48210c4a230c4c240c4f260c51280b53290b552b0b572d0b592f0a5b310a5c320a5e340a5f3609613809623909633b09643d09653e0966400a67420a68440a68450a69470b6a490b6a4a0c6b4c0c6b4d0d6c4f0d6c510e6c520e6d540f6d550f6d57106e59106e5a116e5c126e5d126e5f136e61136e62146e64156e65156e67166e69166e6a176e6c186e6d186e6f196e71196e721a6e741a6e751b6e771c6d781c6d7a1d6d7c1d6d7d1e6d7f1e6c801f6c82206c84206b85216b87216b88226a8a226a8c23698d23698f24699025689225689326679526679727669827669a28659b29649d29649f2a63a02a63a22b62a32c61a52c60a62d60a82e5fa92e5eab2f5ead305dae305cb0315bb1325ab3325ab43359b63458b73557b93556ba3655bc3754bd3853bf3952c03a51c13a50c33b4fc43c4ec63d4dc73e4cc83f4bca404acb4149cc4248ce4347cf4446d04545d24644d34743d44842d54a41d74b3fd84c3ed94d3dda4e3cdb503bdd513ade5238df5337e05536e15635e25734e35933e45a31e55c30e65d2fe75e2ee8602de9612bea632aeb6429eb6628ec6726ed6925ee6a24ef6c23ef6e21f06f20f1711ff1731df2741cf3761bf37819f47918f57b17f57d15f67e14f68013f78212f78410f8850ff8870ef8890cf98b0bf98c0af98e09fa9008fa9207fa9407fb9606fb9706fb9906fb9b06fb9d07fc9f07fca108fca309fca50afca60cfca80dfcaa0ffcac11fcae12fcb014fcb216fcb418fbb61afbb81dfbba1ffbbc21fbbe23fac026fac228fac42afac62df9c72ff9c932f9cb35f8cd37f8cf3af7d13df7d340f6d543f6d746f5d949f5db4cf4dd4ff4df53f4e156f3e35af3e55df2e661f2e865f2ea69f1ec6df1ed71f1ef75f1f179f2f27df2f482f3f586f3f68af4f88ef5f992f6fa96f8fb9af9fc9dfafda1fcffa4")),tB(tw("0d088710078813078916078a19068c1b068d1d068e20068f2206902406912605912805922a05932c05942e05952f059631059733059735049837049938049a3a049a3c049b3e049c3f049c41049d43039e44039e46039f48039f4903a04b03a14c02a14e02a25002a25102a35302a35502a45601a45801a45901a55b01a55c01a65e01a66001a66100a76300a76400a76600a76700a86900a86a00a86c00a86e00a86f00a87100a87201a87401a87501a87701a87801a87a02a87b02a87d03a87e03a88004a88104a78305a78405a78606a68707a68808a68a09a58b0aa58d0ba58e0ca48f0da4910ea3920fa39410a29511a19613a19814a099159f9a169f9c179e9d189d9e199da01a9ca11b9ba21d9aa31e9aa51f99a62098a72197a82296aa2395ab2494ac2694ad2793ae2892b02991b12a90b22b8fb32c8eb42e8db52f8cb6308bb7318ab83289ba3388bb3488bc3587bd3786be3885bf3984c03a83c13b82c23c81c33d80c43e7fc5407ec6417dc7427cc8437bc9447aca457acb4679cc4778cc4977cd4a76ce4b75cf4c74d04d73d14e72d24f71d35171d45270d5536fd5546ed6556dd7566cd8576bd9586ada5a6ada5b69db5c68dc5d67dd5e66de5f65de6164df6263e06363e16462e26561e26660e3685fe4695ee56a5de56b5de66c5ce76e5be76f5ae87059e97158e97257ea7457eb7556eb7655ec7754ed7953ed7a52ee7b51ef7c51ef7e50f07f4ff0804ef1814df1834cf2844bf3854bf3874af48849f48948f58b47f58c46f68d45f68f44f79044f79143f79342f89441f89540f9973ff9983ef99a3efa9b3dfa9c3cfa9e3bfb9f3afba139fba238fca338fca537fca636fca835fca934fdab33fdac33fdae32fdaf31fdb130fdb22ffdb42ffdb52efeb72dfeb82cfeba2cfebb2bfebd2afebe2afec029fdc229fdc328fdc527fdc627fdc827fdca26fdcb26fccd25fcce25fcd025fcd225fbd324fbd524fbd724fad824fada24f9dc24f9dd25f8df25f8e125f7e225f7e425f6e626f6e826f5e926f5eb27f4ed27f3ee27f3f027f2f227f1f426f1f525f0f724f0f921"));let tV=Math.abs,tk=Math.atan2,tz=Math.cos,tH=Math.max,tW=Math.min,tX=Math.sin,tY=Math.sqrt,t$=Math.PI,tq=t$/2,tZ=2*t$;function tj(e){return e>=1?tq:e<=-1?-tq:Math.asin(e)}let tK=Math.PI,tQ=2*tK,tJ=tQ-1e-6;function t0(e){this._+=e[0];for(let t=1,i=e.length;t<i;++t)this._+=arguments[t]+e[t]}class t1{constructor(e){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=null==e?t0:function(e){let t=Math.floor(e);if(!(t>=0))throw Error(`invalid digits: ${e}`);if(t>15)return t0;let i=10**t;return function(e){this._+=e[0];for(let t=1,r=e.length;t<r;++t)this._+=Math.round(arguments[t]*i)/i+e[t]}}(e)}moveTo(e,t){this._append`M${this._x0=this._x1=+e},${this._y0=this._y1=+t}`}closePath(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(e,t){this._append`L${this._x1=+e},${this._y1=+t}`}quadraticCurveTo(e,t,i,r){this._append`Q${+e},${+t},${this._x1=+i},${this._y1=+r}`}bezierCurveTo(e,t,i,r,n,a){this._append`C${+e},${+t},${+i},${+r},${this._x1=+n},${this._y1=+a}`}arcTo(e,t,i,r,n){if(e*=1,t*=1,i*=1,r*=1,(n*=1)<0)throw Error(`negative radius: ${n}`);let a=this._x1,o=this._y1,s=i-e,l=r-t,c=a-e,f=o-t,u=c*c+f*f;if(null===this._x1)this._append`M${this._x1=e},${this._y1=t}`;else if(u>1e-6)if(Math.abs(f*s-l*c)>1e-6&&n){let d=i-a,h=r-o,p=s*s+l*l,m=Math.sqrt(p),_=Math.sqrt(u),g=n*Math.tan((tK-Math.acos((p+u-(d*d+h*h))/(2*m*_)))/2),v=g/_,S=g/m;Math.abs(v-1)>1e-6&&this._append`L${e+v*c},${t+v*f}`,this._append`A${n},${n},0,0,${+(f*d>c*h)},${this._x1=e+S*s},${this._y1=t+S*l}`}else this._append`L${this._x1=e},${this._y1=t}`}arc(e,t,i,r,n,a){if(e*=1,t*=1,i*=1,a=!!a,i<0)throw Error(`negative radius: ${i}`);let o=i*Math.cos(r),s=i*Math.sin(r),l=e+o,c=t+s,f=1^a,u=a?r-n:n-r;null===this._x1?this._append`M${l},${c}`:(Math.abs(this._x1-l)>1e-6||Math.abs(this._y1-c)>1e-6)&&this._append`L${l},${c}`,i&&(u<0&&(u=u%tQ+tQ),u>tJ?this._append`A${i},${i},0,1,${f},${e-o},${t-s}A${i},${i},0,1,${f},${this._x1=l},${this._y1=c}`:u>1e-6&&this._append`A${i},${i},0,${+(u>=tK)},${f},${this._x1=e+i*Math.cos(n)},${this._y1=t+i*Math.sin(n)}`)}rect(e,t,i,r){this._append`M${this._x0=this._x1=+e},${this._y0=this._y1=+t}h${i*=1}v${+r}h${-i}Z`}toString(){return this._}}function t2(e){return e.innerRadius}function t3(e){return e.outerRadius}function t4(e){return e.startAngle}function t5(e){return e.endAngle}function t8(e){return e&&e.padAngle}function t6(e,t,i,r,n,a,o){var s=e-i,l=t-r,c=(o?a:-a)/tY(s*s+l*l),f=c*l,u=-c*s,d=e+f,h=t+u,p=i+f,m=r+u,_=(d+p)/2,g=(h+m)/2,v=p-d,S=m-h,E=v*v+S*S,T=n-a,A=d*m-p*h,x=(S<0?-1:1)*tY(tH(0,T*T*E-A*A)),I=(A*S-v*x)/E,R=(-A*v-S*x)/E,C=(A*S+v*x)/E,b=(-A*v+S*x)/E,y=I-_,L=R-g,M=C-_,P=b-g;return y*y+L*L>M*M+P*P&&(I=C,R=b),{cx:I,cy:R,x01:-f,y01:-u,x11:I*(n/T-1),y11:R*(n/T-1)}}function t9(){let e;var t=t2,i=t3,r=tG(0),n=null,a=t4,o=t5,s=t8,l=null,c=(e=3,f.digits=function(t){if(!arguments.length)return e;if(null==t)e=null;else{let i=Math.floor(t);if(!(i>=0))throw RangeError(`invalid digits: ${t}`);e=i}return f},()=>new t1(e));function f(){var e,f,u=+t.apply(this,arguments),d=+i.apply(this,arguments),h=a.apply(this,arguments)-tq,p=o.apply(this,arguments)-tq,m=tV(p-h),_=p>h;if(l||(l=e=c()),d<u&&(f=d,d=u,u=f),d>1e-12)if(m>tZ-1e-12)l.moveTo(d*tz(h),d*tX(h)),l.arc(0,0,d,h,p,!_),u>1e-12&&(l.moveTo(u*tz(p),u*tX(p)),l.arc(0,0,u,p,h,_));else{var g,v,S=h,E=p,T=h,A=p,x=m,I=m,R=s.apply(this,arguments)/2,C=R>1e-12&&(n?+n.apply(this,arguments):tY(u*u+d*d)),b=tW(tV(d-u)/2,+r.apply(this,arguments)),y=b,L=b;if(C>1e-12){var M=tj(C/u*tX(R)),P=tj(C/d*tX(R));(x-=2*M)>1e-12?(M*=_?1:-1,T+=M,A-=M):(x=0,T=A=(h+p)/2),(I-=2*P)>1e-12?(P*=_?1:-1,S+=P,E-=P):(I=0,S=E=(h+p)/2)}var N=d*tz(S),D=d*tX(S),O=u*tz(A),F=u*tX(A);if(b>1e-12){var w,B=d*tz(E),U=d*tX(E),G=u*tz(T),V=u*tX(T);if(m<t$)if(w=function(e,t,i,r,n,a,o,s){var l=i-e,c=r-t,f=o-n,u=s-a,d=u*l-f*c;if(!(d*d<1e-12))return d=(f*(t-a)-u*(e-n))/d,[e+d*l,t+d*c]}(N,D,G,V,B,U,O,F)){var k,z=N-w[0],H=D-w[1],W=B-w[0],X=U-w[1],Y=1/tX(((k=(z*W+H*X)/(tY(z*z+H*H)*tY(W*W+X*X)))>1?0:k<-1?t$:Math.acos(k))/2),$=tY(w[0]*w[0]+w[1]*w[1]);y=tW(b,(u-$)/(Y-1)),L=tW(b,(d-$)/(Y+1))}else y=L=0}I>1e-12?L>1e-12?(g=t6(G,V,N,D,d,L,_),v=t6(B,U,O,F,d,L,_),l.moveTo(g.cx+g.x01,g.cy+g.y01),L<b?l.arc(g.cx,g.cy,L,tk(g.y01,g.x01),tk(v.y01,v.x01),!_):(l.arc(g.cx,g.cy,L,tk(g.y01,g.x01),tk(g.y11,g.x11),!_),l.arc(0,0,d,tk(g.cy+g.y11,g.cx+g.x11),tk(v.cy+v.y11,v.cx+v.x11),!_),l.arc(v.cx,v.cy,L,tk(v.y11,v.x11),tk(v.y01,v.x01),!_))):(l.moveTo(N,D),l.arc(0,0,d,S,E,!_)):l.moveTo(N,D),u>1e-12&&x>1e-12?y>1e-12?(g=t6(O,F,B,U,u,-y,_),v=t6(N,D,G,V,u,-y,_),l.lineTo(g.cx+g.x01,g.cy+g.y01),y<b?l.arc(g.cx,g.cy,y,tk(g.y01,g.x01),tk(v.y01,v.x01),!_):(l.arc(g.cx,g.cy,y,tk(g.y01,g.x01),tk(g.y11,g.x11),!_),l.arc(0,0,u,tk(g.cy+g.y11,g.cx+g.x11),tk(v.cy+v.y11,v.cx+v.x11),_),l.arc(v.cx,v.cy,y,tk(v.y11,v.x11),tk(v.y01,v.x01),!_))):l.arc(0,0,u,A,T,_):l.lineTo(O,F)}else l.moveTo(0,0);if(l.closePath(),e)return l=null,e+""||null}return f.centroid=function(){var e=(+t.apply(this,arguments)+ +i.apply(this,arguments))/2,r=(+a.apply(this,arguments)+ +o.apply(this,arguments))/2-t$/2;return[tz(r)*e,tX(r)*e]},f.innerRadius=function(e){return arguments.length?(t="function"==typeof e?e:tG(+e),f):t},f.outerRadius=function(e){return arguments.length?(i="function"==typeof e?e:tG(+e),f):i},f.cornerRadius=function(e){return arguments.length?(r="function"==typeof e?e:tG(+e),f):r},f.padRadius=function(e){return arguments.length?(n=null==e?null:"function"==typeof e?e:tG(+e),f):n},f.startAngle=function(e){return arguments.length?(a="function"==typeof e?e:tG(+e),f):a},f.endAngle=function(e){return arguments.length?(o="function"==typeof e?e:tG(+e),f):o},f.padAngle=function(e){return arguments.length?(s="function"==typeof e?e:tG(+e),f):s},f.context=function(e){return arguments.length?(l=null==e?null:e,f):l},f}function t7(e,t){return t<e?-1:t>e?1:t>=e?0:NaN}function ie(e){return e}function it(){var e=ie,t=t7,i=null,r=tG(0),n=tG(tZ),a=tG(0);function o(o){var s,l,c,f,u,d,h=(o="object"==typeof(s=o)&&"length"in s?s:Array.from(s)).length,p=0,m=Array(h),_=Array(h),g=+r.apply(this,arguments),v=Math.min(tZ,Math.max(-tZ,n.apply(this,arguments)-g)),S=Math.min(Math.abs(v)/h,a.apply(this,arguments)),E=S*(v<0?-1:1);for(l=0;l<h;++l)(d=_[m[l]=l]=+e(o[l],l,o))>0&&(p+=d);for(null!=t?m.sort(function(e,i){return t(_[e],_[i])}):null!=i&&m.sort(function(e,t){return i(o[e],o[t])}),l=0,f=p?(v-h*E)/p:0;l<h;++l,g=u)u=g+((d=_[c=m[l]])>0?d*f:0)+E,_[c]={data:o[c],index:l,value:d,startAngle:g,endAngle:u,padAngle:S};return _}return o.value=function(t){return arguments.length?(e="function"==typeof t?t:tG(+t),o):e},o.sortValues=function(e){return arguments.length?(t=e,i=null,o):t},o.sort=function(e){return arguments.length?(i=e,t=null,o):i},o.startAngle=function(e){return arguments.length?(r="function"==typeof e?e:tG(+e),o):r},o.endAngle=function(e){return arguments.length?(n="function"==typeof e?e:tG(+e),o):n},o.padAngle=function(e){return arguments.length?(a="function"==typeof e?e:tG(+e),o):a},o}function ii(e,t,i){this.k=e,this.x=t,this.y=i}t1.prototype,Array.prototype.slice,ii.prototype={constructor:ii,scale:function(e){return 1===e?this:new ii(this.k*e,this.x,this.y)},translate:function(e,t){return 0===e&0===t?this:new ii(this.k,this.x+this.k*e,this.y+this.k*t)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};new ii(1,0,0);ii.prototype},57732:function(e,t,i){i.d(t,{Ay:()=>W,Ts:()=>X,t:()=>Y});let r=e=>"string"==typeof e,n=()=>{let e,t,i=new Promise((i,r)=>{e=i,t=r});return i.resolve=e,i.reject=t,i},a=e=>null==e?"":""+e,o=/###/g,s=e=>e&&e.indexOf("###")>-1?e.replace(o,"."):e,l=e=>!e||r(e),c=(e,t,i)=>{let n=r(t)?t.split("."):t,a=0;for(;a<n.length-1;){if(l(e))return{};let t=s(n[a]);!e[t]&&i&&(e[t]=new i),e=Object.prototype.hasOwnProperty.call(e,t)?e[t]:{},++a}return l(e)?{}:{obj:e,k:s(n[a])}},f=(e,t,i)=>{let{obj:r,k:n}=c(e,t,Object);if(void 0!==r||1===t.length){r[n]=i;return}let a=t[t.length-1],o=t.slice(0,t.length-1),s=c(e,o,Object);for(;void 0===s.obj&&o.length;)a=`${o[o.length-1]}.${a}`,s=c(e,o=o.slice(0,o.length-1),Object),s?.obj&&void 0!==s.obj[`${s.k}.${a}`]&&(s.obj=void 0);s.obj[`${s.k}.${a}`]=i},u=(e,t)=>{let{obj:i,k:r}=c(e,t);if(i&&Object.prototype.hasOwnProperty.call(i,r))return i[r]},d=(e,t,i)=>{for(let n in t)"__proto__"!==n&&"constructor"!==n&&(n in e?r(e[n])||e[n]instanceof String||r(t[n])||t[n]instanceof String?i&&(e[n]=t[n]):d(e[n],t[n],i):e[n]=t[n]);return e};var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};let p=e=>r(e)?e.replace(/[&<>"'\/]/g,e=>h[e]):e,m=[" ",",","?","!",";"],_=new class{constructor(e){this.capacity=e,this.regExpMap=new Map,this.regExpQueue=[]}getRegExp(e){let t=this.regExpMap.get(e);if(void 0!==t)return t;let i=new RegExp(e);return this.regExpQueue.length===this.capacity&&this.regExpMap.delete(this.regExpQueue.shift()),this.regExpMap.set(e,i),this.regExpQueue.push(e),i}}(20),g=(e,t,i=".")=>{if(!e)return;if(e[t]){if(!Object.prototype.hasOwnProperty.call(e,t))return;return e[t]}let r=t.split(i),n=e;for(let e=0;e<r.length;){let t;if(!n||"object"!=typeof n)return;let a="";for(let o=e;o<r.length;++o)if(o!==e&&(a+=i),a+=r[o],void 0!==(t=n[a])){if(["string","number","boolean"].indexOf(typeof t)>-1&&o<r.length-1)continue;e+=o-e+1;break}n=t}return n},v=e=>e?.replace("_","-"),S={type:"logger",log(e){this.output("log",e)},warn(e){this.output("warn",e)},error(e){this.output("error",e)},output(e,t){console?.[e]?.apply?.(console,t)}};class E{constructor(e,t={}){this.init(e,t)}init(e,t={}){this.prefix=t.prefix||"i18next:",this.logger=e||S,this.options=t,this.debug=t.debug}log(...e){return this.forward(e,"log","",!0)}warn(...e){return this.forward(e,"warn","",!0)}error(...e){return this.forward(e,"error","")}deprecate(...e){return this.forward(e,"warn","WARNING DEPRECATED: ",!0)}forward(e,t,i,n){return n&&!this.debug?null:(r(e[0])&&(e[0]=`${i}${this.prefix} ${e[0]}`),this.logger[t](e))}create(e){return new E(this.logger,{...{prefix:`${this.prefix}:${e}:`},...this.options})}clone(e){return(e=e||this.options).prefix=e.prefix||this.prefix,new E(this.logger,e)}}var T=new E;class A{constructor(){this.observers={}}on(e,t){return e.split(" ").forEach(e=>{this.observers[e]||(this.observers[e]=new Map);let i=this.observers[e].get(t)||0;this.observers[e].set(t,i+1)}),this}off(e,t){if(this.observers[e]){if(!t)return void delete this.observers[e];this.observers[e].delete(t)}}emit(e,...t){this.observers[e]&&Array.from(this.observers[e].entries()).forEach(([e,i])=>{for(let r=0;r<i;r++)e(...t)}),this.observers["*"]&&Array.from(this.observers["*"].entries()).forEach(([i,r])=>{for(let n=0;n<r;n++)i.apply(i,[e,...t])})}}class x extends A{constructor(e,t={ns:["translation"],defaultNS:"translation"}){super(),this.data=e||{},this.options=t,void 0===this.options.keySeparator&&(this.options.keySeparator="."),void 0===this.options.ignoreJSONStructure&&(this.options.ignoreJSONStructure=!0)}addNamespaces(e){0>this.options.ns.indexOf(e)&&this.options.ns.push(e)}removeNamespaces(e){let t=this.options.ns.indexOf(e);t>-1&&this.options.ns.splice(t,1)}getResource(e,t,i,n={}){let a,o=void 0!==n.keySeparator?n.keySeparator:this.options.keySeparator,s=void 0!==n.ignoreJSONStructure?n.ignoreJSONStructure:this.options.ignoreJSONStructure;e.indexOf(".")>-1?a=e.split("."):(a=[e,t],i&&(Array.isArray(i)?a.push(...i):r(i)&&o?a.push(...i.split(o)):a.push(i)));let l=u(this.data,a);return(!l&&!t&&!i&&e.indexOf(".")>-1&&(e=a[0],t=a[1],i=a.slice(2).join(".")),!l&&s&&r(i))?g(this.data?.[e]?.[t],i,o):l}addResource(e,t,i,r,n={silent:!1}){let a=void 0!==n.keySeparator?n.keySeparator:this.options.keySeparator,o=[e,t];i&&(o=o.concat(a?i.split(a):i)),e.indexOf(".")>-1&&(o=e.split("."),r=t,t=o[1]),this.addNamespaces(t),f(this.data,o,r),n.silent||this.emit("added",e,t,i,r)}addResources(e,t,i,n={silent:!1}){for(let n in i)(r(i[n])||Array.isArray(i[n]))&&this.addResource(e,t,n,i[n],{silent:!0});n.silent||this.emit("added",e,t,i)}addResourceBundle(e,t,i,r,n,a={silent:!1,skipCopy:!1}){let o=[e,t];e.indexOf(".")>-1&&(o=e.split("."),r=i,i=t,t=o[1]),this.addNamespaces(t);let s=u(this.data,o)||{};a.skipCopy||(i=JSON.parse(JSON.stringify(i))),r?d(s,i,n):s={...s,...i},f(this.data,o,s),a.silent||this.emit("added",e,t,i)}removeResourceBundle(e,t){this.hasResourceBundle(e,t)&&delete this.data[e][t],this.removeNamespaces(t),this.emit("removed",e,t)}hasResourceBundle(e,t){return void 0!==this.getResource(e,t)}getResourceBundle(e,t){return t||(t=this.options.defaultNS),this.getResource(e,t)}getDataByLanguage(e){return this.data[e]}hasLanguageSomeTranslations(e){let t=this.getDataByLanguage(e);return!!(t&&Object.keys(t)||[]).find(e=>t[e]&&Object.keys(t[e]).length>0)}toJSON(){return this.data}}var I={processors:{},addPostProcessor(e){this.processors[e.name]=e},handle(e,t,i,r,n){return e.forEach(e=>{t=this.processors[e]?.process(t,i,r,n)??t}),t}};let R=Symbol("i18next/PATH_KEY");function C(e,t){let i,r,n,{[R]:a}=e((r=[],(n=Object.create(null)).get=(e,t)=>(i?.revoke?.(),t===R)?r:(r.push(t),(i=Proxy.revocable(e,n)).proxy),Proxy.revocable(Object.create(null),n).proxy));return a.join(t?.keySeparator??".")}let b={},y=e=>!r(e)&&"boolean"!=typeof e&&"number"!=typeof e;class L extends A{constructor(e,t={}){super(),((e,t,i)=>{e.forEach(e=>{t[e]&&(i[e]=t[e])})})(["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat","utils"],e,this),this.options=t,void 0===this.options.keySeparator&&(this.options.keySeparator="."),this.logger=T.create("translator")}changeLanguage(e){e&&(this.language=e)}exists(e,t={interpolation:{}}){let i={...t};if(null==e)return!1;let r=this.resolve(e,i);if(r?.res===void 0)return!1;let n=y(r.res);return!1!==i.returnObjects||!n}extractFromKey(e,t){let i=void 0!==t.nsSeparator?t.nsSeparator:this.options.nsSeparator;void 0===i&&(i=":");let n=void 0!==t.keySeparator?t.keySeparator:this.options.keySeparator,a=t.ns||this.options.defaultNS||[],o=i&&e.indexOf(i)>-1,s=!this.options.userDefinedKeySeparator&&!t.keySeparator&&!this.options.userDefinedNsSeparator&&!t.nsSeparator&&!((e,t,i)=>{t=t||"",i=i||"";let r=m.filter(e=>0>t.indexOf(e)&&0>i.indexOf(e));if(0===r.length)return!0;let n=_.getRegExp(`(${r.map(e=>"?"===e?"\\?":e).join("|")})`),a=!n.test(e);if(!a){let t=e.indexOf(i);t>0&&!n.test(e.substring(0,t))&&(a=!0)}return a})(e,i,n);if(o&&!s){let t=e.match(this.interpolator.nestingRegexp);if(t&&t.length>0)return{key:e,namespaces:r(a)?[a]:a};let o=e.split(i);(i!==n||i===n&&this.options.ns.indexOf(o[0])>-1)&&(a=o.shift()),e=o.join(n)}return{key:e,namespaces:r(a)?[a]:a}}translate(e,t,i){let n="object"==typeof t?{...t}:t;if("object"!=typeof n&&this.options.overloadTranslationOptionHandler&&(n=this.options.overloadTranslationOptionHandler(arguments)),"object"==typeof n&&(n={...n}),n||(n={}),null==e)return"";"function"==typeof e&&(e=C(e,{...this.options,...n})),Array.isArray(e)||(e=[String(e)]);let a=void 0!==n.returnDetails?n.returnDetails:this.options.returnDetails,o=void 0!==n.keySeparator?n.keySeparator:this.options.keySeparator,{key:s,namespaces:l}=this.extractFromKey(e[e.length-1],n),c=l[l.length-1],f=void 0!==n.nsSeparator?n.nsSeparator:this.options.nsSeparator;void 0===f&&(f=":");let u=n.lng||this.language,d=n.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(u?.toLowerCase()==="cimode")return d?a?{res:`${c}${f}${s}`,usedKey:s,exactUsedKey:s,usedLng:u,usedNS:c,usedParams:this.getUsedParamsDetails(n)}:`${c}${f}${s}`:a?{res:s,usedKey:s,exactUsedKey:s,usedLng:u,usedNS:c,usedParams:this.getUsedParamsDetails(n)}:s;let h=this.resolve(e,n),p=h?.res,m=h?.usedKey||s,_=h?.exactUsedKey||s,g=void 0!==n.joinArrays?n.joinArrays:this.options.joinArrays,v=!this.i18nFormat||this.i18nFormat.handleAsObject,S=void 0!==n.count&&!r(n.count),E=L.hasDefaultValue(n),T=S?this.pluralResolver.getSuffix(u,n.count,n):"",A=n.ordinal&&S?this.pluralResolver.getSuffix(u,n.count,{ordinal:!1}):"",x=S&&!n.ordinal&&0===n.count,I=x&&n[`defaultValue${this.options.pluralSeparator}zero`]||n[`defaultValue${T}`]||n[`defaultValue${A}`]||n.defaultValue,R=p;v&&!p&&E&&(R=I);let b=y(R),M=Object.prototype.toString.apply(R);if(v&&R&&b&&0>["[object Number]","[object Function]","[object RegExp]"].indexOf(M)&&!(r(g)&&Array.isArray(R))){if(!n.returnObjects&&!this.options.returnObjects){this.options.returnedObjectHandler||this.logger.warn("accessing an object - but returnObjects options is not enabled!");let e=this.options.returnedObjectHandler?this.options.returnedObjectHandler(m,R,{...n,ns:l}):`key '${s} (${this.language})' returned an object instead of string.`;return a?(h.res=e,h.usedParams=this.getUsedParamsDetails(n),h):e}if(o){let e=Array.isArray(R),t=e?[]:{},i=e?_:m;for(let e in R)if(Object.prototype.hasOwnProperty.call(R,e)){let r=`${i}${o}${e}`;E&&!p?t[e]=this.translate(r,{...n,defaultValue:y(I)?I[e]:void 0,...{joinArrays:!1,ns:l}}):t[e]=this.translate(r,{...n,joinArrays:!1,ns:l}),t[e]===r&&(t[e]=R[e])}p=t}}else if(v&&r(g)&&Array.isArray(p))(p=p.join(g))&&(p=this.extendTranslation(p,e,n,i));else{let t=!1,r=!1;!this.isValidLookup(p)&&E&&(t=!0,p=I),this.isValidLookup(p)||(r=!0,p=s);let a=(n.missingKeyNoValueFallbackToKey||this.options.missingKeyNoValueFallbackToKey)&&r?void 0:p,l=E&&I!==p&&this.options.updateMissing;if(r||t||l){if(this.logger.log(l?"updateKey":"missingKey",u,c,s,l?I:p),o){let e=this.resolve(s,{...n,keySeparator:!1});e&&e.res&&this.logger.warn("Seems the loaded translations were in flat JSON format instead of nested. Either set keySeparator: false on init or make sure your translations are published in nested format.")}let e=[],t=this.languageUtils.getFallbackCodes(this.options.fallbackLng,n.lng||this.language);if("fallback"===this.options.saveMissingTo&&t&&t[0])for(let i=0;i<t.length;i++)e.push(t[i]);else"all"===this.options.saveMissingTo?e=this.languageUtils.toResolveHierarchy(n.lng||this.language):e.push(n.lng||this.language);let i=(e,t,i)=>{let r=E&&i!==p?i:a;this.options.missingKeyHandler?this.options.missingKeyHandler(e,c,t,r,l,n):this.backendConnector?.saveMissing&&this.backendConnector.saveMissing(e,c,t,r,l,n),this.emit("missingKey",e,c,t,p)};this.options.saveMissing&&(this.options.saveMissingPlurals&&S?e.forEach(e=>{let t=this.pluralResolver.getSuffixes(e,n);x&&n[`defaultValue${this.options.pluralSeparator}zero`]&&0>t.indexOf(`${this.options.pluralSeparator}zero`)&&t.push(`${this.options.pluralSeparator}zero`),t.forEach(t=>{i([e],s+t,n[`defaultValue${t}`]||I)})}):i(e,s,I))}p=this.extendTranslation(p,e,n,h,i),r&&p===s&&this.options.appendNamespaceToMissingKey&&(p=`${c}${f}${s}`),(r||t)&&this.options.parseMissingKeyHandler&&(p=this.options.parseMissingKeyHandler(this.options.appendNamespaceToMissingKey?`${c}${f}${s}`:s,t?p:void 0,n))}return a?(h.res=p,h.usedParams=this.getUsedParamsDetails(n),h):p}extendTranslation(e,t,i,n,a){if(this.i18nFormat?.parse)e=this.i18nFormat.parse(e,{...this.options.interpolation.defaultVariables,...i},i.lng||this.language||n.usedLng,n.usedNS,n.usedKey,{resolved:n});else if(!i.skipInterpolation){let o;i.interpolation&&this.interpolator.init({...i,...{interpolation:{...this.options.interpolation,...i.interpolation}}});let s=r(e)&&(i?.interpolation?.skipOnVariables!==void 0?i.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables);if(s){let t=e.match(this.interpolator.nestingRegexp);o=t&&t.length}let l=i.replace&&!r(i.replace)?i.replace:i;if(this.options.interpolation.defaultVariables&&(l={...this.options.interpolation.defaultVariables,...l}),e=this.interpolator.interpolate(e,l,i.lng||this.language||n.usedLng,i),s){let t=e.match(this.interpolator.nestingRegexp);o<(t&&t.length)&&(i.nest=!1)}!i.lng&&n&&n.res&&(i.lng=this.language||n.usedLng),!1!==i.nest&&(e=this.interpolator.nest(e,(...e)=>a?.[0]!==e[0]||i.context?this.translate(...e,t):(this.logger.warn(`It seems you are nesting recursively key: ${e[0]} in key: ${t[0]}`),null),i)),i.interpolation&&this.interpolator.reset()}let o=i.postProcess||this.options.postProcess,s=r(o)?[o]:o;return null!=e&&s?.length&&!1!==i.applyPostProcessor&&(e=I.handle(s,e,t,this.options&&this.options.postProcessPassResolved?{i18nResolved:{...n,usedParams:this.getUsedParamsDetails(i)},...i}:i,this)),e}resolve(e,t={}){let i,n,a,o,s;return r(e)&&(e=[e]),e.forEach(e=>{if(this.isValidLookup(i))return;let l=this.extractFromKey(e,t),c=l.key;n=c;let f=l.namespaces;this.options.fallbackNS&&(f=f.concat(this.options.fallbackNS));let u=void 0!==t.count&&!r(t.count),d=u&&!t.ordinal&&0===t.count,h=void 0!==t.context&&(r(t.context)||"number"==typeof t.context)&&""!==t.context,p=t.lngs?t.lngs:this.languageUtils.toResolveHierarchy(t.lng||this.language,t.fallbackLng);f.forEach(e=>{this.isValidLookup(i)||(s=e,!b[`${p[0]}-${e}`]&&this.utils?.hasLoadedNamespace&&!this.utils?.hasLoadedNamespace(s)&&(b[`${p[0]}-${e}`]=!0,this.logger.warn(`key "${n}" for languages "${p.join(", ")}" won't get resolved as namespace "${s}" was not yet loaded`,"This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!")),p.forEach(r=>{let n;if(this.isValidLookup(i))return;o=r;let s=[c];if(this.i18nFormat?.addLookupKeys)this.i18nFormat.addLookupKeys(s,c,r,e,t);else{let e;u&&(e=this.pluralResolver.getSuffix(r,t.count,t));let i=`${this.options.pluralSeparator}zero`,n=`${this.options.pluralSeparator}ordinal${this.options.pluralSeparator}`;if(u&&(t.ordinal&&0===e.indexOf(n)&&s.push(c+e.replace(n,this.options.pluralSeparator)),s.push(c+e),d&&s.push(c+i)),h){let r=`${c}${this.options.contextSeparator||"_"}${t.context}`;s.push(r),u&&(t.ordinal&&0===e.indexOf(n)&&s.push(r+e.replace(n,this.options.pluralSeparator)),s.push(r+e),d&&s.push(r+i))}}for(;n=s.pop();)this.isValidLookup(i)||(a=n,i=this.getResource(r,e,n,t))}))})}),{res:i,usedKey:n,exactUsedKey:a,usedLng:o,usedNS:s}}isValidLookup(e){return void 0!==e&&!(!this.options.returnNull&&null===e)&&!(!this.options.returnEmptyString&&""===e)}getResource(e,t,i,r={}){return this.i18nFormat?.getResource?this.i18nFormat.getResource(e,t,i,r):this.resourceStore.getResource(e,t,i,r)}getUsedParamsDetails(e={}){let t=e.replace&&!r(e.replace),i=t?e.replace:e;if(t&&void 0!==e.count&&(i.count=e.count),this.options.interpolation.defaultVariables&&(i={...this.options.interpolation.defaultVariables,...i}),!t)for(let e of(i={...i},["defaultValue","ordinal","context","replace","lng","lngs","fallbackLng","ns","keySeparator","nsSeparator","returnObjects","returnDetails","joinArrays","postProcess","interpolation"]))delete i[e];return i}static hasDefaultValue(e){let t="defaultValue";for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&t===i.substring(0,t.length)&&void 0!==e[i])return!0;return!1}}class M{constructor(e){this.options=e,this.supportedLngs=this.options.supportedLngs||!1,this.logger=T.create("languageUtils")}getScriptPartFromCode(e){if(!(e=v(e))||0>e.indexOf("-"))return null;let t=e.split("-");return 2===t.length||(t.pop(),"x"===t[t.length-1].toLowerCase())?null:this.formatLanguageCode(t.join("-"))}getLanguagePartFromCode(e){if(!(e=v(e))||0>e.indexOf("-"))return e;let t=e.split("-");return this.formatLanguageCode(t[0])}formatLanguageCode(e){if(r(e)&&e.indexOf("-")>-1){let t;try{t=Intl.getCanonicalLocales(e)[0]}catch(e){}return(t&&this.options.lowerCaseLng&&(t=t.toLowerCase()),t)?t:this.options.lowerCaseLng?e.toLowerCase():e}return this.options.cleanCode||this.options.lowerCaseLng?e.toLowerCase():e}isSupportedCode(e){return("languageOnly"===this.options.load||this.options.nonExplicitSupportedLngs)&&(e=this.getLanguagePartFromCode(e)),!this.supportedLngs||!this.supportedLngs.length||this.supportedLngs.indexOf(e)>-1}getBestMatchFromCodes(e){let t;return e?(e.forEach(e=>{if(t)return;let i=this.formatLanguageCode(e);(!this.options.supportedLngs||this.isSupportedCode(i))&&(t=i)}),!t&&this.options.supportedLngs&&e.forEach(e=>{if(t)return;let i=this.getScriptPartFromCode(e);if(this.isSupportedCode(i))return t=i;let r=this.getLanguagePartFromCode(e);if(this.isSupportedCode(r))return t=r;t=this.options.supportedLngs.find(e=>{if(e===r||!(0>e.indexOf("-")&&0>r.indexOf("-"))&&(e.indexOf("-")>0&&0>r.indexOf("-")&&e.substring(0,e.indexOf("-"))===r||0===e.indexOf(r)&&r.length>1))return e})}),t||(t=this.getFallbackCodes(this.options.fallbackLng)[0]),t):null}getFallbackCodes(e,t){if(!e)return[];if("function"==typeof e&&(e=e(t)),r(e)&&(e=[e]),Array.isArray(e))return e;if(!t)return e.default||[];let i=e[t];return i||(i=e[this.getScriptPartFromCode(t)]),i||(i=e[this.formatLanguageCode(t)]),i||(i=e[this.getLanguagePartFromCode(t)]),i||(i=e.default),i||[]}toResolveHierarchy(e,t){let i=this.getFallbackCodes((!1===t?[]:t)||this.options.fallbackLng||[],e),n=[],a=e=>{e&&(this.isSupportedCode(e)?n.push(e):this.logger.warn(`rejecting language code not found in supportedLngs: ${e}`))};return r(e)&&(e.indexOf("-")>-1||e.indexOf("_")>-1)?("languageOnly"!==this.options.load&&a(this.formatLanguageCode(e)),"languageOnly"!==this.options.load&&"currentOnly"!==this.options.load&&a(this.getScriptPartFromCode(e)),"currentOnly"!==this.options.load&&a(this.getLanguagePartFromCode(e))):r(e)&&a(this.formatLanguageCode(e)),i.forEach(e=>{0>n.indexOf(e)&&a(this.formatLanguageCode(e))}),n}}let P={zero:0,one:1,two:2,few:3,many:4,other:5},N={select:e=>1===e?"one":"other",resolvedOptions:()=>({pluralCategories:["one","other"]})};class D{constructor(e,t={}){this.languageUtils=e,this.options=t,this.logger=T.create("pluralResolver"),this.pluralRulesCache={}}addRule(e,t){this.rules[e]=t}clearCache(){this.pluralRulesCache={}}getRule(e,t={}){let i,r=v("dev"===e?"en":e),n=t.ordinal?"ordinal":"cardinal",a=JSON.stringify({cleanedCode:r,type:n});if(a in this.pluralRulesCache)return this.pluralRulesCache[a];try{i=new Intl.PluralRules(r,{type:n})}catch(n){if(!Intl)return this.logger.error("No Intl support, please use an Intl polyfill!"),N;if(!e.match(/-|_/))return N;let r=this.languageUtils.getLanguagePartFromCode(e);i=this.getRule(r,t)}return this.pluralRulesCache[a]=i,i}needsPlural(e,t={}){let i=this.getRule(e,t);return i||(i=this.getRule("dev",t)),i?.resolvedOptions().pluralCategories.length>1}getPluralFormsOfKey(e,t,i={}){return this.getSuffixes(e,i).map(e=>`${t}${e}`)}getSuffixes(e,t={}){let i=this.getRule(e,t);return(i||(i=this.getRule("dev",t)),i)?i.resolvedOptions().pluralCategories.sort((e,t)=>P[e]-P[t]).map(e=>`${this.options.prepend}${t.ordinal?`ordinal${this.options.prepend}`:""}${e}`):[]}getSuffix(e,t,i={}){let r=this.getRule(e,i);return r?`${this.options.prepend}${i.ordinal?`ordinal${this.options.prepend}`:""}${r.select(t)}`:(this.logger.warn(`no plural rule found for: ${e}`),this.getSuffix("dev",t,i))}}let O=(e,t,i,n=".",a=!0)=>{let o,s=void 0!==(o=u(e,i))?o:u(t,i);return!s&&a&&r(i)&&void 0===(s=g(e,i,n))&&(s=g(t,i,n)),s};class F{constructor(e={}){this.logger=T.create("interpolator"),this.options=e,this.format=e?.interpolation?.format||(e=>e),this.init(e)}init(e={}){e.interpolation||(e.interpolation={escapeValue:!0});let{escape:t,escapeValue:i,useRawValueToEscape:r,prefix:n,prefixEscaped:a,suffix:o,suffixEscaped:s,formatSeparator:l,unescapeSuffix:c,unescapePrefix:f,nestingPrefix:u,nestingPrefixEscaped:d,nestingSuffix:h,nestingSuffixEscaped:m,nestingOptionsSeparator:_,maxReplaces:g,alwaysFormat:v}=e.interpolation;this.escape=void 0!==t?t:p,this.escapeValue=void 0===i||i,this.useRawValueToEscape=void 0!==r&&r,this.prefix=n?n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"):a||"{{",this.suffix=o?o.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"):s||"}}",this.formatSeparator=l||",",this.unescapePrefix=c?"":f||"-",this.unescapeSuffix=this.unescapePrefix?"":c||"",this.nestingPrefix=u?u.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"):d||"$t(".replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),this.nestingSuffix=h?h.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"):m||")".replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),this.nestingOptionsSeparator=_||",",this.maxReplaces=g||1e3,this.alwaysFormat=void 0!==v&&v,this.resetRegExp()}reset(){this.options&&this.init(this.options)}resetRegExp(){let e=(e,t)=>e?.source===t?(e.lastIndex=0,e):RegExp(t,"g");this.regexp=e(this.regexp,`${this.prefix}(.+?)${this.suffix}`),this.regexpUnescape=e(this.regexpUnescape,`${this.prefix}${this.unescapePrefix}(.+?)${this.unescapeSuffix}${this.suffix}`),this.nestingRegexp=e(this.nestingRegexp,`${this.nestingPrefix}((?:[^()"']+|"[^"]*"|'[^']*'|\\((?:[^()]|"[^"]*"|'[^']*')*\\))*?)${this.nestingSuffix}`)}interpolate(e,t,i,n){let o,s,l,c=this.options&&this.options.interpolation&&this.options.interpolation.defaultVariables||{},f=e=>{if(0>e.indexOf(this.formatSeparator)){let r=O(t,c,e,this.options.keySeparator,this.options.ignoreJSONStructure);return this.alwaysFormat?this.format(r,void 0,i,{...n,...t,interpolationkey:e}):r}let r=e.split(this.formatSeparator),a=r.shift().trim(),o=r.join(this.formatSeparator).trim();return this.format(O(t,c,a,this.options.keySeparator,this.options.ignoreJSONStructure),o,i,{...n,...t,interpolationkey:a})};this.resetRegExp();let u=n?.missingInterpolationHandler||this.options.missingInterpolationHandler,d=n?.interpolation?.skipOnVariables!==void 0?n.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables;return[{regex:this.regexpUnescape,safeValue:e=>e.replace(/\$/g,"$$$$")},{regex:this.regexp,safeValue:e=>this.escapeValue?this.escape(e).replace(/\$/g,"$$$$"):e.replace(/\$/g,"$$$$")}].forEach(t=>{for(l=0;o=t.regex.exec(e);){let i=o[1].trim();if(void 0===(s=f(i)))if("function"==typeof u){let t=u(e,o,n);s=r(t)?t:""}else if(n&&Object.prototype.hasOwnProperty.call(n,i))s="";else if(d){s=o[0];continue}else this.logger.warn(`missed to pass in variable ${i} for interpolating ${e}`),s="";else r(s)||this.useRawValueToEscape||(s=a(s));let c=t.safeValue(s);if(e=e.replace(o[0],c),d?(t.regex.lastIndex+=s.length,t.regex.lastIndex-=o[0].length):t.regex.lastIndex=0,++l>=this.maxReplaces)break}}),e}nest(e,t,i={}){let n,o,s,l=(e,t)=>{let i=this.nestingOptionsSeparator;if(0>e.indexOf(i))return e;let r=e.split(RegExp(`${i}[ ]*{`)),n=`{${r[1]}`;e=r[0];let a=(n=this.interpolate(n,s)).match(/'/g),o=n.match(/"/g);((a?.length??0)%2!=0||o)&&o.length%2==0||(n=n.replace(/'/g,'"'));try{s=JSON.parse(n),t&&(s={...t,...s})}catch(t){return this.logger.warn(`failed parsing options string in nesting for key ${e}`,t),`${e}${i}${n}`}return s.defaultValue&&s.defaultValue.indexOf(this.prefix)>-1&&delete s.defaultValue,e};for(;n=this.nestingRegexp.exec(e);){let c=[];(s=(s={...i}).replace&&!r(s.replace)?s.replace:s).applyPostProcessor=!1,delete s.defaultValue;let f=/{.*}/.test(n[1])?n[1].lastIndexOf("}")+1:n[1].indexOf(this.formatSeparator);if(-1!==f&&(c=n[1].slice(f).split(this.formatSeparator).map(e=>e.trim()).filter(Boolean),n[1]=n[1].slice(0,f)),(o=t(l.call(this,n[1].trim(),s),s))&&n[0]===e&&!r(o))return o;r(o)||(o=a(o)),o||(this.logger.warn(`missed to resolve ${n[1]} for nesting ${e}`),o=""),c.length&&(o=c.reduce((e,t)=>this.format(e,t,i.lng,{...i,interpolationkey:n[1].trim()}),o.trim())),e=e.replace(n[0],o),this.regexp.lastIndex=0}return e}}let w=e=>{let t={};return(i,r,n)=>{let a=n;n&&n.interpolationkey&&n.formatParams&&n.formatParams[n.interpolationkey]&&n[n.interpolationkey]&&(a={...a,[n.interpolationkey]:void 0});let o=r+JSON.stringify(a),s=t[o];return s||(s=e(v(r),n),t[o]=s),s(i)}},B=e=>(t,i,r)=>e(v(i),r)(t);class U{constructor(e={}){this.logger=T.create("formatter"),this.options=e,this.init(e)}init(e,t={interpolation:{}}){this.formatSeparator=t.interpolation.formatSeparator||",";let i=t.cacheInBuiltFormats?w:B;this.formats={number:i((e,t)=>{let i=new Intl.NumberFormat(e,{...t});return e=>i.format(e)}),currency:i((e,t)=>{let i=new Intl.NumberFormat(e,{...t,style:"currency"});return e=>i.format(e)}),datetime:i((e,t)=>{let i=new Intl.DateTimeFormat(e,{...t});return e=>i.format(e)}),relativetime:i((e,t)=>{let i=new Intl.RelativeTimeFormat(e,{...t});return e=>i.format(e,t.range||"day")}),list:i((e,t)=>{let i=new Intl.ListFormat(e,{...t});return e=>i.format(e)})}}add(e,t){this.formats[e.toLowerCase().trim()]=t}addCached(e,t){this.formats[e.toLowerCase().trim()]=w(t)}format(e,t,i,r={}){let n=t.split(this.formatSeparator);if(n.length>1&&n[0].indexOf("(")>1&&0>n[0].indexOf(")")&&n.find(e=>e.indexOf(")")>-1)){let e=n.findIndex(e=>e.indexOf(")")>-1);n[0]=[n[0],...n.splice(1,e)].join(this.formatSeparator)}return n.reduce((e,t)=>{let{formatName:n,formatOptions:a}=(e=>{let t=e.toLowerCase().trim(),i={};if(e.indexOf("(")>-1){let r=e.split("(");t=r[0].toLowerCase().trim();let n=r[1].substring(0,r[1].length-1);"currency"===t&&0>n.indexOf(":")?i.currency||(i.currency=n.trim()):"relativetime"===t&&0>n.indexOf(":")?i.range||(i.range=n.trim()):n.split(";").forEach(e=>{if(e){let[t,...r]=e.split(":"),n=r.join(":").trim().replace(/^'+|'+$/g,""),a=t.trim();i[a]||(i[a]=n),"false"===n&&(i[a]=!1),"true"===n&&(i[a]=!0),isNaN(n)||(i[a]=parseInt(n,10))}})}return{formatName:t,formatOptions:i}})(t);if(this.formats[n]){let t=e;try{let o=r?.formatParams?.[r.interpolationkey]||{},s=o.locale||o.lng||r.locale||r.lng||i;t=this.formats[n](e,s,{...a,...r,...o})}catch(e){this.logger.warn(e)}return t}return this.logger.warn(`there was no format function for ${n}`),e},e)}}class G extends A{constructor(e,t,i,r={}){super(),this.backend=e,this.store=t,this.services=i,this.languageUtils=i.languageUtils,this.options=r,this.logger=T.create("backendConnector"),this.waitingReads=[],this.maxParallelReads=r.maxParallelReads||10,this.readingCalls=0,this.maxRetries=r.maxRetries>=0?r.maxRetries:5,this.retryTimeout=r.retryTimeout>=1?r.retryTimeout:350,this.state={},this.queue=[],this.backend?.init?.(i,r.backend,r)}queueLoad(e,t,i,r){let n={},a={},o={},s={};return e.forEach(e=>{let r=!0;t.forEach(t=>{let o=`${e}|${t}`;!i.reload&&this.store.hasResourceBundle(e,t)?this.state[o]=2:this.state[o]<0||(1===this.state[o]?void 0===a[o]&&(a[o]=!0):(this.state[o]=1,r=!1,void 0===a[o]&&(a[o]=!0),void 0===n[o]&&(n[o]=!0),void 0===s[t]&&(s[t]=!0)))}),r||(o[e]=!0)}),(Object.keys(n).length||Object.keys(a).length)&&this.queue.push({pending:a,pendingCount:Object.keys(a).length,loaded:{},errors:[],callback:r}),{toLoad:Object.keys(n),pending:Object.keys(a),toLoadLanguages:Object.keys(o),toLoadNamespaces:Object.keys(s)}}loaded(e,t,i){let r=e.split("|"),n=r[0],a=r[1];t&&this.emit("failedLoading",n,a,t),!t&&i&&this.store.addResourceBundle(n,a,i,void 0,void 0,{skipCopy:!0}),this.state[e]=t?-1:2,t&&i&&(this.state[e]=0);let o={};this.queue.forEach(i=>{((e,t,i,r)=>{let{obj:n,k:a}=c(e,t,Object);n[a]=n[a]||[],n[a].push(i)})(i.loaded,[n],a),void 0!==i.pending[e]&&(delete i.pending[e],i.pendingCount--),t&&i.errors.push(t),0!==i.pendingCount||i.done||(Object.keys(i.loaded).forEach(e=>{o[e]||(o[e]={});let t=i.loaded[e];t.length&&t.forEach(t=>{void 0===o[e][t]&&(o[e][t]=!0)})}),i.done=!0,i.errors.length?i.callback(i.errors):i.callback())}),this.emit("loaded",o),this.queue=this.queue.filter(e=>!e.done)}read(e,t,i,r=0,n=this.retryTimeout,a){if(!e.length)return a(null,{});if(this.readingCalls>=this.maxParallelReads)return void this.waitingReads.push({lng:e,ns:t,fcName:i,tried:r,wait:n,callback:a});this.readingCalls++;let o=(o,s)=>{if(this.readingCalls--,this.waitingReads.length>0){let e=this.waitingReads.shift();this.read(e.lng,e.ns,e.fcName,e.tried,e.wait,e.callback)}o&&s&&r<this.maxRetries?setTimeout(()=>{this.read.call(this,e,t,i,r+1,2*n,a)},n):a(o,s)},s=this.backend[i].bind(this.backend);if(2===s.length){try{let i=s(e,t);i&&"function"==typeof i.then?i.then(e=>o(null,e)).catch(o):o(null,i)}catch(e){o(e)}return}return s(e,t,o)}prepareLoading(e,t,i={},n){if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),n&&n();r(e)&&(e=this.languageUtils.toResolveHierarchy(e)),r(t)&&(t=[t]);let a=this.queueLoad(e,t,i,n);if(!a.toLoad.length)return a.pending.length||n(),null;a.toLoad.forEach(e=>{this.loadOne(e)})}load(e,t,i){this.prepareLoading(e,t,{},i)}reload(e,t,i){this.prepareLoading(e,t,{reload:!0},i)}loadOne(e,t=""){let i=e.split("|"),r=i[0],n=i[1];this.read(r,n,"read",void 0,void 0,(i,a)=>{i&&this.logger.warn(`${t}loading namespace ${n} for language ${r} failed`,i),!i&&a&&this.logger.log(`${t}loaded namespace ${n} for language ${r}`,a),this.loaded(e,i,a)})}saveMissing(e,t,i,r,n,a={},o=()=>{}){if(this.services?.utils?.hasLoadedNamespace&&!this.services?.utils?.hasLoadedNamespace(t))return void this.logger.warn(`did not save key "${i}" as the namespace "${t}" was not yet loaded`,"This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!");if(null!=i&&""!==i){if(this.backend?.create){let s={...a,isUpdate:n},l=this.backend.create.bind(this.backend);if(l.length<6)try{let n;(n=5===l.length?l(e,t,i,r,s):l(e,t,i,r))&&"function"==typeof n.then?n.then(e=>o(null,e)).catch(o):o(null,n)}catch(e){o(e)}else l(e,t,i,r,o,s)}e&&e[0]&&this.store.addResource(e[0],t,i,r)}}}let V=()=>({debug:!1,initAsync:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,supportedLngs:!1,nonExplicitSupportedLngs:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,postProcessPassResolved:!1,returnNull:!1,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:!1,parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:e=>{let t={};if("object"==typeof e[1]&&(t=e[1]),r(e[1])&&(t.defaultValue=e[1]),r(e[2])&&(t.tDescription=e[2]),"object"==typeof e[2]||"object"==typeof e[3]){let i=e[3]||e[2];Object.keys(i).forEach(e=>{t[e]=i[e]})}return t},interpolation:{escapeValue:!0,format:e=>e,prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",nestingOptionsSeparator:",",maxReplaces:1e3,skipOnVariables:!0},cacheInBuiltFormats:!0}),k=e=>(r(e.ns)&&(e.ns=[e.ns]),r(e.fallbackLng)&&(e.fallbackLng=[e.fallbackLng]),r(e.fallbackNS)&&(e.fallbackNS=[e.fallbackNS]),e.supportedLngs?.indexOf?.("cimode")<0&&(e.supportedLngs=e.supportedLngs.concat(["cimode"])),"boolean"==typeof e.initImmediate&&(e.initAsync=e.initImmediate),e),z=()=>{};class H extends A{constructor(e={},t){if(super(),this.options=k(e),this.services={},this.logger=T,this.modules={external:[]},(e=>{Object.getOwnPropertyNames(Object.getPrototypeOf(e)).forEach(t=>{"function"==typeof e[t]&&(e[t]=e[t].bind(e))})})(this),t&&!this.isInitialized&&!e.isClone){if(!this.options.initAsync)return this.init(e,t),this;setTimeout(()=>{this.init(e,t)},0)}}init(e={},t){this.isInitializing=!0,"function"==typeof e&&(t=e,e={}),null==e.defaultNS&&e.ns&&(r(e.ns)?e.defaultNS=e.ns:0>e.ns.indexOf("translation")&&(e.defaultNS=e.ns[0]));let i=V();this.options={...i,...this.options,...k(e)},this.options.interpolation={...i.interpolation,...this.options.interpolation},void 0!==e.keySeparator&&(this.options.userDefinedKeySeparator=e.keySeparator),void 0!==e.nsSeparator&&(this.options.userDefinedNsSeparator=e.nsSeparator);let a=e=>e?"function"==typeof e?new e:e:null;if(!this.options.isClone){let e;this.modules.logger?T.init(a(this.modules.logger),this.options):T.init(null,this.options),e=this.modules.formatter?this.modules.formatter:U;let t=new M(this.options);this.store=new x(this.options.resources,this.options);let r=this.services;r.logger=T,r.resourceStore=this.store,r.languageUtils=t,r.pluralResolver=new D(t,{prepend:this.options.pluralSeparator,simplifyPluralSuffix:this.options.simplifyPluralSuffix}),this.options.interpolation.format&&this.options.interpolation.format!==i.interpolation.format&&this.logger.deprecate("init: you are still using the legacy format function, please use the new approach: https://www.i18next.com/translation-function/formatting"),e&&(!this.options.interpolation.format||this.options.interpolation.format===i.interpolation.format)&&(r.formatter=a(e),r.formatter.init&&r.formatter.init(r,this.options),this.options.interpolation.format=r.formatter.format.bind(r.formatter)),r.interpolator=new F(this.options),r.utils={hasLoadedNamespace:this.hasLoadedNamespace.bind(this)},r.backendConnector=new G(a(this.modules.backend),r.resourceStore,r,this.options),r.backendConnector.on("*",(e,...t)=>{this.emit(e,...t)}),this.modules.languageDetector&&(r.languageDetector=a(this.modules.languageDetector),r.languageDetector.init&&r.languageDetector.init(r,this.options.detection,this.options)),this.modules.i18nFormat&&(r.i18nFormat=a(this.modules.i18nFormat),r.i18nFormat.init&&r.i18nFormat.init(this)),this.translator=new L(this.services,this.options),this.translator.on("*",(e,...t)=>{this.emit(e,...t)}),this.modules.external.forEach(e=>{e.init&&e.init(this)})}if(this.format=this.options.interpolation.format,t||(t=z),this.options.fallbackLng&&!this.services.languageDetector&&!this.options.lng){let e=this.services.languageUtils.getFallbackCodes(this.options.fallbackLng);e.length>0&&"dev"!==e[0]&&(this.options.lng=e[0])}this.services.languageDetector||this.options.lng||this.logger.warn("init: no languageDetector is used and no lng is defined"),["getResource","hasResourceBundle","getResourceBundle","getDataByLanguage"].forEach(e=>{this[e]=(...t)=>this.store[e](...t)}),["addResource","addResources","addResourceBundle","removeResourceBundle"].forEach(e=>{this[e]=(...t)=>(this.store[e](...t),this)});let o=n(),s=()=>{let e=(e,i)=>{this.isInitializing=!1,this.isInitialized&&!this.initializedStoreOnce&&this.logger.warn("init: i18next is already initialized. You should call init just once!"),this.isInitialized=!0,this.options.isClone||this.logger.log("initialized",this.options),this.emit("initialized",this.options),o.resolve(i),t(e,i)};if(this.languages&&!this.isInitialized)return e(null,this.t.bind(this));this.changeLanguage(this.options.lng,e)};return this.options.resources||!this.options.initAsync?s():setTimeout(s,0),o}loadResources(e,t=z){let i=t,n=r(e)?e:this.language;if("function"==typeof e&&(i=e),!this.options.resources||this.options.partialBundledLanguages){if(n?.toLowerCase()==="cimode"&&(!this.options.preload||0===this.options.preload.length))return i();let e=[],t=t=>{t&&"cimode"!==t&&this.services.languageUtils.toResolveHierarchy(t).forEach(t=>{"cimode"!==t&&0>e.indexOf(t)&&e.push(t)})};n?t(n):this.services.languageUtils.getFallbackCodes(this.options.fallbackLng).forEach(e=>t(e)),this.options.preload?.forEach?.(e=>t(e)),this.services.backendConnector.load(e,this.options.ns,e=>{e||this.resolvedLanguage||!this.language||this.setResolvedLanguage(this.language),i(e)})}else i(null)}reloadResources(e,t,i){let r=n();return"function"==typeof e&&(i=e,e=void 0),"function"==typeof t&&(i=t,t=void 0),e||(e=this.languages),t||(t=this.options.ns),i||(i=z),this.services.backendConnector.reload(e,t,e=>{r.resolve(),i(e)}),r}use(e){if(!e)throw Error("You are passing an undefined module! Please check the object you are passing to i18next.use()");if(!e.type)throw Error("You are passing a wrong module! Please check the object you are passing to i18next.use()");return"backend"===e.type&&(this.modules.backend=e),("logger"===e.type||e.log&&e.warn&&e.error)&&(this.modules.logger=e),"languageDetector"===e.type&&(this.modules.languageDetector=e),"i18nFormat"===e.type&&(this.modules.i18nFormat=e),"postProcessor"===e.type&&I.addPostProcessor(e),"formatter"===e.type&&(this.modules.formatter=e),"3rdParty"===e.type&&this.modules.external.push(e),this}setResolvedLanguage(e){if(e&&this.languages&&!(["cimode","dev"].indexOf(e)>-1)){for(let e=0;e<this.languages.length;e++){let t=this.languages[e];if(!(["cimode","dev"].indexOf(t)>-1)&&this.store.hasLanguageSomeTranslations(t)){this.resolvedLanguage=t;break}}!this.resolvedLanguage&&0>this.languages.indexOf(e)&&this.store.hasLanguageSomeTranslations(e)&&(this.resolvedLanguage=e,this.languages.unshift(e))}}changeLanguage(e,t){this.isLanguageChangingTo=e;let i=n();this.emit("languageChanging",e);let a=e=>{this.language=e,this.languages=this.services.languageUtils.toResolveHierarchy(e),this.resolvedLanguage=void 0,this.setResolvedLanguage(e)},o=(r,n)=>{n?this.isLanguageChangingTo===e&&(a(n),this.translator.changeLanguage(n),this.isLanguageChangingTo=void 0,this.emit("languageChanged",n),this.logger.log("languageChanged",n)):this.isLanguageChangingTo=void 0,i.resolve((...e)=>this.t(...e)),t&&t(r,(...e)=>this.t(...e))},s=t=>{e||t||!this.services.languageDetector||(t=[]);let i=r(t)?t:t&&t[0],n=this.store.hasLanguageSomeTranslations(i)?i:this.services.languageUtils.getBestMatchFromCodes(r(t)?[t]:t);n&&(this.language||a(n),this.translator.language||this.translator.changeLanguage(n),this.services.languageDetector?.cacheUserLanguage?.(n)),this.loadResources(n,e=>{o(e,n)})};return e||!this.services.languageDetector||this.services.languageDetector.async?!e&&this.services.languageDetector&&this.services.languageDetector.async?0===this.services.languageDetector.detect.length?this.services.languageDetector.detect().then(s):this.services.languageDetector.detect(s):s(e):s(this.services.languageDetector.detect()),i}getFixedT(e,t,i){let n=(e,t,...r)=>{let a,o;(a="object"!=typeof t?this.options.overloadTranslationOptionHandler([e,t].concat(r)):{...t}).lng=a.lng||n.lng,a.lngs=a.lngs||n.lngs,a.ns=a.ns||n.ns,""!==a.keyPrefix&&(a.keyPrefix=a.keyPrefix||i||n.keyPrefix);let s=this.options.keySeparator||".";return a.keyPrefix&&Array.isArray(e)?o=e.map(e=>("function"==typeof e&&(e=C(e,{...this.options,...t})),`${a.keyPrefix}${s}${e}`)):("function"==typeof e&&(e=C(e,{...this.options,...t})),o=a.keyPrefix?`${a.keyPrefix}${s}${e}`:e),this.t(o,a)};return r(e)?n.lng=e:n.lngs=e,n.ns=t,n.keyPrefix=i,n}t(...e){return this.translator?.translate(...e)}exists(...e){return this.translator?.exists(...e)}setDefaultNamespace(e){this.options.defaultNS=e}hasLoadedNamespace(e,t={}){if(!this.isInitialized)return this.logger.warn("hasLoadedNamespace: i18next was not initialized",this.languages),!1;if(!this.languages||!this.languages.length)return this.logger.warn("hasLoadedNamespace: i18n.languages were undefined or empty",this.languages),!1;let i=t.lng||this.resolvedLanguage||this.languages[0],r=!!this.options&&this.options.fallbackLng,n=this.languages[this.languages.length-1];if("cimode"===i.toLowerCase())return!0;let a=(e,t)=>{let i=this.services.backendConnector.state[`${e}|${t}`];return -1===i||0===i||2===i};if(t.precheck){let e=t.precheck(this,a);if(void 0!==e)return e}return!!(this.hasResourceBundle(i,e)||!this.services.backendConnector.backend||this.options.resources&&!this.options.partialBundledLanguages||a(i,e)&&(!r||a(n,e)))}loadNamespaces(e,t){let i=n();return this.options.ns?(r(e)&&(e=[e]),e.forEach(e=>{0>this.options.ns.indexOf(e)&&this.options.ns.push(e)}),this.loadResources(e=>{i.resolve(),t&&t(e)}),i):(t&&t(),Promise.resolve())}loadLanguages(e,t){let i=n();r(e)&&(e=[e]);let a=this.options.preload||[],o=e.filter(e=>0>a.indexOf(e)&&this.services.languageUtils.isSupportedCode(e));return o.length?(this.options.preload=a.concat(o),this.loadResources(e=>{i.resolve(),t&&t(e)}),i):(t&&t(),Promise.resolve())}dir(e){if(e||(e=this.resolvedLanguage||(this.languages?.length>0?this.languages[0]:this.language)),!e)return"rtl";try{let t=new Intl.Locale(e);if(t&&t.getTextInfo){let e=t.getTextInfo();if(e&&e.direction)return e.direction}}catch(e){}let t=this.services?.languageUtils||new M(V());return e.toLowerCase().indexOf("-latn")>1?"ltr":["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ug","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam","ckb"].indexOf(t.getLanguagePartFromCode(e))>-1||e.toLowerCase().indexOf("-arab")>1?"rtl":"ltr"}static createInstance(e={},t){let i=new H(e,t);return i.createInstance=H.createInstance,i}cloneInstance(e={},t=z){let i=e.forkResourceStore;i&&delete e.forkResourceStore;let r={...this.options,...e,isClone:!0},n=new H(r);return(void 0!==e.debug||void 0!==e.prefix)&&(n.logger=n.logger.clone(e)),["store","services","language"].forEach(e=>{n[e]=this[e]}),n.services={...this.services},n.services.utils={hasLoadedNamespace:n.hasLoadedNamespace.bind(n)},i&&(n.store=new x(Object.keys(this.store.data).reduce((e,t)=>(e[t]={...this.store.data[t]},e[t]=Object.keys(e[t]).reduce((i,r)=>(i[r]={...e[t][r]},i),e[t]),e),{}),r),n.services.resourceStore=n.store),n.translator=new L(n.services,r),n.translator.on("*",(e,...t)=>{n.emit(e,...t)}),n.init(r,t),n.translator.options=r,n.translator.backendConnector.services.utils={hasLoadedNamespace:n.hasLoadedNamespace.bind(n)},n}toJSON(){return{options:this.options,store:this.store,language:this.language,languages:this.languages,resolvedLanguage:this.resolvedLanguage}}}let W=H.createInstance();W.createInstance,W.dir;let X=W.init;W.loadResources,W.reloadResources,W.use,W.changeLanguage,W.getFixedT;let Y=W.t;W.exists,W.setDefaultNamespace,W.hasLoadedNamespace,W.loadNamespaces,W.loadLanguages},65959:function(e,t,i){i.d(t,{Tt:()=>r});function r(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&0>t.indexOf(r)&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,r=Object.getOwnPropertySymbols(e);n<r.length;n++)0>t.indexOf(r[n])&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]]);return i}},47526:function(e,t,i){var r,n;let a,o;function s(e,t,i){function r(i,r){if(i._zod||Object.defineProperty(i,"_zod",{value:{def:r,constr:o,traits:new Set},enumerable:!1}),i._zod.traits.has(e))return;i._zod.traits.add(e),t(i,r);let n=o.prototype,a=Object.keys(n);for(let e=0;e<a.length;e++){let t=a[e];t in i||(i[t]=n[t].bind(i))}}let n=i?.Parent??Object;class a extends n{}function o(e){var t;let n=i?.Parent?new a:this;for(let i of(r(n,e),(t=n._zod).deferred??(t.deferred=[]),n._zod.deferred))i();return n}return Object.defineProperty(a,"name",{value:e}),Object.defineProperty(o,"init",{value:r}),Object.defineProperty(o,Symbol.hasInstance,{value:t=>!!i?.Parent&&t instanceof i.Parent||t?._zod?.traits?.has(e)}),Object.defineProperty(o,"name",{value:e}),o}i.d(t,{gMt:()=>i$,vkY:()=>rf,Ikc:()=>iW,zMY:()=>iB,PVZ:()=>ij,YjP:()=>ic,euz:()=>i2,aig:()=>iD,YOg:()=>iz,L5J:()=>iG,Nlp:()=>rc,RZV:()=>rs,g1P:()=>iQ,mee:()=>i9,uRe:()=>im,k5n:()=>i0}),Object.freeze({status:"aborted"}),Symbol("zod_brand");class l extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class c extends Error{constructor(e){super(`Encountered unidirectional transform during encode: ${e}`),this.name="ZodEncodeError"}}let f={};function u(e){return e&&Object.assign(f,e),f}function d(e,t="|"){return e.map(e=>M(e)).join(t)}function h(e,t){return"bigint"==typeof t?t.toString():t}function p(e){return{get value(){{let t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function m(e){let t=+!!e.startsWith("^"),i=e.endsWith("$")?e.length-1:e.length;return e.slice(t,i)}let _=Symbol("evaluating");function g(e,t,i){let r;Object.defineProperty(e,t,{get(){if(r!==_)return void 0===r&&(r=_,r=i()),r},set(i){Object.defineProperty(e,t,{value:i})},configurable:!0})}function v(e,t,i){Object.defineProperty(e,t,{value:i,writable:!0,enumerable:!0,configurable:!0})}function S(...e){let t={};for(let i of e)Object.assign(t,Object.getOwnPropertyDescriptors(i));return Object.defineProperties({},t)}function E(e){return JSON.stringify(e)}let T="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function A(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}let x=p(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return Function(""),!0}catch(e){return!1}});function I(e){if(!1===A(e))return!1;let t=e.constructor;if(void 0===t||"function"!=typeof t)return!0;let i=t.prototype;return!1!==A(i)&&!1!==Object.prototype.hasOwnProperty.call(i,"isPrototypeOf")}function R(e){return I(e)?{...e}:Array.isArray(e)?[...e]:e}let C=new Set(["string","number","symbol"]);function b(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function y(e,t,i){let r=new e._zod.constr(t??e._zod.def);return(!t||i?.parent)&&(r._zod.parent=e),r}function L(e){if(!e)return{};if("string"==typeof e)return{error:()=>e};if(e?.message!==void 0){if(e?.error!==void 0)throw Error("Cannot specify both `message` and `error` params");e.error=e.message}return(delete e.message,"string"==typeof e.error)?{...e,error:()=>e.error}:e}function M(e){return"bigint"==typeof e?e.toString()+"n":"string"==typeof e?`"${e}"`:`${e}`}let P={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-0x80000000,0x7fffffff],uint32:[0,0xffffffff],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function N(e,t=0){if(!0===e.aborted)return!0;for(let i=t;i<e.issues.length;i++)if(e.issues[i]?.continue!==!0)return!0;return!1}function D(e,t){return t.map(t=>(t.path??(t.path=[]),t.path.unshift(e),t))}function O(e){return"string"==typeof e?e:e?.message}function F(e,t,i){let r={...e,path:e.path??[]};return e.message||(r.message=O(e.inst?._zod.def?.error?.(e))??O(t?.error?.(e))??O(i.customError?.(e))??O(i.localeError?.(e))??"Invalid input"),delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}function w(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function B(...e){let[t,i,r]=e;return"string"==typeof t?{message:t,code:"custom",input:i,inst:r}:{...t}}let U=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,h,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},G=s("$ZodError",U),V=s("$ZodError",U,{Parent:Error}),k=e=>(t,i,r,n)=>{let a=r?Object.assign(r,{async:!1}):{async:!1},o=t._zod.run({value:i,issues:[]},a);if(o instanceof Promise)throw new l;if(o.issues.length){let t=new(n?.Err??e)(o.issues.map(e=>F(e,a,u())));throw T(t,n?.callee),t}return o.value},z=e=>async(t,i,r,n)=>{let a=r?Object.assign(r,{async:!0}):{async:!0},o=t._zod.run({value:i,issues:[]},a);if(o instanceof Promise&&(o=await o),o.issues.length){let t=new(n?.Err??e)(o.issues.map(e=>F(e,a,u())));throw T(t,n?.callee),t}return o.value},H=e=>(t,i,r)=>{let n=r?{...r,async:!1}:{async:!1},a=t._zod.run({value:i,issues:[]},n);if(a instanceof Promise)throw new l;return a.issues.length?{success:!1,error:new(e??G)(a.issues.map(e=>F(e,n,u())))}:{success:!0,data:a.value}},W=H(V),X=e=>async(t,i,r)=>{let n=r?Object.assign(r,{async:!0}):{async:!0},a=t._zod.run({value:i,issues:[]},n);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new e(a.issues.map(e=>F(e,n,u())))}:{success:!0,data:a.value}},Y=X(V),$=/^[cC][^\s-]{8,}$/,q=/^[0-9a-z]+$/,Z=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,j=/^[0-9a-vA-V]{20}$/,K=/^[A-Za-z0-9]{27}$/,Q=/^[a-zA-Z0-9_-]{21}$/,J=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,ee=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,et=e=>e?RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,ei=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,er=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,en=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,ea=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,eo=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,es=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,el=/^[A-Za-z0-9_-]*$/,ec=/^\+(?:[0-9]){6,14}[0-9]$/,ef="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",eu=RegExp(`^${ef}$`);function ed(e){let t="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${t}`:0===e.precision?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}let eh=/^-?\d+$/,ep=/^-?\d+(?:\.\d+)?/,em=/^(?:true|false)$/i,e_=/^[^A-Z]*$/,eg=/^[^a-z]*$/,ev=s("$ZodCheck",(e,t)=>{var i;e._zod??(e._zod={}),e._zod.def=t,(i=e._zod).onattach??(i.onattach=[])}),eS={number:"number",bigint:"bigint",object:"date"},eE=s("$ZodCheckLessThan",(e,t)=>{ev.init(e,t);let i=eS[typeof t.value];e._zod.onattach.push(e=>{let i=e._zod.bag,r=(t.inclusive?i.maximum:i.exclusiveMaximum)??1/0;t.value<r&&(t.inclusive?i.maximum=t.value:i.exclusiveMaximum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value<=t.value:r.value<t.value)||r.issues.push({origin:i,code:"too_big",maximum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),eT=s("$ZodCheckGreaterThan",(e,t)=>{ev.init(e,t);let i=eS[typeof t.value];e._zod.onattach.push(e=>{let i=e._zod.bag,r=(t.inclusive?i.minimum:i.exclusiveMinimum)??-1/0;t.value>r&&(t.inclusive?i.minimum=t.value:i.exclusiveMinimum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value>=t.value:r.value>t.value)||r.issues.push({origin:i,code:"too_small",minimum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),eA=s("$ZodCheckMultipleOf",(e,t)=>{ev.init(e,t),e._zod.onattach.push(e=>{var i;(i=e._zod.bag).multipleOf??(i.multipleOf=t.value)}),e._zod.check=i=>{if(typeof i.value!=typeof t.value)throw Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof i.value?i.value%t.value===BigInt(0):0===function(e,t){let i=(e.toString().split(".")[1]||"").length,r=t.toString(),n=(r.split(".")[1]||"").length;if(0===n&&/\d?e-\d?/.test(r)){let e=r.match(/\d?e-(\d?)/);e?.[1]&&(n=Number.parseInt(e[1]))}let a=i>n?i:n;return Number.parseInt(e.toFixed(a).replace(".",""))%Number.parseInt(t.toFixed(a).replace(".",""))/10**a}(i.value,t.value))||i.issues.push({origin:typeof i.value,code:"not_multiple_of",divisor:t.value,input:i.value,inst:e,continue:!t.abort})}}),ex=s("$ZodCheckNumberFormat",(e,t)=>{ev.init(e,t),t.format=t.format||"float64";let i=t.format?.includes("int"),r=i?"int":"number",[n,a]=P[t.format];e._zod.onattach.push(e=>{let r=e._zod.bag;r.format=t.format,r.minimum=n,r.maximum=a,i&&(r.pattern=eh)}),e._zod.check=o=>{let s=o.value;if(i){if(!Number.isInteger(s))return void o.issues.push({expected:r,format:t.format,code:"invalid_type",continue:!1,input:s,inst:e});if(!Number.isSafeInteger(s))return void(s>0?o.issues.push({input:s,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort}):o.issues.push({input:s,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort}))}s<n&&o.issues.push({origin:"number",input:s,code:"too_small",minimum:n,inclusive:!0,inst:e,continue:!t.abort}),s>a&&o.issues.push({origin:"number",input:s,code:"too_big",maximum:a,inst:e})}}),eI=s("$ZodCheckMaxLength",(e,t)=>{var i;ev.init(e,t),(i=e._zod.def).when??(i.when=e=>{let t=e.value;return null!=t&&void 0!==t.length}),e._zod.onattach.push(e=>{let i=e._zod.bag.maximum??1/0;t.maximum<i&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=i=>{let r=i.value;if(r.length<=t.maximum)return;let n=w(r);i.issues.push({origin:n,code:"too_big",maximum:t.maximum,inclusive:!0,input:r,inst:e,continue:!t.abort})}}),eR=s("$ZodCheckMinLength",(e,t)=>{var i;ev.init(e,t),(i=e._zod.def).when??(i.when=e=>{let t=e.value;return null!=t&&void 0!==t.length}),e._zod.onattach.push(e=>{let i=e._zod.bag.minimum??-1/0;t.minimum>i&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=i=>{let r=i.value;if(r.length>=t.minimum)return;let n=w(r);i.issues.push({origin:n,code:"too_small",minimum:t.minimum,inclusive:!0,input:r,inst:e,continue:!t.abort})}}),eC=s("$ZodCheckLengthEquals",(e,t)=>{var i;ev.init(e,t),(i=e._zod.def).when??(i.when=e=>{let t=e.value;return null!=t&&void 0!==t.length}),e._zod.onattach.push(e=>{let i=e._zod.bag;i.minimum=t.length,i.maximum=t.length,i.length=t.length}),e._zod.check=i=>{let r=i.value,n=r.length;if(n===t.length)return;let a=w(r),o=n>t.length;i.issues.push({origin:a,...o?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:i.value,inst:e,continue:!t.abort})}}),eb=s("$ZodCheckStringFormat",(e,t)=>{var i,r;ev.init(e,t),e._zod.onattach.push(e=>{let i=e._zod.bag;i.format=t.format,t.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(t.pattern))}),t.pattern?(i=e._zod).check??(i.check=i=>{t.pattern.lastIndex=0,t.pattern.test(i.value)||i.issues.push({origin:"string",code:"invalid_format",format:t.format,input:i.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(r=e._zod).check??(r.check=()=>{})}),ey=s("$ZodCheckRegex",(e,t)=>{eb.init(e,t),e._zod.check=i=>{t.pattern.lastIndex=0,t.pattern.test(i.value)||i.issues.push({origin:"string",code:"invalid_format",format:"regex",input:i.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),eL=s("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=e_),eb.init(e,t)}),eM=s("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=eg),eb.init(e,t)}),eP=s("$ZodCheckIncludes",(e,t)=>{ev.init(e,t);let i=b(t.includes),r=new RegExp("number"==typeof t.position?`^.{${t.position}}${i}`:i);t.pattern=r,e._zod.onattach.push(e=>{let t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=i=>{i.value.includes(t.includes,t.position)||i.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:i.value,inst:e,continue:!t.abort})}}),eN=s("$ZodCheckStartsWith",(e,t)=>{ev.init(e,t);let i=RegExp(`^${b(t.prefix)}.*`);t.pattern??(t.pattern=i),e._zod.onattach.push(e=>{let t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(i)}),e._zod.check=i=>{i.value.startsWith(t.prefix)||i.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:i.value,inst:e,continue:!t.abort})}}),eD=s("$ZodCheckEndsWith",(e,t)=>{ev.init(e,t);let i=RegExp(`.*${b(t.suffix)}$`);t.pattern??(t.pattern=i),e._zod.onattach.push(e=>{let t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(i)}),e._zod.check=i=>{i.value.endsWith(t.suffix)||i.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:i.value,inst:e,continue:!t.abort})}}),eO=s("$ZodCheckOverwrite",(e,t)=>{ev.init(e,t),e._zod.check=e=>{e.value=t.tx(e.value)}});class eF{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e){e(this,{execution:"sync"}),e(this,{execution:"async"});return}let t=e.split("\n").filter(e=>e),i=Math.min(...t.map(e=>e.length-e.trimStart().length));for(let e of t.map(e=>e.slice(i)).map(e=>" ".repeat(2*this.indent)+e))this.content.push(e)}compile(){return Function(...this?.args,[...(this?.content??[""]).map(e=>`  ${e}`)].join("\n"))}}let ew={major:4,minor:1,patch:13},eB=s("$ZodType",(e,t)=>{var i;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=ew;let r=[...e._zod.def.checks??[]];for(let t of(e._zod.traits.has("$ZodCheck")&&r.unshift(e),r))for(let i of t._zod.onattach)i(e);if(0===r.length)(i=e._zod).deferred??(i.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{let t=(e,t,i)=>{let r,n=N(e);for(let a of t){if(a._zod.def.when){if(!a._zod.def.when(e))continue}else if(n)continue;let t=e.issues.length,o=a._zod.check(e);if(o instanceof Promise&&i?.async===!1)throw new l;if(r||o instanceof Promise)r=(r??Promise.resolve()).then(async()=>{await o,e.issues.length!==t&&(n||(n=N(e,t)))});else{if(e.issues.length===t)continue;n||(n=N(e,t))}}return r?r.then(()=>e):e},i=(i,n,a)=>{if(N(i))return i.aborted=!0,i;let o=t(n,r,a);if(o instanceof Promise){if(!1===a.async)throw new l;return o.then(t=>e._zod.parse(t,a))}return e._zod.parse(o,a)};e._zod.run=(n,a)=>{if(a.skipChecks)return e._zod.parse(n,a);if("backward"===a.direction){let t=e._zod.parse({value:n.value,issues:[]},{...a,skipChecks:!0});return t instanceof Promise?t.then(e=>i(e,n,a)):i(t,n,a)}let o=e._zod.parse(n,a);if(o instanceof Promise){if(!1===a.async)throw new l;return o.then(e=>t(e,r,a))}return t(o,r,a)}}e["~standard"]={validate:t=>{try{let i=W(e,t);return i.success?{value:i.data}:{issues:i.error?.issues}}catch(i){return Y(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),eU=s("$ZodString",(e,t)=>{var i;let r;eB.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(r=(i=e._zod.bag)?`[\\s\\S]{${i?.minimum??0},${i?.maximum??""}}`:"[\\s\\S]*",RegExp(`^${r}$`)),e._zod.parse=(i,r)=>{if(t.coerce)try{i.value=String(i.value)}catch(e){}return"string"==typeof i.value||i.issues.push({expected:"string",code:"invalid_type",input:i.value,inst:e}),i}}),eG=s("$ZodStringFormat",(e,t)=>{eb.init(e,t),eU.init(e,t)}),eV=s("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=ee),eG.init(e,t)}),ek=s("$ZodUUID",(e,t)=>{if(t.version){let e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(void 0===e)throw Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=et(e))}else t.pattern??(t.pattern=et());eG.init(e,t)}),ez=s("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=ei),eG.init(e,t)}),eH=s("$ZodURL",(e,t)=>{eG.init(e,t),e._zod.check=i=>{try{let r=i.value.trim(),n=new URL(r);t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(n.hostname)||i.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:t.hostname.source,input:i.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(n.protocol.endsWith(":")?n.protocol.slice(0,-1):n.protocol)||i.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:i.value,inst:e,continue:!t.abort})),t.normalize?i.value=n.href:i.value=r;return}catch(r){i.issues.push({code:"invalid_format",format:"url",input:i.value,inst:e,continue:!t.abort})}}}),eW=s("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),eG.init(e,t)}),eX=s("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=Q),eG.init(e,t)}),eY=s("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=$),eG.init(e,t)}),e$=s("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=q),eG.init(e,t)}),eq=s("$ZodULID",(e,t)=>{t.pattern??(t.pattern=Z),eG.init(e,t)}),eZ=s("$ZodXID",(e,t)=>{t.pattern??(t.pattern=j),eG.init(e,t)}),ej=s("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=K),eG.init(e,t)}),eK=s("$ZodISODateTime",(e,t)=>{let i,r,n;t.pattern??(i=ed({precision:t.precision}),r=["Z"],t.local&&r.push(""),t.offset&&r.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)"),n=`${i}(?:${r.join("|")})`,t.pattern=RegExp(`^${ef}T(?:${n})$`)),eG.init(e,t)}),eQ=s("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=eu),eG.init(e,t)}),eJ=s("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=RegExp(`^${ed(t)}$`)),eG.init(e,t)}),e0=s("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=J),eG.init(e,t)}),e1=s("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=er),eG.init(e,t),e._zod.bag.format="ipv4"}),e2=s("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=en),eG.init(e,t),e._zod.bag.format="ipv6",e._zod.check=i=>{try{new URL(`http://[${i.value}]`)}catch{i.issues.push({code:"invalid_format",format:"ipv6",input:i.value,inst:e,continue:!t.abort})}}}),e3=s("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=ea),eG.init(e,t)}),e4=s("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=eo),eG.init(e,t),e._zod.check=i=>{let r=i.value.split("/");try{if(2!==r.length)throw Error();let[e,t]=r;if(!t)throw Error();let i=Number(t);if(`${i}`!==t||i<0||i>128)throw Error();new URL(`http://[${e}]`)}catch{i.issues.push({code:"invalid_format",format:"cidrv6",input:i.value,inst:e,continue:!t.abort})}}});function e5(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}let e8=s("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=es),eG.init(e,t),e._zod.bag.contentEncoding="base64",e._zod.check=i=>{e5(i.value)||i.issues.push({code:"invalid_format",format:"base64",input:i.value,inst:e,continue:!t.abort})}}),e6=s("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=el),eG.init(e,t),e._zod.bag.contentEncoding="base64url",e._zod.check=i=>{!function(e){if(!el.test(e))return!1;let t=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return e5(t.padEnd(4*Math.ceil(t.length/4),"="))}(i.value)&&i.issues.push({code:"invalid_format",format:"base64url",input:i.value,inst:e,continue:!t.abort})}}),e9=s("$ZodE164",(e,t)=>{t.pattern??(t.pattern=ec),eG.init(e,t)}),e7=s("$ZodJWT",(e,t)=>{eG.init(e,t),e._zod.check=i=>{!function(e,t=null){try{let i=e.split(".");if(3!==i.length)return!1;let[r]=i;if(!r)return!1;let n=JSON.parse(atob(r));if("typ"in n&&n?.typ!=="JWT"||!n.alg||t&&(!("alg"in n)||n.alg!==t))return!1;return!0}catch{return!1}}(i.value,t.alg)&&i.issues.push({code:"invalid_format",format:"jwt",input:i.value,inst:e,continue:!t.abort})}}),te=s("$ZodNumber",(e,t)=>{eB.init(e,t),e._zod.pattern=e._zod.bag.pattern??ep,e._zod.parse=(i,r)=>{if(t.coerce)try{i.value=Number(i.value)}catch(e){}let n=i.value;if("number"==typeof n&&!Number.isNaN(n)&&Number.isFinite(n))return i;let a="number"==typeof n?Number.isNaN(n)?"NaN":Number.isFinite(n)?void 0:"Infinity":void 0;return i.issues.push({expected:"number",code:"invalid_type",input:n,inst:e,...a?{received:a}:{}}),i}}),tt=s("$ZodNumberFormat",(e,t)=>{ex.init(e,t),te.init(e,t)}),ti=s("$ZodBoolean",(e,t)=>{eB.init(e,t),e._zod.pattern=em,e._zod.parse=(i,r)=>{if(t.coerce)try{i.value=!!i.value}catch(e){}let n=i.value;return"boolean"==typeof n||i.issues.push({expected:"boolean",code:"invalid_type",input:n,inst:e}),i}}),tr=s("$ZodUnknown",(e,t)=>{eB.init(e,t),e._zod.parse=e=>e}),tn=s("$ZodNever",(e,t)=>{eB.init(e,t),e._zod.parse=(t,i)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)});function ta(e,t,i){e.issues.length&&t.issues.push(...D(i,e.issues)),t.value[i]=e.value}let to=s("$ZodArray",(e,t)=>{eB.init(e,t),e._zod.parse=(i,r)=>{let n=i.value;if(!Array.isArray(n))return i.issues.push({expected:"array",code:"invalid_type",input:n,inst:e}),i;i.value=Array(n.length);let a=[];for(let e=0;e<n.length;e++){let o=n[e],s=t.element._zod.run({value:o,issues:[]},r);s instanceof Promise?a.push(s.then(t=>ta(t,i,e))):ta(s,i,e)}return a.length?Promise.all(a).then(()=>i):i}});function ts(e,t,i,r){e.issues.length&&t.issues.push(...D(i,e.issues)),void 0===e.value?i in r&&(t.value[i]=void 0):t.value[i]=e.value}function tl(e){var t;let i=Object.keys(e.shape);for(let t of i)if(!e.shape?.[t]?._zod?.traits?.has("$ZodType"))throw Error(`Invalid element at key "${t}": expected a Zod schema`);let r=Object.keys(t=e.shape).filter(e=>"optional"===t[e]._zod.optin&&"optional"===t[e]._zod.optout);return{...e,keys:i,keySet:new Set(i),numKeys:i.length,optionalKeys:new Set(r)}}function tc(e,t,i,r,n,a){let o=[],s=n.keySet,l=n.catchall._zod,c=l.def.type;for(let n in t){if(s.has(n))continue;if("never"===c){o.push(n);continue}let a=l.run({value:t[n],issues:[]},r);a instanceof Promise?e.push(a.then(e=>ts(e,i,n,t))):ts(a,i,n,t)}return(o.length&&i.issues.push({code:"unrecognized_keys",keys:o,input:t,inst:a}),e.length)?Promise.all(e).then(()=>i):i}let tf=s("$ZodObject",(e,t)=>{let i;eB.init(e,t);let r=Object.getOwnPropertyDescriptor(t,"shape");if(!r?.get){let e=t.shape;Object.defineProperty(t,"shape",{get:()=>{let i={...e};return Object.defineProperty(t,"shape",{value:i}),i}})}let n=p(()=>tl(t));g(e._zod,"propValues",()=>{let e=t.shape,i={};for(let t in e){let r=e[t]._zod;if(r.values)for(let e of(i[t]??(i[t]=new Set),r.values))i[t].add(e)}return i});let a=t.catchall;e._zod.parse=(t,r)=>{i??(i=n.value);let o=t.value;if(!A(o))return t.issues.push({expected:"object",code:"invalid_type",input:o,inst:e}),t;t.value={};let s=[],l=i.shape;for(let e of i.keys){let i=l[e]._zod.run({value:o[e],issues:[]},r);i instanceof Promise?s.push(i.then(i=>ts(i,t,e,o))):ts(i,t,e,o)}return a?tc(s,o,t,r,n.value,e):s.length?Promise.all(s).then(()=>t):t}}),tu=s("$ZodObjectJIT",(e,t)=>{let i,r;tf.init(e,t);let n=e._zod.parse,a=p(()=>tl(t)),o=!f.jitless,s=o&&x.value,l=t.catchall;e._zod.parse=(c,f)=>{r??(r=a.value);let u=c.value;return A(u)?o&&s&&f?.async===!1&&!0!==f.jitless?(i||(i=(e=>{let t=new eF(["shape","payload","ctx"]),i=a.value,r=e=>{let t=E(e);return`shape[${t}]._zod.run({ value: input[${t}], issues: [] }, ctx)`};t.write("const input = payload.value;");let n=Object.create(null),o=0;for(let e of i.keys)n[e]=`key_${o++}`;for(let e of(t.write("const newResult = {};"),i.keys)){let i=n[e],a=E(e);t.write(`const ${i} = ${r(e)};`),t.write(`
        if (${i}.issues.length) {
          payload.issues = payload.issues.concat(${i}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${a}, ...iss.path] : [${a}]
          })));
        }
        
        
        if (${i}.value === undefined) {
          if (${a} in input) {
            newResult[${a}] = undefined;
          }
        } else {
          newResult[${a}] = ${i}.value;
        }
        
      `)}t.write("payload.value = newResult;"),t.write("return payload;");let s=t.compile();return(t,i)=>s(e,t,i)})(t.shape)),c=i(c,f),l)?tc([],u,c,f,r,e):c:n(c,f):(c.issues.push({expected:"object",code:"invalid_type",input:u,inst:e}),c)}});function td(e,t,i,r){for(let i of e)if(0===i.issues.length)return t.value=i.value,t;let n=e.filter(e=>!N(e));return 1===n.length?(t.value=n[0].value,n[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:i,errors:e.map(e=>e.issues.map(e=>F(e,r,u())))}),t)}let th=s("$ZodUnion",(e,t)=>{eB.init(e,t),g(e._zod,"optin",()=>t.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),g(e._zod,"optout",()=>t.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),g(e._zod,"values",()=>{if(t.options.every(e=>e._zod.values))return new Set(t.options.flatMap(e=>Array.from(e._zod.values)))}),g(e._zod,"pattern",()=>{if(t.options.every(e=>e._zod.pattern)){let e=t.options.map(e=>e._zod.pattern);return RegExp(`^(${e.map(e=>m(e.source)).join("|")})$`)}});let i=1===t.options.length,r=t.options[0]._zod.run;e._zod.parse=(n,a)=>{if(i)return r(n,a);let o=!1,s=[];for(let e of t.options){let t=e._zod.run({value:n.value,issues:[]},a);if(t instanceof Promise)s.push(t),o=!0;else{if(0===t.issues.length)return t;s.push(t)}}return o?Promise.all(s).then(t=>td(t,n,e,a)):td(s,n,e,a)}}),tp=s("$ZodDiscriminatedUnion",(e,t)=>{th.init(e,t);let i=e._zod.parse;g(e._zod,"propValues",()=>{let e={};for(let i of t.options){let r=i._zod.propValues;if(!r||0===Object.keys(r).length)throw Error(`Invalid discriminated union option at index "${t.options.indexOf(i)}"`);for(let[t,i]of Object.entries(r))for(let r of(e[t]||(e[t]=new Set),i))e[t].add(r)}return e});let r=p(()=>{let e=t.options,i=new Map;for(let r of e){let e=r._zod.propValues?.[t.discriminator];if(!e||0===e.size)throw Error(`Invalid discriminated union option at index "${t.options.indexOf(r)}"`);for(let t of e){if(i.has(t))throw Error(`Duplicate discriminator value "${String(t)}"`);i.set(t,r)}}return i});e._zod.parse=(n,a)=>{let o=n.value;if(!A(o))return n.issues.push({code:"invalid_type",expected:"object",input:o,inst:e}),n;let s=r.value.get(o?.[t.discriminator]);return s?s._zod.run(n,a):t.unionFallback?i(n,a):(n.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",discriminator:t.discriminator,input:o,path:[t.discriminator],inst:e}),n)}}),tm=s("$ZodIntersection",(e,t)=>{eB.init(e,t),e._zod.parse=(e,i)=>{let r=e.value,n=t.left._zod.run({value:r,issues:[]},i),a=t.right._zod.run({value:r,issues:[]},i);return n instanceof Promise||a instanceof Promise?Promise.all([n,a]).then(([t,i])=>t_(e,t,i)):t_(e,n,a)}});function t_(e,t,i){if(t.issues.length&&e.issues.push(...t.issues),i.issues.length&&e.issues.push(...i.issues),N(e))return e;let r=function e(t,i){if(t===i||t instanceof Date&&i instanceof Date&&+t==+i)return{valid:!0,data:t};if(I(t)&&I(i)){let r=Object.keys(i),n=Object.keys(t).filter(e=>-1!==r.indexOf(e)),a={...t,...i};for(let r of n){let n=e(t[r],i[r]);if(!n.valid)return{valid:!1,mergeErrorPath:[r,...n.mergeErrorPath]};a[r]=n.data}return{valid:!0,data:a}}if(Array.isArray(t)&&Array.isArray(i)){if(t.length!==i.length)return{valid:!1,mergeErrorPath:[]};let r=[];for(let n=0;n<t.length;n++){let a=e(t[n],i[n]);if(!a.valid)return{valid:!1,mergeErrorPath:[n,...a.mergeErrorPath]};r.push(a.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}(t.value,i.value);if(!r.valid)throw Error(`Unmergable intersection. Error path: ${JSON.stringify(r.mergeErrorPath)}`);return e.value=r.data,e}let tg=s("$ZodTuple",(e,t)=>{eB.init(e,t);let i=t.items;e._zod.parse=(r,n)=>{let a=r.value;if(!Array.isArray(a))return r.issues.push({input:a,inst:e,expected:"tuple",code:"invalid_type"}),r;r.value=[];let o=[],s=[...i].reverse().findIndex(e=>"optional"!==e._zod.optin),l=-1===s?0:i.length-s;if(!t.rest){let t=a.length>i.length,n=a.length<l-1;if(t||n)return r.issues.push({...t?{code:"too_big",maximum:i.length}:{code:"too_small",minimum:i.length},input:a,inst:e,origin:"array"}),r}let c=-1;for(let e of i){if(++c>=a.length&&c>=l)continue;let t=e._zod.run({value:a[c],issues:[]},n);t instanceof Promise?o.push(t.then(e=>tv(e,r,c))):tv(t,r,c)}if(t.rest)for(let e of a.slice(i.length)){c++;let i=t.rest._zod.run({value:e,issues:[]},n);i instanceof Promise?o.push(i.then(e=>tv(e,r,c))):tv(i,r,c)}return o.length?Promise.all(o).then(()=>r):r}});function tv(e,t,i){e.issues.length&&t.issues.push(...D(i,e.issues)),t.value[i]=e.value}let tS=s("$ZodRecord",(e,t)=>{eB.init(e,t),e._zod.parse=(i,r)=>{let n=i.value;if(!I(n))return i.issues.push({expected:"record",code:"invalid_type",input:n,inst:e}),i;let a=[],o=t.keyType._zod.values;if(o){let s;i.value={};let l=new Set;for(let e of o)if("string"==typeof e||"number"==typeof e||"symbol"==typeof e){l.add("number"==typeof e?e.toString():e);let o=t.valueType._zod.run({value:n[e],issues:[]},r);o instanceof Promise?a.push(o.then(t=>{t.issues.length&&i.issues.push(...D(e,t.issues)),i.value[e]=t.value})):(o.issues.length&&i.issues.push(...D(e,o.issues)),i.value[e]=o.value)}for(let e in n)l.has(e)||(s=s??[]).push(e);s&&s.length>0&&i.issues.push({code:"unrecognized_keys",input:n,inst:e,keys:s})}else for(let o of(i.value={},Reflect.ownKeys(n))){if("__proto__"===o)continue;let s=t.keyType._zod.run({value:o,issues:[]},r);if(s instanceof Promise)throw Error("Async schemas not supported in object keys currently");if(s.issues.length){i.issues.push({code:"invalid_key",origin:"record",issues:s.issues.map(e=>F(e,r,u())),input:o,path:[o],inst:e}),i.value[s.value]=s.value;continue}let l=t.valueType._zod.run({value:n[o],issues:[]},r);l instanceof Promise?a.push(l.then(e=>{e.issues.length&&i.issues.push(...D(o,e.issues)),i.value[s.value]=e.value})):(l.issues.length&&i.issues.push(...D(o,l.issues)),i.value[s.value]=l.value)}return a.length?Promise.all(a).then(()=>i):i}}),tE=s("$ZodEnum",(e,t)=>{var i;let r;eB.init(e,t);let n=(r=Object.values(i=t.entries).filter(e=>"number"==typeof e),Object.entries(i).filter(([e,t])=>-1===r.indexOf(+e)).map(([e,t])=>t)),a=new Set(n);e._zod.values=a,e._zod.pattern=RegExp(`^(${n.filter(e=>C.has(typeof e)).map(e=>"string"==typeof e?b(e):e.toString()).join("|")})$`),e._zod.parse=(t,i)=>{let r=t.value;return a.has(r)||t.issues.push({code:"invalid_value",values:n,input:r,inst:e}),t}}),tT=s("$ZodLiteral",(e,t)=>{if(eB.init(e,t),0===t.values.length)throw Error("Cannot create literal schema with no valid values");let i=new Set(t.values);e._zod.values=i,e._zod.pattern=RegExp(`^(${t.values.map(e=>"string"==typeof e?b(e):e?b(e.toString()):String(e)).join("|")})$`),e._zod.parse=(r,n)=>{let a=r.value;return i.has(a)||r.issues.push({code:"invalid_value",values:t.values,input:a,inst:e}),r}}),tA=s("$ZodTransform",(e,t)=>{eB.init(e,t),e._zod.parse=(i,r)=>{if("backward"===r.direction)throw new c(e.constructor.name);let n=t.transform(i.value,i);if(r.async)return(n instanceof Promise?n:Promise.resolve(n)).then(e=>(i.value=e,i));if(n instanceof Promise)throw new l;return i.value=n,i}});function tx(e,t){return e.issues.length&&void 0===t?{issues:[],value:void 0}:e}let tI=s("$ZodOptional",(e,t)=>{eB.init(e,t),e._zod.optin="optional",e._zod.optout="optional",g(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),g(e._zod,"pattern",()=>{let e=t.innerType._zod.pattern;return e?RegExp(`^(${m(e.source)})?$`):void 0}),e._zod.parse=(e,i)=>{if("optional"===t.innerType._zod.optin){let r=t.innerType._zod.run(e,i);return r instanceof Promise?r.then(t=>tx(t,e.value)):tx(r,e.value)}return void 0===e.value?e:t.innerType._zod.run(e,i)}}),tR=s("$ZodNullable",(e,t)=>{eB.init(e,t),g(e._zod,"optin",()=>t.innerType._zod.optin),g(e._zod,"optout",()=>t.innerType._zod.optout),g(e._zod,"pattern",()=>{let e=t.innerType._zod.pattern;return e?RegExp(`^(${m(e.source)}|null)$`):void 0}),g(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(e,i)=>null===e.value?e:t.innerType._zod.run(e,i)}),tC=s("$ZodDefault",(e,t)=>{eB.init(e,t),e._zod.optin="optional",g(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,i)=>{if("backward"===i.direction)return t.innerType._zod.run(e,i);if(void 0===e.value)return e.value=t.defaultValue,e;let r=t.innerType._zod.run(e,i);return r instanceof Promise?r.then(e=>tb(e,t)):tb(r,t)}});function tb(e,t){return void 0===e.value&&(e.value=t.defaultValue),e}let ty=s("$ZodPrefault",(e,t)=>{eB.init(e,t),e._zod.optin="optional",g(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,i)=>("backward"===i.direction||void 0===e.value&&(e.value=t.defaultValue),t.innerType._zod.run(e,i))}),tL=s("$ZodNonOptional",(e,t)=>{eB.init(e,t),g(e._zod,"values",()=>{let e=t.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(i,r)=>{let n=t.innerType._zod.run(i,r);return n instanceof Promise?n.then(t=>tM(t,e)):tM(n,e)}});function tM(e,t){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}let tP=s("$ZodCatch",(e,t)=>{eB.init(e,t),g(e._zod,"optin",()=>t.innerType._zod.optin),g(e._zod,"optout",()=>t.innerType._zod.optout),g(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,i)=>{if("backward"===i.direction)return t.innerType._zod.run(e,i);let r=t.innerType._zod.run(e,i);return r instanceof Promise?r.then(r=>(e.value=r.value,r.issues.length&&(e.value=t.catchValue({...e,error:{issues:r.issues.map(e=>F(e,i,u()))},input:e.value}),e.issues=[]),e)):(e.value=r.value,r.issues.length&&(e.value=t.catchValue({...e,error:{issues:r.issues.map(e=>F(e,i,u()))},input:e.value}),e.issues=[]),e)}}),tN=s("$ZodPipe",(e,t)=>{eB.init(e,t),g(e._zod,"values",()=>t.in._zod.values),g(e._zod,"optin",()=>t.in._zod.optin),g(e._zod,"optout",()=>t.out._zod.optout),g(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(e,i)=>{if("backward"===i.direction){let r=t.out._zod.run(e,i);return r instanceof Promise?r.then(e=>tD(e,t.in,i)):tD(r,t.in,i)}let r=t.in._zod.run(e,i);return r instanceof Promise?r.then(e=>tD(e,t.out,i)):tD(r,t.out,i)}});function tD(e,t,i){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},i)}let tO=s("$ZodReadonly",(e,t)=>{eB.init(e,t),g(e._zod,"propValues",()=>t.innerType._zod.propValues),g(e._zod,"values",()=>t.innerType._zod.values),g(e._zod,"optin",()=>t.innerType?._zod?.optin),g(e._zod,"optout",()=>t.innerType?._zod?.optout),e._zod.parse=(e,i)=>{if("backward"===i.direction)return t.innerType._zod.run(e,i);let r=t.innerType._zod.run(e,i);return r instanceof Promise?r.then(tF):tF(r)}});function tF(e){return e.value=Object.freeze(e.value),e}let tw=s("$ZodLazy",(e,t)=>{eB.init(e,t),g(e._zod,"innerType",()=>t.getter()),g(e._zod,"pattern",()=>e._zod.innerType?._zod?.pattern),g(e._zod,"propValues",()=>e._zod.innerType?._zod?.propValues),g(e._zod,"optin",()=>e._zod.innerType?._zod?.optin??void 0),g(e._zod,"optout",()=>e._zod.innerType?._zod?.optout??void 0),e._zod.parse=(t,i)=>e._zod.innerType._zod.run(t,i)}),tB=s("$ZodCustom",(e,t)=>{ev.init(e,t),eB.init(e,t),e._zod.parse=(e,t)=>e,e._zod.check=i=>{let r=i.value,n=t.fn(r);if(n instanceof Promise)return n.then(t=>tU(t,i,r,e));tU(n,i,r,e)}});function tU(e,t,i,r){if(!e){let e={code:"custom",input:i,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(e.params=r._zod.def.params),t.issues.push(B(e))}}Symbol("ZodOutput"),Symbol("ZodInput");(r=globalThis).__zod_globalRegistry??(r.__zod_globalRegistry=new class e{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...t){let i=t[0];if(this._map.set(e,i),i&&"object"==typeof i&&"id"in i){if(this._idmap.has(i.id))throw Error(`ID ${i.id} already exists in the registry`);this._idmap.set(i.id,e)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(e){let t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){let t=e._zod.parent;if(t){let i={...this.get(t)??{}};delete i.id;let r={...i,...this._map.get(e)};return Object.keys(r).length?r:void 0}return this._map.get(e)}has(e){return this._map.has(e)}});let tG=globalThis.__zod_globalRegistry;function tV(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...L(t)})}function tk(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...L(t)})}function tz(e,t){return new eE({check:"less_than",...L(t),value:e,inclusive:!1})}function tH(e,t){return new eE({check:"less_than",...L(t),value:e,inclusive:!0})}function tW(e,t){return new eT({check:"greater_than",...L(t),value:e,inclusive:!1})}function tX(e,t){return new eT({check:"greater_than",...L(t),value:e,inclusive:!0})}function tY(e,t){return new eA({check:"multiple_of",...L(t),value:e})}function t$(e,t){return new eI({check:"max_length",...L(t),maximum:e})}function tq(e,t){return new eR({check:"min_length",...L(t),minimum:e})}function tZ(e,t){return new eC({check:"length_equals",...L(t),length:e})}function tj(e){return new eO({check:"overwrite",tx:e})}let tK=s("ZodISODateTime",(e,t)=>{eK.init(e,t),iu.init(e,t)}),tQ=s("ZodISODate",(e,t)=>{eQ.init(e,t),iu.init(e,t)}),tJ=s("ZodISOTime",(e,t)=>{eJ.init(e,t),iu.init(e,t)}),t0=s("ZodISODuration",(e,t)=>{e0.init(e,t),iu.init(e,t)}),t1=(e,t)=>{G.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:t=>(function(e,t=e=>e.message){let i={_errors:[]},r=e=>{for(let n of e.issues)if("invalid_union"===n.code&&n.errors.length)n.errors.map(e=>r({issues:e}));else if("invalid_key"===n.code)r({issues:n.issues});else if("invalid_element"===n.code)r({issues:n.issues});else if(0===n.path.length)i._errors.push(t(n));else{let e=i,r=0;for(;r<n.path.length;){let i=n.path[r];r===n.path.length-1?(e[i]=e[i]||{_errors:[]},e[i]._errors.push(t(n))):e[i]=e[i]||{_errors:[]},e=e[i],r++}}};return r(e),i})(e,t)},flatten:{value:t=>(function(e,t=e=>e.message){let i={},r=[];for(let n of e.issues)n.path.length>0?(i[n.path[0]]=i[n.path[0]]||[],i[n.path[0]].push(t(n))):r.push(t(n));return{formErrors:r,fieldErrors:i}})(e,t)},addIssue:{value:t=>{e.issues.push(t),e.message=JSON.stringify(e.issues,h,2)}},addIssues:{value:t=>{e.issues.push(...t),e.message=JSON.stringify(e.issues,h,2)}},isEmpty:{get:()=>0===e.issues.length}})};s("ZodError",t1);let t2=s("ZodError",t1,{Parent:Error}),t3=k(t2),t4=z(t2),t5=H(t2),t8=X(t2),t6=(e,t,i)=>{let r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return k(t2)(e,t,r)},t9=(e,t,i)=>k(t2)(e,t,i),t7=async(e,t,i)=>{let r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return z(t2)(e,t,r)},ie=async(e,t,i)=>z(t2)(e,t,i),it=(e,t,i)=>{let r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return H(t2)(e,t,r)},ii=(e,t,i)=>H(t2)(e,t,i),ir=async(e,t,i)=>{let r=i?Object.assign(i,{direction:"backward"}):{direction:"backward"};return X(t2)(e,t,r)},ia=async(e,t,i)=>X(t2)(e,t,i),io=s("ZodType",(e,t)=>(eB.init(e,t),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...i)=>e.clone(S(t,{checks:[...t.checks??[],...i.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]})),e.clone=(t,i)=>y(e,t,i),e.brand=()=>e,e.register=(t,i)=>(t.add(e,i),e),e.parse=(t,i)=>t3(e,t,i,{callee:e.parse}),e.safeParse=(t,i)=>t5(e,t,i),e.parseAsync=async(t,i)=>t4(e,t,i,{callee:e.parseAsync}),e.safeParseAsync=async(t,i)=>t8(e,t,i),e.spa=e.safeParseAsync,e.encode=(t,i)=>t6(e,t,i),e.decode=(t,i)=>t9(e,t,i),e.encodeAsync=async(t,i)=>t7(e,t,i),e.decodeAsync=async(t,i)=>ie(e,t,i),e.safeEncode=(t,i)=>it(e,t,i),e.safeDecode=(t,i)=>ii(e,t,i),e.safeEncodeAsync=async(t,i)=>ir(e,t,i),e.safeDecodeAsync=async(t,i)=>ia(e,t,i),e.refine=(t,i)=>e.check(function(e,t={}){return new rl({type:"custom",check:"custom",fn:e,...L(t)})}(t,i)),e.superRefine=t=>e.check(function(e){var t;let i,r;return t=t=>(t.addIssue=e=>{"string"==typeof e?t.issues.push(B(e,t.value,i._zod.def)):(e.fatal&&(e.continue=!1),e.code??(e.code="custom"),e.input??(e.input=t.value),e.inst??(e.inst=i),e.continue??(e.continue=!i._zod.def.abort),t.issues.push(B(e)))},e(t.value,t)),(r=new ev({check:"custom",...L(void 0)}))._zod.check=t,i=r}(t)),e.overwrite=t=>e.check(tj(t)),e.optional=()=>i8(e),e.nullable=()=>i9(e),e.nullish=()=>i8(i9(e)),e.nonoptional=t=>new rt({type:"nonoptional",innerType:e,...L(t)}),e.array=()=>iz(e),e.or=t=>new iX({type:"union",options:[e,t],...L(void 0)}),e.and=t=>new iq({type:"intersection",left:e,right:t}),e.transform=t=>rn(e,i4(t)),e.default=t=>{var i,r;return i=e,r=t,new i7({type:"default",innerType:i,get defaultValue(){return"function"==typeof r?r():R(r)}})},e.prefault=t=>{var i,r;return i=e,r=t,new re({type:"prefault",innerType:i,get defaultValue(){return"function"==typeof r?r():R(r)}})},e.catch=t=>{var i;return new ri({type:"catch",innerType:e,catchValue:"function"==typeof(i=t)?i:()=>i})},e.pipe=t=>rn(e,t),e.readonly=()=>new ra({type:"readonly",innerType:e}),e.describe=t=>{let i=e.clone();return tG.add(i,{description:t}),i},Object.defineProperty(e,"description",{get:()=>tG.get(e)?.description,configurable:!0}),e.meta=(...t)=>{if(0===t.length)return tG.get(e);let i=e.clone();return tG.add(i,t[0]),i},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),is=s("_ZodString",(e,t)=>{eU.init(e,t),io.init(e,t);let i=e._zod.bag;e.format=i.format??null,e.minLength=i.minimum??null,e.maxLength=i.maximum??null,e.regex=(...t)=>e.check(function(e,t){return new ey({check:"string_format",format:"regex",...L(t),pattern:e})}(...t)),e.includes=(...t)=>e.check(function(e,t){return new eP({check:"string_format",format:"includes",...L(t),includes:e})}(...t)),e.startsWith=(...t)=>e.check(function(e,t){return new eN({check:"string_format",format:"starts_with",...L(t),prefix:e})}(...t)),e.endsWith=(...t)=>e.check(function(e,t){return new eD({check:"string_format",format:"ends_with",...L(t),suffix:e})}(...t)),e.min=(...t)=>e.check(tq(...t)),e.max=(...t)=>e.check(t$(...t)),e.length=(...t)=>e.check(tZ(...t)),e.nonempty=(...t)=>e.check(tq(1,...t)),e.lowercase=t=>e.check(new eL({check:"string_format",format:"lowercase",...L(t)})),e.uppercase=t=>e.check(new eM({check:"string_format",format:"uppercase",...L(t)})),e.trim=()=>e.check(tj(e=>e.trim())),e.normalize=(...t)=>e.check(function(e){return tj(t=>t.normalize(e))}(...t)),e.toLowerCase=()=>e.check(tj(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(tj(e=>e.toUpperCase())),e.slugify=()=>e.check(tj(e=>e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")))}),il=s("ZodString",(e,t)=>{eU.init(e,t),is.init(e,t),e.email=t=>e.check(new id({type:"string",format:"email",check:"string_format",abort:!1,...L(t)})),e.url=t=>e.check(new i_({type:"string",format:"url",check:"string_format",abort:!1,...L(t)})),e.jwt=t=>e.check(new iP({type:"string",format:"jwt",check:"string_format",abort:!1,...L(t)})),e.emoji=t=>e.check(new ig({type:"string",format:"emoji",check:"string_format",abort:!1,...L(t)})),e.guid=t=>e.check(tV(ih,t)),e.uuid=t=>e.check(tk(ip,t)),e.uuidv4=t=>e.check(new ip({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...L(t)})),e.uuidv6=t=>e.check(new ip({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...L(t)})),e.uuidv7=t=>e.check(new ip({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...L(t)})),e.nanoid=t=>e.check(new iv({type:"string",format:"nanoid",check:"string_format",abort:!1,...L(t)})),e.guid=t=>e.check(tV(ih,t)),e.cuid=t=>e.check(new iS({type:"string",format:"cuid",check:"string_format",abort:!1,...L(t)})),e.cuid2=t=>e.check(new iE({type:"string",format:"cuid2",check:"string_format",abort:!1,...L(t)})),e.ulid=t=>e.check(new iT({type:"string",format:"ulid",check:"string_format",abort:!1,...L(t)})),e.base64=t=>e.check(new iy({type:"string",format:"base64",check:"string_format",abort:!1,...L(t)})),e.base64url=t=>e.check(new iL({type:"string",format:"base64url",check:"string_format",abort:!1,...L(t)})),e.xid=t=>e.check(new iA({type:"string",format:"xid",check:"string_format",abort:!1,...L(t)})),e.ksuid=t=>e.check(new ix({type:"string",format:"ksuid",check:"string_format",abort:!1,...L(t)})),e.ipv4=t=>e.check(new iI({type:"string",format:"ipv4",check:"string_format",abort:!1,...L(t)})),e.ipv6=t=>e.check(new iR({type:"string",format:"ipv6",check:"string_format",abort:!1,...L(t)})),e.cidrv4=t=>e.check(new iC({type:"string",format:"cidrv4",check:"string_format",abort:!1,...L(t)})),e.cidrv6=t=>e.check(new ib({type:"string",format:"cidrv6",check:"string_format",abort:!1,...L(t)})),e.e164=t=>e.check(new iM({type:"string",format:"e164",check:"string_format",abort:!1,...L(t)})),e.datetime=t=>e.check(new tK({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...L(t)})),e.date=t=>e.check(new tQ({type:"string",format:"date",check:"string_format",...L(t)})),e.time=t=>e.check(new tJ({type:"string",format:"time",check:"string_format",precision:null,...L(t)})),e.duration=t=>e.check(new t0({type:"string",format:"duration",check:"string_format",...L(t)}))});function ic(e){return new il({type:"string",...L(e)})}let iu=s("ZodStringFormat",(e,t)=>{eG.init(e,t),is.init(e,t)}),id=s("ZodEmail",(e,t)=>{ez.init(e,t),iu.init(e,t)}),ih=s("ZodGUID",(e,t)=>{eV.init(e,t),iu.init(e,t)}),ip=s("ZodUUID",(e,t)=>{ek.init(e,t),iu.init(e,t)});function im(e){return tk(ip,e)}let i_=s("ZodURL",(e,t)=>{eH.init(e,t),iu.init(e,t)}),ig=s("ZodEmoji",(e,t)=>{eW.init(e,t),iu.init(e,t)}),iv=s("ZodNanoID",(e,t)=>{eX.init(e,t),iu.init(e,t)}),iS=s("ZodCUID",(e,t)=>{eY.init(e,t),iu.init(e,t)}),iE=s("ZodCUID2",(e,t)=>{e$.init(e,t),iu.init(e,t)}),iT=s("ZodULID",(e,t)=>{eq.init(e,t),iu.init(e,t)}),iA=s("ZodXID",(e,t)=>{eZ.init(e,t),iu.init(e,t)}),ix=s("ZodKSUID",(e,t)=>{ej.init(e,t),iu.init(e,t)}),iI=s("ZodIPv4",(e,t)=>{e1.init(e,t),iu.init(e,t)}),iR=s("ZodIPv6",(e,t)=>{e2.init(e,t),iu.init(e,t)}),iC=s("ZodCIDRv4",(e,t)=>{e3.init(e,t),iu.init(e,t)}),ib=s("ZodCIDRv6",(e,t)=>{e4.init(e,t),iu.init(e,t)}),iy=s("ZodBase64",(e,t)=>{e8.init(e,t),iu.init(e,t)}),iL=s("ZodBase64URL",(e,t)=>{e6.init(e,t),iu.init(e,t)}),iM=s("ZodE164",(e,t)=>{e9.init(e,t),iu.init(e,t)}),iP=s("ZodJWT",(e,t)=>{e7.init(e,t),iu.init(e,t)}),iN=s("ZodNumber",(e,t)=>{te.init(e,t),io.init(e,t),e.gt=(t,i)=>e.check(tW(t,i)),e.gte=(t,i)=>e.check(tX(t,i)),e.min=(t,i)=>e.check(tX(t,i)),e.lt=(t,i)=>e.check(tz(t,i)),e.lte=(t,i)=>e.check(tH(t,i)),e.max=(t,i)=>e.check(tH(t,i)),e.int=t=>e.check(iF(t)),e.safe=t=>e.check(iF(t)),e.positive=t=>e.check(tW(0,t)),e.nonnegative=t=>e.check(tX(0,t)),e.negative=t=>e.check(tz(0,t)),e.nonpositive=t=>e.check(tH(0,t)),e.multipleOf=(t,i)=>e.check(tY(t,i)),e.step=(t,i)=>e.check(tY(t,i)),e.finite=()=>e;let i=e._zod.bag;e.minValue=Math.max(i.minimum??-1/0,i.exclusiveMinimum??-1/0)??null,e.maxValue=Math.min(i.maximum??1/0,i.exclusiveMaximum??1/0)??null,e.isInt=(i.format??"").includes("int")||Number.isSafeInteger(i.multipleOf??.5),e.isFinite=!0,e.format=i.format??null});function iD(e){return new iN({type:"number",checks:[],...L(e)})}let iO=s("ZodNumberFormat",(e,t)=>{tt.init(e,t),iN.init(e,t)});function iF(e){return new iO({type:"number",check:"number_format",abort:!1,format:"safeint",...L(e)})}let iw=s("ZodBoolean",(e,t)=>{ti.init(e,t),io.init(e,t)});function iB(e){return new iw({type:"boolean",...L(e)})}let iU=s("ZodUnknown",(e,t)=>{tr.init(e,t),io.init(e,t)});function iG(){return new iU({type:"unknown"})}let iV=s("ZodNever",(e,t)=>{tn.init(e,t),io.init(e,t)}),ik=s("ZodArray",(e,t)=>{to.init(e,t),io.init(e,t),e.element=t.element,e.min=(t,i)=>e.check(tq(t,i)),e.nonempty=t=>e.check(tq(1,t)),e.max=(t,i)=>e.check(t$(t,i)),e.length=(t,i)=>e.check(tZ(t,i)),e.unwrap=()=>e.element});function iz(e,t){return new ik({type:"array",element:e,...L(t)})}let iH=s("ZodObject",(e,t)=>{tu.init(e,t),io.init(e,t),g(e,"shape",()=>t.shape),e.keyof=()=>i0(Object.keys(e._zod.def.shape)),e.catchall=t=>e.clone({...e._zod.def,catchall:t}),e.passthrough=()=>e.clone({...e._zod.def,catchall:iG()}),e.loose=()=>e.clone({...e._zod.def,catchall:iG()}),e.strict=()=>e.clone({...e._zod.def,catchall:new iV({type:"never",...L(void 0)})}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=t=>(function(e,t){if(!I(t))throw Error("Invalid input to extend: expected a plain object");let i=e._zod.def.checks;if(i&&i.length>0)throw Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");let r=S(e._zod.def,{get shape(){let i={...e._zod.def.shape,...t};return v(this,"shape",i),i},checks:[]});return y(e,r)})(e,t),e.safeExtend=t=>(function(e,t){if(!I(t))throw Error("Invalid input to safeExtend: expected a plain object");let i={...e._zod.def,get shape(){let i={...e._zod.def.shape,...t};return v(this,"shape",i),i},checks:e._zod.def.checks};return y(e,i)})(e,t),e.merge=t=>{let i;return i=S(e._zod.def,{get shape(){let i={...e._zod.def.shape,...t._zod.def.shape};return v(this,"shape",i),i},get catchall(){return t._zod.def.catchall},checks:[]}),y(e,i)},e.pick=t=>{let i,r;return i=e._zod.def,r=S(e._zod.def,{get shape(){let e={};for(let r in t){if(!(r in i.shape))throw Error(`Unrecognized key: "${r}"`);t[r]&&(e[r]=i.shape[r])}return v(this,"shape",e),e},checks:[]}),y(e,r)},e.omit=t=>{let i,r;return i=e._zod.def,r=S(e._zod.def,{get shape(){let r={...e._zod.def.shape};for(let e in t){if(!(e in i.shape))throw Error(`Unrecognized key: "${e}"`);t[e]&&delete r[e]}return v(this,"shape",r),r},checks:[]}),y(e,r)},e.partial=(...t)=>{var i;let r;return i=t[0],r=S(e._zod.def,{get shape(){let t=e._zod.def.shape,r={...t};if(i)for(let e in i){if(!(e in t))throw Error(`Unrecognized key: "${e}"`);i[e]&&(r[e]=i5?new i5({type:"optional",innerType:t[e]}):t[e])}else for(let e in t)r[e]=i5?new i5({type:"optional",innerType:t[e]}):t[e];return v(this,"shape",r),r},checks:[]}),y(e,r)},e.required=(...t)=>{var i;let r;return i=t[0],r=S(e._zod.def,{get shape(){let t=e._zod.def.shape,r={...t};if(i)for(let e in i){if(!(e in r))throw Error(`Unrecognized key: "${e}"`);i[e]&&(r[e]=new rt({type:"nonoptional",innerType:t[e]}))}else for(let e in t)r[e]=new rt({type:"nonoptional",innerType:t[e]});return v(this,"shape",r),r},checks:[]}),y(e,r)}});function iW(e,t){return new iH({type:"object",shape:e??{},...L(t)})}let iX=s("ZodUnion",(e,t)=>{th.init(e,t),io.init(e,t),e.options=t.options}),iY=s("ZodDiscriminatedUnion",(e,t)=>{iX.init(e,t),tp.init(e,t)});function i$(e,t,i){return new iY({type:"union",options:t,discriminator:e,...L(i)})}let iq=s("ZodIntersection",(e,t)=>{tm.init(e,t),io.init(e,t)}),iZ=s("ZodTuple",(e,t)=>{tg.init(e,t),io.init(e,t),e.rest=t=>e.clone({...e._zod.def,rest:t})});function ij(e,t,i){let r=t instanceof eB,n=r?i:t;return new iZ({type:"tuple",items:e,rest:r?t:null,...L(n)})}let iK=s("ZodRecord",(e,t)=>{tS.init(e,t),io.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function iQ(e,t,i){return new iK({type:"record",keyType:e,valueType:t,...L(i)})}let iJ=s("ZodEnum",(e,t)=>{tE.init(e,t),io.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);let i=new Set(Object.keys(t.entries));e.extract=(e,r)=>{let n={};for(let r of e)if(i.has(r))n[r]=t.entries[r];else throw Error(`Key ${r} not found in enum`);return new iJ({...t,checks:[],...L(r),entries:n})},e.exclude=(e,r)=>{let n={...t.entries};for(let t of e)if(i.has(t))delete n[t];else throw Error(`Key ${t} not found in enum`);return new iJ({...t,checks:[],...L(r),entries:n})}});function i0(e,t){return new iJ({type:"enum",entries:Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e,...L(t)})}let i1=s("ZodLiteral",(e,t)=>{tT.init(e,t),io.init(e,t),e.values=new Set(t.values),Object.defineProperty(e,"value",{get(){if(t.values.length>1)throw Error("This schema contains multiple valid literal values. Use `.values` instead.");return t.values[0]}})});function i2(e,t){return new i1({type:"literal",values:Array.isArray(e)?e:[e],...L(t)})}let i3=s("ZodTransform",(e,t)=>{tA.init(e,t),io.init(e,t),e._zod.parse=(i,r)=>{if("backward"===r.direction)throw new c(e.constructor.name);i.addIssue=r=>{"string"==typeof r?i.issues.push(B(r,i.value,t)):(r.fatal&&(r.continue=!1),r.code??(r.code="custom"),r.input??(r.input=i.value),r.inst??(r.inst=e),i.issues.push(B(r)))};let n=t.transform(i.value,i);return n instanceof Promise?n.then(e=>(i.value=e,i)):(i.value=n,i)}});function i4(e){return new i3({type:"transform",transform:e})}let i5=s("ZodOptional",(e,t)=>{tI.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType});function i8(e){return new i5({type:"optional",innerType:e})}let i6=s("ZodNullable",(e,t)=>{tR.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType});function i9(e){return new i6({type:"nullable",innerType:e})}let i7=s("ZodDefault",(e,t)=>{tC.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap}),re=s("ZodPrefault",(e,t)=>{ty.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType}),rt=s("ZodNonOptional",(e,t)=>{tL.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType}),ri=s("ZodCatch",(e,t)=>{tP.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap}),rr=s("ZodPipe",(e,t)=>{tN.init(e,t),io.init(e,t),e.in=t.in,e.out=t.out});function rn(e,t){return new rr({type:"pipe",in:e,out:t})}let ra=s("ZodReadonly",(e,t)=>{tO.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.innerType}),ro=s("ZodLazy",(e,t)=>{tw.init(e,t),io.init(e,t),e.unwrap=()=>e._zod.def.getter()});function rs(e){return new ro({type:"lazy",getter:e})}let rl=s("ZodCustom",(e,t)=>{tB.init(e,t),io.init(e,t)});function rc(e,t={error:`Input not instance of ${e.name}`}){let i=new rl({type:"custom",check:"custom",fn:t=>t instanceof e,abort:!0,...L(t)});return i._zod.bag.Class=e,i}function rf(e,t){return rn(i4(e),t)}n||(n={}),u({localeError:(a={string:{unit:"characters",verb:"to have"},file:{unit:"bytes",verb:"to have"},array:{unit:"items",verb:"to have"},set:{unit:"items",verb:"to have"}},o={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",mac:"MAC address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"},e=>{switch(e.code){case"invalid_type":return`Invalid input: expected ${e.expected}, received ${(e=>{let t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":if(1===e.values.length)return`Invalid input: expected ${M(e.values[0])}`;return`Invalid option: expected one of ${d(e.values,"|")}`;case"too_big":{let t=e.inclusive?"<=":"<",i=a[e.origin]??null;if(i)return`Too big: expected ${e.origin??"value"} to have ${t}${e.maximum.toString()} ${i.unit??"elements"}`;return`Too big: expected ${e.origin??"value"} to be ${t}${e.maximum.toString()}`}case"too_small":{let t=e.inclusive?">=":">",i=a[e.origin]??null;if(i)return`Too small: expected ${e.origin} to have ${t}${e.minimum.toString()} ${i.unit}`;return`Too small: expected ${e.origin} to be ${t}${e.minimum.toString()}`}case"invalid_format":if("starts_with"===e.format)return`Invalid string: must start with "${e.prefix}"`;if("ends_with"===e.format)return`Invalid string: must end with "${e.suffix}"`;if("includes"===e.format)return`Invalid string: must include "${e.includes}"`;if("regex"===e.format)return`Invalid string: must match pattern ${e.pattern}`;return`Invalid ${o[e.format]??e.format}`;case"not_multiple_of":return`Invalid number: must be a multiple of ${e.divisor}`;case"unrecognized_keys":return`Unrecognized key${e.keys.length>1?"s":""}: ${d(e.keys,", ")}`;case"invalid_key":return`Invalid key in ${e.origin}`;case"invalid_union":default:return"Invalid input";case"invalid_element":return`Invalid value in ${e.origin}`}})})}}]);