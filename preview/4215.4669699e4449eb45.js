/*
 *  This file is part of Cosmos Journeyer
 *
 *  Copyright (C) 2024 Barthélemy Paléologue <barth.paleologue@cosmosjourneyer.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";(globalThis.webpackChunk_cosmos_journeyer_game=globalThis.webpackChunk_cosmos_journeyer_game||[]).push([["4215"],{91237:function(e,t,r){r(74496).$.prototype.setAlphaEquation=function(e,t=0){if(this._alphaEquation[t]!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774,t);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778,t);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779,t);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776,t);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775,t);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774,t)}this._alphaEquation[t]=e}}},63185:function(e,t,r){var i=r(74496);i.$.prototype.getInputElement=function(){return this._renderingCanvas},i.$.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},i.$.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null},i.$.prototype.getAspectRatio=function(e,t=!1){let r=e.viewport;return this.getRenderWidth(t)*r.width/(this.getRenderHeight(t)*r.height)},i.$.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},i.$.prototype._verifyPointerLock=function(){this._onPointerLockChange?.()}},2909:function(e,t,r){var i=r(17644),n=r(74496);n.$.prototype.displayLoadingUI=function(){if(!(0,i.BA)())return;let e=this.loadingScreen;e&&e.displayLoadingUI()},n.$.prototype.hideLoadingUI=function(){if(!(0,i.BA)())return;let e=this._loadingScreen;e&&e.hideLoadingUI()},Object.defineProperty(n.$.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=n.$.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.$.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.$.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:!0,configurable:!0})},67500:function(e,t,r){var i=r(74496);i.$.prototype.getRenderPassNames=function(){return this._renderPassNames},i.$.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]},i.$.prototype.createRenderPassId=function(e){let t=++i.$._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t},i.$.prototype.releaseRenderPassId=function(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){let r=this.scenes[t];for(let t=0;t<r.meshes.length;++t){let i=r.meshes[t];if(i.subMeshes)for(let t=0;t<i.subMeshes.length;++t)i.subMeshes[t]._removeDrawWrapper(e)}}}},86979:function(e,t,r){var i=r(74496);r(91237),i.$.prototype.getInputElement=function(){return this._renderingCanvas},i.$.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},i.$.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e},i.$.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)},i.$.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)},i.$.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)},i.$.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)},i.$.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},i.$.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e},i.$.prototype.setAlphaConstants=function(e,t,r,i){this._alphaState.setAlphaBlendConstants(e,t,r,i)},i.$.prototype.getAlphaMode=function(e=0){return this._alphaMode[e]},i.$.prototype.getAlphaEquation=function(e=0){return this._alphaEquation[e]}},99913:function(e,t,r){var i=r(74496);r(91237),i.$.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},i.$.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e},i.$.prototype.getStencilMask=function(){return this._stencilState.stencilMask},i.$.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e},i.$.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},i.$.prototype.getStencilBackFunction=function(){return this._stencilState.stencilBackFunc},i.$.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},i.$.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},i.$.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e},i.$.prototype.setStencilBackFunction=function(e){this._stencilState.stencilBackFunc=e},i.$.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e},i.$.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e},i.$.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},i.$.prototype.getStencilBackOperationFail=function(){return this._stencilState.stencilBackOpStencilFail},i.$.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},i.$.prototype.getStencilBackOperationDepthFail=function(){return this._stencilState.stencilBackOpDepthFail},i.$.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},i.$.prototype.getStencilBackOperationPass=function(){return this._stencilState.stencilBackOpStencilDepthPass},i.$.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e},i.$.prototype.setStencilBackOperationFail=function(e){this._stencilState.stencilBackOpStencilFail=e},i.$.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e},i.$.prototype.setStencilBackOperationDepthFail=function(e){this._stencilState.stencilBackOpDepthFail=e},i.$.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e},i.$.prototype.setStencilBackOperationPass=function(e){this._stencilState.stencilBackOpStencilDepthPass=e},i.$.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()},i.$.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}},20094:function(e,t,r){r(74496).$.prototype.createDepthStencilTexture=function(e,t,r){if(!t.isCube)return this._createDepthStencilTexture(e,t,r);{let r=e.width||e;return this._createDepthStencilCubeTexture(r,t)}}},43605:function(e,t,r){r(24157).ThinEngine.prototype.setAlphaMode=function(e,t=!1,r=0){if(this._alphaMode[r]===e){if(!t){let t=0===e;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}let i=0===e;this._alphaState.setAlphaBlend(!i,r),this._alphaState.setAlphaMode(e,r),t||(this.depthCullingState.depthMask=i),this._alphaMode[r]=e}},89409:function(e,t,r){var i=r(24157),n=r(48356),s=r(283),a=r(32915);i.ThinEngine.prototype._createDepthStencilCubeTexture=function(e,t){let r=new n.h(this,12);if(r.isCube=!0,1===this.webGLVersion)return s.V.Error("Depth cube texture is not supported by WebGL 1."),r;let i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t},a=this._gl;this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,r,!0),this._setupDepthStencilTexture(r,e,i.bilinearFiltering,i.comparisonFunction);for(let t=0;t<6;t++)i.generateStencil?a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,a.DEPTH24_STENCIL8,e,e,0,a.DEPTH_STENCIL,a.UNSIGNED_INT_24_8,null):a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,a.DEPTH_COMPONENT24,e,e,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null);return this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(r),r},i.ThinEngine.prototype._setCubeMapTextureParams=function(e,t,r){let i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,t?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),e.samplingMode=t?3:2,t&&this.getCaps().textureMaxLevel&&void 0!==r&&r>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,r),e._maxLodLevel=r),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)},i.ThinEngine.prototype.createCubeTexture=function(e,t,r,i,n=null,o=null,h,l=null,u=!1,_=0,d=0,c=null,f,p=!1,g=null){let T=this._gl;return this.createCubeTextureBase(e,t,r,!!i,n,o,h,l,u,_,d,c,e=>this._bindTextureDirectly(T.TEXTURE_CUBE_MAP,e,!0),(e,t)=>{let r=this.needPOTTextures?(0,a.R)(t[0].width,this._caps.maxCubemapTextureSize):t[0].width,o=[T.TEXTURE_CUBE_MAP_POSITIVE_X,T.TEXTURE_CUBE_MAP_POSITIVE_Y,T.TEXTURE_CUBE_MAP_POSITIVE_Z,T.TEXTURE_CUBE_MAP_NEGATIVE_X,T.TEXTURE_CUBE_MAP_NEGATIVE_Y,T.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(T.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(!1);let l=h?this._getInternalFormat(h,e._useSRGBBuffer):e._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:T.RGBA,u=h?this._getInternalFormat(h):T.RGBA;e._useSRGBBuffer&&1===this.webGLVersion&&(u=l);for(let e=0;e<o.length;e++)if(t[e].width!==r||t[e].height!==r){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext)return void s.V.Warn("Cannot create canvas to resize texture.");this._workingCanvas.width=r,this._workingCanvas.height=r,this._workingContext.drawImage(t[e],0,0,t[e].width,t[e].height,0,0,r,r),T.texImage2D(o[e],0,l,u,T.UNSIGNED_BYTE,this._workingCanvas)}else T.texImage2D(o[e],0,l,u,T.UNSIGNED_BYTE,t[e]);i||T.generateMipmap(T.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(e,!i),e.width=r,e.height=r,e.isReady=!0,h&&(e.format=h),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),n&&n()},!!p,g)},i.ThinEngine.prototype.generateMipMapsForCubemap=function(e,t=!0){if(e.generateMipMaps){let r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,e,!0),r.generateMipmap(r.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null)}}},87790:function(e,t,r){var i=r(24157);i.ThinEngine.prototype.updateDynamicIndexBuffer=function(e,t,r=0){let i;this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e),i=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},i.ThinEngine.prototype.updateDynamicVertexBuffer=function(e,t,r,i){this.bindArrayBuffer(e),void 0===r&&(r=0);let n=t.byteLength||t.length;void 0===i||i>=n&&0===r?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,r,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,r,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,r,new Float32Array(t).subarray(0,i/4)):(t=t instanceof ArrayBuffer?new Uint8Array(t,0,i):new Uint8Array(t.buffer,t.byteOffset,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,r,t)),this._resetVertexBufferBinding()}},21367:function(e,t,r){var i=r(24157),n=r(48356),s=r(283),a=r(6163),o=r(4476);i.ThinEngine.prototype.createPrefilteredCubeTexture=function(e,t,i,h,l=null,u=null,_,d=null,c=!0){let f=async e=>{if(!e){l&&l(null);return}let u=e.texture;if(c?e.info.sphericalPolynomial&&(u._sphericalPolynomial=e.info.sphericalPolynomial):u._sphericalPolynomial=new a.Q,u._source=9,this.getCaps().textureLOD){l&&l(u);return}let _=this._gl,d=e.width;if(!d)return;let{DDSTools:f}=await Promise.all([r.e("8705"),r.e("2858")]).then(r.bind(r,87066)),p=[];for(let r=0;r<3;r++){let a=Math.log2(d)*i+h,l=Math.round(Math.min(Math.max(h+(a-h)*(1-r/2),0),a)),c=new n.h(this,2);if(c.type=u.type,c.format=u.format,c.width=Math.pow(2,Math.max(Math.log2(d)-l,0)),c.height=c.width,c.isCube=!0,c._cachedWrapU=0,c._cachedWrapV=0,this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,c,!0),c.samplingMode=2,_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_MAG_FILTER,_.LINEAR),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_MIN_FILTER,_.LINEAR),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE),e.isDDS){let t=e.info,r=e.data;this._unpackFlipY(t.isCompressed),f.UploadDDSLevels(this,c,r,t,!0,6,l)}else s.V.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,null);let g=new o.t(t);g._isCube=!0,g._texture=c,c.isReady=!0,p.push(g)}u._lodTextureHigh=p[2],u._lodTextureMid=p[1],u._lodTextureLow=p[0],l&&l(u)};return this.createCubeTexture(e,t,null,!1,f,u,_,d,c,i,h)}},8556:function(e,t,r){var i=r(48356),n=r(283),s=r(24157),a=r(32915);function o(e,t,r,i){let n,s=1;1===i?n=new Float32Array(t*r*4):2===i?(n=new Uint16Array(t*r*4),s=15360):n=7===i?new Uint32Array(t*r*4):new Uint8Array(t*r*4);for(let i=0;i<t;i++)for(let a=0;a<r;a++){let r=(a*t+i)*3,o=(a*t+i)*4;n[o+0]=e[r+0],n[o+1]=e[r+1],n[o+2]=e[r+2],n[o+3]=s}return n}function h(e){return function(t,r,n,s,a,o,h,l,u=null,_=0){let d=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,c=new i.h(this,e?10:11);c.baseWidth=r,c.baseHeight=n,c.baseDepth=s,c.width=r,c.height=n,c.depth=s,c.format=a,c.type=_,c.generateMipMaps=o,c.samplingMode=l,e?c.is3D=!0:c.is2DArray=!0,this._doNotHandleContextLost||(c._bufferView=t),e?this.updateRawTexture3D(c,t,a,h,u,_):this.updateRawTexture2DArray(c,t,a,h,u,_),this._bindTextureDirectly(d,c,!0);let f=this._getSamplingParameters(l,o);return this._gl.texParameteri(d,this._gl.TEXTURE_MAG_FILTER,f.mag),this._gl.texParameteri(d,this._gl.TEXTURE_MIN_FILTER,f.min),o&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null),this._internalTexturesCache.push(c),c}}function l(e){return function(t,r,i,n,s=null,a=0){let o=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,h=this._getWebGLTextureType(a),l=this._getInternalFormat(i),u=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(o,t,!0),this._unpackFlipY(void 0===n||!!n),this._doNotHandleContextLost||(t._bufferView=r,t.format=i,t.invertY=n,t._compression=s),t.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&r?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[s],t.width,t.height,t.depth,0,r):this._gl.texImage3D(o,0,u,t.width,t.height,t.depth,0,l,h,r),t.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),t.isReady=!0}}s.ThinEngine.prototype.updateRawTexture=function(e,t,r,i,n=null,s=0,a=!1){if(!e)return;let o=this._getRGBABufferInternalSizedFormat(s,r,a),h=this._getInternalFormat(r),l=this._getWebGLTextureType(s);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===i||!!i),this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.type=s,e.invertY=i,e._compression=n),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,e.width,e.height,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0},s.ThinEngine.prototype.createRawTexture=function(e,t,r,n,s,a,o,h=null,l=0,u=0,_=!1){let d=new i.h(this,3);d.baseWidth=t,d.baseHeight=r,d.width=t,d.height=r,d.format=n,d.generateMipMaps=s,d.samplingMode=o,d.invertY=a,d._compression=h,d.type=l,d._useSRGBBuffer=this._getUseSRGBBuffer(_,!s),this._doNotHandleContextLost||(d._bufferView=e),this.updateRawTexture(d,e,n,a,h,l,d._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,d,!0);let c=this._getSamplingParameters(o,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,c.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,c.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(d),d},s.ThinEngine.prototype.createRawCubeTexture=function(e,t,r,s,o,h,l,u=null){let _=this._gl,d=new i.h(this,8);d.isCube=!0,d.format=r,d.type=s,this._doNotHandleContextLost||(d._bufferViewArray=e);let c=this._getWebGLTextureType(s),f=this._getInternalFormat(r);if(f===_.RGB&&(f=_.RGBA),c!==_.FLOAT||this._caps.textureFloatLinearFiltering?c!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?c!==_.FLOAT||this._caps.textureFloatRender?c!==_.HALF_FLOAT||this._caps.colorBufferFloat||(o=!1,n.V.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(o=!1,n.V.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(o=!1,l=1,n.V.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(o=!1,l=1,n.V.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),d.width=t,d.height=t,d.invertY=h,d._compression=u,!this.needPOTTextures||(0,a.L8)(d.width)&&(0,a.L8)(d.height)||(o=!1),e)this.updateRawCubeTexture(d,e,r,s,h,u);else{let e=this._getRGBABufferInternalSizedFormat(s);this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,d,!0);for(let t=0;t<6;t++)u?_.compressedTexImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this.getCaps().s3tc[u],d.width,d.height,0,void 0):_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e,d.width,d.height,0,f,c,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,d,!0),e&&o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);let p=this._getSamplingParameters(l,o);return _.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_MAG_FILTER,p.mag),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_MIN_FILTER,p.min),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE),this._bindTextureDirectly(_.TEXTURE_CUBE_MAP,null),d.generateMipMaps=o,d.samplingMode=l,d.isReady=!0,d},s.ThinEngine.prototype.updateRawCubeTexture=function(e,t,r,i,n,s=null,h=0){e._bufferViewArray=t,e.format=r,e.type=i,e.invertY=n,e._compression=s;let l=this._gl,u=this._getWebGLTextureType(i),_=this._getInternalFormat(r),d=this._getRGBABufferInternalSizedFormat(i),c=!1;_===l.RGB&&(_=l.RGBA,c=!0),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===n||!!n),e.width%4!=0&&l.pixelStorei(l.UNPACK_ALIGNMENT,1);for(let r=0;r<6;r++){let n=t[r];s?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+r,h,this.getCaps().s3tc[s],e.width,e.height,0,n):(c&&(n=o(n,e.width,e.height,i)),l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+r,h,d,e.width,e.height,0,_,u,n))}(!this.needPOTTextures||(0,a.L8)(e.width)&&(0,a.L8)(e.height))&&e.generateMipMaps&&0===h&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},s.ThinEngine.prototype.createRawCubeTextureFromUrl=function(e,t,r,i,n,s,a,h,l=null,u=null,_=3,d=!1){let c=this._gl,f=this.createRawCubeTexture(null,r,i,n,!s,d,_,null);t?.addPendingData(f),f.url=e,f.isReady=!1,this._internalTexturesCache.push(f);let p=(e,r)=>{t?.removePendingData(f),u&&e&&u(e.status+" "+e.statusText,r)},g=async e=>{if(!f._hardwareTexture)return;let r=a(e);if(!r)return;let s=r instanceof Promise?await r:r,u=f.width;if(h){let e=this._getWebGLTextureType(n),t=this._getInternalFormat(i),r=this._getRGBABufferInternalSizedFormat(n),a=!1;t===c.RGB&&(t=c.RGBA,a=!0),this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);let l=h(s);for(let i=0;i<l.length;i++){let s=u>>i;for(let h=0;h<6;h++){let u=l[i][h];a&&(u=o(u,s,s,n)),c.texImage2D(h,i,r,s,s,0,t,e,u)}}this._bindTextureDirectly(c.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,s,i,n,d);f.isReady=!0,t?.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()};return this._loadFile(e,e=>{g(e).catch(e=>{p(void 0,e)})},void 0,t?.offlineProvider,!0,p),f},s.ThinEngine.prototype.createRawTexture2DArray=h(!1),s.ThinEngine.prototype.createRawTexture3D=h(!0),s.ThinEngine.prototype.updateRawTexture2DArray=l(!1),s.ThinEngine.prototype.updateRawTexture3D=l(!0)},16454:function(e,t,r){r.d(t,{k:()=>n.kZ});var i=r(24157),n=r(98419);i.ThinEngine.prototype._readTexturePixelsSync=function(e,t,r,i=-1,s=0,a=null,o=!0,h=!1,l=0,u=0){let _=this._gl;if(!_)throw Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){let e=_.createFramebuffer();if(!e)throw Error("Unable to create dummy framebuffer");this._dummyFramebuffer=e}_.bindFramebuffer(_.FRAMEBUFFER,this._dummyFramebuffer),i>-1?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture?.underlyingResource,s):_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,e._hardwareTexture?.underlyingResource,s);let d=void 0!==e.type?this._getWebGLTextureType(e.type):_.UNSIGNED_BYTE;return h?a||(a=(0,n.kZ)(e.type,4*t*r)):d===_.UNSIGNED_BYTE?(a||(a=new Uint8Array(4*t*r)),d=_.UNSIGNED_BYTE):(a||(a=new Float32Array(4*t*r)),d=_.FLOAT),o&&this.flushFramebuffer(),_.readPixels(l,u,t,r,_.RGBA,d,a),_.bindFramebuffer(_.FRAMEBUFFER,this._currentFramebuffer),a},i.ThinEngine.prototype._readTexturePixels=function(e,t,r,i=-1,n=0,s=null,a=!0,o=!1,h=0,l=0){return Promise.resolve(this._readTexturePixelsSync(e,t,r,i,n,s,a,o,h,l))}},98167:function(e,t,r){var i=r(48356),n=r(283),s=r(24157),a=r(72922),o=r(27652);class h extends a.v{setDepthStencilTexture(e,t=!0){if(super.setDepthStencilTexture(e,t),!e)return;let r=this._engine,i=this._context,n=e._hardwareTexture;if(n&&e._autoMSAAManagement&&this._MSAAFramebuffer){let t=r._currentFramebuffer;r._bindUnboundFramebuffer(this._MSAAFramebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,(0,o.$l)(e.format)?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT,i.RENDERBUFFER,n.getMSAARenderBuffer()),r._bindUnboundFramebuffer(t)}}constructor(e,t,r,i,n){super(e,t,r,i),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height)).texture.isReady=!0:e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,r=!1,i=1,n=14,s){if(this._depthStencilBuffer){let e=this._engine,t=e._currentFramebuffer,r=this._context;e._bindUnboundFramebuffer(this._framebuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,null),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,null),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.STENCIL_ATTACHMENT,r.RENDERBUFFER,null),e._bindUnboundFramebuffer(t),r.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,r,i,n,s)}shareDepth(e){super.shareDepth(e);let t=this._context,r=this._depthStencilBuffer,i=e._MSAAFramebuffer||e._framebuffer,n=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==r&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=r;let s=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n._bindUnboundFramebuffer(i),t.framebufferRenderbuffer(t.FRAMEBUFFER,s,t.RENDERBUFFER,r),n._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,r,i=0){let n,s=e._hardwareTexture;if(!s)return;let a=this._framebuffer,o=this._engine,h=o._currentFramebuffer;if(o._bindUnboundFramebuffer(a),o.webGLVersion>1){let a=this._context;n=a["COLOR_ATTACHMENT"+t],e.is2DArray||e.is3D?(r=r??this.layerIndices?.[t]??0,a.framebufferTextureLayer(a.FRAMEBUFFER,n,s.underlyingResource,i,r)):e.isCube?(r=r??this.faceIndices?.[t]??0,a.framebufferTexture2D(a.FRAMEBUFFER,n,a.TEXTURE_CUBE_MAP_POSITIVE_X+r,s.underlyingResource,i)):a.framebufferTexture2D(a.FRAMEBUFFER,n,a.TEXTURE_2D,s.underlyingResource,i)}else{let e=this._context;n=e["COLOR_ATTACHMENT"+t+"_WEBGL"];let a=void 0!==r?e.TEXTURE_CUBE_MAP_POSITIVE_X+r:e.TEXTURE_2D;e.framebufferTexture2D(e.FRAMEBUFFER,n,a,s.underlyingResource,i)}if(e._autoMSAAManagement&&this._MSAAFramebuffer){let e=this._context;o._bindUnboundFramebuffer(this._MSAAFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,s.getMSAARenderBuffer())}o._bindUnboundFramebuffer(h)}setTexture(e,t=0,r=!0){super.setTexture(e,t,r),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;let r=this._attachments?.length??this.textures.length;for(let e=0;e<r;e++){let t=this.textures[e];t&&(t.is2DArray||t.is3D?this._bindTextureRenderTarget(t,e,this.layerIndices[e]):t.isCube?this._bindTextureRenderTarget(t,e,this.faceIndices[e]):this._bindTextureRenderTarget(t,e))}}setLayerAndFaceIndex(e=0,t,r){if(super.setLayerAndFaceIndex(e,t,r),!this.textures||!this.layerIndices||!this.faceIndices)return;let i=this.textures[e];i.is2DArray||i.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):i.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}resolveMSAATextures(){let e=this._engine,t=e._currentFramebuffer;e._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),e._bindUnboundFramebuffer(t)}dispose(e=this._disposeOnlyFramebuffers){let t=this._context;!e&&(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}r(20094),s.ThinEngine.prototype._createHardwareRenderTargetWrapper=function(e,t,r){let i=new h(e,t,r,this,this._gl);return this._renderTargetWrapperCache.push(i),i},s.ThinEngine.prototype.createRenderTargetTexture=function(e,t){let r,i,n=this._createHardwareRenderTargetWrapper(!1,!1,e),s=!0,a=!1,o=!1,h=1;void 0!==t&&"object"==typeof t&&(s=t.generateDepthBuffer??!0,a=!!t.generateStencilBuffer,o=!!t.noColorAttachment,r=t.colorAttachment,h=t.samples??1,i=t.label);let l=r||(o?null:this._createInternalTexture(e,t,!0,5)),u=e.width||e,_=e.height||e,d=this._currentFramebuffer,c=this._gl,f=c.createFramebuffer();if(this._bindUnboundFramebuffer(f),n._depthStencilBuffer=this._setupFramebufferDepthAttachments(a,s,u,_),!l||l.is2DArray||l.is3D||c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,l._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(d),n.label=i??"RenderTargetWrapper",n._framebuffer=f,n._generateDepthBuffer=s,n._generateStencilBuffer=a,n.setTextures(l),r){if(n._samples=r.samples,r.samples>1){let e=r._hardwareTexture.getMSAARenderBuffer(0);n._MSAAFramebuffer=c.createFramebuffer(),this._bindUnboundFramebuffer(n._MSAAFramebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.RENDERBUFFER,e),this._bindUnboundFramebuffer(null)}}else this.updateRenderTargetTextureSampleCount(n,h);return n},s.ThinEngine.prototype._createDepthStencilTexture=function(e,t,r){let s=this._gl,a=e.layers||0,h=e.depth||0,l=s.TEXTURE_2D;0!==a?l=s.TEXTURE_2D_ARRAY:0!==h&&(l=s.TEXTURE_3D);let u=new i.h(this,12);if(u.label=t.label,!this._caps.depthTextureExtension)return n.V.Error("Depth texture is not supported by your browser or hardware."),u;let _={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...t};if(this._bindTextureDirectly(l,u,!0),this._setupDepthStencilTexture(u,e,0!==_.comparisonFunction&&_.bilinearFiltering,_.comparisonFunction,_.samples),void 0!==_.depthTextureFormat){if(15!==_.depthTextureFormat&&16!==_.depthTextureFormat&&17!==_.depthTextureFormat&&13!==_.depthTextureFormat&&14!==_.depthTextureFormat&&18!==_.depthTextureFormat)return n.V.Error(`Depth texture ${_.depthTextureFormat} format is not supported.`),u;u.format=_.depthTextureFormat}else u.format=_.generateStencil?13:16;let d=(0,o.$l)(u.format),c=this._getWebGLTextureTypeFromDepthTextureFormat(u.format),f=d?s.DEPTH_STENCIL:s.DEPTH_COMPONENT,p=this._getInternalFormatFromDepthTextureFormat(u.format,!0,d);return u.is2DArray?s.texImage3D(l,0,p,u.width,u.height,a,0,f,c,null):u.is3D?s.texImage3D(l,0,p,u.width,u.height,h,0,f,c,null):s.texImage2D(l,0,p,u.width,u.height,0,f,c,null),this._bindTextureDirectly(l,null),this._internalTexturesCache.push(u),r._depthStencilBuffer&&(s.deleteRenderbuffer(r._depthStencilBuffer),r._depthStencilBuffer=null),this._bindUnboundFramebuffer(r._MSAAFramebuffer??r._framebuffer),r._generateStencilBuffer=d,r._depthStencilTextureWithStencil=d,r._depthStencilBuffer=this._setupFramebufferDepthAttachments(r._generateStencilBuffer,r._generateDepthBuffer,r.width,r.height,r.samples,u.format),this._bindUnboundFramebuffer(null),u},s.ThinEngine.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;let r=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples),e._depthStencilBuffer&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null);let i=e.texture?._hardwareTexture;if(i?.releaseMSAARenderBuffers(),e.texture&&t>1&&"function"==typeof r.renderbufferStorageMultisample){let n=r.createFramebuffer();if(!n)throw Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(e._MSAAFramebuffer);let s=this._createRenderBuffer(e.texture.width,e.texture.height,t,-1,this._getRGBABufferInternalSizedFormat(e.texture.type,e.texture.format,e.texture._useSRGBBuffer),r.COLOR_ATTACHMENT0,!1);if(!s)throw Error("Unable to create multi sampled framebuffer");i?.addMSAARenderBuffer(s)}this._bindUnboundFramebuffer(e._MSAAFramebuffer??e._framebuffer),e.texture&&(e.texture.samples=t),e._samples=t;let n=e._depthStencilTexture?e._depthStencilTexture.format:void 0;return e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t,n),this._bindUnboundFramebuffer(null),t},s.ThinEngine.prototype._setupDepthStencilTexture=function(e,t,r,i,n=1){let s=t.width??t,a=t.height??t,o=t.layers||0,h=t.depth||0;e.baseWidth=s,e.baseHeight=a,e.width=s,e.height=a,e.is2DArray=o>0,e.depth=o||h,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=i;let l=this._gl,u=this._getTextureTarget(e),_=this._getSamplingParameters(e.samplingMode,!1);l.texParameteri(u,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(u,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(u,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(u,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this.webGLVersion>1&&(0===i?(l.texParameteri(u,l.TEXTURE_COMPARE_FUNC,515),l.texParameteri(u,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(u,l.TEXTURE_COMPARE_FUNC,i),l.texParameteri(u,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE)))}},16181:function(e,t,r){var i=r(48356),n=r(283);r(24157).ThinEngine.prototype.createRenderTargetCubeTexture=function(e,t){let r=this._createHardwareRenderTargetWrapper(!1,!0,e),s={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...t};s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1);let a=this._gl,o=new i.h(this,5);this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,o,!0);let h=this._getSamplingParameters(s.samplingMode,s.generateMipMaps);1!==s.type||this._caps.textureFloat||(s.type=0,n.V.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,h.mag),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,h.min),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);for(let t=0;t<6;t++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),e,e,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);let l=a.createFramebuffer();return this._bindUnboundFramebuffer(l),r._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,e,e),s.generateMipMaps&&a.generateMipmap(a.TEXTURE_CUBE_MAP),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),r._framebuffer=l,r._generateDepthBuffer=s.generateDepthBuffer,r._generateStencilBuffer=s.generateStencilBuffer,o.width=e,o.height=e,o.isReady=!0,o.isCube=!0,o.samples=1,o.generateMipMaps=s.generateMipMaps,o.samplingMode=s.samplingMode,o.type=s.type,o.format=s.format,this._internalTexturesCache.push(o),r.setTextures(o),r}},86345:function(e,t,r){r(24157).ThinEngine.prototype.setDepthStencilTexture=function(e,t,r,i){void 0!==e&&(t&&(this._boundUniforms[e]=t),r&&r.depthStencilTexture?this._setTexture(e,r,!1,!0,i):this._setTexture(e,null,void 0,void 0,i))}},74527:function(e,t,r){var i=r(24157),n=r(42187);i.ThinEngine.prototype.createUniformBuffer=function(e,t){let r=this._gl.createBuffer();if(!r)throw Error("Unable to create uniform buffer");let i=new n.A(r);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},i.ThinEngine.prototype.createDynamicUniformBuffer=function(e,t){let r=this._gl.createBuffer();if(!r)throw Error("Unable to create dynamic uniform buffer");let i=new n.A(r);return this.bindUniformBuffer(i),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i},i.ThinEngine.prototype.updateUniformBuffer=function(e,t,r,i){this.bindUniformBuffer(e),void 0===r&&(r=0),void 0===i?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,r,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,r,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(r,r+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(r,r+i)),this.bindUniformBuffer(null)},i.ThinEngine.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},i.ThinEngine.prototype.bindUniformBufferBase=function(e,t,r){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},i.ThinEngine.prototype.bindUniformBlock=function(e,t,r){let i=e.program,n=this._gl.getUniformBlockIndex(i,t);0xffffffff!==n&&this._gl.uniformBlockBinding(i,n,r)}},28721:function(e,t,r){r.d(t,{n:()=>i});class i{constructor(){this.shaderLanguage=0}postProcessor(e,t,r,i,n){return n.drawBuffersExtensionDisabled&&(e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,"")),e}}},60804:function(e,t,r){r.d(t,{$:()=>_});var i=r(65066),n=r(49733),s=r(64527),a=r(8118),o=r(32915),h=r(51454),l=r(283),u=r(18005);h.M.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)};class _ extends s.g{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get enableBoundingBoxRendering(){return this._objectRenderer.enableBoundingBoxRendering}set enableBoundingBoxRendering(e){this._objectRenderer.enableBoundingBoxRendering=e}get enableOutlineRendering(){return this._objectRenderer.enableOutlineRendering}set enableOutlineRendering(e){this._objectRenderer.enableOutlineRendering=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(e){this._objectRenderer.disableImageProcessing=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,r,a=!1,o=!0,h=0,_=!1,d=s.g.TRILINEAR_SAMPLINGMODE,c=!0,f=!1,p=!1,g=5,T=!1,R,E,b=!1,m=!1){let A,P,x=!0,M=!1;if("object"==typeof a){const e=a;a=!!e.generateMipMaps,o=e.doNotChangeAspectRatio??!0,h=e.type??0,_=!!e.isCube,d=e.samplingMode??s.g.TRILINEAR_SAMPLINGMODE,c=e.generateDepthBuffer??!0,f=!!e.generateStencilBuffer,p=!!e.isMulti,g=e.format??5,T=!!e.delayAllocation,R=e.samples,E=e.creationFlags,b=!!e.noColorAttachment,m=!!e.useSRGBBuffer,A=e.colorAttachment,x=e.gammaSpace??x,P=e.existingObjectRenderer,M=!!e.enableClusteredLights}if(super(null,r,!a,void 0,d,void 0,void 0,void 0,void 0,g),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new i.cP,this.onAfterUnbindObservable=new i.cP,this.onClearObservable=new i.cP,this.onResizeObservable=new i.cP,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=n.Pq.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(r=this.getScene()))return;const S=this.getScene().getEngine();if(this._gammaSpace=x,this._coordinatesMode=s.g.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!P,this._processSizeParameter(t),this._objectRenderer=P??new u.P(e,r,{numPasses:_?6:this.getRenderLayers()||1,doNotChangeAspectRatio:o,enableClusteredLights:M}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(let e of this._scene._beforeRenderTargetClearStage)e.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(S):this.skipInitialClear||S.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(let e of this._scene._beforeRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer)}),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(let e of this._scene._afterRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer);let e=this._texture?.generateMipMaps??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(let e of this._scene._afterRenderTargetPostProcessStage)e.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=e),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),S):l.V.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(S):this.skipInitialClear||S.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=S.onResizeObservable.add(()=>{}),this._generateMipMaps=!!a,this._doNotChangeAspectRatio=o,p)return;this._renderTargetOptions={generateMipMaps:a,type:h,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:f,samples:R,creationFlags:E,noColorAttachment:b,useSRGBBuffer:m,colorAttachment:A,label:this.name},this.samplingMode===s.g.NEAREST_SAMPLINGMODE&&(this.wrapU=s.g.CLAMP_ADDRESSMODE,this.wrapV=s.g.CLAMP_ADDRESSMODE),T||(_?(this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=s.g.INVCUBIC_MODE,this._textureMatrix=n.uq.Identity()):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==R&&(this.samples=R))}createDepthStencilTexture(e=0,t=!0,r=!1,i=1,n=14,s){this._renderTarget?.createDepthStencilTexture(e,t,r,i,n,s)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;let t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){let e=this.getScene();if(!e)return;this._postProcessManager=new a.X(e),this._postProcesses=[]}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(let e of this._postProcesses)e.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;let t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){let e=this._size.layers;if(e)return e;let t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){let t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){let t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;let r=this.getScene();r&&(this._processSizeParameter(e),t?this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,r.e("55").then(r.bind(r,62810)).then(e=>this._dumpTools=e)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());let e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){let r=this.getScene();if(r){if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),(this.is2DArray||this.is3D)&&!this.isMulti)for(let i=0;i<this.getRenderLayers();i++)this._renderToTarget(0,e,t,i),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let i=0;i<6;i++)this._renderToTarget(i,e,t),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t);this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){let r=e*t,i=(0,o.OG)(r+16384/(128+r));return Math.min((0,o.C4)(e),i)}_bindFrameBuffer(e=0,t=0){let r=this.getScene();if(!r)return;let i=r.getEngine();this._renderTarget&&i.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,r,i){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(t,r):i&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,r)}_renderToTarget(e,t,r,i=0){let n=this.getScene();if(!n)return;let s=n.getEngine();this._currentFaceIndex=e,this._currentLayer=i,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=r,this._prepareFrame(n,e,i,t),s._debugPushGroup?.(`render to face #${e} layer #${i}`,2),this._objectRenderer.render(e+i,!0),s._debugPopGroup?.(2),this._unbindFrameBuffer(s,e),this._texture&&this.isCube&&5===e&&s.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,r=null,i=null){this._objectRenderer.setRenderingOrder(e,t,r,i)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){let e=this.getSize(),t=new _(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;let e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);let e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);for(let r of(t>=0&&e.customRenderTargets.splice(t,1),e.cameras))(t=r.customRenderTargets.indexOf(this))>=0&&r.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}}_.REFRESHRATE_RENDER_ONCE=u.P.REFRESHRATE_RENDER_ONCE,_.REFRESHRATE_RENDER_ONEVERYFRAME=u.P.REFRESHRATE_RENDER_ONEVERYFRAME,_.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=u.P.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,s.g._CreateRenderTargetTexture=(e,t,r,i,n)=>new _(e,t,r,i)},67435:function(e,t,r){r.d(t,{$x:()=>s,_0:()=>h,xp:()=>a});var i,n,s,a,o=r(49733);(i=s||(s={}))[i.LOCAL=0]="LOCAL",i[i.WORLD=1]="WORLD",i[i.BONE=2]="BONE";class h{}h.X=new o.Pq(1,0,0),h.Y=new o.Pq(0,1,0),h.Z=new o.Pq(0,0,1),(n=a||(a={}))[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"},38070:function(e,t,r){r.d(t,{P:()=>n});var i=r(40038);class n{static GetPlanes(e){let t=[];for(let e=0;e<6;e++)t.push(new i.Z(0,0,0,0));return n.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){let r=e.m;t.normal.x=r[3]+r[2],t.normal.y=r[7]+r[6],t.normal.z=r[11]+r[10],t.d=r[15]+r[14],t.normalize()}static GetFarPlaneToRef(e,t){let r=e.m;t.normal.x=r[3]-r[2],t.normal.y=r[7]-r[6],t.normal.z=r[11]-r[10],t.d=r[15]-r[14],t.normalize()}static GetLeftPlaneToRef(e,t){let r=e.m;t.normal.x=r[3]+r[0],t.normal.y=r[7]+r[4],t.normal.z=r[11]+r[8],t.d=r[15]+r[12],t.normalize()}static GetRightPlaneToRef(e,t){let r=e.m;t.normal.x=r[3]-r[0],t.normal.y=r[7]-r[4],t.normal.z=r[11]-r[8],t.d=r[15]-r[12],t.normalize()}static GetTopPlaneToRef(e,t){let r=e.m;t.normal.x=r[3]-r[1],t.normal.y=r[7]-r[5],t.normal.z=r[11]-r[9],t.d=r[15]-r[13],t.normalize()}static GetBottomPlaneToRef(e,t){let r=e.m;t.normal.x=r[3]+r[1],t.normal.y=r[7]+r[5],t.normal.z=r[11]+r[9],t.d=r[15]+r[13],t.normalize()}static GetPlanesToRef(e,t){n.GetNearPlaneToRef(e,t[0]),n.GetFarPlaneToRef(e,t[1]),n.GetLeftPlaneToRef(e,t[2]),n.GetRightPlaneToRef(e,t[3]),n.GetTopPlaneToRef(e,t[4]),n.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let r=0;r<6;r++)if(0>t[r].dotCoordinate(e))return!1;return!0}}},93209:function(e,t,r){r.d(t,{Cu:()=>_,Xy:()=>u,jj:()=>c,t4:()=>n,tO:()=>d,uM:()=>l,vr:()=>h});var i,n,s=r(69821),a=r(49733),o=r(91941);(i=n||(n={}))[i.CW=0]="CW",i[i.CCW=1]="CCW";class h{static Interpolate(e,t,r,i,n){if(0===e)return 0;let s=1-3*i+3*t,a=3*i-6*t,o=3*t,h=e;for(let t=0;t<5;t++){let t=h*h,r=t*h*s+a*t+o*h,i=1/(3*s*t+2*a*h+o);h-=(r-e)*i,h=Math.min(1,Math.max(0,h))}return 3*Math.pow(1-h,2)*h*r+3*(1-h)*Math.pow(h,2)*n+Math.pow(h,3)}}class l{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return 180*this._radians/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){let r=t.subtract(e);return new l(Math.atan2(r.y,r.x))}static BetweenTwoVectors(e,t){let r=e.lengthSquared()*t.lengthSquared();if(0===r)return new l(Math.PI/2);r=Math.sqrt(r);let i=e.dot(t)/r;return new l(Math.acos(i=(0,s.Clamp)(i,-1,1)))}static FromRadians(e){return new l(e)}static FromDegrees(e){return new l(e*Math.PI/180)}}class u{constructor(e,t,r){this.startPoint=e,this.midPoint=t,this.endPoint=r;const i=Math.pow(t.x,2)+Math.pow(t.y,2),n=(Math.pow(e.x,2)+Math.pow(e.y,2)-i)/2,s=(i-Math.pow(r.x,2)-Math.pow(r.y,2))/2,o=(e.x-t.x)*(t.y-r.y)-(t.x-r.x)*(e.y-t.y);this.centerPoint=new a.I9((n*(t.y-r.y)-s*(e.y-t.y))/o,((e.x-t.x)*s-(t.x-r.x)*n)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=l.BetweenTwoPoints(this.centerPoint,this.startPoint);const h=this.startAngle.degrees();let u=l.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),_=l.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();u-h>180&&(u-=360),u-h<-180&&(u+=360),_-u>180&&(_-=360),_-u<-180&&(_+=360),this.orientation=u-h<0?0:1,this.angle=l.FromDegrees(0===this.orientation?h-_:_-h)}}class _{constructor(e,t){this._points=[],this._length=0,this.closed=!1,this._points.push(new a.I9(e,t))}addLineTo(e,t){if(this.closed)return this;let r=new a.I9(e,t),i=this._points[this._points.length-1];return this._points.push(r),this._length+=r.subtract(i).length(),this}addArcTo(e,t,r,i,n=36){if(this.closed)return this;let s=new u(this._points[this._points.length-1],new a.I9(e,t),new a.I9(r,i)),o=s.angle.radians()/n;0===s.orientation&&(o*=-1);let h=s.startAngle.radians()+o;for(let e=0;e<n;e++){let e=Math.cos(h)*s.radius+s.centerPoint.x,t=Math.sin(h)*s.radius+s.centerPoint.y;this.addLineTo(e,t),h+=o}return this}addQuadraticCurveTo(e,t,r,i,n=36){if(this.closed)return this;let s=(e,t,r,i)=>(1-e)*(1-e)*t+2*e*(1-e)*r+e*e*i,a=this._points[this._points.length-1];for(let o=0;o<=n;o++){let h=o/n,l=s(h,a.x,e,r),u=s(h,a.y,t,i);this.addLineTo(l,u)}return this}addBezierCurveTo(e,t,r,i,n,s,a=36){if(this.closed)return this;let o=(e,t,r,i,n)=>(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*r+3*e*e*(1-e)*i+e*e*e*n,h=this._points[this._points.length-1];for(let l=0;l<=a;l++){let u=l/a,_=o(u,h.x,e,r,n),d=o(u,h.y,t,i,s);this.addLineTo(_,d)}return this}isPointInside(e){let t=!1,r=this._points.length;for(let i=r-1,n=0;n<r;i=n++){let r=this._points[i],s=this._points[n],a=s.x-r.x,o=s.y-r.y;if(Math.abs(o)>Number.EPSILON){if(o<0&&(r=this._points[n],a=-a,s=this._points[i],o=-o),e.y<r.y||e.y>s.y)continue;if(e.y===r.y&&e.x===r.x)return!0;{let i=o*(e.x-r.x)-a*(e.y-r.y);if(0===i)return!0;if(i<0)continue;t=!t}}else{if(e.y!==r.y)continue;if(s.x<=e.x&&e.x<=r.x||r.x<=e.x&&e.x<=s.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){let t=this._points[this._points.length-1];e+=this._points[0].subtract(t).length()}return e}area(){let e=this._points.length,t=0;for(let r=e-1,i=0;i<e;r=i++)t+=this._points[r].x*this._points[i].y-this._points[i].x*this._points[r].y;return .5*t}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return a.I9.Zero();let t=e*this.length(),r=0;for(let e=0;e<this._points.length;e++){let i=(e+1)%this._points.length,n=this._points[e],s=this._points[i].subtract(n),o=s.length()+r;if(t>=r&&t<=o){let e=s.normalize(),i=t-r;return new a.I9(n.x+e.x*i,n.y+e.y*i)}r=o}return a.I9.Zero()}static StartingAt(e,t){return new _(e,t)}}class d{constructor(e,t=null,r,i=!1){this.path=e,this._curve=[],this._distances=[],this._tangents=[],this._normals=[],this._binormals=[],this._pointAtData={id:0,point:a.Pq.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:a.uq.Identity()};for(let t=0;t<e.length;t++)this._curve[t]=e[t].clone();this._raw=r||!1,this._alignTangentsWithPath=i,this._compute(t,i)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?a.Pq.TransformCoordinates(a.Pq.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?a.Pq.TransformCoordinates(a.Pq.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?a.Pq.TransformCoordinates(a.Pq.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,r=0;for(let i=0;i<this._curve.length-1;i++){let n=this._curve[i+0],s=this._curve[i+1].subtract(n).normalize(),o=this._distances[i+1]-this._distances[i+0],h=Math.min(Math.max(a.Pq.Dot(s,e.subtract(n).normalize()),0)*a.Pq.Distance(n,e)/o,1),l=a.Pq.Distance(n.add(s.scale(h*o)),e);l<t&&(t=l,r=(this._distances[i+0]+o*h)/this.length())}return r}slice(e=0,t=1){if(e<0&&(e=1- -1*e%1),t<0&&(t=1- -1*t%1),e>t){let r=e;e=t,t=r}let r=this.getCurve(),i=this.getPointAt(e),n=this.getPreviousPointIndexAt(e),s=this.getPointAt(t),a=this.getPreviousPointIndexAt(t)+1,o=[];return 0!==e&&(n++,o.push(i)),o.push(...r.slice(n,a)),(1!==t||1===e)&&o.push(s),new d(o,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,r=!1){for(let t=0;t<e.length;t++)this._curve[t].x=e[t].x,this._curve[t].y=e[t].y,this._curve[t].z=e[t].z;return this._compute(t,r),this}_compute(e,t=!1){let r,i,n,s,o,h=this._curve.length;if(h<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[h-1]=this._curve[h-1].subtract(this._curve[h-2]),this._raw||this._tangents[h-1].normalize();let l=this._tangents[0],u=this._normalVector(l,e);this._normals[0]=u,this._raw||this._normals[0].normalize(),this._binormals[0]=a.Pq.Cross(l,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(let e=1;e<h;e++)r=this._getLastNonNullVector(e),e<h-1&&(i=this._getFirstNonNullVector(e),this._tangents[e]=t?i:r.add(i),this._tangents[e].normalize()),this._distances[e]=this._distances[e-1]+this._curve[e].subtract(this._curve[e-1]).length(),n=this._tangents[e],o=this._binormals[e-1],this._normals[e]=a.Pq.Cross(o,n),this._raw||(0===this._normals[e].length()?(s=this._normals[e-1],this._normals[e]=s.clone()):this._normals[e].normalize()),this._binormals[e]=a.Pq.Cross(n,this._normals[e]),this._raw||this._binormals[e].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,r=this._curve[e+t].subtract(this._curve[e]);for(;0===r.length()&&e+t+1<this._curve.length;)t++,r=this._curve[e+t].subtract(this._curve[e]);return r}_getLastNonNullVector(e){let t=1,r=this._curve[e].subtract(this._curve[e-t]);for(;0===r.length()&&e>t+1;)t++,r=this._curve[e].subtract(this._curve[e-t]);return r}_normalVector(e,t){let r,i=e.length();if(0===i&&(i=1),null==t){let t;t=(0,s.WithinEpsilon)(Math.abs(e.y)/i,1,o.bH)?(0,s.WithinEpsilon)(Math.abs(e.x)/i,1,o.bH)?(0,s.WithinEpsilon)(Math.abs(e.z)/i,1,o.bH)?a.Pq.Zero():new a.Pq(0,0,1):new a.Pq(1,0,0):new a.Pq(0,-1,0),r=a.Pq.Cross(e,t)}else r=a.Pq.Cross(e,t),a.Pq.CrossToRef(r,e,r);return r.normalize(),r}_updatePointAtData(e,t=!1){let r;if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;let i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let n=i[0],s=0,o=e*this.length();for(let h=1;h<i.length;h++){r=i[h];let l=a.Pq.Distance(n,r);if((s+=l)===o)return this._setPointAtData(e,1,r,h,t);if(s>o){let i=(s-o)/l,a=n.subtract(r),u=r.add(a.scaleInPlace(i));return this._setPointAtData(e,1-i,u,h-1,t)}n=r}return this._pointAtData}_setPointAtData(e,t,r,i,n){return this._pointAtData.point=r,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=i,this._pointAtData.interpolateReady=n,n&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=a.uq.Identity();let e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){let t=e+1,r=this._tangents[e].clone(),i=this._normals[e].clone(),n=this._binormals[e].clone(),s=this._tangents[t].clone(),o=this._normals[t].clone(),h=this._binormals[t].clone(),l=a.PT.RotationQuaternionFromAxis(i,n,r),u=a.PT.RotationQuaternionFromAxis(o,h,s);a.PT.Slerp(l,u,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class c{static CreateQuadraticBezier(e,t,r,i){i=i>2?i:3;let n=[],s=(e,t,r,i)=>(1-e)*(1-e)*t+2*e*(1-e)*r+e*e*i;for(let o=0;o<=i;o++)n.push(new a.Pq(s(o/i,e.x,t.x,r.x),s(o/i,e.y,t.y,r.y),s(o/i,e.z,t.z,r.z)));return new c(n)}static CreateCubicBezier(e,t,r,i,n){n=n>3?n:4;let s=[],o=(e,t,r,i,n)=>(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*r+3*e*e*(1-e)*i+e*e*e*n;for(let h=0;h<=n;h++)s.push(new a.Pq(o(h/n,e.x,t.x,r.x,i.x),o(h/n,e.y,t.y,r.y,i.y),o(h/n,e.z,t.z,r.z,i.z)));return new c(s)}static CreateHermiteSpline(e,t,r,i,n){let s=[],o=1/n;for(let h=0;h<=n;h++)s.push(a.Pq.Hermite(e,t,r,i,h*o));return new c(s)}static CreateCatmullRomSpline(e,t,r){let i=[],n=1/t,s=0;if(r){let r=e.length;for(let o=0;o<r;o++){s=0;for(let h=0;h<t;h++)i.push(a.Pq.CatmullRom(e[o%r],e[(o+1)%r],e[(o+2)%r],e[(o+3)%r],s)),s+=n}i.push(i[0])}else{let r=[];r.push(e[0].clone()),Array.prototype.push.apply(r,e),r.push(e[e.length-1].clone());let o=0;for(;o<r.length-3;o++){s=0;for(let e=0;e<t;e++)i.push(a.Pq.CatmullRom(r[o],r[o+1],r[o+2],r[o+3],s)),s+=n}o--,i.push(a.Pq.CatmullRom(r[o],r[o+1],r[o+2],r[o+3],s))}return new c(i)}static ArcThru3Points(e,t,r,i=32,n=!1,s=!1){let o=[],h=t.subtract(e),l=r.subtract(t),u=e.subtract(r),_=a.Pq.Cross(h,l),d=_.length();if(d<1e-8)return new c(o);let f=h.lengthSquared(),p=l.lengthSquared(),g=u.lengthSquared(),T=_.lengthSquared(),R=.5*h.length()*l.length()*u.length()/d,E=a.Pq.Dot(h,u),b=a.Pq.Dot(h,l),m=a.Pq.Dot(l,u),A=e.scale(-.5*p*E/T).add(t.scale(-.5*g*b/T)).add(r.scale(-.5*f*m/T)),P=e.subtract(A).normalize(),x=a.Pq.Cross(_,P).normalize();if(s){let t=2*Math.PI/i;for(let e=0;e<=2*Math.PI;e+=t)o.push(A.add(P.scale(R*Math.cos(e)).add(x.scale(R*Math.sin(e)))));o.push(e)}else{let t=1/i,s=0,h=a.Pq.Zero();do h=A.add(P.scale(R*Math.cos(s)).add(x.scale(R*Math.sin(s)))),o.push(h),s+=t;while(!h.equalsWithEpsilon(r,R*t*1.1));o.push(r),n&&o.push(e)}return new c(o)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){let t=this._points[this._points.length-1],r=this._points.slice(),i=e.getPoints();for(let e=1;e<i.length;e++)r.push(i[e].subtract(i[0]).add(t));return new c(r)}_computeLength(e){let t=0;for(let r=1;r<e.length;r++)t+=e[r].subtract(e[r-1]).length();return t}}},80655:function(e,t,r){r.d(t,{B:()=>n,k:()=>s});var i=r(49733);class n{constructor(e=i.Pq.Zero(),t=i.Pq.Up()){this.position=e,this.normal=t}clone(){return new n(this.position.clone(),this.normal.clone())}}class s{constructor(e=i.Pq.Zero(),t=i.Pq.Up(),r=i.I9.Zero()){this.position=e,this.normal=t,this.uv=r}clone(){return new s(this.position.clone(),this.normal.clone(),this.uv.clone())}}},16784:function(e,t,r){r.d(t,{L:()=>i});class i{constructor(e,t,r,i){this.x=e,this.y=t,this.width=r,this.height=i}toGlobal(e,t){return new i(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,r){return r.x=this.x*e,r.y=this.y*t,r.width=this.width*e,r.height=this.height*t,this}clone(){return new i(this.x,this.y,this.width,this.height)}}},73621:function(e,t,r){let i,n;r.d(t,{EE:()=>u,LO:()=>T,LZ:()=>d,Oz:()=>g,Qs:()=>_,SX:()=>c,v9:()=>f});var s=r(64527),a=r(60804),o=r(15298),h=r(15577),l=r(69821);function u(e,t,r,i=!0){let n=e.getScene(),h=n.getEngine(),l=new a.$("resized"+e.name,{width:t,height:r},n,!e.noMipmap,!0,e._texture.type,!1,e.samplingMode,!1);l.wrapU=e.wrapU,l.wrapV=e.wrapV,l.uOffset=e.uOffset,l.vOffset=e.vOffset,l.uScale=e.uScale,l.vScale=e.vScale,l.uAng=e.uAng,l.vAng=e.vAng,l.wAng=e.wAng,l.coordinatesIndex=e.coordinatesIndex,l.level=e.level,l.anisotropicFilteringLevel=e.anisotropicFilteringLevel,l._texture.isReady=!1,e.wrapU=s.g.CLAMP_ADDRESSMODE,e.wrapV=s.g.CLAMP_ADDRESSMODE;let _=new o.v("pass",1,null,i?s.g.BILINEAR_SAMPLINGMODE:s.g.NEAREST_SAMPLINGMODE,h,!1,0);return _.externalTextureSamplerBinding=!0,_.onEffectCreatedObservable.addOnce(t=>{t.executeWhenCompiled(()=>{_.onApply=function(t){t.setTexture("textureSampler",e)};let t=l.renderTarget;t&&(n.postProcessManager.directRender([_],t),h.unBindFramebuffer(t),l.disposeFramebufferObjects(),_.dispose(),l.getInternalTexture().isReady=!0)})}),l}function _(e,t,r,i,n,s,a,o){let l=t.getEngine();return t.isReady=!1,n=n??t.samplingMode,i=i??t.type,s=s??t.format,a=a??t.width,o=o??t.height,-1===i&&(i=0),new Promise(u=>{let _=new h.w("postprocess",e,null,null,1,null,n,l,!1,void 0,i,void 0,null,!1,s);_.externalTextureSamplerBinding=!0;let d=l.createRenderTargetTexture({width:a,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n,type:i,format:s});_.onEffectCreatedObservable.addOnce(e=>{e.executeWhenCompiled(()=>{_.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},r.postProcessManager.directRender([_],d,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(t),_&&_.dispose(),d._swapAndDie(t),t.type=i,t.format=5,t.isReady=!0,u(t)})})})}function d(e){i||(n=new Int32Array((i=new Float32Array(1)).buffer)),i[0]=e;let t=n[0],r=t>>16&32768,s=t>>12&2047,a=t>>23&255;return a<103?r:a>142?(r|=31744,r|=+(255!=a)&&8388607&t):a<113?(s|=2048,r|=(s>>114-a)+(s>>113-a&1)):(r|=a-112<<10|s>>1,r+=1&s)}function c(e){let t=(32768&e)>>15,r=(31744&e)>>10,i=1023&e;return 0===r?(t?-1:1)*6103515625e-14*(i/1024):31==r?i?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,r-15)*(1+i/1024)}async function f(e){if(e.isReady())return;if(e.loadingError)throw Error(e.errorObject?.message||`Texture ${e.name} errored while loading.`);let t=e.onLoadObservable;if(t)return await new Promise(e=>t.addOnce(()=>e()));let r=e._texture?.onLoadedObservable;if(r)return await new Promise(e=>r.addOnce(()=>e()));throw Error(`Cannot determine readiness of texture ${e.name}.`)}async function p(e,t,i,n,o){let l,u=e.getScene(),_=u.getEngine();_.isWebGPU?e.isCube?await r.e("3721").then(r.bind(r,72336)):await r.e("2080").then(r.bind(r,43683)):e.isCube?await r.e("5728").then(r.bind(r,47027)):await r.e("5993").then(r.bind(r,29584)),l=e.isCube?new h.w("lodCube","lodCube",{uniforms:["lod","gamma"],samplingMode:s.g.NEAREST_NEAREST_MIPNEAREST,engine:_,defines:["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"][n],shaderLanguage:+!!_.isWebGPU}):new h.w("lod","lod",{uniforms:["lod","gamma"],samplingMode:s.g.NEAREST_NEAREST_MIPNEAREST,engine:_,shaderLanguage:+!!_.isWebGPU}),await new Promise(e=>{l.onEffectCreatedObservable.addOnce(t=>{t.executeWhenCompiled(()=>{e(0)})})});let d=new a.$("temp",{width:t,height:i},u,!1);l.onApply=function(t){t.setTexture("textureSampler",e),t.setFloat("lod",o),t.setInt("gamma",+!!e.gammaSpace)};let c=e.getInternalTexture();try{if(d.renderTarget&&c){let r=c.samplingMode;0!==o?e.updateSamplingMode(s.g.NEAREST_NEAREST_MIPNEAREST):e.updateSamplingMode(s.g.NEAREST_NEAREST),u.postProcessManager.directRender([l],d.renderTarget,!0),e.updateSamplingMode(r);let n=await _.readPixels(0,0,t,i),a=new Uint8Array(n.buffer,0,n.byteLength);return _.unBindFramebuffer(d.renderTarget),a}throw Error("Render to texture failed.")}finally{d.dispose(),l.dispose()}}async function g(e,t,r,i=0,n=0){await f(e);let{width:s,height:a}=e.getSize(),o=t??s,h=r??a;if(function(e){switch(e){case 36492:case 36493:case 36495:case 36494:case 33779:case 35919:case 33778:case 35918:case 33777:case 33776:case 35917:case 35916:case 37808:case 37840:case 36196:case 37492:case 37493:case 37494:case 37495:case 37496:case 37497:return!0;default:return!1}}(e.textureFormat)||o!==s||h!==a)return await p(e,o,h,i,n);let u=await e.readPixels(i,n);if(!u)throw Error(`Failed to read pixels from texture ${e.name}.`);if(u instanceof Float32Array){let e=new Uint8Array(u.length),t=u.length;for(;t--;){let r=u[t];e[t]=Math.round(255*(0,l.Clamp)(r))}u=e}return u}let T={CreateResizedCopy:u,ApplyPostProcess:_,ToHalfFloat:d,FromHalfFloat:c,GetTextureDataAsync:g}},15298:function(e,t,r){r.d(t,{s:()=>_,v:()=>u});var i=r(63566),n=r(15577),s=r(74496),a=r(94346),o=r(93615),h=r(40727),l=r(40117);class u extends n.w{getClassName(){return"PassPostProcess"}constructor(e,t,r=null,i,n,s,a=0,o=!1){const l={size:"number"==typeof t?t:void 0,camera:r,samplingMode:i,engine:n,reusable:s,textureType:a,blockCompilation:o,...t};super(e,h.m.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new h.m(e,n,l),...l})}static _Parse(e,t,r,i){return o.p.Parse(()=>new u(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,r,i)}}(0,a.Y5)("BABYLON.PassPostProcess",u);class _ extends n.w{get face(){return this._effectWrapper.face}set face(e){this._effectWrapper.face=e}getClassName(){return"PassCubePostProcess"}constructor(e,t,r=null,i,n,s,a=0,o=!1){const l={size:"number"==typeof t?t:void 0,camera:r,samplingMode:i,engine:n,reusable:s,textureType:a,blockCompilation:o,...t};super(e,h.m.FragmentUrl,{effectWrapper:"number"!=typeof t&&t.effectWrapper?void 0:new h.V(e,n,l),...l})}static _Parse(e,t,r,i){return o.p.Parse(()=>new _(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,r,i)}}(0,i.Cg)([(0,l.lK)()],_.prototype,"face",null),s.$._RescalePostProcessFactory=e=>new u("rescale",1,null,2,e,!1,0)},2366:function(e,t,r){r.r(t),r.d(t,{postprocessVertexShader:()=>a});var i=r(29416);let n="postprocessVertexShader",s=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;i.l.ShadersStore[n]||(i.l.ShadersStore[n]=s);let a={name:n,shader:s}}}]);