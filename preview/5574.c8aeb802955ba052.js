/*
 *  This file is part of Cosmos Journeyer
 *
 *  Copyright (C) 2024 Barthélemy Paléologue <barth.paleologue@cosmosjourneyer.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";(globalThis.webpackChunk_cosmos_journeyer_game=globalThis.webpackChunk_cosmos_journeyer_game||[]).push([["5574"],{53012:function(e,t,i){i.d(t,{G:()=>s});class s{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(let e in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(let e in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,e)){let t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(let t in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,t)&&parseInt(t)===e)return!0;return!1}}s.Triggers={}},14301:function(e,t,i){i.d(t,{X:()=>s});class s{constructor(e,t,i,s,r,a){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=a}static CreateNew(e,t,i){let r=e.getScene();return new s(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new s(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new s(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new s(e,t.x,t.y,null,i,r)}}},17997:function(e,t,i){i.d(t,{i:()=>g});var s=i(24423),r=i(49196),a=i(78584),n=i(12299),o=i(97183),h=i(64244),l=i(34027),d=i(48766),u=i(79793),c=i(884),_=i(94037),p=i(6553),f=i(42462);class g extends l.b{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===g.PERSPECTIVE_CAMERA)this.fovMode===g.FOVMODE_VERTICAL_FIXED?(t=2*this.minZ*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):t=(e=2*this.minZ*Math.tan(this.fov/2))/this.getEngine().getAspectRatio(this);else{let i=this.getEngine().getRenderWidth()/2,s=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??s)-(this.orthoBottom??-s)}return e*t}set orthoLeft(e){for(let t of(this._orthoLeft=e,this._rigCameras))t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){for(let t of(this._orthoRight=e,this._rigCameras))t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){for(let t of(this._orthoBottom=e,this._rigCameras))t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){for(let t of(this._orthoTop=e,this._rigCameras))t.orthoTop=e}get orthoTop(){return this._orthoTop}setFocalLength(e,t=36){this.fov=2*Math.atan(t/(2*e))}set mode(e){for(let t of(this._mode=e,this._rigCameras))t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,s=!0){super(e,i,!1),this._position=h.Pq.Zero(),this._upVector=h.Pq.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=g.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new _.L(0,0,1,1),this.layerMask=0xfffffff,this.fovMode=g.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=g.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new o.cP,this.onProjectionMatrixChangedObservable=new o.cP,this.onAfterCheckInputsObservable=new o.cP,this.onRestoreStateObservable=new o.cP,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=[],this._skipRendering=!1,this._projectionMatrix=new h.uq,this._postProcesses=[],this._activeMeshes=new a.L(256),this._globalPosition=h.Pq.Zero(),this._computedViewMatrix=h.uq.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=h.uq.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=h.PT.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return!!this._stateStored&&(this.fov=this._storedFov,!0)}restoreState(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){let e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return -1!==this._activeMeshes.indexOf(e)}isReady(e=!1){if(e){for(let e of this._postProcesses)if(e&&!e.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new h.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new h.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return!!super._isSynchronized()&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;let t=this.getEngine();return this.mode===g.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==g.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){let e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){let t=this._rigCameras[e],i=t._rigPostProcess;i?("pass"===i.getEffectName()&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(d.V.Error("You're trying to reuse a post process not defined as reusable."),0):(null==t||t<0?this._postProcesses.push(e):null===this._postProcesses[t]?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){let t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return h.uq.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()||(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix)),this._computedViewMatrix}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;let t=this.getEngine(),i=this.getScene(),s=t.useReverseDepthBuffer;if(this.mode===g.PERSPECTIVE_CAMERA)this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1),(i.useRightHandedSystem?h.uq.PerspectiveFovRHToRef:h.uq.PerspectiveFovLHToRef)(this.fov,t.getAspectRatio(this),s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===g.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,s);else{let e=t.getRenderWidth()/2,r=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?h.uq.ObliqueOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):h.uq.OrthoOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?h.uq.ObliqueOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):h.uq.OrthoOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-r,this.orthoTop??r,s?this.maxZ:this.minZ,s?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=this.oblique?.angle,this._cache.obliqueLength=this.oblique?.length,this._cache.obliqueOffset=this.oblique?.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){return(this.radius||(this.target?h.Pq.Distance(this.position,this.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?p.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=p.P.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),!t||!(this.rigCameras.length>0))return e.isInFrustum(this._frustumPlanes);{let t=!1;for(let i of this.rigCameras)i._updateFrustumPlanes(),t=t||e.isInFrustum(i._frustumPlanes);return t}}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw(0,c.n)("Ray")}getForwardRayToRef(e,t=100,i,s){throw(0,c.n)("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){let e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){let e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==g.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){let t=this._postProcesses[e];t&&t.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){let e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=n.S0.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==g.RIG_MODE_NONE){let e=this.createRigCamera(this.name+"_L",0);e&&(e._isLeftCamera=!0);let t=this.createRigCamera(this.name+"_R",1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return h.uq.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=n.S0.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===g.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){let e=f.p.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),f.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){let i=f.p.Clone(g.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){let t=h.Pq.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){h.Pq.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,r=!0){let a=l.b.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:r});return a||(()=>g._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){let i=e.type,s=g.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=f.p.Parse(s,e,t);if(void 0!==e.parentId&&(r._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=h.Pq.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(h.Pq.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(h.Pq.FromArray(e.target)),e.cameraRigMode){let t=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,t)}if(e.animations){for(let t=0;t<e.animations.length;t++){let i=e.animations[t],s=(0,u.n9)("BABYLON.Animation");s&&r.animations.push(s.Parse(i))}l.b.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&r.setEnabled(e.isEnabled),r}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&0>this.parent._getWorldMatrixDeterminant()&&(e*=-1),e}}g._CreateDefaultParsedCamera=(e,t)=>{throw(0,c.n)("UniversalCamera")},g.PERSPECTIVE_CAMERA=0,g.ORTHOGRAPHIC_CAMERA=1,g.FOVMODE_VERTICAL_FIXED=0,g.FOVMODE_HORIZONTAL_FIXED=1,g.RIG_MODE_NONE=0,g.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,g.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,g.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,g.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,g.RIG_MODE_STEREOSCOPIC_INTERLACED=14,g.RIG_MODE_VR=20,g.RIG_MODE_CUSTOM=22,g.ForceAttachControlToAlwaysPreventDefault=!1,(0,s.Cg)([(0,r.P_)("position")],g.prototype,"_position",void 0),(0,s.Cg)([(0,r.P_)("upVector")],g.prototype,"_upVector",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"orthoLeft",null),(0,s.Cg)([(0,r.lK)()],g.prototype,"orthoRight",null),(0,s.Cg)([(0,r.lK)()],g.prototype,"orthoBottom",null),(0,s.Cg)([(0,r.lK)()],g.prototype,"orthoTop",null),(0,s.Cg)([(0,r.lK)()],g.prototype,"fov",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"projectionPlaneTilt",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"minZ",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"maxZ",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"inertia",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"mode",null),(0,s.Cg)([(0,r.lK)()],g.prototype,"layerMask",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"fovMode",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"cameraRigMode",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"interaxialDistance",void 0),(0,s.Cg)([(0,r.lK)()],g.prototype,"isStereoscopicSideBySide",void 0)},57230:function(e,t,i){i.d(t,{G:()=>a});var s=i(64244),r=i(63329);class a{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){let i;if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(r.R.NormalKind))return null;let a=this.pickedMesh.getIndices();a?.length===0&&(a=null);let n=s.AA.Vector3["0"],o=s.AA.Vector3["1"],h=s.AA.Vector3["2"];if(t){let e=this.pickedMesh.getVerticesData(r.R.NormalKind),t=a?s.Pq.FromArrayToRef(e,3*a[3*this.faceId],n):n.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),l=a?s.Pq.FromArrayToRef(e,3*a[3*this.faceId+1],o):o.copyFromFloats(e[(3*this.faceId+1)*3],e[(3*this.faceId+1)*3+1],e[(3*this.faceId+1)*3+2]),d=a?s.Pq.FromArrayToRef(e,3*a[3*this.faceId+2],h):h.copyFromFloats(e[(3*this.faceId+2)*3],e[(3*this.faceId+2)*3+1],e[(3*this.faceId+2)*3+2]);t=t.scale(this.bu),l=l.scale(this.bv),d=d.scale(1-this.bu-this.bv),i=new s.Pq(t.x+l.x+d.x,t.y+l.y+d.y,t.z+l.z+d.z)}else{let e=this.pickedMesh.getVerticesData(r.R.PositionKind),t=a?s.Pq.FromArrayToRef(e,3*a[3*this.faceId],n):n.copyFromFloats(e[3*this.faceId*3],e[3*this.faceId*3+1],e[3*this.faceId*3+2]),l=a?s.Pq.FromArrayToRef(e,3*a[3*this.faceId+1],o):o.copyFromFloats(e[(3*this.faceId+1)*3],e[(3*this.faceId+1)*3+1],e[(3*this.faceId+1)*3+2]),d=a?s.Pq.FromArrayToRef(e,3*a[3*this.faceId+2],h):h.copyFromFloats(e[(3*this.faceId+2)*3],e[(3*this.faceId+2)*3+1],e[(3*this.faceId+2)*3+2]),u=t.subtract(l),c=d.subtract(l);i=s.Pq.Cross(u,c)}let l=(e,t)=>{if(-1!==this.thinInstanceIndex){let i=e.thinInstanceGetWorldMatrices()[this.thinInstanceIndex];i&&s.Pq.TransformNormalToRef(t,i,t)}let i=e.getWorldMatrix();e.nonUniformScaling&&(s.AA.Matrix["0"].copyFrom(i),(i=s.AA.Matrix["0"]).setTranslationFromFloats(0,0,0),i.invert(),i.transposeToRef(s.AA.Matrix["1"]),i=s.AA.Matrix["1"]),s.Pq.TransformNormalToRef(t,i,t)};if(e&&l(this.pickedMesh,i),this.ray){let t=s.AA.Vector3["0"].copyFrom(i);e||l(this.pickedMesh,t),s.Pq.Dot(t,this.ray.direction)>0&&i.negateInPlace()}return i.normalize(),i}getTextureCoordinates(e=r.R.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;let t=this.pickedMesh.getIndices();if(!t)return null;let i=this.pickedMesh.getVerticesData(e);if(!i)return null;let a=s.I9.FromArray(i,2*t[3*this.faceId]),n=s.I9.FromArray(i,2*t[3*this.faceId+1]),o=s.I9.FromArray(i,2*t[3*this.faceId+2]);return a=a.scale(this.bu),n=n.scale(this.bv),o=o.scale(1-this.bu-this.bv),new s.I9(a.x+n.x+o.x,a.y+n.y+o.y)}}},79985:function(e,t,i){i.d(t,{I:()=>n});var s=i(64770),r=i(64244),a=i(4174);class n{constructor(e,t,i){this.vectors=(0,s.mI)(8,r.Pq.Zero),this.center=r.Pq.Zero(),this.centerWorld=r.Pq.Zero(),this.extendSize=r.Pq.Zero(),this.extendSizeWorld=r.Pq.Zero(),this.directions=(0,s.mI)(3,r.Pq.Zero),this.vectorsWorld=(0,s.mI)(8,r.Pq.Zero),this.minimumWorld=r.Pq.Zero(),this.maximumWorld=r.Pq.Zero(),this.minimum=r.Pq.Zero(),this.maximum=r.Pq.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){let s=e.x,a=e.y,n=e.z,o=t.x,h=t.y,l=t.z,d=this.vectors;this.minimum.copyFromFloats(s,a,n),this.maximum.copyFromFloats(o,h,l),d[0].copyFromFloats(s,a,n),d[1].copyFromFloats(o,h,l),d[2].copyFromFloats(o,a,n),d[3].copyFromFloats(s,h,n),d[4].copyFromFloats(s,a,l),d[5].copyFromFloats(o,h,n),d[6].copyFromFloats(s,h,l),d[7].copyFromFloats(o,a,l),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||r.uq.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){let t=n._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);let r=s*e,a=i.scaleInPlace(.5*r),o=this.center.subtractToRef(a,t[1]),h=this.center.addToRef(a,t[2]);return this.reConstruct(o,h,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){let t=this.minimumWorld,i=this.maximumWorld,s=this.directions,a=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let e=0;e<8;++e)a[e].copyFrom(n[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let s=0;s<8;++s){let o=a[s];r.Pq.TransformCoordinatesToRef(n[s],e,o),t.minimizeInPlace(o),i.maximizeInPlace(o)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}r.Pq.FromArrayToRef(e.m,0,s[0]),r.Pq.FromArrayToRef(e.m,4,s[1]),r.Pq.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return n.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return n.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){let t=this.minimumWorld,i=this.maximumWorld,s=t.x,r=t.y,n=t.z,o=i.x,h=i.y,l=i.z,d=e.x,u=e.y,c=e.z,_=-a.bH;return!(o-d<_)&&!(_>d-s)&&!(h-u<_)&&!(_>u-r)&&!(l-c<_)&&!(_>c-n)}intersectsSphere(e){return n.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){let i=this.minimumWorld,s=this.maximumWorld,r=i.x,a=i.y,n=i.z,o=s.x,h=s.y,l=s.z,d=e.x,u=e.y,c=e.z,_=t.x,p=t.y,f=t.z;return!(o<d)&&!(r>_)&&!(h<u)&&!(a>p)&&!(l<c)&&!(n>f)}dispose(){this._drawWrapperFront?.dispose(),this._drawWrapperBack?.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){let a=n._TmpVector3[0];return r.Pq.ClampToRef(i,e,t,a),r.Pq.DistanceSquared(i,a)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){let s=t[i];for(let t=0;t<8;++t)if(0>s.dotCoordinate(e[t]))return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0,r=t[i];for(let t=0;t<8;++t)if(r.dotCoordinate(e[t])>=0){s=!1;break}if(s)return!1}return!0}}n._TmpVector3=(0,s.mI)(3,r.Pq.Zero)},45378:function(e,t,i){i.d(t,{j:()=>u});var s=i(64770),r=i(64244),a=i(79985),n=i(131);let o={min:0,max:0},h={min:0,max:0},l=(e,t,i)=>{let s=r.Pq.Dot(t.centerWorld,e),a=Math.abs(r.Pq.Dot(t.directions[0],e))*t.extendSize.x+Math.abs(r.Pq.Dot(t.directions[1],e))*t.extendSize.y+Math.abs(r.Pq.Dot(t.directions[2],e))*t.extendSize.z;i.min=s-a,i.max=s+a},d=(e,t,i)=>(l(e,t,o),l(e,i,h),!(o.min>h.max||h.min>o.max));class u{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new a.I(e,t,i),this.boundingSphere=new n.i(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){let i=u._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=u._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){let t=r.Pq.Minimize(this.minimum,e),i=r.Pq.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){let t=r.AA.Matrix["0"];this.boundingBox.getWorldMatrix().invertToRef(t);let i=r.AA.Vector3["0"];return r.Pq.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),r.Pq.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return!!((2===t||3===t)&&this.boundingSphere.isCenterInFrustum(e))||!!this.boundingSphere.isInFrustum(e)&&(1===t||3===t||this.boundingBox.isInFrustum(e))}get diagonalLength(){let e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,u._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e)}intersects(e,t){if(!n.i.Intersects(this.boundingSphere,e.boundingSphere)||!a.I.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;let i=this.boundingBox,s=e.boundingBox;return!!d(i.directions[0],i,s)&&!!d(i.directions[1],i,s)&&!!d(i.directions[2],i,s)&&!!d(s.directions[0],i,s)&&!!d(s.directions[1],i,s)&&!!d(s.directions[2],i,s)&&!!d(r.Pq.Cross(i.directions[0],s.directions[0]),i,s)&&!!d(r.Pq.Cross(i.directions[0],s.directions[1]),i,s)&&!!d(r.Pq.Cross(i.directions[0],s.directions[2]),i,s)&&!!d(r.Pq.Cross(i.directions[1],s.directions[0]),i,s)&&!!d(r.Pq.Cross(i.directions[1],s.directions[1]),i,s)&&!!d(r.Pq.Cross(i.directions[1],s.directions[2]),i,s)&&!!d(r.Pq.Cross(i.directions[2],s.directions[0]),i,s)&&!!d(r.Pq.Cross(i.directions[2],s.directions[1]),i,s)&&!!d(r.Pq.Cross(i.directions[2],s.directions[2]),i,s)&&!0}}u._TmpVector3=(0,s.mI)(2,r.Pq.Zero)},131:function(e,t,i){i.d(t,{i:()=>a});var s=i(64770),r=i(64244);class a{constructor(e,t,i){this.center=r.Pq.Zero(),this.centerWorld=r.Pq.Zero(),this.minimum=r.Pq.Zero(),this.maximum=r.Pq.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);let s=r.Pq.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=.5*s,this._update(i||r.uq.IdentityReadOnly)}scale(e){let t=this.radius*e,i=a._TmpVector3,s=i[0].setAll(t),r=this.center.subtractToRef(s,i[1]),n=this.center.addToRef(s,i[2]);return this.reConstruct(r,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{r.Pq.TransformCoordinatesToRef(this.center,e,this.centerWorld);let t=a._TmpVector3[0];r.Pq.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){let t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){let t=this.centerWorld;for(let i=0;i<6;i++)if(0>e[i].dotCoordinate(t))return!1;return!0}intersectsPoint(e){let t=r.Pq.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){let i=r.Pq.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);let s=new a(this._TmpVector3[0],this._TmpVector3[2]);return i?s._worldMatrix=i:s._worldMatrix=r.uq.Identity(),s}}a._TmpVector3=(0,s.mI)(3,r.Pq.Zero)},60804:function(e,t,i){var s,r,a,n,o,h,l,d,u,c,_,p,f,g;i.d(t,{ST:()=>r,Ze:()=>a,bq:()=>s,dR:()=>l,h8:()=>n,pI:()=>o,sZ:()=>h}),(d=s||(s={}))[d.Generic=0]="Generic",d[d.Keyboard=1]="Keyboard",d[d.Mouse=2]="Mouse",d[d.Touch=3]="Touch",d[d.DualShock=4]="DualShock",d[d.Xbox=5]="Xbox",d[d.Switch=6]="Switch",d[d.DualSense=7]="DualSense",(u=r||(r={}))[u.Horizontal=0]="Horizontal",u[u.Vertical=1]="Vertical",u[u.LeftClick=2]="LeftClick",u[u.MiddleClick=3]="MiddleClick",u[u.RightClick=4]="RightClick",u[u.BrowserBack=5]="BrowserBack",u[u.BrowserForward=6]="BrowserForward",u[u.MouseWheelX=7]="MouseWheelX",u[u.MouseWheelY=8]="MouseWheelY",u[u.MouseWheelZ=9]="MouseWheelZ",u[u.Move=12]="Move",(c=a||(a={}))[c.Horizontal=0]="Horizontal",c[c.Vertical=1]="Vertical",c[c.LeftClick=2]="LeftClick",c[c.MiddleClick=3]="MiddleClick",c[c.RightClick=4]="RightClick",c[c.BrowserBack=5]="BrowserBack",c[c.BrowserForward=6]="BrowserForward",c[c.MouseWheelX=7]="MouseWheelX",c[c.MouseWheelY=8]="MouseWheelY",c[c.MouseWheelZ=9]="MouseWheelZ",c[c.DeltaHorizontal=10]="DeltaHorizontal",c[c.DeltaVertical=11]="DeltaVertical",(_=n||(n={}))[_.Cross=0]="Cross",_[_.Circle=1]="Circle",_[_.Square=2]="Square",_[_.Triangle=3]="Triangle",_[_.L1=4]="L1",_[_.R1=5]="R1",_[_.L2=6]="L2",_[_.R2=7]="R2",_[_.Share=8]="Share",_[_.Options=9]="Options",_[_.L3=10]="L3",_[_.R3=11]="R3",_[_.DPadUp=12]="DPadUp",_[_.DPadDown=13]="DPadDown",_[_.DPadLeft=14]="DPadLeft",_[_.DPadRight=15]="DPadRight",_[_.Home=16]="Home",_[_.TouchPad=17]="TouchPad",_[_.LStickXAxis=18]="LStickXAxis",_[_.LStickYAxis=19]="LStickYAxis",_[_.RStickXAxis=20]="RStickXAxis",_[_.RStickYAxis=21]="RStickYAxis",(p=o||(o={}))[p.Cross=0]="Cross",p[p.Circle=1]="Circle",p[p.Square=2]="Square",p[p.Triangle=3]="Triangle",p[p.L1=4]="L1",p[p.R1=5]="R1",p[p.L2=6]="L2",p[p.R2=7]="R2",p[p.Create=8]="Create",p[p.Options=9]="Options",p[p.L3=10]="L3",p[p.R3=11]="R3",p[p.DPadUp=12]="DPadUp",p[p.DPadDown=13]="DPadDown",p[p.DPadLeft=14]="DPadLeft",p[p.DPadRight=15]="DPadRight",p[p.Home=16]="Home",p[p.TouchPad=17]="TouchPad",p[p.LStickXAxis=18]="LStickXAxis",p[p.LStickYAxis=19]="LStickYAxis",p[p.RStickXAxis=20]="RStickXAxis",p[p.RStickYAxis=21]="RStickYAxis",(f=h||(h={}))[f.A=0]="A",f[f.B=1]="B",f[f.X=2]="X",f[f.Y=3]="Y",f[f.LB=4]="LB",f[f.RB=5]="RB",f[f.LT=6]="LT",f[f.RT=7]="RT",f[f.Back=8]="Back",f[f.Start=9]="Start",f[f.LS=10]="LS",f[f.RS=11]="RS",f[f.DPadUp=12]="DPadUp",f[f.DPadDown=13]="DPadDown",f[f.DPadLeft=14]="DPadLeft",f[f.DPadRight=15]="DPadRight",f[f.Home=16]="Home",f[f.LStickXAxis=17]="LStickXAxis",f[f.LStickYAxis=18]="LStickYAxis",f[f.RStickXAxis=19]="RStickXAxis",f[f.RStickYAxis=20]="RStickYAxis",(g=l||(l={}))[g.B=0]="B",g[g.A=1]="A",g[g.Y=2]="Y",g[g.X=3]="X",g[g.L=4]="L",g[g.R=5]="R",g[g.ZL=6]="ZL",g[g.ZR=7]="ZR",g[g.Minus=8]="Minus",g[g.Plus=9]="Plus",g[g.LS=10]="LS",g[g.RS=11]="RS",g[g.DPadUp=12]="DPadUp",g[g.DPadDown=13]="DPadDown",g[g.DPadLeft=14]="DPadLeft",g[g.DPadRight=15]="DPadRight",g[g.Home=16]="Home",g[g.Capture=17]="Capture",g[g.LStickXAxis=18]="LStickXAxis",g[g.LStickYAxis=19]="LStickYAxis",g[g.RStickXAxis=20]="RStickXAxis",g[g.RStickYAxis=21]="RStickYAxis"},76709:function(e,t,i){i.d(t,{c:()=>r});var s=i(97183);class r{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new s.cP,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}},43388:function(e,t,i){i.d(t,{Z:()=>p});var s=i(60804),r=i(97183),a=i(95362);class n{static CreateDeviceEvent(e,t,i,r,a,n,o){switch(e){case s.bq.Keyboard:return this._CreateKeyboardEvent(i,r,a,n);case s.bq.Mouse:if(i===s.ST.MouseWheelX||i===s.ST.MouseWheelY||i===s.ST.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,a,n);case s.bq.Touch:return this._CreatePointerEvent(e,t,i,r,a,n,o);default:throw`Unable to generate event for device ${s.bq[e]}`}}static _CreatePointerEvent(e,t,i,r,a,n,o){let h=this._CreateMouseEvent(e,t,i,r,a,n);return e===s.bq.Mouse?(h.deviceType=s.bq.Mouse,h.pointerId=1,h.pointerType="mouse"):(h.deviceType=s.bq.Touch,h.pointerId=o??t,h.pointerType="touch"),h.buttons=0+a.pollInput(e,t,s.ST.LeftClick)+2*a.pollInput(e,t,s.ST.RightClick)+4*a.pollInput(e,t,s.ST.MiddleClick),i===s.ST.Move?h.type="pointermove":i>=s.ST.LeftClick&&i<=s.ST.RightClick&&(h.type=1===r?"pointerdown":"pointerup",h.button=i-2),h}static _CreateWheelEvent(e,t,i,r,n,o){let h=this._CreateMouseEvent(e,t,i,r,n,o);switch(h.pointerId=1,h.type="wheel",h.deltaMode=a.s.DOM_DELTA_PIXEL,h.deltaX=0,h.deltaY=0,h.deltaZ=0,i){case s.ST.MouseWheelX:h.deltaX=r;break;case s.ST.MouseWheelY:h.deltaY=r;break;case s.ST.MouseWheelZ:h.deltaZ=r}return h}static _CreateMouseEvent(e,t,i,r,a,n){let o=this._CreateEvent(n),h=a.pollInput(e,t,s.ST.Horizontal),l=a.pollInput(e,t,s.ST.Vertical);return n?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-n.getBoundingClientRect().x,o.offsetY=o.movementY-n.getBoundingClientRect().y):(o.movementX=a.pollInput(e,t,10),o.movementY=a.pollInput(e,t,11),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,a),o.clientX=h,o.clientY=l,o.x=h,o.y=l,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,r){let a=this._CreateEvent(r);return this._CheckNonCharacterKeys(a,i),a.deviceType=s.bq.Keyboard,a.deviceSlot=0,a.inputIndex=e,a.type=1===t?"keydown":"keyup",a.key=String.fromCharCode(e),a.keyCode=e,a}static _CheckNonCharacterKeys(e,t){let i=t.isDeviceAvailable(s.bq.Keyboard),r=i&&1===t.pollInput(s.bq.Keyboard,0,18),a=i&&1===t.pollInput(s.bq.Keyboard,0,17),n=i&&(1===t.pollInput(s.bq.Keyboard,0,91)||1===t.pollInput(s.bq.Keyboard,0,92)||1===t.pollInput(s.bq.Keyboard,0,93)),o=i&&1===t.pollInput(s.bq.Keyboard,0,16);e.altKey=r,e.ctrlKey=a,e.metaKey=n,e.shiftKey=o}static _CreateEvent(e){let t={};return t.preventDefault=()=>{},t.target=e,t}}class o{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(e,t,s,r)=>{let a=n.CreateDeviceEvent(e,t,s,r,this);i(e,t,a)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===s.bq.Mouse||e===s.bq.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}var h=i(46703),l=i(12299);let d=Object.keys(s.ST).length/2;class u{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=l.S0.IsSafari(),this._usingMacOs=(0,h.XD)()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerCancelTouch=e=>{},this._pointerLeaveEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._pointerMacOsChromeOutEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=(0,h.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Firefox"),this._isUsingChromium=(0,h.XD)()&&navigator.userAgent&&-1!==navigator.userAgent.indexOf("Chrome"),this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=l.S0.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=+!this._isUsingFirefox,this._enableEvents(),this._usingMacOs&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){let r=this._inputs[e][t];if(!r)throw`Unable to find device ${s.bq[e]}`;e>=s.bq.DualShock&&e<=s.bq.DualSense&&this._updateDevice(e,t,i);let a=r[i];if(void 0===a)throw`Unable to find input ${i} for device ${s.bq[e]} in slot ${t}`;return i===s.ST.Move&&l.S0.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),a}isDeviceAvailable(e){return void 0!==this._inputs[e]}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){let e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(let e of this._inputs)if(e)for(let t in e){let i=e[+t];if(i)for(let e=0;e<i.length;e++)i[e]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=-1!==this._elementToAttachTo.tabIndex?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOs&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads)for(let e of navigator.getGamepads())e&&this._addGamePad(e);"function"==typeof matchMedia&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(s.bq.Mouse,0,0,0)}_addGamePad(e){let t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,d);let r=this._inputs[e][t];r[0]=i,r[1]=s}_registerDevice(e,t,i){if(void 0===t)throw`Unable to register device ${s.bq[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){let s=Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(s.bq.Keyboard,0,255));let t=this._inputs[s.bq.Keyboard][0];t&&(t[e.keyCode]=1,e.inputIndex=e.keyCode,this._usingMacOs&&e.metaKey&&"Meta"!==e.key&&!this._metaKeys.includes(e.keyCode)&&this._metaKeys.push(e.keyCode),this._onInputChanged(s.bq.Keyboard,0,e))},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(s.bq.Keyboard,0,255));let t=this._inputs[s.bq.Keyboard][0];if(t){if(t[e.keyCode]=0,e.inputIndex=e.keyCode,this._usingMacOs&&"Meta"===e.key&&this._metaKeys.length>0){for(let e of this._metaKeys){let i=n.CreateDeviceEvent(s.bq.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(s.bq.Keyboard,0,i)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(s.bq.Keyboard,0,e)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){let e=this._inputs[s.bq.Keyboard][0];for(let t=0;t<e.length;t++)if(0!==e[t]){e[t]=0;let i=n.CreateDeviceEvent(s.bq.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(s.bq.Keyboard,0,i)}this._usingMacOs&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=(0,h.XD)()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=Array(this._maxTouchPoints));for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{let t=this._getPointerType(e),i=t===s.bq.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===s.bq.Touch&&-1===i){let s=this._activeTouchIds.indexOf(-1);if(!(s>=0))return void l.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=s,this._activeTouchIds[s]=e.pointerId,this._onDeviceConnected(t,i)}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]||this._addPointerDevice(t,i,e.clientX,e.clientY);let r=this._inputs[t][i];r&&(e.inputIndex=s.ST.Move,r[s.ST.Horizontal]=e.clientX,r[s.ST.Vertical]=e.clientY,t===s.bq.Touch&&0===r[s.ST.LeftClick]&&(r[s.ST.LeftClick]=1),void 0===e.pointerId&&(e.pointerId=this._mouseId),this._onInputChanged(t,i,e),this._usingSafari||-1===e.button||(e.inputIndex=e.button+2,r[e.button+2]=+!r[e.button+2],this._onInputChanged(t,i,e)))},this._pointerDownEvent=e=>{let t=this._getPointerType(e),i=t===s.bq.Mouse?0:e.pointerId;if(t===s.bq.Touch){let t=this._activeTouchIds.indexOf(e.pointerId);if(-1===t&&(t=this._activeTouchIds.indexOf(-1)),!(t>=0))return void l.S0.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);i=t,this._activeTouchIds[t]=e.pointerId}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][i]?t===s.bq.Touch&&this._onDeviceConnected(t,i):this._addPointerDevice(t,i,e.clientX,e.clientY);let r=this._inputs[t][i];if(r){let a=r[s.ST.Horizontal],n=r[s.ST.Vertical];if(t===s.bq.Mouse){if(void 0===e.pointerId&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch(e){}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch(e){}r[s.ST.Horizontal]=e.clientX,r[s.ST.Vertical]=e.clientY,r[e.button+2]=1,e.inputIndex=e.button+2,this._onInputChanged(t,i,e),(a!==e.clientX||n!==e.clientY)&&(e.inputIndex=s.ST.Move,this._onInputChanged(t,i,e))}},this._pointerUpEvent=e=>{let t=this._getPointerType(e),i=t===s.bq.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(t===s.bq.Touch)if(-1===i)return;else this._activeTouchIds[i]=-1;let r=this._inputs[t]?.[i],a=e.button,n=r&&0!==r[a+2];if(!n&&this._isUsingFirefox&&this._usingMacOs&&r&&(n=0!==r[(a=2*(2!==a))+2]),n){let n=r[s.ST.Horizontal],o=r[s.ST.Vertical];r[s.ST.Horizontal]=e.clientX,r[s.ST.Vertical]=e.clientY,r[a+2]=0,void 0===e.pointerId&&(e.pointerId=this._mouseId),(n!==e.clientX||o!==e.clientY)&&(e.inputIndex=s.ST.Move,this._onInputChanged(t,i,e)),e.inputIndex=a+2,t===s.bq.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&this._elementToAttachTo.hasPointerCapture?.(e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(t,i,e),t===s.bq.Touch&&this._onDeviceDisconnected(t,i)}},this._pointerCancelTouch=e=>{let t=this._activeTouchIds.indexOf(e);if(-1===t)return;this._elementToAttachTo.hasPointerCapture?.(e)&&this._elementToAttachTo.releasePointerCapture(e),this._inputs[s.bq.Touch][t][s.ST.LeftClick]=0;let i=n.CreateDeviceEvent(s.bq.Touch,t,s.ST.LeftClick,0,this,this._elementToAttachTo,e);this._onInputChanged(s.bq.Touch,t,i),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(s.bq.Touch,t)},this._pointerCancelEvent=e=>{if("mouse"===e.pointerType){let e=this._inputs[s.bq.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=s.ST.LeftClick;t<=s.ST.BrowserForward;t++)if(1===e[t]){e[t]=0;let i=n.CreateDeviceEvent(s.bq.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(s.bq.Mouse,0,i)}}else this._pointerCancelTouch(e.pointerId)},this._pointerLeaveEvent=e=>{"pen"===e.pointerType&&this._pointerCancelTouch(e.pointerId)},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";let e=!1,t=function(){};try{let i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch(e){}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(s.bq.Mouse)){let e=this._inputs[s.bq.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=s.ST.LeftClick;t<=s.ST.BrowserForward;t++)if(1===e[t]){e[t]=0;let i=n.CreateDeviceEvent(s.bq.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(s.bq.Mouse,0,i)}}if(this.isDeviceAvailable(s.bq.Touch)){let e=this._inputs[s.bq.Touch];for(let t=0;t<this._activeTouchIds.length;t++){let i=this._activeTouchIds[t];if(this._elementToAttachTo.hasPointerCapture?.(i)&&this._elementToAttachTo.releasePointerCapture(i),-1!==i&&e[t]?.[s.ST.LeftClick]===1){e[t][s.ST.LeftClick]=0;let r=n.CreateDeviceEvent(s.bq.Touch,t,s.ST.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(s.bq.Touch,t,r),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(s.bq.Touch,t)}}}},this._pointerWheelEvent=e=>{let t=s.bq.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,d));let i=this._inputs[t][0];i&&(i[s.ST.MouseWheelX]=e.deltaX||0,i[s.ST.MouseWheelY]=e.deltaY||e.wheelDelta||0,i[s.ST.MouseWheelZ]=e.deltaZ||0,void 0===e.pointerId&&(e.pointerId=this._mouseId),0!==i[s.ST.MouseWheelX]&&(e.inputIndex=s.ST.MouseWheelX,this._onInputChanged(t,0,e)),0!==i[s.ST.MouseWheelY]&&(e.inputIndex=s.ST.MouseWheelY,this._onInputChanged(t,0,e)),0!==i[s.ST.MouseWheelZ]&&(e.inputIndex=s.ST.MouseWheelZ,this._onInputChanged(t,0,e)))},this._usingMacOs&&this._isUsingChromium&&(this._pointerMacOsChromeOutEvent=e=>{e.buttons>1&&this._pointerCancelEvent(e)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,!!e&&{passive:!1}),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(s.bq.Mouse)){let e=this._inputs[s.bq.Mouse][0];e[s.ST.MouseWheelX]=0,e[s.ST.MouseWheelY]=0,e[s.ST.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){let t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){let s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){let r=this._inputs[e][t];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return -1!==e.indexOf("054c")?-1!==e.indexOf("0ce6")?s.bq.DualSense:s.bq.DualShock:-1!==e.indexOf("Xbox One")||-1!==e.search("Xbox 360")||-1!==e.search("xinput")?s.bq.Xbox:-1!==e.indexOf("057e")?s.bq.Switch:s.bq.Generic}_getPointerType(e){let t=s.bq.Mouse;return("touch"===e.pointerType||"pen"===e.pointerType||e.touches)&&(t=s.bq.Touch),t}}var c=i(76709);class _{constructor(e){this._registeredManagers=[],this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){let i=this._devices[t];for(let s in i){let i=+s;e._addDevice(new c.c(this._deviceInputSystem,t,i))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{let t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};const t=Object.keys(s.bq).length/2;this._devices=Array(t);const i=(e,t)=>{for(let i of(this._devices[e]||(this._devices[e]=[]),this._devices[e][t]||(this._devices[e][t]=t),this._registeredManagers)){let s=new c.c(this._deviceInputSystem,e,t);i._addDevice(s)}},r=(e,t)=>{for(let i of(this._devices[e]?.[t]&&delete this._devices[e][t],this._registeredManagers))i._removeDevice(e,t)},a=(e,t,i)=>{if(i)for(let s of this._registeredManagers)s._onInputChanged(e,t,i)};"undefined"!=typeof _native?this._deviceInputSystem=new o(i,r,a):this._deviceInputSystem=new u(e,i,r,a)}dispose(){this._deviceInputSystem.dispose()}}class p{getDeviceSource(e,t){if(void 0===t){if(void 0===this._firstDevice[e])return null;t=this._firstDevice[e]}return this._devices[e]&&void 0!==this._devices[e][t]?this._devices[e][t]:null}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(e=>!!e):[]}constructor(e){const t=Object.keys(s.bq).length/2;this._devices=Array(t),this._firstDevice=Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new _(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new r.cP(e=>{for(let t of this._devices)if(t)for(let i of t)i&&this.onDeviceConnectedObservable.notifyObserver(e,i)}),this.onDeviceDisconnectedObservable=new r.cP,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=[]),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){let i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case s.bq.Keyboard:case s.bq.Mouse:this._firstDevice[e]=0;break;case s.bq.Touch:case s.bq.DualSense:case s.bq.DualShock:case s.bq.Xbox:case s.bq.Switch:case s.bq.Generic:{delete this._firstDevice[e];let t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}}}}}},95362:function(e,t,i){var s,r;i.d(t,{b:()=>s,s:()=>a}),(r=s||(s={}))[r.PointerMove=0]="PointerMove",r[r.PointerDown=1]="PointerDown",r[r.PointerUp=2]="PointerUp";class a{}a.DOM_DELTA_PIXEL=0,a.DOM_DELTA_LINE=1,a.DOM_DELTA_PAGE=2},30013:function(e,t,i){i.d(t,{Bu:()=>a,TB:()=>s,W0:()=>r});class s{}s.KEYDOWN=1,s.KEYUP=2;class r{constructor(e,t){this.type=e,this.event=t}}class a extends r{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}},82633:function(e,t,i){i.d(t,{Vn:()=>a,Zp:()=>r,mx:()=>o,tT:()=>n});var s=i(64244);class r{}r.POINTERDOWN=1,r.POINTERUP=2,r.POINTERMOVE=4,r.POINTERWHEEL=8,r.POINTERPICK=16,r.POINTERTAP=32,r.POINTERDOUBLETAP=64;class a{constructor(e,t){this.type=e,this.event=t}}class n extends a{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new s.I9(i,r)}}class o extends a{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}},16172:function(e,t,i){i.d(t,{x:()=>r});var s=i(73260);class r extends s.X{static IsCullPass(e){return void 0!==e.setObjectList}get objectList(){return this._objectList}setObjectList(e){this._objectList=e}constructor(e,t,i,s){super(e,t,i),this._engine=s}_isValid(){return super._isValid()||(void 0!==this._objectList?null:"Object list is not set (call setObjectList to set it)")}}},73260:function(e,t,i){i.d(t,{X:()=>s});class s{constructor(e,t,i){this.name=e,this._parentTask=t,this._context=i,this.disabled=!1}setExecuteFunc(e){this._executeFunc=e}_execute(){this.disabled||this._executeFunc(this._context)}_isValid(){return void 0!==this._executeFunc?null:"Execute function is not set (call setExecuteFunc to set it)"}}},4680:function(e,t,i){i.d(t,{p:()=>r});var s=i(73260);class r extends s.X{static IsRenderPass(e){return void 0!==e.setRenderTarget}get renderTarget(){return this._renderTarget}get renderTargetDepth(){return this._renderTargetDepth}constructor(e,t,i,s){super(e,t,i),this._dependencies=new Set,this.depthReadOnly=!1,this.stencilReadOnly=!1,this._engine=s}setRenderTarget(e){this._renderTarget=e}setRenderTargetDepth(e){this._renderTargetDepth=e}addDependencies(e){if(void 0!==e)if(Array.isArray(e))for(let t of e)this._dependencies.add(t);else this._dependencies.add(e)}collectDependencies(e){let t=this._dependencies.keys();for(let i=t.next();!0!==i.done;i=t.next())e.add(i.value);if(void 0!==this._renderTarget)if(Array.isArray(this._renderTarget))for(let t of this._renderTarget)void 0!==t&&e.add(t);else e.add(this._renderTarget);void 0!==this._renderTargetDepth&&e.add(this._renderTargetDepth)}_execute(){this._frameGraphRenderTarget=this._frameGraphRenderTarget||this._context.createRenderTarget(this.name,this._renderTarget,this._renderTargetDepth,this.depthReadOnly,this.stencilReadOnly),this._context.bindRenderTarget(this._frameGraphRenderTarget,`frame graph render pass - ${this.name}`),super._execute(),this._context._flushDebugMessages()}_isValid(){return super._isValid()||(void 0!==this._renderTarget||void 0!==this.renderTargetDepth?null:"Render target and render target depth cannot both be undefined.")}}},79532:function(e,t,i){i.d(t,{C:()=>r});var s=i(77729);class r extends s.L{get drawWrapper(){return this._postProcessDrawWrapper}constructor(e,t,i){super(e,t),this.sourceSamplingMode=2,this.depthReadOnly=!1,this.stencilReadOnly=!1,this.disableColorWrite=!1,this.drawBackFace=!1,this.depthTest=!0,this.postProcess=i,this._postProcessDrawWrapper=this.postProcess.drawWrapper,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthAttachmentTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this.postProcess.isReady()}record(e=!1,t,i){if(void 0===this.sourceTexture&&void 0===this.targetTexture)throw Error(`FrameGraphPostProcessTask "${this.name}": sourceTexture or targetTexture is required`);let s=void 0!==this.sourceTexture?this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture):void 0;if(s&&(s.options.samples=1),this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name,s),void 0!==this.depthAttachmentTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthAttachmentTexture,this.depthAttachmentTexture),s){let e=this._frameGraph.textureManager.getTextureAbsoluteDimensions(s);this._sourceWidth=e.width,this._sourceHeight=e.height}let r=this._frameGraph.textureManager.getTextureDescription(this.outputTexture);this._outputWidth=r.size.width,this._outputHeight=r.size.height;let a=this._frameGraph.addRenderPass(this.name);if(a.depthReadOnly=this.depthReadOnly,a.stencilReadOnly=this.stencilReadOnly,a.addDependencies(this.sourceTexture),a.setRenderTarget(this.outputTexture),a.setRenderTargetDepth(this.depthAttachmentTexture),a.setExecuteFunc(e=>{void 0!==this.sourceTexture&&e.setTextureSamplingMode(this.sourceTexture,this.sourceSamplingMode),t?.(e),e.applyFullScreenEffect(this._postProcessDrawWrapper,()=>{void 0!==this.sourceTexture&&e.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.sourceTexture),i?.(e),this.postProcess.bind()},this.stencilState,this.disableColorWrite,this.drawBackFace,this.depthTest)}),!e){let e=this._frameGraph.addRenderPass(this.name+"_disabled",!0);e.depthReadOnly=this.depthReadOnly,e.stencilReadOnly=this.stencilReadOnly,e.addDependencies(this.sourceTexture),e.setRenderTarget(this.outputTexture),e.setRenderTargetDepth(this.depthAttachmentTexture),e.setExecuteFunc(e=>{void 0!==this.sourceTexture&&e.copyTexture(this.sourceTexture)})}return a}dispose(){this.postProcess.dispose(),super.dispose()}}},20478:function(e,t,i){i.d(t,{w:()=>l});var s=i(62084),r=i(26597),a=i(64957),n=i(64739),o=i(79532),h=i(4111);class l extends r.Q{static IsCascadedShadowGenerator(e){return void 0!==e.numCascades}get numCascades(){return this._numCascades}set numCascades(e){e!==this._numCascades&&(this._numCascades=e,this._setupShadowGenerator())}get debug(){return this._debug}set debug(e){e!==this._debug&&(this._debug=e,this._shadowGenerator&&(this._shadowGenerator.debug=e))}get stabilizeCascades(){return this._stabilizeCascades}set stabilizeCascades(e){e!==this._stabilizeCascades&&(this._stabilizeCascades=e,this._shadowGenerator&&(this._shadowGenerator.stabilizeCascades=e))}get lambda(){return this._lambda}set lambda(e){e!==this._lambda&&(this._lambda=e,this._shadowGenerator&&(this._shadowGenerator.lambda=e))}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){e!==this._cascadeBlendPercentage&&(this._cascadeBlendPercentage=e,this._shadowGenerator&&(this._shadowGenerator.cascadeBlendPercentage=e))}get depthClamp(){return this._depthClamp}set depthClamp(e){e!==this._depthClamp&&(this._depthClamp=e,this._shadowGenerator&&(this._shadowGenerator.depthClamp=e))}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){if(e===this._autoCalcDepthBounds)return;this._autoCalcDepthBounds=e,this._currentAutoCalcDepthBoundsCounter=this._autoCalcDepthBoundsRefreshRate,e||this._shadowGenerator?.setMinMaxDistance(0,1);let t=this.passes;for(let i=0;i<t.length-1;++i)t[i].disabled=!e}get autoCalcDepthBoundsRefreshRate(){return this._autoCalcDepthBoundsRefreshRate}set autoCalcDepthBoundsRefreshRate(e){this._autoCalcDepthBoundsRefreshRate=e,this._currentAutoCalcDepthBoundsCounter=this._autoCalcDepthBoundsRefreshRate}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){e!==this._shadowMaxZ&&(this._shadowMaxZ=e,this._shadowGenerator&&(this._shadowGenerator.shadowMaxZ=e))}constructor(e,t,i){super(e,t,i),this.depthTextureType=0,this._numCascades=s.c.DEFAULT_CASCADES_COUNT,this._debug=!1,this._stabilizeCascades=!1,this._lambda=.5,this._cascadeBlendPercentage=.1,this._depthClamp=!0,this._autoCalcDepthBounds=!1,this._currentAutoCalcDepthBoundsCounter=0,this._autoCalcDepthBoundsRefreshRate=1,this._shadowMaxZ=1e4,this._thinMinMaxReducer=new n.Qh(i),this._thinMinMaxReducer.onAfterReductionPerformed.add(e=>{if(!this._shadowGenerator)return;let t=this.camera,i=e.min,s=e.max;if(i>=s)i=0,s=1;else if(t&&0!==this.depthTextureType){if(2===this.depthTextureType){let e=this._frameGraph.engine,r=t.getProjectionMatrix(),a=r.m[10],n=r.m[14];e.isNDCHalfZRange||(i=2*i-1,s=2*s-1),i=n/(i-a),s=n/(s-a)}let e=t.minZ,r=t.maxZ;i=(i-e)/(r-e),s=(s-e)/(r-e)}(i!==this._shadowGenerator.minDistance||s!==this._shadowGenerator.maxDistance)&&this._shadowGenerator.setMinMaxDistance(i,s)})}_createShadowGenerator(){if(!(this.light instanceof a.Z))throw Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: the CSM shadow generator only supports directional lights.`);this._shadowGenerator=new s.c(this.mapSize,this.light,this.useFloat32TextureType,this.camera,this.useRedTextureFormat),this._shadowGenerator.numCascades=this._numCascades}_setupShadowGenerator(){super._setupShadowGenerator();let e=this._shadowGenerator;void 0!==e&&(e.debug=this._debug,e.stabilizeCascades=this._stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this._cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.shadowMaxZ=this._shadowMaxZ)}record(){if(void 0===this.light||void 0===this.objectList||void 0===this.camera)throw Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: light, objectList and camera are required`);if(void 0!==this.depthTexture){let e,t=this._frameGraph.textureManager.getTextureCreationOptions(this.depthTexture),i=t.sizeIsPercentage?this._frameGraph.textureManager.getAbsoluteDimensions(t.size):(0,h.e)(t.size)?t.size:{width:t.size,height:t.size},s=i.width,r=i.height;t.sizeIsPercentage=!1,t.options.formats=[7],t.options.samples=1,this._thinMinMaxReducer.setTextureDimensions(s,r,this.depthTextureType);let a=this._thinMinMaxReducer.reductionSteps;this._frameGraph.addPass(`${this.name} Before Min Max Reduction`).setExecuteFunc(e=>{e.pushDebugGroup("Min Max Reduction")});for(let i=0;i<a.length-1;++i){let s=a[i];t.size={width:a[i+1].textureWidth,height:a[i+1].textureHeight};let r=new o.C(s.name,this._frameGraph,s);r.sourceTexture=0==i?this.depthTexture:e,r.sourceSamplingMode=1,r.targetTexture=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} ${s.name}`,t),r.record(!0),e=r.outputTexture}this._frameGraph.addPass(`${this.name} After Min Max Reduction`).setExecuteFunc(t=>{if(t.popDebugGroup(),this._autoCalcDepthBounds&&this._currentAutoCalcDepthBoundsCounter>=0){if(++this._currentAutoCalcDepthBoundsCounter>=this._autoCalcDepthBoundsRefreshRate){let i=t.getTextureFromHandle(e);i&&this._thinMinMaxReducer.readMinMax(i)}this._currentAutoCalcDepthBoundsCounter%=this._autoCalcDepthBoundsRefreshRate,0===this._autoCalcDepthBoundsRefreshRate&&(this._currentAutoCalcDepthBoundsCounter=-1)}})}super.record()}dispose(){super.dispose(),this._thinMinMaxReducer.dispose()}}},99872:function(e,t,i){i.d(t,{H:()=>o});var s=i(85411),r=i(77729),a=i(5666),n=i(20478);class o extends r.L{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(e){e!==this._disableImageProcessing&&(this._disableImageProcessing=e,this._renderer.disableImageProcessing=e)}get renderParticles(){return this._renderParticles}set renderParticles(e){e!==this._renderParticles&&(this._renderParticles=e,this._renderer.renderParticles=e)}get renderSprites(){return this._renderSprites}set renderSprites(e){e!==this._renderSprites&&(this._renderSprites=e,this._renderer.renderSprites=e)}get forceLayerMaskCheck(){return this._forceLayerMaskCheck}set forceLayerMaskCheck(e){e!==this._forceLayerMaskCheck&&(this._forceLayerMaskCheck=e,this._renderer.forceLayerMaskCheck=e)}get enableBoundingBoxRendering(){return this._enableBoundingBoxRendering}set enableBoundingBoxRendering(e){e!==this._enableBoundingBoxRendering&&(this._enableBoundingBoxRendering=e,this._renderer.enableBoundingBoxRendering=e)}get enableOutlineRendering(){return this._enableOutlineRendering}set enableOutlineRendering(e){e!==this._enableOutlineRendering&&(this._enableOutlineRendering=e,this._renderer.enableOutlineRendering=e)}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}constructor(e,t,i,s,r){super(e,t),this.shadowGenerators=[],this.depthTest=!0,this.depthWrite=!0,this.disableShadows=!1,this._disableImageProcessing=!1,this.isMainObjectRenderer=!1,this._renderParticles=!0,this._renderSprites=!0,this._forceLayerMaskCheck=!0,this._enableBoundingBoxRendering=!0,this._enableOutlineRendering=!0,this._onBeforeRenderObservable=null,this._onAfterRenderObservable=null,this._externalObjectRenderer=!1,this._scene=i,this._engine=i.getEngine(),this._externalObjectRenderer=!!r,this._renderer=r??new a.P(e,i,s),this.name=e,this._renderer.disableImageProcessing=this._disableImageProcessing,this._renderer.renderParticles=this._renderParticles,this._renderer.renderSprites=this._renderSprites,this._renderer.enableBoundingBoxRendering=this._enableBoundingBoxRendering,this._renderer.forceLayerMaskCheck=this._forceLayerMaskCheck,this._externalObjectRenderer||this._renderer.onBeforeRenderingManagerRenderObservable.add(()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)}),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(e=!1,t){if(void 0===this.targetTexture||void 0===this.objectList)throw Error(`FrameGraphObjectRendererTask ${this.name}: targetTexture and objectList are required`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;let i=Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture],r=this._frameGraph.textureManager.getTextureDescription(i[0]),a=!1;if(void 0!==this.depthTexture){if(this.depthTexture===s.m&&(i[0]!==s.O||i.length>1))throw Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer color texture is the only color texture allowed when the depth is the back buffer depth/stencil`);if(this.depthTexture!==s.m&&i[0]===s.O)throw Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer depth/stencil texture is the only depth texture allowed when the target is the back buffer color`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==r.options.samples)throw Error(`FrameGraphObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);a=!0}this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,i[0]),void 0!==this.depthTexture&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=r.size.width,this._textureHeight=r.size.height,this._setLightsForShadow();let n=this._frameGraph.addRenderPass(this.name);if(n.setRenderTarget(i),n.setRenderTargetDepth(this.depthTexture),n.setExecuteFunc(e=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;let i=this.getBoundingBoxRenderer?.(),s=i&&i.renderList.length>0?i.renderList.data.slice():[];i&&(s.length=i.renderList.length),e.setDepthStates(this.depthTest&&a,this.depthWrite&&a);let r=this._renderer.activeCamera;if(r&&0!==r.cameraRigMode&&!r._renderingMultiview){for(let t=0;t<r._rigCameras.length;t++){let i=r._rigCameras[t];i.rigParent=void 0,this._renderer.activeCamera=i,e.render(this._renderer,this._textureWidth,this._textureHeight),i.rigParent=r}this._renderer.activeCamera=r}else e.render(this._renderer,this._textureWidth,this._textureHeight);t?.(e),i&&(i.renderList.data=s,i.renderList.length=s.length)}),!e){let e=this._frameGraph.addRenderPass(this.name+"_disabled",!0);e.setRenderTarget(i),e.setRenderTargetDepth(this.depthTexture),e.setExecuteFunc(e=>{})}return n}dispose(){this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._externalObjectRenderer||this._renderer.dispose(),super.dispose()}_setLightsForShadow(){let e=new Set,t=new Map;if(this.shadowGenerators)for(let t of this.shadowGenerators){let i=t.shadowGenerator,s=i.getLight();s.isEnabled()&&s.shadowEnabled&&(e.add(s),n.w.IsCascadedShadowGenerator(t)?s._shadowGenerators.set(t.camera,i):s._shadowGenerators.set(null,i))}this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._onBeforeRenderObservable=this._renderer.onBeforeRenderObservable.add(()=>{for(let i=0;i<this._scene.lights.length;i++){let s=this._scene.lights[i];s.setShadowProjectionMatrix&&(t.set(s,s.shadowEnabled),s.shadowEnabled=!this.disableShadows&&e.has(s))}}),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._onAfterRenderObservable=this._renderer.onAfterRenderObservable.add(()=>{for(let e=0;e<this._scene.lights.length;e++){let i=this._scene.lights[e];i.setShadowProjectionMatrix&&(i.shadowEnabled=t.get(i))}})}}},26597:function(e,t,i){i.d(t,{Q:()=>a});var s=i(77729),r=i(50170);class a extends s.L{get light(){return this._light}set light(e){e!==this._light&&(this._light=e,this._setupShadowGenerator())}get camera(){return this._camera}set camera(e){this._camera=e,this._setupShadowGenerator()}get mapSize(){return this._mapSize}set mapSize(e){e!==this._mapSize&&(this._mapSize=e,this._setupShadowGenerator())}get useFloat32TextureType(){return this._useFloat32TextureType}set useFloat32TextureType(e){e!==this._useFloat32TextureType&&(this._useFloat32TextureType=e,this._setupShadowGenerator())}get useRedTextureFormat(){return this._useRedTextureFormat}set useRedTextureFormat(e){e!==this._useRedTextureFormat&&(this._useRedTextureFormat=e,this._setupShadowGenerator())}get bias(){return this._bias}set bias(e){e!==this._bias&&(this._bias=e,this._shadowGenerator&&(this._shadowGenerator.bias=e))}get normalBias(){return this._normalBias}set normalBias(e){e!==this._normalBias&&(this._normalBias=e,this._shadowGenerator&&(this._shadowGenerator.normalBias=e))}get darkness(){return this._darkness}set darkness(e){e!==this._darkness&&(this._darkness=e,this._shadowGenerator&&(this._shadowGenerator.darkness=e))}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){e!==this._transparencyShadow&&(this._transparencyShadow=e,this._shadowGenerator&&(this._shadowGenerator.transparencyShadow=e))}get enableSoftTransparentShadow(){return this._enableSoftTransparentShadow}set enableSoftTransparentShadow(e){e!==this._enableSoftTransparentShadow&&(this._enableSoftTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.enableSoftTransparentShadow=e))}get useOpacityTextureForTransparentShadow(){return this._useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){e!==this._useOpacityTextureForTransparentShadow&&(this._useOpacityTextureForTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.useOpacityTextureForTransparentShadow=e))}get filter(){return this._filter}set filter(e){e!==this._filter&&(this._filter=e,this._shadowGenerator&&(this._shadowGenerator.filter=e))}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){e!==this._filteringQuality&&(this._filteringQuality=e,this._shadowGenerator&&(this._shadowGenerator.filteringQuality=e))}_createShadowGenerator(){this._shadowGenerator=new r.o(this._mapSize,this._light,this._useFloat32TextureType,void 0,this._useRedTextureFormat)}_setupShadowGenerator(){if(this._shadowGenerator?.dispose(),this._shadowGenerator=void 0,void 0!==this._light){this._createShadowGenerator();let e=this._shadowGenerator;if(void 0===e)return;e.bias=this._bias,e.normalBias=this._normalBias,e.darkness=this._darkness,e.transparencyShadow=this._transparencyShadow,e.enableSoftTransparentShadow=this._enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this._useOpacityTextureForTransparentShadow,e.filter=this._filter,e.filteringQuality=this._filteringQuality;let t=e.getShadowMap();t._disableEngineStages=!0,t.cameraForLOD=this._camera,this.shadowGenerator=e}}isReady(){return!!this._shadowGenerator&&!!this._shadowGenerator.getShadowMap()?.isReadyForRendering()}constructor(e,t,i){super(e,t),this._mapSize=1024,this._useFloat32TextureType=!1,this._useRedTextureFormat=!0,this._bias=.01,this._normalBias=0,this._darkness=0,this._transparencyShadow=!1,this._enableSoftTransparentShadow=!1,this._useOpacityTextureForTransparentShadow=!1,this._filter=r.o.FILTER_PCF,this._filteringQuality=r.o.QUALITY_HIGH,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(void 0===this.light||void 0===this.objectList||void 0===this.camera)throw Error(`FrameGraphShadowGeneratorTask ${this.name}: light, objectList and camera are required`);let e=this._shadowGenerator.getShadowMap();e.renderList=this.objectList.meshes,e.particleSystemList=this.objectList.particleSystems;let t=this._frameGraph.textureManager.importTexture(`${this.name} shadowmap`,this._shadowGenerator.getShadowMap().getInternalTexture());this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,t),this._frameGraph.addPass(this.name).setExecuteFunc(e=>{if(!this.light.isEnabled()||!this.light.shadowEnabled)return;let t=this._shadowGenerator.getShadowMap();t.renderList=this.objectList.meshes,t.particleSystemList=this.objectList.particleSystems,e.saveDepthStates(),e.setDepthStates(!0,!0),e.renderUnmanaged(t),e.restoreDepthStates()}),this._frameGraph.addPass(this.name+"_disabled",!0).setExecuteFunc(e=>{})}dispose(){this._shadowGenerator?.dispose(),this._shadowGenerator=void 0}}},77729:function(e,t,i){i.d(t,{L:()=>n});var s=i(16172),r=i(4680),a=i(97183);class n{get name(){return this._name}set name(e){this._name=e}get disabled(){return this._disabled}set disabled(e){this._disabled=e}get passes(){return this._passes}get passesDisabled(){return this._passesDisabled}isReady(){return!0}dispose(){this._reset(),this.onTexturesAllocatedObservable.clear()}constructor(e,t){this._passes=[],this._passesDisabled=[],this._disabled=!1,this.onTexturesAllocatedObservable=new a.cP,this.name=e,this._frameGraph=t,this._reset()}_reset(){this._passes.length=0,this._passesDisabled.length=0}_addPass(e,t){t?this._passesDisabled.push(e):this._passes.push(e)}_checkTask(){let e,t,i=null,a=null;for(let t of this._passes){let n=t._isValid();if(n)throw Error(`Pass "${t.name}" is not valid. ${n}`);if(r.p.IsRenderPass(t)){for(let e of(i=[],Array.isArray(t.renderTarget)?t.renderTarget:[t.renderTarget]))void 0!==e&&i.push(this._frameGraph.textureManager.getTextureFromHandle(e));a=void 0!==t.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(t.renderTargetDepth):null}else s.x.IsCullPass(t)&&(e=t.objectList)}let n=null,o=[],h=null;for(let e of this._passesDisabled){let i=e._isValid();if(i)throw Error(`Pass "${e.name}" is not valid. ${i}`);if(r.p.IsRenderPass(e)){let t=Array.isArray(e.renderTarget)?e.renderTarget:[e.renderTarget];for(let e of(n=[],t))void 0!==e&&n.push(this._frameGraph.textureManager.getTextureFromHandle(e));o=t,h=void 0!==e.renderTargetDepth?this._frameGraph.textureManager.getTextureFromHandle(e.renderTargetDepth):null}else s.x.IsCullPass(e)&&(t=e.objectList)}if(this._passesDisabled.length>0){if(!this._checkSameRenderTarget(i,n)){let e=!0;for(let t of o)if(void 0!==t&&!this._frameGraph.textureManager.isHistoryTexture(t)){e=!1;break}if(!e)throw Error(`The output texture of the task "${this.name}" is different when it is enabled or disabled.`)}if(a!==h)throw Error(`The output depth texture of the task "${this.name}" is different when it is enabled or disabled.`);if(e!==t)throw Error(`The output object list of the task "${this.name}" is different when it is enabled or disabled.`)}}_getPasses(){return this.disabled&&this._passesDisabled.length>0?this._passesDisabled:this._passes}_checkSameRenderTarget(e,t){if(null===e||null===t)return e===t;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}}},85411:function(e,t,i){i.d(t,{O:()=>s,m:()=>r});let s=0,r=1},62084:function(e,t,i){i.d(t,{c:()=>m});var s=i(64244),r=i(42011),a=i(884),n=i(50170),o=i(45378),h=i(5785),l=i(48766),d=i(63468),u=i(83460);let c=s.Pq.Up(),_=s.Pq.Zero(),p=new s.Pq,f=new s.Pq,g=new s.uq;class m extends n.o{_validateFilter(e){return e===n.o.FILTER_NONE||e===n.o.FILTER_PCF||e===n.o.FILTER_PCSS?e:(l.V.Error('Unsupported filter "'+e+'"!'),n.o.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,m.MIN_CASCADES_COUNT),m.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){let e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){let i=e[t];if(!i)continue;let s=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(s.minimumWorld),this._scbiMax.maximizeInPlace(s.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){(this._minDistance!==e||this._maxDistance!==t)&&(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return m.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){let t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){let t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){let t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new h.k(t),this._depthReducer.onAfterReductionPerformed.add(e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),(t!=this._minDistance||i!=this._maxDistance)&&this.setMinMaxDistance(t,i)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){let e=this._getCamera();if(!e)return;let t=e.minZ,i=e.maxZ||this._shadowMaxZ,s=i-t,r=this._minDistance,a=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,n=t+r*s,o=t+a*s,h=o-n,l=o/n;for(let e=0;e<this._cascades.length;++e){let i=(e+1)/this._numCascades,a=n*l**i,o=n+h*i,d=this._lambda*(a-o)+o;this._cascades[e].prevBreakDistance=0===e?r:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(d-t)/s,this._viewSpaceFrustumsZ[e]=d,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){let e=this._scene;if(!this._getCamera())return;s.Pq.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(s.Pq.Dot(this._lightDirection,s.Pq.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);let t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],p),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),s.uq.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],c,this._viewMatrices[i]);let r=0,a=p.z,o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[i]);let h=o.boundingBox.minimumWorld.z,l=o.boundingBox.maximumWorld.z;h>a||(this._depthClamp&&this.filter!==n.o.FILTER_PCSS?(a=Math.min(a,l),a=Math.max((r=Math.max(r,h))+1,a)):(r=Math.min(r,h),this.filter!==n.o.FILTER_PCSS&&(a=Math.min(a,l)))),s.uq.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?a:r,t?r:a,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=r,this._cascadeMaxExtents[i].z=a,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),s.Pq.TransformCoordinatesToRef(_,this._transformMatrices[i],p),p.scaleInPlace(this._mapSize/2),f.copyFromFloats(Math.round(p.x),Math.round(p.y),Math.round(p.z)),f.subtractInPlace(p).scaleInPlace(2/this._mapSize),s.uq.TranslationToRef(f.x,f.y,0,g),this._projectionMatrices[i].multiplyToRef(g,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){let t=this._getCamera();if(!t)return;let i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,a=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();let n=0===t.maxZ,o=t.maxZ;n&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));let h=s.uq.Invert(t.getTransformationMatrix());n&&(t.maxZ=o,t.getProjectionMatrix(!0));let l=4*!!this._scene.getEngine().useReverseDepthBuffer;for(let t=0;t<m._FrustumCornersNdcSpace.length;++t)p.copyFrom(m._FrustumCornersNdcSpace[(t+l)%m._FrustumCornersNdcSpace.length]),a&&-1===p.z&&(p.z=0),s.Pq.TransformCoordinatesToRef(p,h,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<m._FrustumCornersNdcSpace.length/2;++t)p.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),f.copyFrom(p).scaleInPlace(i),p.scaleInPlace(r),p.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(p),this._frustumCornersWorldSpace[e][t].addInPlace(f)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)t=Math.max(t,this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],p).length());t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{let t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,p),s.uq.LookAtLHToRef(t,p,c,g);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)s.Pq.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],g,p),this._cascadeMinExtents[e].minimizeInPlace(p),this._cascadeMaxExtents[e].maximizeInPlace(p)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){let e=d.q.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,s,r=!0){if(!m.IsSupported)return void l.V.Error("CascadedShadowMap is not supported by the current engine.");super(e,t,i,s,r),this.usePercentageCloserFiltering=!0}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??m.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new s.Pq(0,0,0),this._scbiMax=this._scbiMax??new s.Pq(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new o.j(new s.Pq(0,0,0),new s.Pq(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){let e=this._scene.getEngine();this._shadowMap?.dispose();let t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new r.$(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._tempTransformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=Array(this._numCascades),this._frustumLengths=Array(this._numCascades),this._lightSizeUVCorrection=Array(2*this._numCascades),this._depthCorrection=Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=s.uq.Zero(),this._projectionMatrices[e]=s.uq.Zero(),this._transformMatrices[e]=s.uq.Zero(),this._cascadeMinExtents[e]=new s.Pq,this._cascadeMaxExtents[e]=new s.Pq,this._frustumCenter[e]=new s.Pq,this._shadowCameraPos[e]=new s.Pq,this._frustumCornersWorldSpace[e]=Array(m._FrustumCornersNdcSpace.length);for(let t=0;t<m._FrustumCornersNdcSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new s.Pq}let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===n.o.FILTER_PCF&&e.setColorWrite(!1),u.k2.eyeAtCamera=!1,this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==n.o.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);let i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;let r=this._getCamera();r&&this._shadowMaxZ<=(r.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){let i=this._light,s=this._scene;if(!s.shadowsEnabled||!i.shadowEnabled)return;let r=this._getCamera();if(!r)return;let a=this.getShadowMap();if(!a)return;let o=a.getSize().width,h=this._transformMatricesAsArray,l=s.floatingOriginMode?(0,u.Si)(this._scene.floatingOriginOffset,this._viewMatrices,this._projectionMatrices,this._numCascades,this._tempTransformMatricesAsArray):h;if(t.setMatrices("lightMatrix"+e,l),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===n.o.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);else if(this._filter===n.o.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,a),t.setTexture("depthTexture"+e,a),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o,this._contactHardeningLightSizeUVRatio*o,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){let e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t){let i=n.o.Parse(e,t,(e,t,i)=>new m(e,t,void 0,i));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}m._FrustumCornersNdcSpace=[new s.Pq(-1,1,-1),new s.Pq(1,1,-1),new s.Pq(1,-1,-1),new s.Pq(-1,-1,-1),new s.Pq(-1,1,1),new s.Pq(1,1,1),new s.Pq(1,-1,1),new s.Pq(-1,-1,1)],m.CLASSNAME="CascadedShadowGenerator",m.DEFAULT_CASCADES_COUNT=4,m.MIN_CASCADES_COUNT=2,m.MAX_CASCADES_COUNT=4,m._SceneComponentInitialization=e=>{throw(0,a.n)("ShadowGeneratorSceneComponent")}},50170:function(e,t,i){i.d(t,{o:()=>E});var s=i(64244),r=i(98268),a=i(63329),n=i(2357),o=i(93540),h=i(42011),l=i(21636),d=i(49775),u=i(97183),c=i(884),_=i(59782),p=i(27477),f=i(19327),g=i(44223),m=i(53626),T=i(83460);class E{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===E.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===E.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===E.FILTER_PCF||e===E.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===E.FILTER_PCF||e===E.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===E.FILTER_POISSONSAMPLING}set usePoissonSampling(e){let t=this._validateFilter(E.FILTER_POISSONSAMPLING);(e||this.filter===E.FILTER_POISSONSAMPLING)&&(this.filter=e?t:E.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===E.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){let t=this._validateFilter(E.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===E.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:E.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===E.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){let t=this._validateFilter(E.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===E.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:E.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===E.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){let t=this._validateFilter(E.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===E.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:E.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===E.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){let t=this._validateFilter(E.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===E.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:E.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===E.FILTER_PCF}set usePercentageCloserFiltering(e){let t=this._validateFilter(E.FILTER_PCF);(e||this.filter===E.FILTER_PCF)&&(this.filter=e?t:E.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===E.FILTER_PCSS}set useContactHardeningShadow(e){let t=this._validateFilter(E.FILTER_PCSS);(e||this.filter===E.FILTER_PCSS)&&(this.filter=e?t:E.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return E.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(let t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;let i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(let t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,a,n=!1){this.onBeforeShadowMapRenderObservable=new u.cP,this.onAfterShadowMapRenderObservable=new u.cP,this.onBeforeShadowMapRenderMeshObservable=new u.cP,this.onAfterShadowMapRenderMeshObservable=new u.cP,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=E.FILTER_NONE,this._filteringQuality=E.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=s.Pq.Zero(),this._viewMatrix=s.uq.Zero(),this._projectionMatrix=s.uq.Zero(),this._transformMatrix=s.uq.Zero(),this._cachedPosition=new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new s.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=s.uq.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!a,this._initShaderSourceAsync(n);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),E._SceneComponentInitialization(this._scene);const h=this._scene.getEngine().getCaps();i?h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?this._textureType=2:h.textureFloatRender&&h.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){let e=this._scene.getEngine();this._shadowMap?.dispose(),e._features.supportDepthStencilTexture?(this._shadowMap=new h.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new h.$(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=o.g.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=o.g.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(o.g.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,s)=>this._renderForShadowMap(e,t,i,s),this._shadowMap.customIsReadyFunction=(e,t,i)=>{if(!i||!e.subMeshes)return!0;let s=!0;for(let t of e.subMeshes){let e=t.getRenderingMesh(),i=this._scene.getEngine(),r=t.getMaterial();if(!r||0===t.verticesCount||this.customAllowRendering&&!this.customAllowRendering(t))continue;let a=e._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(a.mustReturn)continue;let n=i.getCaps().instancedArrays&&(null!==a.visibleInstances[t._id]&&void 0!==a.visibleInstances[t._id]||e.hasThinInstances),o=r.needAlphaBlendingForMesh(e);s=this.isReady(t,n,o)&&s}return s};let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===E.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),T.k2.eyeAtCamera=!1,this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),T.k2.eyeAtCamera=!0,this._scene.updateTransformMatrix(),this._filter===E.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap)return void e._debugPopGroup?.(1);let t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0)),e._debugPopGroup?.(1)});let t=new r.ov(0,0,0,0),i=new r.ov(1,1,1,1);this._shadowMap.onClearObservable.add(e=>{this._filter===E.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let e=p.m.MIN_RENDERINGGROUPS;e<p.m.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||E.ForceGLSL?await Promise.all([i.e("1816").then(i.bind(i,35659)),i.e("1409").then(i.bind(i,67336)),i.e("9950").then(i.bind(i,26909)),i.e("902").then(i.bind(i,93733))]):(this._shaderLanguage=1,await Promise.all([i.e("5364").then(i.bind(i,39055)),Promise.all([i.e("1476"),i.e("4714")]).then(i.bind(i,65521)),i.e("4545").then(i.bind(i,54248)),i.e("2429").then(i.bind(i,8988))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){let e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new h.$(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=o.g.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=o.g.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(o.g.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new d.j(this._light.name+"KernelBlurX",new s.I9(1,0),this.blurKernel,1,null,o.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new d.j(this._light.name+"KernelBlurY",new s.I9(0,1),this.blurKernel,1,null,o.g.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new l.w(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,o.g.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){let i=e.getRenderingMesh(),r=e.getEffectiveMesh(),a=this._scene,o=a.getEngine(),h=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!h||0===e.verticesCount||e._renderId===a.getRenderId())return;let l=a.useRightHandedSystem,d=0>r._getWorldMatrixDeterminant(),u=h._getEffectiveOrientation(i);(d&&!l||!d&&l)&&(u=+(0===u));let c=0===u;o.setState(h.backFaceCulling,void 0,void 0,c,h.cullBackFaces);let _=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(_.mustReturn)return;let p=o.getCaps().instancedArrays&&(null!==_.visibleInstances[e._id]&&void 0!==_.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e))if(this.isReady(e,p,t)){e._renderId=a.getRenderId();let l=h.shadowDepthWrapper,d=l?.getEffect(e,this,o.currentRenderPassId)??e._getDrawWrapper(),u=f.E.GetEffect(d);o.enableEffect(d),p||i._bind(e,u,h.fillMode),this.getTransformMatrix(),u.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===n.v.LIGHTTYPEID_DIRECTIONALLIGHT?u.setVector3("lightDataSM",this._cachedDirection):u.setVector3("lightDataSM",this._cachedPosition.subtractToRef(this._scene.floatingOriginOffset,s.AA.Vector3["0"]));let c=this._getCamera();if(u.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(c),this.getLight().getDepthMinZ(c)+this.getLight().getDepthMaxZ(c)),t&&this.enableSoftTransparentShadow&&u.setFloat2("softTransparentShadowSM",r.visibility*h.alpha,+!!this._opacityTexture?.getAlphaFromRGB),l)e._setMainDrawWrapperOverride(d),l.standalone?l.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):h.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(u.setTexture("diffuseSampler",this._opacityTexture),u.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){let e=i.skeleton;if(e.isUsingTextureForMatrices){let t=e.getTransformMatrixTexture(i);if(!t)return;u.setTexture("boneSampler",t),u.setFloat("boneTextureWidth",4*(e.bones.length+1))}else u.setMatrices("mBones",e.getTransformMatrices(i))}(0,m.nR)(i,u),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(u);let t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(u,p),(0,g.ij)(u,h,a)}this._useUBO||l||this._bindCustomEffectForRenderSubMeshForShadowMap(e,u,r),(0,m._8)(u,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();let T=r.getWorldMatrix();p&&(r.getMeshUniformBuffer().bindToEffect(u,"Mesh"),r.transferToEffect(T)),this.forceBackFacesOnly&&o.setState(!0,0,!1,!0,h.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(u),i._processRendering(r,e,u,h.fillMode,_,p,(e,t)=>{r===i||e?(r.getMeshUniformBuffer().bindToEffect(u,"Mesh"),r.transferToEffect(e?t:T)):(i.getMeshUniformBuffer().bindToEffect(u,"Mesh"),i.transferToEffect(t))}),this.forceBackFacesOnly&&o.setState(!0,0,!1,!1,h.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(u),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===E.FILTER_NONE||this.filter===E.FILTER_PCSS?this._shadowMap.updateSamplingMode(o.g.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(o.g.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){let i={useInstances:!1,...t},s=this.getShadowMap();if(!s){e&&e(this);return}let r=s.renderList;if(!r){e&&e(this);return}let a=[];for(let e of r)a.push(...e.subMeshes);if(0===a.length){e&&e(this);return}let n=0,o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(a[n],i.useInstances,a[n].getMaterial()?.needAlphaBlendingForMesh(a[n].getMesh())??!1);)if(++n>=a.length){e&&e(this);return}setTimeout(o,16)}};o()}async forceCompilationAsync(e){return await new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));let r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(a.R.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===n.v.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;let s=e.getMaterial(),r=s?.shadowDepthWrapper;if(this._opacityTexture=null,!s)return!1;let n=[];if(this._prepareShadowDefines(e,t,n,i),r){if(!r.isReadyForSubMesh(e,n,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{let i=e._getDrawWrapper(void 0,!0),r=i.effect,o=i.defines,h=[a.R.PositionKind],l=e.getMesh(),d=!1,u=!1,c=!1;this.normalBias&&l.isVerticesDataPresent(a.R.NormalKind)&&(h.push(a.R.NormalKind),n.push("#define NORMAL"),d=!0,l.nonUniformScaling&&n.push("#define NONUNIFORMSCALING"));let p=s.needAlphaTestingForMesh(l);if((p||s.needAlphaBlendingForMesh(l))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=s.opacityTexture:this._opacityTexture=s.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;let e=s.alphaCutOff??E.DEFAULT_ALPHA_CUTOFF;n.push("#define ALPHATEXTURE"),p&&n.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),l.isVerticesDataPresent(a.R.UVKind)&&(h.push(a.R.UVKind),n.push("#define UV1"),u=!0),l.isVerticesDataPresent(a.R.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(h.push(a.R.UV2Kind),n.push("#define UV2"),c=!0)}let f=new _.J;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){h.push(a.R.MatricesIndicesKind),h.push(a.R.MatricesWeightsKind),l.numBoneInfluencers>4&&(h.push(a.R.MatricesIndicesExtraKind),h.push(a.R.MatricesWeightsExtraKind));let e=l.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,l),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");let T=l.morphTargetManager?(0,m.Dk)(l.morphTargetManager,n,h,l,!0,d,!1,u,c,!1):0;if((0,g.r4)(s,this._scene,n),t&&(n.push("#define INSTANCES"),(0,m.te)(h),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(let e of this.customShaderOptions.defines)-1===n.indexOf(e)&&n.push(e);let b=l.bakedVertexAnimationManager;b&&b.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&h.push("bakedVertexAnimationSettingsInstanced"));let M=n.join("\n");if(o!==M){o=M;let e="shadowMap",t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],s=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];if((0,g.Ll)(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(let e of this.customShaderOptions.attributes)-1===h.indexOf(e)&&h.push(e);if(this.customShaderOptions.uniforms)for(let e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(let e of this.customShaderOptions.samplers)-1===s.indexOf(e)&&s.push(e)}let a=this._scene.getEngine();r=a.createEffect(e,{attributes:h,uniformsNames:t,uniformBuffersNames:["Scene","Mesh"],samplers:s,defines:M,fallbacks:f,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:T},shaderLanguage:this._shaderLanguage},a),i.setEffect(r,o)}if(!r.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),(!this._kernelBlurXPostprocess||!!this._kernelBlurXPostprocess.isReady())&&(!this._kernelBlurYPostprocess||!!this._kernelBlurYPostprocess.isReady())&&(!this._boxBlurPostprocess||!!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){let i=this._scene,s=this._light;i.shadowsEnabled&&s.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===E.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===E.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===E.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===E.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){let i=this._light,r=this._scene;if(!r.shadowsEnabled||!i.shadowEnabled)return;let a=this._getCamera(),n=this.getShadowMap();if(!n)return;if(!i.needCube()){let i=r.floatingOriginOffset,a=this.getTransformMatrix(),n=r.floatingOriginMode?(0,T.Lz)(i,this._viewMatrix,this._projectionMatrix,s.AA.Matrix["0"]):a;t.setMatrix("lightMatrix"+e,n)}let o=this.getShadowMapForRendering();this._filter===E.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===E.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,o),t.setTexture("depthTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(a),this.getLight().getDepthMinZ(a)+this.getLight().getDepthMaxZ(a),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){let e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),s.Pq.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(s.Pq.Dot(this._lightDirection,s.Pq.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),s.uq.LookAtLHToRef(t,t.add(this._lightDirection),s.Pq.Up(),this._viewMatrix);let e=this.getShadowMap();if(e){let t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){let e=this._shadowMap;if(!e)return;let t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t)for(let e of(this._shadowMap.renderList||(this._shadowMap.renderList=[]),t))this._shadowMap.renderList.push(e);else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(let e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){let e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){let[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){let e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t,i){let s=t.getLightById(e.lightId),r=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,a=i?i(e.mapSize,s,r):new E(e.mapSize,s,void 0,r),n=a.getShadowMap();if(e.renderList.length&&n){let i=new Set(e.renderList),s=n.renderList;for(let e of(s||(s=n.renderList=[]),t.meshes))i.has(e.id)&&s.push(e)}return void 0!==e.id&&(a.id=e.id),a.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&a.setDarkness(e.darkness),e.transparencyShadow&&a.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(a.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(a.bias=e.bias),void 0!==e.normalBias&&(a.normalBias=e.normalBias),e.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?a.useContactHardeningShadow=!0:e.usePoissonSampling?a.usePoissonSampling=!0:e.useExponentialShadowMap?a.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?a.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(a.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(a.filteringQuality=e.filteringQuality),e.depthScale&&(a.depthScale=e.depthScale),e.blurScale&&(a.blurScale=e.blurScale),e.blurBoxOffset&&(a.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(a.useKernelBlur=e.useKernelBlur),e.blurKernel&&(a.blurKernel=e.blurKernel),a}}E.CLASSNAME="ShadowGenerator",E.ForceGLSL=!1,E.FILTER_NONE=0,E.FILTER_EXPONENTIALSHADOWMAP=1,E.FILTER_POISSONSAMPLING=2,E.FILTER_BLUREXPONENTIALSHADOWMAP=3,E.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,E.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,E.FILTER_PCF=6,E.FILTER_PCSS=7,E.QUALITY_HIGH=0,E.QUALITY_MEDIUM=1,E.QUALITY_LOW=2,E.DEFAULT_ALPHA_CUTOFF=.5,E._SceneComponentInitialization=e=>{throw(0,c.n)("ShadowGeneratorSceneComponent")}},64957:function(e,t,i){i.d(t,{Z:()=>d});var s=i(24423),r=i(49196),a=i(64244),n=i(34027),o=i(2357),h=i(55277),l=i(79793);n.b.AddNodeConstructor("Light_Type_1",(e,t)=>()=>new d(e,a.Pq.Zero(),t));class d extends h.p{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=5e-324,this._orthoTop=5e-324,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return o.v.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){let t=this.getScene().activeCamera;t&&a.uq.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){let s=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){let e=a.Pq.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let s=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<i.length;n++){let o=i[n];if(!o)continue;let h=o.getBoundingInfo().boundingBox;for(let i=0;i<h.vectorsWorld.length;i++)a.Pq.TransformCoordinatesToRef(h.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<s&&(s=e.z),e.z>r&&(r=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=s,this._shadowMaxZ=r)}let r=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,o=void 0!==this.shadowMinZ?this.shadowMinZ:s?.minZ||0,h=void 0!==this.shadowMaxZ?this.shadowMaxZ:s?.maxZ||1e4,l=this.getScene().getEngine().useReverseDepthBuffer;a.uq.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,l?h:o,l?o:h,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t):this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z):e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this}getDepthMinZ(e){let t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){let t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}(0,s.Cg)([(0,r.lK)()],d.prototype,"shadowFrustumSize",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"shadowOrthoScale",null),(0,s.Cg)([(0,r.lK)()],d.prototype,"autoUpdateExtends",void 0),(0,s.Cg)([(0,r.lK)()],d.prototype,"autoCalcShadowZBounds",void 0),(0,s.Cg)([(0,r.lK)("orthoLeft")],d.prototype,"_orthoLeft",void 0),(0,s.Cg)([(0,r.lK)("orthoRight")],d.prototype,"_orthoRight",void 0),(0,s.Cg)([(0,r.lK)("orthoTop")],d.prototype,"_orthoTop",void 0),(0,s.Cg)([(0,r.lK)("orthoBottom")],d.prototype,"_orthoBottom",void 0),(0,l.Y5)("BABYLON.DirectionalLight",d)},2357:function(e,t,i){i.d(t,{v:()=>c});var s=i(24423),r=i(49196),a=i(64244),n=i(98268),o=i(34027),h=i(33640),l=i(79793),d=i(96216),u=i(42462);class c extends o.b{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new n.v9(1,1,1),this.specular=new n.v9(1,1,1),this.falloffType=c.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=c.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=[],this._includedOnlyMeshesIds=[],this._currentViewDepth=0,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new h.D(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,r=!0){let a=e.toString(),o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;let e=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(e,n.IG.Color3["0"]),this._uniformBuffer.updateColor4("vLightDiffuse",n.IG.Color3["0"],this.range,a),s&&(this.specular.scaleToRef(e,n.IG.Color3["1"]),this._uniformBuffer.updateColor4("vLightSpecular",n.IG.Color3["1"],this.radius,a)),o=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&r){let e=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();e&&(e.bindShadowLight(a,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric","Clustered"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return null===this._shadowGenerators?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return a.Pq.Zero()}canAffectMesh(e){return!e||(!this.includedOnlyMeshes||!(this.includedOnlyMeshes.length>0)||-1!==this.includedOnlyMeshes.indexOf(e))&&(!this.excludedMeshes||!(this.excludedMeshes.length>0)||-1===this.excludedMeshes.indexOf(e))&&(0===this.includeOnlyWithLayerMask||(this.includeOnlyWithLayerMask&e.layerMask)!=0)&&(0===this.excludeWithLayerMask||!(this.excludeWithLayerMask&e.layerMask))}dispose(e,t=!1){if(this._shadowGenerators){let e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){let e=this._parentContainer.lights.indexOf(this);e>-1&&this._parentContainer.lights.splice(e,1),this._parentContainer=null}for(let e of this.getScene().meshes)e._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){let i=c.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;let s=u.p.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){let e=u.p.Serialize(this);if(e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0)for(let t of(e.excludedMeshesIds=[],this.excludedMeshes))e.excludedMeshesIds.push(t.id);if(this.includedOnlyMeshes.length>0)for(let t of(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes))e.includedOnlyMeshesIds.push(t.id);return u.p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){let s=o.b.Construct("Light_Type_"+e,t,i);return s||null}static Parse(e,t){let i=c.GetConstructorFromName(e.type,e.name,t);if(!i)return null;let s=u.p.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),void 0!==e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.parentInstanceIndex&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),void 0!==e.falloffType&&(s.falloffType=e.falloffType),void 0!==e.lightmapMode&&(s.lightmapMode=e.lightmapMode),e.animations){for(let t=0;t<e.animations.length;t++){let i=e.animations[t],r=(0,l.n9)("BABYLON.Animation");r&&s.animations.push(r.Parse(i))}o.b.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),void 0!==e.isEnabled&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){let t=e.push;e.push=(...i)=>{let s=t.apply(e,i);for(let e of i)e._resyncLightSource(this);return s};let i=e.splice;for(let t of(e.splice=(t,s)=>{let r=i.apply(e,[t,s]);for(let e of r)e._resyncLightSource(this);return r},e))t._resyncLightSource(this)}_hookArrayForIncludedOnly(e){let t=e.push;e.push=(...i)=>{let s=t.apply(e,i);return this._resyncMeshes(),s};let i=e.splice;e.splice=(t,s)=>{let r=i.apply(e,[t,s]);return this._resyncMeshes(),r},this._resyncMeshes()}_resyncMeshes(){for(let e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(let e of this.getScene().meshes)-1!==e.lightSources.indexOf(this)&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0,t=this.getTypeID(),i=this.intensityMode;switch(i===c.INTENSITYMODE_AUTOMATIC&&(i=t===c.LIGHTTYPEID_DIRECTIONALLIGHT?c.INTENSITYMODE_ILLUMINANCE:c.INTENSITYMODE_LUMINOUSINTENSITY),t){case c.LIGHTTYPEID_POINTLIGHT:case c.LIGHTTYPEID_SPOTLIGHT:switch(i){case c.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case c.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case c.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case c.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case c.INTENSITYMODE_ILLUMINANCE:e=1;break;case c.INTENSITYMODE_LUMINANCE:{let t=this.radius;e=2*Math.PI*(1-Math.cos(t=Math.max(t,.001)))}}break;case c.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e}_reorderLightsInScene(){let e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}_isReady(){return!0}}c.FALLOFF_DEFAULT=d.c.FALLOFF_DEFAULT,c.FALLOFF_PHYSICAL=d.c.FALLOFF_PHYSICAL,c.FALLOFF_GLTF=d.c.FALLOFF_GLTF,c.FALLOFF_STANDARD=d.c.FALLOFF_STANDARD,c.LIGHTMAP_DEFAULT=d.c.LIGHTMAP_DEFAULT,c.LIGHTMAP_SPECULAR=d.c.LIGHTMAP_SPECULAR,c.LIGHTMAP_SHADOWSONLY=d.c.LIGHTMAP_SHADOWSONLY,c.INTENSITYMODE_AUTOMATIC=d.c.INTENSITYMODE_AUTOMATIC,c.INTENSITYMODE_LUMINOUSPOWER=d.c.INTENSITYMODE_LUMINOUSPOWER,c.INTENSITYMODE_LUMINOUSINTENSITY=d.c.INTENSITYMODE_LUMINOUSINTENSITY,c.INTENSITYMODE_ILLUMINANCE=d.c.INTENSITYMODE_ILLUMINANCE,c.INTENSITYMODE_LUMINANCE=d.c.INTENSITYMODE_LUMINANCE,c.LIGHTTYPEID_POINTLIGHT=d.c.LIGHTTYPEID_POINTLIGHT,c.LIGHTTYPEID_DIRECTIONALLIGHT=d.c.LIGHTTYPEID_DIRECTIONALLIGHT,c.LIGHTTYPEID_SPOTLIGHT=d.c.LIGHTTYPEID_SPOTLIGHT,c.LIGHTTYPEID_HEMISPHERICLIGHT=d.c.LIGHTTYPEID_HEMISPHERICLIGHT,c.LIGHTTYPEID_RECT_AREALIGHT=d.c.LIGHTTYPEID_RECT_AREALIGHT,(0,s.Cg)([(0,r.jT)()],c.prototype,"diffuse",void 0),(0,s.Cg)([(0,r.jT)()],c.prototype,"specular",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"falloffType",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"intensity",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"range",null),(0,s.Cg)([(0,r.lK)()],c.prototype,"intensityMode",null),(0,s.Cg)([(0,r.lK)()],c.prototype,"radius",null),(0,s.Cg)([(0,r.lK)()],c.prototype,"_renderPriority",void 0),(0,s.Cg)([(0,r.$z)("_reorderLightsInScene")],c.prototype,"renderPriority",void 0),(0,s.Cg)([(0,r.lK)("shadowEnabled")],c.prototype,"_shadowEnabled",void 0),(0,s.Cg)([(0,r.lK)("excludeWithLayerMask")],c.prototype,"_excludeWithLayerMask",void 0),(0,s.Cg)([(0,r.lK)("includeOnlyWithLayerMask")],c.prototype,"_includeOnlyWithLayerMask",void 0),(0,s.Cg)([(0,r.lK)("lightmapMode")],c.prototype,"_lightmapMode",void 0)},55277:function(e,t,i){i.d(t,{p:()=>h});var s=i(24423),r=i(49196),a=i(64244),n=i(2357),o=i(77746);class h extends n.v{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=a.uq.Identity(),this._projectionMatrix=a.uq.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!!this.parent&&!!this.parent.getWorldMatrix&&(this.transformedPosition||(this.transformedPosition=a.Pq.Zero()),a.Pq.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=a.Pq.Zero()),a.Pq.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0)}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=a.Pq.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();let e=a.Pq.Cross(this.direction,o._0.Y),t=a.Pq.Cross(e,this.direction);return a.Pq.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=a.Pq.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?this._currentRenderId=this.getScene().getRenderId():(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=a.uq.Identity()),a.uq.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0),this._worldMatrix}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e?.minZ||0}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e?.maxZ||1e4}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){let t=a.AA.Vector3["0"],i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),a.Pq.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(a.Pq.Dot(t,a.Pq.Up()))&&(t.z=1e-13);let s=a.AA.Vector3["1"];return i.addToRef(t,s),a.uq.LookAtLHToRef(i,s,a.Pq.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}(0,s.Cg)([(0,r.P_)()],h.prototype,"position",null),(0,s.Cg)([(0,r.P_)()],h.prototype,"direction",null),(0,s.Cg)([(0,r.lK)()],h.prototype,"shadowMinZ",null),(0,s.Cg)([(0,r.lK)()],h.prototype,"shadowMaxZ",null)},4111:function(e,t,i){function s(e){return void 0!==e.width}function r(e){return s(e)?{width:e.width,height:e.height}:{width:e,height:e}}i.d(t,{e:()=>s,o:()=>r})},44223:function(e,t,i){function s(e){-1===e.indexOf("vClipPlane")&&e.push("vClipPlane"),-1===e.indexOf("vClipPlane2")&&e.push("vClipPlane2"),-1===e.indexOf("vClipPlane3")&&e.push("vClipPlane3"),-1===e.indexOf("vClipPlane4")&&e.push("vClipPlane4"),-1===e.indexOf("vClipPlane5")&&e.push("vClipPlane5"),-1===e.indexOf("vClipPlane6")&&e.push("vClipPlane6")}function r(e,t,i){let s=!!(e.clipPlane??t.clipPlane),r=!!(e.clipPlane2??t.clipPlane2),a=!!(e.clipPlane3??t.clipPlane3),n=!!(e.clipPlane4??t.clipPlane4),o=!!(e.clipPlane5??t.clipPlane5),h=!!(e.clipPlane6??t.clipPlane6);s&&i.push("#define CLIPPLANE"),r&&i.push("#define CLIPPLANE2"),a&&i.push("#define CLIPPLANE3"),n&&i.push("#define CLIPPLANE4"),o&&i.push("#define CLIPPLANE5"),h&&i.push("#define CLIPPLANE6")}function a(e,t,i){let s=!1,r=!!(e.clipPlane??t.clipPlane),a=!!(e.clipPlane2??t.clipPlane2),n=!!(e.clipPlane3??t.clipPlane3),o=!!(e.clipPlane4??t.clipPlane4),h=!!(e.clipPlane5??t.clipPlane5),l=!!(e.clipPlane6??t.clipPlane6);return i.CLIPPLANE!==r&&(i.CLIPPLANE=r,s=!0),i.CLIPPLANE2!==a&&(i.CLIPPLANE2=a,s=!0),i.CLIPPLANE3!==n&&(i.CLIPPLANE3=n,s=!0),i.CLIPPLANE4!==o&&(i.CLIPPLANE4=o,s=!0),i.CLIPPLANE5!==h&&(i.CLIPPLANE5=h,s=!0),i.CLIPPLANE6!==l&&(i.CLIPPLANE6=l,s=!0),s}function n(e,t,i){let s=t.clipPlane??i.clipPlane;o(e,"vClipPlane",s),o(e,"vClipPlane2",s=t.clipPlane2??i.clipPlane2),o(e,"vClipPlane3",s=t.clipPlane3??i.clipPlane3),o(e,"vClipPlane4",s=t.clipPlane4??i.clipPlane4),o(e,"vClipPlane5",s=t.clipPlane5??i.clipPlane5),o(e,"vClipPlane6",s=t.clipPlane6??i.clipPlane6)}function o(e,t,i){i&&e.setFloat4(t,i.normal.x,i.normal.y,i.normal.z,i.d)}i.d(t,{Ll:()=>s,e3:()=>a,ij:()=>n,r4:()=>r})},61421:function(e,t,i){i.d(t,{Q:()=>h});var s=i(24423),r=i(49196),a=i(98268),n=i(42462),o=i(18174);class h{constructor(){this._dirty=!0,this._tempColor=new a.ov(0,0,0,0),this._globalCurve=new a.ov(0,0,0,0),this._highlightsCurve=new a.ov(0,0,0,0),this._midtonesCurve=new a.ov(0,0,0,0),this._shadowsCurve=new a.ov(0,0,0,0),this._positiveCurve=new a.ov(0,0,0,0),this._negativeCurve=new a.ov(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,s,r){null!=e&&(e=h._Clamp(e,0,360),t=h._Clamp(t,-100,100),i=h._Clamp(i,-100,100),s=h._Clamp(s,-100,100),t=.5*h._ApplyColorGradingSliderNonlinear(t),s=h._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),h._FromHSBToRef(e,t,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){let t=Math.abs(e/=100);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100}static _FromHSBToRef(e,t,i,s){let r=h._Clamp(e,0,360),a=h._Clamp(t/100,0,1),n=h._Clamp(i/100,0,1);if(0===a)s.r=n,s.g=n,s.b=n;else{let e=Math.floor(r/=60),t=r-e,i=n*(1-a),o=n*(1-a*t),h=n*(1-a*(1-t));switch(e){case 0:s.r=n,s.g=h,s.b=i;break;case 1:s.r=o,s.g=n,s.b=i;break;case 2:s.r=i,s.g=n,s.b=h;break;case 3:s.r=i,s.g=o,s.b=n;break;case 4:s.r=h,s.g=i,s.b=n;break;default:s.r=n,s.g=i,s.b=o}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return n.p.Clone(()=>new h,this)}serialize(){return n.p.Serialize(this)}static Parse(e){return n.p.Parse(()=>new h,e,null,null)}}h.PrepareUniforms=o.B,(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalHue",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalDensity",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalSaturation",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_globalExposure",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsHue",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsDensity",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsSaturation",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_highlightsExposure",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesHue",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesDensity",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesSaturation",void 0),(0,s.Cg)([(0,r.lK)()],h.prototype,"_midtonesExposure",void 0),n.p._ColorCurvesParser=h.Parse},59782:function(e,t,i){i.d(t,{J:()=>s});class s{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=[]),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;let i=this._mesh.getScene();for(let e=0;e<i.meshes.length;e++){let s=i.meshes[e];if(!s.material){!this._mesh.material&&s.computeBonesUsingShaders&&s.numBoneInfluencers>0&&(s.computeBonesUsingShaders=!1);continue}if(s.computeBonesUsingShaders&&0!==s.numBoneInfluencers){if(s.material.getEffect()===t)s.computeBonesUsingShaders=!1;else if(s.subMeshes){for(let e of s.subMeshes)if(e.effect===t){s.computeBonesUsingShaders=!1;break}}}}}else{let t=this._defines[this._currentRank];if(t)for(let i=0;i<t.length;i++)e=e.replace("#define "+t[i],"");this._currentRank++}return e}}},86880:function(e,t,i){i.d(t,{p:()=>c});var s=i(24423),r=i(49196),a=i(97183),n=i(98268),o=i(61421),h=i(11280),l=i(42462),d=i(44019),u=i(79793);class c{constructor(){this.colorCurves=new o.Q,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=c.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new n.ov(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=c.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.outputTextureWidth=0,this.outputTextureHeight=0,this.onUpdateParameters=new a.cP}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===c._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,this._toneMappingEnabled)switch(this._toneMappingType){case c.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case c.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1}else e.TONEMAPPING=0;e.CONTRAST=1!==this.contrast,e.EXPOSURE=1!==this.exposure,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&o.Q.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){let i=1/(this.outputTextureWidth||e.getEngine().getRenderWidth()),s=1/(this.outputTextureHeight||e.getEngine().getRenderHeight());if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){let r=null!=t?t:s/i,a=Math.tan(.5*this.vignetteCameraFov),n=a*r,o=Math.sqrt(n*a);n=(0,h.zF)(n,o,this.vignetteStretch),a=(0,h.zF)(a,o,this.vignetteStretch),e.setFloat4("vignetteSettings1",n,a,-n*this.vignetteCenterX,-a*this.vignetteCenterY);let l=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,l)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);let t=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return l.p.Clone(()=>new c,this)}serialize(){return l.p.Serialize(this)}static Parse(e){let t=l.p.Parse(()=>new c,e,null,null);return void 0!==e.vignetteCentreX&&(t.vignetteCenterX=e.vignetteCentreX),void 0!==e.vignetteCentreY&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}c.TONEMAPPING_STANDARD=0,c.TONEMAPPING_ACES=1,c.TONEMAPPING_KHR_PBR_NEUTRAL=2,c.PrepareUniforms=d._,c.PrepareSamplers=d.C,c._VIGNETTEMODE_MULTIPLY=0,c._VIGNETTEMODE_OPAQUE=1,(0,s.Cg)([(0,r.wL)()],c.prototype,"colorCurves",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_colorCurvesEnabled",void 0),(0,s.Cg)([(0,r.uM)("colorGradingTexture")],c.prototype,"_colorGradingTexture",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_colorGradingEnabled",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_colorGradingWithGreenDepth",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_colorGradingBGR",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_exposure",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_toneMappingEnabled",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_toneMappingType",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_contrast",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"vignetteStretch",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"vignetteCenterX",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"vignetteCenterY",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"vignetteWeight",void 0),(0,s.Cg)([(0,r.qK)()],c.prototype,"vignetteColor",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"vignetteCameraFov",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_vignetteBlendMode",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_vignetteEnabled",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_ditheringEnabled",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_ditheringIntensity",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_skipFinalColorClamp",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_applyByPostProcess",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"_isEnabled",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"outputTextureWidth",void 0),(0,s.Cg)([(0,r.lK)()],c.prototype,"outputTextureHeight",void 0),l.p._ImageProcessingConfigurationParser=c.Parse,(0,u.Y5)("BABYLON.ImageProcessingConfiguration",c)},69766:function(e,t,i){i.d(t,{h:()=>r});var s=i(66799);class r{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get BaseWeightTextureEnabled(){return this._BaseWeightTextureEnabled}static set BaseWeightTextureEnabled(e){this._BaseWeightTextureEnabled!==e&&(this._BaseWeightTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get BaseDiffuseRoughnessTextureEnabled(){return this._BaseDiffuseRoughnessTextureEnabled}static set BaseDiffuseRoughnessTextureEnabled(e){this._BaseDiffuseRoughnessTextureEnabled!==e&&(this._BaseDiffuseRoughnessTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,s.$.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,s.$.MarkAllMaterialsAsDirty(1))}}r._DiffuseTextureEnabled=!0,r._BaseWeightTextureEnabled=!0,r._BaseDiffuseRoughnessTextureEnabled=!0,r._DetailTextureEnabled=!0,r._DecalMapEnabled=!0,r._AmbientTextureEnabled=!0,r._OpacityTextureEnabled=!0,r._ReflectionTextureEnabled=!0,r._EmissiveTextureEnabled=!0,r._SpecularTextureEnabled=!0,r._BumpTextureEnabled=!0,r._LightmapTextureEnabled=!0,r._RefractionTextureEnabled=!0,r._ColorGradingTextureEnabled=!0,r._FresnelEnabled=!0,r._ClearCoatTextureEnabled=!0,r._ClearCoatBumpTextureEnabled=!0,r._ClearCoatTintTextureEnabled=!0,r._SheenTextureEnabled=!0,r._AnisotropicTextureEnabled=!0,r._ThicknessTextureEnabled=!0,r._RefractionIntensityTextureEnabled=!0,r._TranslucencyIntensityTextureEnabled=!0,r._TranslucencyColorTextureEnabled=!0,r._IridescenceTextureEnabled=!0},53626:function(e,t,i){i.d(t,{B1:()=>X,Bb:()=>Z,DL:()=>l.D,Dk:()=>_,ER:()=>I,G$:()=>Y,GD:()=>q,IC:()=>B,IF:()=>f,J2:()=>C,Jz:()=>U,Kd:()=>P,L0:()=>v,MF:()=>p,N4:()=>W,Nc:()=>V,OR:()=>N,RL:()=>x,VO:()=>H,Wp:()=>b,X8:()=>E,Y7:()=>z,YT:()=>M,Yy:()=>c,_8:()=>T,az:()=>w,c4:()=>y,f$:()=>R,fm:()=>D,kz:()=>L,lo:()=>F,mA:()=>S,nR:()=>m,ni:()=>A,qB:()=>G,qL:()=>O,te:()=>g,wu:()=>k});var s=i(48766),r=i(63468),a=i(96216),n=i(44223),o=i(69766),h=i(93540),l=i(79632);let d={r:0,g:0,b:0},u={NUM_MORPH_INFLUENCERS:0,NORMAL:!1,TANGENT:!1,UV:!1,UV2:!1,COLOR:!1};function c(e,t,i,s=!1){i&&e.fogEnabled&&(!t||t.applyFog)&&0!==e.fogMode&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(d,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",d)):i.setColor3("vFogColor",e.fogColor))}function _(e,t,i,s,r,a,n,o,h,l){let d=e.numMaxInfluencers||e.numInfluencers;return d<=0?0:(t.push("#define MORPHTARGETS"),e.hasPositions&&t.push("#define MORPHTARGETTEXTURE_HASPOSITIONS"),e.hasNormals&&t.push("#define MORPHTARGETTEXTURE_HASNORMALS"),e.hasTangents&&t.push("#define MORPHTARGETTEXTURE_HASTANGENTS"),e.hasUVs&&t.push("#define MORPHTARGETTEXTURE_HASUVS"),e.hasUV2s&&t.push("#define MORPHTARGETTEXTURE_HASUV2S"),e.hasColors&&t.push("#define MORPHTARGETTEXTURE_HASCOLORS"),e.supportsPositions&&r&&t.push("#define MORPHTARGETS_POSITION"),e.supportsNormals&&a&&t.push("#define MORPHTARGETS_NORMAL"),e.supportsTangents&&n&&t.push("#define MORPHTARGETS_TANGENT"),e.supportsUVs&&o&&t.push("#define MORPHTARGETS_UV"),e.supportsUV2s&&h&&t.push("#define MORPHTARGETS_UV2"),e.supportsColors&&l&&t.push("#define MORPHTARGETS_COLOR"),t.push("#define NUM_MORPH_INFLUENCERS "+d),e.isUsingTextureForTargets&&t.push("#define MORPHTARGETS_TEXTURE"),u.NUM_MORPH_INFLUENCERS=d,u.NORMAL=a,u.TANGENT=n,u.UV=o,u.UV2=h,u.COLOR=l,f(i,s,u,r),d)}function p(e,t,i){u.NUM_MORPH_INFLUENCERS=i,u.NORMAL=!1,u.TANGENT=!1,u.UV=!1,u.UV2=!1,u.COLOR=!1,f(e,t,u,!0)}function f(e,t,i,a=!0){let n=i.NUM_MORPH_INFLUENCERS;if(n>0&&r.q.LastCreatedEngine){let o=r.q.LastCreatedEngine.getCaps().maxVertexAttribs,h=t.morphTargetManager;if(h?.isUsingTextureForTargets)return;let l=h&&h.supportsPositions&&a,d=h&&h.supportsNormals&&i.NORMAL,u=h&&h.supportsTangents&&i.TANGENT,c=h&&h.supportsUVs&&i.UV1,_=h&&h.supportsUV2s&&i.UV2,p=h&&h.supportsColors&&i.VERTEXCOLOR;for(let i=0;i<n;i++)l&&e.push("position"+i),d&&e.push("normal"+i),u&&e.push("tangent"+i),c&&e.push("uv_"+i),_&&e.push("uv2_"+i),p&&e.push("color"+i),e.length>o&&s.V.Error("Cannot add more vertex attributes for mesh "+t.name)}}function g(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}function m(e,t){let i=e.morphTargetManager;e&&i&&t.setFloatArray("morphTargetInfluences",i.influences)}function T(e,t){t.bindToEffect(e,"Scene")}function E(e,t,i,s,r=null,a=!1,n=!1,h=!1,l=!1,d=!1,u=!1,c=0){if(e.texturesEnabled&&r&&o.h.ReflectionTextureEnabled){if(i.updateMatrix("reflectionMatrix",r.getReflectionTextureMatrix()),i.updateFloat2("vReflectionInfos",r.level*e.iblIntensity,c),h&&r.boundingBoxSize&&(i.updateVector3("vReflectionPosition",r.boundingBoxPosition),i.updateVector3("vReflectionSize",r.boundingBoxSize)),a){let e=r.getSize().width;i.updateFloat2("vReflectionFilteringInfo",e,Math.log2(e))}if(d&&!t.USEIRRADIANCEMAP){let e=r.sphericalPolynomial;if(t.USESPHERICALFROMREFLECTIONMAP&&e)if(t.SPHERICAL_HARMONICS){let t=e.preScaledHarmonics;i.updateVector3("vSphericalL00",t.l00),i.updateVector3("vSphericalL1_1",t.l1_1),i.updateVector3("vSphericalL10",t.l10),i.updateVector3("vSphericalL11",t.l11),i.updateVector3("vSphericalL2_2",t.l2_2),i.updateVector3("vSphericalL2_1",t.l2_1),i.updateVector3("vSphericalL20",t.l20),i.updateVector3("vSphericalL21",t.l21),i.updateVector3("vSphericalL22",t.l22)}else i.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),i.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),i.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),i.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),i.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),i.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),i.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),i.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),i.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}else l&&t.USEIRRADIANCEMAP&&t.USE_IRRADIANCE_DOMINANT_DIRECTION&&i.updateVector3("vReflectionDominantDirection",r.irradianceTexture._dominantDirection);n&&i.updateFloat3("vReflectionMicrosurfaceInfos",r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset)}u&&i.updateColor3("vReflectionColor",s)}function b(e,t,i,s=null,r=!1){if(s&&o.h.ReflectionTextureEnabled){t.LODBASEDMICROSFURACE?i.setTexture("reflectionSampler",s):(i.setTexture("reflectionSampler",s._lodTextureMid||s),i.setTexture("reflectionSamplerLow",s._lodTextureLow||s),i.setTexture("reflectionSamplerHigh",s._lodTextureHigh||s)),t.USEIRRADIANCEMAP&&i.setTexture("irradianceSampler",s.irradianceTexture);let a=e.iblCdfGenerator;r&&a&&i.setTexture("icdfSampler",a.getIcdfTexture())}}function M(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}function S(e,t,i){let s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}function C(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}function R(e,t,i){if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){let s=e.skeleton;if(s.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){let i=s.getTransformMatrixTexture(e);t.setTexture("boneSampler",i),t.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{let r=s.getTransformMatrices(e);r&&(t.setMatrices("mBones",r),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2))&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=r.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),i.previousBones[e.uniqueId].set(r))}}}function v(e,t,i){e.transferToEffect(t,i+"")}function P(e,t,i,s,r,a=!0){e._bindLight(t,i,s,r,a)}function x(e,t,i,s,r=4){let a=Math.min(t.lightSources.length,r);for(let r=0;r<a;r++)P(t.lightSources[r],r,e,i,"boolean"==typeof s?s:s.SPECULARTERM,t.receiveShadows)}function A(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push("matricesIndices"),e.push("matricesWeights"),i.NUM_BONE_INFLUENCERS>4&&(e.push("matricesIndicesExtra"),e.push("matricesWeightsExtra")))}function I(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&g(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push("instanceColor")}function y(e,t,i=4,s=0){let r=0;for(let a=0;a<i&&e["LIGHT"+a];a++)a>0&&(r=s+a,t.addFallback(r,"LIGHT"+a)),!e.SHADOWS&&(e["SHADOW"+a]&&t.addFallback(s,"SHADOW"+a),e["SHADOWPCF"+a]&&t.addFallback(s,"SHADOWPCF"+a),e["SHADOWPCSS"+a]&&t.addFallback(s,"SHADOWPCSS"+a),e["SHADOWPOISSON"+a]&&t.addFallback(s,"SHADOWPOISSON"+a),e["SHADOWESM"+a]&&t.addFallback(s,"SHADOWESM"+a),e["SHADOWCLOSEESM"+a]&&t.addFallback(s,"SHADOWCLOSEESM"+a));return r++}function O(e,t){return t.fogEnabled&&e.applyFog&&0!==t.fogMode}function D(e,t,i,s,r,a,n,o=!1,h=!1,l,d){if(n._areMiscDirty){n.LOGARITHMICDEPTH=i,n.POINTSIZE=s,n.FOG=r&&O(e,t),n.NONUNIFORMSCALING=e.nonUniformScaling,n.ALPHATEST=a,n.DECAL_AFTER_DETAIL=o,n.USE_VERTEX_PULLING=h;let u=l?.geometry?.getIndexBuffer();n.VERTEX_PULLING_USE_INDEX_BUFFER=!!u,n.VERTEX_PULLING_INDEX_BUFFER_32BITS=!!u&&u.is32Bits,n.VERTEXOUTPUT_INVARIANT=!!d}}function w(e,t,i,s,r=4,a=!1){if(!i._areLightsDirty)return i._needNormals;let n=0,o={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!a){for(let a of t.lightSources)if(F(e,t,a,n,i,s,o),++n===r)break}i.SPECULARTERM=o.specularEnabled,i.SHADOWS=o.shadowEnabled;let h=Math.max(r,i.MAXLIGHTCOUNT||0);for(let e=n;e<h;e++)void 0!==i["LIGHT"+e]&&(i["LIGHT"+e]=!1,i["HEMILIGHT"+e]=!1,i["POINTLIGHT"+e]=!1,i["DIRLIGHT"+e]=!1,i["SPOTLIGHT"+e]=!1,i["AREALIGHT"+e]=!1,i["CLUSTLIGHT"+e]=!1,i["SHADOW"+e]=!1,i["SHADOWCSM"+e]=!1,i["SHADOWCSMDEBUG"+e]=!1,i["SHADOWCSMNUM_CASCADES"+e]=!1,i["SHADOWCSMUSESHADOWMAXZ"+e]=!1,i["SHADOWCSMNOBLEND"+e]=!1,i["SHADOWCSM_RIGHTHANDED"+e]=!1,i["SHADOWPCF"+e]=!1,i["SHADOWPCSS"+e]=!1,i["SHADOWPOISSON"+e]=!1,i["SHADOWESM"+e]=!1,i["SHADOWCLOSEESM"+e]=!1,i["SHADOWCUBE"+e]=!1,i["SHADOWLOWQUALITY"+e]=!1,i["SHADOWMEDIUMQUALITY"+e]=!1);i.MAXLIGHTCOUNT=r;let l=e.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(o.needRebuild=!0),i.SHADOWFLOAT=o.shadowEnabled&&(l.textureFloatRender&&l.textureFloatLinearFiltering||l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&i.rebuild(),o.needNormals}function L(e,t,i,s=!1,r=8,a=!1){if(t&&o.h.ReflectionTextureEnabled){if(!t.isReadyOrNotBlocking())return!1;i._needNormals=!0,i.REFLECTION=!0,i.GAMMAREFLECTION=t.gammaSpace,i.RGBDREFLECTION=t.isRGBD,i.LODINREFLECTIONALPHA=t.lodLevelInAlpha,i.LINEARSPECULARREFLECTION=t.linearSpecularLOD,i.USEIRRADIANCEMAP=!1;let n=e.getEngine();switch(s&&r>0?(i.NUM_SAMPLES=""+r,n._features.needTypeSuffixInShaderConstants&&(i.NUM_SAMPLES=i.NUM_SAMPLES+"u"),i.REALTIME_FILTERING=!0,e.iblCdfGenerator&&(i.IBL_CDF_FILTERING=!0)):i.REALTIME_FILTERING=!1,i.INVERTCUBICMAP=t.coordinatesMode===h.g.INVCUBIC_MODE,i.REFLECTIONMAP_3D=t.isCube,i.REFLECTIONMAP_OPPOSITEZ=i.REFLECTIONMAP_3D&&e.useRightHandedSystem?!t.invertZ:t.invertZ,i.REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.coordinatesMode){case h.g.EXPLICIT_MODE:i.REFLECTIONMAP_EXPLICIT=!0;break;case h.g.PLANAR_MODE:i.REFLECTIONMAP_PLANAR=!0;break;case h.g.PROJECTION_MODE:i.REFLECTIONMAP_PROJECTION=!0;break;case h.g.SKYBOX_MODE:i.REFLECTIONMAP_SKYBOX=!0;break;case h.g.SPHERICAL_MODE:i.REFLECTIONMAP_SPHERICAL=!0;break;case h.g.EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case h.g.FIXED_EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case h.g.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case h.g.CUBIC_MODE:case h.g.INVCUBIC_MODE:default:i.REFLECTIONMAP_CUBIC=!0,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!!t.boundingBoxSize}t.coordinatesMode!==h.g.SKYBOX_MODE&&(t.irradianceTexture?(i.USEIRRADIANCEMAP=!0,i.USESPHERICALFROMREFLECTIONMAP=!1,i.USESPHERICALINVERTEX=!1,t.irradianceTexture._dominantDirection&&(i.USE_IRRADIANCE_DOMINANT_DIRECTION=!0)):t.isCube&&(i.USESPHERICALFROMREFLECTIONMAP=!0,i.USEIRRADIANCEMAP=!1,i.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,i.USESPHERICALINVERTEX=a))}else i.REFLECTION=!1,i.REFLECTIONMAP_3D=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_CUBIC=!1,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,i.INVERTCUBICMAP=!1,i.USESPHERICALFROMREFLECTIONMAP=!1,i.USEIRRADIANCEMAP=!1,i.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,i.USESPHERICALINVERTEX=!1,i.REFLECTIONMAP_OPPOSITEZ=!1,i.LODINREFLECTIONALPHA=!1,i.GAMMAREFLECTION=!1,i.RGBDREFLECTION=!1,i.LINEARSPECULARREFLECTION=!1;return!0}function F(e,t,i,s,r,n,o){switch(o.needNormals=!0,void 0===r["LIGHT"+s]&&(o.needRebuild=!0),r["LIGHT"+s]=!0,r["SPOTLIGHT"+s]=!1,r["HEMILIGHT"+s]=!1,r["POINTLIGHT"+s]=!1,r["DIRLIGHT"+s]=!1,r["AREALIGHT"+s]=!1,r["CLUSTLIGHT"+s]=!1,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=!1,r["LIGHT_FALLOFF_GLTF"+s]=!1,r["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case a.c.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=!0;break;case a.c.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case a.c.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=!0}if(n&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),r["SHADOW"+s]=!1,r["SHADOWCSM"+s]=!1,r["SHADOWCSMDEBUG"+s]=!1,r["SHADOWCSMNUM_CASCADES"+s]=!1,r["SHADOWCSMUSESHADOWMAXZ"+s]=!1,r["SHADOWCSMNOBLEND"+s]=!1,r["SHADOWCSM_RIGHTHANDED"+s]=!1,r["SHADOWPCF"+s]=!1,r["SHADOWPCSS"+s]=!1,r["SHADOWPOISSON"+s]=!1,r["SHADOWESM"+s]=!1,r["SHADOWCLOSEESM"+s]=!1,r["SHADOWCUBE"+s]=!1,r["SHADOWLOWQUALITY"+s]=!1,r["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){let t=i.getShadowGenerator(e.activeCamera)??i.getShadowGenerator();if(t){let e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(o.shadowEnabled=!0,t.prepareDefines(r,s))}}i.lightmapMode!=a.c.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+s]=!0,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==a.c.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=!1,r["LIGHTMAPNOSPECULAR"+s]=!1)}function N(e,t,i,s,r,a=null,o=!1){let h=z(e,s);!1!==a&&(h=(0,n.e3)(i,e,s)),!t.getColorWrite()!==s.DEPTHPREPASS&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,h=!0),s.INSTANCES!==r&&(s.INSTANCES=r,h=!0),s.THIN_INSTANCES!==o&&(s.THIN_INSTANCES=o,h=!0),h&&s.markAsUnprocessed()}function B(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;let i=void 0!==t.BONETEXTURE;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=!i&&void 0;let s=e.getScene().prePassRenderer;s&&s.enabled&&(t.BONES_VELOCITY_ENABLED=-1===s.excludedSkinnedMesh.indexOf(e))}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,void 0!==t.BONETEXTURE&&(t.BONETEXTURE=!1)}function U(e,t){let i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_UV2=i.supportsUV2s&&t.UV2,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS_POSITION=i.supportsPositions,t.MORPHTARGETS_COLOR=i.supportsColors,t.MORPHTARGETTEXTURE_HASUVS=i.hasUVs,t.MORPHTARGETTEXTURE_HASUV2S=i.hasUV2s,t.MORPHTARGETTEXTURE_HASTANGENTS=i.hasTangents,t.MORPHTARGETTEXTURE_HASNORMALS=i.hasNormals,t.MORPHTARGETTEXTURE_HASPOSITIONS=i.hasPositions,t.MORPHTARGETTEXTURE_HASCOLORS=i.hasColors,t.NUM_MORPH_INFLUENCERS=i.numMaxInfluencers||i.numInfluencers,t.MORPHTARGETS=t.NUM_MORPH_INFLUENCERS>0,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_UV2=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS_POSITION=!1,t.MORPHTARGETS_COLOR=!1,t.MORPHTARGETTEXTURE_HASUVS=!1,t.MORPHTARGETTEXTURE_HASUV2S=!1,t.MORPHTARGETTEXTURE_HASTANGENTS=!1,t.MORPHTARGETTEXTURE_HASNORMALS=!1,t.MORPHTARGETTEXTURE_HASPOSITIONS=!1,t.MORPHTARGETTEXTURE_HAS_COLORS=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}function k(e,t){let i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!i&&!!i.isEnabled}function G(e,t,i,s,r=!1,a=!0,n=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent("normal"),t._needNormals&&e.isVerticesDataPresent("tangent")&&(t.TANGENT=!0);for(let i=1;i<=6;++i)t["UV"+i]=!!t._needUVs&&e.isVerticesDataPresent(`uv${1===i?"":i}`);if(i){let i=e.useVertexColors&&e.isVerticesDataPresent("color");t.VERTEXCOLOR=i,t.VERTEXALPHA=e.hasVertexAlpha&&i&&a}return e.isVerticesDataPresent("instanceColor")&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&B(e,t),r&&U(e,t),n&&k(e,t),!0}function H(e,t){if(e.activeCamera){let i=t.MULTIVIEW;t.MULTIVIEW=null!==e.activeCamera.outputRenderTarget&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}function V(e,t,i){let s=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(s!==t.ORDER_INDEPENDENT_TRANSPARENCY||r!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}function W(e,t,i){let s=t.PREPASS;if(!t._arePrePassDirty)return;let r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:9,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:11,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:10,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:8,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace,t.PREPASS_COLOR=!0,t.PREPASS_COLOR_INDEX=0;for(let i=0;i<r.length;i++){let s=e.prePassRenderer.getIndex(r[i].type);-1!==s?(t[r[i].define]=!0,t[r[i].index]=s):t[r[i].define]=!1}}else{t.PREPASS=!1;for(let e=0;e<r.length;e++)t[r[e].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}function z(e,t){let i=!1;if(e.activeCamera){let s=+!!t.CAMERA_ORTHOGRAPHIC,r=+!!t.CAMERA_PERSPECTIVE,a=+(1===e.activeCamera.mode),n=+(0===e.activeCamera.mode);(s^a||r^n)&&(t.CAMERA_ORTHOGRAPHIC=1===a,t.CAMERA_PERSPECTIVE=1===n,i=!0)}return i}function q(e,t,i,s,r=null,a=!1,n=!1,o=!1){r&&r.push("Light"+e),!a&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightWidth"+e,"vLightHeight"+e,"vLightFalloff"+e,"vLightGround"+e,"vSliceData"+e,"vSliceRanges"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowTexture"+e),i.push("depthTexture"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightTexture"+e),t.push("textureProjectionMatrix"+e)),n&&i.push("iesLightTexture"+e),o&&(i.push("lightDataTexture"+e),i.push("tileMaskTexture"+e)))}function X(e,t,i){let s=["vReflectionMicrosurfaceInfos","vReflectionDominantDirection","reflectionMatrix","vReflectionInfos","vReflectionPosition","vReflectionSize","vReflectionColor","vReflectionFilteringInfo"];i&&s.push("vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22"),e.push(...s),t.push("reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","icdfSampler")}function Z(e,t,i,s=4){let r,a;e.uniformsNames?(r=e.uniformsNames,a=e.uniformBuffersNames,t=e.samplers,i=e.defines,s=e.maxSimultaneousLights||0):(r=e,t||(t=[]));for(let e=0;e<s&&i["LIGHT"+e];e++)q(e,r,t,i["PROJECTEDLIGHTTEXTURE"+e],a,!1,i["IESLIGHTTEXTURE"+e],i["CLUSTLIGHT"+e]);i.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}function Y(e,t=!1,i=!1,s=!1,r=!1,a=!1){e.addUniform("vReflectionInfos",2),e.addUniform("reflectionMatrix",16),t&&e.addUniform("vReflectionMicrosurfaceInfos",3),i&&(e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3)),s&&(e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionDominantDirection",3)),a&&e.addUniform("vReflectionColor",3),r&&(e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3))}},79632:function(e,t,i){i.d(t,{D:()=>r});var s=i(48766);function r(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){let e=i.activeCamera;1===e.mode&&s.V.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(e.maxZ+1)/Math.LN2))}}},33640:function(e,t,i){i.d(t,{D:()=>a});var s=i(48766),r=i(12299);class a{constructor(e,t,i=!1,s,r=!1,a){this._uniformNames=[],this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=s??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._trackUBOsInFrame=!1,(void 0===a&&this._engine._features.trackUbosInFrame||!0===a)&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0,this._trackUBOsInFrame=!0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}getUniformNames(){return this._uniformNames}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){let e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;let i=this._uniformLocationPointer-e;for(let e=0;e<i;e++)this._data.push(0)}}addUniform(e,t,i=0){let s;if((i>0&&"number"==typeof t&&(this._uniformArraySizes[e]={strideSize:t,arraySize:i}),void 0===this._uniformLocations[e])&&(this._uniformNames.push(e),!this._noUBO)){if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),16==t)t*=i;else{let e=4-t;t=t*i+e*i}s=[];for(let e=0;e<t;e++)s.push(0)}else{if(t instanceof Array)t=(s=t).length;else{s=[];for(let e=0;e<t;e++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(s[e]);this._needSync=!0}}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){this.addUniform(e,[t,i])}addFloat3(e,t,i,s){this.addUniform(e,[t,i,s])}addColor3(e,t){let i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){let s=[t.r,t.g,t.b,i];this.addUniform(e,s)}addVector3(e,t){let i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNamesDebug(){let e=[],t=0;for(let i in this._uniformLocations)if(e.push(i),10==++t)break;return e.join(",")}_rebuild(){!this._noUBO&&this._bufferData&&(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()),this._trackUBOsInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._trackUBOsInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}set name(e){this._name=e}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer)return void this.create();if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._trackUBOsInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(a._UpdatedUbosInFrame[this._name]||(a._UpdatedUbosInFrame[this._name]=0),a._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._trackUBOsInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=0!==this._bufferIndex,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(void 0===r){if(this._buffer)return void s.V.Error("Cannot add an uniform after UBO has been created. uniformName="+e);this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<i;e++)this._bufferData[r+e]=t[e];else{let e=!1;for(let s=0;s<i;s++)(16!==i||this._engine._features.uniformBufferHardCheckMatrix)&&this._bufferData[r+s]===Math.fround(t[s])||(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+s]=t[s]);this._needSync=this._needSync||e}}updateUniformArray(e,t,i){this._checkNewFrame();let a=this._uniformLocations[e];if(void 0===a)return void s.V.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");this._buffer||this.create();let n=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<i;e++)this._bufferData[a+e]=t[e];else{let e=!1,s=0,o=0;for(let h=0;h<i;h++)if(this._bufferData[a+4*o+s]!==r.S0.FloatRound(t[h])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[a+4*o+s]=t[h]),++s===n.strideSize){for(;s<4;s++)this._bufferData[a+4*o+s]=0;s=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();let i=this._valueCache[e],s=t.updateFlag;return(void 0===i||i!==s)&&(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let e=0;e<3;e++)a._TempBuffer[4*e]=t[3*e],a._TempBuffer[4*e+1]=t[3*e+1],a._TempBuffer[4*e+2]=t[3*e+2],a._TempBuffer[4*e+3]=0;this.updateUniform(e,a._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let e=0;e<2;e++)a._TempBuffer[4*e]=t[2*e],a._TempBuffer[4*e+1]=t[2*e+1],a._TempBuffer[4*e+2]=0,a._TempBuffer[4*e+3]=0;this.updateUniform(e,a._TempBuffer,8)}_updateFloatForEffect(e,t,i=""){this._currentEffect.setFloat(e+i,t)}_updateFloatForUniform(e,t){a._TempBuffer[0]=t,this.updateUniform(e,a._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){a._TempBuffer[0]=t,a._TempBuffer[1]=i,this.updateUniform(e,a._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,r=""){this._currentEffect.setFloat3(e+r,t,i,s)}_updateFloat3ForUniform(e,t,i,s){a._TempBuffer[0]=t,a._TempBuffer[1]=i,a._TempBuffer[2]=s,this.updateUniform(e,a._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,r,a=""){this._currentEffect.setFloat4(e+a,t,i,s,r)}_updateFloat4ForUniform(e,t,i,s,r){a._TempBuffer[0]=t,a._TempBuffer[1]=i,a._TempBuffer[2]=s,a._TempBuffer[3]=r,this.updateUniform(e,a._TempBuffer,4)}_updateFloatArrayForEffect(e,t,i=""){switch(this._uniformArraySizes[e]?.strideSize){case 2:this._currentEffect.setFloatArray2(e+i,t);break;case 3:this._currentEffect.setFloatArray3(e+i,t);break;case 4:this._currentEffect.setFloatArray4(e+i,t);break;default:this._currentEffect.setFloatArray(e+i,t)}}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){a._TempBufferInt32View.set(t),this.updateUniformArray(e,a._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){a._TempBufferUInt32View.set(t),this.updateUniformArray(e,a._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){a._TempBuffer[0]=t.x,a._TempBuffer[1]=t.y,a._TempBuffer[2]=t.z,this.updateUniform(e,a._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){a._TempBuffer[0]=t.x,a._TempBuffer[1]=t.y,a._TempBuffer[2]=t.z,a._TempBuffer[3]=t.w,this.updateUniform(e,a._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){a._TempBuffer[0]=t.r,a._TempBuffer[1]=t.g,a._TempBuffer[2]=t.b,this.updateUniform(e,a._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){a._TempBuffer[0]=t.r,a._TempBuffer[1]=t.g,a._TempBuffer[2]=t.b,a._TempBuffer[3]=i,this.updateUniform(e,a._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){a._TempBuffer[0]=t.r,a._TempBuffer[1]=t.g,a._TempBuffer[2]=t.b,a._TempBuffer[3]=t.a,this.updateUniform(e,a._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){a._TempBufferInt32View[0]=t,this.updateUniform(e,a._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){a._TempBufferInt32View[0]=t,a._TempBufferInt32View[1]=i,this.updateUniform(e,a._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setInt3(e+r,t,i,s)}_updateInt3ForUniform(e,t,i,s){a._TempBufferInt32View[0]=t,a._TempBufferInt32View[1]=i,a._TempBufferInt32View[2]=s,this.updateUniform(e,a._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,r,a=""){this._currentEffect.setInt4(e+a,t,i,s,r)}_updateInt4ForUniform(e,t,i,s,r){a._TempBufferInt32View[0]=t,a._TempBufferInt32View[1]=i,a._TempBufferInt32View[2]=s,a._TempBufferInt32View[3]=r,this.updateUniform(e,a._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){a._TempBufferUInt32View[0]=t,this.updateUniform(e,a._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i)}_updateUInt2ForUniform(e,t,i){a._TempBufferUInt32View[0]=t,a._TempBufferUInt32View[1]=i,this.updateUniform(e,a._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setUInt3(e+r,t,i,s)}_updateUInt3ForUniform(e,t,i,s){a._TempBufferUInt32View[0]=t,a._TempBufferUInt32View[1]=i,a._TempBufferUInt32View[2]=s,this.updateUniform(e,a._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,s,r,a=""){this._currentEffect.setUInt4(e+a,t,i,s,r)}_updateUInt4ForUniform(e,t,i,s,r){a._TempBufferUInt32View[0]=t,a._TempBufferUInt32View[1]=i,a._TempBufferUInt32View[2]=s,a._TempBufferUInt32View[3]=r,this.updateUniform(e,a._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,this._buffers.length>1&&this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,!0;return!1}has(e){return void 0!==this._uniformLocations[e]}dispose(){if(this._noUBO)return;let e=this._engine._uniformBuffers,t=e.indexOf(this);if(-1!==t&&(e[t]=e[e.length-1],e.pop()),this._trackUBOsInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){let t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}a._UpdatedUbosInFrame={},a._MAX_UNIFORM_SIZE=256,a._TempBuffer=new Float32Array(a._MAX_UNIFORM_SIZE),a._TempBufferInt32View=new Int32Array(a._TempBuffer.buffer),a._TempBufferUInt32View=new Uint32Array(a._TempBuffer.buffer)},5785:function(e,t,i){i.d(t,{k:()=>a});var s=i(2906),r=i(21394);class a extends r.R{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){let r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(r._depthRenderer||(r._depthRenderer={}),this._depthRendererId="minmax_"+this._camera.id,(e=this._depthRenderer=new s.d(r,t,this._camera,!1,1,!1,`DepthRenderer ${this._depthRendererId}`)).enabled=!1,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){super.dispose(e),this._depthRenderer&&e&&(this._depthRenderer.dispose(),this._depthRenderer=null)}}},17139:function(e,t,i){i.d(t,{Hx:()=>T,Pu:()=>M,RZ:()=>m,UA:()=>R,cU:()=>g,gW:()=>A,o5:()=>S,ow:()=>x,p$:()=>v,qY:()=>I,ux:()=>b});var s=i(12299),r=i(64244),a=i(39720),n=i(17494),o=i(17971),h=i(2415),l=i(28607),d=i(21636),u=i(48766),c=i(25701),_=i(14305);i(95963);let p="image/png",f=[134,22,135,150,246,214,150,54];function g(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),i=0;for(let e=0;e<f.length;e++)if(t.getUint8(i++)!==f[e])return u.V.Error("Not a babylon environment map"),null;let s="",r=0;for(;r=t.getUint8(i++);)s+=String.fromCharCode(r);let a=JSON.parse(s);return(a=m(a)).binaryDataPosition=i,a.specular&&(a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function m(e){if(e.version>2)throw Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:p}}async function T(e,t={}){let i,s=e.getInternalTexture();if(!s)return await Promise.reject("The cube texture is invalid.");let r=s.getEngine();if(2!==e.textureType&&1!==e.textureType&&0!==e.textureType&&0!==e.textureType&&7!==e.textureType&&-1!==e.textureType)return await Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let n=1;if(!r.getCaps().textureFloatRender&&(n=2,!r.getCaps().textureHalfFloatRender))return await Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");e.sphericalPolynomial;let o=e.getInternalTexture()?._sphericalPolynomialPromise,h=s.width,d=new l.Z(r),u={},c={};r.flushFramebuffer();let _=t.imageType??p,g=(0,a.ILog2)(s.width);for(let i=0;i<=g;i++){let s=Math.pow(2,g-i);for(let r=0;r<6;r++)u[6*i+r]=await E(d,e,n,r,i,s,_,t.imageQuality)}let m=t.disableIrradianceTexture?null:e.irradianceTexture;if(m){let e=m.getSize().width;for(let i=0;i<6;i++)c[i]=await E(d,m,n,i,0,e,_,t.imageQuality)}d.dispose(),o&&await o;let b={version:2,width:h,imageType:_,irradiance:null==(i=e.sphericalPolynomial)?null:{x:[i.x.x,i.x.y,i.x.z],y:[i.y.x,i.y.y,i.y.z],z:[i.z.x,i.z.y,i.z.z],xx:[i.xx.x,i.xx.y,i.xx.z],yy:[i.yy.x,i.yy.y,i.yy.z],zz:[i.zz.x,i.zz.y,i.zz.z],yz:[i.yz.x,i.yz.y,i.yz.z],zx:[i.zx.x,i.zx.y,i.zx.z],xy:[i.xy.x,i.xy.y,i.xy.z]},specular:{mipmaps:[],lodGenerationScale:e.lodGenerationScale}},M=0;for(let e=0;e<=g;e++)for(let t=0;t<6;t++){let i=u[6*e+t].byteLength;b.specular.mipmaps.push({length:i,position:M}),M+=i}if(m){b.irradiance=b.irradiance||{x:[0,0,0],xx:[0,0,0],y:[0,0,0],yy:[0,0,0],z:[0,0,0],zz:[0,0,0],yz:[0,0,0],zx:[0,0,0],xy:[0,0,0]},b.irradiance.irradianceTexture={size:m.getSize().width,faces:[],dominantDirection:m._dominantDirection?.asArray()};for(let e=0;e<6;e++){let t=c[e].byteLength;b.irradiance.irradianceTexture.faces.push({length:t,position:M}),M+=t}}let S=JSON.stringify(b),C=new ArrayBuffer(S.length+1),R=new Uint8Array(C);for(let e=0,t=S.length;e<t;e++)R[e]=S.charCodeAt(e);R[S.length]=0;let v=new ArrayBuffer(f.length+M+C.byteLength),P=new Uint8Array(v),x=new DataView(v),A=0;for(let e=0;e<f.length;e++)x.setUint8(A++,f[e]);P.set(new Uint8Array(C),A),A+=C.byteLength;for(let e=0;e<=g;e++)for(let t=0;t<6;t++){let i=u[6*e+t];P.set(new Uint8Array(i),A),A+=i.byteLength}if(m)for(let e=0;e<6;e++){let t=c[e];P.set(new Uint8Array(t),A),A+=t.byteLength}return v}async function E(e,t,i,s,r,a,n,o){let h=await t.readPixels(s,r,void 0,!1);if(h&&h.byteLength===h.length){let e=new Float32Array(4*h.byteLength);for(let t=0;t<h.byteLength;t++)e[t]=h[t]/255,e[t]=Math.pow(e[t],2.2);h=e}else if(h&&t.gammaSpace){let e=h;for(let t=0;t<e.length;t++)e[t]=Math.pow(e[t],2.2)}let l=e.getEngine(),d=l.createRawTexture(h,a,a,5,!1,!0,1,null,i);await c.G.EncodeTextureToRGBD(d,e,i);let u=await l._readTexturePixels(d,a,a),p=await (0,_.DumpDataAsync)(a,a,u,n,void 0,!1,!0,o);return d.dispose(),p}function b(e,t){let i=(t=m(t)).specular,s=Math.log2(t.width);if(s=Math.round(s)+1,i.mipmaps.length!==6*s)throw Error(`Unsupported specular mipmaps number "${i.mipmaps.length}"`);let r=Array(s);for(let a=0;a<s;a++){r[a]=Array(6);for(let s=0;s<6;s++){let n=i.mipmaps[6*a+s];r[a][s]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+n.position,n.length)}}return r}function M(e,t){t=m(t);let i=Array(6),s=t.irradiance?.irradianceTexture;if(s){if(6!==s.faces.length)throw Error(`Incorrect irradiance texture faces number "${s.faces.length}"`);for(let r=0;r<6;r++){let a=s.faces[r];i[r]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+a.position,a.length)}}return i}function S(e,t,i){let s=(i=m(i)).specular;if(!s)return Promise.resolve([]);e._lodGenerationScale=s.lodGenerationScale;let a=[],n=b(t,i);a.push(R(e,n,i.imageType));let o=i.irradiance?.irradianceTexture;if(o){let s=M(t,i),n=null;i.irradiance?.irradianceTexture?.dominantDirection&&(n=r.Pq.FromArray(i.irradiance.irradianceTexture.dominantDirection)),a.push(v(e,s,o.size,i.imageType,n))}return Promise.all(a)}async function C(e,t,i,s,r,a,n,o,h,l,d){return await new Promise((u,c)=>{if(i){let i=t.createTexture(null,!0,!0,null,1,null,e=>{c(e)},e);s?.onEffectCreatedObservable.addOnce(o=>{o.executeWhenCompiled(()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s._bindTexture("textureSampler",i),s.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([s],l,!0,a,n),t.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(r),u())})})}else{if(t._uploadImageToTexture(d,e,a,n),o){let i=h[n];i&&t._uploadImageToTexture(i._texture,e,a,0)}u()}})}async function R(e,t,i=p){let s=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,e),await P(e,t,!0,i),e.isReady=!0}async function v(e,t,i,s=p,r=null){let a=e.getEngine(),n=new o.h(a,5),l=new h.t(a,n);e._irradianceTexture=l,l._dominantDirection=r,n.isCube=!0,n.format=5,n.type=0,n.generateMipMaps=!0,n._cachedAnisotropicFilteringLevel=null,n.generateMipMaps=!0,n.width=i,n.height=i,a.updateTextureSamplingMode(3,n),await P(n,[t],!1,s),a.generateMipMapsForCubemap(n),n.isReady=!0}async function P(e,t,r,n=p){if(!s.S0.IsExponentOfTwo(e.width))throw Error("Texture size must be a power of two");let l=(0,a.ILog2)(e.width)+1,u=e.getEngine(),c=!1,_=!1,f=null,g=null,m=null,T=u.getCaps();T.textureLOD?u._features.supportRenderAndCopyToLodForFloatTextures?T.textureHalfFloatRender&&T.textureHalfFloatLinearFiltering?(c=!0,e.type=2):T.textureFloatRender&&T.textureFloatLinearFiltering&&(c=!0,e.type=1):c=!1:(c=!1,_=r);let E=0;if(c)u.isWebGPU?(E=1,await i.e("5277").then(i.bind(i,39884))):await i.e("5226").then(i.bind(i,19105)),f=new d.w("rgbdDecode","rgbdDecode",null,null,1,null,3,u,!1,void 0,e.type,void 0,null,!1,void 0,E),e._isRGBD=!1,e.invertY=!1,g=u.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,_){m={};let t=e._lodGenerationScale,i=e._lodGenerationOffset;for(let s=0;s<3;s++){let r=(l-1)*t+i,a=Math.round(Math.min(Math.max(i+(r-i)*(1-s/2),0),r)),n=new o.h(u,2);n.isCube=!0,n.invertY=!0,n.generateMipMaps=!1,u.updateTextureSamplingMode(2,n);let d=new h.t(null);switch(d._isCube=!0,d._texture=n,m[a]=d,s){case 0:e._lodTextureLow=d;break;case 1:e._lodTextureMid=d;break;case 2:e._lodTextureHigh=d}}}let b=[];for(let i=0;i<t.length;i++)for(let s=0;s<6;s++){let r,a=new Blob([t[i][s]],{type:n}),o=URL.createObjectURL(a);if(u._features.forceBitmapOverHTMLImageElement)r=u.createImageBitmap(a,{premultiplyAlpha:"none"}).then(async t=>await C(t,u,c,f,o,s,i,_,m,g,e));else{let t=new Image;t.src=o,r=new Promise((r,a)=>{t.onload=()=>{C(t,u,c,f,o,s,i,_,m,g,e).then(()=>r()).catch(e=>{a(e)})},t.onerror=e=>{a(e)}})}b.push(r)}if(await Promise.all(b),t.length<l){let i,s=Math.pow(2,l-1-t.length),r=s*s*4;switch(e.type){case 0:i=new Uint8Array(r);break;case 2:i=new Uint16Array(r);break;case 1:i=new Float32Array(r)}for(let s=t.length;s<l;s++)for(let t=0;t<6;t++)u._uploadArrayBufferViewToTexture(g?.texture||e,i,t,s)}if(g){let t=e._irradianceTexture;e._irradianceTexture=null,u._releaseTexture(e),g._swapAndDie(e),e._irradianceTexture=t}f&&f.dispose(),_&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function x(e,t){let i=(t=m(t)).irradiance;if(!i)return;let s=new n.Q;r.Pq.FromArrayToRef(i.x,0,s.x),r.Pq.FromArrayToRef(i.y,0,s.y),r.Pq.FromArrayToRef(i.z,0,s.z),r.Pq.FromArrayToRef(i.xx,0,s.xx),r.Pq.FromArrayToRef(i.yy,0,s.yy),r.Pq.FromArrayToRef(i.zz,0,s.zz),r.Pq.FromArrayToRef(i.yz,0,s.yz),r.Pq.FromArrayToRef(i.zx,0,s.zx),r.Pq.FromArrayToRef(i.xy,0,s.xy),e._sphericalPolynomial=s}function A(e,t,i,s,r){let a=R(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),t).then(()=>e);return e.onRebuildCallback=e=>({proxy:a,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=s,e._lodGenerationOffset=r,e._sphericalPolynomial=i,R(e,t).then(()=>(e.isReady=!0,e))}let I={GetEnvInfo:g,CreateEnvTextureAsync:T,CreateRadianceImageDataArrayBufferViews:b,CreateIrradianceImageDataArrayBufferViews:M,UploadEnvLevelsAsync:S,UploadRadianceLevelsAsync:R,UploadIrradianceLevelsAsync:v,UploadEnvSpherical:x}},21394:function(e,t,i){i.d(t,{R:()=>n});var s=i(21636),r=i(57057),a=i(64739);i(1146),i(3965);class n{get onAfterReductionPerformed(){return this._thinMinMaxReducer.onAfterReductionPerformed}constructor(e){this._onAfterUnbindObserver=null,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new r.X(e.getScene()),this._thinMinMaxReducer=new a.Qh(e.getScene()),this._reductionSteps=[],this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e!==this._sourceTexture&&(this._thinMinMaxReducer.depthRedux=t,this.deactivate(),this._sourceTexture=e,this._forceFullscreenViewport=r,this._thinMinMaxReducer.setTextureDimensions(e.getRenderWidth(),e.getRenderHeight()))){this._disposePostProcesses();let e=this._thinMinMaxReducer.reductionSteps;for(let t=0;t<e.length;++t){let n=e[t],o=new s.w(n.name,a.jK.FragmentUrl,{effectWrapper:n,samplingMode:1,engine:this._camera.getScene().getEngine(),textureType:i,textureFormat:7,size:{width:n.textureWidth,height:n.textureHeight}});this._reductionSteps.push(o),o.autoClear=!1,o.forceFullscreenViewport=r,0===t&&(o.externalTextureSamplerBinding=!0,o.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._sourceTexture)})),t===e.length-1&&this._reductionSteps[t-1].onAfterRenderObservable.add(()=>{this._thinMinMaxReducer.readMinMax(o.inputTexture.texture)})}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{let e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport,0,0,!0,this._reductionSteps.length-1),e.unBindFramebuffer(this._reductionSteps[this._reductionSteps.length-1].inputTexture,!1),e._debugPopGroup?.(1)}),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){e&&(this.onAfterReductionPerformed.clear(),this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=void 0,this._disposePostProcesses(),this._postProcessManager.dispose(),this._postProcessManager=void 0,this._thinMinMaxReducer.dispose(),this._thinMinMaxReducer=void 0,this._sourceTexture=null)}_disposePostProcesses(){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps.length=0}}},25701:function(e,t,i){i.d(t,{G:()=>a});var s=i(21636),r=i(12188);class a{static ExpandRGBDTexture(e){let t=e._texture;if(!t||!e.isRGBD)return;let r=t.getEngine(),a=r.getCaps(),n=t.isReady,o=!1;a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?(o=!0,t.type=2):a.textureFloatRender&&a.textureFloatLinearFiltering&&(o=!0,t.type=1),o&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);let h=async()=>{let a=r.isWebGPU;t.isReady=!1,a?await i.e("5277").then(i.bind(i,39884)):await i.e("5226").then(i.bind(i,19105));let n=new s.w("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,t.type,void 0,null,!1,void 0,+!!a);n.externalTextureSamplerBinding=!0;let o=r.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});n.onEffectCreatedObservable.addOnce(i=>{i.executeWhenCompiled(()=>{n.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([n],o,!0),r.restoreDefaultFramebuffer(),r._releaseTexture(t),n&&n.dispose(),o._swapAndDie(t),t.isReady=!0})})};o&&(n?h():e.onLoadObservable.addOnce(h))}static async EncodeTextureToRGBD(e,t,s=0){return t.getEngine().isWebGPU?await i.e("5589").then(i.bind(i,75092)):await i.e("5534").then(i.bind(i,12013)),await (0,r.Qs)("rgbdEncode",e,t,s,1,5)}}},97163:function(e,t,i){i.d(t,{w:()=>s});class s{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((e,t)=>this.add(e,t))}get(e){let t=this._data[e];if(void 0!==t)return t}getOrAddWithFactory(e,t){let i=this.get(e);return void 0!==i||(i=t(e))&&this.add(e,i),i}getOrAdd(e,t){let i=this.get(e);return void 0!==i?i:(this.add(e,t),t)}contains(e){return void 0!==this._data[e]}add(e,t){return void 0===this._data[e]&&(this._data[e]=t,++this._count,!0)}set(e,t){return void 0!==this._data[e]&&(this._data[e]=t,!0)}getAndRemove(e){let t=this.get(e);return void 0!==t?(delete this._data[e],--this._count,t):null}remove(e){return!!this.contains(e)&&(delete this._data[e],--this._count,!0)}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(let t in this._data){let i=this._data[t];e(t,i)}}first(e){for(let t in this._data){let i=this._data[t],s=e(t,i);if(s)return s}return null}}},64739:function(e,t,i){i.d(t,{Qh:()=>c,jK:()=>h});var s,r,a=i(97183),n=i(29790),o=i(80089);(s=r||(r={}))[s.NormalizedViewDepth=0]="NormalizedViewDepth",s[s.ViewDepth=1]="ViewDepth",s[s.ScreenDepth=2]="ScreenDepth";class h extends n.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,3965)))):t.push(Promise.resolve().then(i.bind(i,1146)))}constructor(e,t=null,i="",s){super({...s,name:e,engine:t||o.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:h.FragmentUrl,uniforms:h.Uniforms,defines:i}),this.textureWidth=0,this.textureHeight=0}bind(e=!1){super.bind(e);let t=this.drawWrapper.effect;1===this.textureWidth||1===this.textureHeight?t.setInt2("texSize",this.textureWidth,this.textureHeight):t.setFloat2("texSize",this.textureWidth,this.textureHeight)}}h.FragmentUrl="minmaxRedux",h.Uniforms=["texSize"];let l=new Float32Array(4),d=new Uint8Array(4),u={min:0,max:0};class c{get depthRedux(){return this._depthRedux}set depthRedux(e){this._depthRedux!==e&&(this._depthRedux=e,this._recreatePostProcesses())}get textureWidth(){return this._textureWidth}get textureHeight(){return this._textureHeight}constructor(e,t=!0){this.onAfterReductionPerformed=new a.cP,this._textureWidth=0,this._textureHeight=0,this._scene=e,this._depthRedux=t,this.reductionSteps=[]}setTextureDimensions(e,t,i=0){return(e!==this._textureWidth||t!==this._textureHeight||i!==this._depthTextureType)&&(this._textureWidth=e,this._textureHeight=t,this._depthTextureType=i,this._recreatePostProcesses(),!0)}readMinMax(e){let t=e.type===o.N.TEXTURETYPE_FLOAT||e.type===o.N.TEXTURETYPE_HALF_FLOAT,i=t?l:d;this._scene.getEngine()._readTexturePixels(e,1,1,-1,0,i,!1),u.min=i[0],u.max=i[1],t||(u.min=u.min/255,u.max=u.max/255),u.min>=u.max&&(u.min=0,u.max=1),this.onAfterReductionPerformed.notifyObservers(u)}dispose(e=!0){e&&(this.onAfterReductionPerformed.clear(),this._textureWidth=0,this._textureHeight=0);for(let e=0;e<this.reductionSteps.length;++e)this.reductionSteps[e].dispose();this.reductionSteps.length=0}_recreatePostProcesses(){this.dispose(!1);let e=this._scene,t=this.textureWidth,i=this.textureHeight,s=new h("Initial reduction phase",e.getEngine(),"#define INITIAL"+(this._depthRedux?"\n#define DEPTH_REDUX":"")+(1===this._depthTextureType?"\n#define VIEW_DEPTH":""));s.textureWidth=t,s.textureHeight=i,this.reductionSteps.push(s);let r=1;for(;t>1||i>1;){t=Math.max(Math.round(t/2),1),i=Math.max(Math.round(i/2),1);let s=new h("Reduction phase "+r,e.getEngine(),"#define "+(1==t&&1==i?"LAST":1==t||1==i?"ONEBEFORELAST":"MAIN"));s.textureWidth=t,s.textureHeight=i,this.reductionSteps.push(s),r++}}}},847:function(e,t,i){i.d(t,{K:()=>s});class s{static get UniqueId(){let e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}s._UniqueIdCounter=1},49775:function(e,t,i){i.d(t,{j:()=>d});var s=i(24423),r=i(21636),a=i(93540),n=i(79793),o=i(49196),h=i(42462),l=i(27630);class d extends r.w{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,r=null,n=a.g.BILINEAR_SAMPLINGMODE,o,h,d=0,u="",c=!1,_=5){const p="number"==typeof s?c:!!s.blockCompilation,f={uniforms:l.q.Uniforms,samplers:l.q.Samplers,size:"number"==typeof s?s:void 0,camera:r,samplingMode:n,engine:o,reusable:h,textureType:d,vertexUrl:l.q.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:_,defines:u,...s,blockCompilation:!0};super(e,l.q.FragmentUrl,{effectWrapper:"number"!=typeof s&&s.effectWrapper?void 0:new l.q(e,o,void 0,void 0,f),...f}),this._effectWrapper.options.blockCompilation=p,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=i}updateEffect(e=null,t=null,i=null,s,r,a){this._effectWrapper._updateParameters(r,a)}static _Parse(e,t,i,s){return h.p.Parse(()=>new d(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,s)}}(0,s.Cg)([(0,o.WM)()],d.prototype,"direction",null),(0,s.Cg)([(0,o.lK)()],d.prototype,"kernel",null),(0,s.Cg)([(0,o.lK)()],d.prototype,"packedFloat",null),(0,n.Y5)("BABYLON.BlurPostProcess",d)},27630:function(e,t,i){i.d(t,{q:()=>a});var s=i(29790),r=i(80089);class a extends s.${_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([i.e("7223").then(i.bind(i,88794)),i.e("9765").then(i.bind(i,25540))]))):t.push(Promise.all([i.e("3823").then(i.bind(i,99266)),i.e("2185").then(i.bind(i,14960))]))}constructor(e,t=null,i,s,n){const o=!!n?.blockCompilation;super({...n,name:e,engine:t||r.N.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:a.FragmentUrl,uniforms:a.Uniforms,samplers:a.Samplers,vertexUrl:a.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this._staticDefines=n?Array.isArray(n.defines)?n.defines.join("\n"):n.defines||"":"",this.options.blockCompilation=o,void 0!==i&&(this.direction=i),void 0!==s&&(this.kernel=s)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){let i=this._kernel,s=(i-1)/2,r=[],a=[],n=0;for(let e=0;e<i;e++){let t=e/(i-1),o=this._gaussianWeight(2*t-1);r[e]=e-s,a[e]=o,n+=o}for(let e=0;e<a.length;e++)a[e]/=n;let o=[],h=[],l=[];for(let e=0;e<=s;e+=2){let t=Math.min(e+1,Math.floor(s));if(e===t)l.push({o:r[e],w:a[e]});else{let i=t===s,n=a[e]+a[t]*(i?.5:1),o=r[e]+1/(1+a[e]/a[t]);0===o?(l.push({o:r[e],w:a[e]}),l.push({o:r[e+1],w:a[e+1]})):(l.push({o:o,w:n}),l.push({o:-o,w:n}))}}for(let e=0;e<l.length;e++)h[e]=l[e].o,o[e]=l[e].w;r=h,a=o;let d=Math.max(this.options.engine.getCaps().maxVaryingVectors-(1===this.options.shaderLanguage),0)-1,u=Math.min(r.length,d),c="";c+=this._staticDefines,-1!=this._staticDefines.indexOf("DOF")&&(c+=`#define CENTER_WEIGHT ${this._glslFloat(a[u-1])}
`,u--);for(let e=0;e<u;e++)c+=`#define KERNEL_OFFSET${e} ${this._glslFloat(r[e])}
`,c+=`#define KERNEL_WEIGHT${e} ${this._glslFloat(a[e])}
`;let _=0;for(let e=d;e<r.length;e++)c+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(r[e])}
`,c+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(a[e])}
`,_++;this.packedFloat&&(c+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(c,null,null,{varyingCount:u,depCount:_},e,t)}_nearestBestKernel(e){let t=Math.round(e);for(let e of[t,t-1,t+1,t-2,t+2])if(e%2!=0&&Math.floor(e/2)%2==0&&e>0)return Math.max(e,3);return Math.max(t,3)}_gaussianWeight(e){return 1/(1/3*Math.sqrt(2*Math.PI))*Math.exp(-(e*e/(1/3*2*(1/3))))}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}}a.VertexUrl="kernelBlur",a.FragmentUrl="kernelBlur",a.Uniforms=["delta","direction"],a.Samplers=["circleOfConfusionSampler"]},2906:function(e,t,i){i.d(t,{d:()=>c});var s=i(98268),r=i(63329),a=i(93540),n=i(42011),o=i(17997);i(94569),i(67507);var h=i(884),l=i(44223),d=i(53626),u=i(59782);class c{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,h=a.g.TRILINEAR_SAMPLINGMODE,u=!1,_,p){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=u,this.isPacked=0===t,this.isPacked?this.clearColor=new s.ov(1,1,1,1):this.clearColor=new s.ov(+!u,0,0,1),this._initShaderSourceAsync(),c._SceneComponentInitialization(this._scene);const f=e.getEngine();this._camera=i,h!==a.g.NEAREST_SAMPLINGMODE&&(1!==t||f._caps.textureFloatLinearFiltering||(h=a.g.NEAREST_SAMPLINGMODE),2!==t||f._caps.textureHalfFloatLinearFiltering||(h=a.g.NEAREST_SAMPLINGMODE));const g=this.isPacked||!f._features.supportExtendedTextureFormats?5:6;this._depthMap=p??new n.$(_??"DepthRenderer",{width:f.getRenderWidth(),height:f.getRenderHeight()},this._scene,!1,!0,t,!1,h,void 0,void 0,void 0,g),this._depthMap.wrapU=a.g.CLAMP_ADDRESSMODE,this._depthMap.wrapV=a.g.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(e=>{e.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{f._debugPushGroup?.("depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{f._debugPopGroup?.(1)}),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){let i=e.subMeshes[t],s=i.getRenderingMesh(),r=s._getInstancesRenderList(i._id,!!i.getReplacementMesh()),a=f.getCaps().instancedArrays&&(null!==r.visibleInstances[i._id]&&void 0!==r.visibleInstances[i._id]||s.hasThinInstances);if(!this.isReady(i,a))return!1}return!0};const m=e=>{let t=e.getRenderingMesh(),i=e.getEffectiveMesh(),s=this._scene,r=s.getEngine(),a=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||i.infiniteDistance||a.disableDepthWrite||0===e.verticesCount||e._renderId===s.getRenderId())return;let n=0>i._getWorldMatrixDeterminant(),h=a._getEffectiveOrientation(t);n&&(h=+(0===h));let u=0===h;r.setState(a.backFaceCulling,0,!1,u,this.reverseCulling?!a.cullBackFaces:a.cullBackFaces);let c=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(c.mustReturn)return;let _=r.getCaps().instancedArrays&&(null!==c.visibleInstances[e._id]&&void 0!==c.visibleInstances[e._id]||t.hasThinInstances),p=this._camera||s.activeCamera;if(this.isReady(e,_)&&p){let n,h;e._renderId=s.getRenderId();let u=i._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId],f=e._getDrawWrapper();!f&&u&&(f=u._getDrawWrapper());let g=p.mode===o.i.ORTHOGRAPHIC_CAMERA;if(!f)return;let m=f.effect;if(r.enableEffect(f),_||t._bind(e,m,a.fillMode),u?u.bindForSubMesh(i.getWorldMatrix(),i,e):(m.setMatrix("viewProjection",s.getTransformMatrix()),m.setMatrix("world",i.getWorldMatrix()),this._storeCameraSpaceZ&&m.setMatrix("view",s.getViewMatrix())),g?(n=!r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1,h=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:1):(n=r.useReverseDepthBuffer&&r.isNDCHalfZRange?p.minZ:r.isNDCHalfZRange?0:p.minZ,h=r.useReverseDepthBuffer&&r.isNDCHalfZRange?0:p.maxZ),m.setFloat2("depthValues",n,n+h),!u){if(a.needAlphaTestingForMesh(i)){let e=a.getAlphaTestTexture();e&&(m.setTexture("diffuseSampler",e),m.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,d.f$)(t,m),(0,l.ij)(m,a,s),(0,d.nR)(t,m),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(m);let r=e.getMesh().bakedVertexAnimationManager;r&&r.isEnabled&&r.bind(m,_),a.pointsCloud&&m.setFloat("pointSize",a.pointSize)}t._processRendering(i,e,m,a.fillMode,c,_,(e,t)=>m.setMatrix("world",t))}};this._depthMap.customRenderFunction=(e,t,i,s)=>{let r;if(s.length)for(r=0;r<s.length;r++)m(s.data[r]);for(r=0;r<e.length;r++)m(e.data[r]);for(r=0;r<t.length;r++)m(t.data[r]);if(this.forceDepthWriteTransparentMeshes)for(r=0;r<i.length;r++)m(i.data[r]);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||c.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,67507)),Promise.resolve().then(i.bind(i,94569))]):(this._shaderLanguage=1,await Promise.all([i.e("7933").then(i.bind(i,42652)),i.e("107").then(i.bind(i,56406))])),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;let i=this._scene.getEngine(),s=e.getMesh(),a=s.getScene(),n=s._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(n)return n.isReadyForSubMesh(s,e,t);let o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;let h=[],c=[r.R.PositionKind],_=!1,p=!1;o.needAlphaTestingForMesh(s)&&o.getAlphaTestTexture()&&(h.push("#define ALPHATEST"),s.isVerticesDataPresent(r.R.UVKind)&&(c.push(r.R.UVKind),h.push("#define UV1"),_=!0),s.isVerticesDataPresent(r.R.UV2Kind)&&(c.push(r.R.UV2Kind),h.push("#define UV2"),p=!0));let f=new u.J;if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){c.push(r.R.MatricesIndicesKind),c.push(r.R.MatricesWeightsKind),s.numBoneInfluencers>4&&(c.push(r.R.MatricesIndicesExtraKind),c.push(r.R.MatricesWeightsExtraKind)),h.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),s.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,s);let e=s.skeleton;e.isUsingTextureForMatrices?h.push("#define BONETEXTURE"):h.push("#define BonesPerMesh "+(e.bones.length+1))}else h.push("#define NUM_BONE_INFLUENCERS 0");let g=s.morphTargetManager?(0,d.Dk)(s.morphTargetManager,h,c,s,!0,!1,!1,_,p,!1):0;o.pointsCloud&&h.push("#define POINTSIZE"),t&&(h.push("#define INSTANCES"),(0,d.te)(c),e.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES"));let m=s.bakedVertexAnimationManager;m&&m.isEnabled&&(h.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&c.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&h.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&h.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&h.push("#define PACKED"),(0,l.r4)(o,a,h);let T=e._getDrawWrapper(void 0,!0),E=T.defines,b=h.join("\n");if(E!==b){let e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"];(0,l.Ll)(e),T.setEffect(i.createEffect("depth",{attributes:c,uniformsNames:e,uniformBuffersNames:[],samplers:["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"],defines:b,fallbacks:f,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:g},shaderLanguage:this._shaderLanguage},i),b)}return T.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){let e=[];for(let t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0)for(let t of(this._depthMap.dispose(),e))delete this._scene._depthRenderer[t]}}c.ForceGLSL=!1,c._SceneComponentInitialization=e=>{throw(0,h.n)("DepthRendererSceneComponent")}},94569:function(e,t,i){i.r(t),i.d(t,{depthPixelShader:()=>n});var s=i(22081);i(30557),i(34533),i(46741);let r="depthPixelShader",a=`#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;s.l.ShadersStore[r]||(s.l.ShadersStore[r]=a);let n={name:r,shader:a}},34027:function(e,t,i){i.d(t,{b:()=>u});var s=i(24423),r=i(64244),a=i(49196),n=i(97183),o=i(63468),h=i(884),l=i(42462);class d{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new n.cP,this._onClonedObservable=new n.cP,this._inheritVisibility=!1,this._isVisible=!0}}class u{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){let r=this._NodeConstructors[e];return r?r(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return!!this._nodeDataStorage._doNotSerialize||!!this._parentNode&&this._parentNode.doNotSerialize}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;let t=this._parentNode;if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){let t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1),e||this._nodeDataStorage._isDisposed||this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&((void 0===this._parentNode._children||null===this._parentNode._children)&&(this._parentNode._children=[]),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}get inheritVisibility(){return this._nodeDataStorage._inheritVisibility}set inheritVisibility(e){this._nodeDataStorage._inheritVisibility=e}get isVisible(){return(!this.inheritVisibility||!this._parentNode||!!this._parentNode.isVisible)&&this._nodeDataStorage._isVisible}set isVisible(e){this._nodeDataStorage._isVisible=e}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){-1===this._nodeDataStorage._sceneRootNodesIndex&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(-1!==this._nodeDataStorage._sceneRootNodesIndex){let e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=!0){this._isDirty=!1,this._nodeDataStorage=new d,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new n.cP,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=r.uq.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new n.cP,this._onDisposeObserver=null,this._behaviors=[],this.name=e,this.id=e,this._scene=t||o.q.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return -1!==this._behaviors.indexOf(e)||(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{this._behaviors.includes(e)&&e.attach(this)}):e.attach(this),this._behaviors.push(e)),this}removeBehavior(e){let t=this._behaviors.indexOf(e);return -1===t||(this._behaviors[t].detach(),this._behaviors.splice(t,1)),this}get behaviors(){return this._behaviors}getBehaviorByName(e){for(let t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return!this._parentNode||!this._parentNode._isDirty&&this._parentUpdateId===this._parentNode._childUpdateId&&this._parentNode.isSynchronized()}isSynchronized(){return(!this._parentNode||!!this.isSynchronizedWithParent())&&this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return!1===e?this._nodeDataStorage._isEnabled:!!this._nodeDataStorage._isEnabled&&this._nodeDataStorage._isParentEnabled}_syncParentEnabledState(){if(this._nodeDataStorage._isParentEnabled=!this._parentNode||this._parentNode.isEnabled(),this._children)for(let e of this._children)e._syncParentEnabledState()}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))}_getDescendants(e,t=!1,i){if(this._children)for(let s=0;s<this._children.length;s++){let r=this._children[s];(!i||i(r))&&e.push(r),t||r._getDescendants(e,!1,i)}}getDescendants(e,t){let i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){let i=[];return this._getDescendants(i,e,e=>(!t||t(e))&&void 0!==e.cullingStrategy),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){let i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=u._AnimationRangeFactory(e,t,i);for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){let s=l.p.Clone(()=>new u(e,this.getScene()),this);if(t&&(s.parent=t),!i){let t=this.getDescendants(!0);for(let i=0;i<t.length;i++){let r=t[i];r.clone(e+"."+r.name,s)}}return s}getAnimationRanges(){let e,t=[];for(e in this._ranges)t.push(this._ranges[e]);return t}beginAnimation(e,t,i,s){let r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}serializeAnimationRanges(){let e=[];for(let t in this._ranges){let i=this._ranges[t];if(!i)continue;let s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=r.uq.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e)for(let i of this.getDescendants(!0))i.dispose(e,t);for(let e of(this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear(),this._behaviors))e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let i=0;i<t.ranges.length;i++){let s=t.ranges[i];e.createAnimationRange(s.name,s.from,s.to)}}getHierarchyBoundingVectors(e=!0,t=null){let i,s;if(this.getScene().incrementRenderId(),this.computeWorldMatrix(!0),this.getBoundingInfo&&this.subMeshes){let e=this.getBoundingInfo();i=e.boundingBox.minimumWorld.clone(),s=e.boundingBox.maximumWorld.clone()}else i=new r.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new r.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e)for(let e of this.getDescendants(!1)){if(e.computeWorldMatrix(!0),t&&!t(e)||!e.getBoundingInfo||0===e.getTotalVertices())continue;let a=e.getBoundingInfo().boundingBox,n=a.minimumWorld,o=a.maximumWorld;r.Pq.CheckExtends(n,i,s),r.Pq.CheckExtends(o,i,s)}return{min:i,max:s}}}u._AnimationRangeFactory=(e,t,i)=>{throw(0,h.n)("AnimationRange")},u._NodeConstructors={},(0,s.Cg)([(0,a.lK)()],u.prototype,"name",void 0),(0,s.Cg)([(0,a.lK)()],u.prototype,"id",void 0),(0,s.Cg)([(0,a.lK)()],u.prototype,"uniqueId",void 0),(0,s.Cg)([(0,a.lK)()],u.prototype,"state",void 0),(0,s.Cg)([(0,a.lK)()],u.prototype,"metadata",void 0)},28607:function(e,t,i){i.d(t,{F:()=>r,Z:()=>N});var s,r,a=i(12299),n=i(29232),o=i(97183),h=i(78584),l=i(97163),d=i(2495),u=i(64244),c=i(86880),_=i(33640),p=i(57230),f=i(14301),g=i(57057),m=i(83460),T=i(27477),E=i(17132),b=i(46703),M=i(63468),S=i(884),C=i(56712),R=i(64513),v=i(98268),P=i(6553),x=i(847),A=i(45981),I=i(96216),y=i(64770),O=i(42267),D=i(48766),w=i(79793),L=i(99872),F=i(24825);(s=r||(r={}))[s.BackwardCompatible=0]="BackwardCompatible",s[s.Intermediate=1]="Intermediate",s[s.Aggressive=2]="Aggressive";class N{static DefaultMaterialFactory(e){throw(0,S.n)("StandardMaterial")}static CollisionCoordinatorFactory(){throw(0,S.n)("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];for(let t of(e=(e=(e=(e=e.concat(this.meshes)).concat(this.lights)).concat(this.cameras)).concat(this.transformNodes),this.skeletons))e=e.concat(t.bones);return e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return C.e.DragMovementThreshold}static set DragMovementThreshold(e){C.e.DragMovementThreshold=e}static get LongPressDelay(){return C.e.LongPressDelay}static set LongPressDelay(e){C.e.LongPressDelay=e}static get DoubleClickDelay(){return C.e.DoubleClickDelay}static set DoubleClickDelay(e){C.e.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return C.e.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){C.e.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){let s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera?.globalPosition??u.Pq.ZeroReadOnly,r=this.useRightHandedSystem===(null!=this._mirroredCameraPosition),a=this.floatingOriginOffset,n=this._tempVect4.set(s.x,s.y,s.z,r?-1:1),o=n.subtractFromFloatsToRef(a.x,a.y,a.z,0,u.AA.Vector4["1"]);return e&&(i?e.setFloat3(t,o.x,o.y,o.z):e.setVector4(t,o)),n}finalizeSceneUbo(){let e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null),i=this.floatingOriginOffset;return e.updateFloat4("vEyePosition",t.x-i.x,t.y-i.y,t.z-i.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=(0,y.lL)(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get _hasDefaultMaterial(){return N.DefaultMaterialFactory!==N._OriginalDefaultMaterialFactory}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=N.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph){this._frameGraph=e,e||(this.customRenderFunction=this._currentCustomRenderFunction);return}this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph,this.activeCamera=null)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=N.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(let e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e),e.addFromContainer&&e.serialize&&this._serializableComponents.push(e)}_getComponent(e){for(let t of this._components)if(t.name===e)return t;return null}get uniqueId(){return this._uniqueId}constructor(e,t){this._inputManager=new C.e(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new v.ov(.2,.2,.3,1),this._tempVect4=new u.IU,this.onClearColorChangedObservable=new o.cP,this.ambientColor=new v.v9(0,0,0),this.environmentIntensity=1,this.iblIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new o.cP,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.objectRenderers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new o.cP,this._onDisposeObserver=null,this.onBeforeRenderObservable=new o.cP,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new o.cP,this.onAfterRenderCameraObservable=new o.cP,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new o.cP,this.onAfterAnimationsObservable=new o.cP,this.onBeforeDrawPhaseObservable=new o.cP,this.onAfterDrawPhaseObservable=new o.cP,this.onReadyObservable=new o.cP,this.onBeforeCameraRenderObservable=new o.cP,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new o.cP,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new o.cP,this.onAfterActiveMeshesEvaluationObservable=new o.cP,this.onBeforeParticlesRenderingObservable=new o.cP,this.onAfterParticlesRenderingObservable=new o.cP,this.onDataLoadedObservable=new o.cP,this.onNewCameraAddedObservable=new o.cP,this.onCameraRemovedObservable=new o.cP,this.onNewLightAddedObservable=new o.cP,this.onLightRemovedObservable=new o.cP,this.onNewGeometryAddedObservable=new o.cP,this.onGeometryRemovedObservable=new o.cP,this.onNewTransformNodeAddedObservable=new o.cP,this.onTransformNodeRemovedObservable=new o.cP,this.onNewMeshAddedObservable=new o.cP,this.onMeshRemovedObservable=new o.cP,this.onNewSkeletonAddedObservable=new o.cP,this.onSkeletonRemovedObservable=new o.cP,this.onNewParticleSystemAddedObservable=new o.cP,this.onParticleSystemRemovedObservable=new o.cP,this.onNewAnimationGroupAddedObservable=new o.cP,this.onAnimationGroupRemovedObservable=new o.cP,this.onNewMaterialAddedObservable=new o.cP,this.onNewMultiMaterialAddedObservable=new o.cP,this.onMaterialRemovedObservable=new o.cP,this.onMultiMaterialRemovedObservable=new o.cP,this.onNewTextureAddedObservable=new o.cP,this.onTextureRemovedObservable=new o.cP,this.onNewFrameGraphAddedObservable=new o.cP,this.onFrameGraphRemovedObservable=new o.cP,this.onNewObjectRendererAddedObservable=new o.cP,this.onObjectRendererRemovedObservable=new o.cP,this.onNewPostProcessAddedObservable=new o.cP,this.onPostProcessRemovedObservable=new o.cP,this.onNewEffectLayerAddedObservable=new o.cP,this.onEffectLayerRemovedObservable=new o.cP,this.onBeforeRenderTargetsRenderObservable=new o.cP,this.onAfterRenderTargetsRenderObservable=new o.cP,this.onBeforeStepObservable=new o.cP,this.onAfterStepObservable=new o.cP,this.onActiveCameraChanged=new o.cP,this.onActiveCamerasChanged=new o.cP,this.onBeforeRenderingGroupObservable=new o.cP,this.onAfterRenderingGroupObservable=new o.cP,this.onMeshImportedObservable=new o.cP,this.onAnimationFileImportedObservable=new o.cP,this.onEnvironmentTextureChangedObservable=new o.cP,this.onMeshUnderPointerUpdatedObservable=new o.cP,this._registeredForLateAnimationBindings=new h.b(256),this._pointerPickingConfiguration=new O.d,this.onPrePointerObservable=new o.cP,this.onPointerObservable=new o.cP,this.onPreKeyboardObservable=new o.cP,this.onKeyboardObservable=new o.cP,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=N.FOGMODE_NONE,this.fogColor=new v.v9(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.frameGraphs=[],this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new u.Pq(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new h.b(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new R.A,this._activeIndices=new R.A,this._activeParticles=new R.A,this._activeBones=new R.A,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=Array(256),this._activeRequests=[],this._pendingData=[],this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new h.L(256),this._processedMaterials=new h.L(256),this._renderTargets=new h.b(256),this._materialsRenderTargets=new h.b(256),this._activeParticleSystems=new h.L(256),this._activeSkeletons=new h.b(32),this._softwareSkinnedMeshes=new h.b(32),this._activeAnimatables=[],this._transformMatrix=u.uq.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=E.B.Create(),this._beforeClearStage=E.B.Create(),this._beforeRenderTargetClearStage=E.B.Create(),this._gatherRenderTargetsStage=E.B.Create(),this._gatherActiveCameraRenderTargetsStage=E.B.Create(),this._isReadyForMeshStage=E.B.Create(),this._beforeEvaluateActiveMeshStage=E.B.Create(),this._evaluateSubMeshStage=E.B.Create(),this._preActiveMeshStage=E.B.Create(),this._cameraDrawRenderTargetStage=E.B.Create(),this._beforeCameraDrawStage=E.B.Create(),this._beforeRenderTargetDrawStage=E.B.Create(),this._beforeRenderingGroupDrawStage=E.B.Create(),this._beforeRenderingMeshStage=E.B.Create(),this._afterRenderingMeshStage=E.B.Create(),this._afterRenderingGroupDrawStage=E.B.Create(),this._afterCameraDrawStage=E.B.Create(),this._afterCameraPostProcessStage=E.B.Create(),this._afterRenderTargetDrawStage=E.B.Create(),this._afterRenderTargetPostProcessStage=E.B.Create(),this._afterRenderStage=E.B.Create(),this._pointerMoveStage=E.B.Create(),this._pointerDownStage=E.B.Create(),this._pointerUpStage=E.B.Create(),this._geometriesByUniqueId=null,this._uniqueId=0,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._floatingOriginScene=void 0,this._floatingOriginOffsetDefault=u.Pq.Zero(),this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._freezeActiveMeshesCancel=null,this._useCurrentFrameBuffer=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._getFloatingOriginScene=()=>this._floatingOriginScene,this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[],this._uniqueId=this.getUniqueId();const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||M.q.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(M.q._LastCreatedScene=this,e.scenes.push(this)),(e.getCreationOptions().useLargeWorldRendering||t?.useFloatingOrigin)&&((0,m.Dh)(),this._floatingOriginScene=this),this._uid=null,this._renderingManager=new T.m(this),g.X&&(this.postProcessManager=new g.X(this)),(0,b.BA)()&&this.attachControl(),this._createUbo(),c.p&&(this._imageProcessingConfiguration=new c.p),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,t&&t.virtual||e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return void 0!==this._animationRatio?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){let t;if(this._isDisposed)return!1;let i=this.getEngine(),s=i.currentRenderPassId;i.currentRenderPassId=this.activeCamera?.renderPassId??s;let r=!0;for(this._pendingData.length>0&&(r=!1),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&r&&(r=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){let s=this.meshes[t];if(!s.subMeshes||0===s.subMeshes.length)continue;if(!s.isReady(!0)){r=!1;continue}let a=s.hasThinInstances||"InstancedMesh"===s.getClassName()||"InstancedLinesMesh"===s.getClassName()||i.getCaps().instancedArrays&&s.instances.length>0;for(let e of this._isReadyForMeshStage)e.action(s,a)||(r=!1);if(!e)continue;let n=s.material||this.defaultMaterial;if(n)if(n._storeEffectOnSubMeshes)for(let e of s.subMeshes){let t=e.getMaterial();t&&t.hasRenderTargetTextures&&null!=t.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(t)&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else n.hasRenderTargetTextures&&null!=n.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(n)&&(this._processedMaterials.push(n),this._materialsRenderTargets.concatWithNoDuplicate(n.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(r=!1);for(t=0;t<this.geometries.length;t++)2===this.geometries[t].delayLoadState&&(r=!1);if(this.activeCameras&&this.activeCameras.length>0)for(let e of this.activeCameras)e.isReady(!0)||(r=!1);else this.activeCamera&&!this.activeCamera.isReady(!0)&&(r=!1);for(let e of this.particleSystems)e.isReady()||(r=!1);if(this.layers)for(let e of this.layers)e.isReady()||(r=!1);if(this.effectLayers)for(let e of this.effectLayers)e.isLayerReady()||(r=!1);return i.areAllEffectsReady()||(r=!1),i.currentRenderPassId=s,r}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){let t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){void 0!==t?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){let t=this.isLoading,i=this._pendingData.indexOf(e);-1!==i&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),null===this._executeWhenReadyTimeoutId&&this._checkIsReady(t)}async whenReadyAsync(e=!1){return await new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=n.j.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){i||s||!this._multiviewSceneUbo||(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),(this._viewUpdateFlag!==e.updateFlag||this._projectionUpdateFlag!==t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?P.P.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=P.P.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e,t){let i=new _.D(this._engine,void 0,!1,e??"scene",void 0,t);return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}get floatingOriginMode(){return void 0!==this._floatingOriginScene}get floatingOriginOffset(){return this.floatingOriginMode&&this.activeCamera?this.activeCamera.getWorldMatrix().getTranslation():this._floatingOriginOffsetDefault}getUniqueId(){return x.K.UniqueId}addMesh(e,t=!1){if(!this._blockEntityCollection&&(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),a.S0.SetImmediate(()=>{this.onNewMeshAddedObservable.notifyObservers(e)}),t))for(let t of e.getChildMeshes())this.addMesh(t)}removeMesh(e,t=!1){let i=this.meshes.indexOf(e);if(-1!==i&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t)for(let t of e.getChildMeshes())this.removeMesh(t);return i}addTransformNode(e){this._blockEntityCollection||(e.getScene()!==this||-1===e._indexInSceneTransformNodesArray)&&(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){let t=e._indexInSceneTransformNodesArray;if(-1!==t){if(t!==this.transformNodes.length-1){let e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){let t=this.skeletons.indexOf(e);return -1!==t&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){let t=this.morphTargetManagers.indexOf(e);return -1!==t&&this.morphTargetManagers.splice(t,1),t}removeLight(e){let t=this.lights.indexOf(e);if(-1!==t){for(let t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){let t=this.cameras.indexOf(e);if(-1!==t&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){let t=this.activeCameras.indexOf(e);-1!==t&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){let t=this.particleSystems.indexOf(e);return -1!==t&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),this.onParticleSystemRemovedObservable.notifyObservers(e),t}removeAnimation(e){let t=this.animations.indexOf(e);return -1!==t&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){let t=this.animationGroups.indexOf(e);return -1!==t&&this.animationGroups.splice(t,1),this.onAnimationGroupRemovedObservable.notifyObservers(e),t}removeMultiMaterial(e){let t=this.multiMaterials.indexOf(e);return -1!==t&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){let t=e._indexInSceneMaterialArray;if(-1!==t&&t<this.materials.length){if(t!==this.materials.length-1){let e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){let t=this.actionManagers.indexOf(e);return -1!==t&&this.actionManagers.splice(t,1),t}removeTexture(e){let t=this.textures.indexOf(e);return -1!==t&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}removeFrameGraph(e){let t=this.frameGraphs.indexOf(e);return -1!==t&&this.frameGraphs.splice(t,1),this.onFrameGraphRemovedObservable.notifyObservers(e),t}removeObjectRenderer(e){let t=this.objectRenderers.indexOf(e);return -1!==t&&this.objectRenderers.splice(t,1),this.onObjectRendererRemovedObservable.notifyObservers(e),t}removePostProcess(e){let t=this.postProcesses.indexOf(e);return -1!==t&&this.postProcesses.splice(t,1),this.onPostProcessRemovedObservable.notifyObservers(e),t}removeEffectLayer(e){let t=this.effectLayers.indexOf(e);return -1!==t&&this.effectLayers.splice(t,1),this.onEffectLayerRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){for(let t of(this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes(),this.meshes))-1===t.lightSources.indexOf(e)&&(t.lightSources.push(e),t._resyncLightSources());a.S0.SetImmediate(()=>{this.onNewLightAddedObservable.notifyObservers(e)})}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(I.c.CompareLightsPriority)}addCamera(e){!this._blockEntityCollection&&(this.cameras.push(e),a.S0.SetImmediate(()=>{this.onNewCameraAddedObservable.notifyObservers(e)}),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),a.S0.SetImmediate(()=>{this.onNewSkeletonAddedObservable.notifyObservers(e)}))}addParticleSystem(e){this._blockEntityCollection||(this.particleSystems.push(e),a.S0.SetImmediate(()=>{this.onNewParticleSystemAddedObservable.notifyObservers(e)}))}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||(this.animationGroups.push(e),a.S0.SetImmediate(()=>{this.onNewAnimationGroupAddedObservable.notifyObservers(e)}))}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),a.S0.SetImmediate(()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e)}))}addMaterial(e){this._blockEntityCollection||(e.getScene()!==this||-1===e._indexInSceneMaterialArray)&&(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),a.S0.SetImmediate(()=>{this.onNewMaterialAddedObservable.notifyObservers(e)}))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}addFrameGraph(e){this.frameGraphs.push(e),a.S0.SetImmediate(()=>{this.onNewFrameGraphAddedObservable.notifyObservers(e)})}addObjectRenderer(e){this.objectRenderers.push(e),a.S0.SetImmediate(()=>{this.onNewObjectRendererAddedObservable.notifyObservers(e)})}addPostProcess(e){this._blockEntityCollection||(this.postProcesses.push(e),a.S0.SetImmediate(()=>{this.onNewPostProcessAddedObservable.notifyObservers(e)}))}addEffectLayer(e){this._blockEntityCollection||(this.effectLayers.push(e),a.S0.SetImmediate(()=>{this.onNewEffectLayerAddedObservable.notifyObservers(e)}))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){let t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){let t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){let i=this.materials[e];if(t(i))return i}if(e)for(let e=0;e<this.multiMaterials.length;e++){let i=this.multiMaterials[e];if(t(i))return i}return null}getMaterialByUniqueID(e,t=!1){return this.getMaterialByUniqueId(e,t)}getMaterialByUniqueId(e,t=!1){return this._getMaterial(t,t=>t.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,t=>t.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,t=>t.name===e)}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t){for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){let i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].id===e)return i.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){let i=this.skeletons[t];for(let t=0;t<i.bones.length;t++)if(i.bones[t].name===e)return i.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){let t=this._geometriesByUniqueId[e];if(void 0!==t)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}getFrameGraphByName(e){for(let t=0;t<this.frameGraphs.length;t++)if(this.frameGraphs[t].name===e)return this.frameGraphs[t];return null}pushGeometry(e,t){return!(!t&&this._getGeometryByUniqueId(e.uniqueId))&&(this.addGeometry(e),a.S0.SetImmediate(()=>{this.onNewGeometryAddedObservable.notifyObservers(e)}),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(void 0===(t=this._geometriesByUniqueId[e.uniqueId]))return!1}else if((t=this.geometries.indexOf(e))<0)return!1;if(t!==this.geometries.length-1){let e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){let t=this.getMeshById(e);if(t)return t;let i=this.getTransformNodeById(e);if(i)return i;let s=this.getLightById(e);if(s)return s;let r=this.getCameraById(e);if(r)return r;let a=this.getBoneById(e);return a||null}getNodeByName(e){let t=this.getMeshByName(e);if(t)return t;let i=this.getTransformNodeByName(e);if(i)return i;let s=this.getLightByName(e);if(s)return s;let r=this.getCameraByName(e);if(r)return r;let a=this.getBoneByName(e);return a||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){let i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){let s=i.getTarget(t);if(s.id===e)return s}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){let i=this.morphTargetManagers[t];for(let t=0;t<i.numTargets;++t){let s=i.getTarget(t);if(s.name===e)return s}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){let i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return -1!==this._activeMeshes.indexOf(e)}get uid(){return this._uid||(this._uid=a.S0.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new l.w),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new l.w),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(let i of this._evaluateSubMeshStage)i.action(t,e);let i=e.getMaterial();null!=i&&(i.hasRenderTargetTextures&&null!=i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._materialsRenderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,i))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){let t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,s=!0,r=!1){if(this.frameGraph){this._renderWithFrameGraph(!0,!1,!0);let a=this.frameGraph.getTasksByType(L.H);for(let e of a)e.objectRenderer._freezeActiveMeshes(s);return this._freezeActiveMeshesCancel=(0,F.B)(()=>{let e=!0,t=!0;for(let i of a)e&&(e=i.objectRenderer._isFrozen),t&&(t=null!==i.objectRenderer._freezeActiveMeshesCancel);if(e)return!0;if(!t)throw Error("Freezing active meshes was cancelled");return!1},()=>{this._freezeActiveMeshesCancel=null,this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,t?.()},(e,t)=>{if(this._freezeActiveMeshesCancel=null,this.unfreezeActiveMeshes(),t){let t="Scene: Timeout while waiting for meshes to be frozen.";i?i(t):(D.V.Error(t),e&&D.V.Error(e))}else{let t="Scene: An unexpected error occurred while trying to freeze active meshes.";i?i(t):(D.V.Error(t),e&&(D.V.Error(e),e.stack&&D.V.Error(e.stack)))}}),this}return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,s)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}if(this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null,this.frameGraph)for(let e of this.frameGraph.getTasksByType(L.H))e.objectRenderer._unfreezeActiveMeshes();else for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){(!this._engine.snapshotRendering||1!==this._engine.snapshotRenderingMode)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode){this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){let e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){let e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;for(let e of(this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset(),this._beforeEvaluateActiveMeshStage))e.action();let e=this.getActiveMeshCandidates(),t=e.length;for(let i=0;i<t;i++){let t=e.data[i],s=t._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(s?s[1]=-1:(s=[t,-1],t._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,s)),t.isBlocked||(this._totalVertices.addCount(t.getTotalVertices(),!1),!t.isReady()||!t.isEnabled()||t.scaling.hasAZeroComponent))continue;t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t);let r=this.customLODSelector?this.customLODSelector(t,this.activeCamera):t.getLOD(this.activeCamera);if(s[0]=r,s[1]=this._frameId,null!=r&&(r!==t&&0!==r.billboardMode&&r.computeWorldMatrix(),t._preActivate(),t.isVisible&&t.visibility>0&&(t.layerMask&this.activeCamera.layerMask)!=0&&(this._skipFrustumClipping||t.alwaysSelectAsActiveMesh||t.isInFrustum(this._frustumPlanes)))){for(let e of(this._activeMeshes.push(t),this.activeCamera._activeMeshes.push(t),r!==t&&r._activate(this._renderId,!1),this._preActiveMeshStage))e.action(t);t._activate(this._renderId,!1)&&(t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(r=t):r._internalAbstractMeshDataInfo._onlyForInstances=!1,r._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(t,r)),t._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){let t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;let i=t.emitter;(!i.position||i.isEnabled())&&(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){this._skeletonsEnabled&&e.skeleton&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),!e.computeBonesUsingShaders&&this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){let s=this.getActiveSubMeshCandidates(t),r=s.length;i=i||1===r;for(let a=0;a<r;a++){let r=s.data[a];this._evaluateSubMesh(r,t,e,i)}}}updateTransformMatrix(e){let t=this.activeCamera;if(t)if(t._renderingMultiview){let i=t._rigCameras[0],s=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){!this._useCurrentFrameBuffer&&(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(e&&e._multiviewTexture);else if(e&&e.outputRenderTarget&&!e._renderingMultiview){let t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||e.isRightCamera||(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){if(e&&e._skipRendering)return;let s=this._engine;if(this._activeCamera=e,!this.activeCamera)throw Error("Active camera not set");if(s.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){let t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}for(let i of(this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture),this._gatherActiveCameraRenderTargetsStage))i.action(this._renderTargets);let r=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){let e;a.S0.StartPerformanceCounter("Render targets",this._renderTargets.length>0);let t=this.getBoundingBoxRenderer?.();for(let i=0;i<this._renderTargets.length;i++){let s=this._renderTargets.data[i];if(s._shouldRender()){this._renderId++;let i=s.activeCamera&&s.activeCamera!==this.activeCamera;t&&!e&&((e=t.renderList.length>0?t.renderList.data.slice():[]).length=t.renderList.length),s.render(i,this.dumpNextRenderTargets),r=!0}}t&&e&&(t.renderList.data=e,t.renderList.length=e.length),a.S0.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(let e of this._cameraDrawRenderTargetStage)r=e.action(this.activeCamera)||r;this._intermediateRendering=!1}for(let t of(this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??0,r&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),!this.postProcessManager||e._multiviewTexture||this.prePass||this.postProcessManager._prepareFrame(),this._beforeCameraDrawStage))t.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this);let n=s.snapshotRendering&&1===s.snapshotRenderingMode;for(let e of(n&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!n),this.onAfterDrawPhaseObservable.notifyObservers(this),this._afterCameraDrawStage))e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){let t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(let e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(0===e.cameraRigMode||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){let t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){let i=t.actionManager.actions[e];if(12===i.trigger||13===i.trigger){let e=i.getTriggerParameter(),s=e.mesh?e.mesh:e,r=s.intersectsMesh(t,e.usePreciseIntersection),a=t._intersectionsInProgress.indexOf(s);r&&-1===a?12===i.trigger?(i._executeCurrent(f.X.CreateNew(t,void 0,s)),t._intersectionsInProgress.push(s)):13===i.trigger&&t._intersectionsInProgress.push(s):!r&&a>-1&&(13===i.trigger&&i._executeCurrent(f.X.CreateNew(t,void 0,s)),t.actionManager.hasSpecificTrigger(13,e=>s===(e.mesh?e.mesh:e))&&13!==i.trigger||t._intersectionsInProgress.splice(a,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(N.MinDeltaTime,Math.min(this._engine.getDeltaTime(),N.MaxDeltaTime))+this._timeAccumulator,t=this._engine.getTimeStep(),i=1e3/t/1e3,s=0,r=this._engine.getLockstepMaxSteps(),a=Math.floor(e/t);for(a=Math.min(a,r);e>0&&s<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e}else{let e=this.useConstantAnimationDeltaTime?16:Math.max(N.MinDeltaTime,Math.min(this._engine.getDeltaTime(),N.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=!1),e?.rigCameras?.length)for(let t=0;t<e.rigCameras.length;++t){let i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(let t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1,i=!1){if(this.activeCamera=null,this.activeCameras=null,e){for(let e of this.cameras)if(e.update(),0!==e.cameraRigMode)for(let t=0;t<e._rigCameras.length;t++)e._rigCameras[t].update()}for(let e of(this.onBeforeRenderObservable.notifyObservers(this),this._beforeClearStage))e.action();if(this._engine.snapshotRendering&&1===this._engine.snapshotRenderingMode)this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();else{let e=this.getActiveMeshCandidates(),t=e.length;if(this._activeMeshesFrozen){if(!this._skipEvaluateActiveMeshesCompletely)for(let i=0;i<t;i++){let t=e.data[i];t._internalAbstractMeshDataInfo._wasActiveLastFrame&&t.computeWorldMatrix()}if(this.particlesEnabled){let e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}}else{this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();for(let s=0;s<t;s++){let t=e.data[s];t._internalAbstractMeshDataInfo._wasActiveLastFrame=!1,!t.isBlocked&&(this._totalVertices.addCount(t.getTotalVertices(),!1),t.isReady()&&t.isEnabled()&&!t.scaling.hasAZeroComponent&&(t.computeWorldMatrix(i),t.actionManager&&t.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(t)))}if(this.particlesEnabled)for(let e=0;e<this.particleSystems.length;e++){let t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;let i=t.emitter;(!i.position||i.isEnabled())&&(this._activeParticleSystems.push(t),t.animate())}}}this.frameGraph?.execute()}_renderRenderTarget(e,t,i=!1,s=!1){if(this._intermediateRendering=!0,e._shouldRender()){if(this._renderId++,this.activeCamera=t,!this.activeCamera)throw Error("Active camera not set");this._engine.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),e.render(i,s)}this._intermediateRendering=!1}render(e=!0,t=!1){if(!this.isDisposed){if(this.onReadyObservable.hasObservers()&&null===this._executeWhenReadyTimeoutId&&this._checkIsReady(),m.k2.getScene=this._getFloatingOriginScene,this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length)for(let e of this.activeCameras)this._checkCameraRenderTarget(e);for(let e of(this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate(),this._beforeCameraUpdateStage))e.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];if(t.update(),0!==t.cameraRigMode)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),0!==this.activeCamera.cameraRigMode))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update()}if(this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{this.onBeforeRenderObservable.notifyObservers(this),this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);let e=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){a.S0.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);for(let t=0;t<this.customRenderTargets.length;t++){let i=this.customRenderTargets[t],s=i.activeCamera||this.activeCamera;this._renderRenderTarget(i,s,e!==s,this.dumpNextRenderTargets)}a.S0.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._renderId++}for(let t of(this._engine.currentRenderPassId=e?.renderPassId??0,this.activeCamera=e,this._activeCamera&&22!==this._activeCamera.cameraRigMode&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this._beforeClearStage))t.action();for(let e of(this._clearFrameBuffer(this.activeCamera),this._gatherRenderTargetsStage))e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}for(let e of(this._checkIntersections(),this._afterRenderStage))e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){let t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;if(this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations){for(let e of this._activeAnimatables)e.onAnimationEndObservable.clear(),e.onAnimationEnd=null;this.stopAllAnimations()}for(let e of(this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0,this._activeRequests.slice()))e.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){D.V.Error("An error occurred while calling onDisposeObservable!",e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,e=>e.dispose(!0)),this._disposeList(this.transformNodes,e=>e.dispose(!0));let e=this.cameras;this._disposeList(e),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._disposeList(this.frameGraphs),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let t=this._engine.scenes.indexOf(this);if(t>-1&&this._engine.scenes.splice(t,1),this._floatingOriginScene=void 0,0===this._engine.scenes.length&&(0,m.oW)(),M.q._LastCreatedScene===this){M.q._LastCreatedScene=null;let e=M.q.Instances.length-1;for(;e>=0;){let t=M.q.Instances[e];if(t.scenes.length>0){M.q._LastCreatedScene=t.scenes[this._engine.scenes.length-1];break}e--}}(t=this._engine._virtualScenes.indexOf(this))>-1&&this._engine._virtualScenes.splice(t,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onNewFrameGraphAddedObservable.clear(),this.onFrameGraphRemovedObservable.clear(),this.onNewObjectRendererAddedObservable.clear(),this.onObjectRendererRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){let i=e.slice(0);for(let e of(t=t??(e=>e.dispose()),i))t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(let e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){let t=new u.Pq(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new u.Pq(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let s of(e=e||(()=>!0),this.meshes.filter(e))){if(s.computeWorldMatrix(!0),!s.subMeshes||0===s.subMeshes.length||s.infiniteDistance)continue;let e=s.getBoundingInfo(),r=e.boundingBox.minimumWorld,a=e.boundingBox.maximumWorld;u.Pq.CheckExtends(r,t,i),u.Pq.CheckExtends(a,t,i)}return{min:t,max:i}}createPickingRay(e,t,i,s,r=!1){throw(0,S.n)("Ray")}createPickingRayToRef(e,t,i,s,r,a=!1,n=!1){throw(0,S.n)("Ray")}createPickingRayInCameraSpace(e,t,i){throw(0,S.n)("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw(0,S.n)("Ray")}pick(e,t,i,s,r,a){let n=(0,S.n)("Ray",!0);return n&&D.V.Warn(n),new p.G}pickWithBoundingInfo(e,t,i,s,r){let a=(0,S.n)("Ray",!0);return a&&D.V.Warn(a),new p.G}pickWithRay(e,t,i,s){throw(0,S.n)("Ray")}multiPick(e,t,i,s,r){throw(0,S.n)("Ray")}multiPickWithRay(e,t,i){throw(0,S.n)("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(let e of this.geometries)e._rebuild();for(let e of this.meshes)e._rebuild();for(let e of(this.postProcessManager&&this.postProcessManager._rebuild(),this._components))e.rebuild();for(let e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(let e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(let e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(void 0===t)return e;let s=[];for(let r in e){let a=e[r];d.Y&&d.Y.MatchesQuery(a,t)&&(!i||i(a))&&s.push(a)}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(127))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(let i of this.materials)(!t||t(i))&&i.markAsDirty(e)}_loadFile(e,t,i,s,r,a,n){let o=(0,A.zU)(e,t,i,s?this.offlineProvider:void 0,r,a,n);return this._activeRequests.push(o),o.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),o}async _loadFileAsync(e,t,i,s,r){return await new Promise((a,n)=>{this._loadFile(e,e=>{a(e)},t,i,s,(e,t)=>{n(t)},r)})}_requestFile(e,t,i,s,r,a,n){let o=(0,A.sh)(e,t,i,s?this.offlineProvider:void 0,r,a,n);return this._activeRequests.push(o),o.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),o}async _requestFileAsync(e,t,i,s,r){return await new Promise((a,n)=>{this._requestFile(e,e=>{a(e)},t,i,s,e=>{n(e)},r)})}_readFile(e,t,i,s,r){let a=(0,A.NJ)(e,t,i,s,r);return this._activeRequests.push(a),a.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),a}async _readFileAsync(e,t,i){return await new Promise((s,r)=>{this._readFile(e,e=>{s(e)},t,i,e=>{r(e)})})}getPerfCollector(){throw(0,S.n)("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}N.FOGMODE_NONE=0,N.FOGMODE_EXP=1,N.FOGMODE_EXP2=2,N.FOGMODE_LINEAR=3,N.MinDeltaTime=1,N.MaxDeltaTime=1e3,N._OriginalDefaultMaterialFactory=N.DefaultMaterialFactory,(0,w.Y5)("BABYLON.Scene",N)},17132:function(e,t,i){i.d(t,{B:()=>r,v:()=>s});class s{}s.NAME_EFFECTLAYER="EffectLayer",s.NAME_LAYER="Layer",s.NAME_LENSFLARESYSTEM="LensFlareSystem",s.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",s.NAME_PARTICLESYSTEM="ParticleSystem",s.NAME_GAMEPAD="Gamepad",s.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",s.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",s.NAME_PREPASSRENDERER="PrePassRenderer",s.NAME_DEPTHRENDERER="DepthRenderer",s.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",s.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",s.NAME_SPRITE="Sprite",s.NAME_SUBSURFACE="SubSurface",s.NAME_OUTLINERENDERER="Outline",s.NAME_PROCEDURALTEXTURE="ProceduralTexture",s.NAME_SHADOWGENERATOR="ShadowGenerator",s.NAME_OCTREE="Octree",s.NAME_PHYSICSENGINE="PhysicsEngine",s.NAME_AUDIO="Audio",s.NAME_FLUIDRENDERER="FluidRenderer",s.NAME_IBLCDFGENERATOR="iblCDFGenerator",s.NAME_CLUSTEREDLIGHTING="ClusteredLighting",s.STEP_ISREADYFORMESH_EFFECTLAYER=0,s.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,s.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,s.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,s.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,s.STEP_BEFORECAMERADRAW_PREPASS=0,s.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,s.STEP_BEFORECAMERADRAW_LAYER=2,s.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,s.STEP_BEFORERENDERTARGETDRAW_LAYER=1,s.STEP_BEFORERENDERINGMESH_PREPASS=0,s.STEP_BEFORERENDERINGMESH_OUTLINE=1,s.STEP_AFTERRENDERINGMESH_PREPASS=0,s.STEP_AFTERRENDERINGMESH_OUTLINE=1,s.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,s.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,s.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,s.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,s.STEP_BEFORECLEAR_PREPASS=1,s.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,s.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,s.STEP_AFTERRENDERTARGETDRAW_LAYER=1,s.STEP_AFTERCAMERADRAW_PREPASS=0,s.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,s.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,s.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,s.STEP_AFTERCAMERADRAW_LAYER=4,s.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,s.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,s.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,s.STEP_AFTERRENDER_AUDIO=0,s.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,s.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,s.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,s.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,s.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,s.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,s.STEP_GATHERACTIVECAMERARENDERTARGETS_CLUSTEREDLIGHTING=2,s.STEP_POINTERMOVE_SPRITE=0,s.STEP_POINTERDOWN_SPRITE=0,s.STEP_POINTERUP_SPRITE=0;class r extends Array{constructor(e){super(...e)}static Create(){return Object.create(r.prototype)}registerStep(e,t,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length&&!(e<this[s].index);s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}}}]);