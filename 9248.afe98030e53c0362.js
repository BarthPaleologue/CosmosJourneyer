/*
 *  This file is part of Cosmos Journeyer
 *
 *  Copyright (C) 2024 Barthélemy Paléologue <barth.paleologue@cosmosjourneyer.com>
 *
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Affero General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

"use strict";(globalThis.webpackChunkcosmos_journeyer=globalThis.webpackChunkcosmos_journeyer||[]).push([["9248"],{80610:function(e,t,r){r.d(t,{D0:()=>R,En:()=>T,Lf:()=>P,QH:()=>h,Ro:()=>_,hO:()=>b,oJ:()=>A,p6:()=>m,qC:()=>F,qJ:()=>g,qh:()=>L});var a=r(70541),n=r(61834),i=r(16891),l=r(49192),o=r(90481),u=r(11740),s=r(76468),y=r(75590),f=r(88280),p=r(83393),c=r(23207);r(74484);let d="image/png",x=[134,22,135,150,246,214,150,54];function g(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=0;for(let e=0;e<x.length;e++)if(t.getUint8(r++)!==x[e])return f.Y.Error("Not a babylon environment map"),null;let a="",n=0;for(;n=t.getUint8(r++);)a+=String.fromCharCode(n);let i=JSON.parse(a);return(i=h(i)).binaryDataPosition=r,i.specular&&(i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}function h(e){if(e.version>2)throw Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,version:2,imageType:d}}async function m(e,t={}){let r=e.getInternalTexture();if(!r)return await Promise.reject("The cube texture is invalid.");let a=r.getEngine();if(2!==e.textureType&&1!==e.textureType&&0!==e.textureType&&0!==e.textureType&&7!==e.textureType&&-1!==e.textureType)return await Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let n=1;if(!a.getCaps().textureFloatRender&&(n=2,!a.getCaps().textureHalfFloatRender))return await Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");e.sphericalPolynomial;let l=e.getInternalTexture()?._sphericalPolynomialPromise,o=r.width,u=new s.x(a),y={},f={};a.flushFramebuffer();let p=t.imageType??d,c=(0,i.ILog2)(r.width);for(let r=0;r<=c;r++){let a=Math.pow(2,c-r);for(let i=0;i<6;i++)y[6*r+i]=await w(u,e,n,i,r,a,p,t.imageQuality)}let g=t.disableIrradianceTexture?null:e.irradianceTexture;if(g){let e=g.getSize().width;for(let r=0;r<6;r++)f[r]=await w(u,g,n,r,0,e,p,t.imageQuality)}u.dispose(),l&&await l;let h={version:2,width:o,imageType:p,irradiance:function(e){let t=e.sphericalPolynomial;return null==t?null:{x:[t.x.x,t.x.y,t.x.z],y:[t.y.x,t.y.y,t.y.z],z:[t.z.x,t.z.y,t.z.z],xx:[t.xx.x,t.xx.y,t.xx.z],yy:[t.yy.x,t.yy.y,t.yy.z],zz:[t.zz.x,t.zz.y,t.zz.z],yz:[t.yz.x,t.yz.y,t.yz.z],zx:[t.zx.x,t.zx.y,t.zx.z],xy:[t.xy.x,t.xy.y,t.xy.z]}}(e),specular:{mipmaps:[],lodGenerationScale:e.lodGenerationScale}},T=0;for(let e=0;e<=c;e++)for(let t=0;t<6;t++){let r=y[6*e+t].byteLength;h.specular.mipmaps.push({length:r,position:T}),T+=r}if(g){h.irradiance=h.irradiance||{x:[0,0,0],xx:[0,0,0],y:[0,0,0],yy:[0,0,0],z:[0,0,0],zz:[0,0,0],yz:[0,0,0],zx:[0,0,0],xy:[0,0,0]},h.irradiance.irradianceTexture={size:g.getSize().width,faces:[]};for(let e=0;e<6;e++){let t=f[e].byteLength;h.irradiance.irradianceTexture.faces.push({length:t,position:T}),T+=t}}let b=JSON.stringify(h),_=new ArrayBuffer(b.length+1),z=new Uint8Array(_);for(let e=0,t=b.length;e<t;e++)z[e]=b.charCodeAt(e);z[b.length]=0;let A=new ArrayBuffer(x.length+T+_.byteLength),R=new Uint8Array(A),M=new DataView(A),F=0;for(let e=0;e<x.length;e++)M.setUint8(F++,x[e]);R.set(new Uint8Array(_),F),F+=_.byteLength;for(let e=0;e<=c;e++)for(let t=0;t<6;t++){let r=y[6*e+t];R.set(new Uint8Array(r),F),F+=r.byteLength}if(g)for(let e=0;e<6;e++){let t=f[e];R.set(new Uint8Array(t),F),F+=t.byteLength}return A}async function w(e,t,r,a,n,i,l,o){let u=await t.readPixels(a,n,void 0,!1);if(u&&u.byteLength===u.length){let e=new Float32Array(4*u.byteLength);for(let t=0;t<u.byteLength;t++)e[t]=u[t]/255,e[t]=Math.pow(e[t],2.2);u=e}else if(u&&t.gammaSpace){let e=u;for(let t=0;t<e.length;t++)e[t]=Math.pow(e[t],2.2)}let s=e.getEngine(),y=s.createRawTexture(u,i,i,5,!1,!0,1,null,r);await p.r.EncodeTextureToRGBD(y,e,r);let f=await s._readTexturePixels(y,i,i),d=await (0,c.DumpDataAsync)(i,i,f,l,void 0,!1,!0,o);return y.dispose(),d}function T(e,t){let r=(t=h(t)).specular,a=Math.log2(t.width);if(a=Math.round(a)+1,r.mipmaps.length!==6*a)throw Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);let n=Array(a);for(let i=0;i<a;i++){n[i]=Array(6);for(let a=0;a<6;a++){let l=r.mipmaps[6*i+a];n[i][a]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+l.position,l.length)}}return n}function b(e,t){t=h(t);let r=Array(6),a=t.irradiance?.irradianceTexture;if(a){if(6!==a.faces.length)throw Error(`Incorrect irradiance texture faces number "${a.faces.length}"`);for(let n=0;n<6;n++){let i=a.faces[n];r[n]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+i.position,i.length)}}return r}function _(e,t,r){let a=(r=h(r)).specular;if(!a)return Promise.resolve([]);e._lodGenerationScale=a.lodGenerationScale;let n=[],i=T(t,r);n.push(A(e,i,r.imageType));let l=r.irradiance?.irradianceTexture;if(l){let a=b(t,r);n.push(R(e,a,l.size,r.imageType))}return Promise.all(n)}async function z(e,t,r,a,n,i,l,o,u,s,y){return await new Promise((f,p)=>{if(r){let r=t.createTexture(null,!0,!0,null,1,null,e=>{p(e)},e);a?.onEffectCreatedObservable.addOnce(o=>{o.executeWhenCompiled(()=>{a.externalTextureSamplerBinding=!0,a.onApply=a=>{a._bindTexture("textureSampler",r),a.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([a],s,!0,i,l),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(n),f())})})}else{if(t._uploadImageToTexture(y,e,i,l),o){let r=u[l];r&&t._uploadImageToTexture(r._texture,e,i,0)}f()}})}async function A(e,t,r=d){let a=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,a.updateTextureSamplingMode(3,e),await M(e,t,!0,r),e.isReady=!0}async function R(e,t,r,a=d){let n=e.getEngine(),i=new o.l(n,5);e._irradianceTexture=new u.V(n,i),i.isCube=!0,i.format=5,i.type=0,i.generateMipMaps=!0,i._cachedAnisotropicFilteringLevel=null,i.generateMipMaps=!0,i.width=r,i.height=r,n.updateTextureSamplingMode(3,i),await M(i,[t],!1,a),n.generateMipMapsForCubemap(i),i.isReady=!0}async function M(e,t,n,l=d){if(!a.w1.IsExponentOfTwo(e.width))throw Error("Texture size must be a power of two");let s=(0,i.ILog2)(e.width)+1,f=e.getEngine(),p=!1,c=!1,x=null,g=null,h=null,m=f.getCaps();m.textureLOD?f._features.supportRenderAndCopyToLodForFloatTextures?m.textureHalfFloatRender&&m.textureHalfFloatLinearFiltering?(p=!0,e.type=2):m.textureFloatRender&&m.textureFloatLinearFiltering&&(p=!0,e.type=1):p=!1:(p=!1,c=n);let w=0;if(p)f.isWebGPU?(w=1,await r.e("5960").then(r.bind(r,38886))):await r.e("7843").then(r.bind(r,6963)),x=new y.D("rgbdDecode","rgbdDecode",null,null,1,null,3,f,!1,void 0,e.type,void 0,null,!1,void 0,w),e._isRGBD=!1,e.invertY=!1,g=f.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,c){h={};let t=e._lodGenerationScale,r=e._lodGenerationOffset;for(let a=0;a<3;a++){let n=(s-1)*t+r,i=Math.round(Math.min(Math.max(r+(n-r)*(1-a/2),0),n)),l=new o.l(f,2);l.isCube=!0,l.invertY=!0,l.generateMipMaps=!1,f.updateTextureSamplingMode(2,l);let y=new u.V(null);switch(y._isCube=!0,y._texture=l,h[i]=y,a){case 0:e._lodTextureLow=y;break;case 1:e._lodTextureMid=y;break;case 2:e._lodTextureHigh=y}}}let T=[];for(let r=0;r<t.length;r++)for(let a=0;a<6;a++){let n,i=new Blob([t[r][a]],{type:l}),o=URL.createObjectURL(i);if(f._features.forceBitmapOverHTMLImageElement)n=f.createImageBitmap(i,{premultiplyAlpha:"none"}).then(async t=>await z(t,f,p,x,o,a,r,c,h,g,e));else{let t=new Image;t.src=o,n=new Promise((n,i)=>{t.onload=()=>{z(t,f,p,x,o,a,r,c,h,g,e).then(()=>n()).catch(e=>{i(e)})},t.onerror=e=>{i(e)}})}T.push(n)}if(await Promise.all(T),t.length<s){let r,a=Math.pow(2,s-1-t.length),n=a*a*4;switch(e.type){case 0:r=new Uint8Array(n);break;case 2:r=new Uint16Array(n);break;case 1:r=new Float32Array(n)}for(let a=t.length;a<s;a++)for(let t=0;t<6;t++)f._uploadArrayBufferViewToTexture(g?.texture||e,r,t,a)}if(g){let t=e._irradianceTexture;e._irradianceTexture=null,f._releaseTexture(e),g._swapAndDie(e),e._irradianceTexture=t}x&&x.dispose(),c&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function F(e,t){let r=(t=h(t)).irradiance;if(!r)return;let a=new l.i;n.P.FromArrayToRef(r.x,0,a.x),n.P.FromArrayToRef(r.y,0,a.y),n.P.FromArrayToRef(r.z,0,a.z),n.P.FromArrayToRef(r.xx,0,a.xx),n.P.FromArrayToRef(r.yy,0,a.yy),n.P.FromArrayToRef(r.zz,0,a.zz),n.P.FromArrayToRef(r.yz,0,a.yz),n.P.FromArrayToRef(r.zx,0,a.zx),n.P.FromArrayToRef(r.xy,0,a.xy),e._sphericalPolynomial=a}function P(e,t,r,a,n){let i=A(e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),t).then(()=>e);return e.onRebuildCallback=e=>({proxy:i,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=a,e._lodGenerationOffset=n,e._sphericalPolynomial=r,A(e,t).then(()=>(e.isReady=!0,e))}let L={GetEnvInfo:g,CreateEnvTextureAsync:m,CreateRadianceImageDataArrayBufferViews:T,CreateIrradianceImageDataArrayBufferViews:b,UploadEnvLevelsAsync:_,UploadRadianceLevelsAsync:A,UploadIrradianceLevelsAsync:R,UploadEnvSpherical:F}}}]);